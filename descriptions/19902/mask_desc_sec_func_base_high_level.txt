double
mrb_str_len_to_dbl(mrb_state *mrb, const char *s, size_t len, mrb_bool badcheck)
{
  // Convert a string representing a floating-point number into a double value.
  // The function skips leading whitespace and handles optional underscores in the numeric portion,
  // treating underscores as separators that can be ignored between digits.
  // If the string begins with a "0x" or "0X", it is interpreted as a hexadecimal and converted accordingly.
  // The function checks for invalid characters and raises an error if 'badcheck' is true and the string
  // contains invalid content such as null bytes or incorrect underscore usage.
  // After parsing, the function uses 'mrb_float_read' to convert the valid portion of the string to a double.
  // <MASK>
  *n = '\0';
  p = buf;
  pend = n;
nocopy:
  d = mrb_float_read(p, &end);
  if (p == end) {
    if (badcheck) {
bad:
      mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid string for float(%!s)", s);
      /* not reached */
    }
    return d;
  }
  if (badcheck) {
    if (!end || p == end) goto bad;
    while (end<pend && ISSPACE(*end)) end++;
    if (end<pend) goto bad;
  }
  return d;
}