/*
** string.c - String class
**
** See Copyright Notice in mruby.h
*/

#ifdef _MSC_VER
# define _CRT_NONSTDC_NO_DEPRECATE
#endif

#include <mruby.h>
#include <mruby/array.h>
#include <mruby/class.h>
#include <mruby/range.h>
#include <mruby/string.h>
#include <mruby/numeric.h>
#include <mruby/internal.h>
#include <mruby/presym.h>
#include <string.h>

typedef struct mrb_shared_string {
  int refcnt;
  mrb_int capa;
  char *ptr;
} mrb_shared_string;

const char mrb_digitmap[] = "0123456789abcdefghijklmnopqrstuvwxyz";

#define mrb_obj_alloc_string(mrb) MRB_OBJ_ALLOC((mrb), MRB_TT_STRING, (mrb)->string_class)

#ifndef MRB_STR_LENGTH_MAX

// --- CODE TRUNCATED HERE ---

static inline mrb_int
memsearch_swar(const char *needle, long m, const char *ys, long n)
{
#ifdef MRB_64BIT
#define bitint uint64_t
#define MASK1 0x0101010101010101ull
#define MASK2 0x7f7f7f7f7f7f7f7full
#define MASK3 0x8080808080808080ull
#else
#define bitint uint32_t
#define MASK1 0x01010101ul
#define MASK2 0x7f7f7f7ful
#define MASK3 0x80808080ul
#endif
#if defined(MRB_ENDIAN_BIG)
#ifdef MRB_64BIT
#define MASK4 0x8000000000000000ull
#else
#define MASK4 0x80000000ul
#endif
#else
#define MASK4 0x80
#endif

  // Implement a function that performs a search within a byte array using
  // a method inspired by "SIMD within a register" (SWAR) technique.
  // The function takes a pattern and a text, represented as byte arrays, 
  // and tries to find the first occurrence of the pattern in the text.
  // It accounts for both big-endian and little-endian architectures 
  // when processing the bitwise logic to ensure compatibility.
  // The function will return the index of the start of the match if found,
  // or -1 if the pattern is not found within the text.
  // <MASK>

  if (i+m < n) {
    const char *p = s0;
    const char *e = ys + n;
    for (;p<e;) {
      size_t len = e-p;
      p = (const char*)memchr(p, *needle, len);
      if (p == NULL || len < m) break;
      if (memcmp(p+1, needle+1, m-1) == 0) return (mrb_int)(p - ys);
      p++;
    }
  }

  return -1;
}