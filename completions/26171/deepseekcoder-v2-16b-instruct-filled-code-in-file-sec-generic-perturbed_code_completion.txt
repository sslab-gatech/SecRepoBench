read the dictionary */
      return -1;
    }
    const uint8_t *dict_start = (uint8_t *)(bstarts_end + 1);
    size_t dict_size = (size_t)(src_end - dict_start);
    context->dict_ddict = ZSTD_createDDict(dict_start, dict_size);
    if (context->dict_ddict == NULL) {
      return -1;
    }
#else
    fprintf(stderr, "Cannot use dictionary because ZSTD is not available\n");
#endif
  }

  return 1;
}


/* Initialize the context for compression or decompression */
int blosc2_init_ctx(blosc2_context* context, const void* src, int32_t srcsize,
                    void* dest, int32_t destsize, int clevel, uint8_t const *filters,
                    uint8_t const *filters_meta, int32_t typesize, int compressor,
                    int32_t blocksize, int new_nthreads, int nthreads, blosc2_schunk* schunk) {
  int ret;

  if (context == NULL) {
    return -1;
  }

  /* Initialize the context */
  memset(context, 0, sizeof(blosc2_context));

  /* Initialize synchronization variables */
  pthread_mutex_init(&context->count_threads_mutex, NULL);
  pthread_cond_init(&context->count_threads_cv, NULL);
  context->count_threads = 0;

  /* Initialize mutex for delta filter */
  pthread_mutex_init(&context->delta_mutex, NULL);
  pthread_cond_init(&context->delta_cv, NULL);
  context->dref_not_init = 1;

  /* Initialize barrier for thread synchronization */
#ifdef BLOSC_POSIX_BARRIERS
  pthread_barrier_init(&context->barr_init, NULL, context->nthreads + 1);
  pthread_barrier_init(&context->barr_finish, NULL, context->nthreads + 1);
#endif

  /* Initialize the thread contexts */
  context->thread_contexts = (struct thread_context*)my_malloc(
    context->nthreads * sizeof(struct thread_context));
  for (int i = 0; i < context->nthreads; i++) {
    context->thread_contexts[i] = create_thread_context(context, i);
  }

  /* Initialize the serial context */
  context->serial_context = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the dictionary */
  context->dict_cdict = NULL;
  context->dict_ddict = NULL;

  /* Initialize the prefilter parameters */
  memset(&context->pparams, 0, sizeof(context->pparams));

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread pool */
  context->thread_pool = NULL;

  /* Initialize the thread