// <MASK>
/* Closes j < nstreams */
for (int j = 0; j < context->nstreams; j++) {
  int32_t cbytes = 0;
  int32_t ntbytes = 0;
  int32_t compformat = (context->header_flags & 0xe0) >> 5;
  int32_t blocksize = context->blocksize;
  int32_t leftoverblock = 0;
  if ((j == context->nstreams - 1) && (context->leftover > 0)) {
    blocksize = context->leftover;
    leftoverblock = 1;
  }
  if (context->do_compress) {
    if (compformat == BLOSC_SHUFFLE) {
      // Shuffle format
      cbytes = blosc_c_shuffle(thread_context, blocksize, leftoverblock, ntbytes,
                               context->destsize, context->src, j * blocksize,
                               context->dest + ntbytes, tmp, tmp2);
    } else if (compformat == BLOSC_BITSHUFFLE) {
      // Bitshuffle format
      cbytes = blosc_c_bitshuffle(thread_context, blocksize, leftoverblock, ntbytes,
                                  context->destsize, context->src, j * blocksize,
                                  context->dest + ntbytes, tmp, tmp2);
    } else {
      // Regular compression
      cbytes = blosc_c(thread_context, blocksize, leftoverblock, ntbytes,
                       context->destsize, context->src, j * blocksize,
                       context->dest + ntbytes, tmp, tmp2);
    }
  } else {
    if (compformat == BLOSC_SHUFFLE) {
      // Shuffle format
      cbytes = blosc_d_shuffle(thread_context, blocksize, leftoverblock, ntbytes,
                               context->srcsize, context->src, j * blocksize,
                               context->dest, tmp, tmp2);
    } else if (compformat == BLOSC_BITSHUFFLE) {
      // Bitshuffle format
      cbytes = blosc_d_bitshuffle(thread_context, blocksize, leftoverblock, ntbytes,
                                  context->srcsize, context->src, j * blocksize,
                                  context->dest, tmp, tmp2);
    } else {
      // Regular decompression
      cbytes = blosc_d(thread_context, blocksize, leftoverblock, ntbytes,
                       context->srcsize, sw32_(context->bstarts + j),
                       context->dest, j * blocksize, tmp, tmp2);
    }
  }

  if (cbytes < 0) {
    ntbytes = cbytes;         /* error in blosc_c or blosc_d */
    break;
  }
  ntbytes += cbytes;
}