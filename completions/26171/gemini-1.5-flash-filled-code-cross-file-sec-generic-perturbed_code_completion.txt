int32_t nstreams = context->nstreams;
  int32_t j;
  int32_t ntbytes = 0;
  int32_t cbytes;
  int32_t* bstarts = context->bstarts;
  int last_filter_index = -1;
  uint8_t* dest_ptr = dest + destinationoffset;

  for (j = 0; j < nstreams; j++) {
    int32_t stream_csize = sw32_(context->src + 12 + j * 4);
    if (stream_csize == 0) continue;
    int32_t stream_usize = sw32_(context->src + 16 + j * 4);
    uint8_t* stream_dest = dest_ptr + j * stream_usize;
    uint8_t* stream_src = context->src + 20 + j * 4;
    uint8_t* stream_tmp = tmp + j * stream_usize;
    uint8_t* stream_tmp2 = tmp2 + j * stream_usize;
    int32_t stream_src_offset = sw32_(bstarts + j);
    int32_t stream_bsize = stream_usize;
    int32_t stream_leftoverblock = 0;
    if (stream_csize > 0) {
      if (stream_csize == stream_usize) {
        memcpy(stream_dest, stream_src, (unsigned int)stream_csize);
        cbytes = stream_csize;
      }
      else if (compformat == BLOSC_FORMAT_ZLIB) {
        cbytes = blosc_zlib_d(thread_context, stream_bsize, stream_leftoverblock,
                              stream_src, stream_csize, stream_src_offset,
                              stream_dest, 0, stream_tmp, stream_tmp2);
      }
      else if (compformat == BLOSC_FORMAT_LZ4) {
        cbytes = blosc_lz4_d(thread_context, stream_bsize, stream_leftoverblock,
                             stream_src, stream_csize, stream_src_offset,
                             stream_dest, 0, stream_tmp, stream_tmp2);
      }
      else if (compformat == BLOSC_FORMAT_LZ4HC) {
        cbytes = blosc_lz4hc_d(thread_context, stream_bsize, stream_leftoverblock,
                               stream_src, stream_csize, stream_src_offset,
                               stream_dest, 0, stream_tmp, stream_tmp2);
      }
      else if (compformat == BLOSC_FORMAT_SNAPPY) {
        cbytes = blosc_snappy_d(thread_context, stream_bsize, stream_leftoverblock,
                                stream_src, stream_csize, stream_src_offset,
                                stream_dest, 0, stream_tmp, stream_tmp2);
      }
      else if (compformat == BLOSC_FORMAT_ZSTD) {
        cbytes = blosc_zstd_d(thread_context, stream_bsize, stream_leftoverblock,
                              stream_src, stream_csize, stream_src_offset,
                              stream_dest, 0, stream_tmp, stream_tmp2);
      }
      else {
        cbytes = -1;
      }
      if (cbytes < 0) return cbytes;
      last_filter_index = context->last_filter_index;
      ntbytes += cbytes;
    }
  }