int32_t j, cbytes;
  int32_t ntbytes = 0;
  int32_t nstreams = context->nstreams;
  int32_t last_filter_index = context->last_filter_index;
  int32_t* bstarts = context->bstarts;
  uint8_t* _src = (uint8_t*)src + src_offset;
  uint8_t* _dest = dest + destinationoffset;
  uint8_t* _tmp = tmp;
  uint8_t* _tmp2 = tmp2;

  for (j = 0; j < nstreams; j++) {
    int32_t csize = sw32_(_src);
    _src += sizeof(int32_t);

    if (csize == 0) {
      /* Uncompressed data */
      memcpy(_dest, _src, (unsigned int)bsize);
      cbytes = bsize;
    }
    else if (csize < 0) {
      /* Run-length encoded data */
      memset(_dest, *_src, (unsigned int)bsize);
      cbytes = bsize;
    }
    else {
      /* Compressed data */
      if (compformat == BLOSC_BLOSCLZ_FORMAT) {
        cbytes = blosclz_decompress(_src, csize, _dest, bsize);
      }
      else if (compformat == BLOSC_LZ4_FORMAT) {
        cbytes = LZ4_decompress_safe((const char*)_src, (char*)_dest, csize, bsize);
      }
      else if (compformat == BLOSC_LZ4HC_FORMAT) {
        cbytes = LZ4_decompress_safe((const char*)_src, (char*)_dest, csize, bsize);
      }
      else if (compformat == BLOSC_ZLIB_FORMAT) {
        cbytes = zlib_decompress(_src, csize, _dest, bsize);
      }
      else if (compformat == BLOSC_ZSTD_FORMAT) {
        cbytes = zstd_decompress(_src, csize, _dest, bsize);
      }
      else {
        return -1;  /* Unknown compression format */
      }
    }

    if (cbytes < 0) {
      return cbytes;  /* Error in decompression */
    }

    _src += csize;
    _dest += bsize;
    ntbytes += bsize;
  }