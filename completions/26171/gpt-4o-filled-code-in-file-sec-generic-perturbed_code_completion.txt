int32_t nstreams;
  int32_t neblock;
  int32_t ctbytes = 0;
  int32_t ntbytes = 0;
  int32_t cbytes;
  int32_t typesize = context->typesize;
  int32_t last_filter_index = last_filter(context->filters, 'd');
  const uint8_t* _src;
  uint8_t* _dest;
  uint8_t* _tmp = tmp;
  uint8_t* _tmp2 = tmp2;

  /* The number of compressed data streams for this block */
  if (compformat == BLOSC_BLOSCLZ_FORMAT) {
    nstreams = 1;
  }
  else {
    nstreams = (leftoverblock) ? 1 : (int32_t)typesize;
  }
  neblock = bsize / nstreams;

  for (int j = 0; j < nstreams; j++) {
    int32_t nblock = sw32_(src + src_offset + j * sizeof(int32_t));
    if (nblock < 0) {
      /* We have a run here.  Extract the value and set it in dest. */
      memset(dest + destinationoffset + j * neblock, -nblock, (unsigned int)neblock);
      cbytes = neblock;
    }
    else {
      _src = src + src_offset + nblock;
      _dest = dest + destinationoffset + j * neblock;
      if (context->compcode == BLOSC_BLOSCLZ) {
        cbytes = blosclz_decompress(_src, (int)srcsize, _dest, (int)neblock);
      }
#if defined(HAVE_LZ4)
      else if (context->compcode == BLOSC_LZ4) {
        cbytes = lz4_wrap_decompress((char*)_src, (size_t)srcsize, (char*)_dest, (size_t)neblock);
      }
      else if (context->compcode == BLOSC_LZ4HC) {
        cbytes = lz4_wrap_decompress((char*)_src, (size_t)srcsize, (char*)_dest, (size_t)neblock);
      }
#endif /* HAVE_LZ4 */
#if defined(HAVE_LIZARD)
      else if (context->compcode == BLOSC_LIZARD) {
        cbytes = lizard_wrap_decompress((char*)_src, (size_t)srcsize, (char*)_dest, (size_t)neblock);
      }
#endif /* HAVE_LIZARD */
#if defined(HAVE_SNAPPY)
      else if (context->compcode == BLOSC_SNAPPY) {
        cbytes = snappy_wrap_decompress((char*)_src, (size_t)srcsize, (char*)_dest, (size_t)neblock);
      }
#endif /* HAVE_SNAPPY */
#if defined(HAVE_ZLIB)
      else if (context->compcode == BLOSC_ZLIB) {
        cbytes = zlib_wrap_decompress((char*)_src, (size_t)srcsize, (char*)_dest, (size_t)neblock);
      }
#endif /* HAVE_ZLIB */
#if defined(HAVE_ZSTD)
      else if (context->compcode == BLOSC_ZSTD) {
        cbytes = zstd_wrap_decompress(thread_context, (char*)_src, (size_t)srcsize, (char*)_dest, (size_t)neblock);
      }
#endif /* HAVE_ZSTD */
      else {
        fprintf(stderr, "Blosc has not been compiled with the requested decompression support. Please use one having it.");
        return -5;    /* signals no decompression support */
      }
    }

    if (cbytes < 0) {
      return cbytes;  /* decompression error */
    }
    if (cbytes == 0) {
      return 0;  /* non-compressible data */
    }
    ctbytes += cbytes;
    ntbytes += neblock;
  }