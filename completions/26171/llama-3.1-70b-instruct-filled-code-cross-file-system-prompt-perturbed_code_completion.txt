int32_t nstreams = (compformat == 0)? 1 : (bsize / (context->typesize * compformat));
int32_t nelements = bsize / (context->typesize * nstreams);
int32_t cbytes = 0, ntbytes = 0;
int32_t j, k, last_filter_index = -1;
uint8_t* dest2 = dest + destinationoffset;
uint8_t* tmp3 = tmp;
uint8_t* tmp4 = tmp2;
int32_t csize, csize2, csize3, csize4;
int32_t dsize, dsize2, dsize3, dsize4;
int32_t offset = 0;
int32_t offset2 = 0;
int32_t offset3 = 0;
int32_t offset4 = 0;
int32_t errcode = 0;

for (j = 0; j < nstreams; j++) {
  csize = sw32_(src + src_offset + offset);
  if (csize == 0) {
    /* Runs */
    if (get_run(src + src_offset + offset + 4, src + src_offset + offset + 4 + nelements)) {
      /* Fill with the run value */
      memset(dest2, src[src_offset + offset + 4], (unsigned int)nelements);
      ntbytes += nelements;
      offset += 4 + nelements;
    }
    else {
      /* Uncompressed data */
      memcpy(dest2, src + src_offset + offset + 4, (unsigned int)nelements);
      ntbytes += nelements;
      offset += 4 + nelements;
    }
  }
  else {
    /* Compressed data */
    if (csize > 0) {
      if (csize <= BLOSC_MAX_OVERHEAD) {
        /* Error: invalid compressed size */
        return -1;
      }
      if (csize > bsize) {
        /* Error: compressed size larger than block size */
        return -1;
      }
      if (context->header_flags & (uint8_t)BLOSC_MEMCPYED) {
        /* memcpy only */
        memcpy(dest2, src + src_offset + offset + 4, (unsigned int)csize);
        ntbytes += csize;
        offset += 4 + csize;
      }
      else {
        if (filters[0] == BLOSC_NOFILTER) {
          /* No filters */
          dsize = blosc_d_nofilter(src + src_offset + offset + 4, csize, dest2, nelements, tmp3);
        }
        else {
          /* With filters */
          dsize = blosc_d_with_filters(src + src_offset + offset + 4, csize, dest2, nelements, tmp3, tmp4, filters, &last_filter_index);
        }
        if (dsize < 0) {
          return dsize;
        }
        ntbytes += dsize;
        offset += 4 + csize;
      }
    }
    else {
      /* Error: invalid compressed size */
      return -1;
    }
  }
  dest2 += nelements;
}