int32_t nstreams = (compformat == BLOSC_BLOSCLZ) ? 1 : BLOSC2_MAX_STREAMS;
  int32_t last_filter_index = -1;
  int32_t ntbytes = 0;
  int32_t cbytes;

  for (int j = 0; j < nstreams; j++) {
    if (compformat == BLOSC_BLOSCLZ) {
      cbytes = blosclz_decompress(src + src_offset, srcsize, dest + destinationoffset, bsize);
    }
    else {
      cbytes = blosc2_decompress(src + src_offset, srcsize, dest + destinationoffset, bsize, compformat);
    }

    if (cbytes < 0) {
      return cbytes;
    }

    ntbytes += cbytes;
    src_offset += cbytes;
    srcsize -= cbytes;

    // Check if we need to apply filters
    if (filters[j] != BLOSC_NOFILTER) {
      last_filter_index = j;
    }
  }