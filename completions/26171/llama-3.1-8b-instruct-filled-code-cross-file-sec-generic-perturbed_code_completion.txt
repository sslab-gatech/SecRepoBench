// <MASK>
/* Closes j < nstreams */
  for (int j = 0; j < context->nstreams; j++) {
    int32_t cbytes = 0;
    int32_t ntbytes = 0;
    int32_t compformat = (context->header_flags & 0xe0) >> 5;
    int32_t blocksize = context->blocksize;
    int32_t leftoverblock = 0;
    if ((j == context->nstreams - 1) && (context->leftover > 0)) {
      blocksize = context->leftover;
      leftoverblock = 1;
    }
    if (context->do_compress) {
      if (compformat == BLOSC_ZLIB) {
        cbytes = blosc_c_zlib(thread_context, blocksize, leftoverblock, ntbytes,
                              context->destsize, context->src, j * blocksize,
                              context->dest + ntbytes, tmp, tmp2);
      } else if (compformat == BLOSC_LZ4) {
        cbytes = blosc_c_lz4(thread_context, blocksize, leftoverblock, ntbytes,
                             context->destsize, context->src, j * blocksize,
                             context->dest + ntbytes, tmp, tmp2);
      } else if (compformat == BLOSC_SNAPPY) {
        cbytes = blosc_c_snappy(thread_context, blocksize, leftoverblock, ntbytes,
                                context->destsize, context->src, j * blocksize,
                                context->dest + ntbytes, tmp, tmp2);
      } else if (compformat == BLOSC_ZSTD) {
        cbytes = blosc_c_zstd(thread_context, blocksize, leftoverblock, ntbytes,
                              context->destsize, context->src, j * blocksize,
                              context->dest + ntbytes, tmp, tmp2);
      } else {
        cbytes = blosc_c(thread_context, blocksize, leftoverblock, ntbytes,
                         context->destsize, context->src, j * blocksize,
                         context->dest + ntbytes, tmp, tmp2);
      }
    } else {
      if (compformat == BLOSC_ZLIB) {
        cbytes = blosc_d_zlib(thread_context, blocksize, leftoverblock, ntbytes,
                              context->src, context->srcsize, sw32_(context->bstarts + j),
                              context->dest, j * blocksize, tmp, tmp2);
      } else if (compformat == BLOSC_LZ4) {
        cbytes = blosc_d_lz4(thread_context, blocksize, leftoverblock, ntbytes,
                             context->src, context->srcsize, sw32_(context->bstarts + j),
                             context->dest, j * blocksize, tmp, tmp2);
      } else if (compformat == BLOSC_SNAPPY) {
        cbytes = blosc_d_snappy(thread_context, blocksize, leftoverblock, ntbytes,
                                context->src, context->srcsize, sw32_(context->bstarts + j),
                                context->dest, j * blocksize, tmp, tmp2);
      } else if (compformat == BLOSC_ZSTD) {
        cbytes = blosc_d_zstd(thread_context, blocksize, leftoverblock, ntbytes,
                              context->src, context->srcsize, sw32_(context->bstarts + j),
                              context->dest, j * blocksize, tmp, tmp2);
      } else {
        cbytes = blosc_d(thread_context, blocksize, leftoverblock, ntbytes,
                         context->src, context->srcsize, sw32_(context->bstarts + j),
                         context->dest, j * blocksize, tmp, tmp2);
      }
    }

    if (cbytes < 0) {
      ntbytes = cbytes;         /* error in blosc_c or blosc_d */
      break;
    }
    ntbytes += cbytes;
  }