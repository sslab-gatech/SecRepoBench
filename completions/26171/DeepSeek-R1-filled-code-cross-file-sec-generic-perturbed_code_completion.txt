int32_t ctbytes = 0;
  ntbytes = 0;
  int32_t nstreams = (compformat == 0) ? 1 : 1;  // Adjust based on actual compformats
  int32_t csize;
  last_filter_index = -1;

  for (int j = 0; j < nstreams; j++) {
    if (src_offset + ctbytes + 4 > srcsize) return -1;
    csize = sw32_(src + src_offset + ctbytes);
    ctbytes += 4;

    if (csize < 0) {
      if (-csize != bsize) return -1;
      if (src_offset + ctbytes >= srcsize) return -1;
      uint8_t run_byte = src[src_offset + ctbytes];
      ctbytes++;
      memset(tmp, run_byte, bsize);
      ntbytes = bsize;
    } else if (csize == 0) {
      return -1;
    } else {
      if (src_offset + ctbytes + csize > srcsize) return -1;
      if (csize == bsize) {
        memcpy(tmp, src + src_offset + ctbytes, bsize);
        ntbytes = bsize;
        ctbytes += bsize;
      } else {
        int32_t decompressed;
        switch (compformat) {
          case 0:  // BLOSC_BLOSCLZ
            decompressed = blosclz_decompress(src + src_offset + ctbytes, csize, tmp, bsize);
            break;
          // Add other decompression formats here
          default:
            return -1;
        }
        if (decompressed != bsize) return -1;
        ntbytes = bsize;
        ctbytes += csize;
      }
    }
  }

  for (int i = BLOSC2_MAX_FILTERS - 1; i >= 0; i--) {
    if (filters[i] != BLOSC_NOFILTER) {
      last_filter_index = i;
      break;
    }
  }