int32_t nstreams = 1;
  int32_t stream_size = srcsize;
  int32_t last_filter_index = -1;
  int32_t cbytes;
  int32_t ntbytes = (int32_t)bsize;
  int32_t stream_offset = src_offset;

  if (compformat == 1) {
    nstreams = context->nthreads;
    stream_size = srcsize / nstreams;
  }

  if (filters[0] != BLOSC_NOFILTER) {
    /* We have filters, so use tmp as destination */
    dest = tmp;
  }

  for (int j = 0; j < nstreams; j++) {
    int32_t csize;

    if (compformat == 1) {
      csize = sw32_((src + stream_offset));
      stream_offset += 4;
    }
    else {
      csize = srcsize;
    }

    if (csize == 0) {
      /* Run detected */
      if (get_run(src + stream_offset, src + stream_offset + bsize)) {
        memset(dest + destinationoffset, src[stream_offset], (size_t)bsize);
      }
      else {
        /* Not a run.  Return error. */
        return -4;
      }
    }
    else if (csize > 0) {
      /* Decompress block */
      int errcode = blosc_decompress_format(
          src + stream_offset, csize, dest + destinationoffset, bsize,
          filters, context->filter_flags, context->schunk);
      if (errcode < 0) {
        /* Decompression error */
        return errcode;
      }
      last_filter_index = errcode;
    }
    else {
      /* Uncompressed block */
      memcpy(dest + destinationoffset, src + stream_offset + 4, (size_t)bsize);
    }

    if (compformat == 1) {
      stream_offset += abs(csize);
    }
    destinationoffset += bsize;
  }