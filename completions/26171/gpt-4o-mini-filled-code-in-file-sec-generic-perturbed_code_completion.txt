int ntbytes = 0;                /* the number of uncompressed bytes */
  int32_t bsize;                  /* size of the current block */
  int32_t leftoverblock;          /* extra bytes at end of buffer */
  int32_t* bstarts;               /* start pointers for each block */
  int32_t typesize, blocksize, cbytes;
  uint8_t* _src = (uint8_t*)src;  /* current pos for source buffer */
  
  /* Read the header block */
  if (srcsize < BLOSC_MIN_HEADER_LENGTH) {
    /* Not enough input to parse Blosc header */
    return -1;
  }
  
  /* Read the interesting values */
  blocksize = sw32_(_src + 8);    /* block size */
  bstarts = (int32_t*)(_src + BLOSC_MIN_HEADER_LENGTH);
  
  /* Total blocks */
  int32_t nblocks = context->nblocks;
  int32_t leftover = context->leftover;
  
  for (int j = 0; j < nblocks; j++) {
    bsize = blocksize;
    leftoverblock = 0;
    if ((j == nblocks - 1) && (leftover > 0)) {
      bsize = leftover;
      leftoverblock = 1;
    }

    /* Regular decompression */
    cbytes = blosc_d(thread_context, bsize, leftoverblock,
                     src, srcsize, sw32_(bstarts + j),
                     dest, destinationoffset + ntbytes, tmp, tmp2);
    if (cbytes < 0) {
      return cbytes;  // error in decompression
    }
    ntbytes += cbytes;
  }