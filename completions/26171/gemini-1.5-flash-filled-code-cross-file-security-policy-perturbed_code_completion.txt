int32_t i, j, k, nstreams, last_filter_index = -1;
  int32_t cbytes, ntbytes = 0;
  int32_t* bstarts = context->bstarts;
  uint8_t* dest_ptr = dest + destinationoffset;
  uint8_t* src_ptr = (uint8_t*)src + src_offset;
  int32_t remaining_bytes = srcsize;
  bool memcpyed = context->header_flags & (uint8_t)BLOSC_MEMCPYED;

  nstreams = context->nstreams;
  for (j = 0; j < nstreams; j++) {
    int32_t csize;
    if (memcpyed) {
      csize = sw32_(src_ptr + 12); /* compressed buffer size */
      if (remaining_bytes < 16) {
        return -1;
      }
      if (remaining_bytes < csize) {
        return -1;
      }
      memcpy(dest_ptr, src_ptr + 16, (unsigned int)csize);
      cbytes = csize;
      src_ptr += 16 + csize;
      remaining_bytes -= 16 + csize;
    }
    else {
      if (remaining_bytes < 4) {
        return -1;
      }
      csize = sw32_(src_ptr);
      src_ptr += 4;
      remaining_bytes -= 4;
      if (csize == 0) {
        /* uncompressible data */
        cbytes = 0;
      }
      else if (csize < 0) {
        /* run */
        int32_t run_length = -csize;
        if (remaining_bytes < run_length) {
          return -1;
        }
        memset(dest_ptr, src_ptr[0], run_length);
        cbytes = run_length;
        src_ptr += run_length;
        remaining_bytes -= run_length;
      }
      else {
        /* compressed data */
        if (remaining_bytes < csize) {
          return -1;
        }
        int errcode = blosc_decompress_internal(
            context, compformat, csize, src_ptr, dest_ptr, tmp, tmp2, tmp3);
        if (errcode < 0) {
          return errcode;
        }
        cbytes = csize;
        src_ptr += csize;
        remaining_bytes -= csize;
      }
    }
    if (cbytes < 0) {
      return cbytes;
    }
    ntbytes += cbytes;
    dest_ptr += cbytes;
    last_filter_index = context->last_filter_index;
  }