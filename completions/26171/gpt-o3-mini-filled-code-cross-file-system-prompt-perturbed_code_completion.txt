int ntbytes = 0;
int nstreams = 1;  /* In practice, this might be >1 if the block was split */
int streamsize = bsize;

for (int j = 0; j < nstreams; j++) {
  int32_t cbytes;

  /* Read the compressed size for this stream (stored in little‐endian) */
  if (src_offset + 4 > srcsize) {
    return -5;  /* Not enough data to read the stream header */
  }
  cbytes = sw32_(src + src_offset);
  src_offset += 4;

  if (cbytes == streamsize) {
    /* Uncompressed stream: copy directly */
    if (src_offset + streamsize > srcsize) {
      return -6;
    }
    memcpy(dest + destinationoffset, src + src_offset, streamsize);
    src_offset += streamsize;
  }
  else if (cbytes == 1) {
    /* Run‐length encoded stream: the next byte is the repeated value */
    if (src_offset >= srcsize) {
      return -7;
    }
    uint8_t run_value = src[src_offset++];
    memset(dest + destinationoffset, run_value, streamsize);
  }
  else if (cbytes < streamsize) {
    /* Compressed stream: decompress using the appropriate algorithm */
    int res = 0;
    switch (compformat) {
      case BLOSC_BLOSCLZ:
        res = blosclz_decompress(src + src_offset, cbytes,
                                 dest + destinationoffset, streamsize);
        break;
      case BLOSC_LZ4:
        res = lz4_decompress(src + src_offset, cbytes,
                             dest + destinationoffset, streamsize);
        break;
      case BLOSC_ZLIB:
        res = zlib_decompress(src + src_offset, cbytes,
                              dest + destinationoffset, streamsize);
        break;
      default:
        return -8;  /* Unknown compression format */
    }
    if (res != streamsize) {
      return -9;  /* Decompression error */
    }
    src_offset += cbytes;
  }
  else {
    /* Invalid compressed block size */
    return -10;
  }

  destinationoffset += streamsize;
  ntbytes += streamsize;
}

/* Determine the last filter to be applied (if any) */
int last_filter_index = -1;
for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
  if (filters[i] != BLOSC_NOFILTER) {
    last_filter_index = i;
  }
}