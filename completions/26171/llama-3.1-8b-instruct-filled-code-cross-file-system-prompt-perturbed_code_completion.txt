/* Closes j < nstreams */
for (j = 0; j < context->nstreams; j++) {
  int32_t cbytes;
  int32_t ntbytes = 0;
  int32_t compformat = (context->header_flags & 0xe0) >> 5;
  uint8_t* dest = context->dest + j * context->blocksize;
  uint8_t* src = context->src + BLOSC_MAX_OVERHEAD + j * context->blocksize;
  uint8_t* tmp = thread_context->tmp;
  uint8_t* tmp2 = thread_context->tmp2;
  uint8_t* tmp3 = thread_context->tmp4;

  if (context->do_compress) {
    if (compformat == BLOSC_ZLIB) {
      cbytes = zlib_compress(context->blocksize, src, context->blocksize, dest, tmp, tmp2);
    } else if (compformat == BLOSC_LZ4) {
      cbytes = lz4_compress(context->blocksize, src, context->blocksize, dest, tmp, tmp2);
    } else if (compformat == BLOSC_SNAPPY) {
      cbytes = snappy_compress(context->blocksize, src, context->blocksize, dest, tmp, tmp2);
    } else {
      cbytes = blosc_c(thread_context, context->blocksize, 0, 0, context->blocksize, src, 0, dest, tmp, tmp2);
    }
  } else {
    if (compformat == BLOSC_ZLIB) {
      cbytes = zlib_decompress(context->blocksize, src, context->blocksize, dest, tmp, tmp2);
    } else if (compformat == BLOSC_LZ4) {
      cbytes = lz4_decompress(context->blocksize, src, context->blocksize, dest, tmp, tmp2);
    } else if (compformat == BLOSC_SNAPPY) {
      cbytes = snappy_decompress(context->blocksize, src, context->blocksize, dest, tmp, tmp2);
    } else {
      cbytes = blosc_d(thread_context, context->blocksize, 0, src, context->blocksize, 0, dest, 0, tmp, tmp2);
    }
  }

  if (cbytes < 0) {
    ntbytes = cbytes;         /* error in blosc_c or blosc_d */
    break;
  }
  ntbytes += cbytes;
}