int32_t)(src_end - (uint8_t *)(bstarts_end + 1));
    context->dict_ddict = ZSTD_createDDict((void *)(bstarts_end + 1), context->dict_size);
    if (context->dict_ddict == NULL) {
      return -1;
    }
#else
    fprintf(stderr, "Cannot use dictionary because ZSTD is not available\n");
#endif
  }

  return 1;
}


/* Initialize the context for compression or decompression */
int blosc2_init_ctx(blosc2_context* context, const void* src, int32_t srcsize,
                    void* dest, int32_t destsize, int clevel, uint8_t const *filters,
                    uint8_t const *filters_meta, int32_t typesize, int compressor,
                    int32_t blocksize, int new_nthreads, int nthreads, blosc2_schunk* schunk) {
  int ret;

  if (src == NULL || dest == NULL || filters == NULL || filters_meta == NULL) {
    return -1;
  }

  /* Initialize the context */
  memset(context, 0, sizeof(blosc2_context));

  /* Initialize synchronization variables */
  pthread_mutex_init(&context->count_threads_mutex, NULL);
  pthread_cond_init(&context->count_threads_cv, NULL);
  context->count_threads = 0;

  /* Initialize the filter pipeline */
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    context->filters[i] = filters[i];
    context->filters_meta[i] = filters_meta[i];
  }

  /* Initialize the thread pool */
  context->thread_contexts = my_malloc(nthreads * sizeof(struct thread_context*));
  for (int i = 0; i < nthreads; i++) {
    context->thread_contexts[i] = NULL;
  }

  /* Initialize the thread pool */
  if (initialize_context_compression(context, src, srcsize, dest, destsize, clevel,
                                     filters, filters_meta, typesize, compressor,
                                     blocksize, new_nthreads, nthreads, schunk) < 0) {
    return -1;
  }

  return 1;
}


/* Initialize the context for decompression */
int blosc2_init_dctx(blosc2_context* context, const void* src, int32_t srcsize,
                     void* dest, int32_t destsize) {
  int ret;

  if (src == NULL || dest == NULL) {
    return -1;
  }

  /* Initialize the context */
  memset(context, 0, sizeof(blosc2_context));

  /* Initialize synchronization variables */
  pthread_mutex_init(&context->count_threads_mutex, NULL);
  pthread_cond_init(&context->count_threads_cv, NULL);
  context->count_threads = 0;

  /* Initialize the thread pool */
  context->thread_contexts = my_malloc(nthreads * sizeof(struct thread_context*));
  for (int i = 0; i < nthreads; i++) {
    context->thread_contexts[i] = NULL;
  }

  /* Initialize the thread pool */
  if (initialize_context_decompression(context, src, srcsize, dest, destsize) < 0) {
    return -1;
  }

  return 1;
}


/* Free the context for compression or decompression */
void blosc2_free_ctx(blosc2_context* context) {
  if (context == NULL) {
    return;
  }

  /* Free the thread pool */
  for (int i = 0; i < context->nthreads; i++) {
    if (context->thread_contexts[i] != NULL) {
      free_thread_context(context->thread_contexts[i]);
    }
  }
  my_free(context->thread_contexts);

  /* Free synchronization variables */
  pthread_mutex_destroy(&context->count_threads_mutex);
  pthread_cond_destroy(&context->count_threads_cv);

  /* Free the context */
  memset(context, 0, sizeof(blosc2_context));
}


/* Perform the compression or decompression */
int blosc2_do_compress(blosc2_context* context) {
  return do_job(context);
}

int blosc2_do_decompress(blosc2_context* context) {
  return do_job(context);
}


/* Get the number of bytes (de-)compressed */
int64_t blosc2_get_nbytes(blosc2_context* context) {
  return context->output_bytes;
}


/* Get the number of bytes in the input buffer */
int64_t blosc2_get_cbytes(blosc2_context* context) {
  return context->sourcesize;
}


/* Get the number of bytes in the output buffer */
int64_t blosc2_get_dbytes(blosc2_context* context) {
  return context->output_bytes;
}


/* Get the number of blocks in the input buffer */
int64_t blosc2_get_nblocks(blosc2_context* context) {
  return context->nblocks;
}


/* Get the number of threads used */
int64_t blosc2_get_nthreads(blosc2_context* context) {
  return context->nthreads;
}


/* Get the compressor used */
const char* blosc2_get_compressor(blosc2_context* context) {
  const char* compname;
  blosc_compcode_to_compname(context->compcode, &compname);
  return compname;
}


/* Get the filter flags */
uint8_t blosc2_get_filter_flags(blosc2_context* context) {
  return context->filter_flags;
}


/* Get the filter pipeline */
void blosc2_get_filters(blosc2_context* context, uint8_t* filters) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters[i] = context->filters[i];
  }
}


/* Get the filter metadata */
void blosc2_get_filters_meta(blosc2_context* context, uint8_t* filters_meta) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters_meta[i] = context->filters_meta[i];
  }
}


/* Get the typesize */
int32_t blosc2_get_typesize(blosc2_context* context) {
  return context->typesize;
}


/* Get the compression level */
int blosc2_get_clevel(blosc2_context* context) {
  return context->clevel;
}


/* Get the blocksize */
int32_t blosc2_get_blocksize(blosc2_context* context) {
  return context->blocksize;
}


/* Get the number of threads used */
int blosc2_get_nthreads(blosc2_context* context) {
  return context->nthreads;
}


/* Get the compressor used */
const char* blosc2_get_compressor(blosc2_context* context) {
  const char* compname;
  blosc_compcode_to_compname(context->compcode, &compname);
  return compname;
}


/* Get the filter flags */
uint8_t blosc2_get_filter_flags(blosc2_context* context) {
  return context->filter_flags;
}


/* Get the filter pipeline */
void blosc2_get_filters(blosc2_context* context, uint8_t* filters) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters[i] = context->filters[i];
  }
}


/* Get the filter metadata */
void blosc2_get_filters_meta(blosc2_context* context, uint8_t* filters_meta) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters_meta[i] = context->filters_meta[i];
  }
}


/* Get the typesize */
int32_t blosc2_get_typesize(blosc2_context* context) {
  return context->typesize;
}


/* Get the compression level */
int blosc2_get_clevel(blosc2_context* context) {
  return context->clevel;
}


/* Get the blocksize */
int32_t blosc2_get_blocksize(blosc2_context* context) {
  return context->blocksize;
}


/* Get the number of threads used */
int blosc2_get_nthreads(blosc2_context* context) {
  return context->nthreads;
}


/* Get the compressor used */
const char* blosc2_get_compressor(blosc2_context* context) {
  const char* compname;
  blosc_compcode_to_compname(context->compcode, &compname);
  return compname;
}


/* Get the filter flags */
uint8_t blosc2_get_filter_flags(blosc2_context* context) {
  return context->filter_flags;
}


/* Get the filter pipeline */
void blosc2_get_filters(blosc2_context* context, uint8_t* filters) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters[i] = context->filters[i];
  }
}


/* Get the filter metadata */
void blosc2_get_filters_meta(blosc2_context* context, uint8_t* filters_meta) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters_meta[i] = context->filters_meta[i];
  }
}


/* Get the typesize */
int32_t blosc2_get_typesize(blosc2_context* context) {
  return context->typesize;
}


/* Get the compression level */
int blosc2_get_clevel(blosc2_context* context) {
  return context->clevel;
}


/* Get the blocksize */
int32_t blosc2_get_blocksize(blosc2_context* context) {
  return context->blocksize;
}


/* Get the number of threads used */
int blosc2_get_nthreads(blosc2_context* context) {
  return context->nthreads;
}


/* Get the compressor used */
const char* blosc2_get_compressor(blosc2_context* context) {
  const char* compname;
  blosc_compcode_to_compname(context->compcode, &compname);
  return compname;
}


/* Get the filter flags */
uint8_t blosc2_get_filter_flags(blosc2_context* context) {
  return context->filter_flags;
}


/* Get the filter pipeline */
void blosc2_get_filters(blosc2_context* context, uint8_t* filters) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters[i] = context->filters[i];
  }
}


/* Get the filter metadata */
void blosc2_get_filters_meta(blosc2_context* context, uint8_t* filters_meta) {
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    filters_meta[i] = context->filters_meta[i];
  }
}


/* Get the typesize */
int32_t blosc2_get_typesize(blosc2_context* context) {
  return context->typesize;
}


/* Get the compression level */
int blosc2_get_clevel(blosc2_context* context) {
  return context->clevel;
}


/* Get the blocks