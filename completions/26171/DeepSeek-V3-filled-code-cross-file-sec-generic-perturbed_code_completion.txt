int32_t nstreams = (compformat == BLOSC_BLOSCLZ) ? 1 : 2;
  int32_t last_filter_index = -1;
  int32_t ntbytes = 0;
  uint8_t* destp = dest + destinationoffset;
  uint8_t* srcp = (uint8_t*)(src + src_offset);

  for (int j = 0; j < nstreams; j++) {
    int32_t cbytes;
    if (compformat == BLOSC_BLOSCLZ) {
      cbytes = blosclz_decompress(srcp, srcsize, destp, bsize);
    }
    else {
      int32_t stream_size = sw32_(srcp);
      srcp += 4;
      if (compformat == BLOSC_LZ4) {
        cbytes = lz4_decompress(srcp, stream_size, destp, bsize);
      }
      else if (compformat == BLOSC_ZSTD) {
        cbytes = zstd_decompress(srcp, stream_size, destp, bsize);
      }
      else {
        return -1;  // Unsupported compression format
      }
      srcp += stream_size;
    }

    if (cbytes < 0) {
      return cbytes;  // Decompression error
    }

    if (cbytes == 0) {
      // Uncompressed block
      memcpy(destp, srcp, bsize);
      ntbytes += bsize;
      srcp += bsize;
    }
    else {
      ntbytes += cbytes;
    }

    // Check if we need to apply filters
    if (filters[j] != BLOSC_NOFILTER) {
      last_filter_index = j;
    }
  }