int32_t nstreams = context->nstreams;
int32_t typesize = context->typesize;
int32_t j, neblock;
int32_t cbytes;
int32_t ctbytes = 0;
int32_t ntbytes = 0;
uint8_t* _src = (uint8_t*)src + src_offset;
uint8_t* _dest = dest + destinationoffset;
int last_filter_index = filters[BLOSC2_MAX_FILTERS - 1] != BLOSC_NOFILTER ? BLOSC2_MAX_FILTERS - 1 : -1;

neblock = bsize / typesize;

for (j = 0; j < nstreams; j++) {
  cbytes = sw32_(_src);
  _src += sizeof(int32_t);
  ctbytes += (int32_t)sizeof(int32_t);

  if (cbytes == 0) {
    // A run of zeros
    memset(_dest, 0, (unsigned int)neblock);
    _dest += neblock;
  } else if (cbytes == (int32_t)neblock) {
    // Uncompressed data
    memcpy(_dest, _src, (unsigned int)neblock);
    _src += neblock;
    _dest += neblock;
    ctbytes += (int32_t)neblock;
  } else if (cbytes < 0) {
    // Run-length encoding
    int32_t run_size = -cbytes;
    if (run_size > neblock) {
      return BLOSC2_ERROR_WRITE_BUFFER;
    }
    if (get_run(_src, _src + run_size)) {
      memset(_dest, *_src, (unsigned int)run_size);
    } else {
      memcpy(_dest, _src, (unsigned int)run_size);
    }
    _src += run_size;
    _dest += run_size;
    ctbytes += run_size;
  } else {
    // Regular compressed data
    if (compformat == BLOSC_BLOSCLZ_FORMAT) {
      int32_t decomp_size = blosclz_decompress(_src, cbytes, _dest, neblock);
      if (decomp_size != neblock) {
        return BLOSC2_ERROR_WRITE_BUFFER;
      }
    } else if (compformat == BLOSC_LZ4_FORMAT) {
      int32_t decomp_size = LZ4_decompress_safe((const char*)_src, (char*)_dest, cbytes, neblock);
      if (decomp_size != neblock) {
        return BLOSC2_ERROR_WRITE_BUFFER;
      }
    } else if (compformat == BLOSC_ZLIB_FORMAT) {
      unsigned long decomp_size = neblock;
      int ret = uncompress(_dest, &decomp_size, _src, cbytes);
      if (ret != Z_OK || decomp_size != neblock) {
        return BLOSC2_ERROR_WRITE_BUFFER;
      }
    } else {
      return BLOSC2_ERROR_CODEC_SUPPORT;
    }
    _src += cbytes;
    _dest += neblock;
    ctbytes += cbytes;
  }
  ntbytes += neblock;
}