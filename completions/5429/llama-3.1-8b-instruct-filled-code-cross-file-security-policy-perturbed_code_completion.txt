if (image->storage_class!= PseudoClass)
  {
    ssize_t max_colormap_size = image->columns * image->rows;
    ssize_t *c_mp_i = (ssize_t *) AcquireMemory(max_colormap_size * sizeof(*c_mp_i));
    if (c_mp_i == (ssize_t *) NULL)
      {
        ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
          image->filename);
      }
    (void) ResetMagickMemory(c_mp_i,(-1),max_colormap_size*sizeof(*c_mp_i));
    if (AcquireImageColormap(image,max_colormap_size,exception) == MagickFalse)
      {
        c_mp_i=(ssize_t *) RelinquishMagickMemory(c_mp_i);
        ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
          image->filename);
      }
    image->colors=0;
    status=MagickTrue;
    image_view=AcquireAuthenticCacheView(image,exception);
#if defined(MAGICKCORE_OPENMP_SUPPORT)
  #pragma omp parallel for schedule(static,4) shared(status) \
    magick_number_threads(image,image,image->rows,1)
#endif
    for (y=0; y < (ssize_t) image->rows; y++)
    {
      register Quantum
        *magick_restrict q;

      register ssize_t
        x;

      if (status == MagickFalse)
        continue;
      q=GetCacheViewAuthenticPixels(image_view,0,y,image->columns,1,
        exception);
      if (q == (Quantum *) NULL)
        {
          status=MagickFalse;
          continue;
        }
      for (x=0; x < (ssize_t) image->columns; x++)
      {
        register size_t
          intensity;

        intensity=ScaleQuantumToMap(GetPixelRed(image,q));
        if (c_mp_i[intensity] < 0)
          {
#if defined(MAGICKCORE_OPENMP_SUPPORT)
            #pragma omp critical (MagickCore_SetGrayscaleImage)
#endif
            if (c_mp_i[intensity] < 0)
              {
                c_mp_i[intensity]=(ssize_t) image->colors;
                image->colormap[image->colors].red=(double)
                  GetPixelRed(image,q);
                image->colormap[image->colors].green=(double)
                  GetPixelGreen(image,q);
                image->colormap[image->colors].blue=(double)
                  GetPixelBlue(image,q);
                image->colors++;
             }
          }
        SetPixelIndex(image,(Quantum) c_mp_i[intensity],q);
        q+=GetPixelChannels(image);
      }
      if (SyncCacheViewAuthenticPixels(image_view,exception) == MagickFalse)
        status=MagickFalse;
    }
    image_view=DestroyCacheView(image_view);
  }