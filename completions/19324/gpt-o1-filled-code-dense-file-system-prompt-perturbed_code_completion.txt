NDPI_LOG_DBG(ndpi_struct, "search MEMCACHED\n");
u_int32_t *matches = NULL;

/* Check if packet uses TCP or UDP */
if(packet->tcp != NULL) {
  /* For TCP, ensure minimum payload length */
  if(packet->payload_packet_len < 4) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
  /* Point `matches` to TCP-specific memcached counter */
  matches = &stream->l4.tcp.memcached_matches;
} else if(packet->udp != NULL) {
  /* For UDP, ensure minimum payload length, then skip UDP header */
  if(packet->payload_packet_len < 12) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
  offset += 8;
  packet->payload_packet_len -= 8;

  /* Point `matches` to UDP-specific memcached counter */
  matches = &stream->l4.udp.memcached_matches;
} else {
  /* Neither TCP nor UDP */
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}