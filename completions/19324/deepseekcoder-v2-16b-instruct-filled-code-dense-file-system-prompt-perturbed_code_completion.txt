u_int16_t payload_len = packet->payload_packet_len;
  u_int16_t min_length = 0;
  u_int8_t protocol_type = 0;

  if (packet->udp != NULL) {
    // For UDP packets, skip the UDP header length
    payload_len -= 8; // Assuming UDP header length is 8 bytes
    protocol_type = NDPI_PROTOCOL_MEMCACHED_UDP;
    min_length = 8; // Minimum length for UDP packets
  } else if (packet->tcp != NULL) {
    protocol_type = NDPI_PROTOCOL_MEMCACHED_TCP;
    min_length = 14; // Minimum length for TCP packets including TCP header
  } else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  if (payload_len < min_length) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  // Adjust the offset and length for UDP packets by skipping the UDP header length.
  offset += 8; // Assuming UDP header length is 8 bytes
  payload_len -= 8; // Adjust payload length for UDP packets

  // Update the `matches` pointer to point to the appropriate memcached matches counter
  // within the flow structure based on the protocol type.
  u_int16_t *matches = (protocol_type == NDPI_PROTOCOL_MEMCACHED_UDP) ? &flow->memcached_udp_matches : &flow->memcached_tcp_matches;

  // Check for memcached matches
  if (!MEMCACHED_MATCH(MCDC_GET)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_GETS)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_DELETE)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_INCR)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_DECR)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_TOUCH)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_GAT)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_GATS)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDC_STATS)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_ERROR)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_CLIENT_ERROR)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_SERVER_ERROR)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_STORED)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_NOT_STORED)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_EXISTS)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_NOT_FOUND)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_END)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_DELETED)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_TOUCHED)) *matches += 1;
  else if (!MEMCACHED_MATCH(MCDR_STAT)) *matches += 1;

  if (*matches >= MEMCACHED_MIN_MATCH)
    ndpi_int_memcached_add_connection(ndpi_struct, stream);