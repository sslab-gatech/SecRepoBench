{
  u_int16_t length = packet->payload_packet_len;
  u_int16_t *matches = NULL;

  NDPI_LOG_DBG2(ndpi_struct, "search memcached\n");

  /* Check if it's UDP or TCP */
  if(packet->udp) {
    /* UDP requires enough length for header + minimal memcached command/response */
    if(length < MEMCACHED_MIN_UDP_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    /* For memcached UDP operations, first 2 bytes in payload are typically zero */
    if(offset[0] != 0 || offset[1] != 0) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    /* Skip the memcached UDP header */
    offset += MEMCACHED_UDP_HDR_LEN;
    length -= MEMCACHED_UDP_HDR_LEN;

    /* Point matches to the flow's UDP memcached counter */
    matches = &stream->l4.udp.memcached_matches;
  } else {
    /* For TCP, check minimal memcached command/response length */
    if(length < MEMCACHED_MIN_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    /* Point matches to the flow's TCP memcached counter */
    matches = &stream->l4.tcp.memcached_matches;
  }

  if(!matches) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
}