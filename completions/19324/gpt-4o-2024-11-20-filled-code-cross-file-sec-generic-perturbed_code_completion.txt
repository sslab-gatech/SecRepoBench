// Check if the packet is TCP or UDP
  if (packet->l4_protocol == IPPROTO_TCP) {
    // Ensure the packet length is sufficient for memcached protocol
    if (packet->payload_packet_len < MEMCACHED_MIN_TCP_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }
  } else if (packet->l4_protocol == IPPROTO_UDP) {
    // Ensure the packet length is sufficient for memcached protocol
    if (packet->payload_packet_len < MEMCACHED_MIN_UDP_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    // Adjust offset and length for UDP by skipping the UDP header
    offset += UDP_HEADER_LEN;
    packet->payload_packet_len -= UDP_HEADER_LEN;
  } else {
    // Exclude protocol if it's neither TCP nor UDP
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  // Initialize matches pointer based on protocol type
  u_int32_t *matches = (packet->l4_protocol == IPPROTO_TCP) 
                       ? &stream->l4.tcp.memcached_matches 
                       : &stream->l4.udp.memcached_matches;

  // If matches pointer is null, exclude protocol and return
  if (matches == NULL) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }