NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

u_int16_t length = packet->payload_packet_len;
u_int16_t *matches;

if (packet->tcp) {
  if (length < MEMCACHED_MIN_LEN) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
  matches = &stream->memcached_matches;
} else if (packet->udp) {
  if (length < MEMCACHED_MIN_UDP_LEN) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
  if (get_u_int16_t(packet->payload, 0) != htons(0) ||
      get_u_int16_t(packet->payload, 2) != htons(0) ||
      get_u_int16_t(packet->payload, 4) != htons(1)) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
  offset += MEMCACHED_UDP_HDR_LEN;
  length -= MEMCACHED_UDP_HDR_LEN;
  matches = &stream->memcached_matches_udp;
} else {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}

if (length == 0 || offset == NULL) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}