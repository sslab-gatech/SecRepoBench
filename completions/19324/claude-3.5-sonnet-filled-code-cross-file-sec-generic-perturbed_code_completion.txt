ndpi_log_dbg(ndpi_struct, "Searching for memcached protocol\n");

u_int16_t memcached_port = ntohs(stream->packet.tcp ? packet->tcp->source : packet->udp->source);
u_int16_t dport = ntohs(stream->packet.tcp ? packet->tcp->dest : packet->udp->dest);

if (packet->tcp != NULL) {
  if (packet->payload_packet_len < 8)
    goto exclude_memcached;
} else if (packet->udp != NULL) {
  if (packet->payload_packet_len < 12)
    goto exclude_memcached;

  if ((offset[4] != 0x00) || (offset[5] != 0x00) ||
      (offset[6] != 0x00) || (offset[7] != 0x00))
    goto exclude_memcached;

  offset += 8;
  packet->payload_packet_len -= 8;
} else {
  goto exclude_memcached;
}

u_int16_t *matches = (packet->tcp != NULL) ? &stream->memcached_tcp_matches : &stream->memcached_udp_matches;

if ((memcached_port != 11211) && (dport != 11211))
  goto exclude_memcached;

if (*matches >= MEMCACHED_MIN_MATCH) {
  ndpi_int_memcached_add_connection(ndpi_struct, stream);
  return;
}