u_int16_t packet_len = packet->len;
  u_int32_t *matches = &stream->memcached_matches;

  NDPI_LOG(NDPI_PROTOCOL_MEMCACHED, ndpi_struct, NDPI_LOG_DEBUG, "search MEMCACHED\n");

  if (packet->l4_proto == IPPROTO_TCP) {
    if (packet_len < MEMCACHED_MIN_LEN)
      return;
  } else if (packet->l4_proto == IPPROTO_UDP) {
    if (packet_len < MEMCACHED_MIN_LEN)
      return;

    if (packet_len > 65507) /* memcached max packet len */
      return;

    offset += 8; /* Skip UDP header */
    packet_len -= 8;

    matches = &stream->memcached_udp_matches;
  } else
    return;

  if (*matches == 0) {
    if (packet_len > ndpi_struct->memcached_max_string_len)
      packet_len = ndpi_struct->memcached_max_string_len;
  }

  if (ndpi_match_memcached(ndpi_struct, offset, packet_len, matches) == 0)
	return;