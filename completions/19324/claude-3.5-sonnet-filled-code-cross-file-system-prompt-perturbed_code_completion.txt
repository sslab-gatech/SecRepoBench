NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

u_int16_t memcached_port = ntohs(stream->packet.tcp ? packet->tcp->source : packet->udp->source);
u_int16_t dport = ntohs(stream->packet.tcp ? packet->tcp->dest : packet->udp->dest);

if(packet->tcp) {
  if(packet->payload_packet_len < 12) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
} else {
  if(packet->payload_packet_len < 8) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  if((packet->payload[4] != 0) || (packet->payload[5] != 0) ||
     ((packet->payload[6] != 0x00) && (packet->payload[6] != 0x01)) ||
     (packet->payload[7] != 0x00)) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  offset += 8;
}

u_int16_t *matches = packet->tcp ? &stream->memcached_matches : &stream->memcached_udp_matches;

if((memcached_port != 11211) && (dport != 11211)) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}