NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

  u_int8_t *matches = NULL;

  if(packet->tcp != NULL) {
    if(packet->payload_packet_len < 8) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }
    matches = &stream->protos.memcached.memcached_matches_tcp;
  } else if(packet->udp != NULL) {
    if(packet->payload_packet_len < 8) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }
    
    // Verify UDP header and protocol compliance
    u_int16_t udp_len = ntohs(*(u_int16_t*)packet->payload);
    if(udp_len != packet->payload_packet_len - 8) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }
    
    // Adjust offset for UDP header
    offset += 8;
    
    matches = &stream->protos.memcached.memcached_matches_udp;
  } else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  // Initialize matches counter for first packet
  if(packet->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN) {
    *matches = 0;
  }