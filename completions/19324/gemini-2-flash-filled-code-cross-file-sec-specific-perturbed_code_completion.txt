u_int32_t *matches = &stream->memcached_matches;

  if(packet->tcp_retransmission)
    return;

  if(packet->protocol == IPPROTO_TCP) {
    if(packet->payload_len < 4) {
      NDPI_LOG_DBG2(ndpi_struct, "Memcached: packet too short, exclude\n");
      NDPI_EXCLUDE_PROTOCOL(stream, NDPI_PROTOCOL_MEMCACHED);
      return;
    }
  } else if(packet->protocol == IPPROTO_UDP) {
    u_int16_t udp_header_length;

    if(packet->payload_len < 8) {
      NDPI_LOG_DBG2(ndpi_struct, "Memcached: UDP packet too short, exclude\n");
      NDPI_EXCLUDE_PROTOCOL(stream, NDPI_PROTOCOL_MEMCACHED);
      return;
    }

    /* Check UDP header length */
    udp_header_length = ntohs(*((u_int16_t*)(packet->payload + 4)));

    if(udp_header_length != packet->payload_len) {
      NDPI_LOG_DBG2(ndpi_struct, "Memcached: Invalid UDP header length, exclude\n");
      NDPI_EXCLUDE_PROTOCOL(stream, NDPI_PROTOCOL_MEMCACHED);
      return;
    }

    /* Skip UDP header length */
    offset += 8;
  } else {
    NDPI_EXCLUDE_PROTOCOL(stream, NDPI_PROTOCOL_MEMCACHED);
    return;
  }