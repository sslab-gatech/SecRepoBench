u_int16_t len = packet->payload_packet_len;
u_int8_t proto = stream->l4_proto;
u_int32_t *matches = NULL;

if(proto == IPPROTO_TCP) {
  if(len < MEMCACHED_TCP_MIN_LEN) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream, NDPI_PROTOCOL_MEMCACHED, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
  matches = &stream->l4.tcp.memcached_matches;
} else if(proto == IPPROTO_UDP) {
  if(len < MEMCACHED_UDP_MIN_LEN) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream, NDPI_PROTOCOL_MEMCACHED, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
  /* Check for memcached UDP header (first 8 bytes) */
  if(len < 8 || offset[0] != 0x00 || offset[1] != 0x00) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream, NDPI_PROTOCOL_MEMCACHED, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
  offset += 8;
  len -= 8;
  matches = &stream->l4.udp.memcached_matches;
} else {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream, NDPI_PROTOCOL_MEMCACHED, NDPI_PROTOCOL_UNKNOWN);
  return;
}