u_int32_t *matches = &stream->memcached_matches;

  NDPI_LOG(3, "%s: search memcached\n", __FUNCTION__);

  if(packet->tcp_retransmission)
    return;

  if(packet->protocol == IPPROTO_TCP) {
    if(packet->payload_len < MEMCACHED_MIN_LENGTH) {
      NDPI_LOG(4, "exclude memcached due to payload len %u < %u\n",
	       packet->payload_len, MEMCACHED_MIN_LENGTH);
      NDPI_ADD_PROTOCOL_TO_BITMASK(stream, NDPI_PROTOCOL_MEMCACHED,
				   NDPI_DETECTION_EXCLUDED);
      return;
    }
  } else if(packet->protocol == IPPROTO_UDP) {
    if(packet->payload_len < MEMCACHED_MIN_LENGTH) {
      NDPI_LOG(4, "exclude memcached due to payload len %u < %u\n",
	       packet->payload_len, MEMCACHED_MIN_LENGTH);
      NDPI_ADD_PROTOCOL_TO_BITMASK(stream, NDPI_PROTOCOL_MEMCACHED,
				   NDPI_DETECTION_EXCLUDED);
      return;
    }

    /* RFC 6454 */
    if((offset[0] & 0x8f) != 0x00) {
      NDPI_ADD_PROTOCOL_TO_BITMASK(stream, NDPI_PROTOCOL_MEMCACHED,
				   NDPI_DETECTION_EXCLUDED);
      return;
    }

    offset += 8; /* Skip UDP header length */
  } else {
    NDPI_ADD_PROTOCOL_TO_BITMASK(stream, NDPI_PROTOCOL_MEMCACHED,
				 NDPI_DETECTION_EXCLUDED);
    return;
  }

  matches = &stream->memcached_matches;

  *matches = 0;