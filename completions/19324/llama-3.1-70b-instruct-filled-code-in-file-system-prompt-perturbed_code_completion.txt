NDPI_LOG_INFO(ndpi_struct, "searching memcached\n");

if (packet->tcp!= NULL) {
  if (packet->payload_packet_len < MEMCACHED_MIN_LEN) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
    return;
  }
} else if (packet->udp!= NULL) {
  if (packet->payload_packet_len < MEMCACHED_MIN_UDP_LEN) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
    return;
  }

  if (packet->payload[0]!= 0x80 || packet->payload[1]!= 0x00) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
    return;
  }

  offset += MEMCACHED_UDP_HDR_LEN;
  packet->payload_packet_len -= MEMCACHED_UDP_HDR_LEN;
}

if (packet->tcp!= NULL) {
  matches = &stream->memcached_matches_tcp;
} else {
  matches = &stream->memcached_matches_udp;
}

if (packet->payload_packet_len < MEMCACHED_MIN_LEN) {
  NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
  return;
}