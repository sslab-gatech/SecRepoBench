u_int16_t memcached_port = (stream->packet.tcp != NULL) ? ntohs(stream->packet.tcp->dest) : ntohs(stream->packet.udp->dest);
u_int16_t *matches;

NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

if(packet->tcp != NULL) {
  if(packet->payload_packet_len < 8)
    goto exclude_memcached;

  matches = &stream->memcached_tcp_matches;
} else if(packet->udp != NULL) {
  if(packet->payload_packet_len < 12)
    goto exclude_memcached;

  if((offset[4] != 0x00) || (offset[5] != 0x00))
    goto exclude_memcached;

  offset += 8;
  packet->payload_packet_len -= 8;
  matches = &stream->memcached_udp_matches;
} else
  goto exclude_memcached;

if(memcached_port != 11211)
  goto exclude_memcached;

if(*matches >= MEMCACHED_MIN_MATCH) {
  NDPI_LOG_INFO(ndpi_struct, "found memcached\n");
  ndpi_int_memcached_add_connection(ndpi_struct, stream);
  return;
}