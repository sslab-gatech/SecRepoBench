u_int16_t packet_len = packet->len;
  u_int32_t *matches = &stream->memcached_matches;

  NDPI_LOG(NDPI_PROTOCOL_MEMCACHED, ndpi_struct, NDPI_LOG_DEBUG, "search MEMCACHED\n");

  if (packet->l4_proto == IPPROTO_TCP) {
    if (packet_len < MEMCACHED_MIN_LEN)
      return;
  } else if (packet->l4_proto == IPPROTO_UDP) {
    if (packet_len < MEMCACHED_MIN_LEN)
      return;

    if (packet->udp.dport != htons(MEMCACHED_DEFAULT_PORT) && packet->udp.sport != htons(MEMCACHED_DEFAULT_PORT))
      return;

    offset += sizeof(struct udphdr);
    packet_len -= sizeof(struct udphdr);
  } else
    return;


  if (*matches == 0)
	  stream->memcached.detected_protocol = packet->l4_proto;
  else if (stream->memcached.detected_protocol != packet->l4_proto)
	  return;

  if (packet->l4_proto == IPPROTO_UDP)
	  matches = &stream->memcached_udp_matches;