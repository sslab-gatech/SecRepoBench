NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

u_int16_t memcached_port = htons(11211);
u_int16_t sport = htons(packet->tcp ? packet->tcp->source : packet->udp->source);
u_int16_t dport = htons(packet->tcp ? packet->tcp->dest : packet->udp->dest);

if(packet->tcp) {
  if(packet->payload_packet_len < 12) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }
} else if(packet->udp) {
  if(packet->payload_packet_len < 8) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  if((sport != memcached_port) && (dport != memcached_port)) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  offset += 8;
  packet->payload_packet_len -= 8;
}

u_int16_t *matches = packet->tcp ? &stream->memcached_tcp_matches : &stream->memcached_udp_matches;

if((packet->payload_packet_len == 0) || (packet->payload == NULL)) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}