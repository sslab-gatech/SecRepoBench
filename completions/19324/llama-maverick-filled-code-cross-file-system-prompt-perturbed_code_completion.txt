u_int16_t proto = packet->udp ? IPPROTO_UDP : IPPROTO_TCP;
u_int matches_idx = proto == IPPROTO_UDP ? 1 : 0;
u_int8_t *matches = &stream->protos.memcached.matched[matches_idx];

if((proto == IPPROTO_TCP && packet->payload_packet_len < 8 /* sizeof("memcached") */)
   || (proto == IPPROTO_UDP && packet->payload_packet_len < 16 /* sizeof("memcached\r\nvalue ") */)) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}

if(proto == IPPROTO_UDP) {
  if(packet->payload_packet_len < 24 /* sizeof("memcached\r\nvalue 1234567890\r\n") */) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  if(offset[0] != 'm' || offset[1] != 'e' || offset[2] != 'm' || offset[3] != 'c') {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  offset += 8; /* skip "memcached" */
  packet->payload_packet_len -= 8;
}