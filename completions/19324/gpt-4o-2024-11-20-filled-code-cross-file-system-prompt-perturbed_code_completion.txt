NDPI_LOG_DBG(ndpi_struct, "Searching for memcached protocol\n");

  if(packet->l4_protocol == IPPROTO_TCP) {
    if(packet->payload_packet_len < MEMCACHED_TCP_MIN_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }
  } else if(packet->l4_protocol == IPPROTO_UDP) {
    if(packet->payload_packet_len < MEMCACHED_UDP_MIN_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    // Verify UDP header conditions
    if(packet->payload_packet_len < (8 + MEMCACHED_UDP_HEADER_LEN)) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    offset += MEMCACHED_UDP_HEADER_LEN;
    packet->payload_packet_len -= MEMCACHED_UDP_HEADER_LEN;
  } else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }

  u_int32_t *matches = (packet->l4_protocol == IPPROTO_TCP) 
                       ? &stream->l4.tcp.memcached_matches 
                       : &stream->l4.udp.memcached_matches;