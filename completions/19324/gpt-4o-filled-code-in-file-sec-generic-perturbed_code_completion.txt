NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

  u_int16_t length = packet->payload_packet_len;
  u_int8_t *matches;

  if (packet->tcp != NULL) {
    if (length < MEMCACHED_MIN_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }
    matches = &stream->l4.tcp.memcached_matches;
  } else if (packet->udp != NULL) {
    if (length < MEMCACHED_MIN_UDP_LEN) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    if (packet->udp->source != htons(11211) && packet->udp->dest != htons(11211)) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
      return;
    }

    offset += MEMCACHED_UDP_HDR_LEN;
    length -= MEMCACHED_UDP_HDR_LEN;
    matches = &stream->l4.udp.memcached_matches;
  } else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }