NDPI_LOG_DEBUG(ndpi_struct, "search MEMCACHED\n");

  u_int16_t length = packet->len;
  uint8_t *matches;

  if (stream->protocol_family == NDPI_PROTOCOL_FAMILY_IPV4) {
    if (length < MEMCACHED_MIN_LEN) {
      return;
    }
    matches = &stream->memcached_tcp_matches;
  } else if (stream->protocol_family == NDPI_PROTOCOL_FAMILY_IPV6) {
    if (length < MEMCACHED_MIN_LEN) {
      return;
    }
    matches = &stream->memcached_tcp_matches;
  } else if (stream->protocol_family == NDPI_PROTOCOL_FAMILY_UDP) {
    if (length < MEMCACHED_MIN_UDP_LEN) {
      return;
    }

    if (packet->udp.request_id == 0) {
      return;
    }

    offset += MEMCACHED_UDP_HDR_LEN;
    length -= MEMCACHED_UDP_HDR_LEN;
    matches = &stream->memcached_udp_matches;
  } else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
  }