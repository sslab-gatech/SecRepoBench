NDPI_LOG_DBG(ndpi_struct, "search memcached\n");

u_int8_t is_udp = (packet->udp != NULL);
u_int16_t length = packet->payload_packet_len;
u_int16_t *matches;

// Check if the packet meets the minimum length requirement
if ((is_udp && (length < MEMCACHED_MIN_UDP_LEN)) ||
    (!is_udp && (length < MEMCACHED_MIN_LEN))) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}

// For UDP packets, check header conditions and adjust offset and length
if (is_udp) {
  // Adjust offset and length to skip UDP header
  offset += MEMCACHED_UDP_HDR_LEN;
  length -= MEMCACHED_UDP_HDR_LEN;
}

// Update matches pointer to the appropriate counter in the flow structure
matches = &stream->memcached_matches;