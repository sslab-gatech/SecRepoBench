NDPI_LOG_INFO(ndpi_struct, "searching memcached\n");

if (packet->protocol == NDPI_PROTOCOL_TCP) {
  if (packet->payload_packet_len < MEMCACHED_MIN_LEN) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
    return;
  }
} else if (packet->protocol == NDPI_PROTOCOL_UDP) {
  if (packet->payload_packet_len < MEMCACHED_MIN_UDP_LEN) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
    return;
  }

  if (packet->payload[0]!= 0x80 || packet->payload[1]!= 0x00) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
    return;
  }

  offset += MEMCACHED_UDP_HDR_LEN;
  packet->payload_packet_len -= MEMCACHED_UDP_HDR_LEN;
}

u_int32_t *matches = (packet->protocol == NDPI_PROTOCOL_TCP)? &stream->l4.tcp.memcached_matches : &stream->l4.udp.memcached_matches;

if (*matches >= MEMCACHED_MIN_MATCH) {
  NDPI_ADD_PROTOCOL_TO_BITMASK(*detection_bitmask, NDPI_PROTOCOL_MEMCACHED);
  return;
}