// Log that a memcached search is being performed.
NDPI_LOG_DBG(ndpi_struct, "Searching for memcached protocol\n");

// Determine if the packet uses TCP or UDP.
if (packet->tcp != NULL) {
    // For TCP packets, check if the packet length meets the minimum required length.
    if (packet->payload_packet_len < MEMCACHED_MIN_LEN) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
        return;
    }
} else if (packet->udp != NULL) {
    // For UDP packets, check if the packet length meets the minimum required length.
    if (packet->payload_packet_len < MEMCACHED_MIN_UDP_LEN) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
        return;
    }

    // Verify specific header conditions to determine protocol compliance.
    if (ntohs(packet->udp->len) != packet->payload_packet_len) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
        return;
    }
} else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
    return;
}

// Adjust the offset and length for UDP packets by skipping the UDP header length.
if (packet->udp != NULL) {
    offset += MEMCACHED_UDP_HDR_LEN;
    length = packet->payload_packet_len - MEMCACHED_UDP_HDR_LEN;
} else {
    length = packet->payload_packet_len;
}

// Update the `matches` pointer to point to the appropriate memcached matches counter
// within the flow structure based on the protocol type.
if (packet->tcp != NULL) {
    matches = &stream->memcached_tcp_matches;
} else {
    matches = &stream->memcached_udp_matches;
}