// Determine if the packet uses TCP or UDP.
if (packet->protocol == IPPROTO_TCP) {
  // For TCP packets, check if the packet length meets the minimum required length.
  if (packet->payload_length < MEMCACHED_MIN_LEN) {
    return;
  }
} else if (packet->protocol == IPPROTO_UDP) {
  // For UDP packets, check if the packet length meets the minimum required length.
  if (packet->payload_length < MEMCACHED_MIN_UDP_LEN) {
    return;
  }
  // If UDP, verify specific header conditions to determine protocol compliance.
  if (packet->payload_length < MEMCACHED_UDP_HDR_LEN) {
    return;
  }
  // Adjust the offset and length for UDP packets by skipping the UDP header length.
  offset += MEMCACHED_UDP_HDR_LEN;
  packet->payload_length -= MEMCACHED_UDP_HDR_LEN;
}

// Update the `matches` pointer to point to the appropriate memcached matches counter
// within the flow structure based on the protocol type.
matches = &stream->memcached_matches;

// If the packet does not meet the expected criteria, exclude the protocol and return.
if (packet->payload_length < MEMCACHED_MIN_LEN) {
  return;
}

// Check for memcached commands
if (MEMCACHED_MATCH(MCDC_SET)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_ADD)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_REPLACE)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_APPEND)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_PREPEND)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_CAS)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_GET)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_GETS)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_DELETE)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_INCR)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_DECR)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_TOUCH)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_GAT)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_GATS)) *matches += 1;
else if (MEMCACHED_MATCH(MCDC_STATS)) *matches += 1;

// Check for memcached responses
else if (MEMCACHED_MATCH(MCDR_ERROR)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_CLIENT_ERROR)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_SERVER_ERROR)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_STORED)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_NOT_STORED)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_EXISTS)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_NOT_FOUND)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_END)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_DELETED)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_TOUCHED)) *matches += 1;
else if (MEMCACHED_MATCH(MCDR_STAT)) *matches += 1;

// If the packet meets the expected criteria, add the protocol to the flow.
if (*matches >= MEMCACHED_MIN_MATCH)
  ndpi_int_memcached_add_connection(ndpi_struct, stream);