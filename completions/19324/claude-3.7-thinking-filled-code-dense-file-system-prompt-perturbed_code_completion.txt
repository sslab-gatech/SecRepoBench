NDPI_LOG_DBG(ndpi_struct, "search Memcached\n");

u_int *matches = NULL;

if(packet->tcp != NULL) {
  if(packet->payload_packet_len < 4) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
  
  matches = &flow->l4.tcp.memcached_matches;
} else if(packet->udp != NULL) {
  if(packet->payload_packet_len < 8) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
  
  // For UDP, verify header conditions
  // Memcached binary protocol has 0x80 for request and 0x81 for response in first byte
  if(packet->payload[0] != 0x80 && packet->payload[0] != 0x81) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
  
  // Adjust offset for Memcached UDP header
  offset += 8;
  
  matches = &flow->l4.udp.memcached_matches;
} else {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

// Initialize matches counter if this is the first detection
if(*matches == 0)
  *matches = 1;