Signature sig, void* Data, cmsUInt32Number Size)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return FALSE;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) {

        // Not found, create a new one
        if (!_cmsNewTag(Icc, sig, &n)) {
            _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
            return FALSE;
        }
    }

    // Free previous version
    freeOneTag(Icc, n);

    // Save the new data
    Icc -> TagPtrs[n] = Data;
    Icc -> TagSizes[n] = Size;
    Icc -> TagSaveAsRaw[n] = FALSE;

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;
}


// Write a single tag. This just keeps track of the tak into a list of "to be written". If the tag is already
// in that list, the previous version is deleted.
cmsBool CMSEXPORT cmsWriteTagRaw(cmsHPROFILE hProfile, cmsTagSignature sig, void* Data, cmsUInt32Number Size)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return FALSE;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) {

        // Not found, create a new one
        if (!_cmsNewTag(Icc, sig, &n)) {
            _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
            return FALSE;
        }
    }

    // Free previous version
    freeOneTag(Icc, n);

    // Save the new data
    Icc -> TagPtrs[n] = Data;
    Icc -> TagSizes[n] = Size;
    Icc -> TagSaveAsRaw[n] = TRUE;

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;
}


// Delete a tag from the profile
cmsBool CMSEXPORT cmsDeleteTag(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return FALSE;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) {
        _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
        return FALSE;
    }

    // Free previous version
    freeOneTag(Icc, n);

    // Mark as deleted
    Icc -> TagNames[n] = (cmsTagSignature) 0;

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;
}


// Link a tag to another
cmsBool CMSEXPORT cmsLinkTag(cmsHPROFILE hProfile, cmsTagSignature sig, cmsTagSignature linkedSig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return FALSE;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) {
        _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
        return FALSE;
    }

    // Mark as linked
    Icc -> TagLinked[n] = linkedSig;

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;
}


// Unlink a tag
cmsBool CMSEXPORT cmsUnlinkTag(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return FALSE;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) {
        _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
        return FALSE;
    }

    // Mark as unlinked
    Icc -> TagLinked[n] = (cmsTagSignature) 0;

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;
}


// Set the type of a tag
cmsBool CMSEXPORT cmsSetTagType(cmsHPROFILE hProfile, cmsTagSignature sig, cmsTagTypeSignature Type)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return FALSE;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) {
        _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
        return FALSE;
    }

    // Mark as linked
    Icc -> TagTypeHandlers[n] = _cmsGetTagTypeHandler(Icc->ContextID, Type);

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;
}


// Get the type of a tag
cmsTagTypeSignature CMSEXPORT cmsGetTagType(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) return 0;

    // Get the handler. The true type is there
    return Icc -> TagTypeHandlers[n] ->Signature;
}


// Get the size of a tag
cmsUInt32Number CMSEXPORT cmsGetTagSize(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) return 0;

    // Get the size
    return Icc -> TagSizes[n];
}


// Get the offset of a tag
cmsUInt32Number CMSEXPORT cmsGetTagOffset(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) return 0;

    // Get the offset
    return Icc -> TagOffsets[n];
}


// Get the linked tag
cmsTagSignature CMSEXPORT cmsGetLinkedTag(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) return 0;

    // Get the linked tag
    return Icc -> TagLinked[n];
}


// Get the data of a tag
void* CMSEXPORT cmsGetTagData(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) return NULL;

    // Get the data
    return Icc -> TagPtrs[n];
}


// Get the descriptor of a tag
cmsTagDescriptor* CMSEXPORT cmsGetTagDescriptor(cmsHPROFILE hProfile, cmsTagSignature sig)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    int n;

    // Search for given tag in ICC profile directory
    n = _cmsSearchTag(Icc, sig, TRUE);
    if (n < 0) return NULL;

    // Get the descriptor
    return _cmsGetTagDescriptor(Icc->ContextID, sig);
}


// Get the number of tags
cmsUInt32Number CMSEXPORT cmsGetTagCount(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> TagCount;
}


// Get the context ID
cmsContext CMSEXPORT cmsGetProfileContextID(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> ContextID;
}


// Get the ICC version
cmsUInt32Number CMSEXPORT cmsGetEncodedICCversion(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> Version;
}


// Get the ICC creation date/time
cmsBool CMSEXPORT cmsGetHeaderCreationDateTime(cmsHPROFILE hProfile, struct tm *Dest)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    memmove(Dest, &Icc ->Created, sizeof(struct tm));
    return TRUE;
}


// Get the ICC profile ID
void CMSEXPORT cmsGetHeaderProfileID(cmsHPROFILE hProfile, cmsUInt8Number* ProfileID)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    memmove(ProfileID, Icc ->ProfileID.ID8, 16);
}


// Get the ICC profile version
cmsFloat64Number CMSEXPORT cmsGetProfileVersion(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return cmsGetProfileVersion(hProfile);
}


// Get the ICC profile flags
cmsUInt32Number CMSEXPORT cmsGetHeaderFlags(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return (cmsUInt32Number) Icc -> flags;
}


// Get the ICC profile rendering intent
cmsUInt32Number CMSEXPORT cmsGetHeaderRenderingIntent(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> RenderingIntent;
}


// Get the ICC profile device class
cmsProfileClassSignature CMSEXPORT cmsGetDeviceClass(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> DeviceClass;
}


// Get the ICC profile color space
cmsColorSpaceSignature CMSEXPORT cmsGetColorSpace(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> ColorSpace;
}


// Get the ICC profile PCS
cmsColorSpaceSignature CMSEXPORT cmsGetPCS(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc -> PCS;
}


// Get the ICC profile manufacturer
cmsUInt32Number CMSEXPORT cmsGetHeaderManufacturer(cmsHPROFILE hProfile)
{
    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*) hProfile;
    return Icc ->manufacturer;
}


// Get