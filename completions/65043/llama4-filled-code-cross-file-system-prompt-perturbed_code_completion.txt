xmlParserInputBufferPtr new_in;
xmlBufPtr new_buf;

new_buf = xmlBufCreate();
if (new_buf == NULL) {
    xmlErrMemory(ctxt, NULL);
    return (-1);
}

new_in = xmlAllocParserInputBuffer();
if (new_in == NULL) {
    xmlBufFree(new_buf);
    xmlErrMemory(ctxt, NULL);
    return (-1);
}

xmlBufResetInput(new_buf, inputStream);
new_in->buffer = new_buf;
new_in->encoder = handler;
inputStream->buf = new_in;
inputStream->raw = in->buffer;
inputStream->processed = xmlBufGetInputOffset(in->buffer);