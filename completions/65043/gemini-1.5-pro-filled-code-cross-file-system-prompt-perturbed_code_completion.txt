xmlParserInputBufferPtr raw;

        raw = xmlAllocParserInputBuffer(in->encoder);
        if (raw == NULL) {
            xmlCharEncCloseFunc(handler);
            return (-1);
        }
        raw->context = in->context;
        raw->readcallback = in->readcallback;
        raw->closecallback = in->closecallback;
        raw->free = endOfInput; // Use the endOfInput function.
        raw->buffer = in->buffer;
        in->buffer = xmlBufCreate();
        if (in->buffer == NULL) {
            xmlCharEncCloseFunc(handler);
            xmlFreeParserInputBuffer(raw);
            return (-1);
        }
        in->raw = raw;
        inputStream->consumed += (in->rawconsumed - in->consumed);
        in->consumed = in->rawconsumed;