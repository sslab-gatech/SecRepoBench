xmlParserInputBufferPtr buf = xmlAllocParserInputBuffer(XML_CHAR_ENCODING_NONE);
if (buf == NULL) {
    xmlErrMemory(ctxt, "creating input buffer\n");
    return(-1);
}

xmlBufShrink(in->buf->buffer, used);
buf->raw = in->buf->buffer;
in->buf->buffer = buf->buffer;
in->buf->raw = NULL;

xmlBufResetInput(in->buf->buffer, in);
in->consumed += used;