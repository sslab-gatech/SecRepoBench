{
    xmlBufPtr oldBuf = in->buffer;
    xmlBufPtr newBuf = xmlBufCreate();
    if (newBuf == NULL) {
        xmlErrMemory(ctxt, NULL);
        return (-1);
    }

    /* 1) Create a new input buffer and assign it to the current buffer pointer. */
    in->buffer = newBuf;

    /* 2) Shrink the existing input buffer to remove processed data. */
    {
        size_t used = xmlBufUse(oldBuf);
        xmlBufShrink(oldBuf, used);

        /* 3) Move the current buffer to the raw buffer pointer. */
        in->raw = oldBuf;

        /* 4) Update the number of processed bytes in the input structure. */
        inputStream->consumed += used;
    }
}