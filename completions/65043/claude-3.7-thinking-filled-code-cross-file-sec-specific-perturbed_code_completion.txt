/*
 * Create a new buffer for encoding
 */
xmlBufPtr newBuf = xmlBufCreate();
if (newBuf == NULL) {
    xmlErrMemory(ctxt, NULL);
    return (-1);
}

/*
 * Free the existing raw buffer to avoid memory leaks
 */
if (in->raw != NULL) {
    xmlBufFree(in->raw);
}

/*
 * Move the current buffer to raw (to be used as input for encoding)
 */
in->raw = in->buffer;

/*
 * Set the new buffer as current (to store encoded content)
 */
in->buffer = newBuf;

/*
 * Reset consumed bytes
 */
inputStream->consumed = 0;