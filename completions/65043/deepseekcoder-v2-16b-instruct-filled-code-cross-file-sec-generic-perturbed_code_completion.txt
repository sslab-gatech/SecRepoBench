xmlParserInputBufferPtr newBuffer = xmlBufCreate();
    if (newBuffer == NULL) {
        xmlErrMemory(ctxt, NULL);
        return -1;
    }

    xmlBufCopy(newBuffer, in->buffer);
    xmlBufShrink(in->buffer, in->raw);

    in->raw = newBuffer;
    in->conv = NULL;
    in->length = xmlBufGetSize(newBuffer);
    in->cur = xmlBufGetContent(newBuffer);
    in->pos = 0;

    nbchars = xmlCharEncInput(in);
    if (nbchars == XML_ENC_ERR_MEMORY) {
        xmlErrMemory(ctxt, NULL);
    } else if (nbchars < 0) {
        xmlErrInternal(ctxt, "switching encoding: encoder error\n", NULL);
        xmlHaltParser(ctxt);
        return -1;
    }