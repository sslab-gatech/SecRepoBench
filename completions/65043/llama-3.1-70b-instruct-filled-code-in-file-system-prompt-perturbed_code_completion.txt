// Create a new input buffer and assign it to the current buffer pointer.
xmlParserInputBufferPtr newbuf = xmlParserInputBufferCreate(NULL, NULL, NULL, NULL, NULL, 0);
if (newbuf == NULL) {
    xmlErrMemory(ctxt, NULL);
    return(-1);
}
xmlBufResetInput(newbuf->buffer, in);

// Shrink the existing input buffer to remove processed data.
size_t res = xmlBufShrink(in->buf->buffer, used - LINE_LEN);
if (res > 0) {
    used -= res;
    if ((res > ULONG_MAX) ||
        (in->consumed > ULONG_MAX - (unsigned long)res))
        in->consumed = ULONG_MAX;
    else
        in->consumed += res;
}

// Move the current buffer to the raw buffer pointer.
in->buf = newbuf;

// Update the number of processed bytes in the input structure.
in->rawconsumed = in->consumed;