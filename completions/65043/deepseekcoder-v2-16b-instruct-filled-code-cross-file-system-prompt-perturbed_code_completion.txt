xmlParserInputBufferPtr newBuffer = xmlBufCreate();
    xmlBufCopy(newBuffer, in->buffer);
    xmlBufReset(in->buffer);

    xmlParserInputPtr rawInput = xmlNewInputParserCtxt();
    rawInput->buf = newBuffer;
    rawInput->conv = in->conv;

    int nbchars = xmlCharEncInput(rawInput);
    if (nbchars == XML_ENC_ERR_MEMORY) {
        xmlErrMemory(ctxt, NULL);
    } else if (nbchars < 0) {
        xmlErrInternal(ctxt, "switching encoding: encoder error\n", NULL);
        xmlHaltParser(ctxt);
        return (-1);
    }

    xmlBufFree(in->buffer);
    in->buffer = newBuffer;
    in->conv = rawInput->conv;