xmlParserInputBufferPtr newBuf;
size_t used;

newBuf = xmlAllocParserInputBuffer(XML_CHAR_ENCODING_NONE);
if (newBuf == NULL) {
    xmlErrMemory(ctxt, NULL);
    return;
}

used = in->cur - in->base;
if (used > 0) {
    xmlBufShrink(in->buf->buffer, used);
    in->consumed += used;
}

newBuf->raw = in->buf->raw;
newBuf->rawconsumed = in->buf->rawconsumed;
in->buf->raw = NULL;
in->buf->rawconsumed = 0;

xmlFreeParserInputBuffer(in->buf);
in->buf = newBuf;

xmlBufResetInput(in->buf->buffer, in);