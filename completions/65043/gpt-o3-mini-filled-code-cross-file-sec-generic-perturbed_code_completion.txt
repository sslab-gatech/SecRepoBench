{
    xmlBufPtr newbuf;

    /* Remove already processed data from the current buffer */
    xmlBufShrink(in->buffer);

    /* Move the current buffer (now shrunk) to the raw pointer */
    in->raw = in->buffer;

    /* Create a new buffer for incoming encoded data */
    newbuf = xmlBufCreate();
    if (newbuf == NULL) {
        xmlCharEncCloseFunc(handler);
        xmlErrMemory(ctxt, "switching encoding: out of memory\n");
        return(-1);
    }
    in->buffer = newbuf;

    /* Update the number of processed bytes in the input stream */
    inputStream->consumed += in->raw->use;
}