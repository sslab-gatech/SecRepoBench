xmlBufPtr newBuf = xmlBufCreate();
if (newBuf == NULL) {
    xmlErrMemory(ctxt, "Failed to create new buffer\n");
    return (-1);
}

if (xmlBufMerge(newBuf, in->buffer) < 0) {
    xmlErrMemory(ctxt, "Failed to merge buffers\n");
    xmlBufFree(newBuf);
    return (-1);
}

xmlBufShrink(in->buffer, xmlBufUse(in->buffer));
in->raw = in->buffer;
in->buffer = newBuf;
inputStream->consumed += inputStream->cur - inputStream->base;
inputStream->cur = inputStream->base = xmlBufContent(in->buffer);