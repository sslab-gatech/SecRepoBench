xmlBufPtr temp = xmlBufCreate();
if (temp == NULL) {
    xmlErrMemory(ctxt, "Failed to create temporary buffer\n");
    return (-1);
}

if (xmlBufCat(temp, xmlBufContent(in->buffer)) < 0) {
    xmlErrMemory(ctxt, "Failed to copy buffer content\n");
    xmlBufFree(temp);
    return (-1);
}

xmlBufShrink(in->buffer, xmlBufUse(in->buffer));
in->raw = in->buffer;
in->buffer = temp;
inputStream->consumed += inputStream->cur - inputStream->base;
inputStream->cur = inputStream->base = xmlBufContent(in->buffer);