xmlParserInputBufferPtr newBuf = xmlAllocParserInputBuffer(handler);
if (newBuf == NULL) {
    xmlCharEncCloseFunc(handler);
    return (-1);
}
xmlBufShrink(in->buffer, xmlBufUse(in->buffer));
inputStream->buf->raw = inputStream->buf->buffer;
inputStream->buf->buffer = newBuf->buffer;
inputStream->consumed += xmlBufUse(inputStream->buf->raw);