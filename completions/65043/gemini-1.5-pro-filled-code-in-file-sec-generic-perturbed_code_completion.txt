xmlParserInputBufferPtr raw;

        raw = in->buffer;
        in->buffer = xmlAllocParserInputBuffer(in->encoder);
        if (in->buffer == NULL) {
            xmlCharEncCloseFunc(handler);
            in->encoder = NULL;
            in->buffer = raw;
            return(-1);
        }
        in->buffer->raw = raw;
        inputStream->raw = raw->buffer; /* raw->buffer is const */
        in->compressed = raw->compressed;
        in->error = raw->error;

        xmlBufTransfer(in->buffer->buffer, raw->buffer);

        if ((ctxt->input != NULL) && raw->consumed > XML_MAX_LOOKUP_LIMIT) {
            /*
             * If we attempt to shrink a buffer that has more than
             * XML_MAX_LOOKUP_LIMIT bytes consumed, then we reset consumed to
             * XML_MAX_LOOKUP_LIMIT. This is to prevent integer overflow issues
             * in xmlParserInputShrink when we attempt shrink more than
             * XML_MAX_LOOKUP_LIMIT bytes from the buffer.
             */
            raw->consumed = XML_MAX_LOOKUP_LIMIT;
        }

        xmlBufUpdateInput(raw->buffer, inputStream,
                          raw->consumed + (in->cur - in->base));