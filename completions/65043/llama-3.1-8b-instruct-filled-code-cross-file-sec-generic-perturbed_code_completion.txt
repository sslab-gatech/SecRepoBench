if (xmlBufIsEmpty(in->buffer) == 0) {
    xmlBufferPtr newBuffer = xmlBufferCreate();
    xmlBufferPtr rawBuffer = xmlBufferCreate();
    xmlBufferPtr processedBuffer = xmlBufferCreate();

    xmlBufferShrink(in->buffer, in->pos);
    xmlBufferMove(in->buffer, rawBuffer);
    in->pos = 0;

    xmlCharEncInput(in, processedBuffer);
    xmlBufferFree(in->buffer);
    in->buffer = newBuffer;
    in->rawBuffer = rawBuffer;
    in->processedBuffer = processedBuffer;
    in->pos = xmlBufferLength(in->processedBuffer);
}