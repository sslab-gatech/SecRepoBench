xmlParserInputBufferPtr newInputBuffer = xmlAllocParserInputBuffer();
        if (newInputBuffer == NULL) {
            xmlCharEncCloseFunc(in->encoder);
            in->encoder = NULL;
            return (XML_ENC_ERR_MEMORY);
        }
        newInputBuffer->buffer = xmlBufCreate();
        if (newInputBuffer->buffer == NULL) {
            xmlFreeParserInputBuffer(newInputBuffer);
            xmlCharEncCloseFunc(in->encoder);
            in->encoder = NULL;
            return (XML_ENC_ERR_MEMORY);
        }
        newInputBuffer->raw = in->raw;
        newInputBuffer->encoder = in->encoder;
        newInputBuffer->close = in->close;
        newInputBuffer->context = in->context;
        in->raw = in->buffer;
        in->buffer = newInputBuffer->buffer;
        in->encoder = NULL;
        inputStream->cur = inputStream->base = xmlBufContent(in->buffer);
        inputStream->end = inputStream->cur + xmlBufUse(in->buffer);
        inputStream->consumed = 0;