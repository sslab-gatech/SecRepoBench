xmlBufferPtr rawBuf = xmlBufCreate();
xmlBuf *oldBuf = in->buffer;
int processedBytes;

if (rawBuf == NULL) {
    return XML_ENC_ERR_MEMORY;
}

processedBytes = xmlBufUse(oldBuf) - xmlBufGetRawSize(oldBuf);
xmlBufSetRaw(rawBuf, xmlBufGetRawPtr(oldBuf), xmlBufGetRawSize(oldBuf));
xmlBufShrink(oldBuf, xmlBufGetRawSize(oldBuf));

in->raw = rawBuf;
in->buffer = xmlBufCreateSize(0); // Initialize new buffer for encoded content
xmlBufAdd(in->buffer, NULL, 0); // Ensure the new buffer is ready for input

inputStream->consumed += processedBytes;