xmlParserInputBufferPtr newbuf;

newbuf = xmlAllocParserInputBufferInternal(in->compress);
if (newbuf == NULL) {
    xmlErrMemory(ctxt, NULL);
    return(-1);
}
newbuf->encoder = handler;
newbuf->raw = in->buffer;
in->buffer = xmlBufCreate();
if (in->buffer == NULL) {
    xmlErrMemory(ctxt, NULL);
    xmlFreeParserInputBuffer(newbuf);
    return(-1);
}
inputStream->buf = newbuf;
newbuf->rawconsumed = in->consumed;
xmlFreeParserInputBuffer(in);
in = newbuf;