xmlParserInputBufferPtr nbuf = xmlAllocParserInputBuffer(in->encoder);
        if (nbuf == NULL) {
            xmlCharEncCloseFunc(handler);
            return (-1);
        }
        nbuf->readcallback = in->readcallback;
        nbuf->closecallback = in->closecallback;
        nbuf->context = in->context;

        in->raw = in->buffer;
        in->buffer = nbuf;
        inputStream->consumed += (in->raw->use);