xmlBufPtr newBuf = xmlBufCreate();
if (newBuf == NULL) {
    xmlErrMemory(ctxt, "switching encoding: cannot create new buffer\n");
    xmlHaltParser(ctxt);
    return(-1);
}

/* Move existing (decoded) buffer to raw for re-encoding */
in->raw = in->buffer;
in->buffer = newBuf;

/* Remove already processed data from old buffer */
if (inputStream->consumed > 0) {
    xmlBufShrink(in->raw, inputStream->consumed);
    inputStream->consumed = 0;
}