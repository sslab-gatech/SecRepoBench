while (probelength && strchr("\n\r\t ", (char)probe_data[0])) {
		probe_data++;
		probelength--;
	}

	while (probelength) {
		/* Skip leading whitespace and newlines. */
		while (probelength && probe_data[0] && strchr("\n\r\t ", (char)probe_data[0])) {
			probe_data++;
			probelength--;
		}

		if (probelength < 2) break;

		/* Remove XML/HTML comment blocks <!-- ... --> */
		if (!strncmp((const char *)probe_data, "<!--", 4)) {
			const char *end_comment = my_strstr(probe_data, "-->", probelength);
			if (!end_comment) break; /* truncated document */
			u32 skip_len = (u32)((end_comment + 3) - (char *)probe_data);
			if (skip_len > probelength) skip_len = probelength;
			probe_data += skip_len;
			probelength -= skip_len;
			continue;
		}

		/* Remove XML processing instructions <? ... ?> */
		if (!strncmp((const char *)probe_data, "<?", 2)) {
			const char *end_instr = my_strstr(probe_data, "?>", probelength);
			if (!end_instr) break; /* truncated document */
			u32 skip_len = (u32)((end_instr + 2) - (char *)probe_data);
			if (skip_len > probelength) skip_len = probelength;
			probe_data += skip_len;
			probelength -= skip_len;
			continue;
		}

		/* Remove DOCTYPE declarations <!DOCTYPE ... > */
		if (!strncmp((const char *)probe_data, "<!DOCTYPE", 9)) {
			const char *end_doctype = my_strstr(probe_data, ">", probelength);
			if (!end_doctype) break; /* truncated document */
			u32 skip_len = (u32)((end_doctype + 1) - (char *)probe_data);
			if (skip_len > probelength) skip_len = probelength;
			probe_data += skip_len;
			probelength -= skip_len;
			continue;
		}

		/* Remove XML declarations <?xml ... ?> */
		if (!strncmp((const char *)probe_data, "<?xml", 5)) {
			const char *end_xml = my_strstr(probe_data, "?>", probelength);
			if (!end_xml) break; /* truncated document */
			u32 skip_len = (u32)((end_xml + 2) - (char *)probe_data);
			if (skip_len > probelength) skip_len = probelength;
			probe_data += skip_len;
			probelength -= skip_len;
			continue;
		}

		break;
	}