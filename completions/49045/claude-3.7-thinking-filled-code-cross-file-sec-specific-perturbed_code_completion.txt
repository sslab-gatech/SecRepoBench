mrb_value
result;
mrb_int base = 10;
char *buf;
char *pbuf;
mrb_int len, i;
mrb_int val = mrb_integer(obj);

if (mrb_get_args(mrb, "|i", &base) == 0) {
  base = 10;
}
if (base < 2 || base > 36) {
  mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid radix %i", base);
}

if (val == 0) {
  return mrb_str_new_lit(mrb, "0");
}

len = 1;
if (val < 0) {
  len += 1;
  val = -val;
}
for (i = val; i >= base; len++) {
  i /= base;
}

buf = (char*)mrb_malloc(mrb, len + 1);
pbuf = buf + len;
*pbuf-- = '\0';

do {
  *pbuf-- = "0123456789abcdefghijklmnopqrstuvwxyz"[val % base];
  val /= base;
} while (val > 0);

if (buf[0] == '0' && buf[1] == '\0') {
  result = mrb_str_new_lit(mrb, "0");
  mrb_free(mrb, buf);
  return result;
}

if (pbuf >= buf) {
  *pbuf = '-';
}

result = mrb_str_new_cstr(mrb, pbuf);
mrb_free(mrb, buf);
return result;