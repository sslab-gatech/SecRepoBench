mrb_int base = 10;
mrb_int num;
char *buf;
size_t len;

num = mrb_integer(self);

if (mrb_get_args(state, "|i", &base) == 1) {
  if (base < 2 || base > 36) {
    mrb_raisef(state, E_ARGUMENT_ERROR, "invalid radix %S", mrb_fixnum_value(base));
  }
}

len = sizeof(mrb_int) * CHAR_BIT + 2;
buf = (char*)mrb_malloc(state, len);
if (!buf) {
  mrb_raise(state, E_RUNTIME_ERROR, "out of memory");
}

snprintf(buf, len, "%" MRB_PRId, num);

if (base != 10) {
  char *temp = mrb_malloc(state, len);
  if (!temp) {
    mrb_free(state, buf);
    mrb_raise(state, E_RUNTIME_ERROR, "out of memory");
  }
  mrb_int_to_cstr(temp, len, num, base);
  mrb_free(state, buf);
  buf = temp;
}

return mrb_str_new_cstr(state, buf);