mrb_int base = 10;
  mrb_int val;
  char buf[64];
  char *end;
  mrb_value base_arg;

  mrb_get_args(mrb, "|o", &base_arg);
  if (mrb_type(base_arg) != MRB_TT_NIL) {
    base = mrb_integer(base_arg);
    if (base < 2 || base > 36) {
      mrb_raise(mrb, E_ARGUMENT_ERROR, "base must be between 2 and 36");
    }
  }

  val = mrb_integer(obj);
  end = buf + sizeof(buf);
  *--end = '\0';

  if (val == 0) {
    *--end = '0';
  } else {
    int negative = 0;
    if (val < 0) {
      if (base == 10) {
        negative = 1;
        val = -val;
      } else {
        /* handle negative values for bases other than 10 */
        unsigned mrb_int uval = (unsigned mrb_int)val;
        while (uval > 0) {
          int digit = uval % base;
          uval /= base;
          if (digit < 10) {
            *--end = '0' + digit;
          } else {
            *--end = 'a' + digit - 10;
          }
        }
        goto end;
      }
    }
    while (val > 0) {
      int digit = val % base;
      val /= base;
      if (digit < 10) {
        *--end = '0' + digit;
      } else {
        *--end = 'a' + digit - 10;
      }
    }
    if (negative) {
      *--end = '-';
    }
  }

end:
  return mrb_str_new_cstr(mrb, end);