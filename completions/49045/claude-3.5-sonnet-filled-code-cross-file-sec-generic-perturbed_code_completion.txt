mrb_int base = 10;
mrb_int num;
char *buf;
size_t len;

mrb_get_args(state, "i|i", &num, &base);

if (base < 2 || base > 36) {
  mrb_raisef(state, E_ARGUMENT_ERROR, "invalid radix %S", mrb_fixnum_value(base));
}

len = sizeof(mrb_int) * CHAR_BIT + 2;
buf = (char*)mrb_malloc(state, len);
if (!buf) {
  mrb_raise(state, E_RUNTIME_ERROR, "out of memory");
}

snprintf(buf, len, "%" MRB_PRId, num);

if (base != 10) {
  mrb_int tmp = num;
  int i = 0;
  int negative = (tmp < 0);
  if (negative) tmp = -tmp;
  
  do {
    int rem = tmp % base;
    buf[i++] = (rem < 10) ? rem + '0' : (rem - 10) + 'a';
    tmp /= base;
  } while (tmp > 0);
  
  if (negative) buf[i++] = '-';
  buf[i] = '\0';
  
  for (int j = 0; j < i / 2; j++) {
    char temp = buf[j];
    buf[j] = buf[i - j - 1];
    buf[i - j - 1] = temp;
  }
}

return mrb_str_new_cstr(state, buf);