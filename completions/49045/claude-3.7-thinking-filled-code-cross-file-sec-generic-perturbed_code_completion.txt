mrb_value
result;
mrb_int base = 10;
mrb_int n = mrb_integer(obj);
char buf[MRB_INT_BIT+1];
char *p = buf + sizeof(buf) - 1;
char *start;
int len;

if (mrb_get_args(mrb, "|i", &base) < 1 || base == 10) {
  return mrb_fixnum_to_str(mrb, obj, 10);
}

if (base < 2 || base > 36) {
  mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid radix %i", base);
}

if (n == 0) {
  return mrb_str_new_lit(mrb, "0");
}

*p = '\0';
if (n < 0) {
  do {
    *--p = mrb_digitmap[-(n % base)];
  } while (n /= base);
  *--p = '-';
}
else {
  do {
    *--p = mrb_digitmap[n % base];
  } while (n /= base);
}

start = p;
len = buf + sizeof(buf) - 1 - start;
result = mrb_str_new(mrb, start, len);

return result;