mrb_int base = 10;
mrb_get_args(mrb, "|i", &base);
if (base < 2 || base > 36) {
  mrb_raise(mrb, E_ARGUMENT_ERROR, "base must be between 2 and 36");
}

mrb_int num = mrb_integer(obj);
char buf[66];  /* Enough for a 64-bit integer in binary plus sign and terminator */
buf[65] = '\0';
char *p = &buf[65];
int negative = 0;
unsigned long long unum;

if (num < 0) {
  negative = 1;
  unum = (unsigned long long)(-(num + 1)) + 1;
}
else {
  unum = (unsigned long long)num;
}

if (unum == 0) {
  *--p = '0';
} else {
  while (unum != 0) {
    int rem = unum % base;
    unum /= base;
    *--p = (rem < 10) ? ('0' + rem) : ('a' + rem - 10);
  }
}

if (negative) {
  *--p = '-';
}

return mrb_str_new_cstr(mrb, p);