mrb_int base = 10;
mrb_int num;
char *buf;
size_t len;

if (mrb_get_args(state, "|i", &base) == 0) {
  base = 10;
}

if (base < 2 || base > 36) {
  mrb_raisef(state, E_ARGUMENT_ERROR, "invalid radix %S", mrb_fixnum_value(base));
}

num = mrb_integer(self);
buf = (char*)mrb_malloc(state, 64);

if (base == 10) {
  len = snprintf(buf, 64, "%" MRB_PRId, num);
} else {
  const char *digits = "0123456789abcdefghijklmnopqrstuvwxyz";
  char *p = buf + 63;
  int neg = 0;
  size_t size = 64;

  *p = '\0';
  if (num < 0) {
    num = -num;
    neg = 1;
  }
  do {
    *--p = digits[num % base];
    num /= base;
  } while (num);
  if (neg) *--p = '-';
  len = buf + 64 - p;
  memmove(buf, p, len + 1);
}

return mrb_str_new(state, buf, len);