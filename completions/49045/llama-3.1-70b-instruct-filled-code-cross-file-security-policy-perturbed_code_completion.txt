mrb_int base;
mrb_value str;

mrb_get_args(state, "i|o", &base, &str);

if (mrb_nil_p(str)) {
  str = mrb_str_new(state, 0, 0);
}

if (base < 2 || base > 36) {
  mrb_raise(state, E_ARGUMENT_ERROR, "invalid base");
}

mrb_str_resize(state, str, 0);

mrb_value num = self;

if (mrb_integer_p(num)) {
  mrb_int n = mrb_integer(num);
  if (n == 0) {
    mrb_str_cat(state, str, "0", 1);
  } else {
    while (n > 0) {
      mrb_int digit = n % base;
      if (digit < 10) {
        mrb_str_cat(state, str, (char[]){'0' + digit, '\0'}, 1);
      } else {
        mrb_str_cat(state, str, (char[]){'a' + digit - 10, '\0'}, 1);
      }
      n /= base;
    }
  }
} else {
  mrb_raise(state, E_TYPE_ERROR, "can't convert non-integer to string");
}

mrb_str_reverse(state, str);

return str;