{
    /* 'length' has been decremented already, so we need to compare
     * length-1 characters from 'uc' to str+1. */
    size_t needed = length - 1;

    /* Check that we won't read past the end of the input buffer. */
    if (uc + needed > ue) {
        DPRINTF("Bad const: ", uc, *ucp);
        return 0;
    }

    /* Compare each expected character. */
    for (size_t i = 0; i < needed; i++) {
        /* 'i+1' in 'str[i+1]' skips the first character already consumed. */
        if (uc[i] != (unsigned char)str[i + 1]) {
            DPRINTF("Bad const: ", uc, *ucp);
            return 0;
        }
    }
}