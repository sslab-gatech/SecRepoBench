zend_unserialize_data_t var_hash;
php_unserialize_data_t var_hash;
zval *pmembers;
const unsigned char *p, *s;
char *serialized_data_buffer;
size_t buf_len;

if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
    RETURN_THROWS();
}

var_hash = php_var_unserialize_init(&var_hash);
p = (const unsigned char*)serialized_data_buffer;
s = (const unsigned char*)serialized_data_buffer + buf_len;

if (*p!= 'x' || *++p!= ':') {
    goto outexcept;
}
++p;

/* storage */
if (!php_var_unserialize(&intern->storage, &p, s, &var_hash)) {
    goto outexcept;
}

if (*p!= ';') {
    goto outexcept;
}
++p;

/* members */
if (*p!='m' || *++p!= ':') {
    goto outexcept;
}
++p;

pmembers = var_tmp_var(&var_hash);
if (!php_var_unserialize(pmembers, &p, s, &var_hash) || Z_TYPE_P(pmembers)!= IS_ARRAY) {
    goto outexcept;
}

/* copy members */
object_properties_load(&intern->std, Z_ARRVAL_P(pmembers));

PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
return;

outexcept:
PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
zend_throw_exception_ex(spl_ce_UnexpectedValueException, 0, "Error at offset %zd of %zd bytes", ((char*)p - serialized_data_buffer), buf_len);
RETURN_THROWS();