// <MASK>
if (*p!= ';') {
    goto outexcept;
}
++p;

/* members */
if (*p!='m' || *++p!= ':') {
    goto outexcept;
}
++p;

pmembers = var_tmp_var(&var_hash);
if (!php_var_unserialize(pmembers, &p, s + buf_len, &var_hash) || Z_TYPE_P(pmembers)!= IS_ARRAY) {
    goto outexcept;
}

/* copy members */
object_properties_load(&intern->std, Z_ARRVAL_P(pmembers));

/* iterate through the serialized elements */
while (*p!= ';') {
    ++p;

    /* unserialize the element */
    zval *elem = var_tmp_var(&var_hash);
    if (!php_var_unserialize(elem, &p, s + buf_len, &var_hash)) {
        goto outexcept;
    }

    /* validate the unserialized data */
    if (Z_TYPE_P(elem)!= IS_OBJECT) {
        goto outexcept;
    }

    /* retrieve or create a storage element */
    spl_SplObjectStorageElement *storage_elem = spl_object_storage_get_element(intern, Z_OBJCE_P(elem));
    if (!storage_elem) {
        storage_elem = spl_object_storage_create_element(intern, Z_OBJCE_P(elem));
    }

    /* manage references and memory for the unserialized entry */
    Z_TRY_ADDREF(elem);
    storage_elem->obj = *elem;

    /* attach the unserialized element to the internal storage structure */
    zend_hash_next_index_insert(Z_ARRVAL(&intern->storage), &storage_elem);
}

/* done reading $serialized */
PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
return;

outexcept:
PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
zend_throw_exception_ex(spl_ce_UnexpectedValueException, 0, "Error at offset %zd of %zd bytes", ((char*)p - serialized_data_buffer), buf_len);
RETURN_THROWS();