if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
    RETURN_THROWS();
}

if (buf_len == 0) {
    return;
}

s = p = (const unsigned char*)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

/* storage */
if (*p != 'x' || *++p != ':') {
    goto outexcept;
}
++p;

zval *count_val = var_tmp_var(&var_hash);
if (!php_var_unserialize(count_val, &p, s + buf_len, &var_hash) || Z_TYPE_P(count_val) != IS_LONG) {
    goto outexcept;
}

zend_long count = Z_LVAL_P(count_val);

if (*p != ';') {
    goto outexcept;
}
++p;

for (zend_ulong i = 0; i < count; ++i) {
    if (*p != 'r' && *p != 'O') {
        goto outexcept;
    }

    zval *obj_zval = var_tmp_var(&var_hash);
    if (!php_var_unserialize(obj_zval, &p, s + buf_len, &var_hash) || !Z_ISREF_P(obj_zval)) {
        goto outexcept;
    }

    zval ref_target;
    ZVAL_COPY_VALUE(&ref_target, Z_REFVAL_P(obj_zval));
    Z_TRY_ADDREF(ref_target);

    spl_SplObjectStorageElement *elem;
    zend_object *o = Z_OBJ(ref_target);
    ZEND_HASH_FIND(&intern->storage, o->handle, sizeof(o->handle), elem);

    if (elem == NULL) {
        ALLOCATE_SPL_STORAGE_ELEMENT(elem);
        elem->info_init = 0;
        ZVAL_NULL(&elem->inf);
        GC_ADDREF(o);
        elem->obj = o;
        zend_hash_index_add_ptr(&intern->storage, o->handle, elem);
    } else if (!GC_REFCOUNT(o)) {
        /* already added by another reference */
        GC_ADDREF(o);
        if (!elem->info_init) {
            elem->info_init = 1;
            INIT_PZVAL(&elem->inf);
            ZVAL_NULL(&elem->inf);
        }
    }

    /* Check for associated data */
    if (*p != ';' && *p != 'N') {
        if (*p != 'b' && *p != 'i' && *p != 'd' && *p != 's') {
            goto outexcept;
        }

        if (!php_var_unserialize(&elem->inf, &p, s + buf_len, &var_hash)) {
            goto outexcept;
        }
        elem->info_init = 1;
    } else if (*p == 'N') {
        ZVAL_NULL(&elem->inf);
        ++p;
        elem->info_init = 1;
    } else {
        ZVAL_NULL(&elem->inf);
        elem->info_init = 0;
    }

    /* Ensure the separator ';' is present */
    if (*p != ';') {
        goto outexcept;
    }
    ++p;
}