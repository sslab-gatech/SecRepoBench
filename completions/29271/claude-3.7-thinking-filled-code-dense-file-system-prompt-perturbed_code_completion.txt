if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
    RETURN_THROWS();
}

if (buf_len == 0) {
    return;
}

// Clear the storage
zend_hash_clean(&intern->storage);

s = p = (const unsigned char*)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

// Format: x:<count><obj1>,<inf1>;<obj2>,<inf2>;...m:<members>
if (*p!= 'x' || *++p != ':') {
    goto outexcept;
}
++p;

// Get the count
zval *count_zv = var_tmp_var(&var_hash);
if (!php_var_unserialize(count_zv, &p, s + buf_len, &var_hash) || Z_TYPE_P(count_zv) != IS_LONG) {
    goto outexcept;
}

zend_long count = Z_LVAL_P(count_zv);

// Process objects and their infos
for (zend_long i = 0; i < count; i++) {
    zval *obj = var_tmp_var(&var_hash);
    if (!php_var_unserialize(obj, &p, s + buf_len, &var_hash) || Z_TYPE_P(obj) != IS_OBJECT) {
        goto outexcept;
    }
    
    if (*p != ',') {
        goto outexcept;
    }
    ++p;
    
    zval *inf = var_tmp_var(&var_hash);
    if (!php_var_unserialize(inf, &p, s + buf_len, &var_hash)) {
        goto outexcept;
    }
    
    spl_object_storage_attach(intern, Z_OBJ_P(obj), inf);
    
    if (*p != ';') {
        goto outexcept;
    }
    ++p;
}