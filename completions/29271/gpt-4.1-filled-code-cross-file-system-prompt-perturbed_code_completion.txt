zval *zcount, *zstorage, *pmembers;
zend_long count, i;

if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
	RETURN_THROWS();
}

if (buf_len == 0) {
	return;
}

s = p = (const unsigned char*)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

if (*p != 'x' || *++p != ':') {
	goto outexcept;
}
++p;

/* count */
zcount = var_tmp_var(&var_hash);
if (!php_var_unserialize(zcount, &p, s + buf_len, &var_hash) || Z_TYPE_P(zcount) != IS_LONG) {
	goto outexcept;
}
count = Z_LVAL_P(zcount);

if (*p != ';') {
	goto outexcept;
}
++p;

/* storage */
if (*p != 'a' || *++p != ':') {
	goto outexcept;
}
++p;

zstorage = var_tmp_var(&var_hash);
if (!php_var_unserialize(zstorage, &p, s + buf_len, &var_hash) || Z_TYPE_P(zstorage) != IS_ARRAY) {
	goto outexcept;
}

/* clear current storage */
spl_object_storage_free_storage(intern);

/* iterate and attach objects */
for (i = 0; i < count; ++i) {
	zval *zentry = zend_hash_index_find(Z_ARRVAL_P(zstorage), i * 2);
	zval *zinfo = zend_hash_index_find(Z_ARRVAL_P(zstorage), i * 2 + 1);
	if (!zentry || Z_TYPE_P(zentry) != IS_OBJECT) {
		goto outexcept;
	}
	if (zinfo == NULL) {
		goto outexcept;
	}
	/* Attach object and info */
	spl_object_storage_attach(intern, Z_OBJ_P(zentry), zinfo);
}