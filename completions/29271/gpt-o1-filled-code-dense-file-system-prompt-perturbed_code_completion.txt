if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
	RETURN_THROWS();
}

if (!buf_len) {
	return;
}

s = p = (const unsigned char *) serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

if (*p != 'x' || *++p != ':') {
	goto outexcept;
}
++p;

/* parse the count of elements */
zval *zcount = var_tmp_var(&var_hash);
if (!php_var_unserialize(zcount, &p, s + buf_len, &var_hash) || Z_TYPE_P(zcount) != IS_LONG) {
	goto outexcept;
}

zend_long count = Z_LVAL_P(zcount);

/* iterate through and unserialize each object-info pair */
for (zend_long i = 0; i < count; i++) {
	zval *obj_zv = var_tmp_var(&var_hash);
	if (!php_var_unserialize(obj_zv, &p, s + buf_len, &var_hash) || Z_TYPE_P(obj_zv) != IS_OBJECT) {
		goto outexcept;
	}

	if (*p != ',') {
		goto outexcept;
	}
	++p;

	zval *inf_zv = var_tmp_var(&var_hash);
	if (!php_var_unserialize(inf_zv, &p, s + buf_len, &var_hash)) {
		goto outexcept;
	}

	if (*p != ';') {
		goto outexcept;
	}
	++p;

	spl_object_storage_attach(intern, Z_OBJ_P(obj_zv), inf_zv);
}