if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
    RETURN_THROWS();
}

if (buf_len == 0) {
    return;
}

s = p = (const unsigned char*)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

/* storage */
if (*p!= 'a' || *++p != ':') {
    goto outexcept;
}
++p;

zval *pentry = var_tmp_var(&var_hash);
if (!php_var_unserialize(pentry, &p, s + buf_len, &var_hash) || Z_TYPE_P(pentry) != IS_ARRAY) {
    goto outexcept;
}

/* Clear the storage */
zend_hash_clean(&intern->storage);

/* Process objects and their associated info */
HashTable *ht = Z_ARRVAL_P(pentry);
zval *data, *obj = NULL;
int count = 0;

ZEND_HASH_FOREACH_VAL(ht, data) {
    count++;
    if (count % 2 == 1) {
        /* This is an object */
        if (Z_TYPE_P(data) != IS_OBJECT) {
            goto outexcept;
        }
        obj = data;
    } else {
        /* This is the info */
        spl_object_storage_attach(intern, obj, data, 0);
    }
} ZEND_HASH_FOREACH_END();

if (count % 2 != 0) {
    /* We didn't get pairs of objects and info */
    goto outexcept;
}