/* storage */
s = p = (const unsigned char*)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

if (*p != 'x' || *++p != ':') {
	goto outexcept;
}
++p;

zval *pcount = var_tmp_var(&var_hash);
if (!php_var_unserialize(pcount, &p, s + buf_len, &var_hash) || Z_TYPE_P(pcount) != IS_LONG) {
	goto outexcept;
}

zend_long count = Z_LVAL_P(pcount);
if (count < 0) {
	goto outexcept;
}

while (count-- > 0) {
	if (*p != 'o' || *++p != ':') {
		goto outexcept;
	}
	++p;

	zval *obj = var_tmp_var(&var_hash);
	if (!php_var_unserialize(obj, &p, s + buf_len, &var_hash) || Z_TYPE_P(obj) != IS_OBJECT) {
		goto outexcept;
	}

	zval *inf = var_tmp_var(&var_hash);
	if (!php_var_unserialize(inf, &p, s + buf_len, &var_hash)) {
		goto outexcept;
	}

	spl_SplObjectStorageElement *element = spl_object_storage_get(intern, Z_OBJ_P(obj));
	if (element) {
		zval_ptr_dtor(&element->inf);
		ZVAL_COPY(&element->inf, inf);
	} else {
		spl_object_storage_attach(intern, obj, inf);
	}

	if (*p != ';') {
		goto outexcept;
	}
	++p;
}