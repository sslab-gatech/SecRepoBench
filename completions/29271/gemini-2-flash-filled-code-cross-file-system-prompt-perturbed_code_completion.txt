zval *pmembers;
	zend_long count;
	zend_object *obj;
	zval *zdata = NULL;
	spl_SplObjectStorageElement *new_elem;
	zval tmp_obj;

	if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
		RETURN_THROWS();
	}

	if (!buf_len) {
		return;
	}

	p = (const unsigned char*) serialized_data_buffer;
	s = p;

	PHP_VAR_UNSERIALIZE_INIT(var_hash);

	/* storage */
	if (*p != 'O' || *++p != ':') {
		goto outexcept;
	}
	++p;

	if (!php_var_unserialize(&tmp_obj, &p, s + buf_len, &var_hash)) {
		goto outexcept;
	}

	if (Z_TYPE(tmp_obj) != IS_LONG) {
		zval_ptr_dtor(&tmp_obj);
		goto outexcept;
	}

	count = Z_LVAL(tmp_obj);
	zval_ptr_dtor(&tmp_obj);

	while (count-- > 0) {
		if (*p != '{') {
			goto outexcept;
		}
		++p;

		/* object */
		if (*p != 'O' || *++p != ':') {
			goto outexcept;
		}
		++p;

		if (!(obj = php_var_unserialize_ex(&tmp_obj, &p, s + buf_len, &var_hash))) {
			goto outexcept;
		}

		if (Z_TYPE(tmp_obj) != IS_OBJECT) {
			zval_ptr_dtor(&tmp_obj);
			goto outexcept;
		}

		/* data */
		if (*p == 'd' && *++p == ':') {
			++p;
			zdata = var_tmp_var(&var_hash);
			if (!php_var_unserialize(zdata, &p, s + buf_len, &var_hash)) {
				zval_ptr_dtor(&tmp_obj);
				goto outexcept;
			}
		} else {
			zdata = NULL;
		}

		if (*p != '}') {
			if (zdata) {
				zval_ptr_dtor(zdata);
			}
			zval_ptr_dtor(&tmp_obj);
			goto outexcept;
		}
		++p;

		new_elem = spl_obj_storage_get_element(intern, obj);

		if (!new_elem) {
			new_elem = spl_obj_storage_attach(intern, obj);
		}

		zval_ptr_dtor(&tmp_obj);

		if (zdata) {
			zval_ptr_dtor(&new_elem->inf);
			ZVAL_COPY(&new_elem->inf, zdata);
			zval_ptr_dtor(zdata);
		}
	}