zval *pmembers;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

/* storage */
if (*p != 'x' || *++p != ':') {
    goto outexcept;
}
++p;

zend_long count;
if (!php_var_unserialize(&count, &p, s + buf_len, &var_hash) || Z_TYPE(flags) != IS_LONG) {
    goto outexcept;
}

for (zend_long i = 0; i < count; i++) {
    zval obj;
    if (!php_var_unserialize(&obj, &p, s + buf_len, &var_hash) || Z_TYPE(obj) != IS_OBJECT) {
        goto outexcept;
    }

    zval inf;
    if (!php_var_unserialize(&inf, &p, s + buf_len, &var_hash)) {
        zval_ptr_dtor(&obj);
        goto outexcept;
    }

    spl_object_storage_attach(intern, Z_OBJ(obj), &inf);
    zval_ptr_dtor(&obj);
    zval_ptr_dtor(&inf);
}