if (zend_parse_parameters(ZEND_NUM_ARGS(), "s", &serialized_data_buffer, &buf_len) == FAILURE) {
    RETURN_THROWS();
}

if (buf_len == 0) {
    return;
}

s = p = (const unsigned char*)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

if (*p != 'x' || *++p != ':') {
    goto outexcept;
}
++p;

zval *count_val = var_tmp_var(&var_hash);
if (!php_var_unserialize(count_val, &p, s + buf_len, &var_hash) || Z_TYPE_P(count_val) != IS_LONG) {
    goto outexcept;
}

zend_long count = Z_LVAL_P(count_val);
if (count < 0) {
    goto outexcept;
}

if (*p != ':') {
    goto outexcept;
}
++p;

for (zend_long i = 0; i < count; ++i) {
    zval *obj, *inf = NULL;
    spl_SplObjectStorageElement *element;

    if (*p != 'O' && *p != 'C' && *p != 'r') {
        goto outexcept;
    }

    obj = var_tmp_var(&var_hash);
    if (!php_var_unserialize(obj, &p, s + buf_len, &var_hash) || Z_TYPE_P(obj) != IS_OBJECT) {
        goto outexcept;
    }

    if (*p == ';') {
        ++p;
    } else if (*p == ':') {
        ++p;
        inf = var_tmp_var(&var_hash);
        if (!php_var_unserialize(inf, &p, s + buf_len, &var_hash)) {
            goto outexcept;
        }
        if (*p != ';') {
            goto outexcept;
        }
        ++p;
    } else {
        goto outexcept;
    }

    element = spl_object_storage_get(intern, Z_OBJ_P(obj));
    if (!element) {
        element = spl_object_storage_attach(intern, Z_OBJ_P(obj), inf);
    } else {
        if (inf) {
            zval_ptr_dtor(&element->inf);
            ZVAL_COPY(&element->inf, inf);
        }
    }
}