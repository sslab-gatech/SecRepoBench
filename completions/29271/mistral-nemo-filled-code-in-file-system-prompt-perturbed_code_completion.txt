static void spl_multiple_iterator_serialize(spl_SplObjectStorage *intern, smart_str *buf) /* {{{ */
{
	spl_SplObjectStorageElement *element;
	zval tmp;

	PHP_VAR_SERIALIZE_INIT(var_hash);

	/* storage */
	smart_str_appendl(buf, "x:", 2);
	ZVAL_LONG(&tmp, zend_hash_num_elements(&intern->storage));
	php_var_serialize(buf, &tmp, &var_hash);

	ZEND_HASH_FOREACH_PTR(&intern->storage, element) {
		zval obj;
		ZVAL_OBJ_COPY(&obj, element->obj);
		php_var_serialize(buf, &obj, &var_hash);
		smart_str_appendc(buf, ',');
		php_var_serialize(buf, &element->inf, &var_hash);
		smart_str_appendc(buf, ';');
	} ZEND_HASH_FOREACH_END();

	/* members */
	smart_str_appendl(buf, "m:", 2);

	ZVAL_ARR(&tmp, zend_std_get_properties(&intern->std));
	php_var_serialize(buf, &tmp, &var_hash); /* finishes the string */

	PHP_VAR_SERIALIZE_DESTROY(var_hash);
} /* }}} */

static void spl_multiple_iterator_unserialize(spl_SplObjectStorage *intern, const unsigned char *p, const unsigned char *s) /* {{{ */
{
	php_unserialize_data_t var_hash;
	zval *storage_zv, *members_zv, *key, *val;

	PHP_VAR_UNSERIALIZE_INIT(var_hash);

	storage_zv = var_unserialize(p, s, &var_hash);
	members_zv = var_unserialize(p, s, &var_hash);

	if (!storage_zv || !members_zv ||
			Z_TYPE_P(storage_zv) != IS_ARRAY || Z_TYPE_P(members_zv) != IS_ARRAY) {
		zend_throw_exception(spl_ce_UnexpectedValueException,
			"Incomplete or ill-typed serialization data", 0);
		PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
		return;
	}

	if (zend_hash_num_elements(Z_ARRVAL_P(storage_zv)) % 2 != 0) {
		zend_throw_exception(spl_ce_UnexpectedValueException, "Odd number of elements", 0);
		PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
		return;
	}

	key = NULL;
	ZEND_HASH_FOREACH_VAL(Z_ARRVAL_P(storage_zv), val) {
		if (key) {
			if (Z_TYPE_P(key) != IS_OBJECT) {
				zend_throw_exception(spl_ce_UnexpectedValueException, "Non-object key", 0);
				PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
				return;
			}

			spl_object_storage_attach(intern, Z_OBJ_P(key), val);
			key = NULL;
		} else {
			key = val;
		}
	} ZEND_HASH_FOREACH_END();

	object_properties_load(&intern->std, Z_ARRVAL_P(members_zv));

	PHP_VAR_UNSERIALIZE_DESTROY(var_hash);
} /* }}} */