PHP_VAR_UNSERIALIZE_INIT(var_hash);

	if (*p!= 'c' || *++p != ':') {
		goto outexcept;
	}
	++p;

	count = var_tmp_var(&var_hash);
	if (!php_var_unserialize(count, &p, s + buf_len, &var_hash) || Z_TYPE_P(count) != IS_LONG) {
		goto outexcept;
	}

	if (*p != ';') {
		goto outexcept;
	}
	++p;

	for (i = 0; i < Z_LVAL_P(count); ++i) {
		zval *object, *pmembers;
		spl_SplObjectStorageElement *elem;

		if (*p!= 'O' || *++p != ':') {
			goto outexcept;
		}
		++p;

		object = var_tmp_var(&var_hash);
		if (!php_var_unserialize(object, &p, s + buf_len, &var_hash) || Z_TYPE_P(object) != IS_OBJECT) {
			goto outexcept;
		}

		if (*p != ';') {
			goto outexcept;
		}
		++p;

		elem = emalloc(sizeof(spl_SplObjectStorageElement));
		elem->obj = Z_OBJ_P(object);
		GC_ADDREF(elem->obj);

		if (*p == 'N') {
			++p;
			if (*p != ';') {
				goto outexcept;
			}
			++p;
			elem->inf = NULL;
		} else {
			if (*p!= 'm' || *++p != ':') {
				goto outexcept;
			}
			++p;

			pmembers = var_tmp_var(&var_hash);
			if (!php_var_unserialize(pmembers, &p, s + buf_len, &var_hash)) {
				efree(elem);
				goto outexcept;
			}

			elem->inf = pmembers;
		}

		zend_hash_index_update(&intern->storage, (zend_ulong)elem->obj, &elem, sizeof(spl_SplObjectStorageElement*), NULL);
	}