ZEND_PARSE_PARAMETERS_START(1, 1)
    Z_PARAM_STRING(serialized_data_buffer, buf_len)
ZEND_PARSE_PARAMETERS_END();

PHP_VAR_UNSERIALIZE_INIT(var_hash);

s = (const unsigned char*)serialized_data_buffer;
p = s;

/* storage */
if (*p != 'x' || *++p != ':') {
    goto outexcept;
}
++p;

pcount = var_tmp_var(&var_hash);
if (!php_var_unserialize(pcount, &p, s + buf_len, &var_hash) || Z_TYPE_P(pcount) != IS_LONG) {
    goto outexcept;
}

zend_hash_init(&intern->storage, Z_LVAL_P(pcount), NULL, spl_object_storage_dtor, 0);

while (Z_LVAL_P(pcount)-- > 0) {
    zval *obj, *inf;
    spl_SplObjectStorageElement *element;

    obj = var_tmp_var(&var_hash);
    if (!php_var_unserialize(obj, &p, s + buf_len, &var_hash) || Z_TYPE_P(obj) != IS_OBJECT) {
        goto outexcept;
    }

    inf = var_tmp_var(&var_hash);
    if (*p == ',') { /* new version has inf */
        ++p;
        if (!php_var_unserialize(inf, &p, s + buf_len, &var_hash)) {
            goto outexcept;
        }
    } else {
        ZVAL_NULL(inf);
    }

    if (*p != ';') {
        goto outexcept;
    }
    ++p;

    element = spl_object_storage_attach(intern, Z_OBJ_P(obj), inf);
    if (!element) {
        goto outexcept;
    }
}