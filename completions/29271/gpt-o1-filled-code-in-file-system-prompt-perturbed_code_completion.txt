zval *pcount, *pobject, *pinf, *pmembers;
zval tmp;
zend_long count;

ZEND_PARSE_PARAMETERS_START(1, 1)
	Z_PARAM_STRING(serialized_data_buffer, buf_len)
ZEND_PARSE_PARAMETERS_END();

p = s = (const unsigned char *)serialized_data_buffer;
PHP_VAR_UNSERIALIZE_INIT(var_hash);

/* Parse stored elements count */
if (p + 2 > s + buf_len || memcmp(p, "x:", 2) != 0) {
	goto outexcept;
}
p += 2;

/* Unserialize elements count */
pcount = var_tmp_var(&var_hash);
if (!php_var_unserialize(pcount, &p, s + buf_len, &var_hash)) {
	goto outexcept;
}
convert_to_long_ex(pcount);
count = Z_LVAL_P(pcount);

/* Unserialize each stored object and its info */
while (count-- > 0) {
	pobject = var_tmp_var(&var_hash);
	if (!php_var_unserialize(pobject, &p, s + buf_len, &var_hash)) {
		goto outexcept;
	}

	if (p >= s + buf_len || *p != ',') {
		goto outexcept;
	}
	p++;

	pinf = var_tmp_var(&var_hash);
	if (!php_var_unserialize(pinf, &p, s + buf_len, &var_hash)) {
		goto outexcept;
	}

	if (Z_TYPE_P(pobject) != IS_OBJECT) {
		goto outexcept;
	}

	spl_object_storage_attach(intern, Z_OBJ_P(pobject), pinf);
}