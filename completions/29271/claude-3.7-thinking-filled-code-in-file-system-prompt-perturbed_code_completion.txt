ZEND_PARSE_PARAMETERS_START(1, 1)
    Z_PARAM_STRING(serialized_data_buffer, buf_len)
ZEND_PARSE_PARAMETERS_END();

s = p = (const unsigned char*) serialized_data_buffer;

PHP_VAR_UNSERIALIZE_INIT(var_hash);

if (*p!= 'x' || *++p != ':') {
    goto outexcept;
}
++p;

/* storage */
{
    zval *pmembers, *pcount;
    pcount = var_tmp_var(&var_hash);
    if (!php_var_unserialize(pcount, &p, s + buf_len, &var_hash)) {
        goto outexcept;
    }
    
    while (p < s + buf_len && *p != 'm') {
        zval *obj, *inf;
        
        obj = var_tmp_var(&var_hash);
        if (!php_var_unserialize(obj, &p, s + buf_len, &var_hash)) {
            goto outexcept;
        }
        
        if (Z_TYPE_P(obj) != IS_OBJECT) {
            goto outexcept;
        }
        
        if (*p != ',') {
            goto outexcept;
        }
        ++p;
        
        inf = var_tmp_var(&var_hash);
        if (!php_var_unserialize(inf, &p, s + buf_len, &var_hash)) {
            goto outexcept;
        }
        
        if (*p != ';') {
            goto outexcept;
        }
        ++p;
        
        spl_object_storage_attach(intern, Z_OBJ_P(obj), inf);
    }
}