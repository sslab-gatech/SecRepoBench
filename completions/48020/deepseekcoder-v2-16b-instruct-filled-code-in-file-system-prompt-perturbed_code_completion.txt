.total_packet_len += rawsize;

    if(enable_flow_stats) {
      ndpi_clear_entropy_stats(flow);
      flow->entropy->src2dst_pkt_count++;
      flow->entropy->src2dst_pkt_len[flow->entropy->src2dst_pkt_count-1] = rawsize;
      flow->entropy->src2dst_pkt_time[flow->entropy->src2dst_pkt_count-1] = when;
      flow->entropy->src2dst_l4_bytes += payload_len;
      flow->entropy->src2dst_pkt_time[flow->entropy->src2dst_pkt_count-1] = when;
    }

    if(src_to_dst_direction) {
      flow->src2dst_packets++;
      flow->src2dst_bytes += rawsize;
    } else {
      flow->dst2src_packets++;
      flow->dst2src_bytes += rawsize;
    }

    if(flow->entropy->src2dst_pkt_count + flow->entropy->dst2src_pkt_count > max_num_packets_per_flow) {
      if(src_to_dst_direction) {
	flow->src2dst_packets--;
	flow->src2dst_bytes -= rawsize;
      } else {
	flow->dst2src_packets--;
	flow->dst2src_bytes -= rawsize;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP || proto == IPPROTO_UDP) {
      update_tcp_flags_count(flow, tcph, src_to_dst_direction);
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	begin_or_end_tcp = 1;
      } else if(tcph->syn && !tcph->fin) {
	begin_or_end_tcp = 2;
      } else if(!tcph->syn && tcph->fin) {
	begin_or_end_tcp = 3;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {
	flow->syn_fin_count++;
      } else if(tcph->syn && !tcph->fin) {
	flow->syn_count++;
      } else if(!tcph->syn && tcph->fin) {
	flow->fin_count++;
      }
    }

    if(proto == IPPROTO_TCP) {
      if(tcph->syn && tcph->fin) {