.ip_byte_count += ipsize;

    if(enable_flow_stats) {
      if(src_to_dst_direction) {
        flow->entropy->src2dst_pkt_count++;
        flow->entropy->src2dst_ip_bytes += ipsize;
        flow->entropy->src2dst_pkt_time[flow->entropy->src2dst_pkt_count-1] = when;
      } else {
        flow->entropy->dst2src_pkt_count++;
        flow->entropy->dst2src_ip_bytes += ipsize;
        flow->entropy->dst2src_pkt_time[flow->entropy->dst2src_pkt_count-1] = when;
      }
    }

    if(flow->entropy->src2dst_pkt_count + flow->entropy->dst2src_pkt_count > max_num_packets_per_flow) {
      ndpi_clear_entropy_stats(flow);
    }

    if(flow->entropy->src2dst_pkt_count + flow->entropy->dst2src_pkt_count <= max_num_packets_per_flow) {
      if(proto == IPPROTO_TCP) {
        if(tcph->syn && tcph->ack) {
          begin_or_end_tcp = 1;
        } else if(tcph->fin) {
          begin_or_end_tcp = 2;
        }
      }

      if(begin_or_end_tcp == 1) {
        if(src_to_dst_direction) {
          flow->entropy->src2dst_syn_count++;
        } else {
          flow->entropy->dst2src_syn_count++;
        }
      } else if(begin_or_end_tcp == 2) {
        if(src_to_dst_direction) {
          flow->entropy->src2dst_fin_count++;
        } else {
          flow->entropy->dst2src_fin_count++;
        }
      }

      if(enable_payload_analyzer) {
        ndpi_payload_analyzer(flow, src_to_dst_direction, payload, payload_len, flow->entropy->src2dst_pkt_count + flow->entropy->dst2src_pkt_count);
      }

      if(enable_flow_stats) {
        ndpi_flow_update_byte_count(flow, payload, payload_len, src_to_dst_direction);
        ndpi_flow_update_byte_dist_mean_var(flow, payload, payload_len, src_to_dst_direction);
      }

      update_tcp_flags_count(flow, tcph, src_to_dst_direction);

      if(flow_risk) {
        *flow_risk = flow->risk;
      }

      ndpi_flow = flow->ndpi_flow;

      if(ndpi_flow->flow_type == NDPI_PROTOCOL_TLS) {
        if(flow->ssh_tls.server_names) ndpi_free(flow->ssh_tls.server_names);
        if(flow->ssh_tls.tls_alpn) ndpi_free(flow->ssh_tls.tls_alpn);
        if(flow->ssh_tls.tls_supported_versions) ndpi_free(flow->ssh_tls.tls_supported_versions);
        if(flow->ssh_tls.tls_issuerDN) ndpi_free(flow->ssh_tls.tls_issuerDN);
        if(flow->ssh_tls.tls_subjectDN) ndpi_free(flow->ssh_tls.tls_subjectDN);
        if(flow->ssh_tls.encrypted_sni.esni) ndpi_free(flow->ssh_tls.encrypted_sni.esni);

        flow->ssh_tls.server_names = ndpi_strdup(ndpi_flow->ssh_tls.server_names);
        flow->ssh_tls.tls_alpn = ndpi_strdup(ndpi_flow->ssh_tls.tls_alpn);
        flow->ssh_tls.tls_supported_versions = ndpi_strdup(ndpi_flow->ssh_tls.tls_supported_versions);
        flow->ssh_tls.tls_issuerDN = ndpi_strdup(ndpi_flow->ssh_tls.tls_issuerDN);
        flow->ssh_tls.tls_subjectDN = ndpi_strdup(ndpi_flow->ssh_tls.tls_subjectDN);
        flow->ssh_tls.encrypted_sni.esni = ndpi_strdup(ndpi_flow->ssh_tls.encrypted_sni.esni);
      }

      if(ndpi_flow->flow_type == NDPI_PROTOCOL_QUIC) {
        if(flow->ssh_tls.server_names) ndpi_free(flow->ssh_tls.server_names);
        if(flow->ssh_tls.tls_alpn) ndpi_free(flow->ssh_tls.tls_alpn);
        if(flow->ssh_tls.tls_supported_versions) ndpi_free(flow->ssh_tls.tls_supported_versions);
        if(flow->ssh_tls.tls_issuerDN) ndpi_free(flow->ssh_tls.tls_issuerDN);
        if(flow->ssh_tls.tls_subjectDN) ndpi_free(flow->ssh_tls.tls_subjectDN);
        if(flow->ssh_tls.encrypted_sni.esni) ndpi_free(flow->ssh_tls.encrypted_sni.esni);

        flow->ssh_tls.server_names = ndpi_strdup(ndpi_flow->ssh_tls.server_names);
        flow->ssh_tls.tls_alpn = ndpi_strdup(ndpi_flow->ssh_tls.tls_alpn);
        flow->ssh_tls.tls_supported_versions = ndpi_strdup(ndpi_flow->ssh_tls.tls_supported_versions);
        flow->ssh_tls.tls_issuerDN = ndpi_strdup(ndpi_flow->ssh_tls.tls_issuerDN);
        flow->ssh_tls.tls_subjectDN = ndpi_strdup(ndpi_flow->ssh_tls.tls_subjectDN);
        flow->ssh_tls.encrypted_sni.esni = ndpi_strdup(ndpi_flow->ssh_tls.encrypted_sni.esni);
      }

      if(ndpi_flow->flow_type == NDPI_PROTOCOL_HTTP) {
        if(flow->http.url) ndpi_free(flow->http.url);
        flow->http.url = ndpi_strdup(ndpi_flow->http.url);
        flow->http.response_status_code = ndpi_flow->http.response_status_code;
        if(flow->http.content_type) ndpi_free(flow->http.content_type);
        flow->http.content_type = ndpi_strdup(ndpi_flow->http.content_type ? ndpi_flow->http.content_type : "");
        if(flow->http.request_content_type) ndpi_free(flow->http.request_content_type);
        flow->http.request_content_type = ndpi_strdup(ndpi_flow->http.request_content_type ? ndpi_flow->http.request_content_type : "");
      }

      if(ndpi_flow->flow_type == NDPI_PROTOCOL_FTP_CONTROL) {
        if(flow->ftp_imap_pop_smtp.username) ndpi_free(flow->ftp_imap_pop_smtp.username);
        flow->ftp_imap_pop_smtp.username = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.username);
        if(flow->ftp_imap_pop_smtp.password) ndpi_free(flow->ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.password = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.auth_failed = ndpi_flow->l4.tcp.ftp_imap_pop_smtp.auth_failed;
      } else if(ndpi_flow->flow_type == NDPI_PROTOCOL_MAIL_IMAP) {
        if(flow->ftp_imap_pop_smtp.username) ndpi_free(flow->ftp_imap_pop_smtp.username);
        flow->ftp_imap_pop_smtp.username = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.username);
        if(flow->ftp_imap_pop_smtp.password) ndpi_free(flow->ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.password = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.auth_failed = ndpi_flow->l4.tcp.ftp_imap_pop_smtp.auth_failed;
      } else if(ndpi_flow->flow_type == NDPI_PROTOCOL_MAIL_POP) {
        if(flow->ftp_imap_pop_smtp.username) ndpi_free(flow->ftp_imap_pop_smtp.username);
        flow->ftp_imap_pop_smtp.username = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.username);
        if(flow->ftp_imap_pop_smtp.password) ndpi_free(flow->ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.password = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.auth_failed = ndpi_flow->l4.tcp.ftp_imap_pop_smtp.auth_failed;
      } else if(ndpi_flow->flow_type == NDPI_PROTOCOL_MAIL_SMTP) {
        if(flow->ftp_imap_pop_smtp.username) ndpi_free(flow->ftp_imap_pop_smtp.username);
        flow->ftp_imap_pop_smtp.username = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.username);
        if(flow->ftp_imap_pop_smtp.password) ndpi_free(flow->ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.password = ndpi_strdup(ndpi_flow->l4.tcp.ftp_imap_pop_smtp.password);
        flow->ftp_imap_pop_smtp.auth_failed = ndpi_flow->l4.tcp.ftp_imap_pop_smtp.auth_failed;
      }

      if(ndpi_flow->flow_type == NDPI_PROTOCOL_KERBEROS) {
        if(flow->kerberos.domain) ndpi_free(flow->kerberos.domain);
        flow->kerberos.domain = ndpi_strdup(ndpi_flow->protos.kerberos.domain);
        if(flow->kerberos.hostname) ndpi_free(flow->kerberos.hostname);
        flow->kerberos.hostname = ndpi_strdup(ndpi_flow->protos.kerberos.hostname);
        if(flow->kerberos.username) ndpi_free(flow->kerberos.username);
        flow->kerberos.username = ndpi_strdup(ndpi_flow->protos.kerberos.username);
      }

      if(ndpi_flow->flow_type == NDPI_PROTOCOL_TLS) {
        flow->ssh_tls.ssl_version = ndpi_flow->ssh_tls.ssl_version;
        flow->ssh_tls.tls_version = ndpi_flow->ssh_tls.tls_version;
        flow->ssh_tls.tls_cipher_suite = ndpi_flow->ssh_tls.tls_cipher_suite;
        flow->ssh_tls.tls_client_hello.ja3_hash = ndpi_flow->ssh_tls.tls_client_hello.ja3_hash;
        flow->ssh_tls.tls_client_hello.ja3_s_hash = ndpi_flow->ssh_tls.tls_client_hello.ja3_s_hash;
        flow->ssh_tls.tls_client_hello.ja3_extensions = ndpi_flow->ssh_tls.tls_client_hello.ja3_extensions;
        flow->ssh_tls.tls_client_hello.ja3_supported_versions = ndpi_flow->ssh_tls.tls_client_hello.ja3_supported_versions;
        flow->ssh_tls.tls_