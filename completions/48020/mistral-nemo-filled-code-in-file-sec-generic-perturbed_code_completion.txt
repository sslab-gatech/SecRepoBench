def ndpi_malloc_wrapper(size):
    current_ndpi_memory += size
    if current_ndpi_memory > max_ndpi_memory:
        max_ndpi_memory = current_ndpi_memory
    return malloc(size)

def ndpi_free_wrapper(void *freeable):
    free(freeable)

def ndpi_workflow_init(const struct ndpi_workflow_prefs *prefs, pcap_t *pcap_handle, int do_init_flows_root, ndpi_serialization_format serialization_format):
    set_ndpi_malloc(ndpi_malloc_wrapper), set_ndpi_free(ndpi_free_wrapper)
    workflow = ndpi_calloc(1, sizeof(struct ndpi_workflow))
    if workflow is None:
        LOG(NDPI_LOG_ERROR, "global structure initialization failed\n")
        exit(-1)
    workflow.pcap_handle = pcap_handle
    workflow.prefs = *prefs
    workflow.ndpi_struct = ndpi_init_detection_module(enable_ja3_plus ? ndpi_enable_ja3_plus : ndpi_no_prefs)
    if workflow.ndpi_struct is None:
        LOG(NDPI_LOG_ERROR, "global structure initialization failed\n")
        ndpi_free(workflow)
        exit(-1)
    ndpi_set_log_level(workflow.ndpi_struct, nDPI_LogLevel)
    if _debug_protocols != NULL and not _debug_protocols_ok:
        if parse_debug_proto(workflow.ndpi_struct, _debug_protocols):
            exit(-1)
        _debug_protocols_ok = 1
    if _debug_protocols_ok:
        ndpi_set_debug_bitmask(workflow.ndpi_struct, debug_bitmask)
    if serialization_format != ndpi_serialization_format_unknown and ndpi_init_serializer(&workflow.ndpi_serializer, serialization_format) != 0:
        LOG(NDPI_LOG_ERROR, "serializer initialization failed\n")
        exit(-1)
    return workflow

def ndpi_flow_info_freer(void *node):
    flow = (struct ndpi_flow_info*)node
    ndpi_flow_info_free_data(flow)
    ndpi_free(flow)

def ndpi_workflow_free(struct ndpi_workflow *workflow):
    ndpi_term_serializer(&workflow.ndpi_serializer)
    for i in range(workflow.prefs.num_roots):
        ndpi_tdestroy(workflow.ndpi_flows_root[i], ndpi_flow_info_freer)
    ndpi_exit_detection_module(workflow.ndpi_struct)
    ndpi_free(workflow.ndpi_flows_root)
    ndpi_free(workflow)