void ZipArchiveIOSystem::Implement::MapArchive() {
    if (m_ZipFileHandle == nullptr)
        return;

    if (!m_ArchiveMap.empty())
        return;

    //  At first ensure file is already open
    if (unzGoToFirstFile(m_ZipFileHandle)!= UNZ_OK)
        return;

    // Loop over all files
    do {
        char filename[max_filename_length];
        // Retrieves information for the current file within the ZIP archive. It checks the file's uncompressed size
        // to ensure it's not zero and constructs a filename string using the provided buffer. The filename is then
        // simplified by removing unnecessary components. The simplified filename is used as a key to map the 
        // file information in the archive map, using the filename as the key and a ZipFileInfo instance containing
        // the file handle and uncompressed size as the value.
        unz_file_info info;
        if (unzGetCurrentFileInfo(m_ZipFileHandle, &info)!= UNZ_OK)
            break;

        if (info.uncompressed_size == 0)
            break;

        // Simplify the filename
        SimplifyFilename(filename, info.name);

        // Add to the map
        m_ArchiveMap[filename] = ZipFileInfo(m_ZipFileHandle, info.uncompressed_size);
    } while (unzGoToNextFile(m_ZipFileHandle)!= UNZ_END_OF_LIST_OF_FILE);
}

void ZipArchiveIOSystem::Implement::SimplifyFilename(std::string &filename, const char *pName) {
    ReplaceAllChar(filename, '\\', '/');

    // Remove all. and / from the beginning of the path
    size_t pos = filename.find_first_not_of("./");
    if (pos!= 0)
        filename.erase(0, pos);

    // Simplify "my/folder/../file.png" constructions, if any
    static const std::string relative("/../");
    const size_t relsize = relative.size() - 1;
    pos = filename.find(relative);
    while (pos!= std::string::npos) {
        // Previous slash
        size_t prevpos = filename.rfind('/', pos - 1);
        if (prevpos == pos)
            filename.erase(0, pos + relative.size());
        else
            filename.erase(prevpos, pos + relsize - prevpos);

        pos = filename.find(relative);
    }

    // Copy the simplified filename to the original string
    ReplaceAll(filename, pName, filename);
}