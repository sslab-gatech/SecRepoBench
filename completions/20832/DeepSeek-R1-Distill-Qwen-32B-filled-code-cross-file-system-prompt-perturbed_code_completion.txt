if (offset >= flow->packet.payload_packet_len)
  return(1);

while (offset < flow->packet.payload_packet_len && flow->packet.payload[offset] != '\0') {
  offset++;
}

if (offset >= flow->packet.payload_packet_len || offset + 2 > flow->packet.payload_packet_len)
  return(1);

offset++; // Move past null terminator
dns_header->query_type = get16(&offset, flow->packet.payload);

// Optional debug logging
// NDPI_LOG_DBG(ndpi_struct, "DNS query type: 0x%04x\n", dns_header->query_type);