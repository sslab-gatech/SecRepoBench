{
  u_int16_t query_type, query_class;

  /* Iterate over the payload until we find a null terminator or run out of data */
  while((offset < flow->packet.payload_packet_len) &&
        (flow->packet.payload[offset] != 0)) {
    offset++;
  }

  /* Check if we reached or exceeded packet length */
  if(offset >= flow->packet.payload_packet_len) {
    return(1 /* invalid */);
  }

  /* Skip the null terminator */
  offset++;

  /* Ensure we can read the query type and class (4 bytes total) */
  if((offset + 4) > flow->packet.payload_packet_len) {
    return(1 /* invalid */);
  }

  /* Read the query type */
  query_type = get16(&offset, flow->packet.payload);

  /* Read the query class */
  query_class = get16(&offset, flow->packet.payload);

  /* Optionally log the query type for debugging */
  NDPI_LOG_DBG(ndpi_struct, "DNS Request Query Type=%u, Class=%u\n", query_type, query_class);

  /* If desired, store the query type/class in flow->protos.dns */
  flow->protos.dns.req_type = query_type;
  /* flow->protos.dns.req_class = query_class; // if you want to store it as well */
}