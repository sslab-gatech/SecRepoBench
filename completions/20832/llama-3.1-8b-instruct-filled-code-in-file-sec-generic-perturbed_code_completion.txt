if(*is_query) {
  /* DNS Request */
  if((dns_header->num_queries > 0) && (dns_header->num_queries <= NDPI_MAX_DNS_REQUESTS)
     && (((dns_header->flags & 0x2800) == 0x2800 /* Dynamic DNS Update */)
	 || ((dns_header->num_answers == 0) && (dns_header->authority_rrs == 0)))) 
  {
    u_int16_t query_type = 0;
    int i = 0;
    int query_len = 0;
    int query_offset = sizeof(struct ndpi_dns_packet_header) + payload_offset;

    while(i < dns_header->num_queries) {
      if((query_offset + 2) >= flow->packet.payload_packet_len) {
	break;
      }

      query_type = get16(&query_offset, flow->packet.payload);
      flow->protos.dns.query_type[i] = query_type;

      if(query_type == 0x05 /* CNAME */) {
	offset += 2;
	continue; /* Skip CNAME */
      }

      if((((query_type == 0x1) && (query_len == 4)) /* A */
#ifdef NDPI_DETECTION_SUPPORT_IPV6
	  || ((query_type == 0x1c) && (query_len == 16)) /* AAAA */
#endif
	  )) {
	memcpy(&flow->protos.dns.query_addr[i], flow->packet.payload + query_offset, query_len);
      }

      query_len = getNameLength(query_offset, flow->packet.payload, flow->packet.payload_packet_len);
      query_offset += query_len + 2;
      i++;
    }
  } else
    return(1 /* invalid */);
}