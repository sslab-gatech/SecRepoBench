{
  /*
    Extract the DNS query name by iterating until we encounter a null terminator.
    Make sure we don't exceed the payload length while doing so.
  */
  while((offset < flow->packet.payload_packet_len) &&
        (flow->packet.payload[offset] != '\0')) {
    offset++;
  }

  /*
    If offset points beyond the payload length, we cannot safely proceed.
  */
  if(offset >= flow->packet.payload_packet_len) {
    return(1 /* invalid */);
  }

  /*
    Skip the null terminator.
  */
  offset++;

  /*
    Ensure we have at least 2 bytes available to read the query type.
  */
  if((offset + 2) > flow->packet.payload_packet_len) {
    return(1 /* invalid */);
  }

  /*
    Read the query type (2 bytes).
  */
  {
    u_int16_t query_type = (flow->packet.payload[offset] << 8)
                           | flow->packet.payload[offset + 1];
    offset += 2;

    /*
      Optionally log the query type for debugging purposes.
    */
    NDPI_LOG_DBG(ndpi_struct, "DNS Query type: 0x%04x\n", query_type);
  }
}