const unsigned char *sptr, *sptr0;
  char *dptr, *dptr0;
  int i, bits_to_read;

  sptr = (const unsigned char *)src;
  sptr0 = sptr;

  if (count < 0) {
    count = slen * 8;
  }
  if (count > slen * 8) {
    count = slen * 8;
  }
  bits_to_read = count;

  dst = mrb_str_new(mrbstate, NULL, bits_to_read);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  for (i = 0; i < bits_to_read; i++) {
    int bit;
    if (flags & PACK_FLAG_LSB) {
      bit = (sptr[i >> 3] >> (i & 7)) & 1;
    } else {
      bit = (sptr[i >> 3] >> (7 - (i & 7))) & 1;
    }
    *dptr++ = bit ? '1' : '0';
  }

  sptr += (bits_to_read + 7) >> 3;