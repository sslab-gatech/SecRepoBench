CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  int dstlen = (slen * 8 + 6) / 7;  // Calculate the maximum possible length
  dst = mrb_str_new(mrbstate, NULL, dstlen);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  const unsigned char *sptr = (const unsigned char*)src;
  const unsigned char *sptr0 = sptr;

  if (count == -1) count = slen * 8;

  int bits = 0;
  int ch = 0;
  while (count > 0 && slen > 0) {
    if (bits < 8) {
      ch |= *sptr << bits;
      bits += 8;
      sptr++;
      slen--;
    }
    if (flags & PACK_FLAG_LSB) {
      *dptr++ = (ch & 1) ? '1' : '0';
      ch >>= 1;
    } else {
      *dptr++ = (ch & 0x80) ? '1' : '0';
      ch <<= 1;
    }
    bits--;
    count--;
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
  mrb_ary_push(mrbstate, ary, dst);
  return (int)(sptr - sptr0);