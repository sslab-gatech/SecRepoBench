const char *sptr = src;
  const char *sptr0 = sptr;
  int slen = RSTRING_LEN(ary);

  if (count == -1) {
    count = slen * 8;
  }
  else if (count > slen * 8) { // Ensure count does not exceed the maximum possible bits
    count = slen * 8;
  }

  mrb_value dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  int i;

  for (i = 0; i < count; i++) {
    int bit;
    if (flags & PACK_FLAG_LSB) {
      bit = (*sptr >> (i%8)) & 1;
    } else {
      bit = (*sptr >> (7 - (i%8))) & 1;
    }
    *dptr++ = bit ? '1' : '0';
    if ((i%8) == 7) {
       sptr++;
    }
  }