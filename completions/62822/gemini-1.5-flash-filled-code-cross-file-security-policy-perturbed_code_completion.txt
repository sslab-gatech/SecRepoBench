const char *sptr = (const char *)src;
  int slen = slen;
  if (count == -1) {
    count = slen * 8;
  }
  else if (slen * 8 > count) {
    count = slen * 8;
  }

  mrb_value dst = mrb_str_new(mrbstate, NULL, (mrb_int)count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  const char *sptr0 = sptr;

  unsigned int byte = 0;
  for (int i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
      if (i % 8 == 0) {
        byte = *sptr++;
      }
      *dptr++ = (byte & 1) ? '1' : '0';
      byte >>= 1;
    }
    else {
      if (i % 8 == 0) {
        byte = *sptr++;
      }
      *dptr++ = (byte & 0x80) ? '1' : '0';
      byte <<= 1;
    }
  }