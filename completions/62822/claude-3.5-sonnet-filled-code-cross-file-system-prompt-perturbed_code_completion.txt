const unsigned char *sptr = (const unsigned char *)src;
const unsigned char *sptr0 = sptr;
mrb_value dst = mrb_str_new(mrbstate, NULL, count);
char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;

if (count == -1) {
  count = slen * 8;
}

for (int i = 0; i < count; i++) {
  int byte_index = i / 8;
  int bit_index = i % 8;
  unsigned char byte = sptr[byte_index];
  char bit;

  if (flags & PACK_FLAG_LSB) {
    bit = (byte >> bit_index) & 1;
  } else {
    bit = (byte >> (7 - bit_index)) & 1;
  }

  *dptr++ = bit ? '1' : '0';
}