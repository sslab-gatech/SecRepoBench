const unsigned char *sptr = (const unsigned char*)src;
  const unsigned char *sptr0 = sptr;
  
  // Check that we have data to unpack
  CHECK_UNPACK_LEN(mrbstate, slen, ary);
  
  // If count is not specified, use all available bits
  if (count == -1) {
    count = slen * 8;
  }
  
  // Create a new string to hold the bits
  mrb_value dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  
  // Convert bytes to bits
  while (count > 0 && slen > 0) {
    unsigned char byte = *sptr++;
    slen--;
    
    for (int i = 0; i < 8 && count > 0; i++) {
      int bit;
      
      if (flags & PACK_FLAG_LSB) {
        // LSB first
        bit = (byte >> i) & 1;
      } else {
        // MSB first
        bit = (byte >> (7 - i)) & 1;
      }
      
      *dptr++ = bit ? '1' : '0';
      count--;
    }
  }