const unsigned char *sptr = (const unsigned char *)src;
const unsigned char *sptr0 = sptr;
mrb_value dst = mrb_str_new(mrbstate, NULL, count);
char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;

if (count == -1) {
  count = slen * 8;
}

if (count > slen * 8) {
  count = slen * 8;
}

for (int i = 0; i < count; i++) {
  int byte = i / 8;
  int bit = i % 8;
  char c;

  if (flags & PACK_FLAG_LSB) {
    c = (sptr[byte] & (1 << bit)) ? '1' : '0';
  } else {
    c = (sptr[byte] & (1 << (7 - bit))) ? '1' : '0';
  }

  *dptr++ = c;
}