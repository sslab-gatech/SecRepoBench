CHECK_UNPACK_LEN(mrbstate, slen, ary);

mrb_value dst;
const char *sptr, *sptr0;
char *dptr, *dptr0;
int bit, byte, i, nbits;

sptr = (const char*)src;
sptr0 = sptr;

if (count == -1) {
  count = slen * 8;
}
nbits = count;
dst = mrb_str_new(mrbstate, NULL, nbits);
dptr = RSTRING_PTR(dst);
dptr0 = dptr;

for (i = 0; i < nbits; i++) {
  int byteidx, bitidx;
  if (flags & PACK_FLAG_LSB) {
    byteidx = i / 8;
    bitidx = i % 8;
    if (byteidx >= slen) {
      *dptr++ = '0';
      continue;
    }
    byte = sptr[byteidx];
    bit = (byte >> bitidx) & 1;
  }
  else {
    byteidx = i / 8;
    bitidx = 7 - (i % 8);
    if (byteidx >= slen) {
      *dptr++ = '0';
      continue;
    }
    byte = sptr[byteidx];
    bit = (byte >> bitidx) & 1;
  }
  *dptr++ = bit ? '1' : '0';
}
sptr += (nbits + 7) / 8;