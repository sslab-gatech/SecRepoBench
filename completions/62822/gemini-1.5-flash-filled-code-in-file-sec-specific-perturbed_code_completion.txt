mrb_value dst;
  const char *sptr, *sptr0;
  char *dptr, *dptr0;
  int slen = slen;
  int count = count;
  unsigned int byte = 0;

  if (count == -1) {
    count = slen * 8;
  }
  else if (slen * 8 > count) {
    slen = count / 8;
  }

  dst = mrb_str_new(mrbstate, NULL, count);
  dptr = RSTRING_PTR(dst);

  sptr0 = sptr = (const char*)src;
  dptr0 = dptr;
  for (int i = 0; i < slen; i++) {
    unsigned char c = *(unsigned char*)sptr++;
    for (int j = 0; j < 8; j++) {
      if (flags & PACK_FLAG_LSB) {
        *dptr++ = (c & 1) ? '1' : '0';
        c >>= 1;
      }
      else {
        *dptr++ = (c & 128) ? '1' : '0';
        c <<= 1;
      }
    }
  }