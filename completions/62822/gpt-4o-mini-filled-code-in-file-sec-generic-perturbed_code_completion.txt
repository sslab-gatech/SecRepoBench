int i;
  mrb_value dst = mrb_str_new(mrb, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  const unsigned char *sptr = (const unsigned char *)src;
  const unsigned char *sptr0 = sptr;

  for (i = 0; i < count; i++) {
    if (i < slen * 8) {
      int byte_index = i / 8;
      int bit_index = 7 - (i % 8);
      dptr[i] = (sptr[byte_index] & (1 << bit_index)) ? '1' : '0';
    } else {
      dptr[i] = '0'; // Fill remaining bits with '0' if count exceeds available bits
    }
  }

  dst = mrb_str_resize(mrb, dst, count);
  mrb_ary_push(mrbstate, ary, dst);
  return (int)(sptr - sptr0);