mrb_value dst;
  const unsigned char *sptr, *sptr0;
  char *dptr, *dptr0;
  int i;

  sptr = (const unsigned char*)src;
  sptr0 = sptr;

  if (count == -1)
    count = slen * 8;
  else if (count > slen * 8)
    count = slen * 8;

  dst = mrb_str_new(mrbstate, NULL, count);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  for (i = 0; i < count; i++) {
    int byte_num = i / 8;
    int bit_num = i % 8;
    unsigned char byte = sptr[byte_num];

    if (flags & PACK_FLAG_LSB) {
      if (byte & (1 << bit_num)) {
        *dptr++ = '1';
      } else {
        *dptr++ = '0';
      }
    } else {
      if (byte & (1 << (7 - bit_num))) {
        *dptr++ = '1';
      } else {
        *dptr++ = '0';
      }
    }
  }