const uint8_t *sptr = (const uint8_t *)src;
  const uint8_t *sptr0 = sptr;

  if (count < 0) {
    count = slen * 8;
  }
  /* Ensure we don't read beyond 'src' */
  {
    int maxbits = slen * 8;
    if (count > maxbits) {
      count = maxbits;
    }
  }

  mrb_value dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;

  for (int i = 0; i < count; i++) {
    int byte_index = i >> 3;
    int bit_index = i & 7;
    int bit;

    if (flags & PACK_FLAG_LSB) {
      bit = (sptr[byte_index] >> bit_index) & 1;
    } else {
      bit = (sptr[byte_index] >> (7 - bit_index)) & 1;
    }
    *dptr++ = bit ? '1' : '0';
  }

  sptr += (count + 7) >> 3;