const char *sptr = src;
  int slen = (int)RSTRING_LEN(src);

  if (count == -1) {
    count = slen;
  }
  else if (slen > count) {
    slen = count;
  }

  dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);

  for (int i = 0; i < slen; i++) {
    if (flags & PACK_FLAG_LSB) {
      *dptr++ = (sptr[i] & 1) ? '1' : '0';
    }
    else {
      *dptr++ = (sptr[i] & 0x80) ? '1' : '0';
    }
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - RSTRING_PTR(dst)));
  return slen;