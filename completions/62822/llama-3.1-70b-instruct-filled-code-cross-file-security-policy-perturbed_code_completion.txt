mrb_value dst;
const char *sptr, *sptr0;
char *dptr, *dptr0;
int i, j;

if (count == -1) {
  count = slen * 8;
}
else if (count > slen * 8) {
  count = slen * 8;
}

dst = mrb_str_new(mrbstate, NULL, count);
dptr = RSTRING_PTR(dst);
dptr0 = dptr;

sptr = (const char*)src;
sptr0 = sptr;

for (i = 0; i < count; i++) {
  if (flags & PACK_FLAG_LSB) {
    j = i & 7;
    if ((*sptr & (1 << j))!= 0) {
      *dptr++ = '1';
    }
    else {
      *dptr++ = '0';
    }
    if (j == 7) {
      sptr++;
    }
  }
  else {
    j = 7 - (i & 7);
    if ((*sptr & (1 << j))!= 0) {
      *dptr++ = '1';
    }
    else {
      *dptr++ = '0';
    }
    if (j == 0) {
      sptr++;
    }
  }
}