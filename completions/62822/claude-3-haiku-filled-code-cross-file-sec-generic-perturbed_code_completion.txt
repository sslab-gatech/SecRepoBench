char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;
unsigned int byte = 0;
for (int i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
        if (src[i/8] & (1 << (i%8))) {
            byte |= (1 << (7 - (i%8)));
        }
        if ((i+1) % 8 == 0) {
            *dptr++ = (char)(byte & 0xFF);
            byte = 0;
        }
    } else {
        if (src[i/8] & (1 << (7 - (i%8)))) {
            byte |= (1 << (i%8));
        }
        if ((i+1) % 8 == 0) {
            *dptr++ = (char)(byte & 0xFF);
            byte = 0;
        }
    }
}
if (count % 8 != 0) {
    *dptr++ = (char)(byte & 0xFF);
}
dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
mrb_ary_push(mrbstate, ary, dst);
return (int)(sptr - sptr0);