const char *sptr = (const char *)src;
  mrb_value dst;
  int copylen;

  if (count == -1) {
    count = slen * 8; // Default to the number of bits in the source
  } else if (count > slen * 8) {
    count = slen * 8; // Ensure we do not exceed the available bits
  }

  dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  const char *sptr0 = sptr;
  const char *sptr_end = sptr + slen;

  for (int i = 0; i < count; i++) {
    if (sptr < sptr_end) {
      *dptr++ = ((*sptr >> (7 - (i % 8))) & 1) ? '1' : '0';
      if (i % 8 == 7) {
        sptr++;
      }
    } else {
      *dptr++ = '0'; // Fill with '0' if we run out of bits
    }
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - RSTRING_PTR(dst)));