mrb_value dst;
  int dlen;
  unsigned int byte;
  int i, count_byte;
  const char *sptr, *sptr0;
  char *dptr, *dptr0;

  sptr0 = sptr = (const char*)src;

  if (count == -1) {
    count = slen * 8;
  }
  else if (count < slen * 8) {
    slen = (count + 7) / 8;
  }

  dlen = count;
  dst = mrb_str_new(mrbstate, NULL, dlen);
  dptr0 = dptr = RSTRING_PTR(dst);

  byte = 0;
  count_byte = 0;
  for (i = 0; i < slen; i++) {
    unsigned char c = (unsigned char)sptr[i];
    if (flags & PACK_FLAG_LSB) {
      for (int j = 0; j < 8; j++) {
        if (c & 1) {
          *dptr++ = '1';
        }
        else {
          *dptr++ = '0';
        }
        c >>= 1;
      }
    }
    else {
      for (int j = 7; j >= 0; j--) {
        if (c & (1 << j)) {
          *dptr++ = '1';
        }
        else {
          *dptr++ = '0';
        }
      }
    }
  }