int bit_index = 0;
  const unsigned char *sptr = (const unsigned char *)src;
  const unsigned char *end = sptr + slen;
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;

  if (count == -1) {
    count = slen * 8; // Default to the number of bits in the source
  }

  for (int byte_index = 0; byte_index < slen && count > 0; byte_index++) {
    unsigned char byte = sptr[byte_index];
    for (int bit = 7; bit >= 0 && count > 0; bit--, count--) {
      *dptr++ = (byte & (1 << bit)) ? '1' : '0';
    }
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));