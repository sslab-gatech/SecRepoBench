char *dst = mrb_str_new(mrbstate, NULL, count);
char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;

for (int i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
        *dptr++ = (char)((src[i / 8] >> (i % 8)) & 1) + '0';
    } else {
        *dptr++ = (char)(((src[i / 8] >> (7 - (i % 8))) & 1) + '0');
    }
}

dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
mrb_ary_push(mrbstate, ary, dst);
return (int)(sptr - sptr0);