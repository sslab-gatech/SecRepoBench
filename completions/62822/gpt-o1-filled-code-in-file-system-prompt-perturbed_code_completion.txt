CHECK_UNPACK_LEN(mrbstate, slen, ary);

if (count < 0) {
  count = slen * 8;
}

int total_bits = slen * 8;
if (count > total_bits) {
  count = total_bits;
}

mrb_value dst = mrb_str_new(mrbstate, NULL, count);
const unsigned char *sptr = (const unsigned char *)src;
const unsigned char *sptr0 = sptr;
char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;

for (int i = 0; i < count; i++) {
  int byte_index = i >> 3;
  int bit_index = i & 7;
  int bit_val;

  if (flags & PACK_FLAG_LSB) {
    bit_val = (sptr[byte_index] >> bit_index) & 1;
  }
  else {
    bit_val = (sptr[byte_index] >> (7 - bit_index)) & 1;
  }

  *dptr++ = bit_val ? '1' : '0';
}

sptr += (count + 7) >> 3;