mrb_value dst;
const char *sptr, *sptr0;
char *dptr, *dptr0;

if (count == -1) {
  count = slen * 8;
}

dst = mrb_str_new(mrbstate, NULL, (mrb_int)count);
dptr = RSTRING_PTR(dst);

sptr = (const char*)src;
sptr0 = sptr;
dptr0 = dptr;

for (int i = 0; i < slen * 8 && i < count; i++) {
  unsigned char bit = (*sptr >> (7 - (i % 8))) & 1;
  *dptr++ = '0' + bit;
  if ((i % 8) == 7) {
    sptr++;
  }
}

dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));