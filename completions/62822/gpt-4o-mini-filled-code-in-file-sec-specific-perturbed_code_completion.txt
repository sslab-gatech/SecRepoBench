int bit_count = count > 0 ? count : slen * 8;
  const unsigned char *sptr = (const unsigned char *)src;
  const unsigned char *sptr_end = sptr + (slen > 0 ? (slen + 7) / 8 : 0);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;

  for (int i = 0; i < bit_count; i++) {
    if (sptr < sptr_end) {
      int byte_index = i / 8;
      int bit_index = 7 - (i % 8);
      *dptr++ = (sptr[byte_index] & (1 << bit_index)) ? '1' : '0';
    } else {
      *dptr++ = '0'; // Fill with '0' if we exceed the source length
    }
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));