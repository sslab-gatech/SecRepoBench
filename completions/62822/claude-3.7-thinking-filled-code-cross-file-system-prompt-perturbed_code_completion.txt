CHECK_UNPACK_LEN(mrbstate, slen, ary);

mrb_value dst;
const unsigned char *sptr, *sptr0;
char *dptr, *dptr0;

sptr = (const unsigned char *)src;
sptr0 = sptr;

if (count == -1) {
  count = slen * 8;
}

dst = mrb_str_new(mrbstate, NULL, count);
dptr = RSTRING_PTR(dst);
dptr0 = dptr;

for (int byte_index = 0; byte_index < slen && (byte_index * 8) < count; byte_index++) {
  unsigned char byte = sptr[byte_index];
  
  for (int bit_index = 0; bit_index < 8 && ((byte_index * 8) + bit_index) < count; bit_index++) {
    if (flags & PACK_FLAG_LSB) {
      // For LSB, we read bits from right to left (least to most significant)
      *dptr++ = ((byte >> bit_index) & 1) ? '1' : '0';
    } else {
      // For MSB, we read bits from left to right (most to least significant)
      *dptr++ = ((byte >> (7 - bit_index)) & 1) ? '1' : '0';
    }
  }
}