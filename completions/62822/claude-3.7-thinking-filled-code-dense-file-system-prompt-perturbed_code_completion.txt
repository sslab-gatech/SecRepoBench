CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  const unsigned char *sptr, *sptr0;
  char *dptr, *dptr0;

  sptr = (const unsigned char*)src;
  if (count == -1)
    count = slen * 8;

  dst = mrb_str_new(mrbstate, NULL, count);
  dptr = RSTRING_PTR(dst);

  sptr0 = sptr;
  dptr0 = dptr;
  
  if (flags & PACK_FLAG_LSB) {
    while (count > 0 && slen > 0) {
      unsigned char c = *sptr;
      unsigned char mask = 1;
      for (int n = 0; n < 8 && count > 0; n++) {
        *dptr++ = (c & mask) ? '1' : '0';
        mask <<= 1;
        count--;
      }
      sptr++;
      slen--;
    }
  } else {
    while (count > 0 && slen > 0) {
      unsigned char c = *sptr;
      unsigned char mask = 128;
      for (int n = 0; n < 8 && count > 0; n++) {
        *dptr++ = (c & mask) ? '1' : '0';
        mask >>= 1;
        count--;
      }
      sptr++;
      slen--;
    }
  }