{
  const unsigned char *sptr = (const unsigned char*)src;
  const unsigned char *sptr0 = sptr;
  mrb_value dst;
  char *dptr, *dptr0;
  int total_bits, required_bytes;

  if (count == -1) {
    total_bits = slen * 8;
  }
  else {
    total_bits = count;
  }
  required_bytes = (total_bits + 7) / 8;
  if (slen < required_bytes) {
    /* Adjust total_bits if there are not enough bytes in src */
    total_bits = slen * 8;
    required_bytes = slen;
  }

  dst = mrb_str_new(mrbstate, NULL, total_bits);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  for (int i = 0; i < total_bits; i++) {
    int byte_index = i / 8;
    int bit_index = i % 8;
    unsigned char byte = sptr[byte_index];
    int bit;
    if (flags & PACK_FLAG_LSB) {
      bit = (byte >> bit_index) & 1;
    }
    else {
      bit = (byte >> (7 - bit_index)) & 1;
    }
    *dptr++ = bit ? '1' : '0';
  }
  sptr += required_bytes;
}