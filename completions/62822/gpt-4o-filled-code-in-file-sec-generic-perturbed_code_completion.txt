CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst = mrb_str_new(mrbstate, NULL, count);
  const unsigned char *sptr = (const unsigned char *)src;
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  int bits = 0;
  int bit_count = 0;

  if (count == -1) {
    count = slen * 8;
  }

  for (int i = 0; i < count; i++) {
    if (bit_count == 0) {
      if (slen-- <= 0) break;
      bits = *sptr++;
      bit_count = 8;
    }

    if (flags & PACK_FLAG_LSB) {
      *dptr++ = (bits & 1) ? '1' : '0';
      bits >>= 1;
    }
    else {
      *dptr++ = (bits & 0x80) ? '1' : '0';
      bits <<= 1;
    }
    bit_count--;
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
  mrb_ary_push(mrbstate, ary, dst);
  return (int)(sptr - (const unsigned char *)src);