char *dst = NULL;
char *dptr = NULL;
char *dptr0 = NULL;

for (int i = 0; i < count; i++) {
  if (flags & PACK_FLAG_LSB) {
    if ((*sptr) & 1)
      *dptr |= (1 << (i % 8));
    if ((i % 8) == 7) {
      *dptr++ = (char)(*dptr & 0xFF);
      *dptr = 0;
    }
    else {
      *dptr >>= 1;
    }
  }
  else {
    if ((*sptr) & 1)
      *dptr |= (1 << (7 - (i % 8)));
    if ((i % 8) == 0) {
      *dptr++ = (char)(*dptr & 0xFF);
      *dptr = 0;
    }
    else {
      *dptr <<= 1;
    }
  }
  sptr++;
}

if (count % 8 != 0) {
  if (flags & PACK_FLAG_LSB) {
    *dptr >>= 7 - (count % 8);
  }
  else {
    *dptr <<= 7 - (count % 8);
  }
  *dptr++ = (char)(*dptr & 0xFF);
}