if (count == -1) {
  count = slen * 8;
}
mrb_value dst = mrb_str_new(mrbstate, NULL, (mrb_int)count);
char *dptr = RSTRING_PTR(dst);
char *sptr = (char *)src;

for (int i = 0; i < count; ++i) {
  int byte_index = i / 8;
  int bit_index = 7 - (i % 8);
  unsigned char bit = ((unsigned char)sptr[byte_index] >> bit_index) & 1;
  dptr[i] = '0' + bit;
}

if (flags & PACK_FLAG_LSB) {
  for (int i = 0; i < count / 8; ++i) {
    for (int j = 0; j < 4; ++j) {
      char temp = dptr[i * 8 + j];
      dptr[i * 8 + j] = dptr[i * 8 + 7 - j];
      dptr[i * 8 + 7 - j] = temp;
    }
  }
}