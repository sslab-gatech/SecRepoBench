mrb_value dst = mrb_str_new_capa(mrbstate, count);
  const char *sptr = (const char*)src;
  const char *sptr0 = sptr;
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;

  if (count == -1) {
    count = slen * 8;
  }
  else if (slen * 8 < count) {
    count = slen * 8;
  }

  for (int i = 0; i < count; ++i) {
    int byte = (flags & PACK_FLAG_LSB) ? i / 8 : (count - 1 - i) / 8;
    int bit = (flags & PACK_FLAG_LSB) ? (1 << (i % 8)) : (1 << ((count - 1 - i) % 8));

    if (byte < slen)
    {
        *dptr++ = (sptr[byte] & bit) ? '1' : '0';
    } else {
        *dptr++ = '0'; // Pad with zeros if count is larger than available bits
    }
  }