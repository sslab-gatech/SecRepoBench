mrb_value dst;
  const unsigned char *sptr = (const unsigned char *)src;
  const unsigned char *sptr0 = sptr;
  int i;

  if (count == -1) {
    count = slen * 8; // Default to the number of bits in the source
  }

  dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);

  for (i = 0; i < count && slen > 0; i++) {
    if (flags & PACK_FLAG_LSB) {
      *dptr++ = (*sptr & 1) ? '1' : '0'; // Read LSB
      *sptr >>= 1;
    } else {
      *dptr++ = (*sptr & 0x80) ? '1' : '0'; // Read MSB
      *sptr <<= 1;
    }

    if (i % 8 == 7) { // Move to the next byte after 8 bits
      sptr++;
      slen--;
    }
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - RSTRING_PTR(dst)));
  mrb_ary_push(mrbstate, ary, dst);