mrb_value dst;
const char *sptr, *sptr0;
char *dptr, *dptr0;

if (count == -1) {
  count = slen * 8;
}

if (count < 0) return 0;

dst = mrb_str_new(mrbstate, NULL, count);
dptr = RSTRING_PTR(dst);
dptr0 = dptr;
sptr = (const char*)src;
sptr0 = sptr;

while (count > 0) {
  unsigned int byte;
  if (sptr - (const char*)src >= slen) break;
  byte = *sptr++;
  if (flags & PACK_FLAG_LSB) {
    for (int i = 0; i < 8 && count > 0; i++, count--) {
      *dptr++ = '0' + ((byte >> i) & 1);
    }
  }
  else {
    for (int i = 7; i >= 0 && count > 0; i--, count--) {
      *dptr++ = '0' + ((byte >> i) & 1);
    }
  }
}