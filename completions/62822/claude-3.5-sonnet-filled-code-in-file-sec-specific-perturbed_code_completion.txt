CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  int dstlen = (slen * 8 + 6) / 7;  // Calculate the maximum possible length
  const unsigned char *sptr = (const unsigned char*)src;
  const unsigned char *sptr0 = sptr;
  const unsigned char *send = sptr + slen;
  char *dptr, *dptr0;

  dst = mrb_str_new(mrbstate, NULL, dstlen);
  dptr = dptr0 = RSTRING_PTR(dst);

  while (sptr < send) {
    unsigned char c = *sptr++;
    for (int i = 0; i < 8; i++) {
      if (flags & PACK_FLAG_LSB) {
        *dptr++ = (c & 1) ? '1' : '0';
        c >>= 1;
      } else {
        *dptr++ = (c & 0x80) ? '1' : '0';
        c <<= 1;
      }
    }
    if (count > 0 && --count == 0) break;
  }

  dst = mrb_str_resize(mrbstate, dst, dptr - dptr0);
  mrb_ary_push(mrbstate, ary, dst);
  return (int)(sptr - sptr0);