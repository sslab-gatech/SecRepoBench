const char *sptr = (const char*)src;
const char *sptr0 = sptr;
mrb_value dst = mrb_str_new(mrbstate, NULL, count == -1 ? slen * 8 : count);
char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;

if (count == -1) {
  count = slen * 8;
}

for (int i = 0; i < count; i++) {
  int byte_index = i / 8;
  int bit_index = i % 8;
  
  if (byte_index >= slen) {
    break;
  }
  
  char bit;
  if (flags & PACK_FLAG_LSB) {
    bit = (sptr[byte_index] >> bit_index) & 1;
  } else {
    bit = (sptr[byte_index] >> (7 - bit_index)) & 1;
  }
  
  *dptr++ = bit ? '1' : '0';
}