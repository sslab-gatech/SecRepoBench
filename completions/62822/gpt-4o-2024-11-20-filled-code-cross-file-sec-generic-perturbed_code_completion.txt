CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  const char *sptr, *sptr0;
  char *dptr, *dptr0;
  unsigned int bit, byte;
  int i;

  sptr = (const char *)src;

  if (count == -1) {
    count = slen * 8;
  }

  dst = mrb_str_new(mrbstate, NULL, count);
  dptr = RSTRING_PTR(dst);

  sptr0 = sptr;
  dptr0 = dptr;

  for (i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
      bit = (sptr[i / 8] >> (i % 8)) & 1;
    } else {
      bit = (sptr[i / 8] >> (7 - (i % 8))) & 1;
    }
    *dptr++ = bit ? '1' : '0';
  }

  dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
  mrb_ary_push(mrbstate, ary, dst);
  return (int)(sptr - sptr0);