mrb_value dst;
  const char *sptr = (const char*)src;
  int bitlen = (count == -1) ? slen * 8 : count;
  dst = mrb_str_new(mrbstate, NULL, bitlen);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  int bitpos = 0;

  for (int i = 0; i < bitlen; i++) {
    int bytepos = bitpos / 8;
    int bitoffset = bitpos % 8;
    if (flags & PACK_FLAG_LSB) {
      *dptr++ = ((sptr[bytepos] >> bitoffset) & 1) ? '1' : '0';
    }
    else {
      *dptr++ = ((sptr[bytepos] >> (7 - bitoffset)) & 1) ? '1' : '0';
    }
    bitpos++;
  }