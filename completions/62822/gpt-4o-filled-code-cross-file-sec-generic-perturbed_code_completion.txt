const unsigned char *sptr = (const unsigned char *)src;
  const unsigned char *sptr0 = sptr;
  mrb_value dst = mrb_str_new(mrbstate, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;
  unsigned int byte = 0;
  int bit_count = 0;

  if (count == -1) {
    count = slen * 8;
  }

  for (int i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
      byte |= ((*sptr >> (i % 8)) & 1) << (bit_count % 8);
    } else {
      byte |= ((*sptr >> (7 - (i % 8))) & 1) << (7 - (bit_count % 8));
    }
    bit_count++;

    if (bit_count % 8 == 0) {
      *dptr++ = byte;
      byte = 0;
    }

    if (i % 8 == 7) {
      sptr++;
    }
  }

  if (bit_count % 8 != 0) {
    *dptr++ = byte;
  }