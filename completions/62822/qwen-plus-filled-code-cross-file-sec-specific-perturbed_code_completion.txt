const unsigned char *sptr = (const unsigned char *)src;
const unsigned char *sptr0 = sptr;
mrb_value dst = mrb_str_new(mrbstate, NULL, count);
char *dptr = RSTRING_PTR(dst);
char *dptr0 = dptr;

if (count == -1) {
  count = slen * 8;
}

while (slen > 0 && count > 0) {
  unsigned char byte = *sptr;
  int bit;

  for (bit = 7; bit >= 0 && count > 0; bit--, count--) {
    if (flags & PACK_FLAG_LSB) {
      *dptr++ = ((byte >> bit) & 1) ? '1' : '0';
    } else {
      *dptr++ = ((byte >> (7 - bit)) & 1) ? '1' : '0';
    }
  }
  sptr++;
  slen--;
}