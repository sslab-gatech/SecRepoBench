CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  const char *sptr, *sptr0;
  char *dptr, *dptr0;

  if (count == -1) {
    count = slen * 8;
  }
  else if (slen * 8 < count) {
    mrb_raise(mrbstate, E_ARGUMENT_ERROR, "too short string");
  }

  dst = mrb_str_new(mrbstate, NULL, count);
  dptr = dptr0 = RSTRING_PTR(dst);
  sptr = sptr0 = (const char*)src;

  unsigned int byte = 0;
  for (int i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
      byte = *sptr++;
      for (int j=0; j<8 && i<count; j++, i++) {
        *dptr++ = (char)(((byte >> j) & 1) ? '1' : '0');
      }
      i--; // correct for loop increment
      slen--;
    }
    else {
      byte = *sptr++;

      for (int j=7; j>=0 && i<count; j--, i++) {
        *dptr++ = (char)(((byte >> j) & 1) ? '1' : '0');
      }
      i--; // correct for loop increment
      slen--;
    }
  }