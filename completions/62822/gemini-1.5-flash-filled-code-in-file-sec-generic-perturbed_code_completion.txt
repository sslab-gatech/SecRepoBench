mrb_value dst;
  int dlen;
  unsigned int byte = 0;
  int i, count_byte = 0;
  const char *sptr, *sptr0;
  char *dptr, *dptr0;

  sptr0 = sptr = (const char*)src;

  if (count == -1)
    count = slen * 8;

  dlen = (count + 7) / 8;
  dst = mrb_str_new(mrbstate, NULL, dlen);
  dptr0 = dptr = RSTRING_PTR(dst);

  for (i = 0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
      if (sptr < src + slen) {
        byte |= (*sptr & 1) << (i & 7);
      }
      if ((i + 1) % 8 == 0) {
        *dptr++ = (char)(byte & 0xff);
        byte = 0;
      }
    }
    else {
      if (sptr < src + slen) {
        byte |= (*sptr & 1) << (7 - (i & 7));
      }
      if ((i + 1) % 8 == 0) {
        *dptr++ = (char)(byte & 0xff);
        byte = 0;
      }
    }
    if (i % 8 == 7) {
      sptr++;
    }
  }