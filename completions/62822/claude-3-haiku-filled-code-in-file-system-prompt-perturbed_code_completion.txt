static int
unpack_bstr(mrb_state *mrb, const void *src, int slen, mrb_value ary, int count, unsigned int flags) {
  mrb_value dst = mrb_str_new(mrb, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  const char *sptr = (const char*)src;
  int dlen = 0;

  unsigned int byte = 0;
  for (int i=0; i < count; i++) {
    if (flags & PACK_FLAG_LSB) {
      byte |= (*sptr & 1) << (i & 7);
      if ((i & 7) == 7) {
        *dptr++ = (char)(byte & 0xff);
        byte = 0;
      }
    }
    else {
      byte = (byte << 1) | (*sptr & 1);
      if ((i & 7) == 7) {
        *dptr++ = (char)(byte & 0xff);
        byte = 0;
      }
    }
    sptr++;
  }
  if (count & 7) {
    if (flags & PACK_FLAG_LSB) {
      byte >>= 7 - (count & 7);
    }
    else {
      byte <<= 7 - (count & 7);
    }
    *dptr++ = (char)(byte & 0xff);
  }

  dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - RSTRING_PTR(dst)));
  mrb_ary_push(mrb, ary, dst);
  return slen;
}