mrb_value dst;
  const unsigned char *sptr = (const unsigned char *)src;
  int bit_count = (count == -1) ? slen * 8 : count;
  dst = mrb_str_new(mrbstate, NULL, bit_count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;

  for (int i = 0; i < bit_count; i++) {
    int byte_index = i / 8;
    int bit_index = i % 8;
    if (byte_index >= slen) break;

    unsigned char byte = sptr[byte_index];
    if (flags & PACK_FLAG_LSB) {
      *dptr++ = (byte & (1 << bit_index)) ? '1' : '0';
    } else {
      *dptr++ = (byte & (1 << (7 - bit_index))) ? '1' : '0';
    }
  }