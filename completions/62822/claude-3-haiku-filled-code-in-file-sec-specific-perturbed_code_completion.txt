static int
unpack_bstr(mrb_state *mrb, const void *src, int slen, mrb_value ary, int count, unsigned int flags)
{
  mrb_value dst = mrb_str_new(mrb, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  const char *sptr = (const char*)src;
  int i;

  for (i = 0; i < count && slen > 0; i++) {
    unsigned char c = 0;
    int j;
    for (j = 0; j < 8 && slen > 0; j++) {
      if (flags & PACK_FLAG_LSB) {
        c |= (*sptr & 1) << j;
      }
      else {
        c |= (*sptr & 1) << (7 - j);
      }
      sptr++;
      slen--;
    }
    dptr[i] = c;
  }

  dst = mrb_str_resize(mrb, dst, i);
  mrb_ary_push(mrb, ary, dst);
  return (int)(sptr - (const char*)src);
}