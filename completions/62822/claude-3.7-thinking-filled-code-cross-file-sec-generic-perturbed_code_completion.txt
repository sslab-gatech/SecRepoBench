CHECK_UNPACK_LEN(mrbstate, slen, ary);

mrb_value dst;
const unsigned char *sptr, *sptr0;
char *dptr, *dptr0;

sptr = (const unsigned char*)src;
sptr0 = sptr;

if (count == -1) {
  count = slen * 8;
}
else if (count > slen * 8) {
  count = slen * 8;
}

dst = mrb_str_new(mrbstate, NULL, count);
dptr = RSTRING_PTR(dst);
dptr0 = dptr;

for (int i = 0; i < count; i++) {
  int byte_index = i / 8;
  int bit_index = i % 8;
  int bit;
  
  if (flags & PACK_FLAG_LSB) {
    bit = (sptr[byte_index] >> bit_index) & 1;
  } else {
    bit = (sptr[byte_index] >> (7 - bit_index)) & 1;
  }
  
  *dptr++ = bit ? '1' : '0';
}