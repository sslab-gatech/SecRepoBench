static int
unpack_bstr(mrb_state *mrb, const void *src, int slen, mrb_value ary, int count, unsigned int flags)
{
  CHECK_UNPACK_LEN(mrb, slen, ary);

  mrb_value dst;
  const unsigned char *sptr, *sptr0;
  char *dptr, *dptr0;
  unsigned char byte;
  int bits;

  sptr = (const unsigned char *)src;
  sptr0 = sptr;

  if (count == -1)
    count = slen * 8;

  dst = mrb_str_new(mrb, NULL, count);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  while (slen > 0 && count > 0) {
    byte = *sptr++;
    slen--;

    for (int i = 0; i < 8 && count > 0; i++, count--) {
      if (flags & PACK_FLAG_LSB) {
        bits = (byte >> i) & 1;
      } else {
        bits = (byte >> (7 - i)) & 1;
      }
      *dptr++ = bits ? '1' : '0';
    }
  }

  dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - dptr0));
  mrb_ary_push(mrb, ary, dst);
  return (int)(sptr - sptr0);
}