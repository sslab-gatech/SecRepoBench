CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  const unsigned char *sptr, *sptr0;
  char *dptr, *dptr0;
  int i;
  unsigned char byte;

  sptr = (const unsigned char*)src;
  sptr0 = sptr;

  if (count == -1)
    count = slen * 8;
  dst = mrb_str_new(mrbstate, NULL, count);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  while (slen > 0 && count > 0) {
    byte = *sptr++;
    slen--;
    for (i = 7; i >= 0 && count > 0; i--, count--) {
      if (flags & PACK_FLAG_LSB) {
        *dptr++ = ((byte & (1 << i)) ? '1' : '0');
      } else {
        *dptr++ = ((byte & (1 << (7 - i))) ? '1' : '0');
      }
    }
  }