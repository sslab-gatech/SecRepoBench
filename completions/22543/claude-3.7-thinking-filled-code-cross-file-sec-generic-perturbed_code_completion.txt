size_t max_value;
if (jp2_image->comps[i].prec == 0)
  max_value=1;  /* avoid division by zero */
else if (jp2_image->comps[i].prec >= sizeof(size_t)*8)
  max_value=SIZE_MAX;
else
  max_value=((size_t) 1UL << jp2_image->comps[i].prec)-1;
scale=(double) QuantumRange/max_value;
size_t index=(size_t) (y/jp2_image->comps[i].dy)*(jp2_image->comps[i].w/jp2_image->comps[i].dx)+
  (size_t) (columnindex/jp2_image->comps[i].dx);
int value=jp2_image->comps[i].data[index];
if (jp2_image->comps[i].sgnd && jp2_image->comps[i].prec <= ((sizeof(int)*8)-1))
  value+=((int) 1 << (jp2_image->comps[i].prec-1));
pixel=(double) value*scale;