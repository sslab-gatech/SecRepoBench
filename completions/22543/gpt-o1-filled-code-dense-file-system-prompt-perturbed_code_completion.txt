scale = (double) QuantumRange / (double) (((size_t)1UL << jp2_image->comps[i].prec) - 1);
{
  /* map current row and column to the component data index */
  const ssize_t index = (y / jp2_image->comps[i].dy) * (ssize_t) jp2_image->comps[i].w +
                        (columnindex / jp2_image->comps[i].dx);
  int component_value = jp2_image->comps[i].data[index];
  /* adjust if signed */
  if (jp2_image->comps[i].sgnd != 0)
    component_value += (1 << (jp2_image->comps[i].prec - 1));
  /* clamp to valid range */
  if (component_value < 0)
    component_value = 0;
  else if (component_value > (int)((1UL << jp2_image->comps[i].prec) - 1))
    component_value = (int)((1UL << jp2_image->comps[i].prec) - 1);
  /* scale to Quantum range */
  pixel = (double) component_value * scale;
}