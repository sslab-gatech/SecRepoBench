_type_and_change_protocol(ndpi_struct, flow);
}

static void process_response(struct ndpi_detection_module_struct *ndpi_struct,
			     struct ndpi_flow_struct *flow) {
  struct ndpi_packet_struct *packet = &ndpi_struct->packet;

  ndpi_parse_packet_line_info(ndpi_struct, flow);

  parse_response_code(ndpi_struct, flow);

  if(packet->payload_packet_len >= 12) {
    /* Set server HTTP response code */
    flow->http.response_status_code = ((packet->payload[9] - '0') * 100) +
                                      ((packet->payload[10] - '0') * 10) +
                                      (packet->payload[11] - '0');
    NDPI_LOG_DBG2(ndpi_struct, "Response code %d\n", flow->http.response_status_code);

    /* https://en.wikipedia.org/wiki/List_of_HTTP_status_codes */
    if((flow->http.response_status_code < 100) || (flow->http.response_status_code > 509))
      flow->http.response_status_code = 0; /* Out of range */

    if(flow->http.response_status_code >= 400) {
      char ec[48];
      snprintf(ec, sizeof(ec), "HTTP Error Code %u", flow->http.response_status_code);
      ndpi_set_risk(ndpi_struct, flow, NDPI_ERROR_CODE_DETECTED, ec);
    }
  }

  check_content_type_and_change_protocol(ndpi_struct, flow);
}

static void ndpi_search_http_tcp(struct ndpi_detection_module_struct *ndpi_struct,
				 struct ndpi_flow_struct *flow) {
  struct ndpi_packet_struct *packet = &ndpi_struct->packet;

  if(packet->payload_packet_len == 0)
    return;

  if(is_request(ndpi_struct, flow)) {
    process_request(ndpi_struct, flow, http_request_url_offset(ndpi_struct, flow));
  } else if(is_response(ndpi_struct, flow)) {
    process_response(ndpi_struct, flow);
  }
}

/* ************************************************************* */

void ndpi_init_http_dissection(struct ndpi_detection_module_struct *ndpi_struct,
			       struct ndpi_flow_struct *flow) {
  flow->detected_protocol_stack[0] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[1] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[2] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[3] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[4] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[5] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[6] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[7] = NDPI_PROTOCOL_UNKNOWN;

  flow->http.request_version = 0;
  flow->http.response_status_code = 0;
  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;

  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_line.ptr = NULL;
  flow->http.content_line.len = 0;
  flow->http.http_origin.ptr = NULL;
  flow->http.http_origin.len = 0;
  flow->http.authorization_line.ptr = NULL;
  flow->http.authorization_line.len = 0;
  flow->http.referer_line.ptr = NULL;
  flow->http.referer_line.len = 0;
  flow->http.server_line.ptr = NULL;
  flow->http.server_line.len = 0;
  flow->http.host_line.ptr = NULL;
  flow->http.host_line.len = 0;
  flow->http.user_agent_line.ptr = NULL;
  flow->http.user_agent_line.len = 0;
  flow->http.forwarded_line.ptr = NULL;
  flow->http.forwarded_line.len = 0;

  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;

  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_line.ptr = NULL;
  flow->http.content_line.len = 0;
  flow->http.http_origin.ptr = NULL;
  flow->http.http_origin.len = 0;
  flow->http.authorization_line.ptr = NULL;
  flow->http.authorization_line.len = 0;
  flow->http.referer_line.ptr = NULL;
  flow->http.referer_line.len = 0;
  flow->http.server_line.ptr = NULL;
  flow->http.server_line.len = 0;
  flow->http.host_line.ptr = NULL;
  flow->http.host_line.len = 0;
  flow->http.user_agent_line.ptr = NULL;
  flow->http.user_agent_line.len = 0;
  flow->http.forwarded_line.ptr = NULL;
  flow->http.forwarded_line.len = 0;

  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;

  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_line.ptr = NULL;
  flow->http.content_line.len = 0;
  flow->http.http_origin.ptr = NULL;
  flow->http.http_origin.len = 0;
  flow->http.authorization_line.ptr = NULL;
  flow->http.authorization_line.len = 0;
  flow->http.referer_line.ptr = NULL;
  flow->http.referer_line.len = 0;
  flow->http.server_line.ptr = NULL;
  flow->http.server_line.len = 0;
  flow->http.host_line.ptr = NULL;
  flow->http.host_line.len = 0;
  flow->http.user_agent_line.ptr = NULL;
  flow->http.user_agent_line.len = 0;
  flow->http.forwarded_line.ptr = NULL;
  flow->http.forwarded_line.len = 0;

  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;

  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_line.ptr = NULL;
  flow->http.content_line.len = 0;
  flow->http.http_origin.ptr = NULL;
  flow->http.http_origin.len = 0;
  flow->http.authorization_line.ptr = NULL;
  flow->http.authorization_line.len = 0;
  flow->http.referer_line.ptr = NULL;
  flow->http.referer_line.len = 0;
  flow->http.server_line.ptr = NULL;
  flow->http.server_line.len = 0;
  flow->http.host_line.ptr = NULL;
  flow->http.host_line.len = 0;
  flow->http.user_agent_line.ptr = NULL;
  flow->http.user_agent_line.len = 0;
  flow->http.forwarded_line.ptr = NULL;
  flow->http.forwarded_line.len = 0;

  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;

  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_line.ptr = NULL;
  flow->http.content_line.len = 0;
  flow->http.http_origin.ptr = NULL;
  flow->http.http_origin.len = 0;
  flow->http.authorization_line.ptr = NULL;
  flow->http.authorization_line.len = 0;
  flow->http.referer_line.ptr = NULL;
  flow->http.referer_line.len = 0;
  flow->http.server_line.ptr = NULL;
  flow->http.server_line.len = 0;
  flow->http.host_line.ptr = NULL;
  flow->http.host_line.len = 0;
  flow->http.user_agent_line.ptr = NULL;
  flow->http.user_agent_line.len = 0;
  flow->http.forwarded_line.ptr = NULL;
  flow->http.forwarded_line.len = 0;

  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;

  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_line.ptr = NULL;
  flow->http.content_line.len = 0;
  flow->http.http_origin.ptr = NULL;
  flow->http.http_origin.len = 0;
  flow->http.authorization_line.ptr = NULL;
  flow->http.authorization_line.len = 0;
  flow->http.referer_line.ptr = NULL;
  flow->http.referer_line.len = 0;
  flow->http.server_line.ptr = NULL;
  flow->http.server_line.len = 0;
  flow->http