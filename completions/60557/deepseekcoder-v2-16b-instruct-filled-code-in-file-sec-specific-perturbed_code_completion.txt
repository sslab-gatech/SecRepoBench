const char *)packet->payload, "CONNECT ", 8) == 0) {
      master_protocol = NDPI_PROTOCOL_HTTP_CONNECT;
    }
  }

  ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_UNKNOWN, master_protocol, NDPI_CONFIDENCE_DPI);
}

static void process_response(struct ndpi_detection_module_struct *ndpi_struct,
			     struct ndpi_flow_struct *flow) {
  struct ndpi_packet_struct *packet = &ndpi_struct->packet;
  u_int16_t master_protocol;

  ndpi_parse_packet_line_info(ndpi_struct, flow);

  master_protocol = NDPI_PROTOCOL_HTTP;

  if(packet->parsed_lines == 0 ||
     !(packet->line[0].len >= 12 &&
       strncasecmp((const char *)packet->line[0].ptr, "HTTP/1.1 ", 8) == 0)) {
    NDPI_LOG_DBG2(ndpi_struct, "Response with an incomplete or invalid first line\n");
  } else {
    /* First line is complete (example: "HTTP/1.1 200 OK"): extract status code */
    parse_response_code(ndpi_struct, flow);

    if(packet->line[0].len >= 12 &&
       strncasecmp((const char *)packet->line[0].ptr, "HTTP/1.1 ", 8) == 0) {
      flow->http.response_version = 1;
    }
  }

  ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_UNKNOWN, master_protocol, NDPI_CONFIDENCE_DPI);
}

/* ************************************************************* */

static void ndpi_search_http_tcp(struct ndpi_detection_module_struct *ndpi_struct,
				 struct ndpi_flow_struct *flow) {
  struct ndpi_packet_struct *packet = &ndpi_struct->packet;

  if(packet->payload_packet_len == 0)
    return;

  if(is_request(ndpi_struct, flow)) {
    process_request(ndpi_struct, flow, http_request_url_offset(ndpi_struct, flow));
  } else if(is_response(ndpi_struct, flow)) {
    process_response(ndpi_struct, flow);
  }
}

/* ************************************************************* */

static void ndpi_init_http_flow(struct ndpi_detection_module_struct *ndpi_struct,
				struct ndpi_flow_struct *flow) {
  flow->guessed_protocol_id = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[0] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[1] = NDPI_PROTOCOL_UNKNOWN;
  flow->detected_protocol_stack[2] = NDPI_PROTOCOL_UNKNOWN;
  flow->http.request_version = 0;
  flow->http.response_version = 0;
  flow->http.request_content_type = NULL;
  flow->http.content_type = NULL;
  flow->http.user_agent = NULL;
  flow->http.server = NULL;
  flow->http.nat_ip = NULL;
  flow->http.url = NULL;
  flow->http.detected_os = NULL;
  flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;
  flow->http.response_status_code = 0;
  flow->http.request_content_type = NULL;
  flow->http.content_disposition_line.ptr = NULL;
  flow->http.content_disposition_line.len = 0;
  flow->http.content_disposition_line.len = 0;
  flow->http.request_content_disposition_filename = NULL;
  flow->http.response_content_disposition_filename = NULL;
  flow->http.request_content_disposition_filename_len = 0;
  flow->http.response_content_disposition_filename_len = 0;
  flow->http.request_content_length = 0;
  flow->http.response_content_length = 0;
  flow->http.request_transfer_encoding = NULL;
  flow->http.response_transfer_encoding = NULL;
  flow->http.request_transfer_encoding_len = 0;
  flow->http.response_transfer_encoding_len = 0;
  flow->http.request_connection = NULL;
  flow->http.response_connection = NULL;
  flow->http.request_connection_len = 0;
  flow->http.response_connection_len = 0;
  flow->http.request_host = NULL;
  flow->http.response_host = NULL;
  flow->http.request_host_len = 0;
  flow->http.response_host_len = 0;
  flow->http.request_referer = NULL;
  flow->http.response_referer = NULL;
  flow->http.request_referer_len = 0;
  flow->http.response_referer_len = 0;
  flow->http.request_authorization = NULL;
  flow->http.response_authorization = NULL;
  flow->http.request_authorization_len = 0;
  flow->http.response_authorization_len = 0;
  flow->http.request_cookie = NULL;
  flow->http.response_cookie = NULL;
  flow->http.request_cookie_len = 0;
  flow->http.response_cookie_len = 0;
  flow->http.request_set_cookie = NULL;
  flow->http.response_set_cookie = NULL;
  flow->http.request_set_cookie_len = 0;
  flow->http.response_set_cookie_len = 0;
  flow->http.request_pragma = NULL;
  flow->http.response_pragma = NULL;
  flow->http.request_pragma_len = 0;
  flow->http.response_pragma_len = 0;
  flow->http.request_expires = NULL;
  flow->http.response_expires = NULL;
  flow->http.request_expires_len = 0;
  flow->http.response_expires_len = 0;
  flow->http.request_cache_control = NULL;
  flow->http.response_cache_control = NULL;
  flow->http.request_cache_control_len = 0;
  flow->http.response_cache_control_len = 0;
  flow->http.request_accept = NULL;
  flow->http.response_accept = NULL;
  flow->http.request_accept_len = 0;
  flow->http.response_accept_len = 0;
  flow->http.request_accept_encoding = NULL;
  flow->http.response_accept_encoding = NULL;
  flow->http.request_accept_encoding_len = 0;
  flow->http.response_accept_encoding_len = 0;
  flow->http.request_accept_language = NULL;
  flow->http.response_accept_language = NULL;
  flow->http.request_accept_language_len = 0;
  flow->http.response_accept_language_len = 0;
  flow->http.request_if_modified_since = NULL;
  flow->http.response_if_modified_since = NULL;
  flow->http.request_if_modified_since_len = 0;
  flow->http.response_if_modified_since_len = 0;
  flow->http.request_if_none_match = NULL;
  flow->http.response_if_none_match = NULL;
  flow->http.request_if_none_match_len = 0;
  flow->http.response_if_none_match_len = 0;
  flow->http.request_if_match = NULL;
  flow->http.response_if_match = NULL;
  flow->http.request_if_match_len = 0;
  flow->http.response_if_match_len = 0;
  flow->http.request_if_range = NULL;
  flow->http.response_if_range = NULL;
  flow->http.request_if_range_len = 0;
  flow->http.response_if_range_len = 0;
  flow->http.request_range = NULL;
  flow->http.response_range = NULL;
  flow->http.request_range_len = 0;
  flow->http.response_range_len = 0;
  flow->http.request_content_length = 0;
  flow->http.response_content_length = 0;
  flow->http.request_transfer_encoding = NULL;
  flow->http.response_transfer_encoding = NULL;
  flow->http.request_transfer_encoding_len = 0;
  flow->http.response_transfer_encoding_len = 0;
  flow->http.request_connection = NULL;
  flow->http.response_connection = NULL;
  flow->http.request_connection_len = 0;
  flow->http.response_connection_len = 0;
  flow->http.request_host = NULL;
  flow->http.response_host = NULL;
  flow->http.request_host_len = 0;
  flow->http.response_host_len = 0;
  flow->http.request_referer = NULL;
  flow->http.response_referer = NULL;
  flow->http.request_referer_len = 0;
  flow->http.response_referer_len = 0;
  flow->http.request_authorization = NULL;
  flow->http.response_authorization = NULL;
  flow->http.request_authorization_len = 0;
  flow->http.response_authorization_len = 0;
  flow->http.request_cookie = NULL;
  flow->http.response_cookie = NULL;
  flow->http.request_cookie_len = 0;
  flow->http.response_cookie_len = 0;
  flow->http.request_set_cookie = NULL;
  flow->http.response_set_cookie = NULL;
  flow->http.request_set_cookie_len = 0;
  flow->http.response_set_cookie_len = 0;
  flow->http.request_pragma = NULL;
  flow->http.response_pragma = NULL;
  flow->http.request_pragma_len = 0;
  flow->http.response_pragma_len = 0;
  flow->http.request_expires = NULL;
  flow->http.response_expires = NULL;
  flow->http.request_expires_len = 0;
  flow->http.response_expires_len = 0;
  flow->http.request_cache_control = NULL;
  flow->http.response_cache_control = NULL;
  flow->http.request_cache_control_len = 0;
  flow->http.response_cache_control_len = 0;
  flow->http.request_accept = NULL;
  flow->http.response_accept = NULL;
  flow->http.request_accept_len = 0;
  flow->http.response_accept_len = 0;
  flow->http.request_accept_encoding = NULL;
  flow->http.response_accept_encoding = NULL;
  flow->http.request_accept_encoding_len = 0;
  flow->http.response_accept_encoding_len = 0;
  flow->http.request_accept_language = NULL;
  flow->http.response_accept_language = NULL;
  flow->http.request_accept_language_len = 0;
  flow->http.response_accept_language_len = 0;
  flow->http.request_if_modified_since = NULL;
  flow->http.response_if_modified_since = NULL;
  flow->http.request_if_modified_since_len = 0;
  flow->http.response_if_modified_since_len = 0;
  flow->http.request_if_none_match = NULL;
  flow->http.response_if_none_match = NULL;
  flow->http.request_if_none_match_len = 0;
  flow->http.response_if_none_match_len = 0;
  flow->http.request_if_match = NULL;
  flow->http.response_if_match = NULL;
  flow->http.request_if_match_len = 0;
  flow->http.response_if_match_len =