pctxt = decode->ctxt;

    if (nCompressed < 20)
    {
        if (nRawSize != 0)
        {
            return EXR_ERR_CORRUPT_CHUNK;
        }
        return EXR_ERR_SUCCESS;
    }

    im    = readUInt (compressed);
    iM    = readUInt (compressed + 4);
    nBytes = readUInt (compressed + 8);
    nBits = readUInt (compressed + 12);

    if (im < 0 || im >= HUF_ENCSIZE || iM < 0 || iM >= HUF_ENCSIZE)
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }

    ptr = compressed + 20;

    if (ptr + ((nBits + 7) / 8) > compressed + nCompressed)
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }

    if (pctxt && pctxt->fast_huffman && (nBits > 128))
    {
        rv = internal_fast_huf_decode (
            decode, compressed + 20, nCompressed - 20, raw, nRawSize, im, iM, nBits);
    }
    else
    {
        AutoArray<uint64_t, HUF_ENCSIZE> freq;
        AutoArray<HufDec, HUF_DECSIZE>   hdec;

        hufClearDecTable (hdec);

        rv = internal_huf_unpack_enc_table (
            &ptr, nCompressed - (ptr - compressed), im, iM, freq);
        if (rv != EXR_ERR_SUCCESS) return rv;

        if (nBits > 8 * (nCompressed - (ptr - compressed)))
        {
            return EXR_ERR_CORRUPT_CHUNK;
        }

        hufBuildDecTable (freq, im, iM, hdec);
        hufDecode (freq, hdec, ptr, nBits, iM, nRawSize, raw);

        /*hufFreeDecTable (hdec);*/ /*hdec is an AutoArray, so no need to free*/
    }