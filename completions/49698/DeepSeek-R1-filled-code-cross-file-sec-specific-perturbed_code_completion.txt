if (nCompressed < 20)
        return EXR_ERR_INVALID_ARGUMENT;

    im = EXR_READ_U32 (compressed);
    iM = EXR_READ_U32 (compressed + 4);
    uint32_t tableLength = EXR_READ_U32 (compressed + 8);
    nBits = EXR_READ_U32 (compressed + 12);

    if (im >= HUF_ENCSIZE || iM >= HUF_ENCSIZE)
        return EXR_ERR_INVALID_ARGUMENT;

    if (sparebytes != internal_exr_huf_decompress_spare_bytes ())
        return EXR_ERR_INVALID_ARGUMENT;

    nBytes = ((uint64_t) nBits + 7) / 8;
    if (20 + tableLength + nBytes > nCompressed)
        return EXR_ERR_INVALID_ARGUMENT;

    ptr = compressed + 20;
    uint64_t* freq = (uint64_t*) spare;
    HufDec* hdecod = (HufDec*) ((char*) spare + HUF_ENCSIZE * sizeof(uint64_t));

    hufClearDecTable (hdecod);

    rv = hufUnpackEncTable (&ptr, nCompressed - 20, im, iM, freq);
    if (rv != EXR_ERR_SUCCESS) return rv;

    rv = hufBuildDecTable (freq, im, iM, hdecod);
    if (rv != EXR_ERR_SUCCESS) return rv;

    if (nBits > 8 * (nCompressed - (ptr - compressed)))
        return EXR_ERR_INVALID_ARGUMENT;

    rv = hufDecode (freq, hdecod, ptr, nBits, iM, (uint32_t)(nRawSize / 2), raw);