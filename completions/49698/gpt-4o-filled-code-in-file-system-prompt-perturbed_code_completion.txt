if (decode) pctxt = decode->context;

    if (nCompressed < 20)
    {
        if (pctxt)
            pctxt->print_error (
                pctxt,
                EXR_ERR_CORRUPT_CHUNK,
                "Huffman decode error (Compressed data too small)");
        return EXR_ERR_CORRUPT_CHUNK;
    }

    im = readUInt (compressed);
    iM = readUInt (compressed + 4);

    if (im > iM || iM > HUF_ENCSIZE)
    {
        if (pctxt)
            pctxt->print_error (
                pctxt,
                EXR_ERR_CORRUPT_CHUNK,
                "Huffman decode error (Invalid min/max code index)");
        return EXR_ERR_CORRUPT_CHUNK;
    }

    nBytes = readUInt (compressed + 8);
    nBits  = readUInt (compressed + 12);

    if (nBytes + 20 > nCompressed)
    {
        if (pctxt)
            pctxt->print_error (
                pctxt,
                EXR_ERR_CORRUPT_CHUNK,
                "Huffman decode error (Compressed data too small for table)");
        return EXR_ERR_CORRUPT_CHUNK;
    }

    ptr = compressed + 20;

    if (fasthuf_decode_enabled () && nRawSize > 1024)
    {
        FastHufDecoder* fhd = (FastHufDecoder*) spare;
        if (sparebytes < sizeof (FastHufDecoder))
            return EXR_ERR_INVALID_ARGUMENT;

        rv = fasthuf_initialize (pctxt, fhd, &ptr, (int) nBytes, im, iM, iM);
        if (rv != EXR_ERR_SUCCESS) return rv;

        rv = fasthuf_decode (
            pctxt, fhd, ptr, (int) nBits, raw, (int) nRawSize);
    }
    else
    {
        uint64_t* freq;
        HufDec*   hdec;

        if (sparebytes < internal_exr_huf_decompress_spare_bytes ())
            return EXR_ERR_INVALID_ARGUMENT;

        freq = (uint64_t*) spare;
        hdec = (HufDec*) (freq + HUF_ENCSIZE);

        hufClearDecTable (hdec);

        rv = hufUnpackEncTable (&ptr, &nBytes, im, iM, freq);
        if (rv != EXR_ERR_SUCCESS) return rv;

        rv = hufBuildDecTable (freq, im, iM, hdec);
        if (rv != EXR_ERR_SUCCESS) return rv;

        rv = hufDecode (freq, hdec, ptr, nBits, iM, nRawSize, raw);

        hufFreeDecTable (hdec);
    }

    return rv;