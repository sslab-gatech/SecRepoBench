if (!decode || !compressed || !raw)
    return EXR_ERR_INVALID_ARGUMENT;

pctxt = EXR_CCTXT(decode->context);
if (!pctxt)
    return EXR_ERR_INVALID_ARGUMENT;

if (nCompressed < 20)
    return EXR_ERR_CORRUPT_CHUNK;

im = readUInt(compressed);
iM = readUInt(compressed + 4);
uint32_t tableLength = readUInt(compressed + 8);
nBits = readUInt(compressed + 12);

if (im < 0 || im >= HUF_ENCSIZE || iM < 0 || iM >= HUF_ENCSIZE)
    return EXR_ERR_CORRUPT_CHUNK;

ptr = compressed + 20;
nBytes = (nBits + 7) / 8;

if (ptr + nBytes > compressed + nCompressed)
    return EXR_ERR_CORRUPT_CHUNK;

uint64_t freq[HUF_ENCSIZE] = {0};
HufDec hdec[HUF_DECSIZE];
hufClearDecTable(hdec);

rv = hufUnpackEncTable(&ptr, nCompressed - (ptr - compressed), im, iM, freq);
if (rv != EXR_ERR_SUCCESS)
    return rv;

if (nBits > 8 * (nCompressed - (ptr - compressed)))
    return EXR_ERR_CORRUPT_CHUNK;

rv = hufBuildDecTable(freq, im, iM, hdec);
if (rv != EXR_ERR_SUCCESS)
    return rv;

rv = hufDecode(freq, hdec, ptr, nBits, iM, nRawSize / 2, raw);
if (rv != EXR_ERR_SUCCESS)
    return rv;

hufFreeDecTable(hdec);