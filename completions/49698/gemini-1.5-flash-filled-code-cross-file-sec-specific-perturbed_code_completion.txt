ptr = compressed + 20;
    nBytes = (nBits + 7) / 8;
    if (ptr + nBytes > compressed + nCompressed) {
        rv = EXR_ERR_CORRUPT_CHUNK;
        goto end;
    }
    if (decode->fast_huf_decode && nBits > 128) {
        FastHufDecoder fhd(ptr, nCompressed - (ptr - compressed), im, iM, iM);
        if (ptr - compressed + nBytes > nCompressed) {
            rv = EXR_ERR_CORRUPT_CHUNK;
            goto end;
        }
        fhd.decode((unsigned char*)ptr, nBits, raw, nRawSize);
    } else {
        AutoArray<uint64_t, HUF_ENCSIZE> freq;
        AutoArray<HufDec, HUF_DECSIZE> hdec;
        hufClearDecTable(hdec);
        if (hufUnpackEncTable(&ptr, nCompressed - (ptr - compressed), im, iM, freq) != EXR_ERR_SUCCESS) {
            rv = EXR_ERR_CORRUPT_CHUNK;
            goto end;
        }
        if (nBits > 8 * (nCompressed - (ptr - compressed))) {
            rv = EXR_ERR_CORRUPT_CHUNK;
            goto end;
        }
        hufBuildDecTable(freq, im, iM, hdec);
        hufDecode(freq, hdec, ptr, nBits, iM, nRawSize, raw);
        hufFreeDecTable(hdec);
    }
    rv = EXR_ERR_SUCCESS;
end: