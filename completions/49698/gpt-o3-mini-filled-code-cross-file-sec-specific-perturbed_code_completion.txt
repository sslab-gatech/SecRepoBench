if (nCompressed < 20)
    return EXR_ERR_CORRUPT_CHUNK;

im    = readUInt(compressed);
iM    = readUInt(compressed + 4);
nBits = readUInt(compressed + 12);

if (im >= HUF_ENCSIZE || iM >= HUF_ENCSIZE)
    return EXR_ERR_CORRUPT_CHUNK;

ptr = compressed + 20;
nBytes = ((uint64_t)nBits + 7ULL) / 8ULL;
if (ptr + nBytes > compressed + nCompressed)
    return EXR_ERR_CORRUPT_CHUNK;

if (FastHufDecoder::enabled() && nBits > 128)
{
    FastHufDecoder fhd(ptr, nCompressed - (ptr - compressed), im, iM, iM);
    if ((ptr - compressed) + nBytes > nCompressed)
        return EXR_ERR_CORRUPT_CHUNK;
    fhd.decode((unsigned char*)ptr, nBits, raw, nRawSize);
}
else
{
    AutoArray<uint64_t, HUF_ENCSIZE> freq;
    AutoArray<HufDec, HUF_DECSIZE>   hdec;
    hufClearDecTable(hdec);

    hufUnpackEncTable(&ptr, nCompressed - (ptr - compressed), im, iM, freq);

    try
    {
        if (nBits > 8 * (nCompressed - (ptr - compressed)))
            return EXR_ERR_CORRUPT_CHUNK;
        hufBuildDecTable(freq, im, iM, hdec);
        hufDecode(freq, hdec, ptr, nBits, iM, nRawSize, raw);
    }
    catch (...)
    {
        hufFreeDecTable(hdec);
        throw;
    }
    hufFreeDecTable(hdec);
}

rv = EXR_ERR_SUCCESS;