if (nCompressed < 20) return EXR_ERR_CORRUPT_CHUNK;

    ptr = compressed;
    im = readUInt(ptr);
    ptr += 4;
    iM = readUInt(ptr);
    ptr += 4;
    nBits = readUInt(ptr);
    ptr += 4;

    if (im >= HUF_ENCSIZE || iM >= HUF_ENCSIZE || im > iM) return EXR_ERR_CORRUPT_CHUNK;

    nBytes = (nBits + 7) / 8;
    if (nCompressed < 20 + nBytes) return EXR_ERR_CORRUPT_CHUNK;

    if (fasthuf_decode_enabled() && nRawSize >= 256)
    {
        FastHufDecoder fhd;
        rv = fasthuf_initialize(pctxt, &fhd, &ptr, nBytes, im, iM, 0);
        if (rv != EXR_ERR_SUCCESS) return rv;

        rv = fasthuf_decode(pctxt, &fhd, ptr, nBits, raw, nRawSize);
        return rv;
    }
    else
    {
        HufDec hdecod[HUF_DECSIZE];
        hufClearDecTable(hdecod);
        rv = hufUnpackEncTable(&ptr, &nBytes, im, iM, freq);
        if (rv != EXR_ERR_SUCCESS) return rv;

        rv = hufBuildDecTable(freq, im, iM, hdecod);
        if (rv != EXR_ERR_SUCCESS) return rv;

        rv = hufDecode(freq, hdecod, ptr, nBits, 0, nRawSize, raw);
        return rv;
    }