pctxt = decode->context;
    ptr = compressed;
    nBytes = nCompressed;
    rv = EXR_ERR_SUCCESS;

    if (nBytes < 20)
    {
        if (nRawSize != 0)
            rv = EXR_ERR_CORRUPT_CHUNK;
        goto done;
    }

    im = readUInt (ptr);
    iM = readUInt (ptr + 4);
    if (im < 0 || im >= HUF_ENCSIZE || iM < 0 || iM >= HUF_ENCSIZE)
    {
        rv = EXR_ERR_CORRUPT_CHUNK;
        goto done;
    }

    uint32_t tableLength = readUInt (ptr + 8);
    nBits = readUInt (ptr + 12);
    ptr += 20;
    nBytes -= 20;

    if (nBits > 8 * nBytes)
    {
        rv = EXR_ERR_CORRUPT_CHUNK;
        goto done;
    }

    if (pctxt->fast_huf_decode && nBits > 128)
    {
        FastHufDecoder fhd (ptr, nBytes, im, iM, iM);
        fhd.decode ((unsigned char*) ptr, nBits, raw, nRawSize);
    }
    else
    {
        AutoArray<uint64_t, HUF_ENCSIZE> freq;
        AutoArray<HufDec, HUF_DECSIZE>   hdec;

        hufClearDecTable (hdec);

        if (hufUnpackEncTable (&ptr, nBytes, im, iM, freq) != EXR_ERR_SUCCESS)
        {
            rv = EXR_ERR_CORRUPT_CHUNK;
            goto done;
        }

        if (hufBuildDecTable (freq, im, iM, hdec) != EXR_ERR_SUCCESS)
        {
            rv = EXR_ERR_CORRUPT_CHUNK;
            goto done;
        }

        hufDecode (freq, hdec, ptr, nBits, iM, nRawSize, raw);
        hufFreeDecTable (hdec);
    }

done: