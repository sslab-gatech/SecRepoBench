{
    uint32_t im, iM, tableLength, nBits;

    if (nCompressed < 20)
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }

    pctxt = decode->cie;

    im          = readUInt (compressed);
    iM          = readUInt (compressed + 4);
    tableLength = readUInt (compressed + 8);
    nBits       = readUInt (compressed + 12);

    if (im >= HUF_ENCSIZE || iM >= HUF_ENCSIZE)
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }

    ptr    = compressed + 20;
    nBytes = (uint64_t) ((nBits + 7) / 8);

    if ((ptr + tableLength + nBytes) > (compressed + nCompressed))
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }

#ifdef USE_FAST_HUF_DECODE
    if (pctxt->fast_huf_decode && (nBits > 128))
    {
        rv = internal_fast_huf_decode (
            decode, compressed + 20, nCompressed - 20, raw, nRawSize, im, iM, nBits);
    }
    else
#endif
    {
        AutoArray<uint64_t, HUF_ENCSIZE> freq;
        AutoArray<HufDec, HUF_DECSIZE>   hdec;

        hufClearDecTable (hdec);

        rv = internal_huf_unpack_enc_table (
            &ptr,
            nCompressed - (ptr - compressed),
            im,
            iM,
            freq,
            tableLength);

        if (rv != EXR_ERR_SUCCESS) return rv;

        if (nBits > (8 * (nCompressed - (ptr - compressed))))
        {
            return EXR_ERR_CORRUPT_CHUNK;
        }

        hufBuildDecTable (freq, im, iM, hdec);

        rv = internal_huf_decode (
            freq, hdec, ptr, nBits, iM, nRawSize, raw);

        hufFreeDecTable (hdec);
    }
}