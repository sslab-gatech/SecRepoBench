if (decode && decode->context)
    pctxt = EXR_CCTXT(decode->context);

if (nCompressed < 20)
{
    if (nRawSize != 0)
        return EXR_ERR_CORRUPT_CHUNK;
    return EXR_ERR_SUCCESS;
}

im = unaligned_load32(compressed);
iM = unaligned_load32(compressed + 4);
uint32_t tableLength = unaligned_load32(compressed + 8);
nBits = unaligned_load32(compressed + 12);

if (im < 0 || im >= HUF_ENCSIZE || iM < 0 || iM >= HUF_ENCSIZE)
    return EXR_ERR_CORRUPT_CHUNK;

ptr = compressed + 20;
nBytes = (nBits + 7) / 8;

if (ptr + nBytes > compressed + nCompressed)
    return EXR_ERR_CORRUPT_CHUNK;

if (pctxt && pctxt->parts.fast_huf_decode && nBits > 128)
{
    rv = fast_huf_decode(ptr, nCompressed - (ptr - compressed), im, iM, nBits, raw, nRawSize);
}
else
{
    uint64_t freq[HUF_ENCSIZE];
    HufDec hdec[HUF_DECSIZE];

    hufClearDecTable(hdec);

    rv = huf_unpack_enc_table(&ptr, nCompressed - (ptr - compressed), im, iM, freq);
    if (rv != EXR_ERR_SUCCESS)
        return rv;

    if (nBits > 8 * (nCompressed - (ptr - compressed)))
        return EXR_ERR_CORRUPT_CHUNK;

    rv = huf_build_dec_table(freq, im, iM, hdec);
    if (rv != EXR_ERR_SUCCESS)
        return rv;

    rv = huf_decode(freq, hdec, ptr, nBits, iM, nRawSize, raw);
}