size_t slen = 0;
char *strbuf = NULL;
const char *start = p;

/* Scan until matching quote is found or end of input is reached */
while (ctx->pos < ctx->end) {
    if (*ctx->pos == quote_char) {
        /* Matching quote found */
        break;
    } else if (*ctx->pos == '\\') {
        /* Mark escape sequence and skip next character if available */
        num_escapes++;
        ctx->pos++;
        if (ctx->pos >= ctx->end) {
            PLIST_OSTEP_ERR("Unterminated quoted string at offset %ld\n", ctx->pos - ctx->start);
            ctx->err++;
            break;
        }
    }
    ctx->pos++;
}

/* Check that we actually found the terminating quote */
if (ctx->pos >= ctx->end || *ctx->pos != quote_char) {
    PLIST_OSTEP_ERR("Missing terminating quote %c at offset %ld\n", quote_char, ctx->pos - ctx->start);
    ctx->err++;
} else {
    slen = (size_t)(ctx->pos - start);
    ctx->pos++; /* Skip the closing quote */
}

/* Allocate string buffer if no error occurred */
if (!ctx->err) {
    strbuf = (char*)malloc(slen + 1);
    if (!strbuf) {
        PLIST_OSTEP_ERR("Memory allocation failed while parsing quoted string\n");
        ctx->err++;
    }
}