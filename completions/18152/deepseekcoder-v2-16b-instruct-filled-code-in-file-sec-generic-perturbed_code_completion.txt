warning("Header missing trailing newline");
        if (h->l_text < INT32_MAX)
            h->l_text++;
    }

    return h;
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read(htsFile *fp)
{
    if (!fp) return NULL;

    kstring_t str = { 0, 0, NULL };
    if (ks_expand(&str, 1024) < 0) {
        hts_log_error("Out of memory");
        return NULL;
    }

    size_t n_read;
    while ((n_read = hts_read(fp, str.s + str.l, str.m - str.l)) > 0) {
        str.l += n_read;
        if (str.l >= str.m) {
            if (ks_expand(&str, str.m * 2) < 0) {
                hts_log_error("Out of memory");
                ks_free(str.s);
                return NULL;
            }
        }
    }

    if (n_read < 0) {
        hts_log_error("Error reading file");
        ks_free(str.s);
        return NULL;
    }

    str.s[str.l] = '\0';
    sam_hdr_t *h = sam_hdr_parse(str.l, str.s);
    ks_free(str.s);
    if (!h) return NULL;

    h = sam_hdr_sanitise(h);
    if (!h) return NULL;

    return h;
}

// Write a SAM header to a file.
int sam_hdr_write(htsFile *fp, const sam_hdr_t *h)
{
    if (!fp || !h) return -1;

    if (h->l_text == 0) return 0; // nothing to write

    if (bgzf_write(fp, h->text, h->l_text) < 0) {
        hts_log_error("Error writing to file");
        return -1;
    }

    return 0;
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read2(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write2(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse2(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format(kstring_t *str, const sam_hdr_t *h)
{
    if (h->l_text > 0) {
        str->l = h->l_text;
        str->m = h->l_text + 1;
        str->s = h->text;
    } else {
        str->l = 0;
        str->m = 1;
        str->s = NULL;
    }
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse3(const kstring_t *str)
{
    return sam_hdr_parse(str->l, str->s);
}

// Write a SAM header to a string.
void sam_hdr_format2(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(str, h);
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read3(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write3(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse4(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format3(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(str, h);
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read4(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write4(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse5(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format4(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(str, h);
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read5(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write5(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse6(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format5(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(str, h);
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read6(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write6(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse7(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format6(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(str, h);
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read7(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write7(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse8(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format7(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(str, h);
}

// Parse a SAM header from a file.
//
// This function is a wrapper around sam_hdr_parse() and sam_hdr_sanitise().
// It reads the entire file, so is not suitable for large files.
sam_hdr_t *sam_hdr_read8(const char *fn)
{
    htsFile *fp = hts_open(fn, "r");
    if (!fp) return NULL;

    sam_hdr_t *h = sam_hdr_read(fp);
    hts_close(fp);
    return h;
}

// Write a SAM header to a file.
int sam_hdr_write8(const char *fn, const sam_hdr_t *h)
{
    htsFile *fp = hts_open(fn, "w");
    if (!fp) return -1;

    int ret = sam_hdr_write(fp, h);
    hts_close(fp);
    return ret;
}

// Parse a SAM header from a string.
sam_hdr_t *sam_hdr_parse9(const char *text)
{
    return sam_hdr_parse(strlen(text), text);
}

// Write a SAM header to a string.
void sam_hdr_format8(kstring_t *str, const sam_hdr_t *h)
{
    sam_hdr_format(