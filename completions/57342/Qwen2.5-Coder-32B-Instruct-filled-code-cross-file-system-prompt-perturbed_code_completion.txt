bool axis_not_pinned = false;
hb_map_t old_index_to_tag;
unsigned new_index = 0;

for (unsigned i = 0; i < axes.length; i++) {
  hb_tag_t tag = axes[i].Tag;
  old_index_to_tag.set (i, tag);

  if (!plan->user_axes_location.has (tag)) {
    axis_not_pinned = true;
    plan->index_map.set (new_index, i);
    new_index++;
  } else {
    float user_value = plan->user_axes_location[tag];
    int normalized_value = hb_roundf (hb_ot_var_normalize_axis_value (fontface, i, user_value));

    if (has_avar) {
      seg_maps = fontface->table.avar->get_segment_maps_for_axis (i);
      if (seg_maps) {
        normalized_value = seg_maps->map_value (normalized_value);
      }
    }

    plan->axes_location.set (tag, normalized_value);
    plan->normalized_coords[new_index] = normalized_value;
    new_index++;

    if (normalized_value != 0) {
      plan->not_pinned_at_default = true;
    }
  }
}

plan->all_axes_pinned = !axis_not_pinned;