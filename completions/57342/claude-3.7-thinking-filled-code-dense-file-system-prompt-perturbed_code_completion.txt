bool axis_not_pinned = false;
unsigned old_axis_idx = 0;
plan->pinned_at_default = true;

if (has_avar)
  seg_maps = &fontface->table.avar->get_segment_maps ()[0];

for (unsigned i = 0; i < axes.length; i++)
{
  hb_tag_t axis_tag = axes[i].get_tag ();
  plan->axes_old_index_tag_map.set (old_axis_idx++, axis_tag);

  if (!plan->user_axes_location.has (axis_tag))
  {
    axis_not_pinned = true;
    plan->axes_index_map.set (i, i);
    plan->normalized_coords[i] = 0;
    continue;
  }

  float axis_val = plan->user_axes_location.get (axis_tag);
  /* Normalize the coordinate */
  int normalized_coord = fontface->table.fvar->normalize_axis_value (i, axis_val);

  /* Apply avar mapping if exists */
  if (has_avar)
  {
    normalized_coord = seg_maps->map (normalized_coord);
    seg_maps = &StructAfter<OT::SegmentMaps> (*seg_maps);
  }

  plan->axes_index_map.set (i, i);
  plan->normalized_coords[i] = normalized_coord;
  
  if (normalized_coord != 0)
    plan->pinned_at_default = false;
}