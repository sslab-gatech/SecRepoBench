unsigned avar_axis_count = axes.length;
  if (has_avar)
  {
    seg_maps = &fontface->table.avar->get_segment_maps ();
    avar_axis_count = hb_min (axes.length, seg_maps->axes.length);
  }

  hb_map_t old_index_tag_map;
  unsigned old_axis_idx = 0;
  bool axis_not_pinned = false;
  for (const auto& axis : axes)
  {
    hb_tag_t tag = axis.tag;
    old_index_tag_map.set (old_axis_idx, tag);

    float v = 0.f;
    if (plan->user_axes_location.has (tag, &v))
    {
      int normalized_v = fontface->table.fvar->normalize_axis_value (old_axis_idx, v);
      if (has_avar && old_axis_idx < avar_axis_count)
      {
        normalized_v = seg_maps->get_axis_segment_map (old_axis_idx).map (normalized_v);
      }
      plan->axes_location.set (tag, v);
      if (old_axis_idx < plan->normalized_coords.length)
        plan->normalized_coords[old_axis_idx] = normalized_v;

      if (normalized_v != 0)
        plan->pinned_at_default = false;
    }
    else
    {
      axis_not_pinned = true;
      plan->axes_location.set (tag, fontface->table.fvar->get_default_axis_value (old_axis_idx));
    }

    if (has_avar && old_axis_idx < avar_axis_count)
    {
       seg_maps = &fontface->table.avar->get_segment_maps ();
    }
    old_axis_idx++;
  }