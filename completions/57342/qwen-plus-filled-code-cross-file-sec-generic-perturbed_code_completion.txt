if (has_avar)
{
  seg_maps = &fontface->table.avar->get_segment_maps ();
}

hb_map_t axis_index_to_tag;
axis_index_to_tag.init ();
bool axis_not_pinned = false;

for (unsigned int i = 0; i < axes.length; ++i)
{
  hb_tag_t tag = axes[i].get_tag ();
  axis_index_to_tag.set (i, tag);

  if (!plan->user_axes_location.has_axis (tag))
  {
    axis_not_pinned = true;
    plan->normalized_coords[i] = 0;
    continue;
  }

  float user_value = plan->user_axes_location.get_value (tag);
  int normalized_value = fontface->table.fvar->normalize_axis_value (i, user_value);

  if (has_avar && seg_maps)
  {
    const OT::SegmentMap &seg_map = (*seg_maps)[i];
    normalized_value = seg_map.map_value (normalized_value);
  }

  plan->normalized_coords[i] = normalized_value;
  plan->axes_location.set_value (tag, normalized_value);

  if (normalized_value != 0)
    axis_not_pinned = true;

  if (has_avar && seg_maps && i + 1 < axes.length)
    seg_maps = &fontface->table.avar->get_segment_maps (); // Update for next iteration if necessary
}

axis_index_to_tag.fini ();