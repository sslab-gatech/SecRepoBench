unsigned int axis_count = axes.length;
bool axis_not_pinned = false;
hb_hashmap_t<hb_tag_t, unsigned> old_index_to_tag_map;

if (has_avar)
  seg_maps = &fontface->table.avar->get_segment_maps ();

for (unsigned int i = 0; i < axis_count; i++)
{
  hb_tag_t axis_tag = axes[i].get_axis_tag ();
  old_index_to_tag_map.set (i, axis_tag);

  if (!plan->user_axes_location.has (axis_tag))
  {
    axis_not_pinned = true;
    plan->axes_old_index_tag_map.set (i, axis_tag);
    continue;
  }

  float user_value = plan->user_axes_location.get (axis_tag);
  float normalized = axes[i].normalize_axis_value (user_value);

  if (has_avar && seg_maps)
  {
    normalized = seg_maps->map (normalized);
    seg_maps = &StructAfter<OT::SegmentMaps> (*seg_maps);
  }

  plan->axes_location.set (axis_tag, normalized);
  plan->normalized_coords[i] = normalized;

  if (normalized != 0.f)
    plan->pinned_at_default = false;
}