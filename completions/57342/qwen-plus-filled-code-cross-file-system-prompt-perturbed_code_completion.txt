if (has_avar)
{
  seg_maps = &fontface->table.avar->get_segment_maps();
}

hb_map_t axis_index_to_tag;
axis_index_to_tag.init();
bool axis_not_pinned = false;

for (unsigned int i = 0; i < axes.length; i++)
{
  hb_tag_t axis_tag = axes[i].get_axis_tag();
  axis_index_to_tag.set(i, axis_tag);

  if (!plan->user_axes_location.has(axis_tag))
  {
    axis_not_pinned = true;
    plan->normalized_coords[i] = 0; // Default value when not set by user
    continue;
  }

  float user_value = plan->user_axes_location.get(axis_tag);
  int normalized_value = fontface->table.fvar->normalize_axis_value(i, user_value);

  if (has_avar && seg_maps && seg_maps->is_valid() && seg_maps->length > i)
  {
    const OT::SegmentMap *seg_map = &(*seg_maps)[i];
    normalized_value = seg_map->map(normalized_value);
  }

  plan->normalized_axes_location.set(axis_tag, normalized_value);
  plan->normalized_coords[i] = normalized_value;

  if (normalized_value != 0)
    plan->all_axes_at_default = false;

  if (i + 1 < axes.length && has_avar)
    seg_maps = &fontface->table.avar->get_segment_maps(); // Update segment maps if necessary
}

axis_index_to_tag.fini();