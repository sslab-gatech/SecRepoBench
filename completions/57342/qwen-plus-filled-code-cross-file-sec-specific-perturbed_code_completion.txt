if (has_avar)
{
  seg_maps = &fontface->table.avar->get_segment_maps ();
}

hb_map_t axis_index_to_tag;
bool axis_not_pinned = false;

for (unsigned int i = 0; i < axes.length; ++i)
{
  hb_tag_t tag = axes[i].get_tag ();
  axis_index_to_tag.set (i, tag);

  if (!plan->user_axes_location.has (tag))
  {
    axis_not_pinned = true;
    plan->axis_index_map.set (i, HB VariationAxisIndexInvalid);
  }
  else
  {
    float user_value = plan->user_axes_location.get (tag);
    int normalized_value = fontface->table.fvar->normalize_axis_value (i, user_value);

    if (has_avar && seg_maps)
    {
      const OT::SegmentMap *seg_map = seg_maps->get_segment_map_for_axis (i);
      if (seg_map)
      {
        normalized_value = seg_map->map_value (normalized_value);
      }
    }

    plan->normalized_coords[i] = normalized_value;
    plan->axes_location.set (tag, normalized_value);

    if (normalized_value != 0)
    {
      axis_not_pinned = true;
    }

    plan->axis_index_map.set (i, i); // Identity mapping for set axes.
  }
}