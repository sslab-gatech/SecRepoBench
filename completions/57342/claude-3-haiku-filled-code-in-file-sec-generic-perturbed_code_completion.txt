#ifndef HB_NO_VAR
static inline void
_normalize_axes_location (hb_face_t *fontface, hb_subset_plan_t *plan)
{
  if (plan->user_axes_location.is_empty ())
    return;

  hb_array_t<const OT::AxisRecord> axes = fontface->table.fvar->get_axes ();
  plan->normalized_coords.resize (axes.length);

  bool has_avar = fontface->table.avar->has_data ();
  const OT::SegmentMaps *seg_maps = nullptr;
  if (has_avar)
    seg_maps = &fontface->table.avar->get_segment_maps ();

  bool axis_not_pinned = false;
  for (unsigned i = 0; i < axes.length; i++)
  {
    hb_tag_t axis_tag = axes[i].get_tag ();
    plan->axes_old_index_tag_map.set (i, axis_tag);

    if (!plan->user_axes_location.has (axis_tag))
    {
      axis_not_pinned = true;
      plan->axes_location.set (axis_tag, 0.f);
      continue;
    }

    float user_loc = plan->user_axes_location[axis_tag];
    float normalized = (user_loc - axes[i].default_value) / (axes[i].max_value - axes[i].min_value);
    if (has_avar)
      normalized = seg_maps->map (i, normalized);
    plan->axes_location.set (axis_tag, normalized);
    plan->normalized_coords[i] = normalized;

    if (normalized != 0.f)
      plan->pinned_at_default = false;
  }

  plan->all_axes_pinned = !axis_not_pinned;
}
#endif