bool axis_not_pinned = false;
for (unsigned old_axis_idx = 0; old_axis_idx < axes.length; old_axis_idx++)
{
  hb_tag_t axis_tag = axes[old_axis_idx].axis_tag;
  plan->axis_location_map.set (axis_tag, old_axis_idx);

  if (!plan->user_axes_location.has (axis_tag))
  {
    axis_not_pinned = true;
    plan->axis_location_map.set (axis_tag, HB_MAP_VALUE_INVALID);
  }
  else
  {
    float user_value = plan->user_axes_location.get (axis_tag);
    plan->normalized_coords[old_axis_idx] = fvar.normalize_axis_value (old_axis_idx, user_value);

    if (has_avar)
    {
      if (!seg_maps)
        seg_maps = &fontface->table.avar->get_segment_maps ();
      plan->normalized_coords[old_axis_idx] = seg_maps->map_value (old_axis_idx, plan->normalized_coords[old_axis_idx]);
    }

    plan->axes_location.set (axis_tag, plan->normalized_coords[old_axis_idx]);

    if (plan->normalized_coords[old_axis_idx] != 0.f)
      plan->all_axes_pinned = false;
  }

  if (has_avar && old_axis_idx < avar_axis_count)
    seg_maps->advance ();
}