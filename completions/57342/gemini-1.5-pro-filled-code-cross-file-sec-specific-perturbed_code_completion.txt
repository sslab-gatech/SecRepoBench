unsigned axis_count = axes.length;
  bool axis_not_pinned = false;
  hb_map_t old_index_tag_map;
  for (unsigned i = 0; i < axis_count; ++i)
  {
    hb_tag_t tag = axes[i].axisTag;
    old_index_tag_map.set (i, tag);

    int *normalized_coords = &plan->normalized_coords[i];
    if (!plan->user_axes_location.has (tag))
    {
      axis_not_pinned = true;
      plan->axes_location.set (tag, 0);
      *normalized_coords = 0;
      continue;
    }

    float design_value = plan->user_axes_location.get (tag);
    *normalized_coords = fontface->table.fvar->normalize_axis_value (i, design_value);

    if (has_avar)
    {
      const OT::avar &avar = *fontface->table.avar;
      if (unlikely (!seg_maps))
      {
        seg_maps = &avar.get_axis_segment_maps (i);
        if (!seg_maps->is_valid ())
          has_avar = false;
      }
      if (has_avar)
        *normalized_coords = seg_maps->map (*normalized_coords);
    }

    plan->axes_location.set (tag, *normalized_coords);

    if (*normalized_coords != 0)
      plan->pinned_at_default = false;

    if (has_avar)
    {
      unsigned next_index = i + 1;
      if (next_index < axis_count)
        seg_maps = &avar.get_axis_segment_maps (next_index);
      else
      {
        has_avar = false;
        seg_maps = nullptr;
      }
    }
  }