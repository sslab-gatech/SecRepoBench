bool axis_not_pinned = false;
hb_map_t old_index_to_tag;
hb_map_t tag_to_new_index;
unsigned new_axis_idx = 0;

if (has_avar)
  seg_maps = &fontface->table.avar->get_segment_maps ();

for (unsigned i = 0; i < axes.length; i++)
{
  hb_tag_t axis_tag = axes[i].get_tag ();
  old_index_to_tag.set (i, axis_tag);

  if (!plan->user_axes_location.has (axis_tag))
  {
    axis_not_pinned = true;
    tag_to_new_index.set (axis_tag, new_axis_idx++);
    continue;
  }

  float user_value = plan->user_axes_location.get (axis_tag);
  int normalized_value = OT::AxisRecord::normalize_axis_value (user_value,
                                                              axes[i].get_min_value (),
                                                              axes[i].get_default_value (),
                                                              axes[i].get_max_value ());

  if (has_avar && i < seg_maps->len)
    normalized_value = fontface->table.avar->map_coord (normalized_value, (*seg_maps)[i]);

  plan->axes_location.set (axis_tag, user_value);
  plan->normalized_coords[i] = normalized_value;
  if (normalized_value != 0)
    plan->pinned_at_default = false;

  if (has_avar && seg_maps && i < seg_maps->len)
    seg_maps = &(*seg_maps + 1);
}