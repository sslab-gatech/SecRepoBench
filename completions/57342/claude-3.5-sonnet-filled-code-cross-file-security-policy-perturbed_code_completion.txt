unsigned int avar_axis_count = has_avar ? fontface->table.avar->get_axis_count () : 0;
bool axis_not_pinned = false;
for (unsigned old_axis_idx = 0; old_axis_idx < axes.length; old_axis_idx++)
{
  hb_tag_t axis_tag = axes[old_axis_idx].get_axis_tag ();
  plan->axes_old_index_tag_map.set (old_axis_idx, axis_tag);

  if (!plan->user_axes_location.has (axis_tag))
  {
    axis_not_pinned = true;
    plan->axes_index_map.set (old_axis_idx, 0xFFFFFFFF);
    continue;
  }

  float user_value = plan->user_axes_location.get (axis_tag);
  float normalized_value = OT::VariationAxis::normalize (user_value, axes[old_axis_idx]);

  if (has_avar && old_axis_idx < avar_axis_count)
  {
    normalized_value = seg_maps->map (normalized_value);
    seg_maps = &StructAfter<OT::SegmentMaps> (*seg_maps);
  }

  plan->axes_location.set (axis_tag, normalized_value);
  plan->normalized_coords[old_axis_idx] = normalized_value;
  if (normalized_value != 0.f)
    plan->pinned_at_default = false;
}