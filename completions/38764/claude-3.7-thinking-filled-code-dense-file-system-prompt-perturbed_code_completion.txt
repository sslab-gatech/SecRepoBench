p = b;
while (p < b + parent->size && step > 0) {
    struct file_info *file;
    size_t dr_len;

    dr_len = *p;
    if (dr_len == 0) {
        /* Skip zero-length directory records and advance to the next
           logical sector. */
        size_t skip = iso9660->logical_block_size - 
            ((p - b) % iso9660->logical_block_size);
        p += skip;
        step -= skip;
        continue;
    }
    if (p + dr_len > b + parent->size || dr_len > step) {
        /* Ensure we have a complete directory record. */
        break;
    }

    file = parse_file_info(archivereader, parent, p, dr_len);
    if (file == NULL) {
        return (ARCHIVE_FATAL);
    }

    /* Skip "." and ".." entries */
    if (file->name.length == 1 && 
        (file->name.s[0] == '\0' || file->name.s[0] == '\1')) {
        /* Skip "." and ".." entries. */
        free(file);
    } else if (multi != NULL && 
              archive_string_strcmp(&(multi->name), &(file->name)) == 0) {
        /* Append to existing multi-extent file */
        struct content *content = &(file->content);
        content->offset = file->offset;
        content->size = file->size;
        if (multi->contents.first == NULL) {
            multi->contents.first = content;
        } else {
            *multi->contents.last = content;
        }
        multi->contents.last = &(content->next);
        content->next = NULL;
        multi->size += file->size;
        free(file);
    } else {
        /* If we have a previous multi-extent file, add it */
        if (multi != NULL) {
            if (add_entry(archivereader, iso9660, multi) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
            multi = NULL;
        }
        /* Check if this is a multi-extent file */
        if (file->multi_extent) {
            multi = file;
        } else {
            /* Regular file, add it to the archive. */
            if (add_entry(archivereader, iso9660, file) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
        }
    }

    p += dr_len;
    step -= dr_len;
}

/* If we have a multi-extent file at the end, add it */
if (multi != NULL) {
    if (add_entry(archivereader, iso9660, multi) != ARCHIVE_OK)
        return (ARCHIVE_FATAL);
}