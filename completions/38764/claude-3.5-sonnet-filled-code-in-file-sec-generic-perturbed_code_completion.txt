while (step) {
    p = b;
    while (p < b + step) {
        int r;
        size_t dr_len;

        if (p + DR_length_offset + DR_length_size > b + step) {
            archive_set_error(&a->archive, ARCHIVE_ERRNO_MISC,
                "Invalid directory record");
            return (ARCHIVE_FATAL);
        }
        dr_len = p[DR_length_offset];
        if (dr_len == 0) {
            /* Skip any zero-length records. */
            p++;
            continue;
        }
        if (p + dr_len > b + step) {
            archive_set_error(&a->archive, ARCHIVE_ERRNO_MISC,
                "Invalid directory record");
            return (ARCHIVE_FATAL);
        }
        r = parse_file_info(a, parent, p, dr_len);
        if (r != ARCHIVE_OK)
            return (r);

        file = parse_file_info(a, parent, p, dr_len);
        if (file == NULL)
            return (ARCHIVE_FATAL);

        if (file->name.s[0] == '\0' || 
            (file->name.s[0] == '.' && file->name.s[1] == '\0') ||
            (file->name.s[0] == '.' && file->name.s[1] == '.' && 
             file->name.s[2] == '\0')) {
            p += dr_len;
            continue;
        }

        if (file->multi_extent) {
            if (multi == NULL) {
                multi = file;
            } else {
                struct content *con;

                con = malloc(sizeof(*con));
                if (con == NULL) {
                    archive_set_error(&a->archive, ENOMEM,
                        "No memory for multi extent");
                    return (ARCHIVE_FATAL);
                }
                con->offset = file->offset;
                con->size = file->size;
                con->next = NULL;
                *multi->contents.last = con;
                multi->contents.last = &con->next;
                free(file);
            }
        } else {
            if (multi != NULL) {
                struct content *con;

                con = malloc(sizeof(*con));
                if (con == NULL) {
                    archive_set_error(&a->archive, ENOMEM,
                        "No memory for multi extent");
                    return (ARCHIVE_FATAL);
                }
                con->offset = file->offset;
                con->size = file->size;
                con->next = NULL;
                *multi->contents.last = con;
                multi->contents.last = &con->next;
                free(file);
                file = multi;
                multi = NULL;
            }
            if (add_entry(a, iso9660, file) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
        }
        p += dr_len;
    }
    step -= p - b;
    b = p;
}