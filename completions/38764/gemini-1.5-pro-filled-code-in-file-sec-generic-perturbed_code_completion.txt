for (p = b; p + 33 < b + step; p += dr_len) {
			struct file_info *file;
			struct content *con;

			dr_len = p[DR_length_offset];
			/* If dr_len is zero, it's the end of directory
			 * entries. */
			if (dr_len == 0) {
				step -= (p - b);
				break;
			}
			if (p + dr_len > b + step) {
				archive_set_error(&archivereader->archive,
				    ARCHIVE_ERRNO_FILE_FORMAT,
				    "Invalid directory record");
				return (ARCHIVE_FATAL);
			}

			file = parse_file_info(archivereader, parent, p, dr_len);
			if (file == NULL)
				return (ARCHIVE_FATAL);

			if (file->name.s != NULL &&
			    (strcmp(file->name.s, ".") == 0 ||
			     strcmp(file->name.s, "..") == 0)) {
				archive_string_free(&file->name);
				free(file);
				dr_len = (size_t)(((dr_len + 1) & ~1));
				continue;
			}

			if (file->multi_extent) {
				if (multi != NULL) {
					archive_set_error(
					    &archivereader->archive,
					    ARCHIVE_ERRNO_FILE_FORMAT,
					    "Invalid multi extent file");
					return (ARCHIVE_FATAL);
				}
				multi = file;
				multi->contents.first = NULL;
				multi->contents.last =
				    &(multi->contents.first);
				con = malloc(sizeof(struct content));
				if (con == NULL) {
					archive_set_error(
					    &archivereader->archive, ENOMEM,
					    "No memory");
					return (ARCHIVE_FATAL);
				}
				con->offset = file->offset;
				con->size = file->size;
				con->next = NULL;
				*multi->contents.last = con;
				multi->contents.last = &(con->next);
			} else if (multi != NULL) {
				con = malloc(sizeof(struct content));
				if (con == NULL) {
					archive_set_error(
					    &archivereader->archive, ENOMEM,
					    "No memory");
					return (ARCHIVE_FATAL);
				}
				con->offset = file->offset;
				con->size = file->size;
				con->next = NULL;
				*multi->contents.last = con;
				multi->contents.last = &(con->next);
				archive_string_free(&file->name);
				free(file);
			} else if (file->offset != -1) {
				if (add_entry(archivereader, iso9660, file)
				    != ARCHIVE_OK)
					return (ARCHIVE_FATAL);
			}

			dr_len = (size_t)(((dr_len + 1) & ~1));
		}
		if (step > 0) {
			if (multi != NULL && p + 33 >= b + step) {
				parent->subdirs--;
				multi->offset = multi->contents.first->offset;
				multi->size = 0;
				for (con = multi->contents.first; con != NULL;
				    con = con->next) {
					if (con->offset + con->size >
					    iso9660->volume_size) {
						archive_set_error(
						    &archivereader->archive,
						    ARCHIVE_ERRNO_MISC,
						    "File is beyond "
						    "end-of-media: %s",
						    multi->name.s);
						multi->size = 0;
						break;
					}
					multi->size += con->size;
				}
				if (add_entry(archivereader, iso9660, multi)
				    != ARCHIVE_OK)
					return (ARCHIVE_FATAL);
				multi = NULL;
			}
			step -= (p - b);
			b = p;
		}