size_t entry_length;

		p = b;
		if (step < 34)
			break;

		entry_length = p[0];
		if (entry_length == 0)
			break;

		/* Check for corrupted ISO image */
		if (entry_length > step) {
			archive_set_error(&archivereader->archive,
			    ARCHIVE_ERRNO_FILE_FORMAT,
			    "Corrupted ISO image: entry length exceeds step");
			return (ARCHIVE_FATAL);
		}

		/*
		 * Directory entries must be at least 34 bytes long,
		 * according to the ISO9660 spec.
		 */
		if (entry_length < 34) {
			archive_set_error(&archivereader->archive,
			    ARCHIVE_ERRNO_FILE_FORMAT,
			    "Corrupted ISO image: entry length less than 34");
			return (ARCHIVE_FATAL);
		}

		struct file_info *file = next_entry(iso9660);
		if (file == NULL)
			return (ARCHIVE_FATAL);
		file->offset = parent->offset + (step - skip_size);
		file->parent = parent;
		file->length = entry_length;
		file->name_continues = 0;
		file->rr_moved = 0;
		file->re = 0;
		file->re_descendant = 0;
		file->rr_moved_has_re_only = 0;
		file->cl_offset = 0;
		file->subdirs = 0;
		file->number = -1;
		file->nlinks = 1;
		file->contents.first = file->contents.last = NULL;
		file->pz = 0;
		archive_string_empty(&file->symlink);

		parse_file_info(archivereader, iso9660, file, p);

		/* Skip '.' and '..' entries. */
		if (file->flags & ISO9660_FLAG_SELF) {
			free_file(file);
		} else if (file->flags & ISO9660_FLAG_PARENT) {
			free_file(file);
		} else if ((file->mode & AE_IFMT) == AE_IFREG &&
		    file->number != -1 &&
		    iso9660->strict &&
		    !archive_read_test_options(archivereader, "iso9660:ignore-hardlinks", NULL)) {
			/*
			 * If the file is multi extent, add it to the list.
			 * The file will be added to the archive later.
			 */
			if (multi == NULL) {
				multi = file;
				add_file(iso9660, file);
			} else {
				if (multi->number != file->number) {
					archive_set_error(&archivereader->archive,
					    ARCHIVE_ERRNO_FILE_FORMAT,
					    "Invalid ISO image: "
					    "multi extent file has "
					    "different file number");
					return (ARCHIVE_FATAL);
				}
				add_file(iso9660, file);
			}
		} else {
			add_file(iso9660, file);
		}

		step -= entry_length;
		skip_size -= entry_length;
		b += entry_length;