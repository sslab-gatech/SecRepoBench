static int
archive_read_format_iso9660_read_data(struct archive_read *a,
    const void **buff, size_t *size, int64_t *offset)
{
	ssize_t bytes_read;
	const unsigned char *p;
	size_t step, skip_size;

	iso9660 = (struct iso9660 *)(a->format->data);

	/* Skip the first 32k (reserved area) and get the first
	 * 8 sectors of the volume descriptor table.  Of course,
	 * if the I/O layer gives us more, we'll take it.
	 */
	step = LOGICAL_BLOCK_SIZE * 8;
	p = __archive_read_ahead(a, step, &bytes_read);
	if (p == NULL)
		return (ARCHIVE_FATAL);

	/* Skip the reserved area. */
	bytes_read -= LOGICAL_BLOCK_SIZE * 32;
	p += LOGICAL_BLOCK_SIZE * 32;

	/* Check each volume descriptor. */
	while (bytes_read > LOGICAL_BLOCK_SIZE) {
		/* Do not handle undefined Volume Descriptor Type. */
		if (p[0] != 1 && p[0] != 2 && p[0] != 255)
			return (ARCHIVE_FATAL);

		/* Volume Descriptor Version must be 1 for ISO9660/ECMA119. */
		if (p[6] != 1)
			return (ARCHIVE_FATAL);

		/* Reserved field must be 0. */
		if (p[7] != 0)
			return (ARCHIVE_FATAL);

		/* Reserved field must be 0. */
		if (!isNull(iso9660, p, 13))
			return (ARCHIVE_FATAL);

		/* Logical block size must be > 0. */
		/* I've looked at Ecma 119 and can't find any stronger
		 * restriction on this field. */
		if (archive_le16dec(p + PVD_logical_block_size_offset) <= 0)
			return (ARCHIVE_FATAL);

		iso9660->logical_block_size =
		    archive_le16dec(p + PVD_logical_block_size_offset);

		iso9660->volume_block =
		    archive_le32dec(p + PVD_volume_space_size_offset);

		/* File structure version must be 1 for ISO9660/ECMA119. */
		if (p[PVD_file_structure_version_offset] != 1)
			return (ARCHIVE_FATAL);

		/* Location of Occurrence of Type L Path Table must be
		 * available location,
		 * >= SYSTEM_AREA_BLOCK(16) + 2 and < Volume Space Size. */
		location = archive_le32dec(p + PVD_type_1_path_table_offset);
		if (location < SYSTEM_AREA_BLOCK + 2 || location >= iso9660->volume_block)
			return (ARCHIVE_FATAL);

		/* The Type M Path Table must be at a valid location (WinISO
		 * and probably other programs omit this, so we permit a zero here)
		 *
		 * >= SYSTEM_AREA_BLOCK(16) + 2 and < Volume Space Size. */
		location = archive_be32dec(p + PVD_type_m_path_table_offset);
		if ((location > 0 && location < SYSTEM_AREA_BLOCK + 2)
		    || location >= iso9660->volume_block)
			return (ARCHIVE_FATAL);

		/* Read Root Directory Record in Volume Descriptor. */
		p = p + PVD_root_directory_record_offset;
		if (p[DR_length_offset] != 34)
			return (ARCHIVE_FATAL);

		iso9660->primary.location =
		    archive_le32dec(p + DR_extent_offset);
		iso9660->primary.size =
		    archive_le32dec(p + DR_size_offset);

		/* Read data which RRIP "CE" extension points. */
		if (read_CE(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "NM" extension points. */
		if (read_NM(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "PX" extension points. */
		if (read_PX(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "SL" extension points. */
		if (read_SL(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "TF" extension points. */
		if (read_TF(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "ZF" extension points. */
		if (read_ZF(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "RE" extension points. */
		if (read_RE(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "CL" extension points. */
		if (read_CL(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "SP" extension points. */
		if (read_SP(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "RR" extension points. */
		if (read_RR(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "RRIP" extension points. */
		if (read_RRIP(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "SUSP" extension points. */
		if (read_SUSP(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA" extension points. */
		if (read_XA(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA1" extension points. */
		if (read_XA1(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA2" extension points. */
		if (read_XA2(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA3" extension points. */
		if (read_XA3(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA4" extension points. */
		if (read_XA4(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA5" extension points. */
		if (read_XA5(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA6" extension points. */
		if (read_XA6(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA7" extension points. */
		if (read_XA7(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA8" extension points. */
		if (read_XA8(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA9" extension points. */
		if (read_XA9(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA10" extension points. */
		if (read_XA10(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA11" extension points. */
		if (read_XA11(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA12" extension points. */
		if (read_XA12(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA13" extension points. */
		if (read_XA13(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA14" extension points. */
		if (read_XA14(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA15" extension points. */
		if (read_XA15(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA16" extension points. */
		if (read_XA16(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA17" extension points. */
		if (read_XA17(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA18" extension points. */
		if (read_XA18(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA19" extension points. */
		if (read_XA19(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA20" extension points. */
		if (read_XA20(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA21" extension points. */
		if (read_XA21(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA22" extension points. */
		if (read_XA22(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA23" extension points. */
		if (read_XA23(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA24" extension points. */
		if (read_XA24(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA25" extension points. */
		if (read_XA25(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA26" extension points. */
		if (read_XA26(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA27" extension points. */
		if (read_XA27(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA28" extension points. */
		if (read_XA28(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA29" extension points. */
		if (read_XA29(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA30" extension points. */
		if (read_XA30(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA31" extension points. */
		if (read_XA31(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA32" extension points. */
		if (read_XA32(a, iso9660) != ARCHIVE_OK)
			return (ARCHIVE_FATAL);

		/* Read data which RRIP "XA33" extension points