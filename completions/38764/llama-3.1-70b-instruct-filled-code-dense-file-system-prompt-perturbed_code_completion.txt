while (step) {
    size_t entry_size;
    struct file_info *file;

    entry_size = parse_directory_entry(iso9660, b, step, &file);
    if (entry_size == 0) {
        archive_set_error(&archivereader->archive, ARCHIVE_ERRNO_MISC,
            "Failed to parse directory entry");
        return (ARCHIVE_FATAL);
    }
    if (file == NULL) {
        /* Skip entries for '.' and '..' directories. */
        b += entry_size;
        step -= entry_size;
        continue;
    }

    if (file->mode & AE_IFMT) {
        if (file->mode & AE_IFDIR) {
            if (file->number == 1) {
                /* Skip root directory. */
                b += entry_size;
                step -= entry_size;
                continue;
            }
            if (file->size == 0) {
                /* Skip empty directory. */
                b += entry_size;
                step -= entry_size;
                continue;
            }
        } else if (file->mode & AE_IFREG) {
            if (file->size == 0) {
                /* Skip empty file. */
                b += entry_size;
                step -= entry_size;
                continue;
            }
        }
    }

    if (file->number == -1) {
        /* Skip entries for files with invalid file serial number. */
        b += entry_size;
        step -= entry_size;
        continue;
    }

    if (file->pz) {
        /* Manage multi-extent files by collecting their contents into a list. */
        if (multi == NULL) {
            multi = file;
        } else {
            struct file_info *last;

            last = multi;
            while (last->next!= NULL)
                last = last->next;
            last->next = file;
        }
    } else {
        if (multi!= NULL) {
            /* Add multi-extent file to the archive structure. */
            if (add_entry(archivereader, iso9660, multi)!= ARCHIVE_OK)
                return (ARCHIVE_FATAL);
            multi = NULL;
        }
        /* Add single-extent file to the archive structure. */
        if (add_entry(archivereader, iso9660, file)!= ARCHIVE_OK)
            return (ARCHIVE_FATAL);
    }

    b += entry_size;
    step -= entry_size;
}