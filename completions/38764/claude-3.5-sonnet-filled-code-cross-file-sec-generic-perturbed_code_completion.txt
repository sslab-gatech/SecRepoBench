p = b;
while (step) {
    struct file_info *file;
    size_t dr_len;

    if (p >= b + step)
        break;

    dr_len = p[0];
    if (dr_len == 0) {
        /* Skip any zero padding at the end of the sector. */
        skip_size -= step;
        break;
    }
    if (dr_len < 34 || dr_len > step) {
        archive_set_error(&archivereader->archive, ARCHIVE_ERRNO_MISC,
            "Invalid directory record length");
        return (ARCHIVE_FATAL);
    }

    file = parse_file_info(archivereader, parent, p, dr_len);
    if (file == NULL)
        return (ARCHIVE_FATAL);

    if (file->cl_offset) {
        if (multi != NULL) {
            archive_set_error(&archivereader->archive, ARCHIVE_ERRNO_MISC,
                "Invalid directory record");
            return (ARCHIVE_FATAL);
        }
        multi = file;
    } else if (multi != NULL) {
        if (add_multi_extent(archivereader, multi, file) != ARCHIVE_OK)
            return (ARCHIVE_FATAL);
    } else {
        if (strcmp(file->name.s, ".") != 0 && strcmp(file->name.s, "..") != 0) {
            if (register_file(archivereader, file) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
        } else {
            free_file(file);
        }
    }

    p += dr_len;
    step -= dr_len;
}

if (multi != NULL) {
    if (register_file(archivereader, multi) != ARCHIVE_OK)
        return (ARCHIVE_FATAL);
}