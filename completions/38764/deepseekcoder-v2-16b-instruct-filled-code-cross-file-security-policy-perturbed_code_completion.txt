// Iterate over directory entries in the buffer while there is data to process.
// For each directory entry, parse its file information, and handle special cases:
// - Skip entries for '.' and '..' directories.
// - Manage multi-extent files by collecting their contents into a list.
// - For each valid directory entry, add it to the archive structure.
// - Handle memory allocation and error management for multi-extent file handling.

struct iso9660 *iso9660 = (struct iso9660 *)(archivereader->format->data);
struct file_info *file;
size_t i;

for (i = 0; i < step; i += iso9660->logical_block_size) {
    const unsigned char *entry_data = b + i;
    size_t entry_size = iso9660->logical_block_size;

    if (entry_size > data_length) {
        entry_size = data_length;
    }

    data_length -= entry_size;

    // Parse the directory entry
    parse_rockridge_NM1(file, entry_data, entry_size);

    if (file->name.length == 0) {
        continue;
    }

    if (file->name.s[0] == '.' && file->name.s[1] == '\0') {
        continue;
    }

    if (file->name.s[0] == '.' && file->name.s[1] == '.' && file->name.s[2] == '\0') {
        continue;
    }

    // Add the file to the archive structure
    // This is a simplified example, actual implementation may vary
    archive_entry_set_pathname(entry, file->name.s);
    archive_entry_set_mode(entry, file->mode);
    archive_entry_set_uid(entry, file->uid);
    archive_entry_set_gid(entry, file->gid);
    archive_entry_set_nlink(entry, file->nlinks);
    archive_entry_set_mtime(entry, file->mtime, 0);
    archive_entry_set_ctime(entry, file->ctime, 0);
    archive_entry_set_atime(entry, file->atime, 0);
    archive_entry_set_size(entry, file->size);

    if (file->symlink.s != NULL) {
        archive_entry_copy_symlink(entry, file->symlink.s);
    }

    // Handle multi-extent files
    if (file->contents.first != NULL) {
        // Collect contents into a list
        struct file_content *current_content = file->contents.first;
        while (current_content != NULL) {
            // Add content to the archive
            // This is a simplified example, actual implementation may vary
            archive_entry_set_size(entry, current_content->size);
            current_content = current_content->next;
        }
    }
}