while (step) {
    p = b;
    while (p < b + step) {
        if (p[DR_length_offset] == 0)
            break;
        if (p + p[DR_length_offset] > b + step) {
            archive_set_error(&a->archive, ARCHIVE_ERRNO_MISC,
                "Invalid directory record");
            return (ARCHIVE_FATAL);
        }
        file = parse_file_info(a, parent, p, step - (p - b));
        if (file == NULL) {
            return (ARCHIVE_FATAL);
        }
        if (file->name.s[0] == '\0' || 
            (file->name.s[0] == '.' && file->name.s[1] == '\0') ||
            (file->name.s[0] == '.' && file->name.s[1] == '.' && 
             file->name.s[2] == '\0')) {
            p += p[DR_length_offset];
            continue;
        }
        if (file->cl_offset) {
            if (multi == NULL) {
                multi = calloc(1, sizeof(*multi));
                if (multi == NULL) {
                    archive_set_error(&a->archive, ENOMEM,
                        "No memory for multi extent");
                    return (ARCHIVE_FATAL);
                }
            }
            multi->next = file;
            multi = file;
        } else {
            if (add_entry(a, iso9660, file) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
        }
        p += p[DR_length_offset];
    }
    if (multi) {
        if (add_entry(a, iso9660, multi) != ARCHIVE_OK)
            return (ARCHIVE_FATAL);
        multi = NULL;
    }
    b += step;
    step = b + step > end ? end - b : step;
}