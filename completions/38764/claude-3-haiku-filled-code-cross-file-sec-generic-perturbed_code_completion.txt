while (step) {
    b = __archive_read_ahead(archivereader, iso9660->logical_block_size, NULL);
    if (b == NULL) {
        archive_set_error(&archivereader->archive, ARCHIVE_ERRNO_MISC,
            "Failed to read full block when scanning ISO9660 directory list");
        return (ARCHIVE_FATAL);
    }

    p = b;
    while (p < b + iso9660->logical_block_size) {
        struct file_info *file;
        int len, flags, name_len;

        /* Skip '.' and '..' entries */
        if (p[0] == 0 || (p[0] == 1 && p[1] == 0)) {
            p += p[0] + 1;
            continue;
        }

        file = calloc(1, sizeof(*file));
        if (file == NULL) {
            archive_set_error(&archivereader->archive, ENOMEM,
                "Can't allocate file info");
            return (ARCHIVE_FATAL);
        }

        file->parent = parent;
        file->offset = iso9660->current_position + (p - b);
        file->size = p[2] + (p[3] << 8) + (p[4] << 16) + (p[5] << 24);
        file->mode = AE_IFREG | 0444;
        file->uid = 0;
        file->gid = 0;
        file->mtime = iso9660_time(p + 18);
        file->ctime = file->mtime;
        file->atime = file->mtime;
        file->birthtime = file->mtime;
        file->birthtime_is_set = 1;
        file->rdev = 0;
        file->number = -1;

        len = p[32];
        name_len = len;
        flags = p[25];
        if (flags & 0x02) { /* Associated file */
            name_len--;
        }
        if (flags & 0x01) { /* Hidden */
            file->mode &= ~0444;
        }
        if (flags & 0x20) { /* Directory */
            file->mode = AE_IFDIR | 0755;
            file->size = 0;
            file->subdirs = 0;
        }
        if (flags & 0x80) { /* Multi-extent */
            file->multi = 1;
        }

        archive_strncpy(&file->name, (const char *)p + 33, name_len);

        if (flags & 0x02) { /* Associated file */
            /* Ignore associated files for now. */
            free(file);
            p += p[0] + 1;
            continue;
        }

        if (flags & 0x80) { /* Multi-extent */
            if (multi == NULL) {
                multi = file;
            } else {
                multi->next = file;
                multi = file;
            }
        } else {
            cache_add_entry(iso9660, file);
        }

        p += p[0] + 1;
        step -= iso9660->logical_block_size;
    }

    skip_size -= iso9660->logical_block_size;
}