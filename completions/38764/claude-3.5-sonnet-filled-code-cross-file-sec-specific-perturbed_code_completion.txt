while (step > 0) {
    const unsigned char *p = b;
    struct file_info *file;
    size_t dr_len;

    if (p[0] == 0)
        break;

    dr_len = p[0];
    if (dr_len == 0 || dr_len > step) {
        archive_set_error(&archivereader->archive, ARCHIVE_ERRNO_MISC,
            "Invalid directory record length");
        return (ARCHIVE_FATAL);
    }

    file = parse_file_info(archivereader, iso9660, parent, p, dr_len);
    if (file == NULL)
        return (ARCHIVE_FATAL);

    if (file->cl_offset) {
        if (multi == NULL) {
            multi = file;
        } else {
            multi->size += file->size;
            free(file);
        }
    } else {
        if (multi != NULL) {
            if (add_multi_extent(archivereader, multi, file) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
            multi = NULL;
        } else {
            if (register_file(archivereader, iso9660, file) != ARCHIVE_OK)
                return (ARCHIVE_FATAL);
        }
    }

    p += dr_len;
    step -= dr_len;
    if (p - b > (off_t)skip_size)
        skip_size = p - b;
}

if (multi != NULL) {
    archive_set_error(&archivereader->archive, ARCHIVE_ERRNO_MISC,
        "Invalid multi-extent file");
    return (ARCHIVE_FATAL);
}