if (encoding != (const char *) NULL)
  {
    encoding_type=FT_ENCODING_NONE;
    if (LocaleCompare(encoding,"BuiltIn") == 0)
      encoding_type=FT_ENCODING_NONE;
    else
      if ((LocaleCompare(encoding,"Adobe-Custom") == 0) ||
          (LocaleCompare(encoding,"Adobe-Standard") == 0))
        encoding_type=FT_ENCODING_ADOBE_STANDARD;
      else
        if (LocaleCompare(encoding,"Apple-Roman") == 0)
          encoding_type=FT_ENCODING_APPLE_ROMAN;
        else
          if (LocaleCompare(encoding,"BIG5") == 0)
            encoding_type=FT_ENCODING_BIG5;
          else
            if (LocaleCompare(encoding,"GB2312") == 0)
              encoding_type=FT_ENCODING_GB2312;
            else
              if ((LocaleCompare(encoding,"Johab") == 0))
                encoding_type=FT_ENCODING_JOHAB;
              else
                if ((LocaleCompare(encoding,"Latin-1") == 0) ||
                   (LocaleCompare(encoding,"Latin-2") == 0) ||
                   (LocaleCompare(encoding,"Latin-9") == 0) ||
                   (LocaleCompare(encoding,"Windows-1252") == 0))
                  encoding_type=FT_ENCODING_ADOBE_STANDARD;
                else
                  if ((LocaleCompare(encoding,"Microsoft-Symbol") == 0) ||
                      (LocaleCompare(encoding,"Symbol") == 0))
                    encoding_type=FT_ENCODING_MS_SYMBOL;
                  else
                    if (LocaleCompare(encoding,"Shift-JIS") == 0)
                      encoding_type=FT_ENCODING_SJIS;
                    else
                      if (LocaleCompare(encoding,"Unicode") == 0)
                        encoding_type=FT_ENCODING_UNICODE;
                      else
                        if (LocaleCompare(encoding,"Wansung") == 0)
                          encoding_type=FT_ENCODING_WANSUNG;
    if (encoding_type != FT_ENCODING_NONE)
      {
        ft_status=FT_Select_Charmap(face,encoding_type);
        if (ft_status != 0)
          {
            FT_Done_Face(face);
            (void) FT_Done_FreeType(library);
            ThrowFreetypeErrorException("UnrecognizedFontEncoding",ft_status,
              encoding);
            return(MagickFalse);
          }
      }
  }
  /*
    Set character size.
  */
  resolution.x=DefaultResolution;
  resolution.y=DefaultResolution;
  if (draw_info->density != (char *) NULL)
    {
      GeometryInfo
        geometry_info;

      MagickStatusType
        flags;

      flags=ParseGeometry(draw_info->density,&geometry_info);
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        resolution.y=resolution.x;
    }
  ft_status=FT_Set_Char_Size(face,(FT_F26Dot6) (64.0*draw_info->pointsize),
    (FT_F26Dot6) (64.0*draw_info->pointsize),(FT_UInt) resolution.x,
    (FT_UInt) resolution.y);
  if (ft_status != 0)
    {
      FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetPointSize",ft_status,
        draw_info->font);
      return(MagickFalse);
    }
  /*
    Initialize metrics.
  */
  metrics->pixels_per_em.x=face->size->metrics.x_ppem;
  metrics->pixels_per_em.y=face->size->metrics.y_ppem;
  metrics->ascent=(double) face->size->metrics.ascender/64.0;
  metrics->descent=(double) face->size->metrics.descender/64.0;
  metrics->width=0;
  metrics->origin.x=0;
  metrics->origin.y=0;
  metrics->height=(double) face->size->metrics.height/64.0;
  metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
  if (metrics->ascent == 0.0)
    metrics->ascent=(double) face->bbox.yMax/64.0*metrics->pixels_per_em.y/
      face->units_per_EM;
  if (metrics->descent == 0.0)
    metrics->descent=(double) face->bbox.yMin/64.0*metrics->pixels_per_em.y/
      face->units_per_EM;
  metrics->underline_position=FT_MulFix(face->underline_position,
    face->size->metrics.y_scale)/64.0;
  metrics->underline_thickness=FT_MulFix(face->underline_thickness,
    face->size->metrics.y_scale)/64.0;
  if (draw_info->text == (char *) NULL)
    {
      FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  if (*draw_info->text == '\0')
    {
      FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  /*
    Render text as anti-aliased.
  */
  flags=FT_LOAD_NO_BITMAP;
  if (draw_info->text_antialias == MagickFalse)
    flags|=FT_LOAD_TARGET_MONO;
  else
    {
      if (img->storage_class != DirectClass)
        (void) SetImageStorageClass(img,DirectClass,exception);
      flags|=FT_LOAD_TARGET_NORMAL;
    }
  if (draw_info->render == MagickFalse)
    flags|=FT_LOAD_NO_HINTING;
  /*
    Convert text to UTF8 and compute glyph indices.
  */
  annotate_info=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  if (annotate_info == (DrawInfo *) NULL)
    {
      FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickFalse);
    }
  utf8=(unsigned char *) AcquireString(draw_info->text);
  utf8=(unsigned char *) draw_info->text;
  status=MagickTrue;
  if ((draw_info->render != MagickFalse) &&
      (draw_info->direction == RightToLeftDirection))
    {
      char
        *text;

      size_t
        i;

      text=ReverseString(draw_info->text);
      if (text != (char *) NULL)
        {
          for (i=0; i < strlen(text); i++)
            utf8[i]=(unsigned char) text[i];
          text=DestroyString(text);
        }
    }
  grapheme=(GraphemeInfo *) NULL;
  length=ComplexTextLayout(img,draw_info,(const char *) utf8,strlen(
    (char *) utf8),face,flags,&grapheme,exception);
  if (length == 0)
    {
      annotate_info=DestroyDrawInfo(annotate_info);
      FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  if (grapheme == (GraphemeInfo *) NULL)
    {
      annotate_info=DestroyDrawInfo(annotate_info);
      FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickFalse);
    }
  first_glyph_id=grapheme[0].index;
  last_glyph_id=first_glyph_id;
  missin