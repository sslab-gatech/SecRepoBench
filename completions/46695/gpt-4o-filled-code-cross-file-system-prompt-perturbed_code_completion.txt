/*
    Set character size.
  */
  resolution.x=DefaultResolution;
  resolution.y=DefaultResolution;
  if (draw_info->density != (char *) NULL)
    {
      GeometryInfo
        geometry_info;

      MagickStatusType
        flags;

      flags=ParseGeometry(draw_info->density,&geometry_info);
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        resolution.y=resolution.x;
    }
  ft_status=FT_Set_Char_Size(face,0,(FT_F26Dot6) (64.0*draw_info->pointsize),
    (FT_UInt) resolution.x,(FT_UInt) resolution.y);
  if (ft_status != 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,
        img->filename);
      return(MagickFalse);
    }
  /*
    Initialize font metrics.
  */
  metrics->ascent=(double) face->size->metrics.ascender/64.0;
  metrics->descent=(double) face->size->metrics.descender/64.0;
  metrics->width=0.0;
  metrics->height=metrics->ascent-metrics->descent;
  metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
  if (face->size->metrics.y_ppem > 0)
    {
      metrics->underline_position=(double) face->underline_position*
        face->size->metrics.y_ppem/face->units_per_EM;
      metrics->underline_thickness=(double) face->underline_thickness*
        face->size->metrics.y_ppem/face->units_per_EM;
    }
  else
    {
      metrics->underline_position=(double) face->underline_position/
        face->units_per_EM;
      metrics->underline_thickness=(double) face->underline_thickness/
        face->units_per_EM;
    }
  if (metrics->underline_position > 0.0)
    metrics->underline_position=(-metrics->underline_position);
  if (metrics->underline_thickness < 1.0)
    metrics->underline_thickness=1.0;
  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
      (face->num_glyphs == 0))
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  /*
    Render text.
  */
  status=MagickTrue;
  annotate_info=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  if (annotate_info->encoding != (char *) NULL)
    {
      if (LocaleCompare(annotate_info->encoding,"none") == 0)
        encoding_type=FT_ENCODING_NONE;
      else if (LocaleCompare(annotate_info->encoding,"sjis") == 0)
        encoding_type=FT_ENCODING_SJIS;
      else if (LocaleCompare(annotate_info->encoding,"gb2312") == 0)
        encoding_type=FT_ENCODING_GB2312;
      else if (LocaleCompare(annotate_info->encoding,"big5") == 0)
        encoding_type=FT_ENCODING_BIG5;
      else if (LocaleCompare(annotate_info->encoding,"wansung") == 0)
        encoding_type=FT_ENCODING_WANSUNG;
      else if (LocaleCompare(annotate_info->encoding,"johab") == 0)
        encoding_type=FT_ENCODING_JOHAB;
      else if (LocaleCompare(annotate_info->encoding,"adobe-standard") == 0)
        encoding_type=FT_ENCODING_ADOBE_STANDARD;
      else if (LocaleCompare(annotate_info->encoding,"adobe-expert") == 0)
        encoding_type=FT_ENCODING_ADOBE_EXPERT;
      else if (LocaleCompare(annotate_info->encoding,"adobe-custom") == 0)
        encoding_type=FT_ENCODING_ADOBE_CUSTOM;
      else if (LocaleCompare(annotate_info->encoding,"adobe-latin-1") == 0)
        encoding_type=FT_ENCODING_ADOBE_LATIN_1;
      else if (LocaleCompare(annotate_info->encoding,"old-latin-2") == 0)
        encoding_type=FT_ENCODING_OLD_LATIN_2;
      else if (LocaleCompare(annotate_info->encoding,"apple-roman") == 0)
        encoding_type=FT_ENCODING_APPLE_ROMAN;
      ft_status=FT_Select_Charmap(face,encoding_type);
      if (ft_status != 0)
        {
          (void) FT_Done_Face(face);
          (void) FT_Done_FreeType(library);
          ThrowFreetypeErrorException("UnableToSelectCharMap",ft_status,
            img->filename);
          return(MagickFalse);
        }
    }
  length=ComplexTextLayout(img,annotate_info,draw_info->text,
    strlen(draw_info->text),face,flags,&grapheme,exception);
  if (length == 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickFalse);
    }
  for (i=0; i < (ssize_t) length; i++)
  {
    glyph.id=(FT_UInt) grapheme[i].index;
    if (glyph.id == 0)
      continue;
    ft_status=FT_Load_Glyph(face,glyph.id,flags);
    if (ft_status != 0)
      continue;
    ft_status=FT_Get_Glyph(face->glyph,&glyph.image);
    if (ft_status != 0)
      continue;
    if (face->glyph->format != FT_GLYPH_FORMAT_BITMAP)
      {
        ft_status=FT_Glyph_To_Bitmap(&glyph.image,FT_RENDER_MODE_NORMAL,
          &origin,MagickTrue);
        if (ft_status != 0)
          continue;
      }
    bitmap=(FT_BitmapGlyph) glyph.image;
    point.x=offset->x+grapheme[i].x_offset/64.0;
    point.y=offset->y-grapheme[i].y_offset/64.0;
    if (face->glyph->format == FT_GLYPH_FORMAT_OUTLINE)
      {
        FT_Outline
          *outline;

        outline=&face->glyph->outline;
        FT_Outline_Translate(outline,(FT_Pos) point.x,(FT_Pos) point.y);
        FT_Outline_Decompose(outline,&OutlineMethods,(void *) img);
      }
    else
      {
        (void) CompositeImage(img,OverCompositeOp,bitmap->bitmap.buffer,
          (ssize_t) point.x-bitmap->left,(ssize_t) point.y-bitmap->top,
          bitmap->bitmap.width,bitmap->bitmap.rows);
      }
    FT_Done_Glyph(glyph.image);
  }
  grapheme=(GraphemeInfo *) RelinquishMagickMemory(grapheme);
  (void) FT_Done_Face(face);
  (void) FT_Done_FreeType(library);
  return(status);