// <MASK>
  // Select the appropriate character map (encoding) for the font face based on
  // the provided encoding string. If an encoding is specified, determine the
  // corresponding FreeType encoding type using a series of string comparisons.
  // If the encoding type is successfully determined, apply it to the font face.
  // If the encoding type cannot be applied, handle the error by cleaning up
  // resources and throwing an exception.
  // 
  // Set the character size for the font face based on the point size and
  // resolution specified in the DrawInfo structure. Adjust the resolution
  // if a custom density is provided. If setting the character size fails,
  // handle the error by cleaning up resources and throwing an exception.
  // 
  // Initialize the TypeMetric structure with font size metrics such as ascent,
  // descent, width, height, and maximum advance. If necessary, sanitize any
  // incorrect ascender and descender values. Calculate underline position and
  // thickness based on the font's properties.
  // 
  // If there is no text to render, or no glyphs in the font, clean up resources
  // and return a successful status without proceeding further.
  // 
  // Configure rendering options such as anti-aliasing and hinting based on
  // the DrawInfo settings and image properties. Prepare structures for
  // rendering each glyph in the text string, transforming the glyphs according
  // to specified affine transformations.
  // 
  // Loop through each character in the text, rendering glyphs, tracing outlines
  // if necessary, and rasterizing the glyphs onto the image. Adjust the
  // position and metrics of each rendered glyph, and update the bounding box
  // of the text as needed. Manage resources and synchronize image data
  // appropriately during the rendering process.
  // 
  // Finalize the font metrics by normalizing the bounding box coordinates and
  // width. Clean up any remaining resources and return the rendering status.
  if (draw_info->text!= (char *) NULL)
  {
    size_t
      extent;

    GraphemeInfo
      *grapheme;

    extent=ComplexTextLayout(img,draw_info,draw_info->text,
      strlen(draw_info->text),face,flags, &grapheme,exception);
    if (extent == 0)
      {
        (void) FT_Done_FreeType(library);
        return(MagickFalse);
      }
    for (i=0; i < extent; i++)
      {
        if (grapheme[i].index!= 0)
          {
            ft_status=FT_Load_Glyph(face,grapheme[i].index,flags);
            if (ft_status!= 0)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("UnableToLoadGlyph",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            bitmap=(FT_BitmapGlyph) face->glyph;
            bounds=face->glyph->bitmap->bitmap_left;
            bounds.xMin+=offset->x;
            bounds.yMin+=offset->y;
            bounds.xMax+=offset->x;
            bounds.yMax+=offset->y;
            if (bounds.xMin < 0)
              bounds.xMin=0;
            if (bounds.yMin < 0)
              bounds.yMin=0;
            if (bounds.xMax > img->columns)
              bounds.xMax=img->columns;
            if (bounds.yMax > img->rows)
              bounds.yMax=img->rows;
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.yMin == 0)
              {
                if (bounds.yMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.yMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.yMin == 0)
              {
                if (bounds.yMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.yMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.yMin == 0)
              {
                if (bounds.yMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.yMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.yMin == 0)
              {
                if (bounds.yMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.yMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.yMin == 0)
              {
                if (bounds.yMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.yMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.yMin == 0)
              {
                if (bounds.yMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.yMax == 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            if (bounds.xMin > bounds.xMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.yMin > bounds.yMax)
              {
                (void) FT_Done_FreeType(library);
                ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                  draw_info->text);
                return(MagickFalse);
              }
            if (bounds.xMin == 0)
              {
                if (bounds.xMax > 0)
                  {
                    (void) FT_Done_FreeType(library);
                    ThrowFreetypeErrorException("InvalidGlyphBounds",ft_status,
                      draw_info->text);
                    return(MagickFalse);
                  }
              }
            else
              {
                if (bounds.xMax == 0)
                  {