/*
    Select the appropriate character map (encoding) if specified.
  */
  if ((encoding != (char *) NULL) && (*encoding != '\0'))
  {
    if (LocaleCompare(encoding,"UTF-8") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"SJIS") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_SJIS;
    else if (LocaleCompare(encoding,"GB2312") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_GB2312;
    else if (LocaleCompare(encoding,"BIG5") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_BIG5;
    else if (LocaleCompare(encoding,"WANSUNG") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_WANSUNG;
    else if (LocaleCompare(encoding,"JOHAB") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_JOHAB;
    else if (LocaleCompare(encoding,"ADOBE_CUSTOM") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_ADOBE_CUSTOM;
    else if (LocaleCompare(encoding,"ADOBE_EXPERT") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_ADOBE_EXPERT;
    else if (LocaleCompare(encoding,"ADOBE_STANDARD") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_ADOBE_STANDARD;
    else if (LocaleCompare(encoding,"APPLE_ROMAN") == 0)
      encoding_type=(FT_Encoding) FT_ENCODING_APPLE_ROMAN;
    else
      encoding_type=FT_ENCODING_NONE;

    ft_status=FT_Select_Charmap(face,encoding_type);
    if (ft_status != 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSelectCharmap",ft_status,img->filename);
      return(MagickFalse);
    }
  }

  /*
    Set the character size based on pointsize and resolution.
  */
  resolution.x=72.0;
  resolution.y=72.0;
  if (draw_info->density != (char *) NULL)
  {
    GeometryInfo
      geometry_info;

    MagickStatusType
      flags_status;

    flags_status=ParseGeometry(draw_info->density,&geometry_info);
    if ((flags_status & SigmaValue) != 0)
    {
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.sigma;
    }
    else
    {
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.rho;
    }
  }

  ft_status=FT_Set_Char_Size(face,
    (FT_F26Dot6) (64.0*draw_info->pointsize),
    (FT_F26Dot6) (64.0*draw_info->pointsize),
    (FT_UInt) floor(resolution.x+0.5),
    (FT_UInt) floor(resolution.y+0.5));
  if (ft_status != 0)
  {
    (void) FT_Done_Face(face);
    (void) FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,img->filename);
    return(MagickFalse);
  }

  /*
    Initialize the TypeMetric structure.
  */
  metrics->ascent=(double) face->size->metrics.ascender/64.0;
  metrics->descent=(double) (-face->size->metrics.descender)/64.0;
  metrics->width=0.0;
  metrics->height=(double) face->size->metrics.height/64.0;
  metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
  if (metrics->ascent < 0.0)
    metrics->ascent=0.0;
  if (metrics->descent < 0.0)
    metrics->descent=0.0;
  metrics->underline_position=(double) face->underline_position/64.0;
  metrics->underline_thickness=(double) face->underline_thickness/64.0;

  /*
    If there is no text or the font has no glyphs, skip rendering.
  */
  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
      (face->num_glyphs == 0))
  {
    (void) FT_Done_Face(face);
    (void) FT_Done_FreeType(library);
    return(MagickTrue);
  }

  /*
    Configure rendering options (anti-aliasing, hinting) and prepare glyphs.
  */
  flags=FT_LOAD_DEFAULT;
  if (img->storage_class == PseudoClass)
    flags=FT_LOAD_MONOCHROME;
  if (face->glyph->format != FT_GLYPH_FORMAT_OUTLINE)
    flags|=FT_LOAD_RENDER;

  /*
    Apply affine transformations if specified.
  */
  affine.xx=(FT_Fixed) (65536.0*draw_info->affine.sx);
  affine.xy=(FT_Fixed) (65536.0*draw_info->affine.rx);
  affine.yx=(FT_Fixed) (65536.0*draw_info->affine.ry);
  affine.yy=(FT_Fixed) (65536.0*draw_info->affine.sy);
  FT_Set_Transform(face,&affine,(FT_Vector *) NULL);

  /*
    Layout complex text (if supported) or simple text, then render glyphs.
  */
  length=strlen(draw_info->text);
  if (length != 0)
    (void) ComplexTextLayout(img,draw_info,draw_info->text,length,face,
      flags,&grapheme,exception);

  /*
    Rendering loop and bounding box updates will follow here.
  */