if (encoding != (const char *) NULL)
    {
      if (LocaleCompare(encoding,"Adobe Standard") == 0)
        encoding_type=FT_ENCODING_ADOBE_STANDARD;
      else if (LocaleCompare(encoding,"Apple Roman") == 0)
        encoding_type=FT_ENCODING_APPLE_ROMAN;
      else if (LocaleCompare(encoding,"Big5") == 0)
        encoding_type=FT_ENCODING_BIG5;
      else if (LocaleCompare(encoding,"GB2312") == 0)
        encoding_type=FT_ENCODING_GB2312;
      else if (LocaleCompare(encoding,"Johab") == 0)
        encoding_type=FT_ENCODING_JOHAB;
      else if (LocaleCompare(encoding,"SJIS") == 0)
        encoding_type=FT_ENCODING_SJIS;
      else if (LocaleCompare(encoding,"Unicode") == 0)
        encoding_type=FT_ENCODING_UNICODE;
      else if (LocaleCompare(encoding,"Wansung") == 0)
        encoding_type=FT_ENCODING_WANSUNG;
      if (encoding_type != FT_ENCODING_UNICODE)
        {
          ft_status=FT_Select_Charmap(face,encoding_type);
          if (ft_status != 0)
            {
              FT_Done_Face(face);
              FT_Done_FreeType(library);
              ThrowFreetypeErrorException("UnrecognizedFontEncoding",ft_status,
                args.pathname);
              return(MagickFalse);
            }
        }
    }
  resolution.x=draw_info->resolution.x != 0.0 ? draw_info->resolution.x : 96.0;
  resolution.y=draw_info->resolution.y != 0.0 ? draw_info->resolution.y : 96.0;
  if (draw_info->density != (char *) NULL)
    (void) ParseGeometry(draw_info->density,&resolution.x,&resolution.y);
  ft_status=FT_Set_Char_Size(face,0,(FT_F26Dot6) (draw_info->pointsize*64.0),
    (FT_UInt) (resolution.x+0.5),(FT_UInt) (resolution.y+0.5));
  if (ft_status != 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,
        args.pathname);
      return(MagickFalse);
    }
  metrics->ascent=(double) face->size->metrics.ascender/64.0;
  metrics->descent=(double) (-face->size->metrics.descender)/64.0;
  metrics->width=(double) face->size->metrics.max_advance/64.0;
  metrics->height=(double) (face->size->metrics.ascender-
    face->size->metrics.descender)/64.0;
  metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
  if ((face->size->metrics.ascender == 0) && (face->size->metrics.descender == 0))
    {
      metrics->ascent=(double) face->ascender*(double) face->size->metrics.y_ppem/
        (double) face->units_per_EM;
      metrics->descent=(double) (-face->descender)*(double)
        face->size->metrics.y_ppem/(double) face->units_per_EM;
    }
  metrics->underline_position=(double) face->underline_position/64.0;
  metrics->underline_thickness=(double) face->underline_thickness/64.0;
  if ((draw_info->text == (const char *) NULL) || (*draw_info->text == '\0') ||
      (face->num_glyphs == 0))
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickTrue);
    }
  flags=FT_LOAD_DEFAULT;
  if ((img->interlace != NoInterlace) || (draw_info->text_antialias == MagickFalse))
    flags|=FT_LOAD_NO_HINTING;
  grapheme=(GraphemeInfo *) NULL;
  length=ComplexTextLayout(img,draw_info,draw_info->text,strlen(draw_info->text),
    face,flags,&grapheme,exception);
  if (length == 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickFalse);
    }
  origin.x=0;
  origin.y=0;
  for (i=0; i < (ssize_t) length; i++)
  {
    (void) FT_Load_Glyph(face,(FT_UInt) grapheme[i].index,flags);
    (void) FT_Get_Glyph(face->glyph,&glyph.image);
    glyph.id=(FT_UInt) grapheme[i].index;
    glyph.origin.x=(FT_Pos) (grapheme[i].x_offset+origin.x);
    glyph.origin.y=(FT_Pos) (grapheme[i].y_offset+origin.y);
    origin.x+=grapheme[i].x_advance;
    origin.y+=grapheme[i].y_advance;
    if (grapheme[i].x_advance != 0)
      {
        if (TraceGlyph(img,draw_info,&glyph,offset,&OutlineMethods,exception) == MagickFalse)
          status=MagickFalse;
      }
    FT_Done_Glyph(glyph.image);
  }
  if (grapheme != (GraphemeInfo *) NULL)
    grapheme=(GraphemeInfo *) RelinquishMagickMemory(grapheme);
  bounds.xMin=0;
  bounds.yMin=0;
  bounds.xMax=(FT_Pos) (origin.x+0.5);
  bounds.yMax=(FT_Pos) (origin.y+0.5);
  metrics->width=(double) (bounds.xMax-bounds.xMin)/64.0;
  metrics->height=(double) (bounds.yMax-bounds.yMin)/64.0;
  FT_Done_Face(face);
  FT_Done_FreeType(library);