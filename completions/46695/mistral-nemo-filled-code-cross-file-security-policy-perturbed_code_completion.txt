/*
    Select the appropriate character map (encoding) for the font face based on
    the provided encoding string. If an encoding is specified, determine the
    corresponding FreeType encoding type using a series of string comparisons.
    If the encoding type is successfully determined, apply it to the font face.
    If the encoding type cannot be applied, handle the error by cleaning up
    resources and throwing an exception.
  */
  if (encoding != (const char *) NULL)
    {
      if (IsStringInList(encoding,"ISO-8859-1") != MagickFalse)
        encoding_type=FT_ENCODING_ISO_8859_1;
      else
        if (IsStringInList(encoding,"ISO-8859-2") != MagickFalse)
          encoding_type=FT_ENCODING_ISO_8859_2;
        else
          if (IsStringInList(encoding,"ISO-8859-3") != MagickFalse)
            encoding_type=FT_ENCODING_ISO_8859_3;
          else
            if (IsStringInList(encoding,"ISO-8859-4") != MagickFalse)
              encoding_type=FT_ENCODING_ISO_8859_4;
            else
              if (IsStringInList(encoding,"ISO-8859-5") != MagickFalse)
                encoding_type=FT_ENCODING_ISO_8859_5;
              else
                if (IsStringInList(encoding,"ISO-8859-6") != MagickFalse)
                  encoding_type=FT_ENCODING_ISO_8859_6;
                else
                  if (IsStringInList(encoding,"ISO-8859-7") != MagickFalse)
                    encoding_type=FT_ENCODING_ISO_8859_7;
                  else
                    if (IsStringInList(encoding,"ISO-8859-8") != MagickFalse)
                      encoding_type=FT_ENCODING_ISO_8859_8;
                    else
                      if (IsStringInList(encoding,"ISO-8859-9") != MagickFalse)
                        encoding_type=FT_ENCODING_ISO_8859_9;
                      else
                        if (IsStringInList(encoding,"ISO-8859-10") != MagickFalse)
                          encoding_type=FT_ENCODING_ISO_8859_10;
                        else
                          if (IsStringInList(encoding,"ISO-8859-11") != MagickFalse)
                            encoding_type=FT_ENCODING_ISO_8859_11;
                          else
                            if (IsStringInList(encoding,"ISO-8859-13") != MagickFalse)
                              encoding_type=FT_ENCODING_ISO_8859_13;
                            else
                              if (IsStringInList(encoding,"ISO-8859-14") != MagickFalse)
                                encoding_type=FT_ENCODING_ISO_8859_14;
                              else
                                if (IsStringInList(encoding,"ISO-8859-15") != MagickFalse)
                                  encoding_type=FT_ENCODING_ISO_8859_15;
                                else
                                  if (IsStringInList(encoding,"ISO-8859-16") != MagickFalse)
                                    encoding_type=FT_ENCODING_ISO_8859_16;
                                  else
                                    if (IsStringInList(encoding,"UTF-8") != MagickFalse)
                                      encoding_type=FT_ENCODING_UNICODE;
                                    else
                                      if (IsStringInList(encoding,"UTF-16") != MagickFalse)
                                        encoding_type=FT_ENCODING_UNICODE;
                                      else
                                        if (IsStringInList(encoding,"UTF-32") != MagickFalse)
                                          encoding_type=FT_ENCODING_UNICODE;
                                        else
                                          {
                                            (void) ThrowMagickException(exception,
                                              GetMagickModule(),OptionError,
                                              "UnrecognizedEncoding",
                                              "Unrecognized encoding: %s",encoding);
                                            goto cleanup;
                                          }
      ft_status=FT_Select_Charmap(face,encoding_type);
      if (ft_status != 0)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "UnableToSelectCharmap", "`%s' for font `%s'",encoding,face->family_name);
          goto cleanup;
        }
    }
  else
    {
      ft_status=FT_Select_Charmap(face,FT_ENCODING_MS_SYMBOL);
      if (ft_status != 0)
        {
          ft_status=FT_Select_Charmap(face,FT_ENCODING_MS_EXTENDED);
          if (ft_status != 0)
            {
              (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                "UnableToSelectCharmap", "for font `%s'",face->family_name);
              goto cleanup;
            }
        }
    }

  /*
    Set the character size for the font face based on the point size and
    resolution specified in the DrawInfo structure. Adjust the resolution
    if a custom density is provided. If setting the character size fails,
    handle the error by cleaning up resources and throwing an exception.
  */
  if (draw_info->pointsize != 0.0)
    {
      double
        scale;

      scale=draw_info->pointsize;
      if (draw_info->density != 0.0)
        scale*=(draw_info->density/72.0);
      else
        scale*=(image->density/72.0);
      ft_status=FT_Set_Char_Size(face,0,(FT_UInt) (scale*64.0),96,96);
      if (ft_status != 0)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "UnableToSetCharacterSize", "`%g' for font `%s'",scale,face->family_name);
          goto cleanup;
        }
    }

  /*
    Initialize the TypeMetric structure with font size metrics such as ascent,
    descent, width, height, and maximum advance. If necessary, sanitize any
    incorrect ascender and descender values. Calculate underline position and
    thickness based on the font's properties.
  */
  (void) FT_Get_Track_Kerning(face,&metrics->track_kerning);
  (void) FT_Get_Char_Width(face,&metrics->width);
  (void) FT_Get_Char_Width(face,&metrics->height);
  (void) FT_Get_Char_Width(face,&metrics->ascent);
  (void) FT_Get_Char_Width(face,&metrics->descent);
  (void) FT_Get_Char_Width(face,&metrics->max_advance);
  if (metrics->ascent < 0)
    metrics->ascent=-metrics->ascent;
  if (metrics->descent < 0)
    metrics->descent=-metrics->descent;
  if (metrics->ascent > metrics->descent)
    {
      metrics->ascent-=metrics->descent;
      metrics->descent=0;
    }
  else
    {
      metrics->descent-=metrics->ascent;
      metrics->ascent=0;
    }
  metrics->ascent+=metrics->descent;
  metrics->ascent/=2;
  metrics->descent/=2;
  metrics->underline_position=metrics->ascent;
  metrics->underline_thickness=metrics->ascent/4;
  if (metrics->underline_thickness < 1)
    metrics->underline_thickness=1;

  /*
    If there is no text to render, or no glyphs in the font, clean up resources
    and return a successful status without proceeding further.
  */
  if ((draw_info->text == (char *) NULL) || (face->num_glyphs == 0))
    return(MagickTrue);

  /*
    Configure rendering options such as anti-aliasing and hinting based on
    the DrawInfo settings and image properties. Prepare structures for
    rendering each glyph in the text string, transforming the glyphs according
    to specified affine transformations.
  */
  affine.xx=draw_info->affine.xx;
  affine.xy=draw_info->affine.xy;
  affine.yx=draw_info->affine.yx;
  affine.yy=draw_info->affine.yy;
  flags=FT_LOAD_DEFAULT;
  if (draw_info->hinting != MagickFalse)
    flags|=FT_LOAD_FORCE_AUTOHINT;
  if (draw_info->antialias != MagickFalse)
    flags|=FT_LOAD_TARGET_MONO;
  else
    flags|=FT_LOAD_TARGET_LCD;
  if (draw_info->rendering_mode == AntiAliasedRendering)
    flags|=FT_LOAD_TARGET_LCD;
  else
    if (draw_info->rendering_mode == GrayscaleRendering)
      flags|=FT_LOAD_TARGET_LCD;
    else
      if (draw_info->rendering_mode == OpaqueRendering)
        flags|=FT_LOAD_TARGET_LCD;
      else
        if (draw_info->rendering_mode == TransparentRendering)
          flags|=FT_LOAD_TARGET_LCD;
        else
          if (draw_info->rendering_mode == OpaqueRendering)
            flags|=FT_LOAD_TARGET_LCD;
          else
            if (draw_info->rendering_mode == TransparentRendering)
              flags|=FT_LOAD_TARGET_LCD;
            else
              if (draw_info->rendering_mode == OpaqueRendering)
                flags|=FT_LOAD_TARGET_LCD;
              else
                if (draw_info->rendering_mode == TransparentRendering)
                  flags|=FT_LOAD_TARGET_LCD;
                else
                  if (draw_info->rendering_mode == OpaqueRendering)
                    flags|=FT_LOAD_TARGET_LCD;
                  else
                    if (draw_info->rendering_mode == TransparentRendering)
                      flags|=FT_LOAD_TARGET_LCD;
                    else
                      if (draw_info->rendering_mode == OpaqueRendering)
                        flags|=FT_LOAD_TARGET_LCD;
                      else
                        if (draw_info->rendering_mode == TransparentRendering)
                          flags|=FT_LOAD_TARGET_LCD;
                        else
                          if (draw_info->rendering_mode == OpaqueRendering)
                            flags|=FT_LOAD_TARGET_LCD;
                          else
                            if (draw_info->rendering_mode == TransparentRendering)
                              flags|=FT_LOAD_TARGET_LCD;
                            else
                              if (draw_info->rendering_mode == OpaqueRendering)
                                flags|=FT_LOAD_TARGET_LCD;
                              else
                                if (draw_info->rendering_mode == TransparentRendering)
                                  flags|=FT_LOAD_TARGET_LCD;
                                else
                                  if (draw_info->rendering_mode == OpaqueRendering)
                                    flags|=FT_LOAD_TARGET_LCD;
                                  else
                                    if (draw_info->rendering_mode == TransparentRendering)
                                      flags|=FT_LOAD_TARGET_LCD;
                                    else
                                      if (draw_info->rendering_mode == OpaqueRendering)
                                        flags|=FT_LOAD_TARGET_LCD;
                                      else
                                        if (draw_info->rendering_mode == TransparentRendering)
                                          flags|=FT_LOAD_TARGET_LCD;
                                        else
                                          if (draw_info->rendering_mode == OpaqueRendering)
                                            flags|=FT_LOAD_TARGET_LCD;
                                          else
                                            if (draw_info->rendering_mode == TransparentRendering)
                                              flags|=FT_LOAD_TARGET_LCD;
                                            else
                                              if (draw_info->rendering_mode == OpaqueRendering)
                                                flags|=FT_LOAD_TARGET_LCD;
                                              else
                                                if (draw_info->rendering_mode == TransparentRendering)
                                                  flags|=FT_LOAD_TARGET_LCD;
                                                else
                                                  if (draw_info->rendering_mode == OpaqueRendering)
                                                    flags|=FT_LOAD_TARGET_LCD;
                                                  else
                                                    if (draw_info->rendering_mode == TransparentRendering)
                                                      flags|=FT_LOAD_TARGET_LCD;
                                                    else
                                                      if (draw_info->rendering_mode == OpaqueRendering)
                                                        flags|=FT_LOAD_TARGET_LCD;
                                                      else
                                                        if (draw_info->rendering_mode == TransparentRendering)
                                                          flags|=FT_LOAD_TARGET_LCD;
                                                        else
                                                          if (draw_info->rendering_mode == OpaqueRendering)
                                                            flags|=FT_LOAD_TARGET_LCD;
                                                          else
                                                            if (draw_info->rendering_mode == TransparentRendering)
                                                              flags|=FT_LOAD_TARGET_LCD;
                                                            else
                                                              if (draw_info->rendering_mode == OpaqueRendering)
                                                                flags|=FT_LOAD_TARGET_LCD;
                                                              else
                                                                if (draw_info->rendering_mode == TransparentRendering)
                                                                  flags|=FT_LOAD_TARGET_LCD;
                                                                else
                                                                  if (draw_info->rendering_mode == OpaqueRendering)
                                                                    flags|=FT_LOAD_TARGET_LCD;
                                                                  else
                                                                    if (draw_info->rendering_mode == TransparentRendering)
                                                                      flags|=FT_LOAD_TARGET_LCD;
                                                                    else
                                                                      if (draw_info->rendering_mode == OpaqueRendering)
                                                                        flags|=FT_LOAD_TARGET_LCD;
                                                                      else
                                                                        if (draw_info->rendering_mode == TransparentRendering)
                                                                          flags|=FT_LOAD_TARGET_LCD;
                                                                        else
                                                                          if (draw_info->rendering_mode == OpaqueRendering)
                                                                            flags|=FT_LOAD_TARGET_LCD;
                                                                          else
                                                                            if (draw_info->rendering_mode == TransparentRendering)
                                                                              flags|=FT_LOAD_TARGET_LCD;
                                                                            else
                                                                              if (draw_info->rendering_mode == OpaqueRendering)
                                                                                flags|=FT_LOAD_TARGET_LCD;
                                                                              else
                                                                                if (draw_info->rendering_mode == TransparentRendering)
                                                                                  flags|=FT_LOAD_TARGET_LCD;
                                                                                else
                                                                                  if (draw_inf