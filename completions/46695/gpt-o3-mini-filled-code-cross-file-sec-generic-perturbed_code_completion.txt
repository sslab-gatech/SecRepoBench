/* Select the appropriate character map encoding if specified */
  if (encoding != (const char *) NULL)
  {
    if (LocaleCompare(encoding,"unicode") == 0)
      encoding_type = FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"symbol") == 0)
      encoding_type = FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"gb2312") == 0)
      encoding_type = FT_ENCODING_GB2312;
    else if (LocaleCompare(encoding,"shiftjis") == 0)
      encoding_type = FT_ENCODING_SJIS;
    else
      encoding_type = FT_ENCODING_UNICODE;
    ft_status = FT_Select_Charmap(face,encoding_type);
    if (ft_status != 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSelectCharmap",ft_status,encoding);
      return(MagickFalse);
    }
  }

  /* Set the character size based on point size and resolution (density) */
  resolution.x = (draw_info->density.x > 0.0 ? draw_info->density.x : 72.0);
  resolution.y = (draw_info->density.y > 0.0 ? draw_info->density.y : 72.0);
  ft_status = FT_Set_Char_Size(face, 0, (FT_F26Dot6)(draw_info->pointsize*64),
                                (FT_UInt) resolution.x, (FT_UInt) resolution.y);
  if (ft_status != 0)
  {
    FT_Done_Face(face);
    FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,draw_info->font);
    return(MagickFalse);
  }

  /* Initialize the font metrics */
  metrics->ascent             = (double) face->size->metrics.ascender/64.0;
  metrics->descent            = (double) face->size->metrics.descender/64.0;
  metrics->width              = (double) face->size->metrics.max_advance/64.0;
  metrics->height             = metrics->ascent - metrics->descent;
  metrics->underline_position = (double) face->underline_position/64.0;
  metrics->underline_thickness= (double) face->underline_thickness/64.0;

  /* If there is no text to render, cleanup and return successfully */
  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0'))
  {
    FT_Done_Face(face);
    FT_Done_FreeType(library);
    return(MagickTrue);
  }

  /* Render the text glyphs */
#if defined(MAGICKCORE_RAQM_DELEGATE)
  {
    size_t glyph_count;
    grapheme = (GraphemeInfo *) NULL;
    glyph_count = ComplexTextLayout(img, draw_info, draw_info->text,
                                    strlen(draw_info->text), face,
                                    FT_LOAD_DEFAULT, &grapheme, exception);
    if (glyph_count == 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickTrue);
    }
    for (i = 0; i < (ssize_t) glyph_count; i++)
    {
      ft_status = FT_Load_Glyph(face, (FT_UInt) grapheme[i].index, FT_LOAD_DEFAULT);
      if (ft_status != 0)
      {
        if (grapheme != (GraphemeInfo *) NULL)
          grapheme = (GraphemeInfo *) RelinquishMagickMemory(grapheme);
        FT_Done_Face(face);
        FT_Done_FreeType(library);
        ThrowFreetypeErrorException("UnableToLoadGlyph", ft_status, draw_info->text);
        return(MagickFalse);
      }
      ft_status = FT_Render_Glyph(face->glyph, FT_RENDER_MODE_NORMAL);
      if (ft_status != 0)
      {
        if (grapheme != (GraphemeInfo *) NULL)
          grapheme = (GraphemeInfo *) RelinquishMagickMemory(grapheme);
        FT_Done_Face(face);
        FT_Done_FreeType(library);
        ThrowFreetypeErrorException("UnableToRenderGlyph", ft_status, draw_info->text);
        return(MagickFalse);
      }
      /* Composite the rendered glyph bitmap onto the image.
         CompositeGlyphImage is assumed to securely handle the glyph compositing. */
      status = CompositeGlyphImage(img, face->glyph, offset, draw_info);
      if (status == MagickFalse)
        break;
    }
    if (grapheme != (GraphemeInfo *) NULL)
      grapheme = (GraphemeInfo *) RelinquishMagickMemory(grapheme);
  }
#else
  {
    for (p = draw_info->text; *p != '\0'; p += GetUTFOctets(p))
    {
      code = GetUTFCode(p);
      if (code == 0)
        break;
      glyph.id = FT_Get_Char_Index(face, (FT_ULong) code);
      if (glyph.id == 0)
        continue;
      ft_status = FT_Load_Glyph(face, glyph.id, FT_LOAD_DEFAULT);
      if (ft_status != 0)
      {
        FT_Done_Face(face);
        FT_Done_FreeType(library);
        ThrowFreetypeErrorException("UnableToLoadGlyph", ft_status, draw_info->text);
        return(MagickFalse);
      }
      ft_status = FT_Render_Glyph(face->glyph, FT_RENDER_MODE_NORMAL);
      if (ft_status != 0)
      {
        FT_Done_Face(face);
        FT_Done_FreeType(library);
        ThrowFreetypeErrorException("UnableToRenderGlyph", ft_status, draw_info->text);
        return(MagickFalse);
      }
      status = CompositeGlyphImage(img, face->glyph, offset, draw_info);
      if (status == MagickFalse)
        break;
    }
  }
#endif

  FT_Done_Face(face);
  FT_Done_FreeType(library);
  return(status);