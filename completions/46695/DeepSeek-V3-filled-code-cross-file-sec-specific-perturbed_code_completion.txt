if (encoding != (const char *) NULL)
    {
      if (LocaleCompare(encoding,"AdobeCustom") == 0)
        encoding_type=FT_ENCODING_ADOBE_CUSTOM;
      else if (LocaleCompare(encoding,"AdobeExpert") == 0)
        encoding_type=FT_ENCODING_ADOBE_EXPERT;
      else if (LocaleCompare(encoding,"AdobeStandard") == 0)
        encoding_type=FT_ENCODING_ADOBE_STANDARD;
      else if (LocaleCompare(encoding,"AppleRoman") == 0)
        encoding_type=FT_ENCODING_APPLE_ROMAN;
      else if (LocaleCompare(encoding,"Big5") == 0)
        encoding_type=FT_ENCODING_BIG5;
      else if (LocaleCompare(encoding,"GB2312") == 0)
        encoding_type=FT_ENCODING_GB2312;
      else if (LocaleCompare(encoding,"JISX0208") == 0)
        encoding_type=FT_ENCODING_JISX0208;
      else if (LocaleCompare(encoding,"JISX0212") == 0)
        encoding_type=FT_ENCODING_JISX0212;
      else if (LocaleCompare(encoding,"Latin2") == 0)
        encoding_type=FT_ENCODING_LATIN2;
      else if (LocaleCompare(encoding,"None") == 0)
        encoding_type=FT_ENCODING_NONE;
      else if (LocaleCompare(encoding,"Symbol") == 0)
        encoding_type=FT_ENCODING_SYMBOL;
      else if (LocaleCompare(encoding,"Unicode") == 0)
        encoding_type=FT_ENCODING_UNICODE;
      else if (LocaleCompare(encoding,"Wansung") == 0)
        encoding_type=FT_ENCODING_WANSUNG;
      ft_status=FT_Select_Charmap(face,encoding_type);
      if (ft_status != 0)
        {
          FT_Done_Face(face);
          FT_Done_FreeType(library);
          ThrowFreetypeErrorException("UnableToSetEncoding",ft_status,encoding);
          return(MagickFalse);
        }
    }

  resolution.x=draw_info->density != (char *) NULL ? 72.0 : 96.0;
  resolution.y=resolution.x;
  if (draw_info->density != (char *) NULL)
    (void) sscanf(draw_info->density,"%lfx%lf",&resolution.x,&resolution.y);
  ft_status=FT_Set_Char_Size(face,0,(FT_F26Dot6) (draw_info->pointsize*64.0),
    (FT_UInt) resolution.x,(FT_UInt) resolution.y);
  if (ft_status != 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,
        draw_info->font);
      return(MagickFalse);
    }

  if (metrics != (TypeMetric *) NULL)
    {
      metrics->pixels_per_em=face->size->metrics.y_ppem;
      metrics->ascent=(double) face->size->metrics.ascender/64.0;
      metrics->descent=(double) -face->size->metrics.descender/64.0;
      metrics->width=(double) face->size->metrics.max_advance/64.0;
      metrics->height=(double) (face->size->metrics.ascender-
        face->size->metrics.descender)/64.0;
      metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
      if (face->underline_position != 0)
        metrics->underline_position=(double) face->underline_position/64.0;
      else
        metrics->underline_position=(-metrics->descent)/2.0;
      if (face->underline_thickness != 0)
        metrics->underline_thickness=(double) face->underline_thickness/64.0;
      else
        metrics->underline_thickness=metrics->height/12.0;
    }

  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
      (face->num_glyphs == 0))
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickTrue);
    }

  flags=FT_LOAD_DEFAULT;
  if ((draw_info->style & AnyStyle) == NoStyle)
    flags|=FT_LOAD_NO_HINTING;
  if ((draw_info->style & AnyStyle) == ItalicStyle)
    flags|=FT_LOAD_NO_BITMAP;
  if ((draw_info->style & AnyStyle) == BoldStyle)
    flags|=FT_LOAD_TARGET_LIGHT;
  if ((draw_info->style & AnyStyle) == ObliqueStyle)
    flags|=FT_LOAD_TARGET_NORMAL;

  utf8=GetUTF8String(draw_info->text,&length);
  if (utf8 == (unsigned char *) NULL)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      ThrowFileException(exception,ResourceLimitError,"MemoryAllocationFailed",
        draw_info->text);
      return(MagickFalse);
    }

  grapheme=(GraphemeInfo *) NULL;
  length=ComplexTextLayout(img,draw_info,(const char *) utf8,length,face,flags,
    &grapheme,exception);
  utf8=(unsigned char *) RelinquishMagickMemory(utf8);
  if (length == 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickFalse);
    }

  origin.x=0;
  origin.y=0;
  bounds.xMin=0;
  bounds.yMin=0;
  bounds.xMax=0;
  bounds.yMax=0;
  for (i=0; i < (ssize_t) length; i++)
  {
    glyph.id=(FT_UInt) grapheme[i].index;
    if (glyph.id == 0)
      continue;
    glyph.origin.x=origin.x+grapheme[i].x_offset;
    glyph.origin.y=origin.y+grapheme[i].y_offset;
    ft_status=FT_Load_Glyph(face,glyph.id,flags);
    if (ft_status != 0)
      continue;
    ft_status=FT_Get_Glyph(face->glyph,&glyph.image);
    if (ft_status != 0)
      continue;
    FT_Glyph_Get_CBox(glyph.image,ft_glyph_bbox_pixels,&bounds);
    FT_Done_Glyph(glyph.image);
    origin.x+=grapheme[i].x_advance;
  }
  grapheme=(GraphemeInfo *) RelinquishMagickMemory(grapheme);

  if (metrics != (TypeMetric *) NULL)
    {
      metrics->bounds.x1=(double) bounds.xMin;
      metrics->bounds.y1=(double) bounds.yMin;
      metrics->bounds.x2=(double) bounds.xMax;
      metrics->bounds.y2=(double) bounds.yMax;
      metrics->width=(double) origin.x/64.0;
    }

  FT_Done_Face(face);
  FT_Done_FreeType(library);
  return(MagickTrue);