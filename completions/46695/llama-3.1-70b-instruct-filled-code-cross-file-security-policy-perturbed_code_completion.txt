// Select the appropriate character map (encoding) for the font face based on
// the provided encoding string.
if (LocaleCompare(encoding,"ISO-8859-1") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-2") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-3") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-4") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-5") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-6") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-7") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-8") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-9") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-10") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-11") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-13") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-14") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-15") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"ISO-8859-16") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"KOI8-R") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"KOI8-U") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"KOI8-RU") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"KOI8-T") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1250") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1251") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1252") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1253") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1254") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1255") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1256") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1257") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP1258") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP874") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP932") == 0)
  encoding_type=FT_ENCODING_SJIS;
else if (LocaleCompare(encoding,"CP936") == 0)
  encoding_type=FT_ENCODING_GB2312;
else if (LocaleCompare(encoding,"CP949") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"CP950") == 0)
  encoding_type=FT_ENCODING_BIG5;
else if (LocaleCompare(encoding,"CP1361") == 0)
  encoding_type=FT_ENCODING_JOHAB;
else if (LocaleCompare(encoding,"SJIS") == 0)
  encoding_type=FT_ENCODING_SJIS;
else if (LocaleCompare(encoding,"BIG5") == 0)
  encoding_type=FT_ENCODING_BIG5;
else if (LocaleCompare(encoding,"BIG5-HKSCS") == 0)
  encoding_type=FT_ENCODING_BIG5;
else if (LocaleCompare(encoding,"GB2312") == 0)
  encoding_type=FT_ENCODING_GB2312;
else if (LocaleCompare(encoding,"GBK") == 0)
  encoding_type=FT_ENCODING_GB2312;
else if (LocaleCompare(encoding,"GB18030") == 0)
  encoding_type=FT_ENCODING_GB2312;
else if (LocaleCompare(encoding,"JISX0201") == 0)
  encoding_type=FT_ENCODING_JISX0201;
else if (LocaleCompare(encoding,"JISX0208") == 0)
  encoding_type=FT_ENCODING_JISX0208;
else if (LocaleCompare(encoding,"JISX0212") == 0)
  encoding_type=FT_ENCODING_JISX0212;
else if (LocaleCompare(encoding,"JISX0213") == 0)
  encoding_type=FT_ENCODING_JISX0213;
else if (LocaleCompare(encoding,"KSC5601") == 0)
  encoding_type=FT_ENCODING_MS_SYMBOL;
else if (LocaleCompare(encoding,"UNICODE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-8") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-16") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-16BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-16LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-32") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-32BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-32LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-2") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-2BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-2LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-4") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-4BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-4LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"WCHAR_T") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"WCHAR_TBE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"WCHAR_TLE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else
  encoding_type=FT_ENCODING_UNICODE;

ft_status=FT_Select_Charmap(face,encoding_type);
if ((ft_status!= 0) && (face->num_charmaps!= 0))
  ft_status=FT_Set_Charmap(face,face->charmaps[0]);
if (ft_status!= 0)
  {
    (void) FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSelectFontEncoding",ft_status,
      encoding);
    return(MagickFalse);
  }

// Set the character size for the font face based on the point size and
// resolution specified in the DrawInfo structure. Adjust the resolution
// if a custom density is provided.
resolution.x=draw_info->pointsize;
resolution.y=draw_info->pointsize;
if (draw_info->density!= (char *) NULL)
  {
    char
      *p;

    size_t
      width,
      height;

    p=draw_info->density;
    width=StringToUnsignedLong(p,&p);
    if (*p == 'x')
      p++;
    height=StringToUnsignedLong(p,&p);
    resolution.x=(double) draw_info->pointsize*(double) width/72.0;
    resolution.y=(double) draw_info->pointsize*(double) height/72.0;
  }
ft_status=FT_Set_Char_Size(face,(FT_F26Dot6) resolution.x,(FT_F26Dot6)
  resolution.y,(FT_UInt) 0,(FT_UInt) 0);
if (ft_status!= 0)
  {
    (void) FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,
      draw_info->font);
    return(MagickFalse);
  }

// Initialize the TypeMetric structure with font size metrics such as ascent,
// descent, width, height, and maximum advance. If necessary, sanitize any
// incorrect ascender and descender values. Calculate underline position and
// thickness based on the font's properties.
metrics->ascender=(double) face->size->metrics.ascender/64.0;
metrics->descender=(double) face->size->metrics.descender/64.0;
metrics->width=(double) face->size->metrics.width/64.0;
metrics->height=(double) face->size->metrics.height/64.0;
metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
if (metrics->ascender < 0.0)
  metrics->ascender=0.0;
if (metrics->descender > 0.0)
  metrics->descender=0.0;
metrics->underline_position=(double) face->underline_position/64.0;
metrics->underline_thickness=(double) face->underline_thickness/64.0;

// If there is no text to render, or no glyphs in the font, clean up resources
// and return a successful status without proceeding further.
if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
    (face->num_glyphs == 0))
  {
    (void) FT_Done_FreeType(library);
    return(MagickTrue);
  }

// Configure rendering options such as anti-aliasing and hinting based on
// the DrawInfo settings and image properties. Prepare structures for
// rendering each glyph in the text string, transforming the glyphs according
// to specified affine transformations.
flags=FT_LOAD_RENDER;
if (draw_info->stroke_width!= 0.0)
  flags|=FT_LOAD_NO_BITMAP;
if (draw_info->stroke_antialias == MagickFalse)
  flags|=FT_LOAD_MONOCHROME;
if (draw_info->fill_antialias == MagickFalse)
  flags|=FT_LOAD_MONOCHROME;
if (draw_info->hinting == MagickFalse)
  flags|=FT_LOAD_NO_HINTING;
if (draw_info->no_stem_darkening == MagickTrue)
  flags|=FT_LOAD_NO_STEM_DARKENING;
if (draw_info->no_auto_hinting == MagickTrue)
  flags|=FT_LOAD_NO_AUTOHINT;
if (draw_info->force_auto_hinting == MagickTrue)
  flags|=FT_LOAD_FORCE_AUTOHINT;
if (draw_info->lcd_filter == MagickTrue)
  flags|=FT_LOAD_TARGET_LCD;
if (draw_info->lcd_filter_best == MagickTrue)
  flags|=FT_LOAD_TARGET_LCD;
if (draw_info->no_lcd_filter == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_lcd_filter_best == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->light == MagickTrue)
  flags|=FT_LOAD_TARGET_LIGHT;
if (draw_info->mono == MagickTrue)
  flags|=FT_LOAD_TARGET_MONO;
if (draw_info->normal == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_normal == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_mono == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_light == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_lcd == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_lcd_best == MagickTrue)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->no_hinting == MagickTrue)
  flags|=FT_LOAD_NO_HINTING;
if (draw_info->no_auto_hinting == MagickTrue)
  flags|=FT_LOAD_NO_AUTOHINT;
if (draw_info->no_stem_darkening == MagickTrue)
  flags|=FT_LOAD_NO_STEM_DARKENING;
if (draw_info->no_bitmap == MagickTrue)
  flags|=FT_LOAD_NO_BITMAP;
if (draw_info->no_scale == MagickTrue)
  flags|=FT_LOAD_NO_SCALE;
if (draw_info->no_horizontal == MagickTrue)
  flags|=FT_LOAD_NO_HORIZONTAL;
if (draw_info->no_vertical == MagickTrue)
  flags|=FT_LOAD_NO_VERTICAL;
if (draw_info->no_native == MagickTrue)
  flags|=FT_LOAD_NO_NATIVE;
if (draw_info->no_outline == MagickTrue)
  flags|=FT_LOAD_NO_OUTLINE;
if (draw_info->no_composites == MagickTrue)
  flags|=FT_LOAD_NO_COMPOSITES;
if (draw_info->no_auto_advance == MagickTrue)
  flags|=FT_LOAD_NO_AUTO_ADVANCE;
if (draw_info->no_reuse == MagickTrue)
  flags|=FT_LOAD_NO_REUSE;
if (draw_info->no_bitmaps == MagickTrue)
  flags|=FT_LOAD_NO_BITMAP;
if (draw_info->no_sbits == MagickTrue)
  flags|=FT_LOAD_NO_SBITS;
if (draw_info->no_horizontal == MagickTrue)
  flags|=FT_LOAD_NO_HORIZONTAL;
if (draw_info->no_vertical == MagickTrue)
  flags|=FT_LOAD_NO_VERTICAL;
if (draw_info->no_native == MagickTrue)
  flags|=FT_LOAD_NO_NATIVE;
if (draw_info->no_outline == MagickTrue)
  flags|=FT_LOAD_NO_OUTLIN