// <MASK>
  // Select the appropriate character map (encoding) for the font face based on
  // the provided encoding string. If an encoding is specified, determine the
  // corresponding FreeType encoding type using a series of string comparisons.
  // If the encoding type is successfully determined, apply it to the font face.
  // If the encoding type cannot be applied, handle the error by cleaning up
  // resources and throwing an exception.
  // 
  // Set the character size for the font face based on the point size and
  // resolution specified in the DrawInfo structure. Adjust the resolution
  // if a custom density is provided. If setting the character size fails,
  // handle the error by cleaning up resources and throwing an exception.
  // 
  // Initialize the TypeMetric structure with font size metrics such as ascent,
  // descent, width, height, and maximum advance. If necessary, sanitize any
  // incorrect ascender and descender values. Calculate underline position and
  // thickness based on the font's properties.
  // 
  // If there is no text to render, or no glyphs in the font, clean up resources
  // and return a successful status without proceeding further.
  // 
  // Configure rendering options such as anti-aliasing and hinting based on
  // the DrawInfo settings and image properties. Prepare structures for
  // rendering each glyph in the text string, transforming the glyphs according
  // to specified affine transformations.
  // 
  // Loop through each character in the text, rendering glyphs, tracing outlines
  // if necessary, and rasterizing the glyphs onto the image. Adjust the
  // position and metrics of each rendered glyph, and update the bounding box
  // of the text as needed. Manage resources and synchronize image data
  // appropriately during the rendering process.
  // 
  // Finalize the font metrics by normalizing the bounding box coordinates and
  // width. Clean up any remaining resources and return the rendering status.
  if ((draw_info->text!= (char *) NULL) && (draw_info->text[0]!= '\0'))
  {
    size_t
      extent;

    GraphemeInfo
      *grapheme;

    extent=ComplexTextLayout(img,draw_info,draw_info->text,
      strlen(draw_info->text),face,flags, &grapheme,exception);
    if (extent == 0)
      {
        (void) FT_Done_FreeType(library);
        return(MagickFalse);
      }
    grapheme=DestroyGraphemeInfo(grapheme);
    if (extent == 0)
      {
        (void) FT_Done_FreeType(library);
        return(MagickFalse);
      }
    for (i=0; i < (ssize_t) extent; i++)
      {
        if (grapheme[i].index!= 0)
          {
            (void) FT_Load_Glyph(face,(FT_UInt) grapheme[i].index,flags);
            glyph.id=grapheme[i].index;
            glyph.origin.x=grapheme[i].x_offset;
            glyph.origin.y=grapheme[i].y_offset;
            glyph.image=face->glyph;
            glyph.image->advance.x=grapheme[i].x_advance;
            glyph.image->advance.y=0;
            glyph.image->advance.x=(FT_Pos) ((draw_info->direction ==
              RightToLeftDirection? -1.0 : 1.0)*glyph.image->advance.x);
            glyph.image->advance.y=(FT_Pos) ((draw_info->direction ==
              RightToLeftDirection? -1.0 : 1.0)*glyph.image->advance.y);
            glyph.image->outline=OutlineMethods;
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_data=(void *) &glyph;
            glyph.image->outline->user_data_size=sizeof(GlyphInfo);
            glyph.image->outline->user_dat