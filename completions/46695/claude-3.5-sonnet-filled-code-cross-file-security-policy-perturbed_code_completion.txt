if (encoding != (const char *) NULL)
  {
    if (LocaleCompare(encoding,"AdobeCustom") == 0)
      encoding_type=FT_ENCODING_ADOBE_CUSTOM;
    if (LocaleCompare(encoding,"AdobeExpert") == 0)
      encoding_type=FT_ENCODING_ADOBE_EXPERT;
    if (LocaleCompare(encoding,"AdobeStandard") == 0)
      encoding_type=FT_ENCODING_ADOBE_STANDARD;
    if (LocaleCompare(encoding,"AppleRoman") == 0)
      encoding_type=FT_ENCODING_APPLE_ROMAN;
    if (LocaleCompare(encoding,"BIG5") == 0)
      encoding_type=FT_ENCODING_BIG5;
    if (LocaleCompare(encoding,"GB2312") == 0)
      encoding_type=FT_ENCODING_PRC;
    if (LocaleCompare(encoding,"Johab") == 0)
      encoding_type=FT_ENCODING_JOHAB;
    if (LocaleCompare(encoding,"MacRoman") == 0)
      encoding_type=FT_ENCODING_APPLE_ROMAN;
    if (LocaleCompare(encoding,"SJIScode") == 0)
      encoding_type=FT_ENCODING_SJIS;
    if (LocaleCompare(encoding,"Symbol") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    if (LocaleCompare(encoding,"Unicode") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    if (LocaleCompare(encoding,"Wansung") == 0)
      encoding_type=FT_ENCODING_WANSUNG;
    ft_status=FT_Select_Charmap(face,encoding_type);
    if (ft_status != 0)
      {
        (void) FT_Done_Face(face);
        (void) FT_Done_FreeType(library);
        ThrowFreetypeErrorException("UnrecognizedFontEncoding",ft_status,
          encoding);
        return(MagickFalse);
      }
  }
  resolution.x=DefaultResolution;
  resolution.y=DefaultResolution;
  if (draw_info->density != (char *) NULL)
    {
      GeometryInfo
        geometry_info;

      MagickStatusType
        flags;

      flags=ParseGeometry(draw_info->density,&geometry_info);
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        resolution.y=resolution.x;
    }
  ft_status=FT_Set_Char_Size(face,(FT_F26Dot6) (64.0*draw_info->pointsize),
    (FT_F26Dot6) (64.0*draw_info->pointsize),(FT_UInt) resolution.x,
    (FT_UInt) resolution.y);
  if (ft_status != 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetCharSize",ft_status,
        draw_info->font);
      return(MagickFalse);
    }
  metrics->pixels_per_em.x=face->size->metrics.x_ppem;
  metrics->pixels_per_em.y=face->size->metrics.y_ppem;
  metrics->ascent=(double) face->size->metrics.ascender/64.0;
  metrics->descent=(double) face->size->metrics.descender/64.0;
  metrics->width=0;
  metrics->origin.x=0;
  metrics->origin.y=0;
  metrics->height=(double) face->size->metrics.height/64.0;
  metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
  if (face->size->metrics.ascender == 0)
    metrics->ascent=(double) face->ascender/64.0;
  if (face->size->metrics.descender == 0)
    metrics->descent=(double) face->descender/64.0;
  if (metrics->height == 0)
    metrics->height=metrics->ascent-metrics->descent;
  metrics->underline_position=face->underline_position/64.0;
  metrics->underline_thickness=face->underline_thickness/64.0;
  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0'))
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  /*
    Render text.
  */
  flags=FT_LOAD_DEFAULT;
  if (draw_info->render == MagickFalse)
    flags=FT_LOAD_NO_BITMAP;
  if (draw_info->text_antialias == MagickFalse)
    flags|=FT_LOAD_TARGET_MONO;
  else
    {
      if (img->storage_class == PseudoClass)
        flags|=FT_LOAD_TARGET_NORMAL;
      else
        flags|=FT_LOAD_TARGET_LCD;
    }
  if (draw_info->style & NoAutohintStyle)
    flags|=FT_LOAD_NO_AUTOHINT;
  value=GetImageProperty(img,"type:hinting",exception);
  if ((value != (const char *) NULL) && (LocaleCompare(value,"off") == 0))
    flags|=FT_LOAD_NO_HINTING;
  glyph.id=0;
  glyph.image=NULL;
  last_glyph_id=0;
  origin.x=0;
  origin.y=0;
  affine.xx=65536L;
  affine.yx=0L;
  affine.xy=0L;
  affine.yy=65536L;
  if (draw_info->render != MagickFalse)
    {
      affine.xx=(FT_Fixed) (65536L*draw_info->affine.sx+0.5);
      affine.yx=(FT_Fixed) (-65536L*draw_info->affine.rx+0.5);
      affine.xy=(FT_Fixed) (-65536L*draw_info->affine.ry+0.5);
      affine.yy=(FT_Fixed) (65536L*draw_info->affine.sy+0.5);
    }
  annotate_info=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  if (annotate_info->dash_pattern != (double *) NULL)
    annotate_info->dash_pattern[0]=0.0;
  (void) CloneString(&annotate_info->primitive,"path '");
  status=MagickTrue;
  if (draw_info->render != MagickFalse)
    {
      if (draw_info->fill.alpha != TransparentAlpha)
        status&=DrawImage(img,annotate_info,exception);
      annotate_info->fill=draw_info->stroke;
      annotate_info->stroke.alpha=TransparentAlpha;
      if (draw_info->stroke.alpha != TransparentAlpha)
        status&=DrawImage(img,annotate_info,exception);
    }
  annotate_info=DestroyDrawInfo(annotate_info);
  /*
    Finish up.
  */
  if (draw_info->render != MagickFalse)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      if (grapheme != (GraphemeInfo *) NULL)
        grapheme=(GraphemeInfo *) RelinquishMagickMemory(grapheme);
      if (utf8 != (unsigned char *) NULL)
        utf8=(unsigned char *) RelinquishMagickMemory(utf8);
      if (status != MagickFalse)
        (void) SyncImage(img,exception);
    }
  /*
    Relinquish resources.
  */
  FTCloseStream(stream);
  stream=(FT_StreamRec *) RelinquishMagickMemory(stream);
  return(status);