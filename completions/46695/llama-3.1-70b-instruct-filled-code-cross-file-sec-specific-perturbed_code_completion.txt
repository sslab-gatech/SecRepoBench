// Select the appropriate character map (encoding) for the font face based on
// the provided encoding string.
if (LocaleCompare(encoding,"ISO-8859-1:1987") == 0)
  encoding_type=FT_ENCODING_ISO_8859_1;
else if (LocaleCompare(encoding,"ISO-8859-2:1987") == 0)
  encoding_type=FT_ENCODING_ISO_8859_2;
else if (LocaleCompare(encoding,"ISO-8859-7:1987") == 0)
  encoding_type=FT_ENCODING_ISO_8859_7;
else if (LocaleCompare(encoding,"ISO-8859-9:1989") == 0)
  encoding_type=FT_ENCODING_ISO_8859_9;
else if (LocaleCompare(encoding,"ISO-8859-13:1998") == 0)
  encoding_type=FT_ENCODING_ISO_8859_13;
else if (LocaleCompare(encoding,"ISO-8859-15:1999") == 0)
  encoding_type=FT_ENCODING_ISO_8859_15;
else if (LocaleCompare(encoding,"SJIS") == 0)
  encoding_type=FT_ENCODING_SJIS;
else if (LocaleCompare(encoding,"MS-SJIS") == 0)
  encoding_type=FT_ENCODING_SJIS;
else if (LocaleCompare(encoding,"Windows-31J") == 0)
  encoding_type=FT_ENCODING_SJIS;
else if (LocaleCompare(encoding,"GBK") == 0)
  encoding_type=FT_ENCODING_GB2312;
else if (LocaleCompare(encoding,"EUC-CN") == 0)
  encoding_type=FT_ENCODING_GB2312;
else if (LocaleCompare(encoding,"Big5") == 0)
  encoding_type=FT_ENCODING_BIG5;
else if (LocaleCompare(encoding,"EUC-TW") == 0)
  encoding_type=FT_ENCODING_BIG5;
else if (LocaleCompare(encoding,"KOI8-R") == 0)
  encoding_type=FT_ENCODING_KOI8_R;
else if (LocaleCompare(encoding,"KOI8-U") == 0)
  encoding_type=FT_ENCODING_KOI8_U;
else if (LocaleCompare(encoding,"UTF-8") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-16") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-16BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-16LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-32") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-32BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UTF-32LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-2") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-2BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-2LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-4") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-4BE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"UCS-4LE") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"WCHAR") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else if (LocaleCompare(encoding,"WCHAR_T") == 0)
  encoding_type=FT_ENCODING_UNICODE;
else
  encoding_type=FT_ENCODING_UNICODE;

ft_status=FT_Select_Charmap(face,encoding_type);
if ((ft_status!= 0) && (face->num_charmaps!= 0))
  ft_status=FT_Set_Charmap(face,face->charmaps[0]);
if (ft_status!= 0)
  {
    (void) FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSelectCharacterMap",ft_status,
      encoding);
    return(MagickFalse);
  }

// Set the character size for the font face based on the point size and
// resolution specified in the DrawInfo structure. Adjust the resolution
// if a custom density is provided.
resolution.x=draw_info->pointsize;
resolution.y=draw_info->density;
if (draw_info->density == 0)
  resolution.y=72;
flags=FT_LOAD_RENDER;
ft_status=FT_Set_Char_Size(face,0,draw_info->pointsize*64,resolution.x,
  resolution.y,0,0);
if (ft_status!= 0)
  {
    (void) FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSetCharacterSize",ft_status,
      img->filename);
    return(MagickFalse);
  }

// Initialize the TypeMetric structure with font size metrics such as ascent,
// descent, width, height, and maximum advance. If necessary, sanitize any
// incorrect ascender and descender values. Calculate underline position and
// thickness based on the font's properties.
metrics->ascender=face->size->metrics.ascender/64.0;
metrics->descender=face->size->metrics.descender/64.0;
metrics->width=face->size->metrics.width/64.0;
metrics->height=face->size->metrics.height/64.0;
metrics->max_advance=face->size->metrics.max_advance/64.0;
if (metrics->ascender < 0)
  metrics->ascender=0;
if (metrics->descender > 0)
  metrics->descender=0;
metrics->underline_position=face->underline_position/64.0;
metrics->underline_thickness=face->underline_thickness/64.0;

// If there is no text to render, or no glyphs in the font, clean up resources
// and return a successful status without proceeding further.
if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
    (face->num_glyphs == 0))
  {
    (void) FT_Done_FreeType(library);
    return(MagickTrue);
  }

// Configure rendering options such as anti-aliasing and hinting based on
// the DrawInfo settings and image properties. Prepare structures for
// rendering each glyph in the text string, transforming the glyphs according
// to specified affine transformations.
if (draw_info->antialias)
  flags|=FT_LOAD_ANTIALIAS;
if (draw_info->hinting!= UndefinedHinting)
  flags|=FT_LOAD_FORCE_AUTOHINT;
if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_NORMAL;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_NORMAL;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LIGHT;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_MONO;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_NO_HINTING;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MediumHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MediumHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MediumHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MediumHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MediumHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MediumHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FullHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NormalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == MonoHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == NoneHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == VerticalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == StrongHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == FractionalHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == LeastHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == SlightHinting)
  flags|=FT_LOAD_TARGET_LCD;
else if (draw_info->hinting == Mediu