if (encoding != (const char *) NULL)
    {
      if (LocaleCompare(encoding,"Adobe Custom") == 0)
        encoding_type=FT_ENCODING_ADOBE_CUSTOM;
      else if (LocaleCompare(encoding,"Adobe Expert") == 0)
        encoding_type=FT_ENCODING_ADOBE_EXPERT;
      else if (LocaleCompare(encoding,"Apple Roman") == 0)
        encoding_type=FT_ENCODING_ADOBE_LATIN_1;
      else if (LocaleCompare(encoding,"Big5") == 0)
        encoding_type=FT_ENCODING_BIG5;
      else if (LocaleCompare(encoding,"GB2312") == 0)
        encoding_type=FT_ENCODING_GB2312;
      else if (LocaleCompare(encoding,"Latin 2") == 0)
        encoding_type=FT_ENCODING_OLD_LATIN_2;
      else if (LocaleCompare(encoding,"SJIS") == 0)
        encoding_type=FT_ENCODING_SJIS;
      else if (LocaleCompare(encoding,"Unicode") == 0)
        encoding_type=FT_ENCODING_UNICODE;
      else if (LocaleCompare(encoding,"Wansung") == 0)
        encoding_type=FT_ENCODING_WANSUNG;
      ft_status=FT_Select_Charmap(face,encoding_type);
      if (ft_status != 0)
        {
          FT_Done_Face(face);
          FT_Done_FreeType(library);
          ThrowFreetypeErrorException("UnrecognizedFontEncoding",ft_status,
            encoding);
          return(MagickFalse);
        }
    }
  resolution.x=draw_info->resolution.x;
  resolution.y=draw_info->resolution.y;
  if (draw_info->density != (char *) NULL)
    {
      char
        *p;

      resolution.x=StringToDouble(draw_info->density,&p);
      resolution.y=StringToDouble(p,(char **) NULL);
    }
  ft_status=FT_Set_Char_Size(face,(FT_F26Dot6) (draw_info->pointsize*64.0+0.5),
    0,(FT_UInt) (resolution.x+0.5),(FT_UInt) (resolution.y+0.5));
  if (ft_status != 0)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,
        draw_info->font);
      return(MagickFalse);
    }
  metrics->ascent=face->size->metrics.ascender/64.0;
  metrics->descent=(-face->size->metrics.descender)/64.0;
  metrics->width=face->size->metrics.max_advance/64.0;
  metrics->height=face->size->metrics.height/64.0;
  metrics->max_advance=face->size->metrics.max_advance/64.0;
  if ((metrics->ascent+metrics->descent) > metrics->height)
    {
      metrics->ascent=face->ascender*draw_info->pointsize/face->units_per_EM;
      metrics->descent=(-face->descender)*draw_info->pointsize/face->units_per_EM;
    }
  metrics->underline_position=face->underline_position;
  metrics->underline_position=metrics->underline_position*draw_info->pointsize/
    face->units_per_EM;
  metrics->underline_thickness=face->underline_thickness;
  metrics->underline_thickness=metrics->underline_thickness*
    draw_info->pointsize/face->units_per_EM;
  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
      (face->num_glyphs == 0))
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickTrue);
    }
  flags=FT_LOAD_DEFAULT;
  if (draw_info->text_antialias == MagickFalse)
    flags=FT_LOAD_NO_HINTING|FT_LOAD_TARGET_MONO;
  else if ((img->columns > 2000) || (img->rows > 2000))
    flags|=FT_LOAD_NO_HINTING;
  affine.xx=(FT_Fixed) (draw_info->affine.sx*0x10000L);
  affine.xy=(FT_Fixed) (draw_info->affine.rx*0x10000L);
  affine.yx=(FT_Fixed) (draw_info->affine.ry*0x10000L);
  affine.yy=(FT_Fixed) (draw_info->affine.sy*0x10000L);
  origin.x=0;
  origin.y=0;
  length=strlen(draw_info->text);
  (void) ComplexTextLayout(img,draw_info,draw_info->text,length,face,flags,
    &grapheme,exception);
  if (grapheme == (GraphemeInfo *) NULL)
    {
      FT_Done_Face(face);
      FT_Done_FreeType(library);
      return(MagickFalse);
    }
  for (i=0; i < (ssize_t) length; i++)
  {
    (void) FT_Load_Glyph(face,(FT_UInt) grapheme[i].index,flags);
    ft_status=FT_Get_Glyph(face->glyph,&glyph.image);
    if (ft_status != 0)
      continue;
    FT_Glyph_Transform(glyph.image,&affine,&origin);
    ft_status=FT_Glyph_To_Bitmap(&glyph.image,FT_RENDER_MODE_NORMAL,0,1);
    if (ft_status != 0)
      {
        FT_Done_Glyph(glyph.image);
        continue;
      }
    bitmap=(FT_BitmapGlyph) glyph.image;
    point.x=offset->x+grapheme[i].x_offset/64.0;
    point.y=offset->y-grapheme[i].y_offset/64.0;
    (void) RenderFreetypeGlyph(img,draw_info,face,bitmap,&point,exception);
    FT_Done_Glyph(glyph.image);
  }
  grapheme=(GraphemeInfo *) RelinquishMagickMemory(grapheme);
  metrics->bounds.x1=0.0;
  metrics->bounds.y1=0.0;
  metrics->bounds.x2=face->size->metrics.max_advance/64.0;
  metrics->bounds.y2=face->size->metrics.height/64.0;
  metrics->width=face->size->metrics.max_advance/64.0;
  FT_Done_Face(face);
  FT_Done_FreeType(library);