// Select the appropriate character map (encoding) for the font face based on
// the provided encoding string. If an encoding is specified, determine the
// corresponding FreeType encoding type using a series of string comparisons.
// If the encoding type is successfully determined, apply it to the font face.
// If the encoding type cannot be applied, handle the error by cleaning up
// resources and throwing an exception.
if (encoding!= (const char *) NULL)
  {
    if (LocaleCompare(encoding,"ISO-8859-1") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-2") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-3") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-4") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-5") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-6") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-7") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-8") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-9") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-10") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-11") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-13") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-14") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-15") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"ISO-8859-16") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"KOI8-R") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"KOI8-U") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Macintosh") == 0)
      encoding_type=FT_ENCODING_APPLE_ROMAN;
    else if (LocaleCompare(encoding,"MacintoshRoman") == 0)
      encoding_type=FT_ENCODING_APPLE_ROMAN;
    else if (LocaleCompare(encoding,"MacRoman") == 0)
      encoding_type=FT_ENCODING_APPLE_ROMAN;
    else if (LocaleCompare(encoding,"Symbol") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Unicode") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UnicodeBig") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UnicodeLittle") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-16") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-16BE") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-16LE") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-32") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-32BE") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-32LE") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF-8") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"UTF8") == 0)
      encoding_type=FT_ENCODING_UNICODE;
    else if (LocaleCompare(encoding,"Windows") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1250") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1251") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1252") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1253") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1254") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1255") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1256") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1257") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-1258") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-31J") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-874") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-932") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-936") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-949") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-950") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-951") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-952") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-953") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-954") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-958") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-959") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-960") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-961") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-970") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-981") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-982") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-983") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-984") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-985") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-986") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-987") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-988") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-989") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-990") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-991") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-992") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-993") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-994") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-995") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-996") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-997") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-998") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else if (LocaleCompare(encoding,"Windows-999") == 0)
      encoding_type=FT_ENCODING_MS_SYMBOL;
    else
      encoding_type=FT_ENCODING_UNICODE;
    ft_status=FT_Select_Charmap(face,encoding_type);
    if ((ft_status!= 0) && (face->num_charmaps!= 0))
      ft_status=FT_Set_Charmap(face,face->charmaps[0]);
    if (ft_status!= 0)
      {
        (void) FT_Done_FreeType(library);
        ThrowFreetypeErrorException("UnableToSetEncoding",ft_status,encoding);
        return(MagickFalse);
      }
  }
// Set the character size for the font face based on the point size and
// resolution specified in the DrawInfo structure. Adjust the resolution
// if a custom density is provided. If setting the character size fails,
// handle the error by cleaning up resources and throwing an exception.
flags=FT_LOAD_RENDER;
if (draw_info->density!= (char *) NULL)
  {
    (void) sscanf(draw_info->density,"%lg",&resolution.x);
    resolution.y=resolution.x;
  }
else
  {
    resolution.x=draw_info->x_resolution;
    resolution.y=draw_info->y_resolution;
  }
ft_status=FT_Set_Char_Size(face,0,draw_info->pointsize*64,
  resolution.x,0);
if (ft_status!= 0)
  {
    (void) FT_Done_FreeType(library);
    ThrowFreetypeErrorException("UnableToSetCharacterSize",ft_status,
      draw_info->font!= (char *) NULL? draw_info->font : "none");
    return(MagickFalse);
  }
// Initialize the TypeMetric structure with font size metrics such as ascent,
// descent, width, height, and maximum advance. If necessary, sanitize any
// incorrect ascender and descender values. Calculate underline position and
// thickness based on the font's properties.
metrics->pixels_per_em.x=(double) face->units_per_EM;
metrics->pixels_per_em.y=(double) face->units_per_EM;
metrics->ascent=(double) face->ascender;
metrics->descent=(double) -face->descender;
metrics->width=(double) face->max_advance_width;
metrics->height=(double) face->height;
metrics->max_advance=(double) face->max_advance_width;
metrics->underline_position=(double) face->underline_position;
metrics->underline_thickness=(double) face->underline_thickness;
if (metrics->underline_position < 0.0)
  metrics->underline_position=0.0;
if (metrics->underline_thickness < 0.0)
  metrics->underline_thickness=1.0;
if (metrics->ascent < 0.0)
  metrics->ascent=0.0;
if (metrics->descent < 0.0)
  metrics->descent=0.0;
if (metrics->ascent+metrics->descent < metrics->height)
  metrics->ascent=metrics->height-metrics->descent;
if (metrics->ascent+metrics->descent > metrics->height)
  metrics->descent=metrics->height-metrics->ascent;
// If there is no text to render, or no glyphs in the font, clean up resources
// and return a successful status without proceeding further.
if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0') ||
    (face->num_glyphs == 0))
  {
    (void) FT_Done_FreeType(library);
    return(MagickTrue);
  }
// Configure rendering options such as anti-aliasing and hinting based on
// the DrawInfo settings and image properties. Prepare structures for
// rendering each glyph in the text string, transforming the glyphs according
// to specified affine transformations.
if (draw_info->render == MagickFalse)
  flags|=FT_LOAD_NO_BITMAP;
if (draw_info->stroke_width!= 0.0)
  flags|=FT_LOAD_NO_BITMAP;
if (draw_info->stroke_antialias == MagickFalse)
  flags|=FT_LOAD_MONOCHROME;
if (draw_info->fill_antialias == MagickFalse)
  flags|=FT_LOAD_MONOCHROME;
if (draw_info->hinting == MagickFalse)
  flags|=FT_LOAD_NO_HINTING;
if (draw_info->stroke_antialias == MagickFalse)
  flags|=FT_LOAD_TARGET_MONO;
if (draw_info->fill_antialias == MagickFalse)
  flags|=FT_LOAD_TARGET_MONO;
if (draw_info->stroke_width!= 0.0)
  flags|=FT_LOAD_TARGET_LCD;
if (draw_info->stroke_width!= 0.0)
  flags|=FT_LOAD_TARGET_LCD_V;
if (draw_info->stroke_width!= 0.0)
  flags|=FT_LOAD_TARGET_NORMAL;
if (draw_info->stroke_width!= 0.0)
  flags|=FT_LOAD_TARGET_LIGHT;
if (draw_info->stroke_width!= 0.0)
  flags|=F