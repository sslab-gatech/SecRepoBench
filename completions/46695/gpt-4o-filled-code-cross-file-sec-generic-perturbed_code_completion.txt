/*
    Set character size.
  */
  resolution.x=DefaultResolution;
  resolution.y=DefaultResolution;
  if (draw_info->density != (char *) NULL)
    {
      GeometryInfo
        geometry_info;

      MagickStatusType
        flags;

      flags=ParseGeometry(draw_info->density,&geometry_info);
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        resolution.y=resolution.x;
    }
  ft_status=FT_Set_Char_Size(face,0,(FT_F26Dot6) (64.0*draw_info->pointsize),
    (FT_UInt) resolution.x,(FT_UInt) resolution.y);
  if (ft_status != 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      ThrowFreetypeErrorException("UnableToSetFontSize",ft_status,
        img->filename);
      return(MagickFalse);
    }
  /*
    Initialize font metrics.
  */
  metrics->ascent=(double) face->size->metrics.ascender/64.0;
  metrics->descent=(double) face->size->metrics.descender/64.0;
  metrics->width=0.0;
  metrics->height=metrics->ascent-metrics->descent;
  metrics->max_advance=(double) face->size->metrics.max_advance/64.0;
  if (face->size->metrics.y_ppem > 0)
    {
      metrics->underline_position=(double) face->underline_position*
        face->size->metrics.y_ppem/face->units_per_EM;
      metrics->underline_thickness=(double) face->underline_thickness*
        face->size->metrics.y_ppem/face->units_per_EM;
    }
  else
    {
      metrics->underline_position=(double) face->underline_position/64.0;
      metrics->underline_thickness=(double) face->underline_thickness/64.0;
    }
  if (metrics->descent > 0.0)
    metrics->descent=(-metrics->descent);
  if (metrics->underline_position > 0.0)
    metrics->underline_position=(-metrics->underline_position);
  /*
    Render text.
  */
  if ((draw_info->text == (char *) NULL) || (*draw_info->text == '\0'))
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  if (face->num_glyphs == 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickTrue);
    }
  /*
    Configure rendering options.
  */
  flags=FT_LOAD_DEFAULT;
  if (draw_info->rendering_intent == AbsoluteColorimetricIntent)
    flags|=FT_LOAD_NO_HINTING;
  if (draw_info->rendering_intent == PerceptualIntent)
    flags|=FT_LOAD_NO_AUTOHINT;
  if (draw_info->rendering_intent == SaturationIntent)
    flags|=FT_LOAD_FORCE_AUTOHINT;
  if (draw_info->rendering_intent == RelativeColorimetricIntent)
    flags|=FT_LOAD_TARGET_LIGHT;
  if (draw_info->rendering_intent == AbsoluteColorimetricIntent)
    flags|=FT_LOAD_TARGET_MONO;
  /*
    Render each glyph.
  */
  length=ComplexTextLayout(img,draw_info,draw_info->text,strlen(draw_info->text),
    face,flags,&grapheme,exception);
  if (length == 0)
    {
      (void) FT_Done_Face(face);
      (void) FT_Done_FreeType(library);
      return(MagickFalse);
    }
  for (i=0; i < (ssize_t) length; i++)
  {
    glyph.id=(FT_UInt) grapheme[i].index;
    glyph.origin.x=(FT_Pos) (offset->x+grapheme[i].x_offset);
    glyph.origin.y=(FT_Pos) (offset->y+grapheme[i].y_offset);
    ft_status=FT_Load_Glyph(face,glyph.id,flags);
    if (ft_status != 0)
      continue;
    ft_status=FT_Get_Glyph(face->glyph,&glyph.image);
    if (ft_status != 0)
      continue;
    if (face->glyph->format != FT_GLYPH_FORMAT_BITMAP)
      {
        ft_status=FT_Glyph_To_Bitmap(&glyph.image,FT_RENDER_MODE_NORMAL,0,1);
        if (ft_status != 0)
          continue;
      }
    bitmap=(FT_BitmapGlyph) glyph.image;
    point.x=(double) (glyph.origin.x+bitmap->left);
    point.y=(double) (glyph.origin.y-bitmap->top);
    (void) CompositeImage(img,OverCompositeOp,bitmap->bitmap.buffer,
      bitmap->bitmap.width,bitmap->bitmap.rows,point.x,point.y);
    FT_Done_Glyph(glyph.image);
  }
  /*
    Finalize metrics.
  */
  metrics->width=(double) (grapheme[length-1].x_advance/64.0);
  metrics->bounds.x1=0.0;
  metrics->bounds.y1=metrics->descent;
  metrics->bounds.x2=metrics->width;
  metrics->bounds.y2=metrics->ascent;
  (void) FT_Done_Face(face);
  (void) FT_Done_FreeType(library);
  return(MagickTrue);