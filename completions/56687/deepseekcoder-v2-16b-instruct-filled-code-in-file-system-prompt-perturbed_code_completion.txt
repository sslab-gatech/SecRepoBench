io_read_buf(mrb, self);
  if (RSTRING_LEN(buf) == 0) {
    mrb_raise(mrb, E_EOF_ERROR, "readchar failed");
  }
#ifdef MRB_UTF8_STRING
  c = (unsigned char)RSTRING_PTR(buf)[0];
  if (c <= 0x7F) {
    return mrb_str_new_cstr(mrb, (char*)&c);
  }
  else if (c <= 0xDF && RSTRING_LEN(buf) > 1) {
    unsigned int uc;
    uc = ((c & 0x1F) << 6) | ((unsigned char)RSTRING_PTR(buf)[1] & 0x3F);
    return mrb_str_new_cstr(mrb, (char*)&uc);
  }
  else if (c <= 0xEF && RSTRING_LEN(buf) > 2) {
    unsigned int uc;
    uc = ((c & 0x0F) << 12) | ((unsigned char)RSTRING_PTR(buf)[1] & 0x3F) << 6 | ((unsigned char)RSTRING_PTR(buf)[2] & 0x3F);
    return mrb_str_new_cstr(mrb, (char*)&uc);
  }
  else if (c <= 0xF7 && RSTRING_LEN(buf) > 3) {
    unsigned int uc;
    uc = ((c & 0x07) << 18) | ((unsigned char)RSTRING_PTR(buf)[1] & 0x3F) << 12 | ((unsigned char)RSTRING_PTR(buf)[2] & 0x3F) << 6 | ((unsigned char)RSTRING_PTR(buf)[3] & 0x3F);
    return mrb_str_new_cstr(mrb, (char*)&uc);
  }
  else {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "invalid UTF-8 string");
  }
#else
  return mrb_str_new(mrb, RSTRING_PTR(buf), len);
#endif
}

static mrb_value
io_readbyte(mrb_state *mrb, mrb_value self)
{
  mrb_value buf;
  mrb_int len = 1;

  mrb->c->ci->mid = 0;
  buf = io_read_buf(mrb, self);
  if (RSTRING_LEN(buf) == 0) {
    mrb_raise(mrb, E_EOF_ERROR, "readbyte failed");
  }
  return mrb_str_new(mrb, RSTRING_PTR(buf), len);
}

static mrb_value
io_readlines(mrb_state *mrb, mrb_value self)
{
  mrb_value buf, line, lines;
  mrb_int len;
  const char *p;

  mrb->c->ci->mid = 0;
  lines = mrb_ary_new(mrb);
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return lines;
  }
  mrb_str_modify(mrb, RSTRING(buf));
  p = RSTRING_PTR(buf);
  len = RSTRING_LEN(buf);
  while (len > 0) {
    line = mrb_str_new(mrb, p, len);
    mrb_str_cat(mrb, line, "\n", 1);
    mrb_ary_push(mrb, lines, line);
    p += len;
    len -= len;
  }
  return lines;
}

static mrb_value
io_readline(mrb_state *mrb, mrb_value self)
{
  mrb_value buf, line;
  mrb_int len;
  const char *p;

  mrb->c->ci->mid = 0;
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return mrb_nil_value();
  }
  mrb_str_modify(mrb, RSTRING(buf));
  p = RSTRING_PTR(buf);
  len = RSTRING_LEN(buf);
  if (len == 0) {
    return mrb_nil_value();
  }
  line = mrb_str_new(mrb, p, len);
  mrb_str_cat(mrb, line, "\n", 1);
  return line;
}

static mrb_value
io_getc(mrb_state *mrb, mrb_value self)
{
  mrb_value buf;
  mrb_int len = 1;
#ifdef MRB_UTF8_STRING
  unsigned char c;
#endif

  mrb->c->ci->mid = 0;
  buf = io_read_buf(mrb, self);
  if (RSTRING_LEN(buf) == 0) {
    return mrb_nil_value();
  }
#ifdef MRB_UTF8_STRING
  c = (unsigned char)RSTRING_PTR(buf)[0];
  if (c <= 0x7F) {
    return mrb_str_new_cstr(mrb, (char*)&c);
  }
  else if (c <= 0xDF && RSTRING_LEN(buf) > 1) {
    unsigned int uc;
    uc = ((c & 0x1F) << 6) | ((unsigned char)RSTRING_PTR(buf)[1] & 0x3F);
    return mrb_str_new_cstr(mrb, (char*)&uc);
  }
  else if (c <= 0xEF && RSTRING_LEN(buf) > 2) {
    unsigned int uc;
    uc = ((c & 0x0F) << 12) | ((unsigned char)RSTRING_PTR(buf)[1] & 0x3F) << 6 | ((unsigned char)RSTRING_PTR(buf)[2] & 0x3F);
    return mrb_str_new_cstr(mrb, (char*)&uc);
  }
  else if (c <= 0xF7 && RSTRING_LEN(buf) > 3) {
    unsigned int uc;
    uc = ((c & 0x07) << 18) | ((unsigned char)RSTRING_PTR(buf)[1] & 0x3F) << 12 | ((unsigned char)RSTRING_PTR(buf)[2] & 0x3F) << 6 | ((unsigned char)RSTRING_PTR(buf)[3] & 0x3F);
    return mrb_str_new_cstr(mrb, (char*)&uc);
  }
  else {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "invalid UTF-8 string");
  }
#else
  return mrb_str_new(mrb, RSTRING_PTR(buf), len);
#endif
}

static mrb_value
io_ungetc(mrb_state *mrb, mrb_value self)
{
  mrb_value buf, c;
  mrb_int len;
  const char *p;

  mrb->c->ci->mid = 0;
  mrb_get_args(mrb, "S", &c);
  if (RSTRING_LEN(c) != 1) {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "invalid character");
  }
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    buf = mrb_str_new(mrb, NULL, 0);
    mrb_iv_set(mrb, self, MRB_IVSYM(buf), buf);
  }
  mrb_str_modify(mrb, RSTRING(buf));
  p = RSTRING_PTR(c);
  len = RSTRING_LEN(c);
  mrb_str_cat(mrb, buf, p, len);
  return self;
}

static mrb_value
io_each_char(mrb_state *mrb, mrb_value self)
{
  mrb_value ary;
  mrb_value buf;
  mrb_int len;
  const char *p;

  mrb->c->ci->mid = 0;
  ary = mrb_ary_new(mrb);
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return ary;
  }
  mrb_str_modify(mrb, RSTRING(buf));
  p = RSTRING_PTR(buf);
  len = RSTRING_LEN(buf);
  while (len > 0) {
    mrb_value c = mrb_str_new_cstr(mrb, p);
    mrb_ary_push(mrb, ary, c);
    p += len;
    len -= len;
  }
  return ary;
}

static mrb_value
io_each_byte(mrb_state *mrb, mrb_value self)
{
  mrb_value ary;
  mrb_value buf;
  mrb_int len;
  const char *p;

  mrb->c->ci->mid = 0;
  ary = mrb_ary_new(mrb);
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return ary;
  }
  mrb_str_modify(mrb, RSTRING(buf));
  p = RSTRING_PTR(buf);
  len = RSTRING_LEN(buf);
  while (len > 0) {
    mrb_value c = mrb_str_new(mrb, p, 1);
    mrb_ary_push(mrb, ary, c);
    p += 1;
    len -= 1;
  }
  return ary;
}

static mrb_value
io_each_line(mrb_state *mrb, mrb_value self)
{
  mrb_value ary;
  mrb_value buf;
  mrb_int len;
  const char *p;

  mrb->c->ci->mid = 0;
  ary = mrb_ary_new(mrb);
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return ary;
  }
  mrb_str_modify(mrb, RSTRING(buf));
  p = RSTRING_PTR(buf);
  len = RSTRING_LEN(buf);
  while (len > 0) {
    mrb_value line = mrb_str_new(mrb, p, len);
    mrb_ary_push(mrb, ary, line);
    p += len;
    len -= len;
  }
  return ary;
}

static mrb_value
io_eof(mrb_state *mrb, mrb_value self)
{
  mrb_value buf;
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return mrb_true_value();
  }
  return mrb_bool_value(RSTRING_LEN(buf) == 0);
}

static mrb_value
io_eof_mark(mrb_state *mrb, mrb_value self)
{
  mrb_value buf;
  buf = mrb_iv_get(mrb, self, MRB_IVSYM(buf));
  if (mrb_nil_p(buf)) {
    return mrb_false_value();
  }
  return mrb_bool_value(RSTRING_LEN(buf) == 0);
}

static mrb_value
io_rewind(mrb_state *mrb, mrb_value self)
{
  mrb_value buf;
  buf = mrb_iv_get(mrb, self, MRB_IV