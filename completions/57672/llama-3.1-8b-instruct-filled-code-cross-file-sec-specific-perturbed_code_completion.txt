// <MASK>
  {
    mrb_value *newstack = (mrb_value*)mrb_malloc_simple(mrb_state, sizeof(mrb_value)*len);
    if (newstack) {
      mrb_value *oldbase = mrb->c->stbase;
      size_t oldsize = mrb->c->stend - mrb->c->stbase;
      size_t off = mrb->c->ci->stack? mrb->c->stend - mrb->c->ci->stack : 0;

      if (off > oldsize) oldsize = off;
      size_t size = oldsize;
#ifdef MRB_STACK_EXTEND_DOUBLING
      if ((size_t)len <= size)
        size *= 2;
      else
        size += len;
#else
      /* Use linear stack growth.
         It is slightly slower than doubling the stack space,
         but it saves memory on small devices. */
      if (len <= MRB_STACK_GROWTH)
        size += MRB_STACK_GROWTH;
      else
        size += len;
#endif

      if (size > MRB_STACK_MAX) {
        mrb_exc_raise(mrb_state, mrb_obj_value(mrb->stack_err));
      }

      mrb_value *newend = newstack + size;
      mrb_value *oldend = oldbase + oldsize;
      memcpy(newstack, oldbase, oldsize * sizeof(mrb_value));
      mrb->c->stbase = newstack;
      mrb->c->stend = newend;
      e->stack = newstack;
      MRB_ENV_CLOSE(e);
    }
    mrb_free(mrb_state, p);
    return TRUE;
  }