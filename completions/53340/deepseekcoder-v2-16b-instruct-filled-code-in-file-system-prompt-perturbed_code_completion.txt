MIN(s->blockpos, shorten_by & 0x1FFF);
            else if (m->avctx->codec_id == AV_CODEC_ID_MLP && shorten_by & 0x2000)
                s->blockpos -= FFMIN(s->blockpos, shorten_by & 0x1FFF);
        }

        if (substream_parity_present[substr]) {
            if (ff_mlp_calculate_parity(buf, 4) != parity_bits) {
                av_log(avctx, AV_LOG_ERROR, "Substream parity check failed.\n");
                return AVERROR_INVALIDDATA;
            }
        }

        buf += substream_data_len[substr];

    next_substr:
        s->restart_seen = 0;
    }

    if (substream_start != substream_data_len[0]) {
        av_log(avctx, AV_LOG_ERROR, "Substream data length mismatch.\n");
        return AVERROR_INVALIDDATA;
    }

    if ((ret = output_data(m, m->max_decoded_substream, frame, got_frame_ptr)) < 0)
        return ret;

    return length;

substream_length_mismatch:
    av_log(avctx, AV_LOG_ERROR, "Substream data length mismatch.\n");
    return AVERROR_INVALIDDATA;

error:
    *got_frame_ptr = 0;
    return AVERROR_INVALIDDATA;
}

static int mlp_decode_frame(AVCodecContext *avctx, void *data,
                            int *got_frame_ptr, AVPacket *avpkt)
{
    MLPDecodeContext *m = avctx->priv_data;
    AVFrame *frame = data;
    int ret;

    if ((ret = read_access_unit(avctx, frame, got_frame_ptr, avpkt)) < 0)
        return ret;

    if (*got_frame_ptr)
        frame->pts = avpkt->pts;

    return avpkt->size;
}

AVCodec ff_mlp_decoder = {
    .name           = "mlp",
    .long_name      = NULL_IF_CONFIG_SMALL("Meridian Lossless Packing"),
    .type           = AVMEDIA_TYPE_AUDIO,
    .id             = AV_CODEC_ID_MLP,
    .priv_data_size = sizeof(MLPDecodeContext),
    .init           = mlp_decode_init,
    .decode         = mlp_decode_frame,
    .capabilities   = AV_CODEC_CAP_DR1 | AV_CODEC_CAP_CHANNEL_CONF,
    .sample_fmts    = (const enum AVSampleFormat[]){ AV_SAMPLE_FMT_S16, AV_SAMPLE_FMT_S32, AV_SAMPLE_FMT_NONE },
    .channel_layouts = (const uint64_t[]){ AV_CH_LAYOUT_STEREO, AV_CH_LAYOUT_QUAD, AV_CH_LAYOUT_5POINT0_BACK, AV_CH_LAYOUT_5POINT1_BACK, AV_CH_LAYOUT_7POINT1, AV_CH_LAYOUT_MONO, AV_CH_LAYOUT_STEREO_DOWNMIX, AV_CH_LAYOUT_QUAD_SIDE, AV_CH_LAYOUT_5POINT0, AV_CH_LAYOUT_5POINT1, AV_CH_LAYOUT_7POINT1_WIDE, AV_CH_LAYOUT_STEREO_LEFT_RIGHT, AV_CH_LAYOUT_STEREO_TOP_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER, AV_CH_LAYOUT_STEREO_RIGHT_CENTER, AV_CH_LAYOUT_STEREO_CENTER_SIDE, AV_CH_LAYOUT_MONO_DOWNMIX, AV_CH_LAYOUT_STEREO_DOWNMIX_MATRIX, AV_CH_LAYOUT_QUAD_MATRIX, AV_CH_LAYOUT_5POINT0_MATRIX, AV_CH_LAYOUT_5POINT1_MATRIX, AV_CH_LAYOUT_7POINT1_MATRIX, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP, AV_CH_LAYOUT_STEREO_CENTER_SIDE_TOP, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_CENTER_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_LEFT, AV_CH_LAYOUT_STEREO_CENTER_SIDE_RIGHT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_TOP, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_TOP, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_LEFT, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_RIGHT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_TOP_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_BOTTOM_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_LEFT, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_RIGHT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_TOP_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_BOTTOM_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_TOP_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_TOP_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_TOP_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_BOTTOM_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_BOTTOM_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_BOTTOM_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_TOP_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_BOTTOM_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_SIDE_TOP, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_SIDE_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_SIDE_LEFT, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_SIDE_SIDE_RIGHT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_TOP_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_BOTTOM_SIDE_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_TOP_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_TOP_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_TOP_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_LEFT_CENTER_SIDE_BOTTOM_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_SIDE_BOTTOM_SIDE_SIDE_SIDE, AV_CH_LAYOUT_STEREO_CENTER_SIDE_SIDE_BOTTOM_SIDE_SIDE_S