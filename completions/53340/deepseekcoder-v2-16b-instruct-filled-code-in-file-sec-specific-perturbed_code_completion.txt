_INVALIDDATA;

            shorten_by = get_bits(&gb, 16);
            if (shorten_by > 0) {
                av_log(avctx, AV_LOG_ERROR,
                       "Substream %d data is too long by %d bytes.\n",
                       substr, shorten_by);
                return AVERROR_INVALIDDATA;
            }
        }

        if (substream_parity_present[substr]) {
            if (ff_mlp_calculate_parity(buf, substream_data_len[substr]) != 0) {
                av_log(avctx, AV_LOG_ERROR, "Substream %d parity check failed.\n", substr);
                return AVERROR_INVALIDDATA;
            }
        }

        buf += substream_data_len[substr];

    next_substr:
        s->restart_seen = 0;
    }

    if (substream_start != length - header_size - substr_header_size) {
        av_log(avctx, AV_LOG_ERROR, "Substream data length mismatch.\n");
        return AVERROR_INVALIDDATA;
    }

    if ((ret = output_data(m, m->max_decoded_substream, frame, got_frame_ptr)) < 0)
        return ret;

    *got_frame_ptr = 1;
    return length;

substream_length_mismatch:
    av_log(avctx, AV_LOG_ERROR, "Substream %d data length mismatch.\n", substr);
    return AVERROR_INVALIDDATA;

error:
    *got_frame_ptr = 0;
    return AVERROR_INVALIDDATA;
}

static int mlp_decode_frame(AVCodecContext *avctx, void *data,
                            int *got_frame_ptr, AVPacket *avpkt)
{
    MLPDecodeContext *m = avctx->priv_data;
    AVFrame *frame = data;
    int ret;

    if ((ret = read_access_unit(avctx, frame, got_frame_ptr, avpkt)) < 0)
        return ret;

    if (*got_frame_ptr)
        frame->pts = avpkt->pts;

    return avpkt->size;
}

AVCodec ff_mlp_decoder = {
    .name           = "mlp",
    .long_name      = NULL_IF_CONFIG_SMALL("Meridian Lossless Packing"),
    .type           = AVMEDIA_TYPE_AUDIO,
    .id             = AV_CODEC_ID_MLP,
    .priv_data_size = sizeof(MLPDecodeContext),
    .init           = mlp_decode_init,
    .decode         = mlp_decode_frame,
    .capabilities   = AV_CODEC_CAP_DR1 | AV_CODEC_CAP_CHANNEL_CONF,
    .sample_fmts    = (const enum AVSampleFormat[]){ AV_SAMPLE_FMT_S16, AV_SAMPLE_FMT_S32, AV_SAMPLE_FMT_NONE },
    .channel_layouts = (const uint64_t[]){ AV_CH_LAYOUT_STEREO, AV_CH_LAYOUT_QUAD, AV_CH_LAYOUT_5POINT0_BACK, AV_CH_LAYOUT_5POINT1_BACK, AV_CH_LAYOUT_7POINT1, AV_CH_LAYOUT_MONO, AV_CH_LAYOUT_STEREO_DOWNMIX, AV_CH_LAYOUT_2_1, AV_CH_LAYOUT_3_1, AV_CH_LAYOUT_4_0, AV_CH_LAYOUT_4_1, AV_CH_LAYOUT_6_0, AV_CH_LAYOUT_6_0_FRONT, AV_CH_LAYOUT_HEXAGONAL, AV_CH_LAYOUT_6_1, AV_CH_LAYOUT_6_1_BACK, AV_CH_LAYOUT_7_0, AV_CH_LAYOUT_7_0_FRONT, AV_CH_LAYOUT_7_1, AV_CH_LAYOUT_7_1_WIDE, AV_CH_LAYOUT_OCTAGONAL, AV_CH_LAYOUT_STEREO_LEFT_RIGHT, AV_CH_LAYOUT_2_2, AV_CH_LAYOUT_QUAD_SIDE, AV_CH_LAYOUT_STEREO_TOP_BOTTOM, AV_CH_LAYOUT_3_2, AV_CH_LAYOUT_3_2_1, AV_CH_LAYOUT_2_2_2, AV_CH_LAYOUT_3_3, AV_CH_LAYOUT_3_3_1, AV_CH_LAYOUT_3_3_2, AV_CH_LAYOUT_5_0, AV_CH_LAYOUT_5_0_FRONT, AV_CH_LAYOUT_5_1, AV_CH_LAYOUT_5_1_FRONT, AV_CH_LAYOUT_5_1_BACK, AV_CH_LAYOUT_5_2, AV_CH_LAYOUT_5_2_FRONT, AV_CH_LAYOUT_5_3, AV_CH_LAYOUT_5_3_FRONT, AV_CH_LAYOUT_5_3_BACK, AV_CH_LAYOUT_7_0_TOP, AV_CH_LAYOUT_7_1_TOP, AV_CH_LAYOUT_OCTAGONAL_DOWNMIX, AV_CH_LAYOUT_STEREO_LEFT_LEFT, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT, AV_CH_LAYOUT_STEREO_TOP_TOP, AV_CH_LAYOUT_STEREO_BOTTOM_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_RIGHT_2, AV_CH_LAYOUT_STEREO_TOP_BOTTOM_2, AV_CH_LAYOUT_STEREO_LEFT_LEFT_2, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT_2, AV_CH_LAYOUT_STEREO_TOP_TOP_2, AV_CH_LAYOUT_STEREO_BOTTOM_BOTTOM_2, AV_CH_LAYOUT_STEREO_LEFT_LEFT_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT_FRONT, AV_CH_LAYOUT_STEREO_LEFT_LEFT_BACK, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT_BACK, AV_CH_LAYOUT_STEREO_TOP_TOP_FRONT, AV_CH_LAYOUT_STEREO_BOTTOM_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_TOP_TOP_BACK, AV_CH_LAYOUT_STEREO_BOTTOM_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_LEFT_LEFT_CENTER, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT_CENTER, AV_CH_LAYOUT_STEREO_LEFT_LEFT_TOP, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT_TOP, AV_CH_LAYOUT_STEREO_LEFT_LEFT_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_RIGHT_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER, AV_CH_LAYOUT_STEREO_LEFT_FRONT_TOP, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_TOP, AV_CH_LAYOUT_STEREO_LEFT_BACK_TOP, AV_CH_LAYOUT_STEREO_RIGHT_BACK_TOP, AV_CH_LAYOUT_STEREO_LEFT_FRONT_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_BACK_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_BACK_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_CENTER_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_FRONT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BACK, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BACK, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP_FRONT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_LEFT_CENTER_TOP_BACK, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_TOP_BACK, AV_CH_LAYOUT_STEREO_LEFT_CENTER_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_RIGHT_CENTER_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_TOP, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_TOP, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_TOP, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_TOP, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_TOP_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_TOP_FRONT, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_TOP_BACK, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_TOP_BACK, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_TOP_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_TOP_FRONT, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_BOTTOM_FRONT, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_TOP_BACK, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_TOP_BACK, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_BOTTOM_BACK, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_TOP_TOP, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_TOP_TOP, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_BOTTOM_TOP, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_BOTTOM_TOP, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_TOP_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_TOP_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_BOTTOM_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_BOTTOM_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_TOP_TOP, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_TOP_TOP, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_BOTTOM_TOP, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_BOTTOM_TOP, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_TOP_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_TOP_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_BACK_CENTER_BOTTOM_BOTTOM, AV_CH_LAYOUT_STEREO_RIGHT_BACK_CENTER_BOTTOM_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_FRONT_CENTER_TOP_TOP_FRONT, AV_CH_LAYOUT_STEREO_RIGHT_FRONT_CENTER_TOP_TOP_FR