&& shorten_by > 16)
                shorten_by = 16;
            else if (m->avctx->codec_id == AV_CODEC_ID_MLP && shorten_by > 24)
                shorten_by = 24;

            if (shorten_by) {
                av_log(avctx, AV_LOG_DEBUG,
                       "Shortening substream %d by %d bits.\n",
                       substr, shorten_by);
                skip_bits(&gb, shorten_by);
            }
        }

        if (substream_parity_present[substr]) {
            uint8_t parity = ff_mlp_calculate_parity(buf, substream_data_len[substr]);

            if (parity != 0) {
                av_log(avctx, AV_LOG_ERROR,
                       "Parity check failed for substream %d.\n",
                       substr);
                return AVERROR_INVALIDDATA;
            }
        }

        buf += substream_data_len[substr];

    next_substr:
        s->restart_seen = 0;
    }

    if (buf != avpkt->data + length) {
        av_log(avctx, AV_LOG_ERROR, "Data remaining after decoding.\n");
        return AVERROR_INVALIDDATA;
    }

    if ((ret = output_data(m, m->max_decoded_substream, frame, got_frame_ptr)) < 0)
        return ret;

    return length;

substream_length_mismatch:
    av_log(avctx, AV_LOG_ERROR,
           "Substream %d data length mismatch.\n", substr);
    return AVERROR_INVALIDDATA;

error:
    *got_frame_ptr = 0;
    return AVERROR_INVALIDDATA;
}

static int mlp_decode_frame(AVCodecContext *avctx, void *data,
                            int *got_frame_ptr, AVPacket *avpkt)
{
    MLPDecodeContext *m = avctx->priv_data;
    AVFrame *frame = data;
    int ret;

    if ((ret = read_access_unit(avctx, frame, got_frame_ptr, avpkt)) < 0)
        return ret;

    if (*got_frame_ptr)
        frame->pts = avpkt->pts;

    return avpkt->size;
}

AVCodec ff_mlp_decoder = {
    .name           = "mlp",
    .long_name      = NULL_IF_CONFIG_SMALL("Meridian Lossless Packing"),
    .type           = AVMEDIA_TYPE_AUDIO,
    .id             = AV_CODEC_ID_MLP,
    .priv_data_size = sizeof(MLPDecodeContext),
    .init           = mlp_decode_init,
    .decode         = mlp_decode_frame,
    .capabilities   = AV_CODEC_CAP_DR1 | AV_CODEC_CAP_CHANNEL_CONF,
    .sample_fmts    = (const enum AVSampleFormat[]){ AV_SAMPLE_FMT_S16, AV_SAMPLE_FMT_S32, AV_SAMPLE_FMT_NONE },
    .channel_layouts = (const uint64_t[]){ AV_CH_LAYOUT_STEREO, AV_CH_LAYOUT_QUAD, AV_CH_LAYOUT_5POINT0, AV_CH_LAYOUT_5POINT1, AV_CH_LAYOUT_7POINT1, AV_CH_LAYOUT_MONO, AV_CH_LAYOUT_STEREO_DOWNMIX, AV_CH_LAYOUT_QUAD_DOWNMIX, AV_CH_LAYOUT_5POINT1_DOWNMIX, AV_CH_LAYOUT_7POINT1_DOWNMIX, AV_CH_LAYOUT_STEREO_LEFT, AV_CH_LAYOUT_STEREO_RIGHT, AV_CH_LAYOUT_STEREO_TOP, AV_CH_LAYOUT_STEREO_BOTTOM, AV_CH_LAYOUT_STEREO_LEFT_OF_CENTER, AV_CH_LAYOUT_STEREO_RIGHT_OF_CENTER, AV_CH_LAYOUT_MIDDLE_LEFT, AV_CH_LAYOUT_MIDDLE_RIGHT, AV_CH_LAYOUT_LOW_FREQUENCY, AV_CH_LAYOUT_TOP_CENTER, AV_CH_LAYOUT_SIDE_LEFT, AV_CH_LAYOUT_SIDE_RIGHT, AV_CH_LAYOUT_AUX_LEFT, AV_CH_LAYOUT_AUX_RIGHT, AV_CH_LAYOUT_WIDE_LEFT, AV_CH_LAYOUT_WIDE_RIGHT, AV_CH_LAYOUT_SURROUND_DIRECT_LEFT, AV_CH_LAYOUT_SURROUND_DIRECT_RIGHT, AV_CH_LAYOUT_LOW_FREQUENCY_2, AV_CH_LAYOUT_TOP_SIDE_LEFT, AV_CH_LAYOUT_TOP_SIDE_RIGHT, AV_CH_LAYOUT_TOP_FRONT_LEFT, AV_CH_LAYOUT_TOP_FRONT_RIGHT, AV_CH_LAYOUT_TOP_FRONT_CENTER, AV_CH_LAYOUT_TOP_FRONT_LEFT_OF_CENTER, AV_CH_LAYOUT_TOP_FRONT_RIGHT_OF_CENTER, AV_CH_LAYOUT_SIDE_FRONT_LEFT, AV_CH_LAYOUT_SIDE_FRONT_RIGHT, AV_CH_LAYOUT_SIDE_BACK_LEFT, AV_CH_LAYOUT_SIDE_BACK_RIGHT, AV_CH_LAYOUT_AUX_BACK_LEFT, AV_CH_LAYOUT_AUX_BACK_RIGHT, AV_CH_LAYOUT_TOP_BACK_LEFT, AV_CH_LAYOUT_TOP_BACK_RIGHT, AV_CH_LAYOUT_TOP_BACK_CENTER, AV_CH_LAYOUT_TOP_BACK_LEFT_OF_CENTER, AV_CH_LAYOUT_TOP_BACK_RIGHT_OF_CENTER, AV_CH_LAYOUT_SIDE_BACK_CENTER, AV_CH_LAYOUT_SIDE_BACK_LEFT_OF_CENTER, AV_CH_LAYOUT_SIDE_BACK_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_FRONT_LEFT, AV_CH_LAYOUT_AUX_FRONT_RIGHT, AV_CH_LAYOUT_AUX_BACK_CENTER, AV_CH_LAYOUT_AUX_BACK_LEFT_OF_CENTER, AV_CH_LAYOUT_AUX_BACK_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_FRONT_CENTER, AV_CH_LAYOUT_AUX_FRONT_LEFT_OF_CENTER, AV_CH_LAYOUT_AUX_FRONT_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_LEFT, AV_CH_LAYOUT_AUX_SIDE_RIGHT, AV_CH_LAYOUT_AUX_SIDE_FRONT_LEFT, AV_CH_LAYOUT_AUX_SIDE_FRONT_RIGHT, AV_CH_LAYOUT_AUX_SIDE_BACK_LEFT, AV_CH_LAYOUT_AUX_SIDE_BACK_RIGHT, AV_CH_LAYOUT_AUX_SIDE_CENTER, AV_CH_LAYOUT_AUX_SIDE_LEFT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_FRONT_CENTER, AV_CH_LAYOUT_AUX_SIDE_FRONT_LEFT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_FRONT_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_LEFT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_LEFT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_RIGHT_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_SIDE_BACK_FRONT_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER_OF_CENTER, AV_CH_LAYOUT_AUX_S