L_SHIFT:
  if (n < 0) {
    mrb_raisef(mrbstateptr, E_ARGUMENT_ERROR, "negative array size (or size too big)");
  }

  if (n > len) {
    val = mrb_ary_new_capa(mrbstateptr, 0);
    ARY_SET_LEN(a, 0);
  }
  else if (n == 0) {
    val = mrb_ary_new_capa(mrbstateptr, 0);
  }
  else if (n == 1) {
    val = mrb_ary_shift(mrbstateptr, self);
  }
  else {
    val = ary_subseq(mrbstateptr, a, 0, n);
    if (ARY_SHARED_P(a)) {
      goto L_SHIFT_SHARED;
    }
    memmove(ARY_PTR(a), ARY_PTR(a) + n, (len - n) * sizeof(mrb_value));
    ARY_SET_LEN(a, len - n);
  L_SHIFT_SHARED: ;
  }