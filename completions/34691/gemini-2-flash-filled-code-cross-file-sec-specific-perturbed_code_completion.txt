if (n < 0) {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative array size");
  }
  if (n > len) {
    n = len;
  }

  if (n == 0) {
    return mrb_ary_new(mrb);
  }

  val = mrb_ary_new_capa(mrb, n);
  struct RArray *result_ary = mrb_ary_ptr(val);
  result_ary->len = n;

  if (len == 0) {
      return val;
  }

  if (ARY_SHARED_P(ary)) {
    mrb_value *src = ARY_PTR(ary);
    mrb_value *dst = ARY_PTR(result_ary);
    for (mrb_int i = 0; i < n; ++i) {
      dst[i] = src[i];
    }
  } else {
L_SHIFT:
    mrb_value *ptr = ARY_PTR(ary);
    mrb_value *dst = ARY_PTR(result_ary);
    for (mrb_int i = 0; i < n; ++i) {
      dst[i] = ptr[i];
    }

    for (mrb_int i = n; i < len; ++i) {
      ptr[i - n] = ptr[i];
    }
    ARY_SET_LEN(ary, len - n);
  }
  return val;