if (n < 0 || n > len) {
  mrb_raise(mrb, E_ARGUMENT_ERROR, "invalid shift count");
}

if (n == 0) {
  val = mrb_ary_new_capa(mrb, 0);
}
else if (n == 1) {
  val = mrb_ary_shift(mrb, self);
}
else {
  mrb_value *ptr = ARY_PTR(ary);

  if (ARY_SHARED_P(ary)) {
    struct RArray *tmp = ary_dup(mrb, ary);
    ary = tmp;
    ARY_SET_LEN(ary, len);
    ptr = ARY_PTR(ary);
  }

  val = mrb_ary_new_from_values(mrb, n, ptr);
  ARY_SET_LEN(ary, len - n);
  memmove(ptr, ptr + n, sizeof(mrb_value) * (len - n));
}