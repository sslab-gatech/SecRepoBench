if (n < 0) {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative array size");
  }
  if (n > len) {
    n = len;
  }

L_SHIFT:
  if (len == 0) {
    return mrb_nil_value();
  }

  val = mrb_ary_new(mrb);
  if (n == 0)
    return val;

  if (ARY_SHARED_P(ary)) {
    mrb_value *ptr = ARY_PTR(ary);
    mrb_ary_replace(mrb, val, mrb_ary_new_from_values(mrb, n, ptr));
    ARY_SET_LEN(ary, len - n);
    ARY_SET_PTR(ary, ptr + n);
  }
  else if (len < n) {
    mrb_ary_replace(mrb, val, self);
    ARY_SET_LEN(ary, 0);
  }
  else {
    mrb_value *ptr = ARY_PTR(ary);
    mrb_ary_replace(mrb, val, mrb_ary_new_from_values(mrb, n, ptr));
  }