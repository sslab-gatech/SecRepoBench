CASE(OP_EXT1, B) {
  uint8_t op = FETCH_B();
  switch (op) {
    CASE(OP_EXT1_CASE1) {
      /* handle OP_EXT1_CASE1 */
      mrb_value v = mrb_ary_new_from_values(mrb, b, &regs[a]);
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }
    CASE(OP_EXT1_CASE2) {
      /* handle OP_EXT1_CASE2 */
      mrb_ary_push(mrb, regs[a], regs[a+1]);
      NEXT;
    }
    CASE(OP_EXT1_CASE3) {
      /* handle OP_EXT1_CASE3 */
      mrb_value hash = mrb_hash_new_capa(mrb, b);
      int i;
      int lim = a+b*2;

      for (i=a; i<lim; i+=2) {
        mrb_hash_set(mrb, hash, regs[i], regs[i+1]);
      }
      regs[a] = hash;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }
    default:
      pc--;
      goto L_DEFAULT;
  }
  pc--;
  JUMP;
}

CASE(OP_EXT2, B) {
  uint8_t op = FETCH_B();
  switch (op) {
    CASE(OP_EXT2_CASE1) {
      /* handle OP_EXT2_CASE1 */
      mrb_value v = mrb_ary_new_from_values(mrb, b, &regs[a]);
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }
    CASE(OP_EXT2_CASE2) {
      /* handle OP_EXT2_CASE2 */
      mrb_ary_push(mrb, regs[a], regs[a+1]);
      NEXT;
    }
    CASE(OP_EXT2_CASE3) {
      /* handle OP_EXT2_CASE3 */
      mrb_value hash = mrb_hash_new_capa(mrb, b);
      int i;
      int lim = a+b*2;

      for (i=a; i<lim; i+=2) {
        mrb_hash_set(mrb, hash, regs[i], regs[i+1]);
      }
      regs[a] = hash;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }
    default:
      pc--;
      goto L_DEFAULT;
  }
  pc--;
  JUMP;
}

CASE(OP_EXT3, B) {
  uint8_t op = FETCH_B();
  switch (op) {
    CASE(OP_EXT3_CASE1) {
      /* handle OP_EXT3_CASE1 */
      mrb_value v = mrb_ary_new_from_values(mrb, b, &regs[a]);
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }
    CASE(OP_EXT3_CASE2) {
      /* handle OP_EXT3_CASE2 */
      mrb_ary_push(mrb, regs[a], regs[a+1]);
      NEXT;
    }
    CASE(OP_EXT3_CASE3) {
      /* handle OP_EXT3_CASE3 */
      mrb_value hash = mrb_hash_new_capa(mrb, b);
      int i;
      int lim = a+b*2;

      for (i=a; i<lim; i+=2) {
        mrb_hash_set(mrb, hash, regs[i], regs[i+1]);
      }
      regs[a] = hash;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }
    default:
      pc--;
      goto L_DEFAULT;
  }
  pc--;
  JUMP;
}