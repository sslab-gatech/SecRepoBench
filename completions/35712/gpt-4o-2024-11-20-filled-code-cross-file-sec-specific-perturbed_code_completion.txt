CASE(OP_EXT1, Z) {
      FETCH_Z();
      instruction = *pc++;
      switch (instruction) {
        CASE(OP_EXT1_ADD, BB) {
          FETCH_BB();
          regs[a] = mrb_fixnum_value(mrb_fixnum(regs[a]) + mrb_fixnum(regs[b]));
          NEXT;
        }
        CASE(OP_EXT1_SUB, BB) {
          FETCH_BB();
          regs[a] = mrb_fixnum_value(mrb_fixnum(regs[a]) - mrb_fixnum(regs[b]));
          NEXT;
        }
        default:
          mrb_raise(mrb, E_RUNTIME_ERROR, "unknown extended opcode");
      }
    }

    CASE(OP_EXT2, Z) {
      FETCH_Z();
      instruction = *pc++;
      switch (instruction) {
        CASE(OP_EXT2_MUL, BB) {
          FETCH_BB();
          regs[a] = mrb_fixnum_value(mrb_fixnum(regs[a]) * mrb_fixnum(regs[b]));
          NEXT;
        }
        CASE(OP_EXT2_DIV, BB) {
          FETCH_BB();
          if (mrb_fixnum(regs[b]) == 0) {
            mrb_raise(mrb, E_ZERO_DIV_ERROR, "division by zero");
          }
          regs[a] = mrb_fixnum_value(mrb_fixnum(regs[a]) / mrb_fixnum(regs[b]));
          NEXT;
        }
        default:
          mrb_raise(mrb, E_RUNTIME_ERROR, "unknown extended opcode");
      }
    }

    CASE(OP_EXT3, Z) {
      FETCH_Z();
      instruction = *pc++;
      switch (instruction) {
        CASE(OP_EXT3_MOD, BB) {
          FETCH_BB();
          if (mrb_fixnum(regs[b]) == 0) {
            mrb_raise(mrb, E_ZERO_DIV_ERROR, "modulo by zero");
          }
          regs[a] = mrb_fixnum_value(mrb_fixnum(regs[a]) % mrb_fixnum(regs[b]));
          NEXT;
        }
        CASE(OP_EXT3_POW, BB) {
          FETCH_BB();
          mrb_int base = mrb_fixnum(regs[a]);
          mrb_int exp = mrb_fixnum(regs[b]);
          if (exp < 0) {
            mrb_raise(mrb, E_ARGUMENT_ERROR, "negative exponent not allowed");
          }
          mrb_int result = 1;
          while (exp > 0) {
            if (exp % 2 == 1) {
              result *= base;
            }
            base *= base;
            exp /= 2;
          }
          regs[a] = mrb_fixnum_value(result);
          NEXT;
        }
        default:
          mrb_raise(mrb, E_RUNTIME_ERROR, "unknown extended opcode");
      }
    }