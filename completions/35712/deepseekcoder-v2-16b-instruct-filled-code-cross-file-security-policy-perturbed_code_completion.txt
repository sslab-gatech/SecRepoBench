CASE(OP_ASSOC, BB) {
      mrb_value v = mrb_hash_new_with_size(mrb, b);
      int i;

      for (i = 0; i < b; i++) {
        mrb_hash_set(mrb, v, regs[a+i*2], regs[a+i*2+1]);
      }
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_HASH, BB) {
      mrb_value v = mrb_hash_new_with_size(mrb, b);
      int i;

      for (i = 0; i < b; i++) {
        mrb_hash_set(mrb, v, regs[a+i*2], regs[a+i*2+1]);
      }
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_RANGE, BB) {
      mrb_value v;

      if (b == 1) {
        v = mrb_range_new(mrb, regs[a], regs[a+1], 0);
      }
      else {
        v = mrb_range_new(mrb, regs[a], regs[a+1], (mrb_int)regs[a+2]);
      }
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_REVERSE, B) {
      mrb_value v = mrb_ary_new_capa(mrb, b);
      int i;

      for (i = 0; i < b; i++) {
        mrb_ary_set(mrb, v, i, regs[a+b-1-i]);
      }
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_CONCAT, BB) {
      mrb_value v = mrb_ary_new_capa(mrb, b);
      int i;

      for (i = 0; i < b; i++) {
        mrb_ary_cat(mrb, v, regs[a+i]);
      }
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_SLICE, BBB) {
      mrb_value v = mrb_ary_new_capa(mrb, b);
      int i;

      for (i = 0; i < b; i++) {
        mrb_ary_set(mrb, v, i, regs[a+c+i]);
      }
      regs[a] = v;
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_LEN, B) {
      regs[a] = mrb_fixnum_value(b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_SIZE, B) {
      regs[a] = mrb_fixnum_value(b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_AREF, BB) {
      regs[a] = mrb_ary_ref(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_ASET, BBB) {
      mrb_ary_set(mrb, regs[a], b, regs[a+c]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_HREF, BB) {
      regs[a] = mrb_hash_ref(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_HSET, BBB) {
      mrb_hash_set(mrb, regs[a], b, regs[a+c]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SUB, BB) {
      regs[a] = mrb_str_substr(mrb, regs[a], b, c);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_AREF, BB) {
      regs[a] = mrb_str_ref(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_ASET, BBB) {
      mrb_str_set(mrb, regs[a], b, regs[a+c]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_LEN, B) {
      regs[a] = mrb_fixnum_value(mrb_str_len(mrb, regs[a]));
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_CMP, B) {
      if (mrb_str_cmp(mrb, regs[a], regs[a+1]) == 0) {
        SET_TRUE_VALUE(regs[a]);
      }
      else {
        SET_FALSE_VALUE(regs[a]);
      }
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_EQ, B) {
      if (mrb_str_eq(mrb, regs[a], regs[a+1])) {
        SET_TRUE_VALUE(regs[a]);
      }
      else {
        SET_FALSE_VALUE(regs[a]);
      }
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_CASECMP, B) {
      if (mrb_str_casecmp(mrb, regs[a], regs[a+1]) == 0) {
        SET_TRUE_VALUE(regs[a]);
      }
      else {
        SET_FALSE_VALUE(regs[a]);
      }
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_UPCASE, B) {
      regs[a] = mrb_str_upcase(mrb, regs[a]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_DOWNCASE, B) {
      regs[a] = mrb_str_downcase(mrb, regs[a]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_CAPITALIZE, B) {
      regs[a] = mrb_str_capitalize(mrb, regs[a]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SWAPCASE, B) {
      regs[a] = mrb_str_swapcase(mrb, regs[a]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_REVERSE, B) {
      regs[a] = mrb_str_reverse(mrb, regs[a]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_PLUS, B) {
      regs[a] = mrb_str_plus(mrb, regs[a], regs[a+1]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_MULT, BB) {
      regs[a] = mrb_str_times(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_EQQ, B) {
      if (mrb_str_eq(mrb, regs[a], regs[a+1])) {
        SET_TRUE_VALUE(regs[a]);
      }
      else {
        SET_FALSE_VALUE(regs[a]);
      }
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_MATCH, B) {
      if (mrb_str_match(mrb, regs[a], regs[a+1])) {
        SET_TRUE_VALUE(regs[a]);
      }
      else {
        SET_FALSE_VALUE(regs[a]);
      }
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SCAN, B) {
      if (mrb_str_scan(mrb, regs[a], regs[a+1])) {
        SET_TRUE_VALUE(regs[a]);
      }
      else {
        SET_FALSE_VALUE(regs[a]);
      }
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SUBPAT, BB) {
      regs[a] = mrb_str_subpat(mrb, regs[a], b, regs[a+1]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT, BB) {
      regs[a] = mrb_str_split(mrb, regs[a], b, regs[a+1]);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_WORDS, B) {
      regs[a] = mrb_str_split_words(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_NEWLINE, B) {
      regs[a] = mrb_str_split_newline(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_ARG, B) {
      regs[a] = mrb_str_split_arg(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_ARG_WORDS, B) {
      regs[a] = mrb_str_split_arg_words(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_ARG_NEWLINE, B) {
      regs[a] = mrb_str_split_arg_newline(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_ARG_ARG, B) {
      regs[a] = mrb_str_split_arg_arg(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_ARG_ARG_WORDS, B) {
      regs[a] = mrb_str_split_arg_arg_words(mrb, regs[a], b);
      mrb_gc_arena_restore(mrb, ai);
      NEXT;
    }

    CASE(OP_STR_SPLIT_ARG_ARG_NEWLINE, B) {
      regs[a] = mrb_str_split