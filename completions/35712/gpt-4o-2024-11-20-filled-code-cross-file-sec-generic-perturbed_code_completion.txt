CASE(OP_EXT1, Z) {
      FETCH_Z();
      instruction = *pc++;
      a = *pc++;
      switch (instruction) {
        CASE(OP_EXT1_ADD, B) {
          OP_MATH(add);
        }
        CASE(OP_EXT1_SUB, B) {
          OP_MATH(sub);
        }
        CASE(OP_EXT1_MUL, B) {
          OP_MATH(mul);
        }
        CASE(OP_EXT1_DIV, B) {
          mrb_float x, y, f;
          switch (TYPES2(mrb_type(regs[a]), mrb_type(regs[a+1]))) {
            case TYPES2(MRB_TT_INTEGER, MRB_TT_INTEGER):
              {
                mrb_int x = mrb_integer(regs[a]);
                mrb_int y = mrb_integer(regs[a+1]);
                mrb_int div = mrb_div_int(mrb, x, y);
                SET_INT_VALUE(mrb, regs[a], div);
              }
              NEXT;
            case TYPES2(MRB_TT_INTEGER, MRB_TT_FLOAT):
              x = (mrb_float)mrb_integer(regs[a]);
              y = mrb_float(regs[a+1]);
              break;
            case TYPES2(MRB_TT_FLOAT, MRB_TT_INTEGER):
              x = mrb_float(regs[a]);
              y = (mrb_float)mrb_integer(regs[a+1]);
              break;
            case TYPES2(MRB_TT_FLOAT, MRB_TT_FLOAT):
              x = mrb_float(regs[a]);
              y = mrb_float(regs[a+1]);
              break;
            default:
              c = 1;
              mid = MRB_OPSYM(div);
              goto L_SEND_SYM;
          }
          f = mrb_div_float(x, y);
          SET_FLOAT_VALUE(mrb, regs[a], f);
          NEXT;
        }
        default:
          goto L_RAISE;
      }
    }

    CASE(OP_EXT2, Z) {
      FETCH_Z();
      instruction = *pc++;
      a = *pc++;
      b = *pc++;
      switch (instruction) {
        CASE(OP_EXT2_ARRAY, BB) {
          mrb_value v = mrb_ary_new_from_values(mrb, b, &regs[a]);
          regs[a] = v;
          mrb_gc_arena_restore(mrb, ai);
          NEXT;
        }
        CASE(OP_EXT2_HASH, BB) {
          mrb_value hash = mrb_hash_new_capa(mrb, b);
          int i;
          int lim = a + b * 2;
          for (i = a; i < lim; i += 2) {
            mrb_hash_set(mrb, hash, regs[i], regs[i+1]);
          }
          regs[a] = hash;
          mrb_gc_arena_restore(mrb, ai);
          NEXT;
        }
        default:
          goto L_RAISE;
      }
    }

    CASE(OP_EXT3, Z) {
      FETCH_Z();
      instruction = *pc++;
      a = *pc++;
      b = *pc++;
      c = *pc++;
      switch (instruction) {
        CASE(OP_EXT3_AREF, BBB) {
          mrb_value v = regs[b];
          if (!mrb_array_p(v)) {
            if (c == 0) {
              regs[a] = v;
            } else {
              SET_NIL_VALUE(regs[a]);
            }
          } else {
            v = mrb_ary_ref(mrb, v, c);
            regs[a] = v;
          }
          NEXT;
        }
        CASE(OP_EXT3_ASET, BBB) {
          mrb_ary_set(mrb, regs[b], c, regs[a]);
          NEXT;
        }
        default:
          goto L_RAISE;
      }
    }