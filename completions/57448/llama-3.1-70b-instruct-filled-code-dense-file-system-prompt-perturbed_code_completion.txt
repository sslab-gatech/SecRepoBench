_packets_processed++;

  /* process packet */
  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_fin_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with FIN ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.flow_ack_seen) {
      fprintf(stderr, "[%8llu, %d] Skipping TCP packet with ACK\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream TCP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_UDP) {
    if (flow.is_midstream_flow) {
      fprintf(stderr, "[%8llu, %d] Skipping midstream UDP packet\n",
	      workflow->packets_captured, reader_thread->array_index);
      return;
    }
  }

  if (flow.l4_protocol == IPPROTO_TCP) {
    if