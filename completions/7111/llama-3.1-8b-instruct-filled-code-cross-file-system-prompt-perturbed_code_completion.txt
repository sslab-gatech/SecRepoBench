if (0)
RestoreMSCWarning
      (void) TIFFSetEXIFProperties(tiff,image,exception);
    TIFFClose(tiff);
    return(status);
}

// the below code fragment can be found in:
// coders/tiff.c
static void TIFFReadPhotoshopLayers(Image *image, const ImageInfo *image_info,
  ExceptionInfo *exception)
{
  const char
    *option;

  MagickBooleanType
    status;

  register ssize_t
    i;

  TIFF
    *tiff;

  TIFFField
    *field;

  TIFFInfo
    tiff_info;

  uint16
    *layers,
    *pages,
    *scenes;

  unsigned char
    *pixels;

  /*
    Open TIFF file.
  */
  assert(image_info!= (const ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  assert(image!= (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  if (image->debug!= MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
  assert(exception!= (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  status=OpenBlob(image_info,image,ReadBinaryBlobMode,exception);
  if (status == MagickFalse)
    return;
  (void) SetMagickThreadValue(tiff_exception,exception);
  tiff=TIFFClientOpen(image->filename,"rb",(thandle_t) image,TIFFReadBlob,
    TIFFWriteBlob,TIFFSeekBlob,TIFFCloseBlob,TIFFGetBlobSize,TIFFMapBlob,
    TIFFUnmapBlob);
  if (tiff == (TIFF *) NULL)
    return;
  if (GetTIFFInfo(image_info,tiff,&tiff_info) == MagickFalse)
    {
      TIFFClose(tiff);
      return;
    }
  pixels=(unsigned char *) GetQuantumPixels(tiff_info.scanline);
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PHOTOMETRIC,&tiff_info.photometric)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SAMPLESPERPIXEL,&tiff_info.samples_per_pixel)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_BITSPERSAMPLE,&tiff_info.bits_per_sample)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PLANARCONFIG,&tiff_info.interlace)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_ORIENTATION,&tiff_info.orientation)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_XRESOLUTION,&tiff_info.x_resolution)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_YRESOLUTION,&tiff_info.y_resolution)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_RESOLUTIONUNIT,&tiff_info.units)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_XPOSITION,&tiff_info.x_position)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_YPOSITION,&tiff_info.y_position)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_WHITEPOINT,&tiff_info.chromaticity)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PRIMARYCHROMATICITIES,&tiff_info.chromaticity)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_EXTRASAMPLES,&tiff_info.extra_samples)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_EXTRASAMPLE,&tiff_info.sample_info)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_TILEWIDTH,&tiff_info.columns)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_TILELENGTH,&tiff_info.rows)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.subfile_type)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PAGENUMBER,&tiff_info.page_number)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.pages)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.scenes)!= 1)
    {
      TIFFClose(tiff);
      return;
    }
  if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&tiff_info.layers)!= 1)
    {
      TIFFClose(tiff);
      return