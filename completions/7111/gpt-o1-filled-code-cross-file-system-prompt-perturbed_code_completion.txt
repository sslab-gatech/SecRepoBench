{
  /*
    Allocate memory for reading pixel data from TIFF.
  */
  size_t buffer_size = 0;

  switch (method)
  {
    case ReadSingleSampleMethod:
    case ReadRGBAMethod:
    case ReadYCCKMethod:
    case ReadCMYKAMethod:
    {
      /*
        For these methods, we read one row at a time.
      */
      buffer_size = (size_t) TIFFScanlineSize(tiff);
      break;
    }
    case ReadStripMethod:
    {
      /*
        For stripped images, we need space for an entire strip in RGBA format.
      */
      buffer_size = (size_t) rows_per_strip * (size_t) image->columns * sizeof(uint32);
      break;
    }
    default:
    {
      /*
        Other methods (e.g. tiled, generic) manage their own buffers.
      */
      buffer_size = 0;
      break;
    }
  }

  if (buffer_size != 0)
  {
    tiff_pixels = (unsigned char *) AcquireQuantumMemory(buffer_size, 1);
    if (tiff_pixels == (unsigned char *) NULL)
      ThrowTIFFException(ResourceLimitError,"MemoryAllocationFailed");
  }
}