mp_limb2 qhat, rhat;
  size_t j, k, qsize, rsize;

  for (j = 0; j < xd; j++) {
    qhat = 0;
    rhat = 0;

    // Estimate the quotient digit
    if (x.p[j + yd] >= y.p[yd - 1]) {
      qhat = DIG_MASK;
    } else {
      qhat = x.p[j + yd] / y.p[yd - 1];
    }

    // Calculate the remainder
    rhat = 0;
    for (k = 0; k < yd; k++) {
      rhat += x.p[j + k] - qhat * y.p[k];
      x.p[j + k] = rhat & DIG_MASK;
      rhat >>= DIG_SIZE;
    }

    // Adjust if the remainder is negative
    if (rhat != 0 || (rhat < 0 && (x.p[j + yd] < y.p[yd - 1]))) {
      qhat--;
      rhat = 0;
      for (k = 0; k < yd; k++) {
        rhat += x.p[j + k] + y.p[k];
        x.p[j + k] = rhat & DIG_MASK;
        rhat >>= DIG_SIZE;
      }
    }

    q.p[j] = qhat;
  }