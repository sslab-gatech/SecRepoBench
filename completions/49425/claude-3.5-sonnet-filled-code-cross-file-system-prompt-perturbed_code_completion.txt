for (index = xd - yd; index >= 0; index--) {
  mp_limb2 w = ((mp_limb2)x.p[index + yd] << DIG_SIZE) | x.p[index + yd - 1];
  mp_limb2 qhat = w / z;
  mp_limb2 rhat = w % z;

  while (qhat >= BASE || qhat * y.p[yd - 2] > BASE * rhat + x.p[index + yd - 2]) {
    qhat--;
    rhat += z;
    if (rhat >= BASE) break;
  }

  mp_limb2 k = 0;
  for (size_t i = 0; i < yd; i++) {
    mp_limb2 p = qhat * y.p[i];
    mp_limb2 t = x.p[index + i] - k - (p & (BASE - 1));
    x.p[index + i] = t & (BASE - 1);
    k = (p >> DIG_SIZE) - (t >> DIG_SIZE);
  }

  mp_limb2 t = x.p[index + yd] - k;
  x.p[index + yd] = t & (BASE - 1);

  q.p[index] = qhat & (BASE - 1);

  if (t < 0) {
    q.p[index]--;
    k = 0;
    for (size_t i = 0; i < yd; i++) {
      t = (mp_limb2)x.p[index + i] + y.p[i] + k;
      x.p[index + i] = t & (BASE - 1);
      k = t >> DIG_SIZE;
    }
    x.p[index + yd] += k;
  }
}