while (xd >= yd) {
  mp_limb2 cy = 0;
  mp_limb2 qhat = (x.p[xd-1] << (DIG_SIZE - ns)) / z;
  if (qhat) {
    if (qhat == (mp_limb2) -1 / z) {
      qhat--;
      cy = 1;
    }
    size_t i;
    for (i = 0; i < yd; i++) {
      mp_limb2 borrow = x.p[xd - 1 - i] - y.p[yd - 1 - i] * qhat - cy;
      x.p[xd - 1 - i] = borrow;
      cy = (borrow < 0);
    }
    if (cy) {
      qhat--;
      for (i = 0; i < yd; i++) {
        mp_limb2 borrow = x.p[xd - 1 - i] + y.p[yd - 1 - i];
        x.p[xd - 1 - i] = borrow;
        if (borrow >= (mp_limb2) 1 << DIG_SIZE) {
          x.p[xd - i - 1] = 1;
        }
      }
    }
  }
  q.p[xd - yd] = qhat;
  xd = digits(&x);
  ns = lzb(x.p[xd-1]);
}