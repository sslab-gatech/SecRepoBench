for (index = xd - yd; index >= 0; index--) {
  mp_limb2 w = ((mp_limb2)x.p[index + yd] << DIG_SIZE) | x.p[index + yd - 1];
  mp_limb2 qhat = w / z;
  mp_limb2 rhat = w % z;

  while (qhat >= BASE || qhat * y.p[yd - 2] > BASE * rhat + x.p[index + yd - 2]) {
    qhat--;
    rhat += z;
    if (rhat >= BASE) break;
  }

  mp_limb2 borrow = 0;
  for (size_t i = 0; i < yd; i++) {
    mp_limb2 p = qhat * y.p[i];
    mp_limb2 t = x.p[index + i] - borrow - (p & (BASE - 1));
    x.p[index + i] = t & (BASE - 1);
    borrow = (p >> DIG_SIZE) - (t >> DIG_SIZE);
  }

  if (x.p[index + yd] < borrow) {
    mp_limb2 carry = 0;
    for (size_t i = 0; i < yd; i++) {
      mp_limb2 t = (mp_limb2)x.p[index + i] + y.p[i] + carry;
      x.p[index + i] = t & (BASE - 1);
      carry = t >> DIG_SIZE;
    }
    qhat--;
  }

  q.p[index] = qhat & (BASE - 1);
}