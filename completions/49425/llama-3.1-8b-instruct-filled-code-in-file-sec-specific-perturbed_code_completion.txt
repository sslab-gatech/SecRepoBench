static void
udiv(mrb_state *mrb, mpz_t *qq, mpz_t *rr, mpz_t *xx, mpz_t *yy)
{
  /* simple cases */
  int cmp = ucmp(xx, yy);
  if (cmp == 0) {
    mpz_set_int(mrb, qq, 1);
    zero(rr);
    return;
  }
  else if (cmp < 0) {
    zero(qq);
    mpz_set(mrb, rr, yy);
    return;
  }

  mpz_t q, x, y;
  size_t index;

  mrb_assert(!uzero(yy));       /* divided by zero */
  mpz_init(mrb, &q);
  mpz_init(mrb, &x);
  mpz_init(mrb, &y);
  mpz_realloc(mrb, &x, xx->sz+1);
  size_t yd = digits(yy);
  size_t ns = lzb(yy->p[yd-1]);
  ulshift(mrb, &x, xx, ns);
  ulshift(mrb, &y, yy, ns);
  size_t xd = digits(&x);
  mpz_realloc(mrb, &q, xd);
  mp_limb2 z = y.p[yd-1];
  // Perform long division of the unsigned integers represented by `xx` and `yy`.
  for (size_t i=0; i < xd; i++) {
    mp_limb2 c = 0;
    mp_limb2 a = x.p[i];
    mp_limb2 b = y.p[i];
    for (size_t j=0; j < DIG_SIZE; j++) {
      mp_limb2 d = c + a * b;
      c = d >> DIG_SIZE;
      a = d;
    }
    z += c;
    if (i == 0) {
      rr->p[0] = LOW(z);
    }
    else {
      rr->p[i] = LOW(z);
    }
    z = HIGH(z);
  }
  rr->p[rr->sz] = z;
  trim(rr);
  mpz_set(mrb, qq, &q);
  mpz_clear(mrb, &x);
  mpz_clear(mrb, &y);
  mpz_clear(mrb, &q);
}