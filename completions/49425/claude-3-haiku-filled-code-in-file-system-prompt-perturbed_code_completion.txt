mp_limb2 z = y.p[yd-1];
if (z == 0) {
  mrb_raise(mrb, E_DIVISION_BY_ZERO_ERROR, "division by zero");
}
size_t q_len = xd - yd + 1;
mpz_realloc(mrb, &q, q_len);
for (size_t i = 0; i < q_len; i++) {
  mp_limb2 qd;
  if (x.p[xd-i] == y.p[yd-1]) {
    qd = DIG_MASK;
  } else {
    qd = (((mp_limb2)x.p[xd-i] << DIG_SIZE) + x.p[xd-i-1]) / z;
  }
  q.p[i] = LOW(qd);
  mp_limb2 r = 0;
  for (size_t j = 0; j <= yd; j++) {
    mp_limb2 p = (mp_limb2)y.p[j] * qd;
    r += (mp_limb2)x.p[xd-i+j] - LOW(p);
    x.p[xd-i+j] = LOW(r);
    r = HIGH(r) - HIGH(p);
  }
  if (r != 0) {
    qd--;
    r = 0;
    for (size_t j = 0; j <= yd; j++) {
      r += (mp_limb2)x.p[xd-i+j] + (mp_limb2)y.p[j];
      x.p[xd-i+j] = LOW(r);
      r = HIGH(r);
    }
  }
  q.p[i] = LOW(qd);
}