for (index = xd; index-- > yd;) {
    mp_limb2 qhat = x.p[index] / z;
    mp_limb2 rhat = x.p[index] % z;

    if (qhat >= (1ULL << DIG_SIZE)) {
      qhat = (1ULL << DIG_SIZE) - 1;
      rhat += z;
    }

    while (rhat < (1ULL << DIG_SIZE) && qhat * y.p[yd - 2] > ((rhat << DIG_SIZE) | x.p[index - 1])) {
      qhat--;
      rhat += z;
      if (rhat >= (1ULL << DIG_SIZE)) break;
    }

    mpz_t t;
    mpz_init(mrb, &t);
    mpz_realloc(mrb, &t, yd);
    for (size_t i = 0; i < yd; i++) {
      t.p[i] = y.p[i] * qhat;
    }

    if (ucmp(&x, &t) < 0) {
      qhat--;
      for (size_t i = 0; i < yd; i++) {
        t.p[i] -= y.p[i];
      }
    }

    for (size_t i = 0; i < yd; i++) {
      x.p[index - yd + i] -= t.p[i];
    }

    q.p[index - yd] = qhat;
    mpz_clear(mrb, &t);
  }