for (index = xd - yd; index >= 0; index--) {
  mp_limb2 w = ((mp_limb2)x.p[index + yd] << DIG_SIZE) | x.p[index + yd - 1];
  mp_limb q_digit = w / z;
  mp_limb r = w % z;
  while (index + yd >= 2 && q_digit * y.p[yd - 2] > ((r << DIG_SIZE) | x.p[index + yd - 2])) {
    q_digit--;
    r += z;
    if (r >= (1ULL << DIG_SIZE)) break;
  }
  mpz_t tmp;
  mpz_init(mrb, &tmp);
  mpz_set_int(mrb, &tmp, q_digit);
  ulshift(mrb, &tmp, &tmp, index * DIG_SIZE);
  mpz_sub(mrb, &x, &x, &tmp);
  mpz_mul(mrb, &tmp, &y, &tmp);
  mpz_sub(mrb, &x, &x, &tmp);
  q.p[index] = q_digit;
  if (ucmp(&x, &y) >= 0) {
    q.p[index]++;
    mpz_sub(mrb, &x, &x, &y);
  }
  mpz_clear(mrb, &tmp);
}