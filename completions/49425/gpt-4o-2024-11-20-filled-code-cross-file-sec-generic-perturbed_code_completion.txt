for (index = xd; index-- > yd;) {
    mp_limb2 w = x.p[index];
    if (index > 0) {
      w = (w << DIG_SIZE) | x.p[index - 1];
    }
    mp_limb2 qhat = w / z;
    mp_limb2 rhat = w % z;

    if (qhat >= (1ULL << DIG_SIZE)) {
      qhat = (1ULL << DIG_SIZE) - 1;
      rhat += z;
    }

    while (rhat < (1ULL << DIG_SIZE) && qhat * y.p[yd - 2] > ((rhat << DIG_SIZE) | x.p[index - 2])) {
      qhat--;
      rhat += z;
      if (rhat >= (1ULL << DIG_SIZE)) {
        break;
      }
    }

    mpz_t t;
    mpz_init(mrb, &t);
    mpz_realloc(mrb, &t, yd);
    for (size_t i = 0; i < yd; i++) {
      t.p[i] = y.p[i];
    }
    umul(mrb, &t, &t, qhat);
    if (usub(mrb, &x, &x, &t, index - yd + 1)) {
      qhat--;
      uadd(mrb, &x, &x, &t, index - yd + 1);
    }
    q.p[index - yd] = qhat;
    mpz_clear(mrb, &t);
  }