for (index = xd - yd; ; index--) {
    mp_limb2 qhat = x.p[index+yd-1];
    if (index+yd < xd)
      qhat = (qhat << DIG_SIZE) | x.p[index+yd];
    qhat /= z;
    if (qhat > DIG_MASK) qhat = DIG_MASK;
    /* q.p[index] = qhat */
    /* x -= qhat*y*b^index */
    mp_limb2 borrow = 0;
    for (i=0; i < yd; i++) {
      borrow += (mp_limb2)x.p[index+i];
      borrow -= qhat * (mp_limb2)y.p[i];
      x.p[index+i] = LOW(borrow);
      borrow = HIGH(borrow);
    }
    if (index+i < xd) {
      borrow += x.p[index+i];
      x.p[index+i] = LOW(borrow);
      borrow = HIGH(borrow);
    }
    mrb_assert(borrow==0 || borrow == -1);
    q.p[index] = qhat;
    if (borrow) {
      q.p[index]--;
      mp_limb2 carry = 0;
      for (i=0; i < yd; i++) {
        carry += (mp_limb2)x.p[index+i];
        carry += (mp_limb2)y.p[i];
        x.p[index+i] = LOW(carry);
        carry = HIGH(carry);
      }
      if (index+i < xd) {
        carry += x.p[index+i];
        x.p[index+i] = LOW(carry);
        carry = HIGH(carry);
      }
      mrb_assert(carry==1);
    }
    if (index == 0) break;
  }