for (index = xd; index-- > yd;) {
    mp_limb2 qhat;
    mp_limb2 rhat;
    mp_limb2 x0 = x.p[index];
    mp_limb2 x1 = (index > 0) ? x.p[index - 1] : 0;

    if (x0 == z) {
      qhat = MP_LIMB_MAX;
      rhat = x1;
    }
    else {
      mp_limb2 num = (x0 << DIG_SIZE) | x1;
      qhat = num / z;
      rhat = num % z;
    }

    while (qhat * y.p[yd - 2] > ((rhat << DIG_SIZE) | ((index > 1) ? x.p[index - 2] : 0))) {
      qhat--;
      rhat += z;
      if (rhat >= z) break;
    }

    mpz_t qy;
    mpz_init(mrb, &qy);
    mpz_realloc(mrb, &qy, yd + 1);
    umul(mrb, &qy, &y, qhat);
    if (usub(mrb, &x, &x, &qy, index - yd + 1)) {
      qhat--;
      uadd(mrb, &x, &x, &y, index - yd + 1);
    }
    q.p[index - yd] = qhat;
    mpz_clear(mrb, &qy);
  }