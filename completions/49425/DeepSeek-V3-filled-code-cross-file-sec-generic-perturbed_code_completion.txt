for (size_t i = xd; i-- > yd; ) {
    mp_limb2 qhat = (x.p[i] << DIG_SIZE) + x.p[i-1];
    qhat /= z;
    mp_limb2 carry = 0;
    for (size_t j = 0; j < yd; j++) {
      mp_limb2 product = qhat * y.p[j];
      mp_limb2 sum = x.p[i-yd+j] + carry;
      if (sum < carry) {
        carry = 1;
      } else {
        carry = 0;
      }
      sum += (product & DIG_MASK);
      if (sum < (product & DIG_MASK)) {
        carry++;
      }
      carry += (product >> DIG_SIZE);
      x.p[i-yd+j] = sum;
    }
    if (carry > x.p[i]) {
      qhat--;
      carry = 0;
      for (size_t j = 0; j < yd; j++) {
        mp_limb2 sum = x.p[i-yd+j] + y.p[j] + carry;
        if (sum < y.p[j]) {
          carry = 1;
        } else {
          carry = 0;
        }
        x.p[i-yd+j] = sum;
      }
    }
    q.p[i-yd] = qhat;
    x.p[i] -= carry;
  }