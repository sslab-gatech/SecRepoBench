for (index = xd; index > yd; ) {
    --index;
    mp_limb1 num = x.p[index];
    mp_limb2 nn = ((mp_limb2)num << DIG_SIZE) | x.p[index-1];
    mp_limb1 qhat = nn / z;
    mp_limb1 rhat = nn % z;

    while (z * qhat > ((nn << DIG_SIZE) | x.p[index-2])) {
      qhat--;
      rhat += z;
      if (rhat >= ((mp_limb1)1 << DIG_SIZE))
        break;
    }
    x.p[index] = 0;
    mp_limb1 borrow = usub(mrb, &x.p[index-1], &x.p[index-1], qhat * y.p[yd-1]);
    if (yd > 1) {
      borrow += usub(mrb, &x.p[index-2], &x.p[index-2], qhat * y.p[yd-2]);
    }
    if (borrow) {
      qhat--;
      mp_limb1 carry = uadd(mrb, &x.p[index-1], &x.p[index-1], y.p[yd-1]);
      if (yd > 1) {
        carry += uadd(mrb, &x.p[index-2], &x.p[index-2], y.p[yd-2]);
      }
    }
    q.p[index-yd] = qhat;
  }