for (index = xd - yd; index >= 0; index--) {
    mp_limb2 qhat = (x.p[index+yd]*DIG_BASE + x.p[index+yd-1])/z;
    if (qhat >= DIG_BASE) qhat = DIG_BASE-1;
    mp_limb2 borrow = 0;
    for (size_t i=0; i < yd; i++) {
      mp_limb2 p = (mp_limb2)y.p[i] * qhat + borrow;
      borrow = p >> DIG_SIZE;
      mp_limb2 diff = x.p[index+i] - LOW(p);
      x.p[index+i] = LOW(diff);
      if (diff & ((mp_limb2)1<<DIG_SIZE))
        borrow++;
    }
    mp_limb2 diff = x.p[index+yd] - borrow;
    x.p[index+yd] = LOW(diff);
    if (!(diff & ((mp_limb2)1<<DIG_SIZE)) && qhat) {
      q.p[index] = qhat;
    }
    else {
      q.p[index] = qhat-1;
      mp_limb2 carry = 0;
      for (size_t i=0; i < yd; i++) {
        carry += (mp_limb2)x.p[index+i] + (mp_limb2)y.p[i];
        x.p[index+i] = LOW(carry);
        carry >>= DIG_SIZE;
      }
      x.p[index+yd] += carry;
    }
  }