/* Zero out quotient digits */
  for (size_t i = 0; i < xd; i++) {
    q.p[i] = 0;
  }

  /* Perform long division (Knuth's Algorithm D) */
  for (size_t i = xd; i-- > yd - 1;) {
    mp_limb2 top = ((mp_limb2)x.p[i] << DIG_SIZE);
    if (i > 0) top |= x.p[i - 1];

    mp_limb2 qhat = top / z;
    mp_limb2 rhat = top % z;

    /* Check for over-estimation */
    if (qhat == DIG_BASE) {
      qhat = DIG_BASE - 1;
    }
    if (yd > 1) {
      mp_limb2 next_y = y.p[yd - 2];
      mp_limb2 left = (rhat << DIG_SIZE) + (i > 1 ? x.p[i - 2] : 0);
      mp_limb2 want = (mp_limb2)next_y * qhat;
      if (left < want) {
        qhat--;
        rhat += z;
        if (rhat < DIG_BASE && ((rhat << DIG_SIZE) + (i > 1 ? x.p[i - 2] : 0) < (mp_limb2)next_y * qhat)) {
          qhat--;
        }
      }
    }

    /* Multiply and subtract */
    mp_limb2 carry = 0;
    for (size_t j = 0; j < yd; j++) {
      mp_limb2 mul = (mp_limb2)y.p[j] * qhat + carry;
      mp_limb2 sub = (mp_limb2)x.p[i - (yd - 1) + j] - (mul & DIG_MASK);
      x.p[i - (yd - 1) + j] = LOW(sub);
      carry = (mul >> DIG_SIZE) + HIGH(sub);
    }

    /* Check for borrow */
    if (x.p[i + 1] < carry) {
      /* Correct the estimate */
      qhat--;
      mp_limb2 rec = 0;
      for (size_t j = 0; j < yd; j++) {
        mp_limb2 tmp = (mp_limb2)x.p[i - (yd - 1) + j] + (mp_limb2)y.p[j] + rec;
        x.p[i - (yd - 1) + j] = LOW(tmp);
        rec = tmp >> DIG_SIZE;
      }
      x.p[i + 1] += rec;
    }

    /* Store quotient digit */
    q.p[i - (yd - 1)] = (mp_limb)qhat;
  }