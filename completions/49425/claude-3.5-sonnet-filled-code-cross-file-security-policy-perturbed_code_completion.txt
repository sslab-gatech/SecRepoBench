for (index = xd - 1; index >= yd - 1; index--) {
  mp_limb2 w = ((mp_limb2)x.p[index + 1] << DIG_SIZE) | x.p[index];
  mp_limb2 qhat = w / z;
  mp_limb2 rhat = w % z;

  while (qhat > DIG_BASE || qhat * y.p[yd - 2] > (rhat << DIG_SIZE) | x.p[index - 1]) {
    qhat--;
    rhat += z;
    if (rhat >= DIG_BASE)
      break;
  }

  mp_limb2 k = 0;
  for (size_t i = 0; i < yd; i++) {
    mp_limb2 p = qhat * y.p[i];
    mp_limb2 t = x.p[index - yd + 1 + i] - k - (p & DIG_MASK);
    x.p[index - yd + 1 + i] = t & DIG_MASK;
    k = (p >> DIG_SIZE) - (t >> DIG_SIZE);
  }

  x.p[index + 1] -= k;

  q.p[index - yd + 1] = qhat & DIG_MASK;

  if (x.p[index + 1] != 0) {
    q.p[index - yd + 1]--;
    k = 0;
    for (size_t i = 0; i < yd; i++) {
      mp_limb2 t = (mp_limb2)x.p[index - yd + 1 + i] + y.p[i] + k;
      x.p[index - yd + 1 + i] = t & DIG_MASK;
      k = t >> DIG_SIZE;
    }
    x.p[index + 1] += k;
  }
}
q.sz = xd - yd + 1;