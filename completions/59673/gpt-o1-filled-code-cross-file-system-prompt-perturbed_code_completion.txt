linesize   = s->linesize >> lowres;
    uvlinesize = s->uvlinesize >> lowres;

    if (field_based) {
        linesize   <<= 1;
        uvlinesize <<= 1;
        if (bottom_field) {
            dest_y  += linesize;
            dest_cb += uvlinesize;
            dest_cr += uvlinesize;
        }
    }

    mx = motion_x;
    my = motion_y;
    if (s->quarter_sample) {
        mx >>= 1;
        my >>= 1;
    }

    sx = mx & s_mask;
    sy = my & s_mask;

    sourcex = s->mb_x * block_s + (mx >> lowres);
    src_y   = mb_y     * block_s + (my >> lowres);

    {
        ptrdiff_t offset = src_y * linesize + sourcex;
        ptr_y = ref_picture[0] + offset;

        if ((unsigned)sourcex > FFMAX(h_edge_pos - (!!sx) - block_s, 0) ||
            (unsigned)src_y   > FFMAX(v_edge_pos - (!!sy) - h, 0)) {
            s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_y,
                                     linesize, linesize,
                                     block_s + 1, h + 1,
                                     sourcex, src_y,
                                     h_edge_pos, v_edge_pos);
            ptr_y = s->sc.edge_emu_buffer;
        }

        // Luma sub-pixel motion compensation would go here (e.g. put/avg pix).
        // For brevity, it's omitted; implement as needed, e.g. using s->hdsp MC funcs.
    }

    if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
        int cmx = ff_h263_round_chroma(mx);
        int cmy = ff_h263_round_chroma(my);

        uvsx = cmx & s_mask;
        uvsy = cmy & s_mask;

        uvsrc_x = (s->mb_x * block_s >> s->chroma_x_shift) + (cmx >> (lowres + s->chroma_x_shift));
        uvsrc_y = (mb_y     * block_s >> s->chroma_y_shift) + (cmy >> (lowres + s->chroma_y_shift));

        ptr_cb = ref_picture[1] + uvsrc_y * uvlinesize + uvsrc_x;
        ptr_cr = ref_picture[2] + uvsrc_y * uvlinesize + uvsrc_x;

        if ((unsigned)uvsrc_x > FFMAX((h_edge_pos >> s->chroma_x_shift) - (!!uvsx) - (block_s >> s->chroma_x_shift), 0) ||
            (unsigned)uvsrc_y > FFMAX((v_edge_pos >> s->chroma_y_shift) - (!!uvsy) - (h >> s->chroma_y_shift), 0)) {
            s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_cb,
                                     uvlinesize, uvlinesize,
                                     (block_s >> s->chroma_x_shift) + 1,
                                     (h >> s->chroma_y_shift) + 1,
                                     uvsrc_x, uvsrc_y,
                                     h_edge_pos >> s->chroma_x_shift,
                                     v_edge_pos >> s->chroma_y_shift);
            ptr_cb = s->sc.edge_emu_buffer;
            pix_op[op_index](dest_cb, ptr_cb, uvlinesize,
                             h >> s->chroma_y_shift,
                             (uvsx << 2) >> (lowres + s->chroma_x_shift),
                             (uvsy << 2) >> (lowres + s->chroma_y_shift));

            s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_cr,
                                     uvlinesize, uvlinesize,
                                     (block_s >> s->chroma_x_shift) + 1,
                                     (h >> s->chroma_y_shift) + 1,
                                     uvsrc_x, uvsrc_y,
                                     h_edge_pos >> s->chroma_x_shift,
                                     v_edge_pos >> s->chroma_y_shift);
            ptr_cr = s->sc.edge_emu_buffer;
            pix_op[op_index](dest_cr, ptr_cr, uvlinesize,
                             h >> s->chroma_y_shift,
                             (uvsx << 2) >> (lowres + s->chroma_x_shift),
                             (uvsy << 2) >> (lowres + s->chroma_y_shift));
        } else {
            pix_op[op_index](dest_cb, ptr_cb, uvlinesize,
                             h >> s->chroma_y_shift,
                             (uvsx << 2) >> (lowres + s->chroma_x_shift),
                             (uvsy << 2) >> (lowres + s->chroma_x_shift));
            pix_op[op_index](dest_cr, ptr_cr, uvlinesize,
                             h >> s->chroma_y_shift,
                             (uvsx << 2) >> (lowres + s->chroma_x_shift),
                             (uvsy << 2) >> (lowres + s->chroma_x_shift));
        }
    }