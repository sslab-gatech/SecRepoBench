linesize   = s->current_picture.f->linesize[0] << field_based;
    uvlinesize = s->current_picture.f->linesize[1] << field_based;

    ptr_y  = ref_picture[0];
    ptr_cb = ref_picture[1];
    ptr_cr = ref_picture[2];

    if (s->quarter_sample) {
        motion_x <<= 1;
        motion_y <<= 1;
    }

    src_y   = s->mb_y * 2 * block_s             + (motion_y >> (lowres + 1));
    sourcex = s->mb_x * 2 * block_s             + (motion_x >> (lowres + 1));
    src_y  &= ~((1 << lowres) - 1);
    sourcex &= ~((1 << lowres) - 1);
    src_y   = FFMAX(src_y, 0);
    sourcex = FFMAX(sourcex, 0);
    src_y   = FFMIN(src_y, (s->height >> lowres) - (2 * block_s));
    sourcex = FFMIN(sourcex, (s->width >> lowres)  - (2 * block_s));

    ptr_y  += src_y * linesize + sourcex;
    ptr_cb += (src_y >> s->chroma_y_shift) * uvlinesize + (sourcex >> s->chroma_x_shift);
    ptr_cr += (src_y >> s->chroma_y_shift) * uvlinesize + (sourcex >> s->chroma_x_shift);

    sx = (motion_x << (2 - lowres)) & s_mask;
    sy = (motion_y << (2 - lowres)) & s_mask;

    pix_op[lowres - 1](dest_y, ptr_y, linesize, h, sx, sy);

    if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
        uvsx = (motion_x << (2 - lowres)) >> s->chroma_x_shift;
        uvsy = (motion_y << (2 - lowres)) >> s->chroma_y_shift;
        uvsx &= s_mask;
        uvsy &= s_mask;
        pix_op[op_index](dest_cb, ptr_cb, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
        pix_op[op_index](dest_cr, ptr_cr, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
    }
    // if s->encoding is set, perform motion compensation on the other field
    if (s->encoding) {
        // Note: this can be optimized further
        src_y   = FFMAX(src_y - (1 << lowres), 0);
        sourcex = FFMAX(sourcex - (1 << lowres), 0);
        ptr_y  = ref_picture[0] + src_y * linesize + sourcex;
        ptr_cb = ref_picture[1] + (src_y >> s->chroma_y_shift) * uvlinesize + (sourcex >> s->chroma_x_shift);
        ptr_cr = ref_picture[2] + (src_y >> s->chroma_y_shift) * uvlinesize + (sourcex >> s->chroma_x_shift);
        pix_op[lowres - 1](dest_y + (s->mb_y & 1) * s->linesize, ptr_y, linesize, h, sx, sy);
        if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
            pix_op[op_index](dest_cb + (s->mb_y & 1) * s->uvlinesize, ptr_cb, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
            pix_op[op_index](dest_cr + (s->mb_y & 1) * s->uvlinesize, ptr_cr, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
        }
    }