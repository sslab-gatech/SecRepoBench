mx = motion_x & s_mask;
my = motion_y & s_mask;
sourcex = s->mb_x * block_s + (motion_x >> lowres + 1);
src_y = s->mb_y * block_s + (motion_y >> lowres + 1);

linesize = s->linesize;
uvlinesize = s->uvlinesize;

if ((unsigned) sourcex > FFMAX(h_edge_pos - (!!mx) - block_s, 0) ||
    (unsigned) src_y > FFMAX(v_edge_pos - (!!my) - block_s, 0)) {
    s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ref_picture[0] + (src_y * linesize) + sourcex,
                             linesize, linesize,
                             block_s, block_s,
                             sourcex, src_y, h_edge_pos, v_edge_pos);
    ptr_y = s->sc.edge_emu_buffer;
} else {
    ptr_y = ref_picture[0] + (src_y * linesize) + sourcex;
}

uvsrc_x = (sourcex >> s->chroma_x_shift);
uvsrc_y = (src_y >> s->chroma_y_shift);

if ((unsigned) uvsrc_x > FFMAX(h_edge_pos - (!!mx) - block_s, 0) >>
    s->chroma_x_shift ||
    (unsigned) uvsrc_y > FFMAX(v_edge_pos - (!!my) - block_s, 0) >>
    s->chroma_y_shift) {
    s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ref_picture[1] + (uvsrc_y * uvlinesize) + uvsrc_x,
                             uvlinesize, uvlinesize,
                             block_s >> s->chroma_x_shift, block_s >> s->chroma_y_shift,
                             uvsrc_x, uvsrc_y, h_edge_pos >> s->chroma_x_shift,
                             v_edge_pos >> s->chroma_y_shift);
    ptr_cb = s->sc.edge_emu_buffer;
} else {
    ptr_cb = ref_picture[1] + (uvsrc_y * uvlinesize) + uvsrc_x;
}

if ((unsigned) uvsrc_x > FFMAX(h_edge_pos - (!!mx) - block_s, 0) >>
    s->chroma_x_shift ||
    (unsigned) uvsrc_y > FFMAX(v_edge_pos - (!!my) - block_s, 0) >>
    s->chroma_y_shift) {
    s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ref_picture[2] + (uvsrc_y * uvlinesize) + uvsrc_x,
                             uvlinesize, uvlinesize,
                             block_s >> s->chroma_x_shift, block_s >> s->chroma_y_shift,
                             uvsrc_x, uvsrc_y, h_edge_pos >> s->chroma_x_shift,
                             v_edge_pos >> s->chroma_y_shift);
    ptr_cr = s->sc.edge_emu_buffer;
} else {
    ptr_cr = ref_picture[2] + (uvsrc_y * uvlinesize) + uvsrc_x;
}

if (field_based) {
    if (bottom_field) {
        dest_y += s->linesize;
        dest_cb += s->uvlinesize;
        dest_cr += s->uvlinesize;
    }
    if (field_select) {
        ptr_y += s->linesize;
        ptr_cb += s->uvlinesize;
        ptr_cr += s->uvlinesize;
    }
}

pix_op[op_index](dest_y, ptr_y, linesize, block_s, mx, my);
pix_op[op_index](dest_cb, ptr_cb, uvlinesize, block_s >> s->chroma_x_shift, mx >> s->chroma_x_shift, my >> s->chroma_y_shift);
pix_op[op_index](dest_cr, ptr_cr, uvlinesize, block_s >> s->chroma_x_shift, mx >> s->chroma_x_shift, my >> s->chroma_y_shift);