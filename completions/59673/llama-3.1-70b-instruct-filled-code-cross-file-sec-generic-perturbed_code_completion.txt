if (field_based) {
    if (bottom_field) {
        ptr_y = ref_picture[0] + (motion_y >> lowres) * s->linesize +
                (motion_x >> lowres);
        ptr_cb = ref_picture[1] + (motion_y >> (lowres + s->chroma_y_shift)) *
                 s->uvlinesize + (motion_x >> (lowres + s->chroma_x_shift));
        ptr_cr = ref_picture[2] + (motion_y >> (lowres + s->chroma_y_shift)) *
                 s->uvlinesize + (motion_x >> (lowres + s->chroma_x_shift));
    } else {
        ptr_y = ref_picture[0] + (motion_y >> lowres) * s->linesize +
                (motion_x >> lowres) + s->linesize;
        ptr_cb = ref_picture[1] + (motion_y >> (lowres + s->chroma_y_shift)) *
                 s->uvlinesize + (motion_x >> (lowres + s->chroma_x_shift));
        ptr_cr = ref_picture[2] + (motion_y >> (lowres + s->chroma_y_shift)) *
                 s->uvlinesize + (motion_x >> (lowres + s->chroma_x_shift));
    }
} else {
    ptr_y = ref_picture[0] + (motion_y >> lowres) * s->linesize +
            (motion_x >> lowres);
    ptr_cb = ref_picture[1] + (motion_y >> (lowres + s->chroma_y_shift)) *
             s->uvlinesize + (motion_x >> (lowres + s->chroma_x_shift));
    ptr_cr = ref_picture[2] + (motion_y >> (lowres + s->chroma_y_shift)) *
             s->uvlinesize + (motion_x >> (lowres + s->chroma_x_shift));
}

uvlinesize = s->uvlinesize;
linesize = s->linesize;

mx = motion_x & s_mask;
my = motion_y & s_mask;
sourcex = s->mb_x * block_s + (motion_x >> lowres);
src_y = mb_y * block_s + (motion_y >> lowres);
uvsrc_x = s->mb_x * block_s + (motion_x >> (lowres + s->chroma_x_shift));
uvsrc_y = mb_y * block_s + (motion_y >> (lowres + s->chroma_y_shift));

sx = mx & (2 << lowres) - 1;
sy = my & (2 << lowres) - 1;
uvsx = sx >> s->chroma_x_shift;
uvsy = sy >> s->chroma_y_shift;

if (field_select) {
    if ((unsigned) (sourcex + sx) > h_edge_pos ||
        (unsigned) (src_y + sy) > v_edge_pos) {
        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_y,
                                 linesize, linesize,
                                 9, 9,
                                 sourcex, src_y, h_edge_pos, v_edge_pos);
        ptr_y = s->sc.edge_emu_buffer;
    }
    if ((unsigned) (uvsrc_x + uvsx) > h_edge_pos ||
        (unsigned) (uvsrc_y + uvsy) > v_edge_pos) {
        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_cb,
                                 uvlinesize, uvlinesize,
                                 9, 9,
                                 uvsrc_x, uvsrc_y, h_edge_pos, v_edge_pos);
        ptr_cb = s->sc.edge_emu_buffer;
        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_cr,
                                 uvlinesize, uvlinesize,
                                 9, 9,
                                 uvsrc_x, uvsrc_y, h_edge_pos, v_edge_pos);
        ptr_cr = s->sc.edge_emu_buffer;
    }
}

pix_op[op_index](dest_y, ptr_y, linesize, block_s, sx, sy);
if (!CONFIG_GRAY ||!(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
    pix_op[op_index](dest_cb, ptr_cb, uvlinesize, block_s >> s->chroma_y_shift, uvsx, uvsy);
    pix_op[op_index](dest_cr, ptr_cr, uvlinesize, block_s >> s->chroma_y_shift, uvsx, uvsy);
}