linesize   = s->linesize   << field_based;
    uvlinesize = s->uvlinesize << field_based;

    sx = motion_x & s_mask;
    sy = motion_y & s_mask;
    mx = motion_x >> lowres + 1;
    my = motion_y >> lowres + 1;

    src_y = mb_y * block_s + my;
    sourcex = s->mb_x * block_s + mx;

    ptr_y  = ref_picture[0] + src_y * linesize + sourcex;
    src_y = (src_y * (1 << (1 + s->chroma_y_shift))) >> (1 + lowres);
    if (field_select)
        src_y += s->v_edge_pos >> (lowres + 1);

    uvsrc_y = src_y >> s->chroma_y_shift;
    uvsrc_x = sourcex >> s->chroma_x_shift;

    ptr_cb = ref_picture[1] + uvsrc_y * uvlinesize + uvsrc_x;
    ptr_cr = ref_picture[2] + uvsrc_y * uvlinesize + uvsrc_x;

    if (bottom_field) { //FIXME merge with other cases
        dest_y += s->linesize;
        dest_cb += s->uvlinesize;
        dest_cr += s->uvlinesize;
    }

    if ((unsigned)sourcex > FFMAX(h_edge_pos - (!!sx) - block_s, 0) ||
        (unsigned)src_y    > FFMAX(s->v_edge_pos >> lowres - (!!sy) - h, 0)) {
        uint8_t *uvbuf = s->sc.edge_emu_buffer + 18 * s->uvlinesize;

        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_y,
                                 linesize, linesize,
                                 9, 9 + field_based,
                                 sourcex, src_y << field_based,
                                 h_edge_pos, s->v_edge_pos);
        ptr_y = s->sc.edge_emu_buffer;

        s->vdsp.emulated_edge_mc(uvbuf, ptr_cb,
                                 s->uvlinesize, s->uvlinesize,
                                 9, 9 + field_based,
                                 uvsrc_x, uvsrc_y << field_based,
                                 s->h_edge_pos >> s->chroma_x_shift,
                                 s->v_edge_pos >> s->chroma_y_shift);
        ptr_cb = uvbuf;

        s->vdsp.emulated_edge_mc(uvbuf + 16, ptr_cr,
                                 s->uvlinesize, s->uvlinesize,
                                 9, 9 + field_based,
                                 uvsrc_x, uvsrc_y << field_based,
                                 s->h_edge_pos >> s->chroma_x_shift,
                                 s->v_edge_pos >> s->chroma_y_shift);
        ptr_cr = uvbuf + 16;

    }

    sx = (sx << 2) >> lowres;
    sy = (sy << 2) >> lowres;

    if (!s->quarter_sample) {
        s->hdsp.put_pixels_tab[0][op_index](dest_y, ptr_y, linesize, h);
        pix_op[op_index](dest_cb, ptr_cb, uvlinesize, block_s, sx, sy);
        pix_op[op_index](dest_cr, ptr_cr, uvlinesize, block_s, sx, sy);
    } else {
        s->hdsp.put_no_rnd_pixels_tab[lowres](dest_y, ptr_y, linesize, h, sx, sy);
        pix_op[op_index](dest_cb, ptr_cb, uvlinesize, block_s, sx, sy);
        pix_op[op_index](dest_cr, ptr_cr, uvlinesize, block_s, sx, sy);
    }