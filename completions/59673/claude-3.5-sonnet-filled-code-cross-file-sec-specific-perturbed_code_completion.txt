mx = motion_x >> lowres;
my = motion_y >> lowres;
sourcex = s->mb_x * block_s + (mx >> 1);
src_y = mb_y * block_s + (my >> 1);
uvsrc_x = s->mb_x * block_s + (mx >> 2);
uvsrc_y = mb_y * block_s + (my >> 2);
sx = mx & s_mask;
sy = my & s_mask;
uvsx = (mx & (s_mask + 1)) >> 1;
uvsy = (my & (s_mask + 1)) >> 1;

if (field_based) {
    mb_y   = s->mb_y;
    dest_y += s->linesize;
    if (bottom_field) {
        src_y++;
        uvsrc_y++;
        mb_y++;
    }
}

if ((unsigned)sourcex >= h_edge_pos - (!!sx) - 2 * block_s ||
    (unsigned)src_y   >= v_edge_pos - (!!sy) - h) {
    s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_y - !!sy * linesize,
                             linesize, linesize, 17, 17 + field_based,
                             sourcex - !!sx, src_y - !!sy, h_edge_pos, v_edge_pos);
    ptr_y = s->sc.edge_emu_buffer + !!sy * linesize + !!sx;
}
if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
    if ((unsigned)uvsrc_x >= h_edge_pos - (!!uvsx) - block_s ||
        (unsigned)uvsrc_y >= v_edge_pos - (!!uvsy) - h) {
        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_cb - !!uvsy * uvlinesize,
                                 uvlinesize, uvlinesize, 9, 9 + field_based,
                                 uvsrc_x - !!uvsx, uvsrc_y - !!uvsy, h_edge_pos, v_edge_pos);
        ptr_cb = s->sc.edge_emu_buffer + !!uvsy * uvlinesize + !!uvsx;

        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer + 16, ptr_cr - !!uvsy * uvlinesize,
                                 uvlinesize, uvlinesize, 9, 9 + field_based,
                                 uvsrc_x - !!uvsx, uvsrc_y - !!uvsy, h_edge_pos, v_edge_pos);
        ptr_cr = s->sc.edge_emu_buffer + 16 + !!uvsy * uvlinesize + !!uvsx;
    }
}

if (bottom_field) {
    dest_y  += s->linesize;
    dest_cb += s->uvlinesize;
    dest_cr += s->uvlinesize;
}

if (field_select) {
    ptr_y   += s->linesize;
    ptr_cb  += s->uvlinesize;
    ptr_cr  += s->uvlinesize;
}

sx = (sx << 2) >> lowres;
sy = (sy << 2) >> lowres;
uvsx = (uvsx << 2) >> lowres;
uvsy = (uvsy << 2) >> lowres;

pix_op[lowres - 1](dest_y, ptr_y, linesize, h, sx, sy);

if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
    pix_op[op_index](dest_cb, ptr_cb, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
    pix_op[op_index](dest_cr, ptr_cr, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
}