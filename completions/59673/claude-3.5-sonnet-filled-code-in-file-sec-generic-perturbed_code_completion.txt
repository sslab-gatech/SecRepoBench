if (s->quarter_sample) {
        motion_x /= 2;
        motion_y /= 2;
    }

    sx = motion_x & s_mask;
    sy = motion_y & s_mask;
    src_x += motion_x >> lowres + 1;
    src_y += motion_y >> lowres + 1;

    uvsrc_x = src_x >> 1;
    uvsrc_y = src_y >> 1;

    uvsx = (motion_x >> 1) & s_mask;
    uvsy = (motion_y >> 1) & s_mask;

    ptr_y  = ref_picture[0] + src_y * linesize + src_x;
    ptr_cb = ref_picture[1] + uvsrc_y * uvlinesize + uvsrc_x;
    ptr_cr = ref_picture[2] + uvsrc_y * uvlinesize + uvsrc_x;

    linesize   = s->linesize;
    uvlinesize = s->uvlinesize;

    if (field_based) {
        linesize   *= 2;
        uvlinesize *= 2;
        if (bottom_field) {
            src_y++;
            uvsrc_y++;
            ptr_y  += linesize;
            ptr_cb += uvlinesize;
            ptr_cr += uvlinesize;
        }
    }

    if ((unsigned)src_x > FFMAX(h_edge_pos - (!!sx) - w, 0) ||
        (unsigned)src_y > FFMAX((v_edge_pos >> field_based) - (!!sy) - h, 0)) {
        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_y,
                                 linesize, linesize,
                                 w + 1, (h + 1) << field_based,
                                 src_x, src_y * (1 << field_based),
                                 h_edge_pos, v_edge_pos);
        ptr_y = s->sc.edge_emu_buffer;
        if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
            uint8_t *uvbuf = s->sc.edge_emu_buffer + 21 * linesize;
            s->vdsp.emulated_edge_mc(uvbuf, ptr_cb,
                                     uvlinesize, uvlinesize,
                                     (w + 1) >> 1, ((h + 1) << field_based) >> 1,
                                     uvsrc_x, uvsrc_y * (1 << field_based),
                                     h_edge_pos >> 1, v_edge_pos >> 1);
            s->vdsp.emulated_edge_mc(uvbuf + 16, ptr_cr,
                                     uvlinesize, uvlinesize,
                                     (w + 1) >> 1, ((h + 1) << field_based) >> 1,
                                     uvsrc_x, uvsrc_y * (1 << field_based),
                                     h_edge_pos >> 1, v_edge_pos >> 1);
            ptr_cb = uvbuf;
            ptr_cr = uvbuf + 16;
        }
    }

    if (bottom_field) {
        dest_y  += s->linesize;
        dest_cb += s->uvlinesize;
        dest_cr += s->uvlinesize;
    }

    if (field_select) {
        ptr_y   += linesize;
        ptr_cb  += uvlinesize;
        ptr_cr  += uvlinesize;
    }

    sx = (sx << 2) >> lowres;
    sy = (sy << 2) >> lowres;
    pix_op[lowres - 1](dest_y, ptr_y, linesize, h, sx, sy);

    if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
        uvsx = (uvsx << 2) >> lowres;
        uvsy = (uvsy << 2) >> lowres;
        pix_op[op_index](dest_cb, ptr_cb, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
        pix_op[op_index](dest_cr, ptr_cr, uvlinesize, h >> s->chroma_y_shift, uvsx, uvsy);
    }