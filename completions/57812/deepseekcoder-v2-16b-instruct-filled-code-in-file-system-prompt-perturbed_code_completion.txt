gb, sps->log2_max_poc_lsb);
            sps->lt_ref_pic_poc_msb_sps[i]       = get_bits(gb, 16 - sps->log2_max_poc_lsb);
            sps->lt_ref_pic_used_for_long_term_flag[i] = get_bits1(gb);
            sps->lt_ref_pic_flag_valid[i]         = get_bits1(gb);
        }
    }

    sps->sps_temporal_mvp_enabled_flag = get_bits1(gb);
    sps->strong_intra_smoothing_enabled_flag = get_bits1(gb);

    sps->vui_parameters_present_flag = get_bits1(gb);
    if (sps->vui_parameters_present_flag) {
        vui_present = 1;
        decode_vui(gb, avctx, apply_defdispwin, sps);
    } else {
        vui_present = 0;
    }

    sps->entropy_coding_sync_enabled_flag = get_bits1(gb);

    sps->num_of_arrays = get_ue_golomb_long(gb);
    if (sps->num_of_arrays > 1024) {
        av_log(avctx, AV_LOG_ERROR, "Too many arrays: %d.\n",
               sps->num_of_arrays);
        return AVERROR_INVALIDDATA;
    }

    for (i = 0; i < sps->num_of_arrays; i++) {
        int array_type = get_ue_golomb_long(gb);
        int num_elements = get_ue_golomb_long(gb);
        int element_size = get_ue_golomb_long(gb);
        int element_type = get_ue_golomb_long(gb);
        int element_bit_width = get_ue_golomb_long(gb);
        int element_signed_type = get_bits1(gb);
        int element_default_value = get_se_golomb(gb);

        if (array_type >= FF_ARRAY_ELEMS(ff_hevc_array_type_name)) {
            av_log(avctx, AV_LOG_ERROR, "Invalid array type: %d.\n",
                   array_type);
            return AVERROR_INVALIDDATA;
        }

        if (element_type >= FF_ARRAY_ELEMS(ff_hevc_element_type_name)) {
            av_log(avctx, AV_LOG_ERROR, "Invalid element type: %d.\n",
                   element_type);
            return AVERROR_INVALIDDATA;
        }

        if (element_bit_width > 64) {
            av_log(avctx, AV_LOG_ERROR, "Invalid element bit width: %d.\n",
                   element_bit_width);
            return AVERROR_INVALIDDATA;
        }

        if (num_elements > 1024) {
            av_log(avctx, AV_LOG_ERROR, "Too many elements: %d.\n",
                   num_elements);
            return AVERROR_INVALIDDATA;
        }

        if (element_size != num_elements) {
            av_log(avctx, AV_LOG_ERROR, "Element size mismatch: %d != %d.\n",
                   element_size, num_elements);
            return AVERROR_INVALIDDATA;
        }

        if (element_bit_width == 0) {
            element_bit_width = 8 * element_size;
        }

        sps->arrays[array_type].num_elements = num_elements;
        sps->arrays[array_type].element_type = element_type;
        sps->arrays[array_type].element_bit_width = element_bit_width;
        sps->arrays[array_type].element_signed_type = element_signed_type;
        sps->arrays[array_type].element_default_value = element_default_value;
    }

    sps->range_extension_flag = get_bits1(gb);
    if (sps->range_extension_flag) {
        sps->color_primaries = get_bits(gb, 8);
        sps->transfer_characteristics = get_bits(gb, 8);
        sps->matrix_coeffs = get_bits(gb, 8);

        if (sps->color_primaries > 255 || sps->transfer_characteristics > 255 ||
            sps->matrix_coeffs > 255) {
            av_log(avctx, AV_LOG_ERROR, "Invalid color/transfer/matrix coeffs\n");
            return AVERROR_INVALIDDATA;
        }

        if (sps->color_primaries == 255)
            sps->color_primaries = AVCOL_PRI_UNSPECIFIED;
        if (sps->transfer_characteristics == 255)
            sps->transfer_characteristics = AVCOL_TRC_UNSPECIFIED;
        if (sps->matrix_coeffs == 255)
            sps->matrix_coeffs = AVCOL_SPC_UNSPECIFIED;

        if (sps->color_primaries == AVCOL_PRI_BT709 ||
            sps->color_primaries == AVCOL_PRI_BT470M ||
            sps->color_primaries == AVCOL_PRI_BT470BG ||
            sps->color_primaries == AVCOL_PRI_SMPTE170M ||
            sps->color_primaries == AVCOL_PRI_SMPTE240M ||
            sps->color_primaries == AVCOL_PRI_FILM) {
            sps->color_trc = sps->transfer_characteristics;
        } else {
            sps->color_trc = sps->transfer_characteristics;
        }

        sps->video_signal_type_present_flag = get_bits1(gb);
        if (sps->video_signal_type_present_flag) {
            sps->video_full_range_flag = get_bits1(gb);
            sps->colour_description_present_flag = get_bits1(gb);
            if (sps->colour_description_present_flag) {
                sps->colour_primaries = get_bits(gb, 8);
                sps->colour_trc = get_bits(gb, 8);
                sps->col_matrix = get_bits(gb, 8);

                if (sps->colour_primaries > 255 || sps->colour_trc > 255 ||
                    sps->col_matrix > 255) {
                    av_log(avctx, AV_LOG_ERROR, "Invalid color/transfer/matrix coeffs\n");
                    return AVERROR_INVALIDDATA;
                }

                if (sps->colour_primaries == 255)
                    sps->colour_primaries = AVCOL_PRI_UNSPECIFIED;
                if (sps->colour_trc == 255)
                    sps->colour_trc = AVCOL_TRC_UNSPECIFIED;
                if (sps->col_matrix == 255)
                    sps->col_matrix = AVCOL_SPC_UNSPECIFIED;
            }
        }

        sps->chromaticity_coords_present_flag = get_bits1(gb);
        if (sps->chromaticity_coords_present_flag) {
            sps->chromaticity_coords.x_0 = get_bits(gb, 16);
            sps->chromaticity_coords.y_0 = get_bits(gb, 16);
            sps->chromaticity_coords.x_1 = get_bits(gb, 16);
            sps->chromaticity_coords.y_1 = get_bits(gb, 16);
        }

        sps->timing_info_present_flag = get_bits1(gb);
        if (sps->timing_info_present_flag) {
            sps->num_units_in_tick = get_bits_long(gb, 32);
            sps->time_scale = get_bits_long(gb, 32);
            sps->poc_proportional_to_timing_flag = get_bits1(gb);
            if (sps->poc_proportional_to_timing_flag)
                sps->num_ticks_poc_diff_one_minus1 = get_ue_golomb_long(gb) + 1;
        }

        sps->bitstream_restriction_flag = get_bits1(gb);
        if (sps->bitstream_restriction_flag) {
            sps->tiles_fixed_structure_flag = get_bits1(gb);
            sps->motion_vectors_over_pic_boundaries_flag = get_bits1(gb);
            sps->restricted_ref_pic_lists_flag = get_bits1(gb);
            sps->min_spatial_segmentation_idc = get_ue_golomb_long(gb);
            sps->max_bytes_per_pic_denom = get_ue_golomb_long(gb);
            sps->max_bits_per_min_cu_denom = get_ue_golomb_long(gb);
            sps->log2_max_mv_length_horizontal = get_ue_golomb_long(gb);
            sps->log2_max_mv_length_vertical = get_ue_golomb_long(gb);
        }
    }

    if (vps_list) {
        if (vps_list[sps->vps_id]) {
            HEVCVPS *vps = (HEVCVPS*)vps_list[sps->vps_id]->data;
            sps->vps = vps;
            sps->vps_id = vps->vps_id;
        } else {
            sps->vps = NULL;
        }
    } else {
        sps->vps = NULL;
    }

    if (sps->vps && sps->vps->vps_sub_layer_ordering_info_present_flag) {
        for (i = 0; i < sps->max_sub_layers; i++) {
            sps->temporal_layer[i].max_dec_pic_buffering = vui_present ?
                vps->vps_max_dec_pic_buffering[i] : sps->temporal_layer[i].max_dec_pic_buffering;
            sps->temporal_layer[i].num_reorder_pics = vui_present ?
                vps->vps_num_reorder_pics[i] : sps->temporal_layer[i].num_reorder_pics;
            sps->temporal_layer[i].max_latency_increase = vui_present ?
                vps->vps_max_latency_increase[i] : sps->temporal_layer[i].max_latency_increase;
        }
    }

    if (sps->vps && sps->vps->vps_timing_info_present_flag) {
        sps->num_units_in_tick = vui_present ?
            vps->vps_num_units_in_tick : sps->num_units_in_tick;
        sps->time_scale = vui_present ?
            vps->vps_time_scale : sps->time_scale;
        sps->poc_proportional_to_timing_flag = vui_present ?
            vps->vps_poc_proportional_to_timing_flag : sps->poc_proportional_to_timing_flag;
        if (sps->poc_proportional_to_timing_flag)
            sps->num_ticks_poc_diff_one_minus1 = vui_present ?
                vps->vps_num_ticks_poc_diff_one : sps->num_ticks_poc_diff_one_minus1;
    }

    if (sps->vps && sps->vps->vps_hrd_parameters_present_flag) {
        for (i = 0; i < sps->vps->vps_num_hrd_parameters; i++) {
            int common_inf_