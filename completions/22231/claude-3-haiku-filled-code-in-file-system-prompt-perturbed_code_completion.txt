slice->ref = cram_get_ref(fd, slice->hdr->ref_seq_id,
                         slice->hdr->ref_seq_start,
                         slice->hdr->ref_seq_start + slice->hdr->ref_seq_span - 1);
slice->ref_start = slice->hdr->ref_seq_start;
slice->ref_end   = slice->hdr->ref_seq_start + slice->hdr->ref_seq_span - 1;

// Sanity check
if (slice->ref_start < 0) {
    hts_log_warning("Slice starts before base 1"
                    " at #%d:%"PRId64"-%"PRId64, ref_id, slice->hdr->ref_seq_start,
                    slice->hdr->ref_seq_start + slice->hdr->ref_seq_span - 1);
    slice->ref_start = 0;
}
pthread_mutex_lock(&fd->ref_lock);
pthread_mutex_lock(&fd->refs->lock);
if ((fd->required_fields & SAM_SEQ) &&
    ref_id < fd->refs->nref &&
    slice->ref_end > fd->refs->ref_id[ref_id]->length) {
    slice->ref_end = fd->refs->ref_id[ref_id]->length;
}
pthread_mutex_unlock(&fd->refs->lock);
pthread_mutex_unlock(&fd->ref_lock);