}
                break;
            }
            }
        }
    }

    //fprintf(stderr, "=== ENCODE SLICE %d ===\n", c->curr_slice);

    /* Encode records */
    last_pos = INT64_MIN;
    for (rec = 0; rec < s->hdr->num_records; rec++) {
        cram_record *cr = &s->crecs[rec];
        int out_sz = 1;

        if (cr->flags & BAM_FUNMAP) {
            if (h->codecs[DS_BF]) {
                r |= h->codecs[DS_BF]->encode(s, h->codecs[DS_BF],
                                              s->block[DS_BF], (char *)&cr->flags,
                                              &out_sz);
                if (r) return -1;
            }
        } else {
            if (h->codecs[DS_BF]) {
                r |= h->codecs[DS_BF]->encode(s, h->codecs[DS_BF],
                                              s->block[DS_BF], (char *)&cr->flags,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_AP]) {
                r |= h->codecs[DS_AP]->encode(s, h->codecs[DS_AP],
                                              s->block[DS_AP], (char *)&cr->apos,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_RG]) {
                r |= h->codecs[DS_RG]->encode(s, h->codecs[DS_RG],
                                              s->block[DS_RG], (char *)&cr->rg,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_RL]) {
                r |= h->codecs[DS_RL]->encode(s, h->codecs[DS_RL],
                                              s->block[DS_RL], (char *)&cr->len,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_RN] && c->read_names_included) {
                int out_sz2 = cr->name_len;
                r |= h->codecs[DS_RN]->encode(s, h->codecs[DS_RN],
                                              s->block[DS_RN], (char *)cr->name,
                                              &out_sz2);
                if (r) return -1;
            }

            if (h->codecs[DS_MF] && (cr->cram_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_MF]->encode(s, h->codecs[DS_MF],
                                              s->block[DS_MF], (char *)&cr->mate_flags,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_NS] && (cr->cram_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_NS]->encode(s, h->codecs[DS_NS],
                                              s->block[DS_NS], (char *)&cr->mate_ref_id,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_NP] && (cr->cram_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_NP]->encode(s, h->codecs[DS_NP],
                                              s->block[DS_NP], (char *)&cr->mate_pos,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_TS] && (cr->cram_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_TS]->encode(s, h->codecs[DS_TS],
                                              s->block[DS_TS], (char *)&cr->tlen,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_QS] && cr->len >= 0) {
                r |= h->codecs[DS_QS]->encode(s, h->codecs[DS_QS],
                                              s->block[DS_QS], (char *)cr->qual,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_BA] && cr->len) {
                r |= h->codecs[DS_BA]->encode(s, h->codecs[DS_BA],
                                              s->block[DS_BA], (char *)cr->seq,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_MQ] && cr->len >= 0) {
                r |= h->codecs[DS_MQ]->encode(s, h->codecs[DS_MQ],
                                              s->block[DS_MQ], (char *)&cr->mqual,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_NS] && cr->mate_ref_id >= 0) {
                r |= h->codecs[DS_NS]->encode(s, h->codecs[DS_NS],
                                              s->block[DS_NS], (char *)&cr->mate_ref_id,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_MF] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_MF]->encode(s, h->codecs[DS_MF],
                                              s->block[DS_MF], (char *)&cr->mate_flags,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_RN] && c->read_names_included) {
                int out_sz2 = cr->name_len;
                r |= h->codecs[DS_RN]->encode(s, h->codecs[DS_RN],
                                              s->block[DS_RN], (char *)cr->name,
                                              &out_sz2);
                if (r) return -1;
            }

            if (h->codecs[DS_NP] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_NP]->encode(s, h->codecs[DS_NP],
                                              s->block[DS_NP], (char *)&cr->mate_pos,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_TS] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_TS]->encode(s, h->codecs[DS_TS],
                                              s->block[DS_TS], (char *)&cr->tlen,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_QS] && cr->len >= 0) {
                r |= h->codecs[DS_QS]->encode(s, h->codecs[DS_QS],
                                              s->block[DS_QS], (char *)cr->qual,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_BA] && cr->len) {
                r |= h->codecs[DS_BA]->encode(s, h->codecs[DS_BA],
                                              s->block[DS_BA], (char *)cr->seq,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_MQ] && cr->len >= 0) {
                r |= h->codecs[DS_MQ]->encode(s, h->codecs[DS_MQ],
                                              s->block[DS_MQ], (char *)&cr->mqual,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_NS] && cr->mate_ref_id >= 0) {
                r |= h->codecs[DS_NS]->encode(s, h->codecs[DS_NS],
                                              s->block[DS_NS], (char *)&cr->mate_ref_id,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_MF] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_MF]->encode(s, h->codecs[DS_MF],
                                              s->block[DS_MF], (char *)&cr->mate_flags,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_RN] && c->read_names_included) {
                int out_sz2 = cr->name_len;
                r |= h->codecs[DS_RN]->encode(s, h->codecs[DS_RN],
                                              s->block[DS_RN], (char *)cr->name,
                                              &out_sz2);
                if (r) return -1;
            }

            if (h->codecs[DS_NP] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_NP]->encode(s, h->codecs[DS_NP],
                                              s->block[DS_NP], (char *)&cr->mate_pos,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_TS] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_TS]->encode(s, h->codecs[DS_TS],
                                              s->block[DS_TS], (char *)&cr->tlen,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_QS] && cr->len >= 0) {
                r |= h->codecs[DS_QS]->encode(s, h->codecs[DS_QS],
                                              s->block[DS_QS], (char *)cr->qual,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_BA] && cr->len) {
                r |= h->codecs[DS_BA]->encode(s, h->codecs[DS_BA],
                                              s->block[DS_BA], (char *)cr->seq,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_MQ] && cr->len >= 0) {
                r |= h->codecs[DS_MQ]->encode(s, h->codecs[DS_MQ],
                                              s->block[DS_MQ], (char *)&cr->mqual,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_NS] && cr->mate_ref_id >= 0) {
                r |= h->codecs[DS_NS]->encode(s, h->codecs[DS_NS],
                                              s->block[DS_NS], (char *)&cr->mate_ref_id,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_MF] && (cr->mate_flags & CRAM_FLAG_DETACHED)) {
                r |= h->codecs[DS_MF]->encode(s, h->codecs[DS_MF],
                                              s->block[DS_MF], (char *)&cr->mate_flags,
                                              &out_sz);
                if (r) return -1;
            }

            if (h->codecs[DS_RN] && c->read_names_included) {
                int out_sz2 = cr->name_len;
                r |= h->codecs[DS_RN]->encode(s, h->codecs[DS_RN],
                                              s->block[DS_RN], (char *)cr->name,
                                              &out_sz2);
                if (r) return -1;
            }

            if (h->codecs