if (embed_ref) {
    if (slice->hdr->ref_base_id < 0) {
        hts_log_error("No reference specified and no embedded reference is available"
                      " at #%d:%"PRId64"-%"PRId64, ref_id, slice->hdr->ref_seq_start,
                      slice->hdr->ref_seq_start + slice->hdr->ref_seq_span-1);
        return -1;
    }
    cram_block *b = cram_get_block_by_id(slice, slice->hdr->ref_base_id);
    if (!b)
        return -1;
    if (cram_uncompress_block(b) != 0)
        return -1;
    slice->ref = (char *)b->data;
    slice->ref_start = slice->hdr->ref_seq_start;
    slice->ref_end = slice->hdr->ref_seq_start + slice->hdr->ref_seq_span - 1;
    if (slice->ref_end > bfd->ref[ref_id]->length) {
        hts_log_error("Embedded reference extends beyond end of reference sequence");
        return -1;
    }
}