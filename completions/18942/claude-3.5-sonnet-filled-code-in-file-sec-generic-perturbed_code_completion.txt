{
  YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[compiler->loop_depth];
  int var_frame = _yr_compiler_get_var_frame(compiler);
  int i;

  // Clean up any existing loop variables
  loop_vars_cleanup(compiler->loop_depth);

  // Reset loop depth to 0
  compiler->loop_depth = 0;

  // Initialize frame for local variables in current loop context
  loop_ctx->vars_count = 0;
  loop_ctx->vars_internal_count = 0;

  // Set up necessary variables, respecting loop nesting limits
  if (compiler->loop_depth < YR_MAX_LOOP_NESTING)
  {
    // Allocate space for loop variables
    for (i = 0; i < YR_MAX_LOOP_VARS; i++)
    {
      fail_if_error(yr_parser_emit_with_arg(
          yyscanner, OP_CLEAR_M, var_frame + i, NULL, NULL));
    }

    // Initialize loop iteration counter
    fail_if_error(yr_parser_emit_with_arg(
        yyscanner, OP_PUSH, 0, NULL, NULL));
    fail_if_error(yr_parser_emit_with_arg(
        yyscanner, OP_STORE_M, var_frame + YR_LOOP_LOCAL_VARS, NULL, NULL));
  }
  else
  {
    // Error: exceeded maximum loop nesting
    fail_if_error(ERROR_LOOP_NESTING_LIMIT_EXCEEDED);
  }
}