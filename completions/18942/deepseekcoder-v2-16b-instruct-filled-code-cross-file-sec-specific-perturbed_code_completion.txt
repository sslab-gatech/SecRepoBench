// Handle error recovery for loops by cleaning up loop variables
// and resetting the loop depth to zero. If an error occurs while
// parsing an inner loop, the cleanup will propagate to the outer
// loops. This ensures that all resources associated with loop
// variables are properly released before handling the error.
// <MASK>

// Loop variables cleanup function
static void loop_vars_cleanup(int loop_depth) {
    YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[loop_depth];
    for (int i = 0; i < loop_ctx->vars_count; i++) {
        yr_free((loop_ctx->vars[i].identifier));
    }
    loop_ctx->vars_count = 0;
}

// Initialize the frame for local variables in the current loop context
static void initialize_loop_context(int loop_depth) {
    YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[loop_depth];
    loop_ctx->vars_internal_count = 3; // Assuming 3 internal variables for loop context
    loop_ctx->vars_count = 0;
    loop_ctx->addr = NULL;
}

// Function to handle loop variable cleanup and initialization
static void handle_loop_context(int loop_depth) {
    loop_vars_cleanup(loop_depth);
    initialize_loop_context(loop_depth);
}

// Add the following code at the beginning of yyreduce for loop-related reductions
case 87: // for_expression
    handle_loop_context(compiler->loop_depth);
    break;

case 88: // for_of_expression
    handle_loop_context(compiler->loop_depth);
    break;

case 89: // for_in_expression
    handle_loop_context(compiler->loop_depth);
    break;

case 102: // for_expression_any
    handle_loop_context(compiler->loop_depth);
    break;

case 103: // for_expression_all
    handle_loop_context(compiler->loop_depth);
    break;

case 104: // for_expression_1
    handle_loop_context(compiler->loop_depth);
    break;

case 105: // for_expression_2
    handle_loop_context(compiler->loop_depth);
    break;

case 106: // for_expression_any_int
    handle_loop_context(compiler->loop_depth);
    break;

case 107: // for_expression_all_int
    handle_loop_context(compiler->loop_depth);
    break;

case 108: // for_expression_1_int
    handle_loop_context(compiler->loop_depth);
    break;

case 109: // for_expression_2_int
    handle_loop_context(compiler->loop_depth);
    break;

case 110: // for_expression_any_float
    handle_loop_context(compiler->loop_depth);
    break;

case 111: // for_expression_all_float
    handle_loop_context(compiler->loop_depth);
    break;

case 112: // for_expression_1_float
    handle_loop_context(compiler->loop_depth);
    break;

case 113: // for_expression_2_float
    handle_loop_context(compiler->loop_depth);
    break;

case 114: // for_expression_any_string
    handle_loop_context(compiler->loop_depth);
    break;

case 115: // for_expression_all_string
    handle_loop_context(compiler->loop_depth);
    break;

case 116: // for_expression_1_string
    handle_loop_context(compiler->loop_depth);
    break;

case 117: // for_expression_2_string
    handle_loop_context(compiler->loop_depth);
    break;

case 118: // for_expression_any_regexp
    handle_loop_context(compiler->loop_depth);
    break;

case 119: // for_expression_all_regexp
    handle_loop_context(compiler->loop_depth);
    break;

case 120: // for_expression_1_regexp
    handle_loop_context(compiler->loop_depth);
    break;

case 121: // for_expression_2_regexp
    handle_loop_context(compiler->loop_depth);
    break;