// <MASK>
// This code handles the loop control flow and loop variable management.

// Cleanup any loop variables associated with the current loop context.
void loop_vars_cleanup(int loop_depth)
{
    YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[loop_depth];

    for (int i = 0; i < loop_ctx->vars_count; i++)
    {
        yr_free(loop_ctx->vars[i].identifier);
    }

    loop_ctx->vars_count = 0;
    loop_ctx->vars_internal_count = 0;
}

// Initialize the frame for local variables in the current loop context,
// setting up necessary variables and ensuring that loop nesting limits
// are respected.
int _yr_compiler_get_var_frame(YR_COMPILER* compiler)
{
    int var_frame = 0;

    for (int i = 0; i < compiler->loop_depth; i++)
    {
        var_frame += compiler->loop[i].vars_internal_count;
    }

    if (var_frame + 3 + compiler->loop[compiler->loop_depth].vars_count > YR_MAX_LOOP_VARS)
    {
        yr_compiler_set_error_extra_info(compiler, "too many loop variables");
        return -1;
    }

    return var_frame;
}