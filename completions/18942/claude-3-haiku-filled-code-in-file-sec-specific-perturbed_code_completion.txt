YR_FIXUP* fixup;
uint8_t* pop_addr;
int var_frame;

compiler->loop_depth--;

loop_vars_cleanup(compiler->loop_depth);

var_frame = _yr_compiler_get_var_frame(compiler);

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_ADD_M, var_frame + 0, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_INCR_M, var_frame + 1, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_PUSH_M, var_frame + 2, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg_reloc(
    yyscanner,
    OP_JUNDEF_P,
    compiler->loop[compiler->loop_depth].addr,
    NULL,
    NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_PUSH_M, var_frame + 0, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_PUSH_M, var_frame + 2, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg_reloc(
    yyscanner,
    OP_JL_P,
    compiler->loop[compiler->loop_depth].addr,
    NULL,
    NULL));

fail_if_error(yr_parser_emit(
    yyscanner, OP_POP, &pop_addr));

// Pop from the stack the fixup entry containing the jump's address
// that needs to be fixed.

fixup = compiler->fixup_stack_head;
compiler->fixup_stack_head = fixup->next;

// Fix the jump's target address.
*(void**)(fixup->address) = (void*)(pop_addr);

yr_free(fixup);

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_PUSH_M, var_frame + 0, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_PUSH_M, var_frame + 2, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_SWAPUNDEF, var_frame + 1, NULL, NULL));

fail_if_error(yr_parser_emit(
    yyscanner, OP_INT_GE, NULL));