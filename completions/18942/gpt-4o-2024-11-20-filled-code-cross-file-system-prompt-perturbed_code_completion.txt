{
    // Cleanup loop variables for the current loop depth
    for (int i = 0; i < compiler->loop[compiler->loop_depth].vars_count; i++)
    {
        yr_free(compiler->loop[compiler->loop_depth].vars[i].identifier);
        compiler->loop[compiler->loop_depth].vars[i].identifier = NULL;
    }

    // Reset loop depth to zero
    compiler->loop_depth = 0;

    // Initialize the frame for local variables in the current loop context
    int var_frame = _yr_compiler_get_var_frame(compiler);

    // Set up necessary variables for the loop
    fail_if_error(yr_parser_emit_with_arg(
        yyscanner, OP_CLEAR_M, var_frame + 0, NULL, NULL)); // Counter for matches

    fail_if_error(yr_parser_emit_with_arg(
        yyscanner, OP_CLEAR_M, var_frame + 1, NULL, NULL)); // Counter for iterations

    fail_if_error(yr_parser_emit_with_arg(
        yyscanner, OP_CLEAR_M, var_frame + 2, NULL, NULL)); // Quantifier

    // Ensure loop nesting limits are respected
    if (compiler->loop_depth == YR_MAX_LOOP_NESTING)
    {
        fail_if_error(ERROR_LOOP_NESTING_LIMIT_EXCEEDED);
    }
}