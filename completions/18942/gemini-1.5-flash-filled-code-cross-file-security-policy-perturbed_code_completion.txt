{
        int parseresult = ERROR_SUCCESS;
        int i;

        YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[compiler->loop_depth];

        // Clean up loop variables from inner loops.
        loop_vars_cleanup(compiler->loop_depth);

        // Reset loop depth to zero.
        compiler->loop_depth = 0;

        // Initialize the frame for local variables in the current loop context.
        // The frame is allocated at the beginning of the loop and contains
        // three internal variables (loop counter, iterations counter, and
        // end-of-list marker) followed by the loop variables.
        int var_frame = _yr_compiler_get_var_frame(compiler);

        for (i = 0; i < loop_ctx->vars_count; i++)
        {
          fail_if_error(yr_parser_emit_with_arg(
              yyscanner, OP_PUSH_M, var_frame + 3 + i, NULL, NULL));
        }

        // Set the loop depth to the current loop depth.
        compiler->loop_depth = min(compiler->loop_depth, YR_MAX_LOOP_NESTING);

        // Set the number of internal variables in the loop context.
        compiler->loop[compiler->loop_depth].vars_internal_count = 3;

        // Set the number of loop variables in the loop context.
        compiler->loop[compiler->loop_depth].vars_count = loop_ctx->vars_count;

        // Set the address of the loop start.
        compiler->loop[compiler->loop_depth].addr = compiler->code_arena->current_address;

        // Set the loop depth to the current loop depth.
        compiler->loop_depth = min(compiler->loop_depth, YR_MAX_LOOP_NESTING);

        // Set the number of internal variables in the loop context.
        compiler->loop[compiler->loop_depth].vars_internal_count = 3;

        // Set the number of loop variables in the loop context.
        compiler->loop[compiler->loop_depth].vars_count = loop_ctx->vars_count;

        // Set the address of the loop start.
        compiler->loop[compiler->loop_depth].addr = compiler->code_arena->current_address;

        fail_if_error(parseresult);
      }