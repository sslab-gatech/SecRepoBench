// Initialize variables for loop context
YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[compiler->loop_depth];
int var_frame = _yr_compiler_get_var_frame(compiler);

// Validate loop depth to prevent stack overflow
if (compiler->loop_depth >= YR_MAX_LOOP_NESTING)
{
  yr_compiler_set_error_extra_info(compiler, "exceeded maximum loop nesting level");
  return ERROR_LOOP_NESTING_LIMIT_EXCEEDED;
}

// Securely initialize loop variables
loop_ctx->vars_count = 0;
loop_ctx->vars_internal_count = 3;  // Three internal variables: index, count, and undefined

// Allocate memory for loop variables
loop_ctx->vars = (YR_LOOP_VARIABLE*) yr_malloc(YR_MAX_LOOP_VARS * sizeof(YR_LOOP_VARIABLE));
if (loop_ctx->vars == NULL)
{
  return ERROR_INSUFFICIENT_MEMORY;
}

// Initialize loop variables
for (int i = 0; i < YR_MAX_LOOP_VARS; i++)
{
  loop_ctx->vars[i].identifier = NULL;
  loop_ctx->vars[i].offset = 0;
}

// Set up the frame for local variables
int result = yr_parser_emit_with_arg(yyscanner, OP_INIT_LOOP, var_frame, NULL, NULL);
if (result != ERROR_SUCCESS)
{
  yr_free(loop_ctx->vars);
  return result;
}

compiler->loop_depth++;