YR_LOOP_CONTEXT* loop_ctx = &compiler->loop[compiler->loop_depth];

// Clean up any existing loop variables
loop_vars_cleanup(compiler->loop_depth);

// Initialize the frame for local variables in this loop context
int var_frame = _yr_compiler_get_var_frame(compiler);

// Set up internal loop variables
fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_CLEAR_M, var_frame + 1, NULL, NULL));

fail_if_error(yr_parser_emit_with_arg(
    yyscanner, OP_CLEAR_M, var_frame + 2, NULL, NULL));

// Initialize loop context
loop_ctx->vars_internal_count = 3;
loop_ctx->vars_count = 0;

// Check if we've exceeded the maximum loop nesting depth
if (compiler->loop_depth >= YR_MAX_LOOP_NESTING)
{
  yr_compiler_set_error_extra_info(
      compiler, "too many nested loops");
  return ERROR_LOOP_NESTING_LIMIT_EXCEEDED;
}

// Increment the loop depth
compiler->loop_depth++;