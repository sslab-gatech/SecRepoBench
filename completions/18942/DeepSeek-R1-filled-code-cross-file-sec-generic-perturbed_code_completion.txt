{
        // Clean up any existing loop variables and reset loop depth to handle error recovery
        while (compiler->loop_depth > 0)
        {
            YR_LOOP_CONTEXT* ctx = &compiler->loop[compiler->loop_depth - 1];
            for (int i = 0; i < ctx->vars_count; i++)
                yr_free(ctx->vars[i].identifier);
            ctx->vars_count = 0;
            ctx->vars_internal_count = 0;
            compiler->loop_depth--;
        }

        // Check loop nesting limit before initializing new context
        if (compiler->loop_depth >= YR_MAX_LOOP_NESTING)
        {
            yr_compiler_set_error_extra_info(compiler, "Maximum loop nesting depth exceeded");
            YYABORT;
        }

        // Initialize new loop context with safe defaults
        YR_LOOP_CONTEXT* new_ctx = &compiler->loop[compiler->loop_depth];
        new_ctx->vars_count = 0;
        new_ctx->vars_internal_count = 3;  // For iterator, counter, and limit
        new_ctx->addr = NULL;

        // Reset loop tracking variables
        compiler->loop_for_of_var_index = -1;
        int var_frame = _yr_compiler_get_var_frame(compiler);

        // Initialize memory slots for loop control variables
        fail_if_error(yr_parser_emit_with_arg(yyscanner, OP_CLEAR_M, var_frame, NULL, NULL));
        fail_if_error(yr_parser_emit_with_arg(yyscanner, OP_CLEAR_M, var_frame + 1, NULL, NULL));
        fail_if_error(yr_parser_emit_with_arg(yyscanner, OP_CLEAR_M, var_frame + 2, NULL, NULL));
    }