// Handle simplified triple letter checking
if (checkcompoundtriple && !checkedstriple && i > 1 && i < word.size() - 1) {
    if (word[i-1] == word[i] && (word[i-2] == word[i-1] || word[i] == word[i+1])) {
        checkedstriple = 1;
        striple = 1;
        i--;
    }
}

// Perform lookup for the current substring
rv = lookup(st.c_str() + i, st.size() - i);

// Iterate over homonyms
while (rv) {
    if ((!needaffix || !TESTAFF(rv->astr, needaffix, rv->alen)) &&
        (compoundflag && TESTAFF(rv->astr, compoundflag, rv->alen)) &&
        (!onlycpdrule || compound_words) &&
        ((!defcpdtable.empty() && defcpd_check(&compound_words, wnum + 1, rv, NULL, 1)) ||
         (scpd == 0 || checkcpdtable[scpd - 1].cond == FLAG_NULL ||
          TESTAFF(rv->astr, checkcpdtable[scpd - 1].cond, rv->alen)))) {
        break;
    }
    rv = rv->next_homonym;
}

// Check array bounds before accessing
if (i < word.size()) {
    st[i] = ch;
}