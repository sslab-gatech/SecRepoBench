plist_t parse_json_token(const char* js, jsmntok_info_t* ti, int* index) {
    switch (ti->tokens[*index].type) {
        case JSMN_PRIMITIVE:
            return parse_primitive(js, ti, index);
        case JSMN_STRING:
            return parse_string(js, ti, index);
        case JSMN_ARRAY:
            return parse_array(js, ti, index);
        case JSMN_OBJECT:
            return parse_object(js, ti, index);
        default:
            PLIST_JSON_ERR("%s: Invalid token type encountered\n", __func__);
            return NULL;
    }
}

plist_t plist_from_json(const char *jsonstr, uint32_t length, plist_t * plist) {
    // ... (previous code)

    int startindex = 0;
    plist_t root = parse_json_token(jsonstr, &ti, &startindex);

    if (!root) {
        PLIST_JSON_ERR("%s: Failed to parse JSON\n", __func__);
        return PLIST_ERR_PARSE;
    }

    *plist = root;
    return PLIST_ERR_SUCCESS;
}