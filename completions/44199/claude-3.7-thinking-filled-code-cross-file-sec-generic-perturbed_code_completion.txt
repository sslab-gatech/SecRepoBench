if (r <= 0) {
    PLIST_JSON_ERR("%s: No JSON tokens found\n", __func__);
    free(tokens);
    return PLIST_ERR_PARSE;
}

// Create a token info structure to pass to the parsing functions
typedef struct {
    jsmntok_t* tokens;
    int count;
} jsmntok_info_t;

jsmntok_info_t ti;
ti.tokens = tokens;
ti.count = r; // r contains the number of tokens found by jsmn_parse

// Ensure startindex is within bounds
if (startindex < 0 || startindex >= r) {
    PLIST_JSON_ERR("%s: Invalid start index\n", __func__);
    free(tokens);
    return PLIST_ERR_PARSE;
}

// Parse based on the type of the root token
plist_t result = NULL;
int index = startindex;

switch (tokens[index].type) {
    case JSMN_OBJECT:
        result = parse_object(jsonstr, &ti, &index);
        break;
    case JSMN_ARRAY:
        result = parse_array(jsonstr, &ti, &index);
        break;
    case JSMN_STRING:
        result = parse_string(jsonstr, &ti, &index);
        break;
    case JSMN_PRIMITIVE:
        result = parse_primitive(jsonstr, &ti, &index);
        break;
    default:
        PLIST_JSON_ERR("%s: Unknown token type\n", __func__);
        free(tokens);
        return PLIST_ERR_PARSE;
}

if (!result) {
    PLIST_JSON_ERR("%s: Failed to parse JSON\n", __func__);
    free(tokens);
    return PLIST_ERR_PARSE;
}

*plist = result;