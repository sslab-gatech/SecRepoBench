if (originalformat == 'g') {
  // For 'g' format with negative exponent, adjust precision to ensure proper significant digits
  int adjusted_prec = prec + e - 1;
  if (adjusted_prec + 1 > buf_remaining) {  // +1 for the decimal point
    adjusted_prec = buf_remaining - 1;
    if (adjusted_prec < 0) adjusted_prec = 0;
  }
  prec = adjusted_prec;
}