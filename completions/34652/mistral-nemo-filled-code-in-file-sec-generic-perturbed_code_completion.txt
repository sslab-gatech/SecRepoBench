if (fmt == 'g') {
  if (prec > (buf_remaining - e - 1)) {
    prec = buf_remaining - e - 1;
  }
  num_digits = prec;
} else {
  num_digits = prec + e + 1;
}