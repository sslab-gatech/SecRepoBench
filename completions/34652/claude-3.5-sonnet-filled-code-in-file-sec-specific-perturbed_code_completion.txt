if (originalformat == 'g') {
  int max_prec = buf_remaining - FLT_MIN_BUF_SIZE - 1;
  if (prec > max_prec) {
    prec = max_prec;
  }
  prec += e - 1;
  if (prec < 0) prec = 0;
}
if (prec > buf_remaining - 2) {
  prec = buf_remaining - 2;
}