if (fmt == 'g') {
    num_digits = prec;
    if (num_digits > (buf_remaining - FLT_MIN_BUF_SIZE)) {
      num_digits = buf_remaining - FLT_MIN_BUF_SIZE;
      if (e <= 4) {
        num_digits++;
      }
    }
  }