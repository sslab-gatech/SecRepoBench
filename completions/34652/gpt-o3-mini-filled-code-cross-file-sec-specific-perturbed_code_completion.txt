if (originalformat == 'g') {
  prec += (e > 1 ? e - 1 : 0);
  if (prec > buf_remaining - 1) {
    prec = buf_remaining - 1;
  }
}