if (fmt == 'g') {
  if (e <= 4) {
    num_digits = prec + 1;
  } else {
    num_digits = prec;
    if (num_digits || alt_form) {
      num_digits++;
    }
  }
} else {
  num_digits = prec + 1;
}