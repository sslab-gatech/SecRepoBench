if (fmt == 'f' && originalformat == 'g') {
  // For 'g' format converted to 'f', adjust precision to maintain significant digits
  prec += (e - 1);
}

// Check if we'll exceed the buffer
// We need space for: a potential decimal point, (e-1) zeros, prec digits, and a null terminator
int space_needed = 0;
if (prec > 0 || alt_form) space_needed += 1; // Decimal point
if (e > 0) space_needed += (e - 1); // Zeros
space_needed += prec; // Significant digits
space_needed += 1; // Null terminator

if (space_needed > buf_remaining) {
  // Reduce precision to fit
  prec -= (space_needed - buf_remaining);
  if (prec < 0) prec = 0;
}