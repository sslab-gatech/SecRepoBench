settings);
	} else {
		e = gf_webvtt_parser_parse(ctx->vttparser);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] WebVTT parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}
#endif

#ifndef GPAC_DISABLE_SWF_IMPORT
static GF_Err txtin_process_swf_svg(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->playstate==2)
		return GF_EOS;
	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e || !ctx->unframed) return e;
	}
	if (!ctx->swf_parse) return (ctx->playstate==2) ? GF_EOS : GF_NOT_SUPPORTED;

	if (ctx->seek_state==1) {
		ctx->seek_state = 2;
		gf_swf_restart(ctx->swf_parse);
	}

	if (ctx->unframed) {
		const GF_PropertyValue *p;
		const char *swf_pre=NULL, *swf_cueid=NULL, *swf_settings=NULL;
		p = gf_filter_pck_get_property_str(ipck, "swf_pre");
		if (p) swf_pre = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "swf_cueid");
		if (p) swf_cueid = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "swf_settings");
		if (p) swf_settings = p->value.string;

		e = gf_swf_parse_payload(ctx->swf_parse,
			gf_timestamp_rescale(ctx->start, ctx->timescale, 1000),
			gf_timestamp_rescale(ctx->end, ctx->timescale, 1000),
			swf_pre, swf_cueid, swf_settings);
	} else {
		e = gf_swf_parse(ctx->swf_parse);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] SWF parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}
#endif

static GF_Err txtin_process_text(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->playstate==2)
		return GF_EOS;
	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e || !ctx->unframed) return e;
	}

	if (ctx->seek_state==1) {
		ctx->seek_state = 2;
		gf_fseek(ctx->src, 0, SEEK_SET);
	}

	if (ctx->unframed) {
		const GF_PropertyValue *p;
		const char *text_pre=NULL, *text_cueid=NULL, *text_settings=NULL;
		p = gf_filter_pck_get_property_str(ipck, "text_pre");
		if (p) text_pre = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "text_cueid");
		if (p) text_cueid = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "text_settings");
		if (p) text_settings = p->value.string;

		e = gf_text_process(filter, ctx, ipck);
	} else {
		e = ctx->text_process(filter, ctx, ipck);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Text parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}

static GF_Err txtin_process_srt_probe(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	if (ctx->seek_state==1) {
		ctx->seek_state = 2;
		gf_fseek(ctx->src, 0, SEEK_SET);
	}

	e = ctx->text_process(filter, ctx, ipck);

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Text parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	if (ctx->seek_state==1) {
		ctx->seek_state = 2;
		gf_fseek(ctx->src, 0, SEEK_SET);
	}

	txtin_probe_duration(ctx);

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	txtin_probe_duration(ctx);

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only_no_flush(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	txtin_probe_duration(ctx);

	if (!ctx->unframed) {
		gf_filter_pid_set_info(ctx->opid, GF_PROP_PID_DOWN_BYTES, &PROP_LONGUINT( gf_ftell(ctx->src )) );
	}

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only_no_flush_no_empty(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	txtin_probe_duration(ctx);

	if (!ctx->unframed) {
		gf_filter_pid_set_info(ctx->opid, GF_PROP_PID_DOWN_BYTES, &PROP_LONGUINT( gf_ftell(ctx->src )) );
	}

	ctx->no_empty = GF_TRUE;

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only_no_flush_no_empty_no_flush(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	txtin_probe_duration(ctx);

	if (!ctx->unframed) {
		gf_filter_pid_set_info(ctx->opid, GF_PROP_PID_DOWN_BYTES, &PROP_LONGUINT( gf_ftell(ctx->src )) );
	}

	ctx->no_empty = GF_TRUE;
	ctx->noflush = GF_TRUE;

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only_no_flush_no_empty_no_flush_no_block(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	txtin_probe_duration(ctx);

	if (!ctx->unframed) {
		gf_filter_pid_set_info(ctx->opid, GF_PROP_PID_DOWN_BYTES, &PROP_LONGUINT( gf_ftell(ctx->src )) );
	}

	ctx->no_empty = GF_TRUE;
	ctx->noflush = GF_TRUE;

	if (!ctx->unframed) {
		if (gf_filter_pid_would_block(ctx->opid))
			return GF_OK;
	}

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only_no_flush_no_empty_no_flush_no_block_no_block(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e || !ctx->unframed) return e;
	}

	txtin_probe_duration(ctx);

	if (!ctx->unframed) {
		gf_filter_pid_set_info(ctx->opid, GF_PROP_PID_DOWN_BYTES, &PROP_LONGUINT( gf_ftell(ctx->src )) );
	}

	ctx->no_empty = GF_TRUE;
	ctx->noflush = GF_TRUE;

	if (!ctx->unframed) {
		if (gf_filter_pid_would_block(ctx->opid))
			return GF_OK;
	}

	if (gf_filter_pid_would_block(ctx->opid))
		return GF_OK;

	return GF_OK;
}

static GF_Err txtin_process_srt_probe_duration_only_no_flush_no_empty_no_flush_no_block_no_block_no_block(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e ||