->vttparser);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] WebVTT parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}
#endif

#ifndef GPAC_DISABLE_SWF_IMPORT
static GF_Err txtin_process_swf_svg(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->playstate==2)
		return GF_EOS;
	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e || !ctx->unframed) return e;
	}
	if (!ctx->opid) return GF_NOT_SUPPORTED;

	if (ctx->seek_state==1) {
		ctx->seek_state = 2;
		gf_fseek(ctx->src, 0, SEEK_SET);
	}

	if (ctx->unframed) {
		const char *swf_pre=NULL, *swf_cueid=NULL, *swf_settings=NULL;
		const GF_PropertyValue *p;
		p = gf_filter_pck_get_property_str(ipck, "swf_pre");
		if (p) swf_pre = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "swf_cueid");
		if (p) swf_cueid = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "swf_settings");
		if (p) swf_settings = p->value.string;

		e = gf_swf_parse_payload(ctx->swf_parse,
			gf_timestamp_rescale(ctx->start, ctx->timescale, 1000),
			gf_timestamp_rescale(ctx->end, ctx->timescale, 1000),
			swf_pre, swf_cueid, swf_settings);
	} else {
		e = gf_swf_parse(ctx->swf_parse);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] SWF parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}
#endif

static GF_Err txtin_process_text(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->playstate==2)
		return GF_EOS;
	if (!ctx->is_setup) {
		ctx->is_setup = GF_TRUE;
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e || !ctx->unframed) return e;
	}
	if (!ctx->opid) return GF_NOT_SUPPORTED;

	if (ctx->seek_state==1) {
		ctx->seek_state = 2;
		gf_fseek(ctx->src, 0, SEEK_SET);
	}

	if (ctx->unframed) {
		const char *text_pre=NULL, *text_cueid=NULL, *text_settings=NULL;
		const GF_PropertyValue *p;
		p = gf_filter_pck_get_property_str(ipck, "text_pre");
		if (p) text_pre = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "text_cueid");
		if (p) text_cueid = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "text_settings");
		if (p) text_settings = p->value.string;

		e = gf_text_process_payload(ctx->text_process, ctx,
			gf_timestamp_rescale(ctx->start, ctx->timescale, 1000),
			gf_timestamp_rescale(ctx->end, ctx->timescale, 1000),
			text_pre, text_cueid, text_settings);
	} else {
		e = ctx->text_process(filter, ctx, ipck);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Text parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}

static GF_Err txtin_process_srt_or_webvtt(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	if (ctx->fmt == GF_TXTIN_MODE_SRT)
		return txtin_process_srt(filter, ctx, ipck);
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT)
		return txtin_process_webvtt(filter, ctx, ipck);
#endif
#ifndef GPAC_DISABLE_SWF_IMPORT
	else if (ctx->fmt == GF_TXTIN_MODE_SWF_SVG)
		return txtin_process_swf_svg(filter, ctx, ipck);
#endif
	else if (ctx->fmt == GF_TXTIN_MODE_TEXT)
		return txtin_process_text(filter, ctx, ipck);
	else
		return GF_NOT_SUPPORTED;
}

static GF_Err txtin_process(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_loaded) {
		ctx->is_loaded = GF_TRUE;
		e = gf_text_guess_format(ctx, ctx->file_name, &ctx->fmt);
		if (e) return e;
	}

	e = txtin_process_srt_or_webvtt(filter, ctx, ipck);
	if (e) return e;

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}

static GF_Err txtin_setup(GF_Filter *filter, GF_TXTIn *ctx)
{
	GF_Err e;

	if (!ctx->file_name) return GF_BAD_PARAM;

	ctx->is_loaded = GF_FALSE;
	ctx->is_setup = GF_FALSE;
	ctx->src = NULL;
	ctx->fio = NULL;
	ctx->bs_w = NULL;
	ctx->first_samp = GF_TRUE;
	ctx->hdr_parsed = GF_FALSE;
	ctx->unframed = GF_FALSE;
	ctx->simple_text = GF_FALSE;
	ctx->forced_sub = GF_FALSE;
	ctx->has_forced = 0;
	ctx->intervals = NULL;
	ctx->cts_first_interval = 0;

	e = gf_text_guess_format(ctx, ctx->file_name, &ctx->fmt);
	if (e) return e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT || ctx->fmt == GF_TXTIN_MODE_WEBVTT || ctx->fmt == GF_TXTIN_MODE_SWF_SVG || ctx->fmt == GF_TXTIN_MODE_TEXT) {
		ctx->ipid = gf_filter_pid_new(filter);
		gf_filter_pid_set_property(ctx->ipid, GF_PROP_PID_STREAM_TYPE, &PROP_UINT(GF_STREAM_TEXT) );
		gf_filter_pid_set_property(ctx->ipid, GF_PROP_PID_CODECID, &PROP_UINT(GF_CODECID_TX3G) );
		gf_filter_pid_set_property(ctx->ipid, GF_PROP_PID_TIMESCALE, &PROP_UINT(ctx->timescale) );
		ctx->opid = gf_filter_pid_new(filter);
		gf_filter_pid_set_property(ctx->opid, GF_PROP_PID_STREAM_TYPE, &PROP_UINT(GF_STREAM_TEXT) );
		gf_filter_pid_set_property(ctx->opid, GF_PROP_PID_CODECID, &PROP_UINT(GF_CODECID_TX3G) );
		gf_filter_pid_set_property(ctx->opid, GF_PROP_PID_TIMESCALE, &PROP_UINT(ctx->timescale) );
		ctx->text_descs = gf_list_new();
		ctx->parser = gf_dom_parser_new();
		ctx->parser_working_copy = gf_dom_parser_new();
		ctx->ttml_resources = gf_list_new();
		ctx->div_nodes_list = gf_list_new();
		ctx->vttparser = NULL;
		ctx->bs_w = gf_bs_new();
		ctx->samp = gf_isom_new_text_sample();
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;
		ctx->last_desc_idx = 0;
		ctx->last_sample_empty = GF_FALSE;
		ctx->last_sample_duration = 0;
		ctx->cur_child_idx = 0;
		ctx->nb_children = 0;