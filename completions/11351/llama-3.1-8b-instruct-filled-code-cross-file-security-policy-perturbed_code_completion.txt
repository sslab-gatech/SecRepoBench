hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyphs;
hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
_create_old_gid_to_new_gid_map (*glyphs, old_gid_to_new_gid_map);

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (initial_gids_to_retain->next (&gid))
{
  hb_codepoint_t new_gid = gid;
  if (old_gid_to_new_gid_map->get (gid, &new_gid))
  {
    full_glyphs_to_retain->add (new_gid);
  }
  else
  {
    hb_codepoint_t cp = HB_SET_VALUE_INVALID;
    if (codepoint_to_glyph->get (gid, &cp))
    {
      hb_codepoint_t new_gid = HB_SET_VALUE_INVALID;
      if (cmap.get_nominal_glyph (cp, &new_gid))
      {
        full_glyphs_to_retain->add (new_gid);
      }
    }
  }
}

hb_set_t *final_gids_to_retain = hb_set_create ();
hb_set_t *valid_gids = hb_set_create ();
hb_set_t *invalid_gids = hb_set_create ();
hb_set_t *glyphs_to_retain = hb_set_create ();
hb_set_t *glyphs_to_drop = hb_set_create ();

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (full_glyphs_to_retain->next (&gid))
{
  if (gid < 0 || gid >= face->max_glyph_id)
  {
    invalid_gids->add (gid);
  }
  else
  {
    valid_gids->add (gid);
  }
}

hb_set_t *valid_gids_copy = hb_set_create ();
hb_set_t *invalid_gids_copy = hb_set_create ();
hb_set_t *glyphs_to_retain_copy = hb_set_create ();
hb_set_t *glyphs_to_drop_copy = hb_set_create ();

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (valid_gids->next (&gid))
{
  valid_gids_copy->add (gid);
}

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (invalid_gids->next (&gid))
{
  invalid_gids_copy->add (gid);
}

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (glyphs_to_retain->next (&gid))
{
  glyphs_to_retain_copy->add (gid);
}

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (glyphs_to_drop->next (&gid))
{
  glyphs_to_drop_copy->add (gid);
}

hb_set_destroy (valid_gids);
hb_set_destroy (invalid_gids);
hb_set_destroy (glyphs_to_retain);
hb_set_destroy (glyphs_to_drop);

hb_set_t *final_gids_to_retain = hb_set_create ();
hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (valid_gids_copy->next (&gid))
{
  final_gids_to_retain->add (gid);
}

hb_set_t *glyphs_to_retain = hb_set_create ();
hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (glyphs_to_retain_copy->next (&gid))
{
  glyphs_to_retain->add (gid);
}

hb_set_t *glyphs_to_drop = hb_set_create ();
hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (glyphs_to_drop_copy->next (&gid))
{
  glyphs_to_drop->add (gid);
}

hb_set_destroy (valid_gids_copy);
hb_set_destroy (invalid_gids_copy);
hb_set_destroy (glyphs_to_retain_copy);
hb_set_destroy (glyphs_to_drop_copy);

hb_set_destroy (full_glyphs_to_retain);
hb_map_destroy (old_gid_to_new_gid_map);
hb_vector_destroy (&glyphs);