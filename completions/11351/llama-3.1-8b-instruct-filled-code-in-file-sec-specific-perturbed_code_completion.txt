hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyphs_to_retain;
hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (hb_set_next (initial_gids_to_retain, &gid)) {
  glyphs_to_retain.push_back (gid);
  OT::glyf::accelerator_t glyf;
  glyf.init (face);
  OT::glyf::CompositeGlyphHeader::Iterator composite;
  if (glyf.get_composite (gid, &composite)) {
    do {
      glyphs_to_retain.push_back ((hb_codepoint_t) composite.current->glyphIndex);
    } while (composite.move_to_next());
  }
}
hb_set_destroy (initial_gids_to_retain);
hb_set_t *glyphs_to_retain_set = hb_set_create ();
for (unsigned int i = 0; i < glyphs_to_retain.len; i++) {
  hb_set_add (glyphs_to_retain_set, glyphs_to_retain[i]);
}
hb_set_destroy (glyphs_to_retain_set);
hb_set_destroy (full_glyphs_to_retain);
return glyphs_to_retain_set;