while (initial_gids_to_retain->next (&gid))
  {
    full_glyphs_to_retain->add (gid);
    glyphs->push (gid);
    for (unsigned int i = 0; i < glyf.get_n_contours (gid); i++)
    {
      hb_codepoint_t comp_gid;
      if (glyf.get_component_glyph (gid, i, &comp_gid))
	full_glyphs_to_retain->add (comp_gid);
    }
  }

  hb_set_destroy (initial_gids_to_retain);
  _create_old_gid_to_new_gid_map (*glyphs, codepoint_to_glyph);
  cmap.fini ();
  glyf.fini ();
  return full_glyphs_to_retain;