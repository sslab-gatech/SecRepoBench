hb_codepoint_t gid;
  hb_set_t *glyphs_to_retain = hb_set_create ();
  hb_set_t *composite_glyphs = hb_set_create ();
  hb_set_t *glyphs_to_retain_tmp = hb_set_create ();

  hb_codepoint_t cp = HB_SET_VALUE_INVALID;
  while (initial_gids_to_retain->next (&gid)) {
    glyphs_to_retain->add (gid);
    if (glyf.get_glyph_info (gid).is_simple ()) {
      glyphs_to_retain_tmp->add (gid);
    } else {
      composite_glyphs->add (gid);
    }
  }

  hb_set_t *composite_components;
  while (composite_glyphs->next (&gid)) {
    if (glyf.get_glyph_info (gid).is_composite ()) {
      hb_set_t *components = glyf.get_glyph_components (gid);
      hb_codepoint_t comp_gid = HB_SET_VALUE_INVALID;
      while (components->next (&comp_gid)) {
        glyphs_to_retain->add (comp_gid);
        glyphs_to_retain_tmp->add (comp_gid);
      }
    }
  }

  glyphs->resize (glyphs_to_retain_tmp->size ());
  unsigned int index = 0;
  hb_codepoint_t gid_tmp = HB_SET_VALUE_INVALID;
  while (glyphs_to_retain_tmp->next (&gid_tmp)) {
    glyphs->push (gid_tmp);
    index++;
  }

  hb_set_destroy (composite_glyphs);
  hb_set_destroy (glyphs_to_retain_tmp);
  hb_set_destroy (initial_gids_to_retain);

  return glyphs_to_retain;
}