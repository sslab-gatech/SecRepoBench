hb_codepoint_t gid = HB_SET_VALUE_INVALID;
hb_queue_t<hb_codepoint_t> queue;

initial_gids_to_retain->foreach ([&queue] (hb_codepoint_t gid) {
  queue.push (gid);
});

while (queue.pop (gid))
{
  if (full_glyphs_to_retain->has (gid))
    continue;

  full_glyphs_to_retain->add (gid);

  hb_vector_t<hb_codepoint_t> components;
  if (glyf.get_components (gid, &components))
  {
    for (hb_codepoint_t component : components)
    {
      if (!full_glyphs_to_retain->has (component))
	queue.push (component);
    }
  }
}

hb_set_destroy (initial_gids_to_retain);

glyphs->init ();
full_glyphs_to_retain->foreach ([glyphs] (hb_codepoint_t gid) {
  glyphs->push (gid);
});

cmap.fini ();
glyf.fini ();

return full_glyphs_to_retain;