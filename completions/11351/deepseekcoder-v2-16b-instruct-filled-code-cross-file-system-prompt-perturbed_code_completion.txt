hb_codepoint_t gid;
  hb_set_t *composite_glyphs = hb_set_create ();
  hb_set_t *glyph_ids = hb_set_create ();
  hb_set_union (glyph_ids, initial_gids_to_retain);

  for (hb_codepoint_t gid : glyph_ids) {
    if (glyf.get_glyph_info (gid).is_simple ()) {
      full_glyphs_to_retain->add (gid);
    } else {
      glyf.get_composite_glyphs (gid, composite_glyphs);
      hb_codepoint_t cgid = HB_SET_VALUE_INVALID;
      while (composite_glyphs->next (&cgid)) {
        full_glyphs_to_retain->add (cgid);
      }
    }
  }

  glyphs->resize (full_glyphs_to_retain->size);
  unsigned int index = 0;
  hb_codepoint_t gid = HB_SET_VALUE_INVALID;
  while (full_glyphs_to_retain->next (&gid)) {
    glyphs->push (gid);
  }

  hb_set_destroy (composite_glyphs);
  hb_set_destroy (glyph_ids);
  hb_set_destroy (initial_gids_to_retain);
  hb_set_destroy (full_glyphs_to_retain);

  cmap.fini ();
  glyf.fini ();

  return glyphs;
}