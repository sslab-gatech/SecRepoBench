hb_codepoint_t gid;
  hb_set_t *glyphs_to_retain = hb_set_create ();
  hb_set_union (glyphs_to_retain, initial_gids_to_retain);

  hb_set_t glyphs_to_retain_tmp = *glyphs_to_retain;
  while (hb_set_next (&glyphs_to_retain_tmp, &gid)) {
    if (glyf.get_glyph (gid)) {
      hb_set_t components;
      glyf.get_glyph_components (gid, &components);
      hb_set_union (glyphs_to_retain, &components);
    }
  }

  hb_set_destroy (initial_gids_to_retain);

  glyphs->resize (0);
  for (hb_codepoint_t cp = 0; cp < glyf.get_num_glyphs (); cp++) {
    if (hb_set_has (glyphs_to_retain, cp)) {
      glyphs->push (cp);
    }
  }

  hb_set_destroy (glyphs_to_retain);

  glyf.fini ();
  cmap.fini ();

  return glyphs_to_retain;
}