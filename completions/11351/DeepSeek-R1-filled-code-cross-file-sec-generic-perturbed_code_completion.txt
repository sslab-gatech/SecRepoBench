hb_set_t *current_gids = hb_set_create();
  hb_set_copy(current_gids, initial_gids_to_retain);

  while (!hb_set_is_empty(current_gids))
  {
    hb_codepoint_t gid;
    if (!hb_set_next(current_gids, &gid))
      break;

    if (full_glyphs_to_retain->has(gid))
      continue;

    full_glyphs_to_retain->add(gid);

    hb_set_t components;
    hb_set_init(&components);
    glyf.get_component_gids(gid, &components);
    hb_set_union(current_gids, &components);
    hb_set_destroy(&components);
  }

  hb_set_destroy(current_gids);
  hb_set_destroy(initial_gids_to_retain);

  hb_vector_t<hb_codepoint_t> all_gids;
  hb_codepoint_t gid = HB_SET_VALUE_INVALID;
  while (full_glyphs_to_retain->next(&gid))
    all_gids.push(gid);
  all_gids.qsort();

  for (unsigned int i = 0; i < all_gids.len; i++)
    glyphs->push(all_gids[i]);

  glyf.fini();
  cmap.fini();

  return full_glyphs_to_retain;