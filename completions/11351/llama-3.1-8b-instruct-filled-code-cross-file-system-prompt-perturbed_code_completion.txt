hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyphs_to_retain;
hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
_create_old_gid_to_new_gid_map (*glyphs, old_gid_to_new_gid_map);

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
hb_set_t::iterator it = initial_gids_to_retain->begin ();
while (it!= initial_gids_to_retain->end ())
{
  gid = *it;
  it++;
  if (gid!= 0) // Not-def
  {
    hb_set_t *component_gids = hb_set_create ();
    hb_ot_cmap_get_component_gids (face, gid, component_gids);
    hb_set_t::iterator it2 = component_gids->begin ();
    while (it2!= component_gids->end ())
    {
      hb_codepoint_t component_gid = *it2;
      it2++;
      if (hb_set_contains (full_glyphs_to_retain, component_gid))
      {
        continue;
      }
      if (_is_gid_consecutive (face->cmap->long_group, gid, component_gid))
      {
        continue;
      }
      if (hb_set_contains (initial_gids_to_retain, component_gid))
      {
        continue;
      }
      if (hb_set_contains (unicodes_to_retain, component_gid))
      {
        continue;
      }
      if (hb_set_contains (glyphs, component_gid))
      {
        continue;
      }
      if (hb_set_contains (old_gid_to_new_gid_map, component_gid))
      {
        continue;
      }
      glyphs_to_retain.push_back (component_gid);
      full_glyphs_to_retain->add (component_gid);
    }
    hb_set_destroy (component_gids);
  }
}
hb_set_destroy (initial_gids_to_retain);
hb_map_destroy (old_gid_to_new_gid_map);
hb_vector_destroy (glyphs_to_retain);
hb_set_destroy (full_glyphs_to_retain);
hb_ot_cmap_accelerator_t::finalize (face->cmap);
hb_ot_glyf_accelerator_t::finalize (face->glyf);
return full_glyphs_to_retain;