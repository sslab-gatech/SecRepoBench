hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyphs;
hb_set_t *glyphs_to_retain = hb_set_create ();
hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
hb_set_t *glyphs_to_add = hb_set_create ();

hb_set_t *iter = hb_set_create ();
hb_set_copy (iter, gids_to_retain);
while (hb_set_next (iter, &gid))
{
  hb_set_t *component_gids = hb_set_create ();
  hb_ot_layout_collect_components (face, gid, component_gids);
  hb_set_t *component_gids_to_add = hb_set_create ();
  hb_set_copy (component_gids_to_add, component_gids);
  hb_set_difference (component_gids_to_add, glyphs_to_retain);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, initial_gids_to_retain);
  hb_set_difference (component_gids_to_add, full_glyphs_to_retain);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);
  hb_set_difference (component_gids_to_add, glyphs_to_add);
  hb_set_difference (component_gids_to_add, glyphs);