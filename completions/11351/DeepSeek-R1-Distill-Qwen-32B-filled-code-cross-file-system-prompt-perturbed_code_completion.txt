while (initial_gids_to_retain->next (&gid))
  {
    full_glyphs_to_retain->add (gid);
    if (glyf.is_composite (gid))
    {
      hb_vector_t<hb_codepoint_t> components;
      glyf.get_components (gid, &components);
      for (hb_codepoint_t component : components)
        full_glyphs_to_retain->add (component);
    }
  }
  
  hb_set_destroy (initial_gids_to_retain);
  
  while (full_glyphs_to_retain->next (&gid))
    glyphs.push (gid);
  
  hb_set_destroy (full_glyphs_to_retain);
  
  glyf.fini ();
  cmap.fini ();
  
  return glyphs_to_retain;