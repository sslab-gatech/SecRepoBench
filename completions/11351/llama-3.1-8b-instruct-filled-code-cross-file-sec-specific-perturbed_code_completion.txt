hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyphs_to_retain;
hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
_create_old_gid_to_new_gid_map (*glyphs, old_gid_to_new_gid_map);

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
hb_set_t::iterator it = initial_gids_to_retain->begin ();
while (it!= initial_gids_to_retain->end ())
{
  gid = *it;
  it++;
  if (gid!= HB_SET_VALUE_INVALID)
  {
    hb_set_t *component_gids = hb_set_create ();
    hb_codepoint_t component_gid = HB_SET_VALUE_INVALID;
    hb_set_t::iterator it2 = initial_gids_to_retain->begin ();
    while (it2!= initial_gids_to_retain->end ())
    {
      component_gid = *it2;
      it2++;
      if (component_gid!= HB_SET_VALUE_INVALID)
      {
        if (_is_gid_consecutive (&face->cmap->subtable_long_group, gid, component_gid))
        {
          component_gids->add (component_gid);
        }
      }
    }
    if (component_gids->len > 0)
    {
      hb_set_t *new_component_gids = hb_set_create ();
      hb_codepoint_t new_gid = HB_SET_VALUE_INVALID;
      hb_set_t::iterator it3 = component_gids->begin ();
      while (it3!= component_gids->end ())
      {
        new_gid = old_gid_to_new_gid_map->get (*it3);
        it3++;
        if (new_gid!= HB_SET_VALUE_INVALID)
        {
          new_component_gids->add (new_gid);
        }
      }
      full_glyphs_to_retain->add (gid);
      full_glyphs_to_retain->add (new_component_gids);
      hb_set_destroy (new_component_gids);
    }
    hb_set_destroy (component_gids);
  }
}
hb_set_destroy (initial_gids_to_retain);
hb_map_destroy (old_gid_to_new_gid_map);
hb_set_destroy (full_glyphs_to_retain);
return full_glyphs_to_retain;