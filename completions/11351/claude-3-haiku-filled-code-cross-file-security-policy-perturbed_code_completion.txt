hb_codepoint_t gid;
while (initial_gids_to_retain->next (&gid))
{
  if (glyf.get_glyph_data (gid, nullptr, nullptr))
  {
    full_glyphs_to_retain->add (gid);
    if (glyf.get_composite_glyph_components (gid, glyphs))
    {
      for (unsigned int i = 0; i < glyphs->len; i++)
        full_glyphs_to_retain->add ((*glyphs)[i]);
    }
  }
}

hb_set_destroy (initial_gids_to_retain);
glyphs->clear ();
for (hb_codepoint_t gid : *full_glyphs_to_retain)
  glyphs->push (gid);

cmap.fini ();
glyf.fini ();

return full_glyphs_to_retain;