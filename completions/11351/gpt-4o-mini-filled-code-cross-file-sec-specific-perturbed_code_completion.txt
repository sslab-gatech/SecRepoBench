hb_codepoint_t gid = HB_SET_VALUE_INVALID;
  while (initial_gids_to_retain->next(&gid))
  {
    full_glyphs_to_retain->add(gid);
    // Assuming we have a function to get the component glyphs for a composite glyph
    hb_set_t *component_gids = hb_set_create();
    if (glyf.get_component_glyphs(gid, component_gids))
    {
      hb_codepoint_t component_gid = HB_SET_VALUE_INVALID;
      while (component_gids->next(&component_gid))
      {
        full_glyphs_to_retain->add(component_gid);
      }
    }
    hb_set_destroy(component_gids);
  }

  hb_vector_t<hb_codepoint_t> glyph_vector;
  full_glyphs_to_retain->next(&gid);
  while (gid != HB_SET_VALUE_INVALID)
  {
    glyph_vector.push_back(gid);
    full_glyphs_to_retain->next(&gid);
  }

  _create_old_gid_to_new_gid_map(glyph_vector, codepoint_to_glyph);
  
  hb_set_destroy(initial_gids_to_retain);
  hb_set_destroy(full_glyphs_to_retain);
  cmap.finish();
  glyf.finish();

  return full_glyphs_to_retain;