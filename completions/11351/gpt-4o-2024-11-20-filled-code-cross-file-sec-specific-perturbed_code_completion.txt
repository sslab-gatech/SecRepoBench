while (initial_gids_to_retain->next(&gid)) {
    full_glyphs_to_retain->add(gid);

    // Add composite glyphs referenced by this glyph.
    unsigned int num_components = glyf.get_num_components(gid);
    for (unsigned int i = 0; i < num_components; i++) {
      hb_codepoint_t component_gid = glyf.get_component_gid(gid, i);
      if (component_gid != HB_SET_VALUE_INVALID) {
        full_glyphs_to_retain->add(component_gid);
      }
    }
  }

  hb_set_destroy(initial_gids_to_retain);

  glyphs->clear();
  gid = HB_SET_VALUE_INVALID;
  while (full_glyphs_to_retain->next(&gid)) {
    glyphs->push(gid);
  }

  cmap.fini();
  glyf.fini();

  return full_glyphs_to_retain;