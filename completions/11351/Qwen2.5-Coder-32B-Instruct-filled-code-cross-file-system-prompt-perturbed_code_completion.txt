while (initial_gids_to_retain->next (&gid))
  {
    full_glyphs_to_retain->add (gid);
    if (glyf.get_extents (gid))
    {
      unsigned int num_components;
      glyf.get_num_components (gid, &num_components);
      for (unsigned int i = 0; i < num_components; i++)
      {
	hb_codepoint_t component_gid;
	glyf.get_component (gid, i, &component_gid, nullptr, nullptr);
	full_glyphs_to_retain->add (component_gid);
      }
    }
  }

  hb_set_destroy (initial_gids_to_retain);

  glyphs->alloc (full_glyphs_to_retain->get_population ());
  unsigned int j = 0;
  full_glyphs_to_retain->next (&gid);
  do
  {
    (*glyphs)[j++] = gid;
  } while (full_glyphs_to_retain->next (&gid));

  hb_set_destroy (full_glyphs_to_retain);
  cmap.fini ();
  glyf.fini ();

  return full_glyphs_to_retain;