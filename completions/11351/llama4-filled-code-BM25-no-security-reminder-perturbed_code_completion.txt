while (initial_gids_to_retain->next (&gid))
  {
    hb_codepoint_t *components = nullptr;
    unsigned int num_components = glyf.get_components (gid, &components);
    for (unsigned int i = 0; i < num_components; i++)
      full_glyphs_to_retain->add (components[i]);
    if (components)
      free (components);
    full_glyphs_to_retain->add (gid);
  }
  hb_set_destroy (initial_gids_to_retain);

  glyphs->alloc (full_glyphs_to_retain->get_population ());
  hb_codepoint_t *glyph_array = glyphs->begin ();
  hb_map_t glyph_map;
  _create_old_gid_to_new_gid_map (*glyphs, &glyph_map);
  hb_codepoint_t new_gid = 0;
  while (full_glyphs_to_retain->next (&gid))
  {
    glyph_array[new_gid] = gid;
    glyph_map.set (gid, new_gid++);
  }

  cmap.fini ();
  glyf.fini ();

  return full_glyphs_to_retain;