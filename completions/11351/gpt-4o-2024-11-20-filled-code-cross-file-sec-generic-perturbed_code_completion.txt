while (initial_gids_to_retain->next(&gid)) {
    full_glyphs_to_retain->add(gid);

    // If the glyph is a composite glyph, add its components to the set.
    hb_set_t component_glyphs;
    if (glyf.get_contour_point_count(gid) == 0 && glyf.get_components(gid, &component_glyphs)) {
      hb_codepoint_t component_gid = HB_SET_VALUE_INVALID;
      while (component_glyphs.next(&component_gid)) {
        full_glyphs_to_retain->add(component_gid);
      }
    }
  }

  // Clean up the initial set of glyph IDs to retain.
  hb_set_destroy(initial_gids_to_retain);

  // Populate the vector with all glyph IDs to retain.
  gid = HB_SET_VALUE_INVALID;
  while (full_glyphs_to_retain->next(&gid)) {
    glyphs->push(gid);
  }

  // Finalize and clean up resources.
  cmap.fini();
  glyf.fini();

  return full_glyphs_to_retain;