while (initial_gids_to_retain->next (&gid))
  {
    full_glyphs_to_retain->add (gid);
    hb_set_t *component_gids = hb_set_create ();
    glyf.get_component_glyphs (gid, component_gids);
    full_glyphs_to_retain->union_with (component_gids);
    hb_set_destroy (component_gids);
  }

  hb_vector_t<hb_codepoint_t> glyph_vector;
  glyph_vector.resize (full_glyphs_to_retain->size ());
  unsigned int index = 0;
  while (full_glyphs_to_retain->next (&gid))
  {
    glyph_vector[index++] = gid;
  }

  _create_old_gid_to_new_gid_map (glyph_vector, codepoint_to_glyph);
  
  cmap.fini ();
  glyf.fini ();
  hb_set_destroy (initial_gids_to_retain);
  
  return full_glyphs_to_retain;