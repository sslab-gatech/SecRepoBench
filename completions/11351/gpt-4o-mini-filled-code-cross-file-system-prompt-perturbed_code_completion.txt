while (initial_gids_to_retain->next (&gid))
  {
    full_glyphs_to_retain->add (gid);
    hb_set_t *composite_gids = hb_set_create ();
    hb_ot_layout_collect_composite_glyphs (face, gid, composite_gids);
    full_glyphs_to_retain->union_with (composite_gids);
    hb_set_destroy (composite_gids);
  }

  hb_vector_t<hb_codepoint_t> glyph_vector;
  full_glyphs_to_retain->next (&gid);
  while (gid != HB_SET_VALUE_INVALID)
  {
    glyph_vector.push (gid);
    full_glyphs_to_retain->next (&gid);
  }

  hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
  _create_old_gid_to_new_gid_map (glyph_vector, old_gid_to_new_gid_map);

  cmap.fini ();
  glyf.fini ();
  hb_set_destroy (initial_gids_to_retain);
  hb_set_destroy (full_glyphs_to_retain);

  return full_glyphs_to_retain;