// Populate a full set of glyphs to retain by adding all referenced
// composite glyphs.
hb_codepoint_t gid = HB_SET_VALUE_INVALID;
hb_set_t *full_glyphs_to_retain = hb_set_create ();
while (initial_gids_to_retain->next (&gid))
{
    full_glyphs_to_retain->add (gid);
    if (glyf.get_glyph_profile (gid))
    {
        hb_codepoint_t component_gid;
        unsigned int num_components = glyf.get_num_components (gid);
        for (unsigned int i = 0; i < num_components; i++)
        {
            if (glyf.get_component_glyph (gid, i, &component_gid))
            {
                full_glyphs_to_retain->add (component_gid);
            }
        }
    }
}
hb_set_destroy (initial_gids_to_retain);

hb_vector_t<hb_codepoint_t> *glyphs = new hb_vector_t<hb_codepoint_t>;
hb_set_t *glyph_set = hb_set_create ();
hb_set_union (glyph_set, full_glyphs_to_retain);
hb_set_next (glyph_set, &gid);
do
{
    glyphs->push (gid);
} while (hb_set_next (glyph_set, &gid));
hb_set_destroy (full_glyphs_to_retain);
hb_set_destroy (glyph_set);

cmap.fini ();
glyf.fini ();

return full_glyphs_to_retain;