hb_codepoint_t gid;
while (initial_gids_to_retain->next (&gid))
{
  if (glyf.get_glyph_data (gid, nullptr, nullptr))
  {
    full_glyphs_to_retain->add (gid);
    if (glyf.get_composite_glyph (gid))
    {
      hb_codepoint_t component;
      unsigned int num_components = glyf.get_component_glyphs (gid, nullptr, 0);
      hb_codepoint_t *components = (hb_codepoint_t *) calloc (num_components, sizeof (hb_codepoint_t));
      glyf.get_component_glyphs (gid, components, num_components);
      for (unsigned int i = 0; i < num_components; i++)
      {
        component = components[i];
        full_glyphs_to_retain->add (component);
      }
      free (components);
    }
  }
}

cmap.fini ();
glyf.fini ();

*glyphs = hb_vector_t<hb_codepoint_t> (full_glyphs_to_retain->get_population ());
full_glyphs_to_retain->serialize (*glyphs);
hb_set_destroy (full_glyphs_to_retain);
hb_set_destroy (initial_gids_to_retain);

return full_glyphs_to_retain;