hb_set_t *current_gids = hb_set_create();
  current_gids->copy(initial_gids_to_retain);

  while (!hb_set_is_empty(current_gids))
  {
    hb_codepoint_t gid = HB_SET_VALUE_INVALID;
    if (!current_gids->next(&gid)) break;

    current_gids->del(gid);
    if (full_glyphs_to_retain->has(gid)) continue;

    full_glyphs_to_retain->add(gid);

    hb_set_t components;
    hb_set_init(&components);
    glyf.get_composite_glyphs(gid, &components);
    current_gids->add(&components);
    hb_set_fini(&components);
  }

  hb_set_destroy(current_gids);
  hb_set_destroy(initial_gids_to_retain);

  hb_codepoint_t g = HB_SET_VALUE_INVALID;
  while (full_glyphs_to_retain->next(&g))
    glyphs->push(g);

  glyphs->qsort();

  cmap.fini();
  glyf.fini();

  return full_glyphs_to_retain;