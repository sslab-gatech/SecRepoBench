hb_set_t *gids_to_process = hb_set_copy (initial_gids_to_retain);
  hb_set_t *seen_gids = hb_set_create ();

  while (gids_to_process->next (&gid))
  {
    if (hb_set_has (seen_gids, gid))
      continue;

    hb_set_add (seen_gids, gid);
    full_glyphs_to_retain->add (gid);

    unsigned int num_components = glyf.get_num_components (gid);
    for (unsigned int j = 0; j < num_components; ++j)
    {
      hb_codepoint_t component_gid;
      if (glyf.get_component (gid, j, &component_gid))
	gids_to_process->add (component_gid);
    }
  }

  hb_set_destroy (gids_to_process);
  hb_set_destroy (seen_gids);
  hb_set_destroy (initial_gids_to_retain);

  glyphs->alloc (full_glyphs_to_retain->get_population ());
  gid = HB_SET_VALUE_INVALID;
  while (full_glyphs_to_retain->next (&gid))
    glyphs->push (gid);

  cmap.fini ();
  glyf.fini ();

  return full_glyphs_to_retain;