while (initial_gids_to_retain->next(&gid))
{
  full_glyphs_to_retain->add(gid);
  glyf.add_gid_and_children(gid, full_glyphs_to_retain);
}

hb_set_destroy(initial_gids_to_retain);

gid = HB_SET_VALUE_INVALID;
while (full_glyphs_to_retain->next(&gid))
{
  glyphs->push(gid);
}

cmap.fini();
glyf.fini();

return full_glyphs_to_retain;