hb_codepoint_t gid;
  hb_set_t *glyphs_to_retain = hb_set_create ();
  hb_set_t *composite_glyphs = hb_set_create ();
  hb_set_t *glyphs_to_retain_tmp = hb_set_create ();

  hb_set_union (glyphs_to_retain, initial_gids_to_retain);

  while (hb_set_next_value (initial_gids_to_retain, &gid))
  {
    if (glyf.get_glyph_is_simple (gid))
    {
      hb_set_add (glyphs_to_retain, gid);
    }
    else
    {
      hb_set_add (composite_glyphs, gid);
    }
  }

  hb_set_t *composite_components = hb_set_create ();
  while (hb_set_next_value (composite_glyphs, &gid))
  {
    hb_set_t *components = glyf.get_glyph_components (gid);
    hb_set_union (composite_components, components);
    hb_set_destroy (components);
  }

  hb_set_union (glyphs_to_retain, composite_components);
  hb_set_destroy (composite_components);

  hb_set_destroy (composite_glyphs);
  hb_set_destroy (initial_gids_to_retain);

  hb_vector_t<hb_codepoint_t> glyph_vector;
  hb_vector_t<hb_codepoint_t> glyphs_to_retain_vector;
  hb_set_t *glyphs_to_retain_tmp2 = hb_set_create ();

  hb_set_union (glyphs_to_retain_tmp2, glyphs_to_retain);
  hb_set_union (glyphs_to_retain_tmp2, glyphs);

  for (unsigned int i = 0; i < glyphs.len; i++)
  {
    hb_codepoint_t gid = glyphs[i];
    if (hb_set_has (glyphs_to_retain_tmp2, gid))
    {
      glyph_vector.push (gid);
    }
  }

  hb_set_destroy (glyphs_to_retain_tmp2);

  glyphs->copy_from (glyph_vector);
  hb_vector_destroy (glyph_vector);

  hb_set_destroy (glyphs_to_retain);

  return full_glyphs_to_retain;
}