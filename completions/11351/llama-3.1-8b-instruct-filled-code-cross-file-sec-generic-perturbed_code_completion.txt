hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyph_ids;
hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
_create_old_gid_to_new_gid_map (*glyphs, old_gid_to_new_gid_map);

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (initial_gids_to_retain->next (&gid))
{
  hb_codepoint_t new_gid = HB_SET_VALUE_INVALID;
  if (old_gid_to_new_gid_map->get (gid, &new_gid))
  {
    full_glyphs_to_retain->add (new_gid);
  }
  else
  {
    hb_vector_t<hb_codepoint_t> component_glyphs;
    hb_face_get_glyph_components (face, gid, &component_glyphs);
    for (unsigned int i = 0; i < component_glyphs.len; i++)
    {
      hb_codepoint_t component_gid = component_glyphs[i];
      hb_codepoint_t new_component_gid = HB_SET_VALUE_INVALID;
      if (old_gid_to_new_gid_map->get (component_gid, &new_component_gid))
      {
        full_glyphs_to_retain->add (new_component_gid);
      }
    }
  }
}

hb_set_destroy (initial_gids_to_retain);
hb_map_destroy (old_gid_to_new_gid_map);
hb_vector_destroy (&glyph_ids);

hb_set_t *result = hb_set_create ();
hb_set_copy (full_glyphs_to_retain, result);
hb_set_destroy (full_glyphs_to_retain);
return result;