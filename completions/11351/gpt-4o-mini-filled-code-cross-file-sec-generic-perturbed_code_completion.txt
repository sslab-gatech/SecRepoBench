while (initial_gids_to_retain->next (&gid))
  {
    full_glyphs_to_retain->add (gid);
    hb_set_t *composite_glyphs = hb_set_create ();
    hb_ot_layout_collect_composite_glyphs (face, gid, composite_glyphs);
    
    hb_codepoint_t comp_gid = HB_SET_VALUE_INVALID;
    while (composite_glyphs->next (&comp_gid))
    {
      full_glyphs_to_retain->add (comp_gid);
    }
    
    hb_set_destroy (composite_glyphs);
  }

  hb_vector_t<hb_codepoint_t> glyph_vector;
  glyph_vector.resize (full_glyphs_to_retain->size ());
  unsigned int index = 0;
  while (full_glyphs_to_retain->next (&gid))
  {
    glyph_vector[index++] = gid;
  }

  hb_map_t *glyph_map = hb_map_create ();
  _create_old_gid_to_new_gid_map (glyph_vector, glyph_map);

  hb_set_destroy (initial_gids_to_retain);
  hb_set_destroy (full_glyphs_to_retain);
  cmap.fini ();
  glyf.fini ();

  return full_glyphs_to_retain;