{
    // If PPM is present, the tile-part headers may be concatenated from the packed headers stream
    // (which was initialized after reading the SOT marker when in_tile_headers was set).
    // If PPT is present and this is the first tile-part, initialize the packed packet headers stream.
    if (tile->tile_part[tile->tp_idx].ppt_data && tile->tile_part[tile->tp_idx].ppt_data_size && tile->tp_idx == 0) {
        bytestream2_init(&tile->ppt_stream,
                         tile->tile_part[tile->tp_idx].ppt_data,
                         tile->tile_part[tile->tp_idx].ppt_data_size);
    }

    // Calculate the tile-part data size, initialize the bytestream with that segment,
    // and skip it in the main stream to move to the next marker.
    {
        ptrdiff_t tile_part_size = tp->tp_end - decodercontext->g.buffer;
        if (tile_part_size < 0 || tile_part_size > bytestream2_get_bytes_left(&decodercontext->g)) {
            av_log(decodercontext->avctx, AV_LOG_ERROR, "Invalid tile-part size\n");
            return AVERROR_INVALIDDATA;
        }
        bytestream2_init(&tp->codestream, decodercontext->g.buffer, tile_part_size);
        bytestream2_skip(&decodercontext->g, tile_part_size);
    }

    // Proceed to the next tile-part and continue reading markers.
    tile->tp_idx++;
    continue;
}