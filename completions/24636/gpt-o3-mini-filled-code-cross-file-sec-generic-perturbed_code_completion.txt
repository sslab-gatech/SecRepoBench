{
    int tp_size = tp->tp_end - decodercontext->g.buffer;
    if (tp_size < 0 || tp_size > bytestream2_get_bytes_left(&decodercontext->g)) {
        av_log(decodercontext->avctx, AV_LOG_ERROR, "Invalid tile-part size\n");
        return AVERROR_INVALIDDATA;
    }
    if (decodercontext->has_ppm) {
        /* If packed main header (PPM) is present, reinitialize the tile‐part stream
           from the packed header buffer for decoding tile‐part headers. */
        bytestream2_init(&decodercontext->tilepart_stream,
                         decodercontext->packed_headers,
                         decodercontext->packed_headers_size);
    } else if (decodercontext->ppt_data && tile->tp_idx == 0) {
        /* If PPT is present and this is the first tile‐part,
           initialize the packed packet header stream. */
        bytestream2_init(&decodercontext->packed_packet_stream,
                         decodercontext->ppt_data,
                         decodercontext->ppt_size);
    }
    /* Set up the data stream for the current tile-part.
       Assign the current position as the start of tile-part data and skip ahead
       by the computed tile-part size. */
    tp->data = decodercontext->g.buffer;
    tp->size = tp_size;
    bytestream2_skip(&decodercontext->g, tp_size);
    continue;
}