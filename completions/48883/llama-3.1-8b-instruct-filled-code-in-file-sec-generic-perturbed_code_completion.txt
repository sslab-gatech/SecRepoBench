{
  char const * const possible_filename_chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789._-";
  size_t filename_len = 0;
  size_t possible_filename_len = strlen(possible_filename_chars);
  uint8_t filename_found = 0;
  uint8_t filename_idx;
  uint8_t filename_char;

  // Extract the length of the filename.
  for (filename_idx = 0; filename_idx < 256; ++filename_idx)
  {
    if (tftp_packet->payload_packet_len < filename_idx + 1 /* filename is a nul terminated string */)
    {
      break;
    }
    if (tftp_packet->payload[tftp_packet->payload_packet_len - 1 - filename_idx] == 0x00)
    {
      filename_len = filename_idx;
      break;
    }
  }

  // Verify the filename is present and consists of printable characters.
  for (filename_idx = 0; filename_idx < filename_len; ++filename_idx)
  {
    filename_char = tftp_packet->payload[tftp_packet->payload_packet_len - 1 - filename_idx];
    if (strchr(possible_filename_chars, filename_char) == NULL)
    {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  // If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
  memcpy(flow->tftp_filename, &tftp_packet->payload[tftp_packet->payload_packet_len - 1 - filename_len], filename_len + 1);

  // Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.
  NDPI_LOG_INFO(ndpi_struct, "detected TFTP RRQ/WWQ packet with filename: %s\n", flow->tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}