// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
// Verify the filename is present and consists of printable characters.
// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.

char filename[256]; // Assuming a maximum filename length of 255 characters + null terminator
size_t filename_len = tftp_packet->payload_packet_len - 1 - mode_len - 1; // Adjusting for mode and null terminator

if (filename_len > 255) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

if (tftp_packet->payload_packet_len < mode_len + 1 + filename_len + 1) { // Adjusting for mode, null terminator, and filename
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

memcpy(filename, &tftp_packet->payload[tftp_packet->payload_packet_len - 1 - mode_len - filename_len], filename_len);
filename[filename_len] = '\0'; // Null-terminate the filename

// Verify the filename consists of printable characters
for (size_t i = 0; i < filename_len; i++) {
  if (!isprint(filename[i])) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
}

// Copy the filename into the flow structure's TFTP filename field
memset(flow->l4.udp.tftp_filename, 0, sizeof(flow->l4.udp.tftp_filename));
strncpy(flow->l4.udp.tftp_filename, filename, filename_len);

NDPI_LOG_INFO(ndpi_struct, "detected TFTP RRQ/WWQ packet with filename: %s\n", filename);
ndpi_int_tftp_add_connection(ndpi_struct, flow);