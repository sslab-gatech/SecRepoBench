size_t filename_len = 0;
const u_int8_t *filename_start = tftp_packet->payload + 2; // Skip opcode

// Find the end of the filename (null terminator)
while (filename_len < tftp_packet->payload_packet_len - 2 && filename_start[filename_len] != 0) {
    filename_len++;
}

// Verify filename is present and not too long
if (filename_len == 0 || filename_len >= sizeof(flow->protos.tftp.filename)) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
}

// Verify filename consists of printable characters
for (size_t i = 0; i < filename_len; i++) {
    if (!isprint(filename_start[i])) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
    }
}

// Copy filename to flow structure, ensuring null-termination
memcpy(flow->protos.tftp.filename, filename_start, filename_len);
flow->protos.tftp.filename[filename_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "Found TFTP %s request for file: %s\n",
              (get_u_int8_t(tftp_packet->payload, 1) == 0x01) ? "RRQ" : "WRQ",
              flow->protos.tftp.filename);

ndpi_int_tftp_add_connection(ndpi_struct, flow);