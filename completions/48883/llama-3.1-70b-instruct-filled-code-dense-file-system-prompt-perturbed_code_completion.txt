// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
// Verify the filename is present and consists of printable characters.
// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.

uint8_t filename_len = 0;
uint8_t *filename_ptr = NULL;

// Determine the length of the filename.
for (uint8_t i = 2; i < tftp_packet->payload_packet_len - mode_len - 1; i++) {
  if (tftp_packet->payload[i] == 0x00) {
    filename_len = i - 2;
    filename_ptr = &tftp_packet->payload[2];
    break;
  }
}

if (filename_len > 0 && filename_ptr!= NULL) {
  // Verify the filename consists of printable characters.
  for (uint8_t i = 0; i < filename_len; i++) {
    if (!isprint(filename_ptr[i])) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  // Copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
  strncpy(flow->protos.tftp.filename, (char const *)filename_ptr, filename_len);
  flow->protos.tftp.filename[filename_len] = '\0';

  NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ packet\n");
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
} else {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
}