// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
// Verify the filename is present and consists of printable characters.
// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.

uint8_t filename_idx = 2; // Skip the opcode
uint8_t filename_len = 0;

// Find the length of the filename
while (filename_idx < tftp_packet->payload_packet_len - 1) {
  if (tftp_packet->payload[filename_idx] == 0x00) {
    filename_len = filename_idx - 2; // Subtract the opcode and the null terminator
    break;
  }
  filename_idx++;
}

// Verify the filename is present and consists of printable characters
if (filename_len > 0) {
  for (uint8_t i = 2; i < filename_idx; i++) {
    if (!isprint(tftp_packet->payload[i])) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  // Copy the filename into the flow structure's TFTP filename field, ensuring null-termination
  strncpy(flow->l4.udp.tftp_filename, (char const *)&tftp_packet->payload[2], filename_len);
  flow->l4.udp.tftp_filename[filename_len] = '\0';

  // Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow
  NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ packet");
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}