size_t filename_len = tftp_packet->payload_packet_len - mode_len - 2; // -2 for the opcode and null terminator
          char *filename = (char *)malloc(filename_len + 1); // +1 for null terminator
          if (filename == NULL) {
            NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
            return;
          }
          strncpy(filename, (char *)&tftp_packet->payload[2], filename_len);
          filename[filename_len] = '\0'; // null-terminate the filename

          // Verify that the filename consists of printable characters
          for (size_t i = 0; i < filename_len; i++) {
            if (!isprint((unsigned char)filename[i])) {
              free(filename);
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return;
            }
          }

          // Store the filename in the flow structure
          strncpy(flow->l4.udp.tftp_filename, filename, sizeof(flow->l4.udp.tftp_filename) - 1);
          flow->l4.udp.tftp_filename[sizeof(flow->l4.udp.tftp_filename) - 1] = '\0'; // ensure null-termination
          free(filename);

          NDPI_LOG_INFO(ndpi_struct, "Detected TFTP RRQ/WWQ with filename: %s\n", flow->l4.udp.tftp_filename);
          ndpi_int_tftp_add_connection(ndpi_struct, flow);