size_t filename_len = tftp_packet->payload_packet_len - mode_len - 2; // -2 for the mode and null terminator
          char *filename = (char *)malloc(filename_len + 1); // +1 for null terminator
          if (filename == NULL) {
            NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
            return; // Memory allocation failed
          }

          // Copy the filename and ensure null-termination
          memcpy(filename, &tftp_packet->payload[2], filename_len);
          filename[filename_len] = '\0';

          // Validate the filename for printable characters
          for (size_t i = 0; i < filename_len; i++) {
            if (!isprint((unsigned char)filename[i])) {
              free(filename);
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return; // Invalid filename
            }
          }

          // Store the filename in the flow structure (assuming flow->tftp_filename is defined)
          strncpy(flow->tftp_filename, filename, sizeof(flow->tftp_filename) - 1);
          flow->tftp_filename[sizeof(flow->tftp_filename) - 1] = '\0'; // Ensure null-termination

          free(filename); // Free the allocated memory
          NDPI_LOG_INFO(ndpi_struct, "Detected TFTP RRQ/WWQ with filename: %s\n", flow->tftp_filename);
          ndpi_int_tftp_add_connection(ndpi_struct, flow);