{
  /* Find and validate the filename (the string following the opcode) */
  size_t filename_start = 2, filename_end = filename_start;
  while (filename_end < tftp_packet->payload_packet_len &&
         tftp_packet->payload[filename_end] != '\0')
  {
    if(!isprint((unsigned char)tftp_packet->payload[filename_end])) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    filename_end++;
  }

  /* If we didn't find a null terminator or there's nothing after opcode, exclude */
  if (filename_end >= tftp_packet->payload_packet_len - 1 || filename_end == filename_start) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  {
    /* Copy and null-terminate filename safely */
    size_t filename_len = filename_end - filename_start;
    if (filename_len >= sizeof(flow->l4.udp.tftp_filename)) {
      filename_len = sizeof(flow->l4.udp.tftp_filename) - 1;
    }
    memcpy(flow->l4.udp.tftp_filename,
           &tftp_packet->payload[filename_start],
           filename_len);
    flow->l4.udp.tftp_filename[filename_len] = '\0';
  }

  NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ packet with filename '%s'\n",
                flow->l4.udp.tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}