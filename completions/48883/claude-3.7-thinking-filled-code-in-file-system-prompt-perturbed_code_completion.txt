size_t i;
size_t filename_len = 0;

// Find the null terminator for the filename
for (i = 2; i < tftp_packet->payload_packet_len; i++) {
  if (tftp_packet->payload[i] == 0x00) {
    filename_len = i - 2;
    break;
  }
}

// Check if we found a valid filename
if (filename_len == 0 || i == tftp_packet->payload_packet_len) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

// Verify filename contains only printable characters
for (i = 0; i < filename_len; i++) {
  // ASCII printable characters range from 32 to 126
  if (tftp_packet->payload[2 + i] < 32 || tftp_packet->payload[2 + i] > 126) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
}

// Create a null-terminated copy of the filename for logging
char filename_buf[256];
size_t copy_len = filename_len < sizeof(filename_buf) - 1 ? filename_len : sizeof(filename_buf) - 1;
memcpy(filename_buf, &tftp_packet->payload[2], copy_len);
filename_buf[copy_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "found tftp: %s\n", filename_buf);
ndpi_int_tftp_add_connection(ndpi_struct, flow);