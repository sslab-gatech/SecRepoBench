size_t filename_len = tftp_packet->payload_packet_len - 2 - mode_len; // 2 for opcode and mode
          char *filename = (char *)malloc(filename_len + 1); // +1 for null-terminator
          if (filename == NULL) {
            NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
            return;
          }

          // Copy the filename from the payload
          memcpy(filename, &tftp_packet->payload[2 + mode_len], filename_len);
          filename[filename_len] = '\0'; // Null-terminate the filename

          // Verify the filename consists of printable characters
          for (size_t i = 0; i < filename_len; i++) {
            if (!isprint((unsigned char)filename[i])) {
              free(filename);
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return;
            }
          }

          // Store the filename in the flow structure
          strncpy(flow->l4.udp.tftp_filename, filename, sizeof(flow->l4.udp.tftp_filename) - 1);
          flow->l4.udp.tftp_filename[sizeof(flow->l4.udp.tftp_filename) - 1] = '\0'; // Ensure null-termination
          free(filename); // Free the allocated memory

          NDPI_LOG_INFO(ndpi_struct, "Detected TFTP %s request for file: %s\n", 
                        (tftp_packet->payload[1] == 0x01) ? "RRQ" : "WWQ", flow->l4.udp.tftp_filename);