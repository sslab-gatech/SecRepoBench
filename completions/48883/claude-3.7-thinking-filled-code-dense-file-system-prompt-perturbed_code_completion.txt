size_t filename_offset = 2; /* After 2-byte opcode */
size_t filename_len = 0;
const char *filename_start = (const char *)&tftp_packet->payload[filename_offset];

/* Find the null terminator for the filename */
while (filename_offset + filename_len < tftp_packet->payload_packet_len && 
       tftp_packet->payload[filename_offset + filename_len] != 0) {
  /* Check for printable characters */
  if (!isprint(tftp_packet->payload[filename_offset + filename_len])) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
  filename_len++;
}

/* Verify filename exists and is valid */
if (filename_len == 0 || filename_offset + filename_len >= tftp_packet->payload_packet_len) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

/* Copy filename to flow structure with null termination */
if (filename_len < sizeof(flow->protos.tftp.filename) - 1) {
  memcpy(flow->protos.tftp.filename, filename_start, filename_len);
  flow->protos.tftp.filename[filename_len] = '\0';
} else {
  memcpy(flow->protos.tftp.filename, filename_start, 
         sizeof(flow->protos.tftp.filename) - 1);
  flow->protos.tftp.filename[sizeof(flow->protos.tftp.filename) - 1] = '\0';
}

NDPI_LOG_INFO(ndpi_struct, "found tftp: %s\n", flow->protos.tftp.filename);
ndpi_int_tftp_add_connection(ndpi_struct, flow);