{
  size_t filename_offset = 2;
  size_t max_filename_len = tftp_packet->payload_packet_len - filename_offset;
  size_t filename_len = strnlen((char *)&tftp_packet->payload[filename_offset], max_filename_len);

  if ((filename_len == 0) || (filename_len >= max_filename_len)) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  /* Verify that the filename contains only printable characters */
  for (size_t i = 0; i < filename_len; ++i) {
    if (!isprint((unsigned char)tftp_packet->payload[filename_offset + i])) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  /* Copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
     Assuming that flow->l4.udp.tftp_filename is a char array large enough to hold the filename. */
  strncpy(flow->l4.udp.tftp_filename, (char *)&tftp_packet->payload[filename_offset], filename_len);
  flow->l4.udp.tftp_filename[filename_len] = '\0';

  NDPI_LOG_INFO(ndpi_struct, "TFTP RRQ/WWQ detected, filename: %s", flow->l4.udp.tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}