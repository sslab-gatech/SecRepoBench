// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
// Verify the filename is present and consists of printable characters.
// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.
{
  char const * const possible_modes[] = { "netascii", "octet", "mail" };
  uint8_t mode_found = 0, mode_idx;
  size_t mode_len;

  for(mode_idx = 0; mode_idx < NDPI_ARRAY_LENGTH(possible_modes); ++mode_idx)
  {
    mode_len = strlen(possible_modes[mode_idx]);

    if (tftp_packet->payload_packet_len < mode_len + 1 /* mode is a nul terminated string */)
    {
      continue;
    }
    if (strncasecmp((char const *)&tftp_packet->payload[tftp_packet->payload_packet_len - 1 - mode_len],
                    possible_modes[mode_idx], mode_len) == 0)
    {
      mode_found = 1;
      break;
    }
  }

  if (mode_found == 0)
  {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  // Extract the filename from the TFTP RRQ/WWQ packet.
  size_t filename_len = tftp_packet->payload_packet_len - mode_len - 1;
  if (filename_len == 0)
  {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  // Verify the filename is present and consists of printable characters.
  for (size_t i = 0; i < filename_len; ++i)
  {
    if (!isprint(tftp_packet->payload[tftp_packet->payload_packet_len - 1 - mode_len - i - 1]))
    {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  // If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
  strncpy(flow->tftp_filename, (char const *)&tftp_packet->payload[tftp_packet->payload_packet_len - 1 - mode_len - filename_len], filename_len);
  flow->tftp_filename[filename_len] = '\0';

  // Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.
  NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ packet with filename '%s'\n", flow->tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}