// Extract the filename from the TFTP RRQ/WWQ packet.
{
  size_t filename_len = 0;
  const char *filename_start = (const char *)&tftp_packet->payload[2]; // Start after opcode

  // Find the length of the filename by searching for the first null byte
  while (filename_start[filename_len] != '\0' && 
         (filename_start + filename_len) < (const char *)&tftp_packet->payload[tftp_packet->payload_packet_len - 1]) {
    filename_len++;
  }

  // Ensure the filename is null-terminated and within bounds
  if (filename_start[filename_len] != '\0' || filename_len == 0) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  // Verify the filename consists of printable characters
  for (size_t i = 0; i < filename_len; i++) {
    if (!isprint((unsigned char)filename_start[i])) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  // Copy the filename into the flow structure's TFTP filename field, ensuring null-termination
  strncpy(flow->l4.udp.tftp_filename, filename_start, filename_len);
  flow->l4.udp.tftp_filename[filename_len] = '\0';

  // Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow
  NDPI_LOG_INFO(ndpi_struct, "found tftp RRQ/WWQ with filename: %s\n", flow->l4.udp.tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}