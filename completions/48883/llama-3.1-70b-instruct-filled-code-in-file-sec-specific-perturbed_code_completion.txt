// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
size_t filename_len = 0;
for (filename_len = 2; filename_len < tftp_packet->payload_packet_len - 1; filename_len++) {
  if (tftp_packet->payload[filename_len] == 0x00) {
    break;
  }
}

// Verify the filename is present and consists of printable characters.
if (filename_len <= 2 || filename_len >= tftp_packet->payload_packet_len - 1) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}
for (size_t i = 2; i < filename_len; i++) {
  if (!isprint(tftp_packet->payload[i])) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
}

// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
memcpy(flow->tftp.filename, &tftp_packet->payload[2], filename_len - 2);
flow->tftp.filename[filename_len - 2] = '\0';

// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.
NDPI_LOG_DBG2(ndpi_struct, "found TFTP RRQ/WWQ packet\n");
ndpi_int_tftp_add_connection(ndpi_struct, flow);