{
  size_t filename_start = 2; // opcode is at offset 1, filename starts at 2
  size_t filename_end = filename_start;
  size_t payload_len = tftp_packet->payload_packet_len;
  size_t max_filename_len = sizeof(flow->l4.udp.tftp_filename) - 1;
  size_t i;

  // Find the end of the filename (first NUL after filename_start)
  while (filename_end < payload_len && tftp_packet->payload[filename_end] != 0x00)
    filename_end++;

  if (filename_end == payload_len || filename_end == filename_start) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  // Check that filename is printable
  for (i = filename_start; i < filename_end; ++i) {
    if (tftp_packet->payload[i] < 32 || tftp_packet->payload[i] > 126) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  // Copy filename, ensure null-termination
  {
    size_t copy_len = filename_end - filename_start;
    if (copy_len > max_filename_len)
      copy_len = max_filename_len;
    memcpy(flow->l4.udp.tftp_filename, &tftp_packet->payload[filename_start], copy_len);
    flow->l4.udp.tftp_filename[copy_len] = '\0';
  }

  NDPI_LOG_INFO(ndpi_struct, "found tftp RRQ/WWQ: filename='%s'\n", flow->l4.udp.tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}