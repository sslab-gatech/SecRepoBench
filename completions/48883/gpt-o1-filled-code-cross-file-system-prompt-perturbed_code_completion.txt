{
  /* Extract the filename */
  uint32_t offset = 2; /* Skip the first two bytes: [0]=0x00, [1]=opcode */
  char filename[256];
  uint32_t filename_len = 0;

  while (offset < tftp_packet->payload_packet_len && tftp_packet->payload[offset] != 0) {
    /* Check if character is printable */
    if (tftp_packet->payload[offset] < 32 || tftp_packet->payload[offset] > 126) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    /* Check for space in filename buffer */
    if (filename_len >= sizeof(filename) - 1) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    /* Copy character and increment */
    filename[filename_len++] = (char)tftp_packet->payload[offset++];
  }

  /* Ensure filename exists and offset is valid */
  if (filename_len == 0 || offset >= tftp_packet->payload_packet_len) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  /* Null-terminate the filename */
  filename[filename_len] = '\0';

  /* Copy to flow structure (assuming flow->l4.udp.tftp_filename exists) */
  strncpy(flow->l4.udp.tftp_filename, filename, sizeof(flow->l4.udp.tftp_filename));
  flow->l4.udp.tftp_filename[sizeof(flow->l4.udp.tftp_filename) - 1] = '\0';

  /* Log and add connection */
  NDPI_LOG_INFO(ndpi_struct, "Detected TFTP RRQ/WWQ: filename '%s'\n", filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}