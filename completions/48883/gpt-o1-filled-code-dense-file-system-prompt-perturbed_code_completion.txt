{
  /* Skip opcode bytes (2) to find the start of the filename */
  uint16_t offset = 2;
  /* Locate the filename by searching until the next null terminator (if any) */
  while (offset < tftp_packet->payload_packet_len &&
         tftp_packet->payload[offset] != 0x00) {
    /* Check for printable characters */
    if (tftp_packet->payload[offset] < 32 || tftp_packet->payload[offset] > 126) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    offset++;
  }

  /* If offset is still 2, then the filename was empty; 
     or if offset reached beyond payload length, there's no proper null terminator. */
  if (offset == 2 || offset >= tftp_packet->payload_packet_len) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  /* Calculate filename length */
  uint16_t filename_len = offset - 2;
  /* Ensure we don't overflow the destination buffer */
  if (filename_len >= sizeof(flow->protos.tftp.filename)) {
    filename_len = sizeof(flow->protos.tftp.filename) - 1;
  }

  /* Copy and null-terminate the filename */
  memcpy(flow->protos.tftp.filename, &tftp_packet->payload[2], filename_len);
  flow->protos.tftp.filename[filename_len] = '\0';

  NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ request for file: %s\n",
                flow->protos.tftp.filename);

  /* Mark protocol detection completion */
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}