// Extract the filename from the TFTP RRQ/WWQ packet.
char *filename = (char *)&tftp_packet->payload[2];
size_t filename_len = tftp_packet->payload_packet_len - 2 - mode_len - 1; // 2 for opcode, mode_len for mode, 1 for \0

// Verify the filename is present and consists of printable characters.
if (filename_len <= 0) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

for (size_t i = 0; i < filename_len; i++) {
  if (!isprint(filename[i])) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
}

// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
strncpy(flow->l4.udp.tftp.filename, filename, filename_len);
flow->l4.udp.tftp.filename[filename_len] = '\0';

// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.
NDPI_LOG_DBG2(ndpi_struct, "found tftp rrq/wwq\n");
flow->l4.udp.tftp_stage = 1;