// Extract the filename from the TFTP RRQ/WWQ packet.
size_t filename_len = 0;
while (filename_len < tftp_packet->payload_packet_len && tftp_packet->payload[filename_len] != 0x00) {
    filename_len++;
}

// Verify the filename is present and consists of printable characters.
if (filename_len == 0 || filename_len >= sizeof(flow->protos.tftp.filename)) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
}

for (size_t i = 0; i < filename_len; i++) {
    if (!isprint(tftp_packet->payload[i])) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
    }
}

// Copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
size_t copy_len = ndpi_min(filename_len, sizeof(flow->protos.tftp.filename) - 1);
memcpy(flow->protos.tftp.filename, tftp_packet->payload, copy_len);
flow->protos.tftp.filename[copy_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "found tftp RRQ/WWQ packet with filename: %s\n", flow->protos.tftp.filename);
ndpi_int_tftp_add_connection(ndpi_struct, flow);