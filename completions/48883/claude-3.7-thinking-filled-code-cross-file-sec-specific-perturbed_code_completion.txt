// Extract filename from TFTP RRQ/WWQ packet
uint16_t filename_offset = 2; // Skip the opcode
size_t filename_len = 0;

// Find the length of the filename (search for the null terminator)
while (filename_offset + filename_len < tftp_packet->payload_packet_len && 
       tftp_packet->payload[filename_offset + filename_len] != 0x00) {
    // Verify character is printable
    if (tftp_packet->payload[filename_offset + filename_len] < 32 || 
        tftp_packet->payload[filename_offset + filename_len] > 126) {
        // Non-printable character found in filename
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
    }
    filename_len++;
}

// Check if we found the null terminator and if the filename has valid length
if (filename_offset + filename_len >= tftp_packet->payload_packet_len || filename_len == 0) {
    // Filename missing, not null-terminated, or empty
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
}

NDPI_LOG_INFO(ndpi_struct, "found tftp RRQ/WWQ\n");
ndpi_int_tftp_add_connection(ndpi_struct, flow);