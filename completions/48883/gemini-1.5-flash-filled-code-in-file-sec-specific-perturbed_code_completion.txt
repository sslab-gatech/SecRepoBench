size_t filename_len = tftp_packet->payload_packet_len - 1 - mode_len - 2; // Subtract null terminators and mode length
          if (filename_len > 0) {
            char *filename = (char *)malloc(filename_len + 1);
            if (filename != NULL) {
              // Check for printable characters in the filename
              bool valid_filename = true;
              for (size_t i = 0; i < filename_len; ++i) {
                if (!isprint(tftp_packet->payload[2 + i])) {
                  valid_filename = false;
                  break;
                }
              }

              if (valid_filename) {
                memcpy(filename, &tftp_packet->payload[2], filename_len);
                filename[filename_len] = '\0';
                flow->l4.udp.tftp_filename = filename;
              } else {
                free(filename);
              }
            }
          }
          NDPI_LOG_DBG(ndpi_struct, "found tftp RRQ/WWQ\n");
          ndpi_int_tftp_add_connection(ndpi_struct, flow);