size_t filename_len = tftp_packet->payload_packet_len - 1 - mode_len - 2; // Subtract mode length, opcode, and two null terminators

          if (filename_len <= 0 || filename_len >= NDPI_TFTP_FILENAME_MAX_LEN || tftp_packet->payload[2 + filename_len] != 0x00) {
            NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
            return;
          }

          for (size_t i = 0; i < filename_len; ++i) {
            if (!isprint(tftp_packet->payload[2 + i])) {
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return;
            }
          }


          memcpy(flow->l4.udp.tftp_filename, &tftp_packet->payload[2], filename_len);
          flow->l4.udp.tftp_filename[filename_len] = '\0';

          NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WRQ packet (filename: %s)\n", flow->l4.udp.tftp_filename);
          ndpi_int_tftp_add_connection(ndpi_struct, flow);