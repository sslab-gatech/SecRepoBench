uint16_t filename_start = 2;
uint16_t filename_end = filename_start;

while (filename_end < tftp_packet->payload_packet_len && 
       tftp_packet->payload[filename_end] != 0x00) {
    filename_end++;
}

if (filename_end >= tftp_packet->payload_packet_len || 
    filename_end - filename_start == 0) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
}

for (uint16_t i = filename_start; i < filename_end; i++) {
    if (!isprint(tftp_packet->payload[i])) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
    }
}

size_t max_len = sizeof(flow->protos.tftp.filename) - 1;
uint16_t copy_len = (filename_end - filename_start) < max_len ? 
                   (filename_end - filename_start) : max_len;
memcpy(flow->protos.tftp.filename, &tftp_packet->payload[filename_start], copy_len);
flow->protos.tftp.filename[copy_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ\n");
ndpi_int_tftp_add_connection(ndpi_struct, flow);