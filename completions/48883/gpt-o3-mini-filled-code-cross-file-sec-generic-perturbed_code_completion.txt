{
  size_t filename_start = 2;
  size_t filename_end = 0, i;
  /* Search for the null-terminator marking the end of the filename */
  for(i = filename_start; i < tftp_packet->payload_packet_len; i++) {
    if(tftp_packet->payload[i] == 0x00) {
      filename_end = i;
      break;
    }
  }
  if(filename_end == 0 || filename_end == filename_start) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
  size_t filename_length = filename_end - filename_start;
  /* Verify that every character in the filename is printable */
  for(i = filename_start; i < filename_end; i++) {
    if(!isprint((unsigned char)tftp_packet->payload[i])) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }
  /* Safely copy the filename into the flow's tftp_filename field */
  if(filename_length >= sizeof(flow->l4.udp.tftp_filename)) {
    filename_length = sizeof(flow->l4.udp.tftp_filename) - 1;
  }
  memcpy(flow->l4.udp.tftp_filename, &tftp_packet->payload[filename_start], filename_length);
  flow->l4.udp.tftp_filename[filename_length] = '\0';

  NDPI_LOG_INFO(ndpi_struct, "TFTP RRQ/WRQ packet: filename %s", flow->l4.udp.tftp_filename);
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}