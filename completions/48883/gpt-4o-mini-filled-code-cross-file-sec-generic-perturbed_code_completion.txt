size_t filename_len = tftp_packet->payload_packet_len - mode_len - 2; // -2 for opcode and mode
          char *filename = (char *)malloc(filename_len + 1); // +1 for null-terminator
          if (filename == NULL) {
            NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
            return;
          }

          // Copy the filename and ensure null-termination
          memcpy(filename, &tftp_packet->payload[2], filename_len);
          filename[filename_len] = '\0';

          // Verify that the filename consists of printable characters
          for (size_t i = 0; i < filename_len; i++) {
            if (!isprint((unsigned char)filename[i])) {
              free(filename);
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return;
            }
          }

          // Store the filename in the flow structure
          strncpy(flow->tftp_filename, filename, sizeof(flow->tftp_filename) - 1);
          flow->tftp_filename[sizeof(flow->tftp_filename) - 1] = '\0'; // Ensure null-termination

          free(filename); // Free the allocated memory
          NDPI_LOG_INFO(ndpi_struct, "Detected TFTP filename: %s\n", flow->tftp_filename);