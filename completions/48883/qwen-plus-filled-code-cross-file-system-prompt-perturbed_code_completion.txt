{
  size_t filename_len = 0;
  char const *filename_start = NULL;

  /* Calculate the length of the filename */
  for (size_t i = 2; i < tftp_packet->payload_packet_len; ++i) {
    if (tftp_packet->payload[i] == '\0') {
      filename_start = (char const *)&tftp_packet->payload[2];
      filename_len = i - 2;
      break;
    }
  }

  /* Verify that a valid filename was found and consists of printable characters */
  if (!filename_start || filename_len == 0) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  for (size_t i = 0; i < filename_len; ++i) {
    if (!(tftp_packet->payload[2 + i] >= 32 && tftp_packet->payload[2 + i] <= 126)) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  /* Copy the filename into the flow structure's TFTP filename field */
  if (flow->l4.udp.tftp_filename && filename_len < sizeof(flow->l4.udp.tftp_filename) - 1) {
    memcpy(flow->l4.udp.tftp_filename, filename_start, filename_len);
    flow->l4.udp.tftp_filename[filename_len] = '\0';
  }

  /* Log the detection of a TFTP RRQ/WWQ packet */
  NDPI_LOG_INFO(ndpi_struct, "detected TFTP RRQ/WWQ with filename: %s\n", flow->l4.udp.tftp_filename);

  /* Add the connection to the flow */
  ndpi_int_tftp_add_connection(ndpi_struct, flow);
}