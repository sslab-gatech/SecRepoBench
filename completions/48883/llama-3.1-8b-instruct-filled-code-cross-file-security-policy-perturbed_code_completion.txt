// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
// Verify the filename is present and consists of printable characters.
// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.
// <MASK>

size_t filename_len = strlen((char const *)&tftp_packet->payload[tftp_packet->payload_packet_len - 1 - strlen("netascii")]);
if (tftp_packet->payload_packet_len < filename_len + 1 /* filename is a nul terminated string */)
{
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}
if (strncasecmp((char const *)&tftp_packet->payload[tftp_packet->payload_packet_len - 1 - filename_len],
                "netascii", filename_len)!= 0)
{
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

// Calculate the length of the filename, ensuring it does not exceed the allocated space.
size_t filename_space = sizeof(flow->tftp_filename) - 1;
size_t filename_len_safe = ndpi_min(filename_len, filename_space);

// Copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
memcpy(flow->tftp_filename, (char const *)&tftp_packet->payload[tftp_packet->payload_packet_len - 1 - filename_len], filename_len_safe);
flow->tftp_filename[filename_len_safe] = '\0';

NDPI_LOG_INFO(ndpi_struct, "found TFTP RRQ/WWQ packet with filename: %s\n", flow->tftp_filename);
ndpi_int_tftp_add_connection(ndpi_struct, flow);