// Extract the filename from the TFTP RRQ/WWQ packet.
// Determine the length of the filename.
// Verify the filename is present and consists of printable characters.
// If valid, copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
// Log the detection of a TFTP RRQ/WWQ packet and add the connection to the flow.

size_t filename_len = 0;
uint8_t *filename_ptr = NULL;

// Find the filename in the TFTP packet
for (uint16_t i = 2; i < tftp_packet->payload_packet_len - mode_len - 1; i++) {
  if (tftp_packet->payload[i] == 0x00) {
    filename_len = i - 2;
    filename_ptr = &tftp_packet->payload[2];
    break;
  }
}

if (filename_len == 0 || filename_ptr == NULL) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

// Verify the filename consists of printable characters
for (uint16_t i = 0; i < filename_len; i++) {
  if (!isprint(filename_ptr[i])) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
}

// Copy the filename into the flow structure's TFTP filename field
strncpy(flow->l4.udp.tftp_filename, (char const *)filename_ptr, filename_len);
flow->l4.udp.tftp_filename[filename_len] = '\0';

NDPI_LOG_DBG(ndpi_struct, "detected TFTP RRQ/WWQ packet with filename: %s\n", flow->l4.udp.tftp_filename);
ndpi_int_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_TFTP, NDPI_REAL_PROTOCOL);