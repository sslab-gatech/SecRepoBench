size_t filename_len = 0;
while (filename_len < tftp_packet->payload_packet_len - mode_len - 2 &&
       tftp_packet->payload[filename_len + 2] != 0) {
  if (!isprint(tftp_packet->payload[filename_len + 2])) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }
  filename_len++;
}

if (filename_len == 0 || filename_len >= sizeof(flow->protos.tftp.filename)) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  return;
}

memcpy(flow->protos.tftp.filename, &tftp_packet->payload[2], filename_len);
flow->protos.tftp.filename[filename_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "found TFTP %s request\n", 
              get_u_int8_t(tftp_packet->payload, 1) == 0x01 ? "RRQ" : "WRQ");
ndpi_int_tftp_add_connection(ndpi_struct, flow);