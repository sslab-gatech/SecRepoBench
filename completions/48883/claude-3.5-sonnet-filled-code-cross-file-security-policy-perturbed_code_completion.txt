size_t filename_len = 2; // Start after opcode
while (filename_len < tftp_packet->payload_packet_len && tftp_packet->payload[filename_len] != 0x00) {
    filename_len++;
}

if (filename_len > 2 && filename_len < tftp_packet->payload_packet_len) {
    size_t max_filename_len = sizeof(flow->protos.tftp.filename) - 1;
    size_t safe_len = ndpi_min(filename_len - 2, max_filename_len);

    for (size_t i = 0; i < safe_len; i++) {
        if (!isprint(tftp_packet->payload[i + 2])) {
            NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
            return;
        }
    }

    memcpy(flow->protos.tftp.filename, &tftp_packet->payload[2], safe_len);
    flow->protos.tftp.filename[safe_len] = '\0';

    NDPI_LOG_INFO(ndpi_struct, "Found TFTP %s request for file: %s\n",
                  (get_u_int8_t(tftp_packet->payload, 1) == 0x01) ? "RRQ" : "WRQ",
                  flow->protos.tftp.filename);

    ndpi_int_tftp_add_connection(ndpi_struct, flow);
} else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
}