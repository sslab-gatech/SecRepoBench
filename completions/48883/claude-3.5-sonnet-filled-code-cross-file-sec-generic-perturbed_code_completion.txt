size_t filename_len = 0;
const u_int8_t *payload = tftp_packet->payload;
u_int16_t payload_len = tftp_packet->payload_packet_len;

// Find the end of the filename (null terminator)
while (filename_len < payload_len && payload[filename_len + 2] != 0) {
    filename_len++;
}

// Verify filename is present and consists of printable characters
if (filename_len == 0 || filename_len >= payload_len - 2) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
}

for (size_t i = 2; i < filename_len + 2; i++) {
    if (!isprint(payload[i])) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
    }
}

// Copy filename to flow structure, ensuring null-termination
size_t max_filename_len = sizeof(flow->protos.tftp.filename) - 1;
size_t copy_len = (filename_len < max_filename_len) ? filename_len : max_filename_len;
memcpy(flow->protos.tftp.filename, &payload[2], copy_len);
flow->protos.tftp.filename[copy_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "Found TFTP %s request, filename: %s\n",
              (payload[1] == 0x01) ? "RRQ" : "WRQ",
              flow->protos.tftp.filename);

ndpi_int_tftp_add_connection(ndpi_struct, flow);