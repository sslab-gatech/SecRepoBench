{
  /* Find the end of the filename. It starts at offset 2 and continues until
   * the first null terminator or the end of the packet. */
  uint16_t i;
  const uint8_t *payload = tftp_packet->payload;
  const uint16_t plen = tftp_packet->payload_packet_len;

  for(i = 2; i < plen; i++) {
    if(payload[i] == 0x00) {
      break;
    }
  }

  /* If we didn't find a null terminator or no filename, it's invalid. */
  if(i == plen || i == 2) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  {
    uint16_t filename_len = i - 2;

    /* Verify filename characters are printable and within a reasonable range. */
    if(filename_len >= sizeof(flow->l4.udp.tftp_filename)) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }

    for(uint16_t j = 2; j < i; j++) {
      if(!isprint(payload[j])) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
      }
    }

    /* Copy the filename safely into the flow structure, ensuring null-termination. */
    memcpy(flow->l4.udp.tftp_filename, &payload[2], filename_len);
    flow->l4.udp.tftp_filename[filename_len] = '\0';

    /* Log the detection of TFTP RRQ/WWQ and add the connection. */
    NDPI_LOG_INFO(ndpi_struct, "TFTP RRQ/WWQ request with filename: %s\n", flow->l4.udp.tftp_filename);
    ndpi_int_tftp_add_connection(ndpi_struct, flow);
  }
}