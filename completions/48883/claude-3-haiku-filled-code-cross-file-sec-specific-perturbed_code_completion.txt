// Extract the filename from the TFTP RRQ/WWQ packet.
size_t filename_len = 0;
for (size_t i = 2; i < tftp_packet->payload_packet_len; i++) {
    if (tftp_packet->payload[i] == 0x00) {
        filename_len = i - 2;
        break;
    }
}

// Verify the filename is present and consists of printable characters.
if (filename_len == 0 || filename_len >= NDPI_FILENAME_LEN) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
}

for (size_t i = 2; i < 2 + filename_len; i++) {
    if (!isprint(tftp_packet->payload[i])) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
    }
}

// Copy the filename into the flow structure's TFTP filename field, ensuring null-termination.
memcpy(flow->protos.tftp.filename, &tftp_packet->payload[2], filename_len);
flow->protos.tftp.filename[filename_len] = '\0';

NDPI_LOG_INFO(ndpi_struct, "found tftp RRQ/WWQ packet with filename: %s", flow->protos.tftp.filename);
ndpi_int_tftp_add_connection(ndpi_struct, flow);