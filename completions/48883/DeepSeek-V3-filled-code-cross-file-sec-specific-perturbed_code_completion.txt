uint16_t filename_len = 0;
          const uint8_t *payload = tftp_packet->payload;
          uint16_t payload_len = tftp_packet->payload_packet_len;

          // Find the length of the filename (first null-terminated string after opcode)
          while (filename_len < payload_len - 2 && payload[2 + filename_len] != 0x00) {
              if (!isprint(payload[2 + filename_len])) {
                  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
                  return;
              }
              filename_len++;
          }

          // Check if we found a valid filename
          if (filename_len == 0 || filename_len >= payload_len - 2 - mode_len - 1) {
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return;
          }

          // Ensure we don't overflow the destination buffer
          if (filename_len >= sizeof(flow->protos.tftp.filename) - 1) {
              filename_len = sizeof(flow->protos.tftp.filename) - 1;
          }

          // Copy the filename and ensure null-termination
          memcpy(flow->protos.tftp.filename, &payload[2], filename_len);
          flow->protos.tftp.filename[filename_len] = '\0';

          NDPI_LOG_INFO(ndpi_struct, "found TFTP %s request for file %s\n",
                       (get_u_int8_t(tftp_packet->payload, 1) == 0x01) ? "read" : "write",
                       flow->protos.tftp.filename);
          ndpi_int_tftp_add_connection(ndpi_struct, flow);