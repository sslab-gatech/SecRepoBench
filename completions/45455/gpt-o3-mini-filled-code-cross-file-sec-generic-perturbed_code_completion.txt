{
    xmlChar *name;
    /* Skip the '&' already parsed */
    NEXT;
    name = xmlParseName(ctxt);
    if (name == NULL) {
        xmlFatalErrMsg(ctxt, XML_ERR_NAME_REQUIRED, "xmlParseReference: no name\n");
        return;
    }
    if (RAW != ';') {
        xmlFatalErr(ctxt, XML_ERR_ENTITYREF_SEMICOL_MISSING, NULL);
        xmlFree(name);
        return;
    }
    NEXT;  /* skip the ';' */

    /* First check for predefined entities if not using old SAX options */
    if ((ctxt->options & XML_PARSE_OLDSAX) == 0)
        ent = xmlGetPredefinedEntity(name);
    if (ent != NULL) {
        /* Predefined entity found; if it has inline content, pass it to the SAX handler */
        if ((ent->content == NULL) || (ent->content[0] == 0)) {
            xmlFree(name);
            return;
        }
        if ((ctxt->sax != NULL) && (ctxt->sax->characters != NULL) &&
            (!ctxt->disableSAX))
            ctxt->sax->characters(ctxt->userData, ent->content, xmlStrlen(ent->content));
        xmlFree(name);
        return;
    }

    /* Lookup the entity via SAX callback if available */
    if ((ctxt->sax != NULL) && (ctxt->sax->getEntity != NULL))
        ent = ctxt->sax->getEntity(ctxt->userData, name);

    if (ent == NULL) {
        xmlErrMsgStr(ctxt, XML_WAR_UNDECLARED_ENTITY,
                     "Entity '%s' not defined\n", name);
        xmlFree(name);
        xmlParserEntityCheck(ctxt, 0, ent, 0);
        return;
    }
    xmlFree(name);

    /* Store the entity's checked status for later use */
    entity_checked_status = ent->checked;
}