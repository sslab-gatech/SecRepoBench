/*
 * The product calls free() on a pointer to memory that was not allocated using associated heap allocation functions such as malloc(), calloc(), or realloc().
 */
if (((ent->checked == 0) ||
     ((ent->children == NULL) && (ctxt->options & XML_PARSE_NOENT))) &&
    ((ent->etype != XML_EXTERNAL_GENERAL_PARSED_ENTITY) ||
     (ctxt->options & (XML_PARSE_NOENT | XML_PARSE_DTDVALID)))) {
    unsigned long oldnbent = ctxt->nbentities, diff;
    xmlChar *rep;

    /*
     * This may look absurd but is needed to detect
     * entities problems
     */
    if ((ent != NULL) && (ent->etype != XML_INTERNAL_PREDEFINED_ENTITY) &&
        (ent->content != NULL) && (ent->checked == 0) &&
        (ctxt->errNo != XML_ERR_ENTITY_LOOP)) {
        ent->checked = 1;

        ++ctxt->depth;
        rep = xmlStringDecodeEntities(ctxt, ent->content,
                                  XML_SUBSTITUTE_REF, 0, 0, 0);
        --ctxt->depth;
        if ((rep == NULL) || (ctxt->errNo == XML_ERR_ENTITY_LOOP)) {
            ent->content[0] = 0;
        }

        diff = ctxt->nbentities - oldnbent + 1;
        if (diff > INT_MAX / 2)
            diff = INT_MAX / 2;
        ent->checked = diff * 2;
        if (rep != NULL) {
            if (xmlStrchr(rep, '<'))
                ent->checked |= 1;
            xmlFree(rep);
            rep = NULL;
        }
    }
}