/*
     * Parse the entity reference from the XML parser context.
     * Check if the entity is null and return if it is.
     * Store the entity's checked status for later use.
     * Handle the special case for predefined entities:
     *  - Retrieve the content of the entity.
     *  - Check if the content is null and return if it is.
     *  - Inline the entity content using the SAX character handler if available.
     */
    if (ent == NULL) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNDECLARED_ENTITY,
                         "Entity '%s' not defined\n", ent->name);
        return;
    }

    if (ent->etype == XML_INTERNAL_PREDEFINED_ENTITY ||
        ent->etype == XML_EXTERNAL_PREDEFINED_ENTITY) {
        val = xmlStrdup(ent->content);
        if (val == NULL) {
            xmlParserEntityCheck(ctxt, 0, ent, 0);
            return;
        }
    } else {
        if (ctxt->sax != NULL && ctxt->sax->getEntity != NULL)
            val = ctxt->sax->getEntity(ctxt->userData, ent->name);
        if (val == NULL) {
            xmlFatalErrMsgStr(ctxt, XML_ERR_UNDECLARED_ENTITY,
                             "Entity '%s' not defined\n", ent->name);
            xmlParserEntityCheck(ctxt, 0, ent, 0);
            return;
        }
    }

    if ((ctxt->sax != NULL) && (ctxt->sax->reference != NULL) &&
        (ctxt->replaceEntities == 0) && (!ctxt->disableSAX)) {
        ctxt->sax->reference(ctxt->userData, ent->name);
    }

    if (val != NULL) {
        xmlChar *decoded = xmlStringDecodeEntities(ctxt, val, 0, 0, 0, 0);
        if (decoded != NULL) {
            xmlFree(val);
            val = decoded;
        }
    }