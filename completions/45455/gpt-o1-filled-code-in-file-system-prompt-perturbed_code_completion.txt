ctxt->nbentities++;

    /*
     * Ask for entity resolution.
     */
    ent = xmlParseEntityRef(ctxt);
    if (ent == NULL)
        return;

    entity_checked_status = 1;

    /*
     * [ WFC: Parsed Entity ]
     * An entity reference must not contain the name of an unparsed entity.
     */
    if (ent->etype == XML_EXTERNAL_GENERAL_UNPARSED_ENTITY) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNPARSED_ENTITY,
             "Entity reference to unparsed entity %s\n", ent->name);
    }

    /*
     * [ WFC: No External Entity References ]
     * Attribute values cannot contain direct or indirect
     * references to external entities.
     */
    else if ((ctxt->instate == XML_PARSER_ATTRIBUTE_VALUE) &&
             (ent->etype == XML_EXTERNAL_GENERAL_PARSED_ENTITY)) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_ENTITY_IS_EXTERNAL,
             "Attribute references external entity '%s'\n", ent->name);
    }

    /*
     * Internal check: no parameter entities here.
     */
    else {
        switch (ent->etype) {
            case XML_INTERNAL_PARAMETER_ENTITY:
            case XML_EXTERNAL_PARAMETER_ENTITY:
                xmlFatalErrMsgStr(ctxt, XML_ERR_ENTITY_IS_PARAMETER,
                     "Attempt to reference the parameter entity '%s'\n",
                     ent->name);
                break;
            default:
                break;
        }
    }