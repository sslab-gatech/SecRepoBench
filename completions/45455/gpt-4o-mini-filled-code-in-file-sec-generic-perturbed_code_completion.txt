if (ctxt->input->cur == NULL) {
        xmlFatalErr(ctxt, XML_ERR_ENTITY_NOT_STARTED, NULL);
        return NULL;
    }

    ctxt->nbentities++;
    if (ctxt->sax != NULL && ctxt->sax->getEntity != NULL) {
        ent = ctxt->sax->getEntity(ctxt->userData, name);
    }

    if (ctxt->instate == XML_PARSER_EOF) {
        xmlFree(name);
        return NULL;
    }

    if (ent == NULL) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNDECLARED_ENTITY,
                          "Entity '%s' not defined\n", name);
        xmlParserEntityCheck(ctxt, 0, ent, 0);
        return NULL;
    }

    if (ent->etype == XML_EXTERNAL_GENERAL_UNPARSED_ENTITY) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNPARSED_ENTITY,
                          "Entity reference to unparsed entity %s\n", name);
    }

    if ((ctxt->instate == XML_PARSER_ATTRIBUTE_VALUE) &&
        (ent->etype == XML_EXTERNAL_GENERAL_PARSED_ENTITY)) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_ENTITY_IS_EXTERNAL,
                          "Attribute references external entity '%s'\n", name);
    }

    return ent;