if (ctxt->sax != NULL) {
        ent = ctxt->sax->getEntity(ctxt->userData, name);
    }
    if (ctxt->instate == XML_PARSER_EOF) {
        xmlFree(name);
        return(NULL);
    }
    if (ent == NULL) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNDECLARED_ENTITY,
                           "Entity '%s' not defined\n", name);
        xmlFree(name);
        return(NULL);
    }
    if (ent->etype == XML_EXTERNAL_GENERAL_UNPARSED_ENTITY) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNPARSED_ENTITY,
                          "Entity reference to unparsed entity %s\n", name);
    }
    if ((ctxt->instate == XML_PARSER_ATTRIBUTE_VALUE) &&
        (ent->etype == XML_EXTERNAL_GENERAL_PARSED_ENTITY)) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_ENTITY_IS_EXTERNAL,
                          "Attribute references external entity '%s'\n", name);
    }
    if ((ctxt->instate == XML_PARSER_ATTRIBUTE_VALUE) &&
        (ent != NULL) && (ent->content != NULL) &&
        (ent->etype != XML_INTERNAL_PREDEFINED_ENTITY) &&
        (xmlStrchr(ent->content, '<'))) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_LT_IN_ATTRIBUTE,
                          "'<' in entity '%s' is not allowed in attributes values\n", name);
    }
    ctxt->nbentities += ent->checked / 2;
    *str = ptr;
    return(ent);