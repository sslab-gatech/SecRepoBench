/*
 * Parse the entity reference from the XML parser context.
 */
NEXT;  // Skip the '&' character
const xmlChar *name;
name = xmlParseName(ctxt);
if (name == NULL) {
    xmlFatalErrMsg(ctxt, XML_ERR_NAME_REQUIRED,
                   "xmlParseEntityRef: no name\n");
    return;
}

if (RAW != ';') {
    xmlFatalErr(ctxt, XML_ERR_ENTITYREF_SEMICOL_MISSING, NULL);
    return;
}

NEXT;  // Skip the ';' character

/*
 * Increase the number of entity references parsed
 */
ctxt->nbentities++;

/*
 * Request the entity from SAX or predefined entities
 */
if (ctxt->sax != NULL) {
    if (ctxt->sax->getEntity != NULL)
        ent = ctxt->sax->getEntity(ctxt->userData, name);
    if ((ent == NULL) && (ctxt->options & XML_PARSE_OLDSAX))
        ent = xmlGetPredefinedEntity(name);
    if ((ent == NULL) && (ctxt->userData == ctxt)) {
        ent = xmlSAX2GetEntity(ctxt, name);
    }
}

/*
 * Check if the entity is null and return if it is.
 */
if (ent == NULL) {
    if ((ctxt->standalone == 1) ||
        ((ctxt->hasExternalSubset == 0) &&
         (ctxt->hasPErefs == 0))) {
        xmlFatalErrMsgStr(ctxt, XML_ERR_UNDECLARED_ENTITY,
                         "Entity '%s' not defined\n", name);
    } else {
        xmlErrMsgStr(ctxt, XML_WAR_UNDECLARED_ENTITY,
                      "Entity '%s' not defined\n",
                      name);
    }
    xmlParserEntityCheck(ctxt, 0, NULL, 0);
    return;
}

/*
 * Store the entity's checked status for later use.
 */
entity_checked_status = ent->checked;

/*
 * Handle the special case for predefined entities:
 *  - Retrieve the content of the entity.
 *  - Check if the content is null and return if it is.
 *  - Inline the entity content using the SAX character handler if available.
 */
if ((ctxt->replaceEntities) && 
    (ent->etype == XML_INTERNAL_PREDEFINED_ENTITY)) {
    val = ent->content;
    if (val == NULL) {
        return;
    }
    
    if ((ctxt->sax != NULL) && 
        (ctxt->sax->characters != NULL) && 
        (!ctxt->disableSAX)) {
        ctxt->sax->characters(ctxt->userData, val, xmlStrlen(val));
    }
    return;
}