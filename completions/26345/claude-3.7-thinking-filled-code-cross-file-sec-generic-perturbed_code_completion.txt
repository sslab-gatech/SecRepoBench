if (!p->time_fmt || !p->time_fmt_full) {
    flb_error("[parser] Unable to allocate time format string");
    if (p->time_fmt) flb_free(p->time_fmt);
    if (p->time_fmt_full) flb_free(p->time_fmt_full);
    flb_free(p->name);
    if (p->type == FLB_PARSER_REGEX) {
        flb_regex_destroy(p->regex);
        flb_free(p->p_regex);
    }
    flb_free(p);
    return NULL;
}

/* Check if the format is considering the year */
if (strstr(p->time_fmt, "%Y") || strstr(p->time_fmt, "%y")) {
    p->time_with_year = FLB_TRUE;
}
else if (strstr(p->time_fmt, "%s")) {
    /* epoch seconds */
    p->time_with_year = FLB_TRUE;
    is_epoch = FLB_TRUE;
}
else {
    size_t fmt_len = strlen(p->time_fmt);
    p->time_with_year = FLB_FALSE;
    
    /* Allocate enough space for "%Y " prefix + original format */
    p->time_fmt_year = flb_malloc(fmt_len + 4);
    if (!p->time_fmt_year) {
        flb_errno();
        flb_free(p->time_fmt);
        flb_free(p->time_fmt_full);
        flb_free(p->name);
        if (p->type == FLB_PARSER_REGEX) {
            flb_regex_destroy(p->regex);
            flb_free(p->p_regex);
        }
        flb_free(p);
        return NULL;
    }
    
    /* Prepend "%Y " to the format string */
    snprintf(p->time_fmt_year, fmt_len + 4, "%%Y %s", p->time_fmt);
}

/* Check if the format contains timezone */
if (strstr(p->time_fmt, "%z") || strstr(p->time_fmt, "%Z") || 
    strstr(p->time_fmt, "%SZ") || strstr(p->time_fmt, "%:z")) {
#ifdef FLB_HAVE_TIMEZONE
    p->time_with_tz = FLB_TRUE;
#else
    flb_error("[parser] timezone offset not supported");
    flb_free(p->time_fmt);
    flb_free(p->time_fmt_full);
    flb_free(p->name);
    if (p->time_fmt_year) {
        flb_free(p->time_fmt_year);
    }
    if (p->type == FLB_PARSER_REGEX) {
        flb_regex_destroy(p->regex);
        flb_free(p->p_regex);
    }
    flb_free(p);
    return NULL;
#endif
}
else {
    p->time_with_tz = FLB_FALSE;
}

/* Check if the format has the fractional seconds symbol */
tmp = strstr(p->time_fmt, "%L");
if (tmp) {
    /* Store a reference to the point where fractional seconds starts */
    p->time_frac_secs = FLB_TRUE;
    
    /* Truncate the format string at the %L position */
    *tmp = '\0';
}
else {
    p->time_frac_secs = FLB_FALSE;
}

/* Optional fixed timezone offset */
if (time_offset) {
    diff = 0;
    len = strlen(time_offset);
    if (len <= 0) {
        flb_error("[parser] Invalid time offset %s", time_offset);
        flb_free(p->time_fmt);
        flb_free(p->time_fmt_full);
        flb_free(p->name);
        if (p->time_fmt_year) {
            flb_free(p->time_fmt_year);
        }
        if (p->type == FLB_PARSER_REGEX) {
            flb_regex_destroy(p->regex);
            flb_free(p->p_regex);
        }
        flb_free(p);
        return NULL;
    }

    /* Timezone parser */
    status = 1;
    size_t pos = 0;
    
    if (time_offset[pos] == '+' || time_offset[pos] == '-') {
        if (time_offset[pos] == '-') {
            statu