timeptr = strstr(p->time_fmt, "%Y");
if (!timeptr) {
    timeptr = strstr(p->time_fmt, "%y");
}

if (timeptr) {
    p->time_with_year = FLB_TRUE;
}
else if (strstr(p->time_fmt, "%s")) {
    p->time_with_year = FLB_TRUE;
    is_epoch = FLB_TRUE;
}
else {
    size = strlen(p->time_fmt);
    p->time_with_year = FLB_FALSE;
    p->time_fmt_year = flb_malloc(size + 3);
    if (!p->time_fmt_year) {
        flb_errno();
        flb_free(p->name);
        flb_free(p->p_regex);
        flb_free(p->time_fmt_full);
        flb_free(p->time_fmt);
        flb_free(p);
        return NULL;
    }
    memcpy(p->time_fmt_year, "%Y ", 3);
    memcpy(p->time_fmt_year + 3, p->time_fmt, size);
    p->time_fmt_year[size + 3] = '\0';
}

if (strstr(p->time_fmt, "%z") || strstr(p->time_fmt, "%Z") ||
    strstr(p->time_fmt, "%SZ") || strstr(p->time_fmt, "%:z")) {
#if !defined(FLB_HAVE_GMTOFF) && !defined(FLB_HAVE_TIMEZONE)
    flb_error("[parser] timezone offset not supported");
    flb_free(p->name);
    flb_free(p->p_regex);
    flb_free(p->time_fmt_full);
    flb_free(p->time_fmt);
    flb_free(p->time_fmt_year);
    flb_free(p);
    return NULL;
#else
    p->time_with_tz = FLB_TRUE;
#endif
}

if ((tmp = strstr(p->time_fmt, "%L")) != NULL) {
    tmp[0] = '\0';
    p->time_frac_secs = (tmp + 1);
}

if (time_offset) {
    diff = 0;
    len = strlen(time_offset);
    ret = flb_parser_time_offset_parse(time_offset, len, &diff);
    if (ret == -1) {
        flb_error("[parser] Invalid time offset");
        flb_free(p->name);
        flb_free(p->p_regex);
        flb_free(p->time_fmt_full);
        flb_free(p->time_fmt);
        flb_free(p->time_fmt_year);
        flb_free(p);
        return NULL;
    }
    p->time_offset = diff;
}