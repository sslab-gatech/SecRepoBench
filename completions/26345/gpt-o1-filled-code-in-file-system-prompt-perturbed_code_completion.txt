p->time_with_year = FLB_FALSE;
p->time_with_tz = FLB_FALSE;
p->time_offset = 0;
p->time_frac_secs = NULL;

/* check if the time format includes a year specifier or epoch */
if (strstr(p->time_fmt, "%Y") || strstr(p->time_fmt, "%y") || strstr(p->time_fmt, "%s")) {
    p->time_with_year = FLB_TRUE;
}

/* detect epoch format */
if (strstr(p->time_fmt, "%s")) {
    is_epoch = FLB_TRUE;
}

/* if no year specifier and not epoch, prepend %Y to the format */
if (!p->time_with_year) {
    size = strlen(p->time_fmt) + 4; /* 4 = 3 chars for "%Y " + null term */
    p->time_fmt_year = flb_malloc(size);
    if (!p->time_fmt_year) {
        flb_errno();
        flb_interim_parser_destroy(p);
        return NULL;
    }
    snprintf(p->time_fmt_year, size, "%%Y %s", p->time_fmt);
}
else {
    p->time_fmt_year = flb_strdup(p->time_fmt);
    if (!p->time_fmt_year) {
        flb_errno();
        flb_interim_parser_destroy(p);
        return NULL;
    }
}

/* check for timezone specifiers */
#ifdef FLB_HAVE_GMTOFF
if (strstr(p->time_fmt, "%z") || strstr(p->time_fmt, "%Z")) {
    p->time_with_tz = FLB_TRUE;
}
#else
if (strstr(p->time_fmt, "%z") || strstr(p->time_fmt, "%Z")) {
    flb_error("[parser:%s] time format contains '%%z'/'%%Z' but was built without zone support", name);
    flb_interim_parser_destroy(p);
    return NULL;
}
#endif

/* check for fractional seconds (%L) */
{
    char *fs = strstr(p->time_fmt, "%L");
    if (fs) {
        *fs = '\0';         /* truncate format string at %L */
        fs += 2;            /* skip %L */
        if (*fs != '\0') {
            p->time_frac_secs = flb_strdup(fs);
            if (!p->time_frac_secs) {
                flb_errno();
                flb_interim_parser_destroy(p);
                return NULL;
            }
        }
    }
}

/* optional fixed time_offset */
if (time_offset) {
    ret = flb_parser_tzone_offset(time_offset, strlen(time_offset), &diff);
    if (ret < 0) {
        flb_error("[parser:%s] invalid time_offset '%s'", name, time_offset);
        flb_interim_parser_destroy(p);
        return NULL;
    }
    p->time_offset = diff;
}