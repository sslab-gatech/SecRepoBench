{
    int has_year = FLB_FALSE;
    char *ptr;

    /* Check for year specifiers: if found, mark that the format includes a year */
    if (strstr(time_fmt, "%Y") || strstr(time_fmt, "%y")) {
        has_year = FLB_TRUE;
    }

    /* If the format contains '%s', consider it an epoch format and mark it as having a year */
    if (strstr(time_fmt, "%s")) {
        is_epoch = FLB_TRUE;
        has_year = FLB_TRUE;
    }

    /* If no year specifier is found, prepend "%Y" to the time format */
    if (!has_year) {
        size = strlen(time_fmt) + 3; /* 3 extra bytes for "%Y" */
        p->time_fmt_year = flb_malloc(size + 1);
        if (!p->time_fmt_year) {
            flb_error("[parser:%s] memory allocation error for time_fmt_year", name);
            flb_free(p->time_fmt);
            flb_free(p->time_fmt_full);
            flb_free(p);
            return NULL;
        }
        snprintf(p->time_fmt_year, size + 1, "%%Y%s", time_fmt);
    }
    else {
        p->time_fmt_year = flb_strdup(time_fmt);
    }

    /* If a fixed timezone offset is provided, ensure the time format includes a timezone specifier */
    if (time_offset) {
        if (!(strstr(time_fmt, "%z") || strstr(time_fmt, "%Z"))) {
            flb_error("[parser:%s] timezone offset provided but time_fmt lacks timezone specifier", name);
            flb_free(p->time_fmt);
            flb_free(p->time_fmt_full);
            flb_free(p->time_fmt_year);
            flb_free(p);
            return NULL;
        }
        p->time_offset = flb_strdup(time_offset);
        if (!p->time_offset) {
            flb_error("[parser:%s] memory allocation error for time_offset", name);
            flb_free(p->time_fmt);
            flb_free(p->time_fmt_full);
            flb_free(p->time_fmt_year);
            flb_free(p);
            return NULL;
        }
    }

    /* Check for a fractional seconds specifier ("%L") */
    ptr = strstr(time_fmt, "%L");
    if (ptr) {
        /* Store the fractional seconds format */
        p->time_frac = flb_strdup(ptr);
        if (!p->time_frac) {
            flb_error("[parser:%s] memory allocation error for time_frac", name);
            flb_free(p->time_fmt);
            flb_free(p->time_fmt_full);
            flb_free(p->time_fmt_year);
            if (p->time_offset) {
                flb_free(p->time_offset);
            }
            flb_free(p);
            return NULL;
        }
        /* Truncate time_fmt to remove the fractional seconds part */
        len = ptr - time_fmt;
        char *truncated = flb_malloc(len + 1);
        if (!truncated) {
            flb_error("[parser:%s] memory allocation error while truncating time_fmt", name);
            flb_free(p->time_fmt);
            flb_free(p->time_fmt_full);
            flb_free(p->time_fmt_year);
            if (p->time_offset) {
                flb_free(p->time_offset);
            }
            flb_free(p->time_frac);
            flb_free(p);
            return NULL;
        }
        memcpy(truncated, time_fmt, len);
        truncated[len] = '\0';
        flb_free(p->time_fmt);
        p->time_fmt = truncated;

        /* Also update time_fmt_year accordingly */
        char *truncated_year;
        if (!has_year) {
            /* When no year was originally present, we need to account for the prepended "%Y" */
            truncated_year = flb_malloc(len + 3 + 1);
            if (!truncated_year) {
                flb_error("[parser:%s] memory allocation error while truncating time_fmt_year", name);
                flb_free(p->time_fmt_full);
                flb_free(p->time_fmt_year);
                if (p->time_offset) {
                    flb_free(p->time_offset);
                }
                flb_free(p->time_frac);
                flb_free(p);
                return NULL;
            }
            snprintf(truncated_year, len + 4, "%%Y%.*s", (int)len, time_fmt);
        }
        else {
            truncated_year = flb_malloc(len + 1);
            if (!truncated_year) {
                flb_error("[parser:%s] memory allocation error while truncating time_fmt_year", name);
                flb_free(p->time_fmt_full);
                flb_free(p->time_fmt_year);
                if (p->time_offset) {
                    flb_free(p->time_offset);
                }
                flb_free(p->time_frac);
                flb_free(p);
                return NULL;
            }
            snprintf(truncated_year, len + 1, "%.*s", (int)len, time_fmt);
        }
        flb_free(p->time_fmt_year);
        p->time_fmt_year = truncated_year;
    }
}