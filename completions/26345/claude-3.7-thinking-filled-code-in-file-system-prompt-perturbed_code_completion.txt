/* Check if the format includes a year */
p->time_with_year = FLB_FALSE;
tmp = strstr(time_fmt, "%Y");
if (tmp) {
    p->time_with_year = FLB_TRUE;
}
else {
    tmp = strstr(time_fmt, "%y");
    if (tmp) {
        p->time_with_year = FLB_TRUE;
    }
}

/* Check if it's an epoch format */
if (strcmp(time_fmt, "%s") == 0) {
    /* The format is epoch seconds */
    p->time_with_year = FLB_TRUE;
    is_epoch = FLB_TRUE;
}

/* If no year is specified, append it */
if (p->time_with_year == FLB_FALSE) {
    p->time_fmt_year = flb_malloc(strlen(time_fmt) + 5);
    if (!p->time_fmt_year) {
        flb_errno();
        flb_interim_parser_destroy(p);
        return NULL;
    }
    strcpy(p->time_fmt_year, "%Y ");
    strcat(p->time_fmt_year, time_fmt);
}

/* Check if the format has timezone support */
p->time_with_tz = FLB_FALSE;
tmp = strstr(time_fmt, "%z");
if (tmp) {
    p->time_with_tz = FLB_TRUE;
}
else {
    tmp = strstr(time_fmt, "%Z");
    if (tmp) {
        p->time_with_tz = FLB_TRUE;
    }
}

/* Optional fixed timezone offset */
p->time_offset = 0;
if (time_offset) {
    diff = 0;
    len = strlen(time_offset);
    status = flb_parser_tzone_offset(time_offset, len, &diff);
    if (status == -1) {
        flb_error("[parser:%s] Invalid time offset %s", name, time_offset);
        flb_interim_parser_destroy(p);
        return NULL;
    }
    p->time_offset = diff;
}

#ifndef FLB_HAVE_GMTOFF
if (p->time_with_tz) {
    flb_error("[parser:%s] The timezone in the format string is not supported (%s)",
              name, time_fmt);
    flb_interim_parser_destroy(p);
    return NULL;
}
#endif

/* Check for fractional seconds */
tmp = strstr(time_fmt, "%L");
if (tmp) {
    /* Fractional seconds found, create a new time format */
    p->time_frac_secs = tmp + 2;
    
    /* Calculate length for truncated time format */
    diff = tmp - time_fmt;
    size = diff + 1;
    
    /* Free the original time_fmt since we'll allocate a new one */
    flb_free(p->time_fmt);
    
    /* Create the truncated time format (without %L) */
    p->time_fmt = flb_malloc(size);
    if (!p->time_fmt) {
        flb_errno();
        flb_interim_parser_destroy(p);
        return NULL;
    }
    
    /* Copy the truncated time format */
    strncpy(p->time_fmt, time_fmt, diff);
    p->time_fmt[diff] = '\0';
    
    /* For the format with year, we need to truncate it too */
    if (p->time_with_year == FLB_FALSE) {
        size = strlen(p->time_fmt_year);
        timeptr = strstr(p->time_fmt_year, "%L");
        if (timeptr) {
            diff = timeptr - p->time_fmt_year;
            p->time_fmt_year[diff] = '\0';
        }
    }
}
else {
    p->time_frac_secs = NULL;
}