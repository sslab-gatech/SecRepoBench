static MagickBooleanType WritePSImage(const ImageInfo *image_info, Image *image, ExceptionInfo *exception)
{
  // ... (previous code)

  // Fill in the masked region
  if (image->mask != (Image *) NULL)
  {
    const Quantum *mask_pixels;
    ssize_t y;

    for (y = 0; y < (ssize_t) image->rows; y++)
    {
      mask_pixels = GetVirtualPixels(image->mask, 0, y, image->columns, 1, exception);
      if (mask_pixels == (const Quantum *) NULL)
        break;

      for (x = 0; x < (ssize_t) image->columns; x++)
      {
        if (GetPixelIntensity(image->mask, mask_pixels) != 0)
        {
          // Skip transparent pixels
          p += GetPixelChannels(image);
          continue;
        }

        // Write the pixel data for masked pixels
        if (image->storage_class == DirectClass)
        {
          // ... (write DirectClass pixel data)
        }
        else
        {
          // ... (write PseudoClass pixel data)
        }
      }

      if (image->previous == (Image *) NULL)
      {
        status = SetImageProgress(image, SaveImageTag, (MagickOffsetType) y, image->rows);
        if (status == MagickFalse)
          break;
      }
    }
  }

  // ... (remaining code)
}