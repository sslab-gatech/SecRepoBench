MagickBooleanType
    status;

  MemoryInfo
    *memory_info;

  PointInfo
    point;

  RectangleInfo
    page;

  register ssize_t
    i;

  size_t
    length;

  ssize_t
    columns = 0,
    count,
    p,
    q,
    rows = 0,
    scene;

  unsigned char
    *hex_lookup;

  /*
    Allocate image structure.
  */
  assert(image_info != (ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  assert(exception != (ExceptionInfo *) NULL);
  if (image_info->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  image=AcquireImage(image_info,exception);
  if (image == (Image *) NULL)
    return((Image *) NULL);
  image->alpha_trait=OpaqueAlpha;
  status=OpenBlob(image_info,image,ReadBinaryBlobMode,exception);
  if (status == MagickFalse)
    {
      image=DestroyImage(image);
      return((Image *) NULL);
    }
  (void) CopyMagickString(input_filename,image->filename,MagickPathExtent);
  filedescriptor=fileno(GetBlobFile(image));
  if (filedescriptor == -1)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),FileOpenError,
        "UnableToOpenFile",image->filename);
      image=DestroyImage(image);
      return((Image *) NULL);
    }
  (void) strlcpy(filename,image->filename,MagickPathExtent);
  length=strlen(filename);
  if ((length > 4) && (LocaleCompare(filename+length-3,".ps") == 0))
    (void) CopyMagickString(filename+length-3,".eps",4);
  if ((length > 4) && (LocaleCompare(filename+length-3,".ai") == 0))
    (void) CopyMagickString(filename+length-3,".eps",4);
  if ((length > 4) && (LocaleCompare(filename+length-3,".pdf") == 0))
    (void) CopyMagickString(filename+length-3,".eps",4);
  if (image_info->density.x == 0.0)
    image_info->density.x=DefaultResolution;
  if (image_info->density.y == 0.0)
    image_info->density.y=DefaultResolution;
  density=AcquireString("");
  (void) FormatLocaleString(density,MagickPathExtent,"-density %.0fx%.0f",
    image_info->density.x,image_info->density.y);
  /*
    Determine page geometry from Postscript bounding box.
  */
  page.x=0;
  page.y=0;
  page.width=0;
  page.height=0;
  point.x=0.0;
  point.y=0.0;
  scene=0;
  columns=0;
  rows=0;
  (void) ResetMagickMemory(command,0,sizeof(command));
  /*
    Create Ghostscript control file.
  */
  (void) CopyMagickString(postscript_filename,image->filename,
    MagickPathExtent);
  (void) ConcatenateMagickString(postscript_filename,".eps",MagickPathExtent);
  delegate_info=GetDelegateInfo(image_info,"eps",exception);
  if (delegate_info == (const DelegateInfo *) NULL)
    delegate_info=GetDelegateInfo(image_info,"ps",exception);
  if (delegate_info == (const DelegateInfo *) NULL)
    {
      ThrowDelegateException(exception,MissingDelegateError,
        "NoPostscriptDecoder","`%s' is not a valid Postscript file",
        image->filename);
      image=DestroyImage(image);
      return((Image *) NULL);
    }
  options=AcquireString("");
  option=GetImageOption(image_info,"postscript:options");
  if (option != (const char *) NULL)
    options=ConcatenateString(options,option);
  if (image_info->number_scenes != 1)
    {
      char
        pages[MagickPathExtent];

      (void) FormatLocaleString(pages,MagickPathExtent,"-dFirstPage=%ld",
        (long) image_info->scene+1);
      options=ConcatenateString(options," ");
      options=ConcatenateString(options,pages);
      (void) FormatLocaleString(pages,MagickPathExtent,"-dLastPage=%ld",
        (long) (image_info->scene+image_info->number_scenes));
      options=ConcatenateString(options," ");
      options=ConcatenateString(options,pages);
    }
  (void) FormatLocaleString(command,MagickPathExtent,
    "\"%s\" -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 %s %s -sstdout=%%stdout -sstderr=%%stderr \"%s\" -c quit",
    delegate_info->command,density,options,filename);
  options=DestroyString(options);
  density=DestroyString(density);
  (void) CopyMagickString(image_info->filename,filename,MagickPathExtent);
  (void) CopyMagickString(image->filename,input_filename,MagickPathExtent);
  (void) CopyMagickString(image_info->filename,input_filename,
    MagickPathExtent);
  (void) SetImageOption(image_info,"filename",input_filename);
  (void) CopyMagickString(image->filename,input_filename,MagickPathExtent);
  (void) CopyMagickString(image_info->filename,input_filename,
    MagickPathExtent);
  (void) SetImageOption(image_info,"filename",input_filename);
  (void) LogMagickEvent(DelegateEvent,GetMagickModule(),"%s",command);
  read_info=CloneImageInfo(image_info);
  postscript_image=NewImageList();
  ResetImagePropertyIterator(image);
  (void) SetImageProperty(image,"label",image->filename,exception);
  status=InvokeDelegate(read_info,command,image,exception);
  if (status == MagickFalse)
    {
      image=DestroyImage(image);
      read_info=DestroyImageInfo(read_info);
      return(DestroyImageList(postscript_image));
    }
  (void) CopyMagickString(image_info->filename,filename,MagickPathExtent);
  (void) CopyMagickString(image->filename,input_filename,MagickPathExtent);
  (void) CopyMagickString(image_info->filename,input_filename,
    MagickPathExtent);
  (void) SetImageOption(image_info,"filename",input_filename);
  (void) CopyMagickString(image->filename,input_filename,MagickPathExtent);
  (void) CopyMagickString(image_info->filename,input_filename,
    MagickPathExtent);
  (void) SetImageOption(image_info,"filename",input_filename);
  (void) CloseBlob(image);
  (void) RemoveImageProperty(image,"label");
  (void) strlcpy(filename,image->filename,MagickPathExtent);
  (void) strlcpy(image_info->filename,image->filename,MagickPathExtent);
  (void) SetImageOption(image_info,"filename",image->filename);
  (void) strlcpy(read_info->filename,image->filename,MagickPathExtent);
  (void) SetImageOption(read_info,"filename",image->filename);
  (void) strlcpy(image->magick,image_info->magick,MagickPathExtent);
  (void) strlcpy(read_info->magick,image_info->magick,MagickPathExtent);
  (void) SetImageInfo(read_info,0,exception);
  (void) strlcpy(read_info->filename,image->filename,MagickPathExtent);
  (void) SetImageOption(read_info,"filename",image->filename);
  (void) strlcpy(image->filename,filename,MagickPathExtent);
  (void) SetImageOption(image,"filename",filename);
  (void) strlcpy(image_info->filename,filename,MagickPathExtent);
  (void) SetImageOption(image_info,"filename",filename);
  (void) strlcpy(read_info->filename,filename,MagickPathExtent);
  (void) SetImageOption(read_info,"filename",filename);
  (void) strlcpy(image->magick,image_info->magick,MagickPathExtent);
  (void) strlcpy(read_info->magick,image_info->magick,MagickPathExtent);
  (void) SetImageInfo(read_info,0,exception);
  (void) strlcpy(read_info->filename,filename,MagickPathExtent);
  (void) SetImageOption(read_info,"filename",filename);
  postscript_image=ReadImages(read_info,filename,exception);
  read_info=DestroyImageInfo(read_info);
  if (postscript_image == (Image *) NULL)
    {
      image=DestroyImage(image);
      return((Image *) NULL);
    }
  if (image->profile != (void *) NULL)
    {
      Image
        *next;

      /*
        Transfer ICC profile from original image.
      */
      next=GetFirstImageInList(postscript_image);
      do
      {
        (void) CloneImageProfiles(next,image);
        next=SyncNextImageInList(next);
      } while (next != (Image *) NULL);
    }
  if ((image->colorspace == CMYKColorspace) &&
      (image->rendering_intent == PerceptualIntent))
    {
      Image
        *next;

      /*
        Ghostscript renders CMYK as sRGB, so force the colorspace back to CMYK.
      */
      next=GetFirstImageInList(postscript_image);
      do
      {
        next->colorspace=CMYKColorspace;
        next->rendering_intent=PerceptualIntent;
        next=SyncNextImageInList(next);
      } while (next != (Image *) NULL);
    }
  if (image->alpha_trait != OpaqueAlpha)
    {
      Image
        *next;

      /*
        Ghostscript ignores the alpha channel, so force it back.
      */
      next=GetFirstImageInList(postscript_image);
      do
      {
        next->alpha_trait=image->alpha_trait;
        next=SyncNextImageInList(next);
      } while (next != (Image *) NULL);
    }
  (void) CopyMagickString(filename,image->filename,MagickPathExtent);
  (void) CopyMagickString(image_info->filename,image->filename,
    MagickPathExtent);
  (void) SetImageOption(image_info,"filename",image->filename);
  (void) CopyMagickString(image->filename,filename,MagickPathExtent);
  (void) CopyMagickString(image_info->filename,image->filename,
    MagickPathExtent);
  (void) SetImageOption(image_info,"filename",image->filename);
  (void) strlcpy(image->magick,image_info->magick,MagickPathExtent);
  (void) SetImageOption(image,"filename",filename);
  (void) strlcpy(image_info->magick,image->magick,MagickPathExtent);
  (void) SetImageOption(image_info,"filename",filename);
  (void) strlcpy(image->magick,image_info->magick,MagickPathExtent);
  (void) SetImageOption(image,"filename",filename);
  (void) strlcpy(image_info->magick,image->magick,MagickPathExtent);
  (void) SetImageOption(image_info,"filename",filename);
  image=DestroyImage(image);
  image=GetFirstImageInList(postscript_image);
  page.x=0;
  page.y=0;
  page.width=0;
  page.height=0;
  point.x=0.0;
  point.y=0.0;
  scene=0;
  columns=0;
  rows=0;