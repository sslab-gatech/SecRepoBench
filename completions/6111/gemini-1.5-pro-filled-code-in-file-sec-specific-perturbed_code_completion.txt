MagickBooleanType
  skip;

  MagickSizeType
    length;

  register ssize_t
    i;

  short int
    hex_digits[256];

  ssize_t
    count,
    offset;

  size_t
    columns,
    rows;

  /*
    Open image file.
  */
  assert(image_info != (const ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  image=AcquireImage(image_info,exception);
  status=OpenBlob(image_info,image,ReadBinaryBlobMode,exception);
  if (status == MagickFalse)
    {
      image=DestroyImageList(image);
      return((Image *) NULL);
    }
  /*
    Initialize hex values.
  */
  for (i=0; i < 256; i++)
    hex_digits[i]=(-1);
  for (i=0; i < 10; i++)
    hex_digits['0'+i]=i;
  for (i=0; i < 6; i++)
    {
      hex_digits['a'+i]=10+i;
      hex_digits['A'+i]=10+i;
    }
  /*
    Set the page density.
  */
  delta.x=DefaultResolution;
  delta.y=DefaultResolution;
  if ((image->resolution.x == 0.0) || (image->resolution.y == 0.0))
    {
      flags=ParseGeometry(PSDensityGeometry,&geometry_info);
      image->resolution.x=geometry_info.rho;
      image->resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        image->resolution.y=image->resolution.x;
    }
  if (image_info->density != (char *) NULL)
    {
      flags=ParseGeometry(image_info->density,&geometry_info);
      image->resolution.x=geometry_info.rho;
      image->resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        image->resolution.y=image->resolution.x;
    }
  if (image->units == PixelsPerCentimeterResolution)
    {
      image->resolution.x=(double) ((size_t) (100.0*2.54*
        image->resolution.x+0.5)/100.0);
      image->resolution.y=(double) ((size_t) (100.0*2.54*
        image->resolution.y+0.5)/100.0);
    }
  /*
    Search for Postscript commands.
  */
  skip=MagickFalse;
  columns=0;
  rows=0;
  (void) ResetMagickMemory(command,0,MagickPathExtent);
  (void) ResetMagickMemory(geometry,0,MagickPathExtent);
  (void) ResetMagickMemory(&page,0,sizeof(page));
  for (i=1; ; i++)
  {
    /*
      Read a line from the input file.
    */
    (void) ResetMagickMemory(buffer,0,MagickPathExtent);
    count=ReadBlobString(image,buffer);
    if (count <= 0)
      break;
    if (skip == MagickFalse)
      {
        char
          *p;

        /*
          Interpret Postscript directive.
        */
        p=buffer;
        if (LocaleNCompare(p,"%%BeginDocument:",15) == 0)
          (void) CopyMagickString(command,p+15,MagickPathExtent);
        else
          if (LocaleNCompare(p,"%%EndDocument:",13) == 0)
            (void) CopyMagickString(command,p+13,MagickPathExtent);
          else
            if (LocaleNCompare(p,"%%BoundingBox:",13) == 0)
              (void) CopyMagickString(geometry,p+13,MagickPathExtent);
            else
              if (LocaleNCompare(p,"%%HiResBoundingBox:",18) == 0)
                (void) CopyMagickString(geometry,p+18,MagickPathExtent);
              else
                if (LocaleNCompare(p,"%%PageBoundingBox:",17) == 0)
                  (void) CopyMagickString(geometry,p+17,MagickPathExtent);
                else
                  if (LocaleNCompare(p,"%%LanguageLevel:",15) == 0)
                    {
                      size_t
                        level;

                      level=(size_t) StringToLong(p+15);
                      if (level > 1)
                        (void) ThrowMagickException(exception,GetMagickModule(),
                          CoderError,"DataEncodingSchemeIsNotSupported",
                          image->filename);
                    }
                  else
                    if (LocaleNCompare(p,"%%Pages:",8) == 0)
                      (void) CopyMagickString(geometry,p+8,MagickPathExtent);
                    else
                      if (LocaleNCompare(p,"%%Page:",7) == 0)
                        page=(size_t) StringToLong(p+7);
                      else
                        if (LocaleNCompare(p,"%%BeginData:",11) == 0)
                          skip=MagickTrue;
                        else
                          if (LocaleNCompare(p,"%%BeginICCProfile:",17) == 0)
                            skip=MagickTrue;
                          else
                            if (LocaleNCompare(p,"%%BeginPhotoshop:",16) == 0)
                              skip=MagickTrue;
                            else
                              if (LocaleNCompare(p,"%%BeginXMPPacket:",16) == 0)
                                skip=MagickTrue;
                              else
                                if (LocaleNCompare(p,"%%EndXMPPacket:",14) == 0)
                                  skip=MagickTrue;
                                else
                                  if (LocaleNCompare(p,"%%CMYKCustomColor:",17) == 0)
                                    skip=MagickTrue;
                                  else
                                    if (LocaleNCompare(p,"%%CMYKProcessColor:",18) == 0)
                                      skip=MagickTrue;
                                    else
                                      if (LocaleNCompare(p,"%%DocumentMedia:",15) == 0)
                                        skip=MagickTrue;
                                      else
                                        if (LocaleNCompare(p,
                                            "%%DocumentCustomColors:",22) == 0)
                                          skip=MagickTrue;
                                        else
                                          if (LocaleNCompare(p,
                                              "%%DocumentProcessColors:",23) == 0)
                                            skip=MagickTrue;
                                          else
                                            if (LocaleNCompare(p,"%%ImageData:",11) == 0)
                                              skip=MagickTrue;
        continue;
      }
    if (LocaleNCompare(buffer,"%EndData:",9) == 0)
      break;
    if (LocaleNCompare(buffer,"%EndICCProfile:",15) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%EndPhotoshop:",14) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%EndXMPPacket:",14) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%%CMYKCustomColor:",17) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%%CMYKProcessColor:",18) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%%DocumentMedia:",15) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%%DocumentCustomColors:",22) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%%DocumentProcessColors:",23) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (LocaleNCompare(buffer,"%%ImageData:",11) == 0)
      {
        skip=MagickFalse;
        continue;
      }
    if (image->profiles != (void *) NULL)
      continue;
    /*
      Allocate image structure.
    */
    (void) ResetMagickMemory(input_filename,0,MagickPathExtent);
    (void) CopyMagickString(input_filename,image->filename,MagickPathExtent);
    if (*geometry == '\0')
      {
        (void) ThrowMagickException(exception,GetMagickModule(),CoderError,
          "MustSpecifyImageSize","`%s'",image->filename);
        image=DestroyImageList(image);
        return((Image *) NULL);
      }
    /*
      Parse geometry.
    */
    (void) ParseGeometry(geometry,&geometry_info);
    image->columns=(size_t) geometry_info.rho;
    image->rows=(size_t) geometry_info.sigma;
    if ((geometry_info.width != 0) || (geometry_info.height != 0))
      {
        image->page.width=(size_t) geometry_info.width;
        image->page.height=(size_t) geometry_info.height;
      }
    if ((geometry_info.x != 0) || (geometry_info.y != 0))
      {
        image->page.x=(ssize_t) geometry_info.x;
        image->page.y=(ssize_t) geometry_info.y;
      }
    columns=image->columns;
    rows=image->rows;
    (void) SetImageBackgroundColor(image,exception);
    /*
      Create Ghostscript control file.
    */
    filedescriptor=AcquireUniqueFileResource(postscript_filename);
    if (filedescriptor < 0)
      {
        (void) ThrowMagickException(exception,GetMagickModule(),FileOpenError,
          "UnableToCreateTemporaryFile","%s",postscript_filename);
        image=DestroyImageList(image);
        return((Image *) NULL);
      }
    (void) FormatLocaleFile(filedescriptor,"%.20g %.20g translate\n%g %g scale\n",
      (double) image->page.x,(double) image->page.y,1.0,1.0);
    if (image_info->page != (char *) NULL)
      {
        char
          *canonical_page,
          page[MagickPathExtent];

        canonical_page=GetPageGeometry(image_info->page);
        (void) ParseGeometry(canonical_page,&geometry_info);
        geometry_info.rho+=image->page.x;
        geometry_info.sigma+=image->page.y;
        (void) FormatLocaleString(page,MagickPathExtent,"%+lg%+lg",
          (double) geometry_info.rho,(double) geometry_info.sigma);
        canonical_page=DestroyString(canonical_page);
        (void) FormatLocaleFile(filedescriptor,"%.20g %.20g translate\n",
          (double) geometry_info.x,(double) geometry_info.y);
      }
    (void) FormatLocaleFile(filedescriptor,"/Times-Roman findfont %g scalefont setfont\n",
      image_info->pointsize == 0.0 ? 12.0 : image_info->pointsize);
    (void) FormatLocaleFile(filedescriptor,
      "0 0 moveto (\\n) show 0 -12 moveto (  ) show\n");
    (void) CloseBlob(image);
    (void) RelinquishUniqueFileResource(postscript_filename);
    /*
      Render Postscript with Ghostscript.
    */
    (void) ResetMagickMemory(command,0,MagickPathExtent);
    delegate_info=GetPostscriptDelegateInfo(exception);
    if (delegate_info != (const DelegateInfo *) NULL)
      {
        if (IsPostscriptRendered(input_filename) != MagickFalse)
          {
            (void) CopyMagickString(command,input_filename,MagickPathExtent);
            status=MagickTrue;
          }
        else
          {
            (void) FormatLocaleString(command,MagickPathExtent,
              GetDelegateCommands(delegate_info),input_filename,
              postscript_filename);
            status=InvokePostscriptDelegate(image_info->verbose,command,
              message,exception);
          }
        (void) DeleteFile(postscript_filename);
        if (status == MagickFalse)
          {