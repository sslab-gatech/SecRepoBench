// Initialize necessary variables and structures for processing Postscript images.
// Open the input image file and create a symbolic link to it for processing.
// Initialize an array to map hex characters to their integer values.
// Set the page density for the image based on the provided resolution or default values.
// Determine the page geometry using the Postscript bounding box comments.
// Initialize various variables including color space, resolution, and page dimensions.
// Create a control file for Ghostscript to render the Postscript image.
// Use the Ghostscript delegate to render the Postscript into a raster format.
// Read the rendered images and append them to the image list, handling profiles if necessary.
// Clean up and return the processed image list, handling any errors that occur.

// Initialize necessary variables and structures for processing Postscript images.
image=AcquireImage(image_info,exception);
status=OpenBlob(image_info,image,ReadBinaryBlobMode,exception);
if (status == MagickFalse)
{
  image=DestroyImageList(image);
  return((Image *) NULL);
}
status=AcquireUniqueSymbolicLink(image_info->filename,input_filename);
if (status == MagickFalse)
{
  ThrowFileException(exception,FileOpenError,"UnableToCreateTemporaryFile",
    image_info->filename);
  image=DestroyImageList(image);
  return((Image *) NULL);
}

// Set the page density for the image based on the provided resolution or default values.
delta.x=DefaultResolution;
delta.y=DefaultResolution;
if ((image->resolution.x == 0.0) || (image->resolution.y == 0.0))
{
  GeometryInfo
    geometry_info;

  MagickStatusType
    flags;

  flags=ParseGeometry(PSDensityGeometry,&geometry_info);
  image->resolution.x=geometry_info.rho;
  image->resolution.y=geometry_info.sigma;
  if ((flags & SigmaValue) == 0)
    image->resolution.y=image->resolution.x;
}

// Determine the page geometry using the Postscript bounding box comments.
cmyk=image->colorspace == CMYKColorspace? MagickTrue : MagickFalse;
count=0;
(void) ResetMagickMemory(&bounding_box,0,sizeof(bounding_box));
(void) ResetMagickMemory(&bounds,0,sizeof(bounds));
(void) ResetMagickMemory(&page,0,sizeof(page));
(void) ResetMagickMemory(command,0,sizeof(command));
p=command;
for (c=ReadBlobByte(image); c!= EOF; c=ReadBlobByte(image))
{
  if (image_info->page!= (char *) NULL)
    continue;
  // Note XPS elements.
  *p++=(char) c;
  if ((c!= (int) '/') && (c!= '\n') &&
      ((size_t) (p-command) < (MagickPathExtent-1)))
    continue;
  *p='\0';
  p=command;
  // Is this a CMYK document?
  if (LocaleNCompare(DeviceCMYK,command,strlen(DeviceCMYK)) == 0)
    cmyk=MagickTrue;
  if (LocaleNCompare(CropBox,command,strlen(CropBox)) == 0)
  {
    // Note region defined by crop box.
    count=(ssize_t) sscanf(command,"CropBox [%lf %lf %lf %lf",
      &bounds.x1,&bounds.y1,&bounds.x2,&bounds.y2);
    if (count!= 4)
      count=(ssize_t) sscanf(command,"CropBox[%lf %lf %lf %lf",
        &bounds.x1,&bounds.y1,&bounds.x2,&bounds.y2);
  }
  if (LocaleNCompare(MediaBox,command,strlen(MediaBox)) == 0)
  {
    // Note region defined by media box.
    count=(ssize_t) sscanf(command,"MediaBox [%lf %lf %lf %lf",
      &bounds.x1,&bounds.y1,&bounds.x2,&bounds.y2);
    if (count!= 4)
      count=(ssize_t) sscanf(command,"MediaBox[%lf %lf %lf %lf",
        &bounds.x1,&bounds.y1,&bounds.x2,&bounds.y2);
  }
  if (count!= 4)
    continue;
  // Set XPS render geometry.
  width=(size_t) (floor(bounds.x2+0.5)-ceil(bounds.x1-0.5));
  height=(size_t) (floor(bounds.y2+0.5)-ceil(bounds.y1-0.5));
  if (width > page.width)
    page.width=width;
  if (height > page.height)
    page.height=height;
}
(void) CloseBlob(image);

// Create a control file for Ghostscript to render the Postscript image.
if ((page.width == 0) || (page.height == 0))
  (void) ParseAbsoluteGeometry(PSPageGeometry,&page);
if (image_info->page!= (char *) NULL)
  (void) ParseAbsoluteGeometry(image_info->page,&page);
(void) FormatLocaleString(geometry,MagickPathExtent,"%.20gx%.20g",(double)
  page.width,(double) page.height);
if (image_info->monochrome!= MagickFalse)
  delegate_info=GetDelegateInfo("ps:mono",(char *) NULL,exception);
else
  if (cmyk!= MagickFalse)
    delegate_info=GetDelegateInfo("ps:cmyk",(char *) NULL,exception);
  else
    delegate_info=GetDelegateInfo("ps:color",(char *) NULL,exception);
if (delegate_info == (const DelegateInfo *) NULL)
{
  image=DestroyImage(image);
  return((Image *) NULL);
}
density=AcquireString("");
options=AcquireString("");
(void) FormatLocaleString(density,MagickPathExtent,"%gx%g",
  image->resolution.x,image->resolution.y);
if ((page.width == 0) || (page.height == 0))
  (void) ParseAbsoluteGeometry(PSPageGeometry,&page);
if (image_info->page!= (char *) NULL)
  (void) ParseAbsoluteGeometry(image_info->page,&page);
page.width=(size_t) floor(page.width*image->resolution.y/delta.x+0.5);
page.height=(size_t) floor(page.height*image->resolution.y/delta.y+0.5);
(void) FormatLocaleString(options,MagickPathExtent,"-g%.20gx%.20g ",(double)
  page.width,(double) page.height);
image=DestroyImage(image);
read_info=CloneImageInfo(image_info);
*read_info->magick='\0';
if (read_info->number_scenes!= 0)
{
  if (read_info->number_scenes!= 1)
    (void) FormatLocaleString(options,MagickPathExtent,"-dLastPage=%.20g",
      (double) (read_info->scene+read_info->number_scenes));
  else
    (void) FormatLocaleString(options,MagickPathExtent,
      "-dFirstPage=%.20g -dLastPage=%.20g",(double) read_info->scene+1,
      (double) (read_info->scene+read_info->number_scenes));
  read_info->number_scenes=0;
  if (read_info->scenes!= (char *) NULL)
    *read_info->scenes='\0';
}
(void) CopyMagickString(filename,read_info->filename,MagickPathExtent);
(void) AcquireUniqueFilename(read_info->filename);
(void) FormatLocaleString(command,MagickPathExtent,
  GetDelegateCommands(delegate_info),
  read_info->antialias!= MagickFalse? 4 : 1,
  read_info->antialias!= MagickFalse? 4 : 1,density,options,
  read_info->filename,input_filename);
options=DestroyString(options);
density=DestroyString(density);
status=ExternalDelegateCommand(MagickFalse,read_info->verbose,command,
  (char *) NULL,exception)!= 0? MagickTrue : MagickFalse;
image=ReadImage(read_info,exception);
(void) RelinquishUniqueFileResource(read_info->filename);
(void) RelinquishUniqueFileResource(input_filename);
read_info=DestroyImageInfo(read_info);
if (image == (Image *) NULL)
  ThrowReaderException(DelegateError,"PSDelegateFailed");
if (LocaleCompare(image->magick,"BMP") == 0)
{
  Image
    *cmyk_image;

  cmyk_image=ConsolidateCMYKImages(image,exception);
  if (cmyk_image!= (Image *) NULL)
  {
    image=DestroyImageList(image);
    image=cmyk_image;
  }
}