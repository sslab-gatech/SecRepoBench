MagickBooleanType status;
Image *image,*next;
char buffer[MagickPathExtent];
const char *value;
size_t scene;
double pointsize;
size_t text_size;
GeometryInfo geometry_info;
PointInfo resolution,scale;
RectangleInfo geometry,media_info,page_info;
SegmentInfo bounds;
MagickOffsetType scene;

assert(image_info != (const ImageInfo *) NULL);
assert(image_info->signature == MagickCoreSignature);
assert(image != (Image *) NULL);
assert(image->signature == MagickCoreSignature);
if (image->debug != MagickFalse)
  (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
status=OpenBlob(image_info,image,WriteBinaryBlobMode,exception);
if (status == MagickFalse)
  return(status);
scene=0;
do
{
  /*
   * Scale image to fit page dimensions
   */
  scale.x=PerceptibleReciprocal(image->resolution.x)*72.0;
  scale.y=PerceptibleReciprocal(image->resolution.y)*72.0;
  page_info=GetImagePage(image);
  media_info=page_info;
  if ((image_info->page != (char *) NULL) &&
      (IsGeometry(image_info->page) != MagickFalse))
    (void) ParseMetaGeometry(image_info->page,&media_info.x,&media_info.y,
      &media_info.width,&media_info.height);
  geometry=media_info;
  if ((page_info.width != 0) && (page_info.height != 0))
    geometry=page_info;
  if ((geometry.width == 0) || (geometry.height == 0))
    {
      geometry.width=612;
      geometry.height=792;
    }
  /*
   * Scale image to fit page dimensions
   */
  (void) ParseAbsoluteGeometry(page_geometry,&geometry);
  (void) ParseGravityGeometry(image,page_geometry,&page_info,exception);
  if (image->gravity != UndefinedGravity)
    {
      geometry.x=(-page_info.x);
      geometry.y=(ssize_t) (media_info.height+page_info.y-image->rows);
    }
  pointsize=12.0;
  if (image_info->pointsize != 0.0)
    pointsize=image_info->pointsize;
  text_size=0;
  value=GetImageProperty(image,"label",exception);
  if (value != (const char *) NULL)
    text_size=(size_t) (MultilineCensus(value)*pointsize+12);
  if (page == 1)
  {
    /*
     * Output Postscript header
     */
    if (LocaleCompare(image_info->magick,"PS") == 0)
      (void) CopyMagickString(buffer,"%!PS-Adobe-3.0\n",MagickPathExtent);
    else
      (void) CopyMagickString(buffer,"%!PS-Adobe-3.0 EPSF-3.0\n",
        MagickPathExtent);
    (void) WriteBlobString(image,buffer);
    (void) WriteBlobString(image,"%%Creator: (ImageMagick)\n");
    (void) FormatLocaleString(buffer,MagickPathExtent,"%%%%Title: (%s)\n",
      image->filename);
    (void) WriteBlobString(image,buffer);
    (void) FormatMagickTime(time((time_t *) NULL),MagickPathExtent,buffer);
    (void) FormatLocaleString(buffer,MagickPathExtent,
      "%%%%CreationDate: (%s)\n",buffer);
    (void) WriteBlobString(image,buffer);
    bounds.x1=(double) geometry.x;
    bounds.y1=(double) geometry.y;
    bounds.x2=(double) geometry.x+scale.x*image->columns;
    bounds.y2=(double) geometry.y+scale.y*image->rows+text_size;
    if ((image_info->adjoin != MagickFalse) &&
        (GetNextImageInList(image) != (Image *) NULL))
      (void) CopyMagickString(buffer,"%%%%BoundingBox: (atend)\n",
        MagickPathExtent);
    else
      {
        (void) FormatLocaleString(buffer,MagickPathExtent,
          "%%%%BoundingBox: %.20g %.20g %.20g %.20g\n",
          ceil(bounds.x1-0.5),ceil(bounds.y1-0.5),
          floor(bounds.x2+0.5),floor(bounds.y2+0.5));
        (void) WriteBlobString(image,buffer);
        (void) FormatLocaleString(buffer,MagickPathExtent,
          "%%%%HiResBoundingBox: %g %g %g %g\n",
          bounds.x1,bounds.y1,bounds.x2,bounds.y2);
      }
    (void) WriteBlobString(image,buffer);
    /*
     * Output Postscript commands
     */
    /* ... (rest of Postscript commands) ... */
  }
  /*
   * Output image data
   */
  /* ... (image data output code) ... */
  
  if (GetNextImageInList(image) == (Image *) NULL)
    break;
  image=SyncNextImageInList(image);
  status=SetImageProgress(image,SaveImagesTag,scene++,
    GetImageListLength(image));
  if (status == MagickFalse)
    break;
} while (image_info->adjoin != MagickFalse);
(void) WriteBlobString(image,"%%Trailer\n");
if (page > 2)
{
  (void) FormatLocaleString(buffer,MagickPathExtent,
    "%%%%BoundingBox: %.20g %.20g %.20g %.20g\n",
    ceil(bounds.x1-0.5),ceil(bounds.y1-0.5),
    floor(bounds.x2+0.5),floor(bounds.y2+0.5));
  (void) WriteBlobString(image,buffer);
  (void) FormatLocaleString(buffer,MagickPathExtent,
    "%%%%HiResBoundingBox: %g %g %g %g\n",
    bounds.x1,bounds.y1,bounds.x2,bounds.y2);
  (void) WriteBlobString(image,buffer);
}
(void) WriteBlobString(image,"%%EOF\n");
(void) CloseBlob(image);
return(MagickTrue);