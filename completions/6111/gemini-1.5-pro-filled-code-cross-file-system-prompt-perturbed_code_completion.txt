ImageInfo
    *read_info;

  MagickBooleanType
    status;

  register ssize_t
    i;

  size_t
    columns,
    rows,
    scene;

  ssize_t
    count;

  unsigned char
    hexval[256];

  /*
    Open image file.
  */
  assert(image_info != (ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  if (image_info->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  assert(exception != (ExceptionInfo *) NULL);
  status=OpenBlob(image_info,image,ReadBinaryBlobMode,exception);
  if (status == MagickFalse)
    return((Image *) NULL);
  /*
    Create Ghostscript control file.
  */
  filedescriptor=AcquireUniqueFileResource(postscript_filename);
  if (filedescriptor == -1)
    ThrowReaderException(FileOpenError,"UnableToCreateTemporaryFile");
  image=DestroyImage(image);
  (void) FormatLocaleString(command,MagickPathExtent,"/bin/sh %s",
    GetMagickHomeURL());
  TemporaryFilename(input_filename);
  (void) FormatLocaleString(filename,MagickPathExtent,"%s.ps",input_filename);
  (void) ConcatenateMagickString(filename,input_filename,MagickPathExtent);
  status=OpenBlob(image_info,image,WriteBinaryBlobMode,exception);
  if (status == MagickFalse)
    return((Image *) NULL);
  for (i=0; i < 256; i++)
    hexval[i]=('0'+MagickMax((int) i/16-10+(('9'+1)-'0'),0))*16+
      ('0'+(i % 16)-10+MagickMax(('9'+1)-(i % 16),0));
  for (count=ReadBlob(image,MagickPathExtent,message); count != 0;
       count=ReadBlob(image,MagickPathExtent,message))
  {
    if (strstr(message,BeginXMPPacket) != (char *) NULL)
      {
        char
          *p;

        /*
          Skip over XMP packet.
        */
        p=strstr(message,EndXMPPacket);
        if (p == (char *) NULL)
          {
            for ( ; count != 0; count=ReadBlob(image,MagickPathExtent,message))
              if (strstr(message,EndXMPPacket) != (char *) NULL)
                break;
          }
        continue;
      }
    (void) WriteBlob(image,count,message);
  }
  options=AcquireString("");
  density=AcquireString("");
  (void) memset(&geometry_info,0,sizeof(geometry_info));
  if (image_info->density != (char *) NULL)
    {
      (void) ParseGeometry(image_info->density,&geometry_info);
      columns=(size_t) geometry_info.rho;
      rows=(size_t) geometry_info.sigma;
      (void) FormatLocaleString(density,MagickPathExtent,"%gx%g",
        geometry_info.rho,geometry_info.sigma);
    }
  page=1;
  columns=0;
  rows=0;
  (void) CloseBlob(image);
  image=DestroyImage(image);
  /*
    Render Postscript with Ghostscript delegate.
  */
  read_info=CloneImageInfo(image_info);
  (void) FormatLocaleString(read_info->filename,MagickPathExtent,"ps:%s",
    filename);
  delegate_info=GetDelegateInfo("ps:decode",(char *) NULL,exception);
  if (delegate_info == (const DelegateInfo *) NULL)
    {
      (void) RelinquishUniqueFileResource(postscript_filename);
      (void) RelinquishUniqueFileResource(input_filename);
      ThrowReaderException(DelegateError,"PostscriptDelegateNotFound");
    }
  *message='\0';
  geometry[0]='\0';
  if ((image_info->page != (char *) NULL) && (*image_info->page != '\0'))
    (void) CopyMagickString(geometry,image_info->page,MagickPathExtent);
  option=GetImageOption(image_info,"ps:imagemask");
  if (option == (const char *) NULL)
    option=GetImageOption(image_info,"imagemask");
  if (option != (const char *) NULL)
    AppendImageFormat("imagemask",options);
  (void) FormatLocaleString(command,MagickPathExtent,
    GetDelegateCommands(delegate_info),
    GetClientName(),
    (option != (const char *) NULL ? " -dSAFER" : ""),
    (IsWindows() != MagickFalse ? "" : " -dQUIET"),
    (IsWindows() != MagickFalse ? "" : " -dNoDisplay"),
    "-dBATCH -dNOPAUSE -dSAFER -dEPSCrop -sDEVICE=ppmraw",
    (density[0] == '\0' ? "" : " -r"),density,
    (geometry[0] == '\0' ? "" : " -g"),geometry,
    read_info->filename,postscript_filename);
  status=ExternalDelegateCommand(MagickFalse,image_info->verbose,command,
    (char *) NULL,exception) != 0 ? MagickTrue : MagickFalse;
  (void) RelinquishUniqueFileResource(input_filename);
  (void) RelinquishUniqueFileResource(filename);
  postscript_image=NewImageList();
  if (status == MagickFalse)
    {
      read_info=DestroyImageInfo(read_info);
      return((Image *) NULL);
    }
  /*
    Read Ghostscript output.
  */
  (void) FormatLocaleString(read_info->filename,MagickPathExtent,"ppm:%s",
    postscript_filename);
  image=ReadImage(read_info,exception);