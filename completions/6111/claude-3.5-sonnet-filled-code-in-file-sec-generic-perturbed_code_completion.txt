MagickBooleanType status;
Image *image,*next;
char buffer[MagickPathExtent];
const char *value;
size_t scene;
double pointsize;
size_t text_size;
GeometryInfo geometry_info;
PointInfo resolution,scale;
RectangleInfo geometry,media_info,page_info;
MagickStatusType flags;

assert(image_info != (const ImageInfo *) NULL);
assert(image_info->signature == MagickCoreSignature);
assert(image != (Image *) NULL);
assert(image->signature == MagickCoreSignature);
if (image->debug != MagickFalse)
  (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
assert(exception != (ExceptionInfo *) NULL);
assert(exception->signature == MagickCoreSignature);
status=OpenBlob(image_info,image,WriteBinaryBlobMode,exception);
if (status == MagickFalse)
  return(status);

scene=0;
do
{
  /*
   * Scale relative to dots-per-inch.
   */
  (void) TransformImageColorspace(image,sRGBColorspace,exception);
  resolution.x=image->resolution.x;
  resolution.y=image->resolution.y;
  if ((resolution.x == 0.0) || (resolution.y == 0.0))
    {
      flags=ParseGeometry(PSPageGeometry,&geometry_info);
      resolution.x=geometry_info.rho;
      resolution.y=geometry_info.sigma;
      if ((flags & SigmaValue) == 0)
        resolution.y=resolution.x;
    }
  SetGeometry(image,&geometry);
  (void) FormatLocaleString(buffer,MagickPathExtent,"%.20gx%.20g",
    (double) image->columns,(double) image->rows);
  if (image_info->page != (char *) NULL)
    (void) CopyMagickString(buffer,image_info->page,MagickPathExtent);
  else
    if ((image->page.width != 0) && (image->page.height != 0))
      (void) FormatLocaleString(buffer,MagickPathExtent,
        "%.20gx%.20g%+.20g%+.20g",(double) image->page.width,
        (double) image->page.height,(double) image->page.x,(double) image->page.y);
    else
      if ((image->gravity != UndefinedGravity) &&
          (LocaleCompare(image_info->magick,"PS") == 0))
        (void) CopyMagickString(buffer,PSPageGeometry,MagickPathExtent);
  (void) ConcatenateMagickString(buffer,">",MagickPathExtent);
  (void) ParseMetaGeometry(buffer,&geometry.x,&geometry.y,
    &geometry.width,&geometry.height);
  scale.x=(double) (geometry.width*resolution.x)/72.0;
  geometry.width=(size_t) floor(scale.x+0.5);
  scale.y=(double) (geometry.height*resolution.y)/72.0;
  geometry.height=(size_t) floor(scale.y+0.5);
  (void) ParseAbsoluteGeometry(buffer,&media_info);
  (void) ParseGravityGeometry(image,buffer,&page_info,exception);
  if (image->gravity != UndefinedGravity)
    {
      geometry.x=(-page_info.x);
      geometry.y=(ssize_t) (media_info.height+page_info.y-image->rows);
    }
  pointsize=12.0;
  if (image_info->pointsize != 0.0)
    pointsize=image_info->pointsize;
  text_size=0;
  value=GetImageProperty(image,"label",exception);
  if (value != (const char *) NULL)
    text_size=(size_t) (MultilineCensus(value)*pointsize+12);