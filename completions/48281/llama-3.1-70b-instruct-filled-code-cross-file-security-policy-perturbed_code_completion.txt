if (buf_size < 16) {
    av_log(codec_context, AV_LOG_WARNING, "truncated header\n");
    return AVERROR_INVALIDDATA;
}

if (codec_context->width < 8 || codec_context->width % 8!= 0) {
    av_log(codec_context, AV_LOG_ERROR, "Invalid width\n");
    return AVERROR_INVALIDDATA;
}

int quality = AV_RL32(buf + 4);
SpeedhqContext *s = codec_context->priv_data;
s->quality = quality;

if ((ret = ff_set_dimensions(codec_context, codec_context->width, codec_context->height)) < 0)
    return ret;

speedhq_calculate_qtable(s, quality);