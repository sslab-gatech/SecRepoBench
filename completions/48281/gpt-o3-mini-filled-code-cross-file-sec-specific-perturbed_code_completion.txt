{
    const uint8_t *buf = avpkt->data;
    int buf_size       = avpkt->size;
    SpeedhqContext *s  = codec_context->priv_data;
    
    if (buf_size < 4) {
        av_log(codec_context, AV_LOG_ERROR, "Packet too small: %d bytes\n", buf_size);
        return AVERROR_INVALIDDATA;
    }
    
    // The first byte holds the quality parameter.
    int quality = buf[0];

    // Optionally validate quality if a specific range is expected.
    // For example, if quality is expected to be between 1 and 100:
    // if (quality < 1 || quality > 100) {
    //     av_log(codec_context, AV_LOG_ERROR, "Invalid quality parameter: %d\n", quality);
    //     return AVERROR_INVALIDDATA;
    // }

    // Calculate the quantization matrix based on the quality parameter.
    speedhq_calculate_qtable(s, quality);
}