const uint8_t *buf = avpkt->data;
int buf_size = avpkt->size;
SHQContext *s = codec_context->priv_data;
int ret, quality, second_field_offset;

if (buf_size < 8) {
    av_log(codec_context, AV_LOG_ERROR, "Frame too small (%d)\n", buf_size);
    return AVERROR_INVALIDDATA;
}

quality = buf[0];
if (quality < 1 || quality > 100) {
    av_log(codec_context, AV_LOG_ERROR, "Invalid quality %d\n", quality);
    return AVERROR_INVALIDDATA;
}

if (codec_context->width & 15) {
    av_log(codec_context, AV_LOG_ERROR, "Width %d is not a multiple of 16\n", codec_context->width);
    return AVERROR_INVALIDDATA;
}

s->quality = quality;
prepare_speedhq_quant_matrix(s);