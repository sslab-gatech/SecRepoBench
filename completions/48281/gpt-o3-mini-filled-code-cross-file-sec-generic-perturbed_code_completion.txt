const uint8_t *buf = avpkt->data;
int buf_size = avpkt->size;

if (buf_size < 4) {
    av_log(codec_context, AV_LOG_ERROR, "speedhq: packet too small (%d bytes)", buf_size);
    return AVERROR_INVALIDDATA;
}

SpeedhqContext *s = codec_context->priv_data;
int quality = buf[0];

/* Ensure the quality parameter is within a valid range */
if (quality < 1)
    quality = 1;
else if (quality > 100)
    quality = 100;

speedhq_calculate_qmatrix(s, quality);