const uint8_t *buf = avpkt->data;
    int buf_size = avpkt->size;
    SpeedHQContext *s = codec_context->priv_data;

    if (buf_size < 8) {
        return AVERROR_INVALIDDATA;
    }

    s->width = AV_RL16(buf);
    s->height = AV_RL16(buf + 2);
    
    if (s->width <= 0 || s->height <= 0 || s->width > codec_context->width || s->height > codec_context->height) {
        return AVERROR_INVALIDDATA;
    }

    ret = ff_set_dimensions(codec_context, s->width, s->height);
    if (ret < 0) {
        return ret;
    }

    // Ensure that the frame buffer is allocated correctly
    if ((ret = ff_get_buffer(codec_context, frame, 0)) < 0) {
        return ret;
    }