const uint8_t *buf = avpkt->data;
int buf_size = avpkt->size;
SpeedhqContext *s = codec_context->priv_data;
int quality_param;

if (buf_size < 8) {
    av_log(codec_context, AV_LOG_ERROR, "Packet size is too small.\n");
    return AVERROR_INVALIDDATA;
}

// Extract quality parameter from packet data
quality_param = buf[0]; // Assuming the first byte represents the quality parameter

// Validate codec context width and height
if (codec_context->width <= 0 || codec_context->height <= 0) {
    av_log(codec_context, AV_LOG_ERROR, "Invalid width or height in codec context.\n");
    return AVERROR_INVALIDDATA;
}

// Calculate quantization matrix based on quality parameter
speedhq_calculate_qmatrix(s, quality_param);