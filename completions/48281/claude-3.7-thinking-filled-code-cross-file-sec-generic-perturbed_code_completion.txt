SpeedHQContext *s = codec_context->priv_data;
const uint8_t *buf = avpkt->data;
int buf_size = avpkt->size;
int second_field_offset;
int ret;

if (buf_size < 4) {
    av_log(codec_context, AV_LOG_ERROR, "packet too small\n");
    return AVERROR_INVALIDDATA;
}

// Extract quality parameter for quantization
int quality = buf[0];
// Adjust quality if outside valid range
if (quality < 1 || quality > 100) {
    quality = 50;  // Use default quality
}

// Calculate quantization tables based on quality
speedhq_calculate_qtable(s, quality);