const uint8_t *buf = avpkt->data;
    int buf_size = avpkt->size;
    SpeedHQContext *s   = codec_context->priv_data;
    int ret;

    /* Validate packet size and codec dimensions */
    if (!buf || buf_size < 4) {
        av_log(codec_context, AV_LOG_ERROR, "Invalid packet size for SpeedHQ.\n");
        return AVERROR_INVALIDDATA;
    }
    if (codec_context->width <= 0 || codec_context->height <= 0) {
        av_log(codec_context, AV_LOG_ERROR, "Invalid codec dimensions.\n");
        return AVERROR_INVALIDDATA;
    }

    /* Extract the quality parameter (assume it's in the first byte) */
    s->quality = buf[0];

    /* Calculate the quantization matrix based on the extracted quality */
    ret = speedhq_calculate_qtable(s, s->quality);
    if (ret < 0) {
        av_log(codec_context, AV_LOG_ERROR, "Failed to calculate SpeedHQ quantization table.\n");
        return ret;
    }