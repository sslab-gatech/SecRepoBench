const uint8_t *buf = avpkt->data;
    int buf_size = avpkt->size;
    int ret;

    if (!buf || buf_size < 4) {
        av_log(codec_context, AV_LOG_ERROR, "Invalid packet data or size\n");
        return AVERROR_INVALIDDATA;
    }

    // Ensure the buffer size is within a reasonable range to prevent overflow
    if (buf_size > INT_MAX - 16) {
        av_log(codec_context, AV_LOG_ERROR, "Packet size too large\n");
        return AVERROR_INVALIDDATA;
    }

    // Validate codec context dimensions
    if (codec_context->width <= 0 || codec_context->height <= 0) {
        av_log(codec_context, AV_LOG_ERROR, "Invalid codec context dimensions\n");
        return AVERROR_INVALIDDATA;
    }

    // Initialize decoding context
    SpeedHQContext *s = codec_context->priv_data;
    if (!s) {
        av_log(codec_context, AV_LOG_ERROR, "Failed to retrieve codec private data\n");
        return AVERROR(ENOMEM);
    }

    // Prepare the decoding buffer
    s->buf = buf;
    s->buf_size = buf_size;