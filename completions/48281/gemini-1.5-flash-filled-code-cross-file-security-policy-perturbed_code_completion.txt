const uint8_t *buf = avpkt->data;
    int buf_size = avpkt->size;
    SpeedHQContext *s = codec_context->priv_data;
    int ret;
    int second_field_offset;

    if (buf_size < 4) {
        return AVERROR_INVALIDDATA;
    }

    if (codec_context->width < 8 || codec_context->width % 8 != 0) {
        av_log(codec_context, AV_LOG_ERROR, "Codec context width must be a multiple of 8 and at least 8.\n");
        return AVERROR_INVALIDDATA;
    }

    s->quality = buf[0];
    if (s->quality > 100) {
        s->quality = 100;
    }
    s->quality = (s->quality * 255) / 100;

    tgq_calculate_qtable(s, s->quality);