SpeedhqContext *s = codec_context->priv_data;
const uint8_t *buf = avpkt->data;
int buf_size = avpkt->size;
int ret, second_field_offset;

if (buf_size < 4) {
    av_log(codec_context, AV_LOG_ERROR, "Packet size too small\n");
    return AVERROR_INVALIDDATA;
}

if (codec_context->width <= 0 || codec_context->height <= 0) {
    av_log(codec_context, AV_LOG_ERROR, "Invalid dimensions\n");
    return AVERROR_INVALIDDATA;
}

s->quality = buf[0];
if (s->quality < 1 || s->quality > 100) {
    av_log(codec_context, AV_LOG_ERROR, "Invalid quality value\n");
    return AVERROR_INVALIDDATA;
}

ret = speedhq_calculate_qtable(s, s->quality);
if (ret < 0) {
    av_log(codec_context, AV_LOG_ERROR, "Failed to calculate quantization table\n");
    return ret;
}