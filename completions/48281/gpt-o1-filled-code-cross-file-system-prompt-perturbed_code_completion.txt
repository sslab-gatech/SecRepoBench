{
    SpeedHQContext *s = codec_context->priv_data;
    const uint8_t *buf = avpkt->data;
    int buf_size = avpkt->size;

    if (buf_size < 4) {
        av_log(codec_context, AV_LOG_ERROR, "Packet too small\n");
        return AVERROR_INVALIDDATA;
    }

    if (codec_context->width <= 0 || codec_context->height <= 0) {
        av_log(codec_context, AV_LOG_ERROR, "Invalid frame dimensions\n");
        return AVERROR_INVALIDDATA;
    }

    /* Extract a quality parameter from the first byte of packet data. */
    s->quality = buf[0];

    /* Calculate a quantization matrix based on the extracted quality. */
    speedhq_calculate_qtable(s, s->quality);
}