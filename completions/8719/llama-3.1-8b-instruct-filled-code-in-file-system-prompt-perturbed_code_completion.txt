static void
DestroyJNG(unsigned char *chunk,Image **color_image,
  ImageInfo **color_image_info,Image **alpha_image,
  ImageInfo **alpha_image_info)
{
  (void) RelinquishMagickMemory(chunk);
  if (color_image_info && *color_image_info)
  {
    DestroyImageInfo(*color_image_info);
    *color_image_info = (ImageInfo *)NULL;
  }
  if (alpha_image_info && *alpha_image_info)
  {
    DestroyImageInfo(*alpha_image_info);
    *alpha_image_info = (ImageInfo *)NULL;
  }
  if (color_image && *color_image)
  {
    DestroyImage(*color_image);
    *color_image = (Image *)NULL;
  }
  if (alpha_image && *alpha_image)
  {
    DestroyImage(*alpha_image);
    *alpha_image = (Image *)NULL;
  }
}

static Image *ReadOneJNGImage(MngInfo *mng_info,
    const ImageInfo *image_info, ExceptionInfo *exception)
{
  Image
    *alpha_image,
    *color_image,
    *image,
    *jng_image;

  ImageInfo
    *alpha_image_info,
    *color_image_info;

  MagickBooleanType
    logging;

  ssize_t
    y;

  MagickBooleanType
    status;

  png_uint_32
    jng_height,
    jng_width;

  png_byte
    jng_color_type,
    jng_image_sample_depth,
    jng_image_compression_method,
    jng_image_interlace_method,
    jng_alpha_sample_depth,
    jng_alpha_compression_method,
    jng_alpha_filter_method,
    jng_alpha_interlace_method;

  register const Quantum
    *s;

  register ssize_t
    i,
    x;

  register Quantum
    *q;

  register unsigned char
    *p;

  unsigned int
    read_JSEP,
    reading_idat;

  size_t
    length;

  jng_alpha_compression_method=0;
  jng_alpha_sample_depth=8;
  jng_color_type=0;
  jng_height=0;
  jng_width=0;
  alpha_image=(Image *) NULL;
  color_image=(Image *) NULL;
  alpha_image_info=(ImageInfo *)
    AcquireMagickMemory(sizeof(ImageInfo));

  if (alpha_image_info == (ImageInfo *) NULL)
    {
      (void) ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
    }

  GetImageInfo(alpha_image_info);
  alpha_image=AcquireImage(alpha_image_info,exception);

  if (alpha_image == (Image *) NULL)
    {
      DestroyJNG(NULL,&color_image,&color_image_info,
        &alpha_image,&alpha_image_info);
      return(DestroyImageList(image));
    }

  if (logging!= MagickFalse)
    (void) LogMagickEvent(CoderEvent,GetMagickModule(),
      "    Creating color_blob.");

  (void) AcquireUniqueFilename(color_image->filename);
  status=OpenBlob(color_image_info,color_image,WriteBinaryBlobMode,
    exception);

  if (status == MagickFalse)
    {
      DestroyJNG(NULL,&color_image,&color_image_info,
        &alpha_image,&alpha_image_info);
      return(DestroyImageList(image));
    }

  if ((image_info->ping == MagickFalse) && (jng_color_type >= 12))
    {
      alpha_image_info=(ImageInfo *)
        AcquireMagickMemory(sizeof(ImageInfo));

      if (alpha_image_info == (ImageInfo *) NULL)
        {
          DestroyJNG(NULL,&color_image,&color_image_info,
            &alpha_image,&alpha_image_info);
          ThrowReaderException(ResourceLimitError,
            "MemoryAllocationFailed");
        }

      GetImageInfo(alpha_image_info);
      alpha_image=AcquireImage(alpha_image_info,exception);

      if (alpha_image == (Image *) NULL)
        {
          DestroyJNG(NULL,&color_image,&color_image_info,
            &alpha_image,&alpha_image_info);
          return(DestroyImageList(image));
        }

      if (logging!= MagickFalse)
        (void) LogMagickEvent(CoderEvent,GetMagickModule(),
          "    Creating alpha_blob.");

      (void) AcquireUniqueFilename(alpha_image->filename);
      status=OpenBlob(alpha_image_info,alpha_image,WriteBinaryBlobMode,
        exception);

      if (status == MagickFalse)
        {
          DestroyJNG(NULL,&color_image,&color_image_info,
            &alpha_image,&alpha_image_info);
          return(DestroyImageList(image));
        }

      if (jng_alpha_compression_method == 0)
        {
          unsigned char
            data[18];

          if (logging!= MagickFalse)
            (void) LogMagickEvent(CoderEvent,GetMagickModule(),
              "    Writing IHDR chunk to alpha_blob.");

          (void) WriteBlob(alpha_image,8,(const unsigned char *)
            "\211PNG\r\n\032\n");

          (void) WriteBlobMSBULong(alpha_image,13L);
          PNGType(data,mng_IHDR);
          LogPNGChunk(logging,mng_IHDR,13L);
          PNGLong(data+4,jng_width);
          PNGLong(data+8,jng_height);
          data[12]=jng_alpha_sample_depth;
          data[13]=0; /* color_type gray */
          data[14]=0; /* compression method 0 */
          data[15]=0; /* filter_method 0 */
          data[16]=0; /* interlace_method 0 */
          (void) WriteBlob(alpha_image,17,data);
          (void) WriteBlobMSBULong(alpha_image,crc32(0,data,17));
        }
    }

  reading_idat=MagickTrue;
  for (;;)
  {
    char
      type[MagickPathExtent];

    unsigned char
      *chunk_data;

    unsigned int
      count;

    /*
      Read the next chunk from the JNG image file.
    */
    status=SetImageProgress(image,LoadImagesTag,TellBlob(image),
      2*GetBlobSize(image));

    if (status == MagickFalse)
      break;

    type[0]='\0';
    (void) ConcatenateMagickString(type,"errr",MagickPathExtent);
    length=(size_t) ReadBlobMSBULong(image);
    count=(unsigned int) ReadBlob(image,4,(unsigned char *) type);

    if (logging!= MagickFalse)
      (void) LogMagickEvent(CoderEvent,GetMagickModule(),
        "  Reading JNG chunk type %c%c%c%c, length: %.20g",
        type[0],type[1],type[2],type[3],(double) length);

    if (length > PNG_UINT_31_MAX || count == 0)
      {
        DestroyJNG(NULL,&color_image,&color_image_info,
          &alpha_image,&alpha_image_info);
        ThrowReaderException(CorruptImageError,"ImproperImageHeader");
      }
    if (length > GetBlobSize(image))
      {
        DestroyJNG(NULL,&color_image,&color_image_info,
          &alpha_image,&alpha_image_info);
        ThrowReaderException(CorruptImageError,
          "InsufficientImageDataInFile");
      }

    p=NULL;
    chunk_data=(unsigned char *) NULL;

    if (length!= 0)
      {
        chunk_data=(unsigned char *) AcquireQuantumMemory(length,sizeof(*chunk_data));

        if (chunk_data == (unsigned char *) NULL)
          ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");

        for (i=0; i < (ssize_t) length; i++)
        {
          int
            c;

          c=ReadBlobByte(image);
          if (c == EOF)
            break;
          chunk_data[i]=(unsigned char) c;
        }
        for ( ; i < (ssize_t) length; i++)
          chunk_data[i]='\0';

        p=chunk_data;
      }

    (void) ReadBlobMSBLong(image);  /* read crc word */

#if!defined(JNG_SUPPORTED)
    if (memcmp(type,mng_JHDR,4) == 0)
      {
        skip_to_iend=MagickTrue;

        if (mng_info->jhdr_warning == 0)
          (void) ThrowMagickException(exception,GetMagickModule(),
            CoderError,"JNGCompressNotSupported","`%s'",image->filename);

        mng_info->jhdr_warning++;
      }
#endif
    if (memcmp(type,mng_DHDR,4) == 0)
      {
        skip_to_iend=MagickTrue;

        if (mng_info->dhdr_warning == 0)
          (void) ThrowMagickException(exception,GetMagickModule(),
            CoderError,"DeltaPNGNotSupported","`%s'",image->filename);

        mng_info->dhdr_warning++;
      }
    if (memcmp(type,mng_MEND,4) == 0)
      {
        chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
        break;
      }

    if (skip_to_iend)
      {
        if (memcmp(type,mng_IEND,4) == 0)
          skip_to_iend=MagickFalse;

        chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);

        if (logging!= MagickFalse)
          (void) LogMagickEvent(CoderEvent,GetMagickModule(),
            "  Skip to IEND.");

        continue;
      }

    if (memcmp(type,mng_MHDR,4) == 0)
      {
        if (length!= 28)
          {
            chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
            ThrowReaderException(CorruptImageError,"CorruptImage");
          }

        mng_info->mng_width=(unsigned long)mng_get_long(p);
        mng_info->mng_height=(unsigned long)mng_get_long(&p[4]);

        if (logging!= MagickFalse)
          {
            (void) LogMagickEvent(CoderEvent,GetMagickModule(),
              "  MNG width: %.20g",(double) mng_info->mng_width);
            (void) LogMagickEvent(CoderEvent,GetMagickModule(),
              "  MNG height: %.20g",(double) mng_info->mng_height);
          }

        p+=8;
        mng_info->ticks_per_second=(size_t) mng_get_long(p);

        if (mng_info->ticks_per_second == 0)
          default_frame_delay=0;

        else
          default_frame_delay=1UL*image->ticks_per_second/
            mng_info->ticks_per_second;

        frame_delay=default_frame_delay;
        simplicity=0;

        p+=16;
        simplicity=(size_t) mng_get_long(p);

        mng_type=1;    /* Full MNG */

        if ((simplicity!= 0) && ((simplicity | 11) == 11))
          mng_type=2; /* LC */

        if ((simplicity!= 0) && ((simplicity | 9) == 9))
          mng_type=3; /* VLC */

#if defined(MNG_INSERT_LAYERS)
        if (mng_type!= 3)
          insert_layers=MagickTrue;
#endif
        if (GetAuthenticPixelQueue(image)!= (Quantum *) NULL)
          {
            /* Allocate next image structure.  */
            AcquireNextImage(image_info,image,exception);

            if (GetNextImageInList(image) == (Image *) NULL)
              return(DestroyImageList(image));

            image=SyncNextImageInList(image);
          }

        if ((mng_info->mng_width > 65535L) ||
            (mng_info->mng_height > 65535L))
          {
            chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
            ThrowReaderException(ImageError,"WidthOrHeightExceedsLimit");
          }

        (void) FormatLocaleString(page_geometry,MagickPathExtent,
          "%.20gx%.20g+0+0",(double) mng_info->mng_width,(double)
          mng_info->mng_height);

        mng_info->frame.left=0;
        mng_info->frame.right=(ssize_t) mng_info->mng_width;
        mng_info->frame.top=0;
        mng_info->frame.bottom=(ssize_t) mng_info->mng_height;
        mng_info->clip=default_fb=previous_fb=mng_info->frame;

        for (i=0; i < MNG_MAX_OBJECTS; i++)
          mng_info->object_clip[i]=mng_info->frame;

        chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
        continue;
      }

    if (memcmp(type,mng_TERM,4) == 0)
      {
        int
          repeat=0;

        if (length!= 0)
          repeat=p[0];

        if (repeat == 3 && length > 9)
          {
            final_delay=(png_uint_32) mng_get_long(&p[2]);
            mng_iterations=(png_uint_32) mng_get_long(&p[6]);

            if (mng_iterations == PNG_UINT_31_MAX)
              mng_iterations=0;

            image->iterations=mng_iterations;
            term_chunk_found=MagickTrue;
          }

        if (logging!= MagickFalse)
          {
            (void) LogMagickEvent(CoderEvent,GetMagickModule(),
              "    repeat=%d,  final_delay=%.20g,  iterations=%.20g",
              repeat,(double) final_delay, (double) image->iterations);
          }

        chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
        continue;
      }
    if (memcmp(type,mng_DEFI,4) == 0)
      {
        if (mng_type == 3)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              CoderError,"DEFI chunk found in MNG-VLC datastream","`%s'",
              image->filename);
            chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
            continue;
          }

        if (length < 2)
          {
            chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
            ThrowReaderException(CorruptImageError,"CorruptImage");
          }