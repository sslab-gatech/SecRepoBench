png_uint_32 length;
png_byte type[5];
png_byte *chunk_data;

length = (png_uint_32) ReadBlobMSBLong(image);
(void) memset(type, 0, 5);
(void) ReadBlob(image, 4, type);

if (logging != MagickFalse)
{
  (void) LogMagickEvent(CoderEvent,GetMagickModule(),
    "  Reading PNG chunk type %c%c%c%c, length: %.20g",
    type[0],type[1],type[2],type[3],(double) length);
}

if (length > PNG_UINT_31_MAX || length > GetBlobSize(image))
{
  chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
  ThrowReaderException(CorruptImageError,"ImproperImageHeader");
}

chunk_data = (png_byte *) AcquireQuantumMemory(length, sizeof(*chunk_data));

if (chunk_data == (png_byte *) NULL)
  ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");

for (i=0; i < (ssize_t) length; i++)
{
  int
    c;

  c = ReadBlobByte(image);
  if (c == EOF)
  {
    chunk_data=(unsigned char *) RelinquishMagickMemory(chunk_data);
    ThrowReaderException(CorruptImageError,
      "InsufficientImageDataInFile");
  }
  chunk_data[i] = (unsigned char) c;
}

p = chunk_data;