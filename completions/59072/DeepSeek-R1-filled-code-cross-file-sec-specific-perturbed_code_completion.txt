if (op1_string == op2_string) {
    zend_string *old_op2 = op2_string;
    op2_string = zend_string_copy(old_op2);
    if (free_op2_string) {
        zend_string_release(old_op2);
    }
    free_op2_string = true;
}

result_str = zend_string_extend(op1_string, result_len, 0);
if (result_str != op1_string) {
    if (shouldfreeopstring) {
        zend_string_release(op1_string);
    }
    shouldfreeopstring = true;
}

if (result == orig_op1) {
    i_zval_ptr_dtor(result);
}