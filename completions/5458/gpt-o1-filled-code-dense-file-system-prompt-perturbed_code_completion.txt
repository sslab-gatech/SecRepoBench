{
  size_t new_size;
  char *new_xml_start;

  /*
    Calculate the required size to accommodate the expanded entity plus
    the remaining string (including the null terminator).
  */
  new_size=(size_t)(offset + length + strlen(entity+1) + 1);
  /*
    If our current buffer is too small, attempt to resize it.
  */
  if (new_size > (strlen(xml_start)+1))
    {
      new_xml_start=(char *) ResizeQuantumMemory(xml_start,new_size,
        sizeof(*new_xml_start));
      if (new_xml_start == (char *) NULL)
        ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
      xml_start=new_xml_start;
    }
  /*
    Update pointers after reallocation.
  */
  xml=xml_start+offset;
  entity=strchr(xml,';');
}