char *new_xml;
if (extent > (size_t) (xml_start-q))
{
  size_t current_length = (size_t) (xml-xml_start);
  new_xml = (char *) AcquireQuantumMemory(extent+1, sizeof(*new_xml));
  if (new_xml == (char *) NULL)
    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
  memcpy(new_xml, q, current_length);
  new_xml[current_length] = '\0';
  if (xml_start != q)
    free(xml_start);
  xml_start = new_xml;
}
xml = xml_start + offset;
entity = strchr(xml, ';');
if (entity == (char *) NULL)
  ThrowFatalException(ResourceLimitFatalError, "UnexpectedEndOfFile");
memmove(xml + length, entity + 1, strlen(entity));
xml_start[extent] = '\0';