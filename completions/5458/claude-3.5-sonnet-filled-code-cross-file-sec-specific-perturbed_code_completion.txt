char *new_xml;
size_t new_size = extent + 1;  // +1 for null terminator

new_xml = (char *)RelinquishMagickMemory(xml_start);
new_xml = (char *)AcquireMagickMemory(new_size);
if (new_xml == NULL) {
    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
}

memcpy(new_xml, xml_start, offset);
memcpy(new_xml + offset, entities[i], length);
size_t remaining = strlen(entity + 1);
if (remaining > new_size - (offset + length)) {
    remaining = new_size - (offset + length) - 1;
}
memcpy(new_xml + offset + length, entity + 1, remaining);
new_xml[new_size - 1] = '\0';

xml_start = new_xml;
xml = xml_start + offset;
entity = strchr(xml, ';');