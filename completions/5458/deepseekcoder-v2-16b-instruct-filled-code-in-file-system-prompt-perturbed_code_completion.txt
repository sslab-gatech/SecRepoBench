->attributes[i][j] != (char *) NULL; j+=3)
                if (strcmp(root->attributes[i][j],n) == 0)
                  break;
              if (root->attributes[i][j] == (char *) NULL)
                {
                  root->attributes[i]=(char **) ResizeQuantumMemory(
                    root->attributes[i],(size_t) (j+4),
                    sizeof(**root->attributes));
                  if (root->attributes[i] == (char **) NULL)
                    ThrowFatalException(ResourceLimitFatalError,
                      "MemoryAllocationFailed");
                  root->attributes[i][j+1]=ConstantString(n);
                  root->attributes[i][j+2]=ConstantString(c);
                  root->attributes[i][j+3]=ConstantString(v);
                  root->attributes[i][j+4]=(char *) NULL;
                }
              xml+=strspn(xml,XMLWhitespace ">")+1;
            }
          }
        else
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","malformed <!ATTLIST");
            predefined_entitites=(char **) RelinquishMagickMemory(
              predefined_entitites);
            return(MagickFalse);
          }
        }
      else
        if (strncmp(xml,"<!DOCTYPE",9) == 0)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","<!DOCTYPE not supported");
            predefined_entitites=(char **) RelinquishMagickMemory(
              predefined_entitites);
            return(MagickFalse);
          }
      xml+=strspn(xml,XMLWhitespace);
    }
  predefined_entitites=(char **) RelinquishMagickMemory(predefined_entitites);
  return(MagickTrue);
}

static XMLTreeInfo *ParseOpenTag(XMLTreeRoot *root,char *tag,
  ExceptionInfo *exception)
{
  XMLTreeInfo
    *xml_info;

  xml_info=GetXMLTreeChild(root->node,tag);
  if (xml_info != (XMLTreeInfo *) NULL)
    {
      root->node=xml_info;
      return(xml_info);
    }
  xml_info=(XMLTreeInfo *) AcquireMagickMemory(sizeof(*xml_info));
  if (xml_info == (XMLTreeInfo *) NULL)
    ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
  (void) ResetMagickMemory(xml_info,0,sizeof(*xml_info));
  xml_info->tag=tag;
  xml_info->attributes=sentinel;
  xml_info->content=ConstantString("");
  xml_info->debug=IsEventLogging();
  xml_info->signature=MagickCoreSignature;
  xml_info=InsertTagIntoXMLTree(root->node,xml_info,root->node->offset);
  if (xml_info == (XMLTreeInfo *) NULL)
    {
      xml_info=(XMLTreeInfo *) RelinquishMagickMemory(xml_info);
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  root->node=xml_info;
  return(xml_info);
}

static XMLTreeInfo *ParseTag(XMLTreeRoot *root,char *xml,size_t length,
  ExceptionInfo *exception)
{
  char
    *tag,
    *xml_start;

  XMLTreeInfo
    *xml_info;

  xml_start=xml;
  xml+=strspn(xml,XMLWhitespace);
  if (*xml == '\0')
    return((XMLTreeInfo *) NULL);
  tag=xml+strcspn(xml,XMLWhitespace);
  *tag='\0';
  tag=strchr(xml,' ');
  if (tag != (char *) NULL)
    *tag='\0';
  xml+=strspn(xml,XMLWhitespace);
  xml_info=ParseOpenTag(root,xml_start,exception);
  if (xml_info == (XMLTreeInfo *) NULL)
    return((XMLTreeInfo *) NULL);
  if (*xml != '\0')
    {
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '>')
        return(xml_info);
      if (*xml == '/')
        {
          xml++;
          xml+=strspn(xml,XMLWhitespace);
          if (*xml == '>')
            return(xml_info);
          (void) ThrowMagickException(exception,GetMagickModule(),
            OptionWarning,"ParseError","malformed tag");
          return((XMLTreeInfo *) NULL);
        }
      if (*xml != '<')
        {
          (void) ThrowMagickException(exception,GetMagickModule(),
            OptionWarning,"ParseError","malformed tag");
          return((XMLTreeInfo *) NULL);
        }
    }
  xml++;
  ParseCharacterContent(root,xml,length-2,' ');
  xml+=strspn(xml,XMLWhitespace);
  if (*xml != '>')
    {
      (void) ThrowMagickException(exception,GetMagickModule(),
        OptionWarning,"ParseError","malformed tag");
      return((XMLTreeInfo *) NULL);
    }
  xml++;
  return(xml_info);
}

MagickExport XMLTreeInfo *NewXMLTree(const char *xml,ExceptionInfo *exception)
{
  XMLTreeRoot
    *root;

  char
    *xml_start,
    *xml_utf8;

  size_t
    length;

  xml_start=xml;
  length=strlen(xml);
  xml_utf8=ConvertUTF16ToUTF8(xml_start,&length);
  if (xml_utf8 == (char *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
        "ParseError","Unable to convert XML string to UTF-8");
      return((XMLTreeInfo *) NULL);
    }
  root=(XMLTreeRoot *) AcquireMagickMemory(sizeof(*root));
  if (root == (XMLTreeRoot *) NULL)
    {
      xml_utf8=(char *) RelinquishMagickMemory(xml_utf8);
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  (void) ResetMagickMemory(root,0,sizeof(*root));
  root->root.tag=ConstantString("root");
  root->root.attributes=sentinel;
  root->root.content=ConstantString("");
  root->root.debug=IsEventLogging();
  root->root.signature=MagickCoreSignature;
  root->node=&root->root;
  root->standalone=MagickFalse;
  root->processing_instructions=(char ***) AcquireQuantumMemory(1,
    sizeof(*root->processing_instructions));
  if (root->processing_instructions == (char ***) NULL)
    {
      xml_utf8=(char *) RelinquishMagickMemory(xml_utf8);
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  *root->processing_instructions=(char **) NULL;
  root->entities=(char **) AcquireQuantumMemory(NumberPredefinedEntities*2+1,
    sizeof(*root->entities));
  if (root->entities == (char **) NULL)
    {
      xml_utf8=(char *) RelinquishMagickMemory(xml_utf8);
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  (void) CopyMagickMemory(root->entities,sentinel,sizeof(sentinel));
  xml=ParseEntities(xml_utf8,root->entities,'&');
  xml_utf8=(char *) RelinquishMagickMemory(xml_utf8);
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,'*');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,'%');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,'c');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }
  xml=ParseEntities(xml,root->entities,' ');
  if (xml == (char *) NULL)
    {
      ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
    }