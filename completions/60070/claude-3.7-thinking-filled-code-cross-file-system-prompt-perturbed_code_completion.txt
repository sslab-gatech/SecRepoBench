static void thrift_set_method(struct ndpi_detection_module_struct *ndpi_struct,
                              struct ndpi_flow_struct *flow,
                              char const * const method, size_t methodlen)
{
  // Copy the method name into the flow's method field if the method is valid.
  // If the method is invalid, set a risk flag and clear the flow's method field.
  if (method == NULL || methodlen == 0) {
    // Invalid method, set risk flag and clear method field
    NDPI_SET_BIT(flow->risk, NDPI_MALFORMED_PACKET);
    flow->protos.thrift.method[0] = '\0';
  } else {
    // Valid method, copy it to the flow's method field
    size_t copy_len = methodlen < sizeof(flow->protos.thrift.method) - 1 ? methodlen : sizeof(flow->protos.thrift.method) - 1;
    memcpy(flow->protos.thrift.method, method, copy_len);
    flow->protos.thrift.method[copy_len] = '\0';
    
    // If the method name was truncated, set a risk flag
    if (methodlen > copy_len) {
      NDPI_SET_BIT(flow->risk, NDPI_MALFORMED_PACKET);
    }
  }
}