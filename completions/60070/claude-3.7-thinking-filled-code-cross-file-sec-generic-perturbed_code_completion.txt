if (method == NULL || methodlen == 0 || methodlen >= NDPI_THRIFT_METHOD_MAX_LEN) {
  // Invalid method - set a risk flag
  ndpi_set_risk(ndpi_struct, flow, NDPI_MALFORMED_PACKET);
  // Clear the method field
  flow->protos.thrift.method[0] = '\0';
  return;
}

// Check for invalid characters in the method name
for (size_t i = 0; i < methodlen; i++) {
  if (!isprint((unsigned char)method[i])) {
    // Method contains invalid characters - set risk flag
    ndpi_set_risk(ndpi_struct, flow, NDPI_MALFORMED_PACKET);
    flow->protos.thrift.method[0] = '\0';
    return;
  }
}

// Method is valid, copy it to the flow
memcpy(flow->protos.thrift.method, method, methodlen);
flow->protos.thrift.method[methodlen] = '\0'; // Ensure null-termination