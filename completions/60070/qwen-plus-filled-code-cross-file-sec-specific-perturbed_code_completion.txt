if (methodlen > 0 && methodlen <= NDPI_THRIFT_MAX_METHOD_LEN) {
  if (flow->method == NULL || strlen(flow->method) == 0) {
    flow->method = malloc(methodlen + 1);
    if (flow->method != NULL) {
      memcpy(flow->method, method, methodlen);
      flow->method[methodlen] = '\0';
    } else {
      NDPI_LOG_ERROR(ndpi_struct, "Memory allocation failed for method.\n");
      ndpi_set_risk(ndpi_struct, flow, NDPI_RISK_MEMORY_ALLOCATION_FAILURE);
    }
  } else {
    NDPI_LOG_WARNING(ndpi_struct, "Flow method field is already set.\n");
    ndpi_set_risk(ndpi_struct, flow, NDPI_RISK_INVALID_THRIFT_MESSAGE);
  }
} else {
  NDPI_LOG_WARNING(ndpi_struct, "Invalid method length.\n");
  ndpi_set_risk(ndpi_struct, flow, NDPI_RISK_INVALID_THRIFT_MESSAGE);
  if (flow->method != NULL) {
    free(flow->method);
    flow->method = NULL;
  }
}