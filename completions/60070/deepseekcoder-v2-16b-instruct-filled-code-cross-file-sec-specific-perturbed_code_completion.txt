if (methodlen > 0 && methodlen <= NDPI_MAX_METHOD_LEN) {
    char *method_copy = (char *)ndpi_malloc(ndpi_struct, methodlen + 1);
    if (method_copy) {
      memcpy(method_copy, method, methodlen);
      method_copy[methodlen] = '\0';
      flow->method = method_copy;
      flow->method_len = methodlen;
    } else {
      NDPI_LOG_ERROR(ndpi_struct, "Failed to allocate memory for method copy\n");
      flow->risk |= NDPI_BITMASK_PROTOCOL_RISK_INVALID_DATA;
      flow->method[0] = '\0';
      flow->method_len = 0;
    }
  } else {
    NDPI_LOG_WARN(ndpi_struct, "Invalid method length: %zu\n", methodlen);
    flow->risk |= NDPI_BITMASK_PROTOCOL_RISK_INVALID_DATA;
    flow->method[0] = '\0';
    flow->method_len = 0;
  }