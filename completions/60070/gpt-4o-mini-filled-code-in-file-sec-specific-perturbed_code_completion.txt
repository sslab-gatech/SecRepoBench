if (thrift_validate_method(method, methodlen)) {
    // Allocate memory for the method and ensure it does not exceed the maximum allowed length
    if (methodlen < MAX_METHOD_LENGTH) {
      flow->protos.thrift.method = (char *)malloc(methodlen + 1);
      if (flow->protos.thrift.method) {
        memcpy(flow->protos.thrift.method, method, methodlen);
        flow->protos.thrift.method[methodlen] = '\0'; // Null-terminate the string
      } else {
        ndpi_set_risk(ndpi_struct, flow, NDPI_MEMORY_ALLOCATION_FAILURE, "Failed to allocate memory for method");
      }
    } else {
      ndpi_set_risk(ndpi_struct, flow, NDPI_MALFORMED_PACKET, "Method length exceeds maximum allowed");
      flow->protos.thrift.method = NULL; // Clear the method field
    }
  } else {
    ndpi_set_risk(ndpi_struct, flow, NDPI_MALFORMED_PACKET, "Invalid method");
    flow->protos.thrift.method = NULL; // Clear the method field
  }