if (ISDIGIT(ch)) {
  int val = ch - '0';
  int nextpos = tmpl->idx + 1;
  while (nextpos < tlen && ISDIGIT(tptr[nextpos])) {
    int nd = tptr[nextpos] - '0';
    if (val > (INT_MAX - nd) / 10) {
      mrb_raise(mrb, E_RUNTIME_ERROR, "template length too large");
    }
    val = val * 10 + nd;
    nextpos++;
  }
  repeatcount = val;
  tmpl->idx = nextpos - 1; /* leave it so that 'tmpl->idx++' will set tmpl->idx = nextpos */
}