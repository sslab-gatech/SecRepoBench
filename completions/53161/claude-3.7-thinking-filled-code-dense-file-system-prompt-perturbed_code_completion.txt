int v = 0;
do {
  if (v > INT_MAX / 10) {
    mrb_raise(mrb, E_RUNTIME_ERROR, "template length too big");
  }
  v = v * 10 + (ch - '0');
  tmpl->idx++;
  if (tmpl->idx >= tlen) break;
  ch = tptr[tmpl->idx];
} while (ISDIGIT(ch));
tmpl->idx--; // adjust back since the loop will increment it again
repeatcount = v;