{
  /* parse the first digit we already have in 'ch' */
  mrb_int val = ch - '0';
  mrb_int pos = tmpl->idx + 1;

  /* read subsequent digits */
  while (pos < tlen && ISDIGIT(tptr[pos])) {
    int digit = tptr[pos] - '0';
    if (val > (MRB_INT_MAX - digit) / 10) {
      mrb_raise(mrb, E_RUNTIME_ERROR, "the template length is too large");
    }
    val = val * 10 + digit;
    pos++;
  }

  /* check for overflow */
  if (val > INT_MAX) {
    mrb_raise(mrb, E_RUNTIME_ERROR, "the template length is too large");
  }

  repeatcount = (int)val;

  /* adjust index so the main loop increment points to the next suffix character */
  tmpl->idx = pos - 1;
}