{
        mrb_int val = 0;
        int start = tmpl->idx;
        while (tmpl->idx < tlen && ISDIGIT(tptr[tmpl->idx])) {
          int digit = tptr[tmpl->idx] - '0';
          if (val > (MRB_INT_MAX - digit) / 10) {
            mrb_raise(mrb, E_RUNTIME_ERROR, "template length too large");
          }
          val = val * 10 + digit;
          tmpl->idx++;
        }
        if (tmpl->idx == start) {
          mrb_raise(mrb, E_RUNTIME_ERROR, "invalid template repeat count");
        }
        repeatcount = (int)val;
        tmpl->idx--; /* compensate for tmpl->idx++ at end of loop */
      }