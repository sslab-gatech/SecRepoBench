while (tmpl->idx < tlen) {
  ch = tptr[tmpl->idx];
  if (ISDIGIT(ch)) {
    // Check if the current character is a digit.
    // If so, read an integer value from the template string.
    // Update the template index to point after the read integer value.
    // If reading fails raise a runtime error indicating the template length is too large.
    if (sscanf((const char*)tptr + tmpl->idx, "%d", &repeatcount)!= 1) {
      mrb_raisef(mrb, E_RUNTIME_ERROR, "template length is too large");
    }
    tmpl->idx += strlen((const char*)tptr + tmpl->idx);
  } else if (ch == '*')  {
    if (type == PACK_TYPE_NONE)
      repeatcount = 0;
    else
      repeatcount = -1;
  } else if (ch == '_' || ch == '!' || ch == '<' || ch == '>') {
    if (strchr("sSiIlLqQ", (int)t) == NULL) {
      mrb_raisef(mrb, E_ARGUMENT_ERROR, "'%c' allowed only after types sSiIlLqQ", ch);
    }
    if (ch == '_' || ch == '!') {
      flags |= PACK_FLAG_s;
    } else if (ch == '<') {
      flags |= PACK_FLAG_LT;
    } else if (ch == '>') {
      flags |= PACK_FLAG_GT;
    }
  }
  else {
    break;
  }
  tmpl->idx++;
}