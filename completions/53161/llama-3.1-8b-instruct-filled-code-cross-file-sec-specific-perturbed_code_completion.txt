while (tmpl->idx < tlen) {
  ch = tptr[tmpl->idx];
  if (ISDIGIT(ch)) {
    // Check if the current character is a digit.
    // If so, read an integer value from the template string.
    // Update the template index to point after the read integer value.
    // If reading fails raise a runtime error indicating the template length is too large.
    if (tmpl->idx + 1 >= tlen) {
      mrb_raisef(mrb, E_RUNTIME_ERROR, "Template length is too large");
    }
    repeatcount = 0;
    while (ISDIGIT(tptr[tmpl->idx])) {
      repeatcount = repeatcount * 10 + (tptr[tmpl->idx++] - '0');
    }
    if (repeatcount == 0) {
      mrb_raisef(mrb, E_RUNTIME_ERROR, "Invalid repeat count in template");
    }
  } else if (ch == '*')  {
    if (type == PACK_TYPE_NONE)
      repeatcount = 0;
    else
      repeatcount = -1;
  } else if (ch == '_' || ch == '!' || ch == '<' || ch == '>') {
    if (strchr("sSiIlLqQ", (int)t) == NULL) {
      mrb_raisef(mrb, E_ARGUMENT_ERROR, "'%c' allowed only after types sSiIlLqQ", ch);
    }
    if (ch == '_' || ch == '!') {
      flags |= PACK_FLAG_s;
    } else if (ch == '<') {
      flags |= PACK_FLAG_LT;
    } else if (ch == '>') {
      flags |= PACK_FLAG_GT;
    }
  }
  else {
    break;
  }
  tmpl->idx++;
}