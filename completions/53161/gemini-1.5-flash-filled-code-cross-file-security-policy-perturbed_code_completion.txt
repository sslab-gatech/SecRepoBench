long val;
      char *endp;
      val = strtol(tptr + tmpl->idx, &endp, 10);
      if (endp == tptr + tmpl->idx) {
        mrb_raisef(mrb, E_RUNTIME_ERROR, "invalid template '%s'", tptr);
      }
      tmpl->idx = endp - tptr;
      if (tmpl->idx > tlen) {
        mrb_raisef(mrb, E_RUNTIME_ERROR, "template length is too large");
      }
      if (t == 'A' || t == 'a' || t == 'm' || t == 'M' || t == 'Z') {
        if (val > INT_MAX) {
          mrb_raisef(mrb, E_RUNTIME_ERROR, "template length is too large");
        }
        repeatcount = (int)val;
      } else {
        repeatcount = (int)val;
      }