bool result = false;
    auto subset_glyphs = _plan->generate_subset_glyphs (context->plan, font);

    if (font)
      hb_font_destroy (font);

    if (unlikely (subset_glyphs.failed ()))
      return_trace (false);

    _glyphs.init ();
    unsigned glyf_count = subset_glyphs->length;
    _glyphs.resize (glyf_count);

    bool short_loca = true;
    for (unsigned i = 0; i < glyf_count; i++)
    {
      hb_codepoint_t glyph = (*subset_glyphs)[i];
      if (unlikely (!context->serializer->embed_glyph (glyph)))
      {
	DEBUG_MSG (SUBSET, nullptr, "failed to embed glyph %u", glyph);
	return_trace (false);
      }

      unsigned offset = context->serializer->get_offset (glyph);
      _glyphs[i].padded_offset = offset;
      if (offset > 65535)
	short_loca = false;
    }

    _loca_format = short_loca ? HB_LOCA_FORMAT_SHORT : HB_LOCA_FORMAT_LONG;

    glyf_object_t glyf;
    result = _serialize_glyf (context, &glyf);

    if (context->plan->drop_hints)
      subset_glyphs->clear ();

    return_trace (result);