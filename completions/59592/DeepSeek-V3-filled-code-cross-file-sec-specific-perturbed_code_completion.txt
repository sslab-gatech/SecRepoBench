hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->num_output_glyphs ()))) {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    if (!_populate_subset_glyphs (context->plan, font, subset_glyphs)) {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    if (font) {
      hb_font_destroy (font);
      font = nullptr;
    }

    bool use_short_loca = _calculate_padded_offsets (subset_glyphs);

    glyf *glyf_prime = context->serializer->start_embed<glyf> ();
    if (unlikely (!glyf_prime)) {
      for (auto &g : subset_glyphs)
        g.free_compiled_bytes ();
      return_trace (false);
    }

    bool result = glyf_prime->serialize (context->serializer, subset_glyphs, use_short_loca);

    for (auto &g : subset_glyphs)
      g.free_compiled_bytes ();