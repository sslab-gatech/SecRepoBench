// Generate a subset of glyphs based on the provided plan and font.
// Populate a list of subset glyphs, checking for failure in the process.
// Destroy the font if it was created for instancing, after using it.
// Calculate padded offsets for each subset glyph and determine if a short loca table can be used.
// Initialize a new glyf object for serialization.
// Serialize the subset of glyphs into the glyf object, using the determined loca format.
// Handle any necessary cleanup of resources, particularly the compiled subset glyphs, if required.
// Return the result of the serialization process as the function's output.
hb_glyf_t *glyf = hb_glyf_create ();
if (unlikely (!glyf)) return_trace (false);

hb_glyf_t *subset_glyf = hb_glyf_create_subset (glyf, context->plan->source);
if (unlikely (!subset_glyf)) {
  hb_glyf_destroy (glyf);
  return_trace (false);
}

hb_glyf_t *serialized_glyf = hb_glyf_serialize (subset_glyf, context->serializer);
if (unlikely (!serialized_glyf)) {
  hb_glyf_destroy (subset_glyf);
  return_trace (false);
}

hb_glyf_destroy (subset_glyf);
hb_glyf_destroy (glyf);

// Cleanup compiled subset glyphs
hb_subset_glyph_t *glyph = context->plan->glyphs.get_first ();
while (glyph) {
  hb_subset_glyph_t *next_glyph = glyph->next;
  free_compiled_bytes (glyph);
  glyph = next_glyph;
}

result = hb_glyf_serialize (serialized_glyf, context->serializer);
hb_glyf_destroy (serialized_glyf);
return result;