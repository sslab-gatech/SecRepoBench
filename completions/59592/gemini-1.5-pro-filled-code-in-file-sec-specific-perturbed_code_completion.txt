hb_vector_t<glyf_impl::SubsetGlyph> glyphs;
    bool result = _populate_subset_glyphs (context->plan, font, glyphs);

    if (font)
      hb_font_destroy (font);

    if (unlikely (!result))
      return_trace (false);

    unsigned total_size = 0;
    for (auto &glyph : glyphs)
      glyph.padded_offset = total_size += glyph.get_size ();

    bool use_short_loca = total_size < 65536 * 2;
    OT::glyf new_glyf;
    if (unlikely (!new_glyf.serialize (context->serializer, glyphs.iter (), use_short_loca, context->plan)))
    {
      _free_compiled_subset_glyphs (glyphs);
      return_trace (false);
    }

    _free_compiled_subset_glyphs (glyphs);