hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->glyphs.len)))
    {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    for (unsigned int i = 0; i < context->plan->glyphs.len; i++)
    {
      SubsetGlyph subset_glyph;
      if (!subset_glyph.compile (context->plan->glyphs[i], font))
      {
        if (font) hb_font_destroy (font);
        return_trace (false);
      }
      subset_glyphs.push (subset_glyph);
    }

    if (font) hb_font_destroy (font);

    // Calculate padded offsets and determine loca format
    bool use_short_loca = calculate_padded_offsets_and_loca_format (subset_glyphs);

    // Initialize glyf object
    glyf glyf_obj;
    if (!glyf_obj.init (context->serializer, use_short_loca))
    {
      for (auto &glyph : subset_glyphs)
        glyph.free_compiled_bytes ();
      return_trace (false);
    }

    // Serialize subset glyphs
    bool result = glyf_obj.serialize (subset_glyphs, use_short_loca);

    // Cleanup
    for (auto &glyph : subset_glyphs)
      glyph.free_compiled_bytes ();

    return result;