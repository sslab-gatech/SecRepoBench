bool result = true;

// Populate a list of subset glyphs based on the plan.
hb_set_t *subset_glyphs = context->plan->_glyphset_glyf;
if (!subset_glyphs || hb_set_is_empty (subset_glyphs))
{
  DEBUG_MSG (SUBSET, nullptr, "No glyphs to subset, dropping glyf table.");
  result = false;
  goto cleanup;
}

// Compile the subset glyphs so they can be serialized.
if (unlikely (!_compile_glyf_subset (context, subset_glyphs, font)))
{
  DEBUG_MSG (SUBSET, nullptr, "Failed to compile glyf subset.");
  result = false;
  goto cleanup;
}

// Determine if we can use a short loca table based on the compiled subset.
bool use_short_loca = _can_use_short_loca (context, subset_glyphs);

// Initialize a new glyf object for serialization.
auto *glyf_out = context->serializer->start_embed (*this);
if (unlikely (!glyf_out))
{
  result = false;
  goto cleanup;
}

// Serialize the subset of glyphs into the glyf object.
if (unlikely (!_serialize_glyf_subset (context, glyf_out, use_short_loca)))
{
  DEBUG_MSG (SUBSET, nullptr, "Failed to serialize glyf subset.");
  result = false;
  goto cleanup;
}

cleanup:
if (font)
  hb_font_destroy (font);

return_trace (result);