bool result = false;
    hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->glyphs.len)))
      goto cleanup;

    for (unsigned int i = 0; i < context->plan->glyphs.len; i++)
    {
      SubsetGlyph &subset_glyph = subset_glyphs[i];
      if (!subset_glyph.compile (context->plan->glyphs[i], font))
        goto cleanup;
    }

    if (font)
    {
      hb_font_destroy (font);
      font = nullptr;
    }

    // Calculate padded offsets and determine loca format
    bool use_short_loca = calculate_padded_offsets_and_loca_format(subset_glyphs);

    // Initialize glyf object
    Glyf glyf;
    if (!glyf.init (use_short_loca))
      goto cleanup;

    // Serialize subset glyphs
    if (!glyf.serialize (subset_glyphs, use_short_loca))
      goto cleanup;

    result = true;

cleanup:
    for (unsigned int i = 0; i < subset_glyphs.len; i++)
      subset_glyphs[i].free_compiled_bytes();

    if (font)
      hb_font_destroy (font);

    return result;