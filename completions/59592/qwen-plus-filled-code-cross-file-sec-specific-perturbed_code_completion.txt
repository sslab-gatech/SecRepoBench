bool result = false;

hb_blob_t *compiled_glyphs = hb_blob_create(nullptr, 0, HB_MEMORY_MODE_WRITABLE, nullptr, nullptr);
if (unlikely (!compiled_glyphs)) goto cleanup;

hb_vector_t<SubsetGlyph> subset_glyphs;
if (unlikely (!subset_glyphs.alloc (context->plan->glyphset->get_population (), true))) goto cleanup;

for (hb_codepoint_t glyph_id : *context->plan->glyphset)
{
  SubsetGlyph subset_glyph = get_subset_glyph(glyph_id, context->plan->source, font);
  if (unlikely (!subset_glyph.compile_to_bytes (compiled_glyphs))) goto cleanup;
  subset_glyphs.push (subset_glyph);
}

bool use_short_loca = calculate_short_loca_feasibility(subset_glyphs);

glyf glyf_prime;
glyf_prime.set_use_short_loca(use_short_loca);

if (unlikely (!glyf_prime.serialize_sub glyphs(context->serializer, subset_glyphs, compiled_glyphs)))
  goto cleanup;

result = true;

cleanup:
  for (auto &glyph : subset_glyphs) glyph.free_compiled_bytes();
  hb_blob_destroy(compiled_glyphs);
  if (font) hb_font_destroy(font);

return result;