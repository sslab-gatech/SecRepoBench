bool result = true;

hb_set_t *glyphset = context->plan->glyphset;
hb_map_t *glyph_map = context->plan->glyph_map;

hb_vector_t<hb_subset_glyph_t> subset_glyphs;
if (!context->plan->populate_subset_glyphs (glyphset, glyph_map, &subset_glyphs))
  return_trace (false);

if (font)
  hb_font_destroy (font);

hb_vector_t<unsigned> padded_offsets;
if (!context->plan->calculate_padded_offsets (subset_glyphs, &padded_offsets))
  return_trace (false);

bool use_short_loca = padded_offsets.last () <= 0xFFFFu;

hb_glyf_t *glyf_prime = context->serializer->start_glyf (use_short_loca);
if (unlikely (!glyf_prime)) return_trace (false);

for (unsigned i = 0; i < subset_glyphs.length; i++) {
  hb_subset_glyph_t *glyph = &subset_glyphs[i];
  if (!glyph->subset (context, glyf_prime, padded_offsets[i]))
    return_trace (false);
}

if (!context->plan->cleanup_compiled_subset_glyphs (subset_glyphs))
  return_trace (false);

return_trace (result);