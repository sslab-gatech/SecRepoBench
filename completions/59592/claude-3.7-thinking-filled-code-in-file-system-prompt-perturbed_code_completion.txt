hb_vector_t<glyf_impl::SubsetGlyph> glyphs;
if (unlikely (!_populate_subset_glyphs (context->plan, font, glyphs)))
{
  if (font) hb_font_destroy (font);
  return_trace (false);
}

if (font)
  hb_font_destroy (font);

// Calculate if we can use short loca
bool use_short_loca = true;
unsigned int glyph_size = 0;
for (unsigned int i = 0; i < glyphs.length; i++)
{
  glyph_size += glyphs[i].padded_size ();
  if (unlikely (glyph_size > 0x1FFFF))
    use_short_loca = false;
}

// Create a new glyf table object for serialization
glyf *glyf_prime = context->serializer->start_embed<glyf> ();
if (unlikely (!glyf_prime)) {
  _free_compiled_subset_glyphs (glyphs);
  return_trace (false);
}

// Serialize the subset glyphs
bool result = glyf_prime->serialize (context->serializer,
                                    hb_iter (glyphs),
                                    use_short_loca,
                                    context->plan);

_free_compiled_subset_glyphs (glyphs);