hb_vector_t<glyf_impl::SubsetGlyph> glyphs;
    bool result = _populate_subset_glyphs (context->plan, font, glyphs);

    if (font)
      hb_font_destroy (font);

    if (unlikely (!result))
      return_trace (false);

    unsigned total_size = 0;
    for (auto &glyph : glyphs)
    {
      glyph.padded_offset = total_size;
      total_size += glyph.get_size ();
    }

    bool use_short_loca = total_size < 65536 * 2;
    unsigned loca_size = (glyphs.length + 1) * (use_short_loca ? 2 : 4);

    OT::glyf *glyf_prime = c->start_embed<OT::glyf> ();
    if (unlikely (!glyf_prime))
    {
      _free_compiled_subset_glyphs (glyphs);
      return_trace (false);
    }

    result = glyf_prime->serialize (c, glyphs.iter (), use_short_loca, context->plan);

    if (!plan->pinned_at_default)
      _free_compiled_subset_glyphs (glyphs);