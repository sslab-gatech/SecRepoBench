hb_vector_t<char> glyf_prime;
    bool result = _populate_subset_glyphs (context->plan, font, &glyf_prime);
    if (font)
      hb_font_destroy (font);

    if (!result)
      return_trace (false);

    unsigned int num_glyphs = context->plan->num_output_glyphs ();
    hb_vector_t<hb_codepoint_t> subset_glyphs;
    if (unlikely (!subset_glyphs.resize (num_glyphs)))
      return_trace (false);

    for (unsigned i = 0; i < num_glyphs; i++)
      subset_glyphs[i] = i;

    hb_vector_t<unsigned> padded_offsets;
    bool use_short_loca = _calculate_padded_offsets (context->plan, glyf_prime, &padded_offsets);

    hb_serialize_context_t serializer (glyf_prime.arrayZ, glyf_prime.length);
    glyf *glyf_prime_obj = serializer.start_serialize<glyf> ();
    if (!glyf_prime_obj)
      return_trace (false);

    result = _serialize_subset_glyphs (context->plan, subset_glyphs, padded_offsets, use_short_loca, &serializer);
    if (!result)
      return_trace (false);

    serializer.end_serialize ();

    for (unsigned i = 0; i < num_glyphs; i++)
      if (context->plan->glyphs_retained->has (i))
        context->plan->glyphs_retained->get (i).free_compiled_bytes ();