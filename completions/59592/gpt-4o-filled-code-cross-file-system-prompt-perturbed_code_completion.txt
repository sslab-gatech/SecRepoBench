bool result = false;
    hb_set_t *subset_glyphs = hb_set_create();
    if (!subset_glyphs) {
      if (font) hb_font_destroy(font);
      return_trace(false);
    }

    if (!context->plan->collect_subset_glyphs(subset_glyphs, font)) {
      hb_set_destroy(subset_glyphs);
      if (font) hb_font_destroy(font);
      return_trace(false);
    }

    if (font) hb_font_destroy(font);

    hb_vector_t padded_offsets;
    if (!calculate_padded_offsets(subset_glyphs, &padded_offsets)) {
      hb_set_destroy(subset_glyphs);
      return_trace(false);
    }

    bool use_short_loca = determine_short_loca(padded_offsets);

    glyf_object_t *glyf = glyf_object_create();
    if (!glyf) {
      hb_set_destroy(subset_glyphs);
      return_trace(false);
    }

    result = serialize_glyphs_to_glyf(subset_glyphs, glyf, use_short_loca);

    hb_set_destroy(subset_glyphs);
    glyf_object_destroy(glyf);

    return_trace(result);