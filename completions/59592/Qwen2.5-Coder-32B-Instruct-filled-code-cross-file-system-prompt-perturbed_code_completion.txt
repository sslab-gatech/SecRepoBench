hb_vector_t<hb_codepoint_t> subset_glyphs;
    if (!populate_subset_glyphs(context, font, subset_glyphs))
      return_trace (false);

    if (font)
      hb_font_destroy (font);

    hb_vector_t<unsigned> padded_offsets;
    bool use_short_loca = calculate_padded_offsets(subset_glyphs, padded_offsets);

    glyf glyf_prime;
    if (!glyf_prime.init(context->serializer, use_short_loca))
      return_trace (false);

    bool result = serialize_subset_glyphs(context, subset_glyphs, padded_offsets, glyf_prime);
    if (!result)
      return_trace (false);

    for (auto &glyph : subset_glyphs)
      glyf_prime.free_compiled_bytes(glyph);

    return_trace (result);