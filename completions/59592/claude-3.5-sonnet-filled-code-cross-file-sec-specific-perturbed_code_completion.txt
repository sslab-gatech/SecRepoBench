hb_vector_t<glyf_impl::SubsetGlyph> subset_glyphs;
if (!_populate_subset_glyphs (context->plan, font, subset_glyphs))
{
  hb_font_destroy (font);
  return_trace (false);
}

hb_font_destroy (font);

_calculate_glyf_and_loca_sizes (subset_glyphs,
                                &context->serializer->glyf_length,
                                &context->serializer->loca_length,
                                &context->serializer->use_short_loca);

glyf_impl::accelerator_t glyf;
glyf.init (context->plan->source);
glyf_impl::glyf_serialize_context_t glyf_ctx;
glyf_ctx.start_serialize (context->serializer);

bool result = _serialize_glyf_and_loca (glyf,
                                        context->plan,
                                        subset_glyphs,
                                        context->serializer->use_short_loca,
                                        glyf_ctx);

glyf_ctx.end_serialize ();
glyf.fini ();

_free_compiled_subset_glyphs (subset_glyphs);