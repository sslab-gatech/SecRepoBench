hb_subset_glyphs_t subset_glyphs;
if (unlikely (!_compile_subset_glyphs (context->plan, font, &subset_glyphs)))
  return_trace (false);

hb_destroy (font);

hb_vector_t<unsigned> padded_offsets;
if (unlikely (!_calculate_padded_offsets (subset_glyphs, &padded_offsets)))
  return_trace (false);

bool use_short_loca = padded_offsets.last () <= 0xFFFF;

glyf_t *glyf_prime = context->serializer->start_embed<glyf_t> ();
if (unlikely (!glyf_prime))
  return_trace (false);

bool result = _serialize_subset_glyphs (context->serializer, glyf_prime, subset_glyphs, padded_offsets, use_short_loca);
_free_compiled_subset_glyphs (subset_glyphs);
return_trace (result);