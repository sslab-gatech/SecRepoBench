hb_subset_glyphs_t *subset_glyphs = nullptr;
bool result = false;

subset_glyphs = _compile_subset_glyphs (context, font);
if (unlikely (!subset_glyphs))
  goto done;

hb_glyph_extents_t *extents = _calculate_glyph_extents (subset_glyphs);
if (unlikely (!extents))
  goto done;

bool use_short_loca = _calculate_padded_offsets (subset_glyphs, extents);
if (unlikely (!use_short_loca))
  goto done;

hb_glyf_t *glyf = _create_glyf (context->plan->source, use_short_loca);
if (unlikely (!glyf))
  goto done;

result = _serialize_subset_glyphs (glyf, subset_glyphs, use_short_loca);

done:
if (font)
  hb_font_destroy (font);
if (subset_glyphs)
  _free_compiled_subset_glyphs (subset_glyphs);
if (extents)
  _free_glyph_extents (extents);
if (glyf)
  _destroy_glyf (glyf);