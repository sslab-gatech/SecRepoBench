hb_vector_t<glyf_impl::SubsetGlyph> glyphs;
    bool result = _populate_subset_glyphs (context->plan, font, glyphs);
    if (unlikely (!result))
    {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    bool use_short_loca = true;
    for (auto &g : glyphs)
    {
      g.padded_offset = context->plan->padded_offset_for_glyph (g.source_glyph.get_length ());
      if (g.padded_offset > 0xFFFFu) use_short_loca = false;
    }

    OT::glyf new_glyf;
    result = new_glyf.serialize (context->serializer, glyphs.iter (), use_short_loca, context->plan);

    if (font) hb_font_destroy (font);
    _free_compiled_subset_glyphs (glyphs);