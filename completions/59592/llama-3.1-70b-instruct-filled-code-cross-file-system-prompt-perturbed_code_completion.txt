hb_subset_glyphs_t *glyphs = hb_subset_glyphs_create ();
if (unlikely (!glyphs))
  return_trace (false);

if (!populate_subset_glyphs (context, glyphs, font))
  return_trace (false);

if (font)
  hb_font_destroy (font);

hb_glyph_extents_t *extents = hb_glyph_extents_create ();
if (unlikely (!extents))
  return_trace (false);

bool use_short_loca = true;
unsigned int padded_offset = 0;
for (unsigned int i = 0; i < glyphs->len; i++) {
  hb_glyph_t glyph = glyphs->glyphs[i];
  if (unlikely (!hb_glyph_extents_get (extents, glyph, &padded_offset)))
    return_trace (false);
  if (padded_offset >= 0x10000)
    use_short_loca = false;
}

hb_glyph_extents_destroy (extents);

hb_glyf_t *glyf = hb_glyf_create (use_short_loca);
if (unlikely (!glyf))
  return_trace (false);

if (!serialize_subset_glyphs (context, glyf, glyphs))
  return_trace (false);

hb_subset_glyphs_destroy (glyphs);

bool result = hb_glyf_serialize (glyf, context->serializer);
hb_glyf_destroy (glyf);

return_trace (result);