bool result = false;
    std::vector<hb_codepoint_t> subset_glyphs;
    if (!generate_subset_glyphs (context, &subset_glyphs))
      goto cleanup;

    hb_array_t<hb_offset_t> padded_offsets;
    bool short_loca = false;
    if (!calculate_padded_offsets (context, subset_glyphs, &padded_offsets, &short_loca))
      goto cleanup;

    glyf *subset_glyf = new glyf;
    if (unlikely (!subset_glyf))
      goto cleanup;

    result = subset_glyf->serialize (context, subset_glyphs, padded_offsets, short_loca);
    if (unlikely (!result))
      goto cleanup;

    *this = std::move (*subset_glyf);
    delete subset_glyf;
    goto cleanup;

  cleanup:
    if (font)
      hb_font_destroy (font);

    free_compiled_bytes ();