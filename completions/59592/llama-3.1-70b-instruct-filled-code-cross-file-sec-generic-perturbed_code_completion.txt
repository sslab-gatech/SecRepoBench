bool result = true;

hb_vector_t<const hb_subset_glyph_t*> subset_glyphs;
if (unlikely (!_populate_subset_glyphs (context, &subset_glyphs)))
  return_trace (false);

if (font)
  hb_font_destroy (font);

hb_vector_t<hb_uint32_t> padded_offsets;
if (unlikely (!_calculate_padded_offsets (subset_glyphs, &padded_offsets)))
  return_trace (false);

bool use_short_loca = _can_use_short_loca (padded_offsets);

glyf glyf_prime;
if (unlikely (!glyf_prime.init (context->serializer, use_short_loca)))
  return_trace (false);

if (unlikely (!_serialize_subset_glyphs (context, glyf_prime, subset_glyphs, padded_offsets)))
  return_trace (false);

for (auto glyph : subset_glyphs)
  glyph->free_compiled_bytes ();

return_trace (result);