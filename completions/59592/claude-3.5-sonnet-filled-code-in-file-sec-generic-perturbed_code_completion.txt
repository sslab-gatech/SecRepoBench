hb_vector_t<glyf_impl::SubsetGlyph> glyphs;
if (unlikely (!_populate_subset_glyphs (context->plan, font, glyphs)))
{
  hb_font_destroy (font);
  return_trace (false);
}

hb_font_destroy (font);

unsigned int glyf_prime_size;
glyf_prime_size = 0;
for (unsigned int i = 0; i < glyphs.length; i++)
  glyf_prime_size += glyphs[i].padded_size ();

bool use_short_loca = glyf_prime_size < 131072;

glyf *glyf_prime = context->serializer->start_embed <glyf> ();
bool result = glyf_prime->serialize (context->serializer,
                                     glyphs.iter (),
                                     use_short_loca,
                                     context->plan);

if (context->plan->pinned_at_default)
  _free_compiled_subset_glyphs (glyphs);