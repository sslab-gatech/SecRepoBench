bool result = true;
hb_vector_t<hb_codepoint_t> subset_glyphs;
if (unlikely (!_get_subset_glyphs (context->plan, &subset_glyphs)))
  return_trace (false);

hb_vector_t<hb_codepoint_t> compiled_subset_glyphs;
if (unlikely (!_compile_subset_glyphs (subset_glyphs, &compiled_subset_glyphs)))
  return_trace (false);

hb_vector_t<unsigned> padded_offsets;
if (unlikely (!_calculate_padded_offsets (compiled_subset_glyphs, &padded_offsets)))
  return_trace (false);

bool use_short_loca = _can_use_short_loca (padded_offsets);
glyf *glyf_prime = context->serializer->start_embed<glyf> ();
if (unlikely (!glyf_prime))
  return_trace (false);

if (unlikely (!_serialize_subset_glyphs (compiled_subset_glyphs, padded_offsets, use_short_loca, glyf_prime)))
  return_trace (false);

if (font)
  hb_font_destroy (font);

for (auto glyph : compiled_subset_glyphs)
  glyph.free_compiled_bytes ();

return_trace (result);