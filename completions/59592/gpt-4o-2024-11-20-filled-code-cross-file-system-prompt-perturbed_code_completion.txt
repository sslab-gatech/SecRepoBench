hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->num_output_glyphs ())))
    {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    for (hb_codepoint_t gid : context->plan->glyphs ())
    {
      SubsetGlyph subset_glyph;
      if (unlikely (!subset_glyph.compile (context->plan, font, gid)))
      {
        if (font) hb_font_destroy (font);
        subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });
        return_trace (false);
      }
      subset_glyphs.push (std::move (subset_glyph));
    }

    if (font) hb_font_destroy (font);

    hb_vector_t<unsigned> padded_offsets;
    bool short_loca = false;
    if (unlikely (!calculate_padded_offsets_and_loca_format (subset_glyphs, padded_offsets, short_loca)))
    {
      subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });
      return_trace (false);
    }

    glyf *glyf_prime = context->serializer->start_embed<glyf> ();
    if (unlikely (!glyf_prime))
    {
      subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });
      return_trace (false);
    }

    bool result = glyf_prime->serialize (context->serializer, subset_glyphs, padded_offsets, short_loca);
    subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });