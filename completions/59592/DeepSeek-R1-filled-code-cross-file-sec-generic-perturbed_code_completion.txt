hb_vector_t<glyf_impl::SubsetGlyph> subset_glyphs;
    if (!_populate_subset_glyphs(context, font, subset_glyphs))
      return_trace (false);

    if (font)
      hb_font_destroy (font);

    hb_vector_t<unsigned int> padded_offsets;
    unsigned max_offset = subset_glyphs.get_padded_offsets (&padded_offsets);
    bool use_short_loca = _should_write_short_loca (max_offset);

    auto *new_glyf = context->serializer->start_embed<glyf> ();
    if (unlikely (!context->serializer->extend_min (new_glyf))) return_trace (false);

    bool result = new_glyf->serialize (context->serializer,
                                      subset_glyphs,
                                      padded_offsets,
                                      use_short_loca,
                                      context->plan->flags);

    if (context->plan->flags & HB_SUBSET_FLAGS_RETAIN_GIDS) {
      for (auto &subset_glyph : subset_glyphs)
        subset_glyph.compiled.free ();
    }

    return_trace (result);