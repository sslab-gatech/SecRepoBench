auto subset_glyphs = SubsetGlyph::compile (context, font);
    if (subset_glyphs.in_error ()) {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    if (font)
      hb_font_destroy (font);

    hb_vector_t<unsigned> offsets;
    if (!subset_glyphs.get_padded_offsets (&offsets))
      return_trace (false);

    bool use_short_loca = (offsets[offsets.length - 1] + 1) <= 0x20000;

    glyf *glyf_prime = context->serializer->start_embed<glyf> ();
    if (!glyf_prime)
      return_trace (false);

    bool result = subset_glyphs.serialize (context->serializer,
                                           offsets,
                                           use_short_loca);

    for (auto &glyph : subset_glyphs)
      glyph.free_compiled_bytes ();

    return_trace (result);