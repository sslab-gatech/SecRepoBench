hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->num_glyphs ())))
    {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    for (unsigned gid : context->plan->glyphs)
    {
      SubsetGlyph subset_glyph;
      if (unlikely (!subset_glyph.compile (context->plan, font, gid)))
      {
        if (font) hb_font_destroy (font);
        subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });
        return_trace (false);
      }
      subset_glyphs.push (std::move (subset_glyph));
    }

    if (font) hb_font_destroy (font);

    hb_vector_t<unsigned> padded_offsets;
    bool use_short_loca = false;
    if (unlikely (!SubsetGlyph::calculate_padded_offsets (subset_glyphs, padded_offsets, use_short_loca)))
    {
      subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });
      return_trace (false);
    }

    glyf *glyf_obj = context->serializer->start_embed<glyf> ();
    if (unlikely (!glyf_obj))
    {
      subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });
      return_trace (false);
    }

    bool result = glyf_obj->serialize (context->serializer, subset_glyphs, padded_offsets, use_short_loca);
    subset_glyphs.for_each ([](SubsetGlyph &g) { g.free_compiled_bytes (); });