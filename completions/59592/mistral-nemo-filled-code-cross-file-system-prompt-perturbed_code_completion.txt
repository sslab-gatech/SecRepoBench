std::vector<hb_codepoint_t> subset_glyphs;
    for (auto glyph : context->plan->glyphs) {
      if (!subset_glyph(context, font, glyph, subset_glyphs)) {
        return_trace(false);
      }
    }

    if (font) {
      hb_font_destroy(font);
    }

    bool use_short_loca = true;
    for (auto glyph : subset_glyphs) {
      if (glyph->num_contours > 0xFFFF) {
        use_short_loca = false;
        break;
      }
    }

    hb_glyf_t *glyf = hb_glyf_create();
    if (!glyf) {
      return_trace(false);
    }

    if (!hb_glyf_serialize_glyphs(glyf, subset_glyphs, use_short_loca)) {
      hb_glyf_destroy(glyf);
      return_trace(false);
    }

    // Cleanup resources if required
    for (auto glyph : subset_glyphs) {
      hb_glyph_free(glyph);
    }

    return true;