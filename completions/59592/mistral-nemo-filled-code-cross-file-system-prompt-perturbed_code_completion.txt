hb_vector_t<hb_codepoint_t> glyphs;
    if (unlikely (!glyphs.alloc (context->plan->glyphs.get_length (), true)))
      return_trace (false);

    for (auto _ : context->plan->glyphs)
      glyphs.push (_);

    hb_glyph_info_t *glyph_info = nullptr;
    if (unlikely (!glyph_info = hb_font_get_glyph_info (font, glyphs.arrayZ, glyphs.get_length ())))
      return_trace (false);

    hb_vector_t<hb_glyph_position_t> positions;
    if (unlikely (!positions.alloc (glyphs.get_length (), true)))
      return_trace (false);

    if (unlikely (!hb_font_get_glyph_positions (font, glyphs.arrayZ, glyphs.get_length (), &positions)))
      return_trace (false);

    hb_vector_t<hb_glyph_t> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (glyphs.get_length (), true)))
      return_trace (false);

    for (unsigned i = 0; i < glyphs.get_length (); ++i)
      subset_glyphs.push (hb_glyph_t (glyphs[i], glyph_info[i].codepoint));

    if (font)
      hb_font_destroy (font);

    hb_glyf_t *glyf = nullptr;
    if (unlikely (!glyf = hb_glyf_create (subset_glyphs.arrayZ, subset_glyphs.get_length ())))
      return_trace (false);

    if (unlikely (!glyf->serialize (context->serializer, context->plan->normalized_coords)))
      return_trace (false);

    free_compiled_bytes ();

    return_trace (true);