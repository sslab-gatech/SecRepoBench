hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->num_glyphs ())))
    {
      if (font) hb_font_destroy (font);
      return_trace (false);
    }

    for (unsigned gid = 0; gid < context->plan->num_glyphs (); gid++)
    {
      if (!subset_glyphs[gid].compile (context->plan, font, gid))
      {
        for (unsigned i = 0; i < gid; i++)
          subset_glyphs[i].free_compiled_bytes ();
        if (font) hb_font_destroy (font);
        return_trace (false);
      }
    }

    if (font) hb_font_destroy (font);

    hb_vector_t<unsigned> padded_offsets;
    bool use_short_loca = false;
    if (unlikely (!calculate_padded_offsets_and_loca (subset_glyphs, padded_offsets, use_short_loca)))
    {
      for (unsigned i = 0; i < context->plan->num_glyphs (); i++)
        subset_glyphs[i].free_compiled_bytes ();
      return_trace (false);
    }

    glyf *glyf_obj = context->serializer->start_embed<glyf> ();
    if (unlikely (!glyf_obj))
    {
      for (unsigned i = 0; i < context->plan->num_glyphs (); i++)
        subset_glyphs[i].free_compiled_bytes ();
      return_trace (false);
    }

    bool result = glyf_obj->serialize (context->serializer, subset_glyphs, padded_offsets, use_short_loca);

    for (unsigned i = 0; i < context->plan->num_glyphs (); i++)
      subset_glyphs[i].free_compiled_bytes ();