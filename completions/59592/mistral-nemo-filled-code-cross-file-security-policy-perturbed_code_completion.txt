// <MASK>
    std::vector<hb_codepoint_t> subset_glyphs;
    if (!generate_subset_glyphs(context->plan, font, &subset_glyphs)) {
      return_trace(false);
    }

    if (font) {
      _destroy_font(font);
    }

    bool use_short_loca = determine_short_loca(subset_glyphs);
    hb_glyph_info_t *glyph_info = hb_glyph_info_create(subset_glyphs.size());
    if (!glyph_info) {
      return_trace(false);
    }

    hb_glyph_info_t *glyph_info_end = glyph_info;
    for (auto glyph : subset_glyphs) {
      *glyph_info_end++ = hb_glyph_info_t{glyph, 0, 0};
    }

    hb_glyph_storage_t *glyph_storage = hb_glyph_storage_create_for_glyphs(glyph_info, glyph_info_end);
    if (!glyph_storage) {
      hb_glyph_info_destroy(glyph_info);
      return_trace(false);
    }

    hb_glyph_storage_serialize(glyph_storage, use_short_loca, &result);
    hb_glyph_storage_destroy(glyph_storage);

    if (result.is_valid()) {
      _free_compiled_subset_glyphs(subset_glyphs);
    }

    return result.is_valid();