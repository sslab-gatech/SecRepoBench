bool result = false;
    std::vector<hb_codepoint_t> subset_glyphs;
    if (!get_subset_glyphs (context, &subset_glyphs))
      goto cleanup;

    hb_vector_t<hb_glyph_info_t> subset_glyph_infos;
    if (unlikely (!subset_glyph_infos.alloc (subset_glyphs.size ())))
      goto cleanup;

    for (size_t i = 0; i < subset_glyphs.size (); i++)
    {
      hb_glyph_info_t info;
      info.codepoint = subset_glyphs[i];
      info.mask = 0;
      subset_glyph_infos.push (info);
    }

    hb_vector_t<hb_glyph_position_t> subset_glyph_positions;
    if (unlikely (!subset_glyph_positions.alloc (subset_glyphs.size ())))
      goto cleanup;

    for (size_t i = 0; i < subset_glyphs.size (); i++)
    {
      hb_glyph_position_t pos;
      pos.x_offset = 0;
      pos.y_offset = 0;
      pos.x_advance = 0;
      pos.y_advance = 0;
      subset_glyph_positions.push (pos);
    }


    hb_array_t<unsigned> padded_offsets;
    bool short_loca = false;
    if (!calculate_padded_offsets (subset_glyph_infos.arrayZ, subset_glyph_infos.length (), &padded_offsets, &short_loca))
      goto cleanup;

    glyf *subset_glyf = new glyf (context->plan->source, short_loca);
    if (unlikely (!subset_glyf))
      goto cleanup;

    if (!subset_glyf->serialize (context->serializer, subset_glyph_infos.arrayZ, subset_glyph_infos.length (),
				 padded_offsets.arrayZ, padded_offsets.length ()))
      goto cleanup_subset_glyf;

    result = true;

  cleanup_subset_glyf:
    delete subset_glyf;

  cleanup:
    if (font)
      hb_font_destroy (font);