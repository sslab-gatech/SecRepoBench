bool subset_glyphs (hb_subset_context_t *context)
{
  hb_codepoint_t *glyph_ids = nullptr;
  unsigned int num_glyphs = 0;
  if (!hb_subset_plan_create_glyph_list (context->plan, &glyph_ids, &num_glyphs))
    return_trace (false);

  hb_glyf_accelerator_t glyf (context->plan->source);
  hb_glyf_accelerator_t::glyph_snapshot_t *snapshots = nullptr;
  if (!glyf.create_glyph_snapshots (glyph_ids, num_glyphs, &snapshots))
    return_trace (false);

  hb_serialize_context_t serializer;
  hb_glyf_table_t *new_glyf = serializer.start_serialize<hb_glyf_table_t> ();
  if (!new_glyf->serialize (serializer, context, glyph_ids, num_glyphs, snapshots, font))
  {
    serializer.cancel_serialize ();
    return_trace (false);
  }

  serializer.end_serialize ();
  hb_blob_t *new_glyf_blob = serializer.copy_blob ();

  bool result = context->plan->add_table (HB_OT_TAG_glyf, new_glyf_blob);
  hb_blob_destroy (new_glyf_blob);

  hb_glyf_accelerator_t::glyph_snapshot_t::destroy (snapshots, num_glyphs);
  hb_free (glyph_ids);

  return result;
}