hb_vector_t<SubsetGlyph> subset_glyphs;
if (!_populate_subset_glyphs (context->plan, font, &subset_glyphs))
{
  hb_font_destroy (font);
  return_trace (false);
}

hb_font_destroy (font);

unsigned int glyf_prime_size;
unsigned int loca_prime_size;
bool use_short_loca;
if (!_calculate_glyf_and_loca_prime_size (subset_glyphs,
                                          &glyf_prime_size,
                                          &loca_prime_size,
                                          &use_short_loca))
  return_trace (false);

glyf *glyf_prime = context->serializer->start_embed<glyf> ();
if (unlikely (!glyf_prime)) return_trace (false);

if (!_serialize_glyf_and_loca (glyf_prime,
                               context->serializer,
                               subset_glyphs,
                               use_short_loca,
                               glyf_prime_size,
                               loca_prime_size))
{
  for (unsigned int i = 0; i < subset_glyphs.length; i++)
    subset_glyphs[i].free_compiled_bytes ();
  return_trace (false);
}

for (unsigned int i = 0; i < subset_glyphs.length; i++)
  subset_glyphs[i].free_compiled_bytes ();

bool result = true;