bool result = false;

// Build subset glyph list using context->plan and font (if not null).
hb_vector_t<SubsetGlyph> subset_glyphs;
if (unlikely (!build_subset_glyph_list (context->plan, font, subset_glyphs)))
{
  if (font) hb_font_destroy (font);
  return_trace (false);
}

// Determine if short loca can be used based on subset glyphs.
bool use_short_loca = can_use_short_loca (subset_glyphs);

// Initialize a glyf object for serialization.
glyf *glyf_prime = context->serializer->start_embed<glyf> ();
if (unlikely (!glyf_prime)))
{
  // Clean up font if it was created.
  if (font) hb_font_destroy (font);
  return_trace (false);
}

// Serialize the subset of glyphs into the glyf object.
if (unlikely (!glyf_prime->serialize (context->serializer, subset_glyphs, use_short_loca)))
{
  if (font) hb_font_destroy (font);
  return_trace (false);
}

// Clean up any compiled glyph data if needed.
for (auto &g : subset_glyphs)
{
  g.free_compiled_bytes ();
}

// Destroy the font if it was created for instancing.
if (font)
  hb_font_destroy (font);

// If we reach here, everything succeeded.
result = true;