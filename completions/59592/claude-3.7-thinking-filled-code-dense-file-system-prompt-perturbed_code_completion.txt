bool result = false;

hb_vector_t<glyf_impl::SubsetGlyph> subset_glyphs;
if (!_populate_subset_glyphs (context->plan, font, subset_glyphs))
{
  if (font) hb_font_destroy (font);
  return_trace (false);
}

if (font)
  hb_font_destroy (font);

unsigned int glyf_prime_size;
bool use_short_loca;
if (!_calculate_glyf_and_loca_prime_size (subset_glyphs,
                                         &glyf_prime_size,
                                         &use_short_loca))
  return_trace (false);

glyf *glyf_prime = context->serializer->start_embed<glyf> ();
if (unlikely (!glyf_prime || !glyf_prime_size))
  return_trace (false);

result = _serialize_glyf_and_loca (subset_glyphs,
                                  use_short_loca,
                                  context->serializer,
                                  glyf_prime,
                                  glyf_prime_size);

// Clean up compiled subset glyphs if needed
_free_compiled_subset_glyphs (subset_glyphs);