hb_vector_t<SubsetGlyph> subset_glyphs;
    if (unlikely (!subset_glyphs.alloc (context->plan->num_output_glyphs, true)))
    {
      if (font)
        hb_font_destroy (font);
      return_trace (false);
    }

    for (unsigned int i = 0; i < context->plan->num_output_glyphs; ++i)
    {
      unsigned int glyph_id = context->plan->output_to_input[i];
      SubsetGlyph sglyph (this, glyph_id, font);
      if (unlikely (!sglyph.compile (context->plan)))
      {
        if (font)
          hb_font_destroy (font);
        return_trace (false);
      }
      subset_glyphs.push (sglyph);
    }

    if (font)
      hb_font_destroy (font);

    unsigned int offset = 0;
    bool short_loca = true;
    for (auto &sglyph : subset_glyphs)
    {
      sglyph.padded_offset = offset;
      offset += sglyph.compiled.length;
      if (sglyph.padded_offset > 0xFFFF)
        short_loca = false;
      offset += sglyph.padding;
    }

    glyf *glyf_prime = context->serializer->start_embed<glyf> ();
    if (unlikely (!glyf_prime))
    {
      return_trace (false);
    }

    bool result = glyf_prime->serialize (context->serializer, subset_glyphs, short_loca);

    for (auto &sglyph : subset_glyphs)
      sglyph.free_compiled_bytes ();