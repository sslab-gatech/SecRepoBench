hb_vector_t<SubsetGlyph> subset_glyphs;

if (unlikely (!subset_glyphs.alloc (context->plan->num_output Glyphs, true)))
  return_trace (false);

for (unsigned int i = 0; i < context->plan->num_output_glyphs; i++) {
  hb_codepoint_t glyph_id = context->plan->output_glyph_set.get_nth (i);
  SubsetGlyph sg;
  sg.compile (this, font, glyph_id);
  if (unlikely (!sg)) {
    subset_glyphs.fini ();
    if (font) hb_font_destroy (font);
    return_trace (false);
  }
  subset_glyphs.push (sg);
}

if (font) hb_font_destroy (font);

bool short_loca = true;
for (auto& sg : subset_glyphs) {
  if (sg.padded_size () > 0xFFFF) {
    short_loca = false;
    break;
  }
}

glyf glyf_prime;
glyf_prime.shortloca = short_loca;

for (auto& sg : subset_glyphs) {
  if (unlikely (!glyf_prime.serialize_subset_glyph (context->serializer, sg))) {
    subset_glyphs.fini ();
    return_trace (false);
  }
}

for (auto& sg : subset_glyphs) sg.free_compiled_bytes();
subset_glyphs.fini ();

return_trace (glyf_prime.serialize (context->serializer));