hb_vector_t<glyf_impl::SubsetGlyph> subset_glyphs;
if (!_populate_subset_glyphs (context->plan, font, subset_glyphs))
{
  hb_font_destroy (font);
  return_trace (false);
}

hb_font_destroy (font);

unsigned int max_offset = _calculate_glyf_size (subset_glyphs);
bool use_short_loca = max_offset < 0x1FFFF;

glyf_impl::accelerator_t glyf;
glyf.instance_coords = context->plan->normalized_coords;
glyf.num_coords = context->plan->num_coords;

bool result = glyf.serialize (context->serializer,
                              context->plan,
                              subset_glyphs.as_array (),
                              use_short_loca);

_free_compiled_subset_glyphs (subset_glyphs);