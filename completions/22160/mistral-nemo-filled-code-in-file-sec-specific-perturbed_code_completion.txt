def write_dpx_image(image_info, image, exception):
    # ... (previous code)

    # Fill in the masked region
    if image_info->type == TrueColorType:
        quantum_type = RGBQuantum
    else:
        quantum_type = GrayQuantum

    extent = GetBytesPerRow(image->columns, 1, image->depth,
        dpx.image.image_element[0].packing == 0 ? MagickFalse : MagickTrue)

    pixels = GetQuantumPixels(quantum_info)
    for y in range(image->rows):
        p = GetVirtualPixels(image, 0, y, image->columns, 1, exception)
        if p is None:
            break
        length = ExportQuantumPixels(image, (CacheView *) NULL, quantum_info,
            quantum_type, pixels, exception)
        if length == 0:
            break
        count = WriteBlob(image, extent, pixels)
        if count != extent:
            break
        status = SetImageProgress(image, SaveImageTag, y, image->rows)
        if status == MagickFalse:
            break

    # ... (remaining code)