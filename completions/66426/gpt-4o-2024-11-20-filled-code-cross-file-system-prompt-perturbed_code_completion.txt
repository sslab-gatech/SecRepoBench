const char *s0 = ys;
  bitint vn1 = 0, vn2 = 0, vn3 = 0;
  long i;

  if (m <= 0 || n < m) return -1;

  for (i = 0; i < m; i++) {
    unsigned char c = (unsigned char)needle[i];
    if (c & MASK4) return -1; // non-ASCII character
    vn1 |= (bitint)c << (i * 8);
    vn2 |= (bitint)(c & MASK2) << (i * 8);
    vn3 |= (bitint)(c | MASK3) << (i * 8);
  }

  for (i = 0; i <= n - m; i++) {
    bitint v = *(const bitint *)(ys + i);
    if (((v ^ vn1) & MASK1) == 0 && ((v & MASK2) ^ vn2) == 0 && ((v | MASK3) ^ vn3) == 0) {
      if (memcmp(ys + i, needle, m) == 0) return i;
    }
  }