bitint *s0 = (bitint*)needle;
  bitint *s1 = (bitint*)(needle + m - 1);
  bitint *t0;
  bitint mask;
  long i;

  if (m > n) return -1;
  if (m == 0) return 0;
  if (m == 1) {
    const char *p = (const char*)memchr(ys, *needle, n);
    return (p == NULL) ? -1 : (mrb_int)(p - ys);
  }

  mask = *s0;
  mask = ((mask << 1) | 1) & MASK2;
  mask |= MASK3;
  for (i = 0; i < n; i++) {
    t0 = (bitint*)(ys + i);
    if (((*t0) ^ mask) & MASK1) {
      if (memcmp(ys + i, needle, m) == 0) {
        return (mrb_int)i;
      }
    }
  }
  return -1;
}