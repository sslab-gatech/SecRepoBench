if (m <= 0) return -1;
  if (m == 1) {
    const char *p = (const char*)memchr(ys, needle[0], n);
    return p ? (mrb_int)(p - ys) : -1;
  }

  const bitint c0 = needle[0];
  const bitint c0mask = c0 * MASK1;
  const char *s = ys;
  const char *const end = ys + n - m + 1;

  while (s <= end - sizeof(bitint)) {
    bitint chunk;
    memcpy(&chunk, s, sizeof(bitint));
    bitint matches = ((chunk ^ c0mask) - MASK1) & (~(chunk ^ c0mask)) & MASK3;

    while (matches) {
      bitint match = matches & -matches;
      int shift;
#ifdef MRB_64BIT
      shift = __builtin_ctzll(match);
#else
      shift = __builtin_ctz(match);
#endif
      int byte_pos = shift / 8;
#if defined(MRB_ENDIAN_BIG)
      byte_pos = (sizeof(bitint) - 1) - byte_pos;
#endif
      const char *candidate = s + byte_pos;
      if (candidate + m <= ys + n) {
        if (memcmp(candidate + 1, needle + 1, m - 1) == 0) {
          return (mrb_int)(candidate - ys);
        }
      }
      matches ^= match;
    }
    s += sizeof(bitint);
  }

  while (s < end) {
    if (*s == c0 && memcmp(s + 1, needle + 1, m - 1) == 0) {
      return (mrb_int)(s - ys);
    }
    s++;
  }