bitint mask = 0;
  for (int i = 0; i < m; i++) {
    mask |= (bitint)needle[i] << (i * 8);
  }

  bitint mask1 = MASK1 * mask;
  bitint mask2 = MASK2 * mask;

  const bitint *ys_aligned = (const bitint *)ys;
  mrb_int i;

  for (i = 0; i <= n - m; i += sizeof(bitint)) {
    bitint x = *ys_aligned ^ mask1;
    bitint y = ((x & MASK2) + MASK2) | x | MASK3;

    if ((y & MASK4) == 0) {
      if (i + m <= n && memcmp(ys + i, needle, m) == 0) {
        return i;
      }
    }
    ys_aligned++;
  }

  i -= sizeof(bitint);