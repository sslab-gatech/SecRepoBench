// Initialize variables for the search
  const char *s0 = ys;
  bitint w = 0;
  bitint mask = 0;
  mrb_int i = 0;

  // Prepare the mask for the first character of the needle
  mask = ~(bitint)0 / 255 * (unsigned char)needle[0];

  // Main search loop
  while (i < n) {
    // Load a chunk of the haystack into w
    if (n - i >= sizeof(bitint))
      memcpy(&w, ys + i, sizeof(bitint));
    else
      memcpy(&w, ys + i, n - i);

    // XOR w with the mask to find potential matches
    bitint x = w ^ mask;

    // Check if there's a potential match
    if ((x - MASK1) & ~x & MASK3) {
      // Potential match found, check character by character
      for (mrb_int j = 0; j < m; j++) {
        if (ys[i + j] != needle[j]) {
          goto next;
        }
      }
      // Full match found
      return i;
    }
  next:
    // Move to the next chunk
    i += sizeof(bitint);
  }

  // If we reach here, no match was found in the main loop
  // Perform a final check for any remaining characters