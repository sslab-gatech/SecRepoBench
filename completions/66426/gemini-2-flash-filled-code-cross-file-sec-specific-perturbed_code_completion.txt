const char *s0 = ys;
  long i = 0;

  if (m <= 0 || n <= 0 || m > n) return -1;
  if (m == 1) {
    const char *p = (const char*)memchr(ys, *needle, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  if (m <= sizeof(bitint)) {
    bitint needle_bits = 0;
    bitint first_byte_mask;

    for (i = 0; i < m; ++i) {
      needle_bits = (needle_bits << 8) | (unsigned char)needle[i];
    }

#if defined(MRB_ENDIAN_BIG)
    first_byte_mask = MASK4;
#else
    first_byte_mask = MASK1;
#endif

    for (i = 0; i <= n - m; ++i) {
      bitint chunk;
      memcpy(&chunk, ys + i, m);

      if (chunk == needle_bits) {
        return (mrb_int)i;
      }
    }
    return -1;
  }