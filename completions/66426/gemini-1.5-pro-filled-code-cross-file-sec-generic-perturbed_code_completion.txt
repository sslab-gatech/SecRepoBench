const char *s0 = ys;
  long i = 0;

  if (m == 0) return 0;
  if (m > n) return -1;

  bitint a1 = *needle & MASK2;
  bitint z = ~a1;

  for (; i < n-m; ++i) {
    bitint x = ys[i] & MASK2;
    bitint y = (bitint)(~x + a1);
#if defined(MRB_ENDIAN_BIG)
    if (y&MASK4) {
#else
    if (y&MASK4) {
#endif
      if (ys[i] == *needle) {
        if (memcmp(&ys[i+1], needle+1, m-1) == 0) return (mrb_int)i;
      }
    }
  }