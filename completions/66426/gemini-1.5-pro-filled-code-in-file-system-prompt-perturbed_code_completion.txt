const char *s0 = ys;
  const char *s = s0;
  const char *t = needle;
  const char *end = ys + n;
  bitint a = *t++;
  bitint b = *s++;
  long i = 0;

  // Preprocessing
  bitint mask = (bitint)MASK4;
  for (long j = 1; j < m; ++j) {
    mask |= MASK4 >> (j * CHAR_BIT);
  }
  a &= mask;

  // Search loop
  for (; i + m <= n; ++i) {
    bitint diff = a ^ b;
    if (!diff) {
      if (memcmp(s, t, m - 1) == 0) {
        return i;
      }
    }
    else if (!(diff & MASK2)) {
      if (memcmp(s, t, m - 1) == 0) {
        return i;
      }
    }
    b = *s++;
    b &= mask;
  }
  if (m==1 && *needle == '\0') {
    const char *p = (const char*)memchr(s0, *needle, n);
    if (p) return (mrb_int)(p - ys);
  }