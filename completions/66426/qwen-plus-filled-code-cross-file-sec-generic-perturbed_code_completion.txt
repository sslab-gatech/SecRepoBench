if (m <= 0 || n < m) return -1;

  const char *s0 = ys;
  mrb_int i = 0;

  bitint pattern_mask = 0;
  for (long j = 0; j < m; ++j) {
    bitint byte_val = (bitint)(needle[j]) & MASK2;
    pattern_mask |= ((byte_val | (byte_val - MASK1)) & MASK3) << (j * 8);
  }

  bitint mask4_shifted = MASK4;
  while (i + sizeof(bitint) <= n - m) {
    bitint window = *(bitint*)(ys + i);
    bitint diff = window ^ pattern_mask;

    if (((diff - MASK1) & ~diff & MASK4) == mask4_shifted) {
      if (memcmp(ys + i, needle, m) == 0) {
        return i;
      }
    }

    i += sizeof(bitint);
  }

  // Handle remaining bytes that didn't fit into full SIMD register size
  for (; i <= n - m; ++i) {
    if (memcmp(ys + i, needle, m) == 0) {
      return i;
    }
  }