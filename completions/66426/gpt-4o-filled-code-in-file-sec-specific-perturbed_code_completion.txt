const char *s0 = ys;
  bitint v, eq, x, y;
  mrb_int i = 0;

  if (m < 1 || n < 1) return -1;
  if (m == 1) {
    const char *p = (const char*)memchr(ys, *needle, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  if (m > n) return -1;

  x = (bitint)(uint8_t)needle[0] * MASK1;
  y = (bitint)(uint8_t)needle[1] * MASK1;

  for (; i <= n - m; i++) {
    v = *(bitint*)(ys + i);
    eq = (v ^ x) + MASK2;
    eq &= ~v;
    eq &= MASK3;
    if (eq) {
      if (memcmp(ys + i + 1, needle + 1, m - 1) == 0) {
        return i;
      }
    }
  }
  return -1;