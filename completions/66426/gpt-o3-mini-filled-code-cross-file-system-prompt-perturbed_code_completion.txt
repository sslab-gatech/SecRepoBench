const char *s0 = ys;
size_t remaining = n;
#if defined(MRB_64BIT)
const size_t word_size = sizeof(bitint);
#else
const size_t word_size = sizeof(bitint);
#endif

if (remaining >= word_size) {
  bitint repeated = (unsigned char)*needle * MASK1;
  /* Align s0 to word boundary */
  while (remaining && (((uintptr_t)s0) & (word_size - 1))) {
    if ((unsigned char)*s0 == (unsigned char)*needle) break;
    s0++;
    remaining--;
  }
  if (remaining >= word_size) {
    const bitint *wptr = (const bitint *)s0;
    size_t nwords = remaining / word_size;
    while (nwords--) {
      bitint w = *wptr ^ repeated;
#if defined(MRB_ENDIAN_BIG)
      if ((((w & MASK2) + MASK2) | w) & MASK3) {
#else
      if (((w - MASK1) & ~w) & MASK3) {
#endif
        const char *cp = (const char *)wptr;
        size_t j;
        for (j = 0; j < word_size; j++) {
          if ((unsigned char)cp[j] == (unsigned char)*needle) {
            s0 = cp + j;
            goto swar_search_done;
          }
        }
      }
      wptr++;
      s0 = (const char *)wptr;
      remaining = (ys + n) - s0;
    }
  }
}
swar_search_done:
mrb_int i = s0 - ys;