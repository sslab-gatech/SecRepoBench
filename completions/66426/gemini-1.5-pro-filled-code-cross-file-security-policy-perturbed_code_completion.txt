const char *s0 = ys;
  const char *p = needle;
  bitint vn = *p++ & MASK2;
  bitint carry = MASK3;
  long i = 0;

  if (m > n) return -1;

  bitint vmask = (bitint)*(p-1) & MASK2;
  while (p < needle+m) {
    vmask |= ((bitint)*p++ & MASK2);
  }
  vmask = ~vmask;

#ifdef MRB_ENDIAN_BIG
  for (; i < n-m; ++i) {
    bitint x = *(bitint*)(s0+i);
    bitint diff = (x ^ vn) | vmask;
    bitint z = diff + carry;
    if (((z ^ diff) & carry & MASK4)) {
      if (memcmp(needle, s0+i, m) == 0) return (mrb_int)i;
    }
    vn = *(bitint*)(s0+i+1) & MASK2;
  }
#else
  for (; i < n-m; ++i) {
    bitint x = *(bitint*)(s0+i);
    bitint diff = (x ^ vn) | vmask;
    bitint z = diff + carry;
    if (((z ^ diff) & carry & MASK4)) {
      if (memcmp(needle, s0+i, m) == 0) return (mrb_int)i;
    }
    vn = *(bitint*)(s0+i+m-sizeof(bitint)+1) & MASK2;
  }
#endif