if (m == 0 || n < m) return -1;
const unsigned char first = needle[0];
if (m == 1) {
  const char *p = (const char*)memchr(ys, first, n);
  return p ? (mrb_int)(p - ys) : -1;
}
const unsigned char last = needle[m-1];
const bitint first_char_mask = MASK1 * first;

const char *s = ys;
const char *end = ys + n - m + 1;

while (s < end) {
  bitint chunk;
  memcpy(&chunk, s, sizeof(bitint));
  bitint xor = chunk ^ first_char_mask;
  bitint matches = (xor - MASK1) & (~xor) & MASK3;

  while (matches != 0) {
    int pos;
#ifdef MRB_ENDIAN_BIG
    pos = 0;
    bitint mask = MASK4;
    while (pos < sizeof(bitint)) {
      if (matches & mask) break;
      mask >>= 8;
      pos++;
    }
#else
    pos = 0;
    bitint mask = MASK4;
    while (pos < sizeof(bitint)) {
      if (matches & mask) break;
      mask <<= 8;
      pos++;
    }
#endif
    if (pos >= sizeof(bitint)) break;

    const char *candidate = s + pos;
    if (candidate + m - 1 >= ys + n) break;

    if (candidate[m-1] == last && memcmp(candidate, needle, m) == 0) {
      return (mrb_int)(candidate - ys);
    }

    matches &= ~mask;
  }

  s++;
}