const char *s0 = ys;
  long i = 0;

  if (m == 0) return 0;
  if (m > n) return -1;

  bitint a1 = *needle & MASK2;
  bitint z = ~a1;

  for (; i < n-m; ++i) {
    bitint x = ys[i] & MASK2;
    bitint u = a1 ^ x;
    if ((u & z) == 0) {
      if (memcmp(needle+1, ys+i+1, m-1) == 0) return (mrb_int)i;
    }
#if defined(MRB_ENDIAN_BIG)
    if ((x & MASK4) == 0) {
      i += m-1;
    }
#endif
  }