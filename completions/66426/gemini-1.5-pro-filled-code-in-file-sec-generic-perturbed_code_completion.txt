const char *s0 = ys;
  const char *s = s0;
  const char *t = needle;
  const char *end_s = ys + n;
  const char *end_t = needle + m;

  bitint a = *t++;
  bitint b = *s++;
  long i = 0;

  // Preprocessing
  bitint mask = (bitint)MASK4;
  for (long j = 1; j < m; ++j) {
    mask |= MASK4 >> (j * 8 % (sizeof(mask) * 8));
  }

  // Search loop
  while (s < end_s) {
    bitint diff = b ^ a;
    if (!diff) {
      if (memcmp(s, t, end_t - t) == 0) {
        return i;
      }
      b = *(s + m - 1);
      s += m;
      i += m;
    }
    else {
      b = *s++;
      i++;
#if defined(MRB_ENDIAN_BIG)
      diff = (diff << (sizeof(mask) * 8 - 8)) | (diff >> 8);
#endif
      if (diff & mask) {
        s -= (m - 1);
        i -= (m - 1);
        t = needle;
        a = *t++;
        b = *s++;
      }
    }
  }

  // Check the last segment for partial matches
  if (s > end_s) {
    return -1;
  }