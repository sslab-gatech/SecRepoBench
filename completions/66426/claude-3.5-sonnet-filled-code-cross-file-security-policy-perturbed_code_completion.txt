const bitint *x = (const bitint*)needle;
  const bitint *y = (const bitint*)ys;
  bitint pattern = *x & MASK2;
  bitint i = 0;
  bitint limit = (n - m - sizeof(bitint) + 1) / sizeof(bitint);

  while (i < limit) {
    bitint v = y[i] & MASK2;
    bitint xor = v ^ pattern;
    bitint zeroes = ((xor - MASK1) & ~xor & MASK3);
    if (zeroes) {
      size_t offset = i * sizeof(bitint);
      size_t j = offset;
#if defined(MRB_ENDIAN_BIG)
      while (!(zeroes & MASK4)) {
        zeroes <<= 8;
        j++;
      }
#else
      while (!(zeroes & MASK4)) {
        zeroes >>= 8;
        j++;
      }
#endif
      if (j + m <= n && memcmp(needle, ys + j, m) == 0) {
        return (mrb_int)j;
      }
    }
    i++;
  }