if (m <= 0 || n < m) return -1;

  const char *s0 = ys;
  bitint mask4 = MASK4;
  while ((n-m+1) >= sizeof(bitint)) {
    bitint v = *(bitint *)ys;
    bitint vm = v ^ *(bitint *)needle;
    bitint bits = ~(vm + MASK1) & ~vm & MASK2;
    if (bits) {
      int idx = __builtin_ctzl(bits);
      if (memcmp(ys + idx, needle, m) == 0) {
        return (mrb_int)(ys - s0 + idx);
      }
    }
    ys += sizeof(bitint);
    n -= sizeof(bitint);
  }

  if (n >= m) {
    size_t len = n;
    ys = s0 + (len - m + 1);
  } else {
    return -1;
  }