// Initialize variables for the search
  const char *s0 = ys;
  bitint w = 0;
  bitint mask = 0;
  mrb_int i = 0;

  // Prepare the mask for the first character of the needle
  mask |= (bitint)1 << (8 * (sizeof(bitint) - 1));
  mask >>= 8 * (sizeof(bitint) - 1);
  mask = ~mask;

  // Prepare the word for comparison
  for (mrb_int j = 0; j < m; ++j) {
    w = (w << 8) | needle[j];
  }

  // Main search loop
  while (i <= n - m) {
    bitint v = 0;
    for (mrb_int j = 0; j < sizeof(bitint) && i + j < n; ++j) {
      v = (v << 8) | ys[i + j];
    }

    if (((v ^ w) & mask) == 0) {
      // Potential match found, verify it
      if (memcmp(ys + i, needle, m) == 0) {
        return i;
      }
    }

    // Move to the next position
    ++i;
    mask = (mask << 8) | 0xFF;
  }

  // If we reach here, no match was found in the main loop