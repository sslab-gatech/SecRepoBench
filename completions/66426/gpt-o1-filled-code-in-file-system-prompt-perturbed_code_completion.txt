mrb_int i;
  const bitint mask_c = (unsigned char)needle[0] * MASK1;
  const char first = needle[0];
  const char *y0 = ys;
  const char *last = ys + (n - m + 1);

  if (m > n) return -1;

  /* Align pointer on bitint boundary */
  while (((uintptr_t)ys & (sizeof(bitint) - 1)) && ys < last) {
    if (*ys == first && memcmp(ys, needle, m) == 0) {
      return (mrb_int)(ys - y0);
    }
    ys++;
  }

  n = last - ys;
  while (n >= (long)sizeof(bitint)) {
    bitint u = *(bitint*)ys ^ mask_c;
    bitint v = (u - MASK1) & ~u & MASK2;
    if (v) {
      for (i = 0; i < (mrb_int)sizeof(bitint); i++) {
        if (((v >> (i * 8)) & MASK4) && ys[i] == first) {
          if (memcmp(ys + i, needle, m) == 0) {
            return (mrb_int)((ys + i) - y0);
          }
        }
      }
    }
    ys += sizeof(bitint);
    n -= sizeof(bitint);
  }

  while (n-- > 0) {
    if (*ys == first && memcmp(ys, needle, m) == 0) {
      return (mrb_int)(ys - y0);
    }
    ys++;
  }
  return -1;