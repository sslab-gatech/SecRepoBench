const char *s0 = ys;
  const char *s = s0;
  const char *t = needle;
  const char *end = ys + n;

  bitint a = *t++;
  bitint b = *s++;
  long i = 0;

  // Preprocessing
  bitint mask = (bitint)MASK4;
  for (long j = 1; j < m; ++j) {
    mask |= MASK4 >> (j * CHAR_BIT);
  }
  if (m > 1) {
    a |= a << CHAR_BIT;
    b |= b << CHAR_BIT;
    if (m > 2) {
      a |= a << 16;
      b |= b << 16;
#ifdef MRB_64BIT
      if (m > 4) {
        a |= a << 32;
        b |= b << 32;
      }
#endif
    }
  }
  a = (a & MASK2) + MASK1;
  b = (b & MASK2) + MASK1;

  // Searching
  for (; i <= n - m; ++i) {
    if (((a ^ b) & mask) == 0) {
      if (memcmp(s-1, needle, m) == 0) {
        return i;
      }
    }
    if (i < n - m) {
      b = ((b << CHAR_BIT) & MASK2) + MASK1;
      b |= (*s++ | MASK3);
    }
  }