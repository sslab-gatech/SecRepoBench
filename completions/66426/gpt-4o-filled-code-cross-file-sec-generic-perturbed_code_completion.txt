if (m < 1 || n < m) return -1;

  const char *s0 = ys;
  const char *s = ys;
  const char *p = needle;
  bitint v, eq, x;
  bitint mask = MASK1 * (unsigned char)*p;
  bitint mask2 = MASK2;
  bitint mask3 = MASK3;
  bitint mask4 = MASK4;

  while (n >= (long)sizeof(bitint)) {
    v = *(const bitint *)s;
    eq = ~(v ^ mask) & mask2;
    x = (eq + mask3) ^ mask4;
    if (x) {
      int i;
      for (i = 0; i < (int)sizeof(bitint); i++) {
        if ((x & ((bitint)1 << (i * 8))) && memcmp(s + i + 1, p + 1, m - 1) == 0) {
          return (mrb_int)(s - s0 + i);
        }
      }
    }
    s += sizeof(bitint);
    n -= sizeof(bitint);
  }