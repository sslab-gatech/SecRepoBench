if (m <= 0 || n <= 0 || m > n) return -1;

  const char *s0 = ys;
  const char *s1 = ys + n - m + 1;
  bitint v = (bitint)(unsigned char)needle[0] * MASK1;

  for (const char *p = s0; p < s1; p++) {
    bitint u = *(const bitint *)p;
    bitint x = (u ^ v) & MASK2;
    if (((x - MASK1) & ~x & MASK3) != 0) {
      if (memcmp(p + 1, needle + 1, m - 1) == 0) {
        return (mrb_int)(p - ys);
      }
    }
  }