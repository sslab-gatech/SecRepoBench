const char *s0 = ys;
  long i = 0;

  if (m == 0) return 0;
  if (m > n) return -1;

  if (m >= sizeof(bitint)) {
    bitint first = 0;
    for (i=0; i<m; i++) {
      first <<= 8;
      first += (unsigned char)needle[i];
    }

    bitint mask = MASK1 * (unsigned char)needle[0];
    bitint need = first ^ mask;

    bitint word = 0;
    for (i=0; i<m; i++) {
      word <<= 8;
      word += (unsigned char)ys[i];
    }

    for (; i<n; i++) {
      bitint diff = word ^ need;
      bitint t = ((diff - MASK1) & ~diff) & MASK3;
      if (t != 0) {
        return (mrb_int)(i - m);
      }
      word <<= 8;
      word += (unsigned char)ys[i];
    }
    bitint diff = word ^ need;
    bitint t = ((diff - MASK1) & ~diff) & MASK3;
    if (t != 0) {
      return (mrb_int)(i - m);
    }
    return -1;
  }