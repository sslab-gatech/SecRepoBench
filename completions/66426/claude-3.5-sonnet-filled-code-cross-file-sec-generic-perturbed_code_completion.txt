bitint x = *(bitint*)needle;
  bitint mask = x ^ ((bitint)-1 / MASK1);
  mask = ((mask & MASK2) + MASK2) & MASK3;

  mrb_int i;
  for (i = 0; i <= n - sizeof(bitint); i += sizeof(bitint)) {
    bitint y = *(bitint*)(ys + i);
    bitint z = (x ^ y) | mask;
    if ((z & MASK4) == 0) {
      if (i + m <= n && memcmp(needle, ys + i, m) == 0) {
        return i;
      }
    }
  }