const char *s0 = ys;
  long i = 0;

  if (m == 0) return 0;
  if (m > n) return -1;
  if (m == 1) {
    const char *p = (const char*)memchr(ys, *needle, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  if (m <= sizeof(bitint)) {
    bitint needle_bits = 0;
    bitint first_byte_mask = MASK4;

    for (i = 0; i < m; ++i) {
      needle_bits |= ((bitint)needle[i]) << (i * 8);
    }

    for (i = 0; i <= n - m; ++i) {
      bitint chunk;
      memcpy(&chunk, ys + i, m);

      if (chunk == needle_bits) {
        return (mrb_int)i;
      }
    }
  }