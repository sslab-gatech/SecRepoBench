const bitint *s0 = (const bitint*)ys;
  const bitint *s1 = (const bitint*)needle;
  bitint v = *s1;
  bitint mask = MASK1 * v;
  bitint x, y;
  mrb_int i;

  for (i = 0; i <= n - m; i++) {
    x = *(const bitint*)(ys + i);
    y = (x ^ mask) + MASK2;
    x = ~(x | MASK2);
    y = y & x;
    if ((y & MASK3) != 0) {
      if (i + m > n) break;
      if (memcmp(ys + i, needle, m) == 0) {
        return i;
      }
    }
  }