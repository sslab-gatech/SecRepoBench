if (m <= 0 || n <= 0 || m > n) return -1;

  const char *s0 = ys;
  const char *s = ys;
  bitint vn1 = 0, vn2 = 0;
  bitint vn3 = 0, vn4 = 0;
  bitint vn5 = 0, vn6 = 0;

  // Precompute masks for the needle
  for (long i = 0; i < m; i++) {
    unsigned char c = (unsigned char)needle[i];
    vn1 |= ((bitint)c) << (i * 8);
    vn2 |= ((bitint)(c & 0x7f)) << (i * 8);
    vn3 |= ((bitint)(c | 0x80)) << (i * 8);
  }

  // Search for the needle in the haystack
  for (long i = 0; i <= n - m; i++) {
    bitint chunk = 0;
    for (long j = 0; j < m; j++) {
      chunk |= ((bitint)(unsigned char)s[j]) << (j * 8);
    }

    if ((chunk & vn2) == vn1 && (chunk | vn3) == vn3) {
      if (memcmp(s, needle, m) == 0) {
        return (mrb_int)(s - s0);
      }
    }

    s++;
  }