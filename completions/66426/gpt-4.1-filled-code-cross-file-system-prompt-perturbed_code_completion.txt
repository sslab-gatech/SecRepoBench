if (m <= 0 || n < m) return -1;
  const char *s0 = ys;
  mrb_int i = 0;

  if (m == 1) {
    const char *p = (const char*)memchr(ys, *needle, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  // Use SWAR only for short needles (up to sizeof(bitint))
  if ((size_t)m <= sizeof(bitint) && n >= m) {
    bitint needle_word = 0;
    for (i = 0; i < m; ++i) {
#if defined(MRB_ENDIAN_BIG)
      needle_word = (needle_word << 8) | (unsigned char)needle[i];
#else
      needle_word |= ((bitint)(unsigned char)needle[i]) << (i * 8);
#endif
    }
    const char *p = ys;
    const char *e = ys + n - m + 1;
    while (p < e) {
      bitint word = 0;
      for (i = 0; i < m; ++i) {
#if defined(MRB_ENDIAN_BIG)
        word = (word << 8) | (unsigned char)p[i];
#else
        word |= ((bitint)(unsigned char)p[i]) << (i * 8);
#endif
      }
      if (word == needle_word) return (mrb_int)(p - ys);
      p++;
    }
    return -1;
  }