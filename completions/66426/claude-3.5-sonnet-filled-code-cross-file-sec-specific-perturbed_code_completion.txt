bitint x = *(bitint*)needle;
bitint mask = x ^ (x << 8);
mask = (mask & MASK2) ^ MASK1;
mask *= MASK1;
mask = ~mask;

const bitint *ys_ptr = (const bitint*)ys;
mrb_int i;

for (i = 0; i <= n - sizeof(bitint); i += sizeof(bitint)) {
  bitint y = *ys_ptr++;
  bitint z = (y ^ x) & mask;
  if ((z & MASK3) == 0) {
    if (memcmp(needle, ys + i, m) == 0) {
      return i;
    }
  }
}