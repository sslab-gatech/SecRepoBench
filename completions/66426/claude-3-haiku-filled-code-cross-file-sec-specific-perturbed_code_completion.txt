bitint x, y, z;
  const bitint *p = (const bitint*)p0;
  const bitint *e = (const bitint*)(ys + n - sizeof(bitint) + 1);

  for (; p < e; p++) {
    x = *(const bitint*)p ^ *(const bitint*)needle;
    x = (x - MASK1) & ~x & MASK2;
    y = (x * MASK3) >> (sizeof(bitint) * CHAR_BIT - 8);
    if (y) {
      z = *(const bitint*)p;
      p = (const bitint*)(memchr(p, (int)((z & MASK4) ? 0 : *needle), e-p) + 1);
      if (p >= e) break;
      if (memcmp(p, needle+1, m-1) == 0) return (mrb_int)((const char*)p - ys);
    }
  }