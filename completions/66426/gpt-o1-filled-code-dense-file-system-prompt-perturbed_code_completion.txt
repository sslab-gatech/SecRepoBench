{
  long i = 0;
  bitint c_bcast = (bitint)((unsigned char)needle[0]) * (bitint)MASK1;

  while (i + m <= n) {
    if (i + (long)sizeof(bitint) > n) break;

    bitint block = *(const bitint*)(ys + i);

#if defined(MRB_ENDIAN_BIG)
    bitint x = block ^ (c_bcast << ((sizeof(bitint) - 1) * 8));
#else
    bitint x = block ^ c_bcast;
#endif

    bitint y = (x - MASK1) & ~x & MASK2;
    if (y & MASK3) {
      for (int j = 0; j < (int)sizeof(bitint); j++) {
        if (ys[i + j] == needle[0]) {
          if (m == 1 || memcmp(ys + i + j + 1, needle + 1, m - 1) == 0) {
            return (mrb_int)(i + j);
          }
        }
      }
    }
    i += sizeof(bitint);
  }

  s0 = ys + i;
}