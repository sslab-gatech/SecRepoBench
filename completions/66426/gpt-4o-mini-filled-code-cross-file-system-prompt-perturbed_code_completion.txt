bitint needle_mask = 0;
  for (long i = 0; i < m; i++) {
    needle_mask |= ((bitint)(needle[i] & 0xFF) << (i * 8));
  }

  bitint needle_bits = needle_mask * MASK1;
  needle_bits = (needle_bits & MASK2) + ((needle_bits >> 1) & MASK2);
  needle_bits = (needle_bits & MASK3) + ((needle_bits >> 2) & MASK3);
  needle_bits = (needle_bits & MASK4) + ((needle_bits >> 4) & MASK4);
  
  const char *s0 = ys;
  long i = 0;
  for (; i <= n - m; i += sizeof(bitint)) {
    bitint text_bits = 0;
    for (long j = 0; j < sizeof(bitint) && (i + j) < n; j++) {
      text_bits |= ((bitint)(ys[i + j] & 0xFF) << (j * 8));
    }

    text_bits = text_bits * MASK1;
    text_bits = (text_bits & MASK2) + ((text_bits >> 1) & MASK2);
    text_bits = (text_bits & MASK3) + ((text_bits >> 2) & MASK3);
    text_bits = (text_bits & MASK4) + ((text_bits >> 4) & MASK4);

    if ((text_bits & needle_bits) == needle_bits) {
      return (mrb_int)(i);
    }
  }