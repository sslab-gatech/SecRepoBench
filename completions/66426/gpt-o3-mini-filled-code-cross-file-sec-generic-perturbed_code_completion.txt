mrb_int i = 0;
  const char *s0 = ys;
  if (m > 0 && n >= m) {
    const unsigned char c = (unsigned char)*needle;
    bitint repeated = c * MASK1;
    const char *p = ys;
    const char *limit = ys + n - sizeof(bitint) + 1;
    while (p < limit) {
      bitint word;
      memcpy(&word, p, sizeof(word));
      bitint diff = word ^ repeated;
      if (((diff - MASK1) & ~diff & MASK3) != 0) {
        mrb_int offset = 0;
        while (offset < (mrb_int)sizeof(bitint)) {
          if ( ((word >> (offset * 8)) & 0xff) == c ) {
            i = (mrb_int)(p - ys) + offset;
            goto swar_done;
          }
          offset++;
        }
      }
      p += sizeof(bitint);
    }
  swar_done:
    /* If no candidate was found in full words, ensure that i is not past the last
       possible starting position for a match. */
    if (i > n - m) i = n - m;
  }