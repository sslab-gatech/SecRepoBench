// Initialize variables for the search
  const char *s0 = ys;
  bitint w = 0;
  bitint mask = 0;
  mrb_int i = 0;

  // Prepare the pattern mask
  for (mrb_int j = 0; j < m; j++) {
    w |= (bitint)needle[j] << (j * 8);
    mask |= (bitint)0xFF << (j * 8);
  }

  // Perform the search
  while (i <= n - m) {
    bitint v = 0;
    for (mrb_int j = 0; j < m; j++) {
      v |= (bitint)ys[i + j] << (j * 8);
    }
    if (((v ^ w) & mask) == 0) {
      return i;
    }
    v = (v | MASK1) & MASK2;
    bitint x = v + MASK1;
    if ((x & MASK3) != 0) {
      i += (x & MASK4) ? m : 1;
    } else {
      i++;
    }
  }

  // If no match is found, continue with the fallback method