long limit = n - m; // Calculate the limit for the loop
  for (long i = 0; i <= limit; i++) {
    bitint b = 0;
    for (long j = 0; j < m; j++) {
      b |= ((bitint)(ys[i + j] == needle[j]) << j);
    }
    if ((b - MASK1) & ~b & MASK2) {
      return (mrb_int)i; // Match found
    }
  }