const char *s0 = ys;
  long i = 0;

  if (m == 0) return 0;
  if (m > n) return -1;

  bitint a1 = *needle++ & MASK2;
  bitint z = ~a1;

  for (; i < m-1; ++i, ++needle) {
    z &= ~(*needle & MASK2);
  }

  bitint vn = *needle & MASK2;

  while (i < n) {
    bitint x = *s0++ & MASK2;
    bitint v = vn ^ x;
    bitint r = (bitint)(v - MASK1) & ~v & MASK3;
    if (r) {
      i += (r & MASK4) >> (sizeof(bitint)*CHAR_BIT-1);
      i -= (i >> (sizeof(bitint)*CHAR_BIT-4)) & 15;
      continue;
    }
    if (z == 0) {
      if (memcmp(s0-1, needle-m+1, m-1) == 0) return (mrb_int)(s0 - ys - 1);
    }
    i++;
  }