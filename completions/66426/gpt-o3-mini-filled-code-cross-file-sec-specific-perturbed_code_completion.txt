if (m <= 0) return 0;
  if (m == 1) {
    bitint ch = (bitint)(unsigned char)*needle;
    bitint rep = ch * MASK1;
    const char *s = ys;
    long remaining = n;

    /* Process bytes until pointer is aligned to a word boundary */
    while (remaining > 0 && ((uintptr_t)s & (sizeof(bitint)-1))) {
      if ((unsigned char)*s == (unsigned char)ch)
        return (mrb_int)(s - ys);
      s++;
      remaining--;
    }

    /* Process aligned words */
    const bitint *wptr = (const bitint *)s;
    while (remaining >= (long)sizeof(bitint)) {
      bitint w = *wptr;
      bitint diff = w ^ rep;
      if ((((diff - MASK1) & ~diff) & MASK3) != 0) {
        s = (const char *)wptr;
        for (size_t i = 0; i < sizeof(bitint); i++) {
          if ((unsigned char)s[i] == (unsigned char)ch)
            return (mrb_int)(s - ys + i);
        }
      }
      wptr++;
      remaining -= sizeof(bitint);
    }

    /* Process remaining bytes */
    s = (const char *)wptr;
    while (remaining--) {
      if ((unsigned char)*s == (unsigned char)ch)
        return (mrb_int)(s - ys);
      s++;
    }
    return -1;
  }

  const char *s0 = ys;