const char *s0 = needle;
  const char *s1 = ys;
  const char *e1 = ys + n;
  const char *end = s1 + n - m;
  bitint mask1, mask2, mask3, mask4;
  bitint needle_mask = 0;
  bitint cmp_mask = 0;
  bitint found_mask = 0;

  for (long i = 0; i < m; i++) {
    needle_mask |= (bitint)1 << (unsigned char)needle[i];
  }

  while (s1 <= end) {
    mask1 = mask2 = mask3 = 0;
    for (long i = 0; i < sizeof(bitint); i++) {
      if (s1 + i < e1) {
        mask1 |= (bitint)(1 << (unsigned char)s1[i]);
      }
    }
    cmp_mask = needle_mask ^ mask1;
    if ((cmp_mask & needle_mask) == 0) {
      found_mask |= (bitint)(1 << (s1 - ys));
    }
    s1++;
  }

  if (found_mask) {
    return (mrb_int)(__builtin_ctz(found_mask));
  }