bitint a, b, c, d;
  const bitint *x = (const bitint*)p;
  const bitint *y = (const bitint*)needle;
  bitint mask;

  while (p + sizeof(bitint) <= ys + n) {
    a = *x++;
    b = *y;

    // Check if the first byte of the pattern matches the current byte in the text
    mask = (a ^ b) & MASK1;
    if (mask == 0) {
      // The first byte matches, check the remaining bytes
      c = a & MASK2;
      d = b & MASK2;
      if (c == d) {
        // All bytes match, return the index of the match
        return (mrb_int)(p - ys);
      }
    }

    // Shift the text by one byte and continue the search
    p++;
  }

  // Pattern not found
  return -1;