const char *s0 = ys;
  bitint x = 0, y = 0, z = 0;
  bitint mask = 0;
  int i;

  for (i = 0; i < m; i++) {
    x |= ((bitint)(unsigned char)needle[i]) << (i * 8);
  }

  for (i = 0; i < sizeof(bitint); i++) {
    mask |= (x & MASK3) >> i;
  }

  for (i = 0; i <= n - sizeof(bitint); i += sizeof(bitint)) {
    y = 0;
    for (int j = 0; j < sizeof(bitint); j++) {
      y |= ((bitint)(unsigned char)ys[i + j]) << (j * 8);
    }
    z = ~((y ^ x) | mask);
    if (z & MASK4) {
      if (memcmp(&ys[i], needle, m) == 0) {
        return (mrb_int)i;
      }
    }
  }

  for (; i < n; i++) {
    if (ys[i] == needle[0] && memcmp(&ys[i], needle, m) == 0) {
      return (mrb_int)i;
    }
  }