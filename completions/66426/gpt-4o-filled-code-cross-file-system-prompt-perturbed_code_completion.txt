const char *s0 = ys;
  bitint v, eq, x;
  long i;

  if (m < 1 || n < m) return -1;
  if (m == 1) {
    const char *p = (const char*)memchr(ys, *needle, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  v = (bitint)(unsigned char)needle[0] * MASK1;
  for (i=0; i<=n-m; i++) {
    x = *(const bitint*)(ys+i);
    eq = (x ^ v) + MASK2;
    eq &= ~x & MASK3;
    if (eq) {
      if (memcmp(ys+i+1, needle+1, m-1) == 0) return i;
    }
  }