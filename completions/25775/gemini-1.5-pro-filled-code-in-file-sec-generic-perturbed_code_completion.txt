if (i + length > p->buf_size || length < 8)
    return 0;