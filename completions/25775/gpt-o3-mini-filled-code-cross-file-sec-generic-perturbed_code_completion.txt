if (length < 8 || length > (unsigned)(p->buf_size - i))
    return 0;
i += 8;