if (length < 8 || i + length > p->buf_size) {
            return 0; // Invalid length or buffer overflow
        }