if (mng_type)
  {
    MngBox
      crop_box;

    if (((mng_info->magn_methx > 0) && (mng_info->magn_methx <= 5)) &&
        ((mng_info->magn_methy > 0) && (mng_info->magn_methy <= 5)))
      {
        png_uint_32
           magnified_height,
           magnified_width;

        if (logging!= MagickFalse)
          (void) LogMagickEvent(CoderEvent,GetMagickModule(),
            "  Processing MNG MAGN chunk");

        if (current_image->columns == 1)
          mng_info->magn_methx = 1;
        if (current_image->rows == 1)
          mng_info->magn_methy = 1;
        if (mng_info->magn_methx == 1)
          {
            magnified_width=mng_info->magn_ml;

            if (current_image->columns > 1)
               magnified_width += mng_info->magn_mr;

            if (current_image->columns > 2)
               magnified_width += (png_uint_32)
                  ((current_image->columns-2)*(mng_info->magn_mx));
          }

        else
          {
            magnified_width=(png_uint_32) current_image->columns;

            if (current_image->columns > 1)
               magnified_width += mng_info->magn_ml-1;

            if (current_image->columns > 2)
               magnified_width += mng_info->magn_mr-1;

            if (current_image->columns > 3)
               magnified_width += (png_uint_32)
                  ((current_image->columns-3)*(mng_info->magn_mx-1));
          }

        if (mng_info->magn_methy == 1)
          {
            magnified_height=mng_info->magn_mt;

            if (current_image->rows > 1)
               magnified_height += mng_info->magn_mb;

            if (current_image->rows > 2)
               magnified_height += (png_uint_32)
                  ((current_image->rows-2)*(mng_info->magn_my));
          }

        else
          {
            magnified_height=(png_uint_32) current_image->rows;

            if (current_image->rows > 1)
               magnified_height += mng_info->magn_mt-1;

            if (current_image->rows > 2)
               magnified_height += mng_info->magn_mb-1;

            if (current_image->rows > 3)
               magnified_height += (png_uint_32)
                  ((current_image->rows-3)*(mng_info->magn_my-1));
          }

        if (magnified_height > current_image->rows ||
            magnified_width > current_image->columns)
          {
            Image
              *large_image;

            int
              yy;

            Quantum
              *next,
              *prev;

            png_uint_16
              magn_methx,
              magn_methy;

            ssize_t
              m,
              y;

            Quantum
              *n,
              *q;

            ssize_t
              x;

            /* Allocate next image structure.  */

            if (logging!= MagickFalse)
              (void) LogMagickEvent(CoderEvent,GetMagickModule(),
                "    Allocate magnified image");

            AcquireNextImage(image_info,current_image,exception);

            if (GetNextImageInList(current_image) == (Image *) NULL)
              return(DestroyImageList(current_image));

            large_image=SyncNextImageInList(current_image);

            large_image->columns=magnified_width;
            large_image->rows=magnified_height;

            magn_methx=mng_info->magn_methx;
            magn_methy=mng_info->magn_methy;

#if (MAGICKCORE_QUANTUM_DEPTH > 16)
#define QM unsigned short
            if (magn_methx!= 1 || magn_methy!= 1)
              {
              /*
                 Scale pixels to unsigned shorts to prevent
                 overflow of intermediate values of interpolations
              */
                 for (y=0; y < (ssize_t) current_image->rows; y++)
                 {
                   q=GetAuthenticPixels(current_image,0,y,current_image->columns,1,
                      exception);
                   if (q == (Quantum *) NULL)
                     break;
                   for (x=(ssize_t) current_image->columns-1; x >= 0; x--)
                   {
                      SetPixelRed(current_image,ScaleQuantumToShort(
                        GetPixelRed(current_image,q)),q);
                      SetPixelGreen(current_image,ScaleQuantumToShort(
                        GetPixelGreen(current_image,q)),q);
                      SetPixelBlue(current_image,ScaleQuantumToShort(
                        GetPixelBlue(current_image,q)),q);
                      SetPixelAlpha(current_image,ScaleQuantumToShort(
                        GetPixelAlpha(current_image,q)),q);
                      q+=GetPixelChannels(current_image);
                   }

                   if (SyncAuthenticPixels(current_image,exception) == MagickFalse)
                     break;
                 }
              }
#else
#define QM Quantum
#endif

            if (current_image->alpha_trait!= UndefinedPixelTrait)
               (void) SetImageBackgroundColor(large_image,exception);

            else
              {
                large_image->background_color.alpha=OpaqueAlpha;
                (void) SetImageBackgroundColor(large_image,exception);

                if (magn_methx == 4)
                  magn_methx=2;

                if (magn_methx == 5)
                  magn_methx=3;

                if (magn_methy == 4)
                  magn_methy=2;

                if (magn_methy == 5)
                  magn_methy=3;
              }

            /* magnify the rows into the right side of the large image */

            if (logging!= MagickFalse)
              (void) LogMagickEvent(CoderEvent,GetMagickModule(),
                "    Magnify the rows to %.20g",
                (double) large_image->rows);
            m=(ssize_t) mng_info->magn_mt;
            yy=0;
            length=(size_t) GetPixelChannels(current_image)*current_image->columns;
            next=(Quantum *) AcquireQuantumMemory(length,sizeof(*next));
            prev=(Quantum *) AcquireQuantumMemory(length,sizeof(*prev));

            if ((prev == (Quantum *) NULL) ||
                (next == (Quantum *) NULL))
              {
                if (prev!= (Quantum *) NULL)
                  prev=(Quantum *) RelinquishMagickMemory(prev);
                if (next!= (Quantum *) NULL)
                  next=(Quantum *) RelinquishMagickMemory(next);
                current_image=DestroyImageList(current_image);
                ThrowReaderException(ResourceLimitError,
                  "MemoryAllocationFailed");
              }

            n=GetAuthenticPixels(current_image,0,0,current_image->columns,1,exception);
            (void) memcpy(next,n,length);

            for (y=0; y < (ssize_t) current_image->rows; y++)
            {
              if (y == 0)
                m=(ssize_t) mng_info->magn_mt;

              else if (magn_methy > 1 && y == (ssize_t) current_image->rows-2)
                m=(ssize_t) mng_info->magn_mb;

              else if (magn_methy <= 1 && y == (ssize_t) current_image->rows-1)
                m=(ssize_t) mng_info->magn_mb;

              else if (magn_methy > 1 && y == (ssize_t) current_image->rows-1)
                m=1;

              else
                m=(ssize_t) mng_info->magn_my;

              n=prev;
              prev=next;
              next=n;

              if (y < (ssize_t) current_image->rows-1)
                {
                  n=GetAuthenticPixels(current_image,0,y+1,current_image->columns,1,
                      exception);
                  (void) memcpy(next,n,length);
                }

              for (i=0; i < m; i++, yy++)
              {
                Quantum
                  *pixels;

                assert(yy < (ssize_t) large_image->rows);
                pixels=prev;
                n=next;
                q=GetAuthenticPixels(large_image,0,yy,large_image->columns,
                  1,exception);
                if (q == (Quantum *) NULL)
                  break;
                q+=(large_image->columns-current_image->columns)*
                  GetPixelChannels(large_image);

                for (x=(ssize_t) current_image->columns-1; x >= 0; x--)
                {
                  /* To do: get color as function of indexes[x] */
                  /*
                  if (image->storage_class == PseudoClass)
                    {
                    }
                  */

                  if (magn_methy <= 1)
                    {
                      /* replicate previous */
                      SetPixelRed(large_image,GetPixelRed(current_image,pixels),q);
                      SetPixelGreen(large_image,GetPixelGreen(current_image,
                         pixels),q);
                      SetPixelBlue(large_image,GetPixelBlue(current_image,
                         pixels),q);
                      SetPixelAlpha(large_image,GetPixelAlpha(current_image,
                         pixels),q);
                    }

                  else if (magn_methy == 2 || magn_methy == 4)
                    {
                      if (i == 0)
                        {
                          SetPixelRed(large_image,GetPixelRed(current_image,
                             pixels),q);
                          SetPixelGreen(large_image,GetPixelGreen(current_image,
                             pixels),q);
                          SetPixelBlue(large_image,GetPixelBlue(current_image,
                             pixels),q);
                          SetPixelAlpha(large_image,GetPixelAlpha(current_image,
                             pixels),q);
                        }

                      else
                        {
                          /* Interpolate */
                          SetPixelRed(large_image,((QM) (((ssize_t)
                             (2*i*(GetPixelRed(current_image,n)
                             -GetPixelRed(current_image,pixels)+m))/
                             ((ssize_t) (m*2))
                             +GetPixelRed(current_image,pixels)))),q);
                          SetPixelGreen(large_image,((QM) (((ssize_t)
                             (2*i*(GetPixelGreen(current_image,n)
                             -GetPixelGreen(current_image,pixels)+m))/
                             ((ssize_t) (m*2))
                             +GetPixelGreen(current_image,pixels)))),q);
                          SetPixelBlue(large_image,((QM) (((ssize_t)
                             (2*i*(GetPixelBlue(current_image,n)
                             -GetPixelBlue(current_image,pixels)+m))/
                             ((ssize_t) (m*2))
                             +GetPixelBlue(current_image,pixels)))),q);

                          if (current_image->alpha_trait!= UndefinedPixelTrait)
                             SetPixelAlpha(large_image, ((QM) (((ssize_t)
                               (2*i*(GetPixelAlpha(current_image,n)
                               -GetPixelAlpha(current_image,pixels)+m))
                               /((ssize_t) (m*2))+
                               GetPixelAlpha(current_image,pixels)))),q);
                        }

                      if (magn_methy == 4)
                        {
                          /* Replicate nearest */
                          if (i <= ((m+1) << 1))
                             SetPixelAlpha(large_image,GetPixelAlpha(current_image,
                                pixels),q);
                          else
                             SetPixelAlpha(large_image,GetPixelAlpha(current_image,
                                n),q);
                        }
                    }

                  else /* if (magn_methy == 3 || magn_methy == 5) */
                    {
                      /* Replicate nearest */
                      if (i <= ((m+1) << 1))
                      {
                         SetPixelRed(large_image,GetPixelRed(current_image,
                                pixels),q);
                         SetPixelGreen(large_image,GetPixelGreen(current_image,
                                pixels),q);
                         SetPixelBlue(large_image,GetPixelBlue(current_image,
                                pixels),q);
                         SetPixelAlpha(large_image,GetPixelAlpha(current_image,
                                pixels),q);
                      }

                      else
                      {
                         SetPixelRed(large_image,GetPixelRed(current_image,n),q);
                         SetPixelGreen(large_image,GetPixelGreen(current_image,n),
                                q);
                         SetPixelBlue(large_image,GetPixelBlue(current_image,n),
                                q);
                         SetPixelAlpha(large_image,GetPixelAlpha(current_image,n),
                                q);
                      }

                      if (magn_methy == 5)
                        {
                          SetPixelAlpha(large_image,(QM) (((ssize_t) (2*i*
                             (GetPixelAlpha(current_image,n)
                             -GetPixelAlpha(current_image,pixels))
                             +m))/((ssize_t) (m*2))
                             +GetPixelAlpha(current_image,pixels)),q);
                        }
                    }
                  n+=GetPixelChannels(current_image);
                  q+=GetPixelChannels(large_image);
                  pixels+=GetPixelChannels(current_image);
                } /* x */

                if (SyncAuthenticPixels(large_image,exception) == 0)
                  break;

              } /* i */
            } /* y */

            prev=(Quantum *) RelinquishMagickMemory(prev);
            next=(Quantum *) RelinquishMagickMemory(next);

            length=current_image->columns;

            if (logging!= MagickFalse)
              (void) LogMagickEvent(CoderEvent,GetMagickModule(),
                "    Delete original image");

            DeleteImageFromList(&current_image);

            current_image=large_image;

            mng_info->image=current_image;

            /* magnify the columns */
            if (logging!= MagickFalse)
              (void) LogMagickEvent(CoderEvent,GetMagickModule(),
                "    Magnify the columns to %.20g",
                (double) current_image->columns);

            for (y=0; y < (ssize_t) current_image->rows; y++)
            {
              Quantum
                *pixels;

              q=GetAuthenticPixels(current_image,0,y,current_image->columns,1,exception);
              if (q == (Quantum *) NULL)
                break;
              pixels=q+(current_image->columns-length)*GetPixelChannels(current_image);
              n=pixels+GetPixelChannels(current_image);

              for (x=(ssiz