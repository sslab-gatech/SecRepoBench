if (head < 0) {
  head += arraylength;
}
if (head < 0) {
  mrb_raisef(mrb, E_INDEX_ERROR, "index %i out of array", head - arraylength);
}
if (head < arraylength) {
  tail = head + len;
  if (tail > arraylength) {
    len = arraylength - head;
    tail = arraylength;
  }
  if (head > ARY_MAX_SIZE || tail > ARY_MAX_SIZE) {
    mrb_raise(mrb, E_INDEX_ERROR, "index too big");
  }
}
else {
  /* head is at or beyond the current array length; just check maximum index bounds */
  if (head > ARY_MAX_SIZE) {
    mrb_raise(mrb, E_INDEX_ERROR, "index too big");
  }
  tail = head + len;
}