// Adjust the `head` index for negative values by adding the array length.
// If the adjusted `head` is still negative, raise an index error as it's out of bounds.
if (head < 0) {
    head += arraylength;
    if (head < 0) {
        mrb_raisef(mrb, E_INDEX_ERROR, "index %i out of array", head);
    }
}

// Calculate the `tail` index.
tail = head + len;

// If the `head` index or calculated `tail` would result in exceeding the maximum array size, raise an index error.
if (head > ARY_MAX_SIZE || tail > ARY_MAX_SIZE) {
out_of_range:
    mrb_raisef(mrb, E_INDEX_ERROR, "index %i out of array", head);
}

// If the current array length is less than `len` or `tail`, adjust `len` to fit within the array bounds.
if (arraylength < len || arraylength < tail) {
    len = (arraylength < tail) ? tail : arraylength;
}