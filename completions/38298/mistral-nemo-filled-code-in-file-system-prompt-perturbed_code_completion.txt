def array_join(mrb_state *mrb, mrb_value self, mrb_value sep)
  if !mrb_nil_p(sep)
    sep = mrb_obj_as_string(mrb, sep)
  end
  result = mrb_str_new_capa(mrb, 64)
  RARRAY_PTR(self).each_with_index do |val, i|
    if i > 0 && !mrb_nil_p(sep)
      mrb_str_cat_str(mrb, result, sep)
    end
    case mrb_type(val)
    when MRB_TT_ARRAY
      val = join_ary(mrb, val, sep, mrb_ary_new(mrb))
    when MRB_TT_STRING
      mrb_str_cat_str(mrb, result, val)
    else
      val = mrb_obj_as_string(mrb, val)
      mrb_str_cat_str(mrb, result, val)
    end
  end
  result
end