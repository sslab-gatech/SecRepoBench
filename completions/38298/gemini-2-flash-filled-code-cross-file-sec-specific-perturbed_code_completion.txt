if (head < 0) {
    head += arraylength;
    if (head < 0) {
      mrb_raisef(mrb, E_INDEX_ERROR, "index %i out of array (size:%i)", (int)(head - arraylength), (int)arraylength);
    }
  }

  tail = head + len;
  if (head > ARY_MAX_SIZE || tail > ARY_MAX_SIZE) {
  out_of_range:
    mrb_raise(mrb, E_INDEX_ERROR, "index too big");
  }

  if (arraylength < len) {
    len = arraylength;
  }
  if (arraylength < tail) {
    len = arraylength - head;
  }