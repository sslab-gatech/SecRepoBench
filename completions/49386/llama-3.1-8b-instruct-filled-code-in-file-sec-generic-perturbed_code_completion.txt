static
cmsBool _cmsReadHeader(_cmsICCPROFILE* Icc)
{
    cmsTagEntry TagEntry;
    cmsICCHeader Header;
    cmsUInt32Number i, j;
    cmsUInt32Number HeaderSize;
    cmsIOHANDLER* io = Icc ->IOhandler;
    cmsUInt32Number TagCount;

    // Read the header
    if (io -> Read(io, &Header, sizeof(cmsICCHeader), 1)!= 1) {
        return FALSE;
    }

    // Validate file as an ICC profile
    if (_cmsAdjustEndianess32(Header.magic)!= cmsMagicNumber) {
        cmsSignalError(Icc ->ContextID, cmsERROR_BAD_SIGNATURE, "not an ICC profile, invalid signature");
        return FALSE;
    }

    // Adjust endianness of the used parameters
    Icc -> DeviceClass     = (cmsProfileClassSignature) _cmsAdjustEndianess32(Header.deviceClass);
    Icc -> ColorSpace      = (cmsColorSpaceSignature)   _cmsAdjustEndianess32(Header.colorSpace);
    Icc -> PCS             = (cmsColorSpaceSignature)   _cmsAdjustEndianess32(Header.pcs);
   
    Icc -> RenderingIntent = _cmsAdjustEndianess32(Header.renderingIntent);
    Icc -> flags           = _cmsAdjustEndianess32(Header.flags);
    Icc -> manufacturer    = _cmsAdjustEndianess32(Header.manufacturer);
    Icc -> model           = _cmsAdjustEndianess32(Header.model);
    Icc -> creator         = _cmsAdjustEndianess32(Header.creator);
    
    _cmsAdjustEndianess64(&Icc -> attributes, &Header.attributes);
    Icc -> Version         = _cmsAdjustEndianess32(_validatedVersion(Header.version));

    // Get size as reported in header
    HeaderSize = _cmsAdjustEndianess32(Header.size);

    // Make sure HeaderSize is lower than profile size
    if (HeaderSize >= Icc ->IOhandler ->ReportedSize)
            HeaderSize = Icc ->IOhandler ->ReportedSize;


    // Get creation date/time
    _cmsDecodeDateTimeNumber(&Header.date, &Icc ->Created);

    // The profile ID are 32 raw bytes
    memmove(Icc ->ProfileID.ID32, Header.profileID.ID32, 16);


    // Read tag directory
    if (!_cmsReadUInt32Number(io, &TagCount)) return FALSE;
    if (TagCount > MAX_TABLE_TAG) {

        cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Too many tags (%d)", TagCount);
        return FALSE;
    }


    // Read tag directory
    Icc -> TagCount = 0;
    // Loop through each tag entry in the profile's tag directory, reading the tag signature,
    // offset, and size from the IO handler. Perform basic sanity checks to ensure the tag
    // falls within the bounds of the file. If a tag passes the checks, record its signature,
    // offset, and size in the Icc structure. Additionally, search for and record any links
    // between tags that share the same offset and size, indicating they are linked. Finally,
    // increment the tag count for each valid tag entry processed. Return TRUE if the tags are successfully read and processed.
    for (i=0; i < TagCount; i++) {
        cmsUInt32Number offset, size;
        cmsTagSignature sig;

        if (!_cmsReadUInt32Number(io, &sig)) return FALSE;
        if (!_cmsReadUInt32Number(io, &offset)) return FALSE;
        if (!_cmsReadUInt32Number(io, &size)) return FALSE;

        if (offset + size > Icc ->IOhandler ->ReportedSize) {
            cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Tag %d out of bounds", i);
            return FALSE;
        }

        Icc -> TagNames[i] = sig;
        Icc -> TagOffsets[i] = offset;
        Icc -> TagSizes[i] = size;
    }

    Icc -> TagCount = TagCount;

    // Search for links
    for (i=0; i < TagCount; i++) {
        cmsUInt32Number offset, size;
        cmsTagSignature sig;

        if (!_cmsReadUInt32Number(io, &sig)) return FALSE;
        if (!_cmsReadUInt32Number(io, &offset)) return FALSE;
        if (!_cmsReadUInt32Number(io, &size)) return FALSE;

        if (offset + size > Icc ->IOhandler ->ReportedSize) {
            cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Tag %d out of bounds", i);
            return FALSE;
        }

        if (Icc -> TagNames[i]!= sig) {
            cmsTagSignature linkedSig;

            if (!_cmsReadUInt32Number(io, &linkedSig)) return FALSE;
            Icc -> TagLinked[i] = linkedSig;
        }
    }

    return TRUE;
}