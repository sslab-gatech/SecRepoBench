// Read tag directory
Icc -> TagCount = 0;
for (i = 0; i < TagCount; i++) {
    cmsUInt32Number TagOffset;
    cmsUInt32Number TagSize;
    cmsTagSignature TagSignature;
    cmsTagDescriptor* TagDescriptor;
    cmsUInt32Number j;

    if (!_cmsReadUInt32Number(io, &TagOffset)) return FALSE;
    if (!_cmsReadUInt32Number(io, &TagSize)) return FALSE;
    if (!_cmsReadUInt32Number(io, &TagSignature)) return FALSE;

    // Check if the tag is within the bounds of the file
    if (TagOffset + TagSize > HeaderSize) {
        cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Tag out of bounds");
        return FALSE;
    }

    // Check if the tag is a link
    if (TagSignature == cmsTagSignatureLink) {
        cmsUInt32Number LinkOffset;
        cmsUInt32Number LinkSize;
        cmsTagSignature LinkSignature;

        if (!_cmsReadUInt32Number(io, &LinkOffset)) return FALSE;
        if (!_cmsReadUInt32Number(io, &LinkSize)) return FALSE;
        if (!_cmsReadUInt32Number(io, &LinkSignature)) return FALSE;

        // Check if the link is within the bounds of the file
        if (LinkOffset + LinkSize > HeaderSize) {
            cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Link out of bounds");
            return FALSE;
        }

        // Check if the link is already in the list
        for (j = 0; j < Icc -> TagCount; j++) {
            if (Icc -> TagOffsets[j] == LinkOffset && Icc -> TagSizes[j] == LinkSize && Icc -> TagLinked[j] == LinkSignature) {
                cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Duplicate link");
                return FALSE;
            }
        }

        // Add the link to the list
        Icc -> TagLinked[Icc -> TagCount] = LinkSignature;
        Icc -> TagOffsets[Icc -> TagCount] = LinkOffset;
        Icc -> TagSizes[Icc -> TagCount] = LinkSize;
    } else {
        // Check if the tag is supported
        TagDescriptor = _cmsGetTagDescriptor(TagSignature);
        if (TagDescriptor == NULL) {
            cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Unsupported tag");
            return FALSE;
        }

        if (!IsTypeSupported(TagDescriptor, TagSignature)) {
            cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Unsupported tag type");
            return FALSE;
        }

        // Check if the tag is already in the list
        for (j = 0; j < Icc -> TagCount; j++) {
            if (Icc -> TagOffsets[j] == TagOffset && Icc -> TagSizes[j] == TagSize && Icc -> TagSignature[j] == TagSignature) {
                cmsSignalError(Icc ->ContextID, cmsERROR_RANGE, "Duplicate tag");
                return FALSE;
            }
        }

        // Add the tag to the list
        Icc -> TagSignature[Icc -> TagCount] = TagSignature;
        Icc -> TagOffsets[Icc -> TagCount] = TagOffset;
        Icc -> TagSizes[Icc -> TagCount] = TagSize;
    }

    // Increment the tag count
    Icc -> TagCount++;
}

// Search for and record any links between tags that share the same offset and size
SetLinks(Icc);

return TRUE;