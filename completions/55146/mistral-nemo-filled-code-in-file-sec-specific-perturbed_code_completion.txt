if (wchr >= 0x800) {
    strbuf[o++] = (char)(0xE0 + ((wchr >> 12) & 0xF));
    strbuf[o++] = (char)(0x80 + ((wchr >> 6) & 0x3F));
    strbuf[o++] = (char)(0x80 + (wchr & 0x3F));
} else if (wchr >= 0x80) {
    strbuf[o++] = (char)(0xC0 + ((wchr >> 6) & 0x1F));
    strbuf[o++] = (char)(0x80 + (wchr & 0x3F));
} else {
    strbuf[o++] = (char)(wchr & 0x7F);
}