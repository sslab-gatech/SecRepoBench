/*
  P o l a r o i d I m a g e
*/
MagickExport Image *PolaroidImage(const Image *image,const DrawInfo *draw_info,
  const char *caption,const double angle,const PixelInterpolateMethod method,
  ExceptionInfo *exception)
{
#define PolaroidImageTag  "Polaroid/Image"

  CacheView
    *image_view,
    *shadow_view;

  Image
    *shadow_image,
    *polaroid_image;

  MagickBooleanType
    status;

  MagickOffsetType
    progress;

  ssize_t
    y;

  /*
    Initialize polaroid image attributes.
  */
  assert(image != (const Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  polaroid_image=CloneImage(image,0,0,MagickTrue,exception);
  if (polaroid_image == (Image *) NULL)
    return((Image *) NULL);
  if (SetImageStorageClass(polaroid_image,DirectClass,exception) == MagickFalse)
    {
      polaroid_image=DestroyImage(polaroid_image);
      return((Image *) NULL);
    }
  if ((IsGrayColorspace(image->colorspace) != MagickFalse) &&
      (IsPixelInfoGray(draw_info) == MagickFalse))
    (void) SetImageColorspace(polaroid_image,sRGBColorspace,exception);
  if ((polaroid_image->alpha_trait == UndefinedPixelTrait) &&
      (draw_info->alpha != UndefinedPixelTrait))
    (void) SetImageAlpha(polaroid_image,draw_info->alpha,exception);
  if (caption != (const char *) NULL)
  {
    char
      geometry[MagickPathExtent],
      *text;

    DrawInfo
      *annotate_info;

    ImageInfo
      *image_info;

    MagickBooleanType
      status;

    ssize_t
      count;

    TypeMetric
      metrics;

    /*
      Generate caption image.
    */
    caption_image=CloneImage(image,image->columns,1,MagickTrue,exception);
    if (caption_image == (Image *) NULL)
      return((Image *) NULL);
    image_info=AcquireImageInfo();
    annotate_info=CloneDrawInfo((const ImageInfo *) NULL,draw_info);
    text=InterpretImageProperties(image_info,(Image *) image,caption,
      exception);
    image_info=DestroyImageInfo(image_info);
    (void) CloneString(&annotate_info->text,text);
    count=FormatMagickCaption(caption_image,annotate_info,MagickTrue,&metrics,
      &text,exception);
    status=SetImageExtent(caption_image,image->columns,(size_t) ((count+1)*
      (metrics.ascent-metrics.descent)+0.5),exception);
    if (status == MagickFalse)
      caption_image=DestroyImage(caption_image);
    else
    {
      caption_image->background_color=image->border_color;
      (void) SetImageBackgroundColor(caption_image,exception);
      (void) CloneString(&annotate_info->text,text);
      (void) FormatLocaleString(geometry,MagickPathExtent,"+0+%.20g",
        metrics.ascent);
      if (annotate_info->gravity == UndefinedGravity)
        (void) CloneString(&annotate_info->geometry,AcquireString(
          geometry));
      (void) AnnotateImage(caption_image,annotate_info,exception);
      height+=caption_image->rows;
    }
    annotate_info=DestroyDrawInfo(annotate_info);
    text=DestroyString(text);
  }
  /*
    Apply shadow to image.
  */
  shadow_image=ShadowImage(polaroid_image,80.0,2.0,0,0,exception);
  if (shadow_image == (Image *) NULL)
  {
    polaroid_image=DestroyImage(polaroid_image);
    return((Image *) NULL);
  }
  image_view=AcquireVirtualCacheView(image,exception);
  shadow_view=AcquireAuthenticCacheView(shadow_image,exception);
  for (y=0; y < (ssize_t) image->rows; y++)
  {
    MagickBooleanType
      sync;

    register const Quantum
      *magick_restrict p;

    register ssize_t
      x;

    p=GetCacheViewVirtualPixels(image_view,0,y,image->columns,1,exception);
    if (p == (const Quantum *) NULL)
      continue;
    for (x=0; x < (ssize_t) image->columns; x++)
    {
      Quantum
        alpha;

      alpha=GetPixelAlpha(shadow_image,p);
      if (alpha != OpaqueAlpha)
      {
        Quantum
          red, green, blue;

        red=GetPixelRed(shadow_image,p);
        green=GetPixelGreen(shadow_image,p);
        blue=GetPixelBlue(shadow_image,p);
        SetPixelRed(polaroid_image,red,p);
        SetPixelGreen(polaroid_image,green,p);
        SetPixelBlue(polaroid_image,blue,p);
      }
      p+=GetPixelChannels(image);
    }
    sync=SyncCacheViewAuthenticPixels(shadow_view,exception);
    if (sync == MagickFalse)
      status=MagickFalse;
  }
  shadow_view=DestroyCacheView(shadow_view);
  image_view=DestroyCacheView(image_view);
  if (status == MagickFalse)
    shadow_image=DestroyImage(shadow_image);
  return(shadow_image);
}