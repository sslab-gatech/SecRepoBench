;
  precedence=UndefinedPrecedence;
  while ((c != EOF) && (c != '\0'))
  {
    c=GetNextChar(expression,exception);
    if (c == EOF)
      break;
    if (c == '(')
      level++;
    if (level == 0)
    {
      switch (c)
      {
        case '!':
        case '~':
          if (precedence == UndefinedPrecedence)
            precedence=BitwiseComplementPrecedence;
          break;
        case '^':
          if (precedence == UndefinedPrecedence)
            precedence=ExponentPrecedence;
          break;
        case 'E':
        case 'e':
          if (precedence == UndefinedPrecedence)
            precedence=ExponentialNotationPrecedence;
          break;
        case '*':
        case '/':
        case '%':
          if (precedence == UndefinedPrecedence)
            precedence=MultiplyPrecedence;
          break;
        case '+':
        case '-':
          if (precedence == UndefinedPrecedence)
            precedence=AdditionPrecedence;
          break;
        case '<':
        case '>':
          if (precedence == UndefinedPrecedence)
            precedence=RelationalPrecedence;
          break;
        case '=':
        case '!':
          if (precedence == UndefinedPrecedence)
            precedence=EquivalencyPrecedence;
          break;
        case '&':
          if (precedence == UndefinedPrecedence)
            precedence=BitwiseAndPrecedence;
          break;
        case '|':
          if (precedence == UndefinedPrecedence)
            precedence=BitwiseOrPrecedence;
          break;
        case '&&':
          if (precedence == UndefinedPrecedence)
            precedence=LogicalAndPrecedence;
          break;
        case '||':
          if (precedence == UndefinedPrecedence)
            precedence=LogicalOrPrecedence;
          break;
        case '?':
          if (precedence == UndefinedPrecedence)
            precedence=TernaryPrecedence;
          break;
        case ':':
          if (precedence == TernaryPrecedence)
            precedence=TernaryPrecedence;
          break;
        case ',':
          if (precedence == UndefinedPrecedence)
            precedence=CommaPrecedence;
          break;
        case ';':
        case ' ':
        case '\t':
        case '\n':
        case '\r':
          if (precedence == UndefinedPrecedence)
            precedence=SeparatorPrecedence;
          break;
        case '(':
          if (precedence == UndefinedPrecedence)
            level++;
          break;
        case ')':
          if (precedence == UndefinedPrecedence)
            level--;
          break;
        default:
          if (isalpha((int) ((unsigned char) c)) != 0)
          {
            if (subexpression == (const char *) NULL)
              subexpression=expression;
          }
          else
          {
            if (subexpression != (const char *) NULL)
            {
              target=UndefinedPrecedence;
              if (LocaleCompare(subexpression,"true") == 0)
                target=NullPrecedence;
              if (LocaleCompare(subexpression,"false") == 0)
                target=NullPrecedence;
              if (LocaleCompare(subexpression,"null") == 0)
                target=NullPrecedence;
              if (target != UndefinedPrecedence)
              {
                expression=subexpression+strlen(subexpression);
                return((const char *) NULL);
              }
              subexpression=expression;
            }
          }
          break;
      }
    }
    if (c == ')')
      level--;
  }
  if (subexpression != (const char *) NULL)
  {
    target=UndefinedPrecedence;
    if (LocaleCompare(subexpression,"true") == 0)
      target=NullPrecedence;
    if (LocaleCompare(subexpression,"false") == 0)
      target=NullPrecedence;
    if (LocaleCompare(subexpression,"null") == 0)
      target=NullPrecedence;
    if (target != UndefinedPrecedence)
    {
      expression=subexpression+strlen(subexpression);
      return((const char *) NULL);
    }
  }
  return(expression);
}

static double FxEvaluateSubexpression(FxInfo *fx_info,const PixelChannel pixchannel,
  const ssize_t x,const ssize_t y,const char *expression,size_t *depth,
  double *alpha,ExceptionInfo *exception)
{
  char
    *p,
    *q,
    subexpression[MagickPathExtent];

  const char
    *subexpression_end;

  double
    beta,
    value;

  size_t
    level;

  level=0;
  p=subexpression;
  while ((*expression != '\0') &&
         ((level != 1) || (strchr(")",(int) *expression) == (char *) NULL)))
  {
    if (strchr("(",(int) *expression) != (char *) NULL)
      level++;
    else
      if (strchr(")",(int) *expression) != (char *) NULL)
        level--;
    *p++=(*expression++);
  }
  *p='\0';
  if (*expression == '\0')
    (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
      "UnbalancedParenthesis","`%s'",subexpression);
  expression++;
  subexpression_end=FxOperatorPrecedence(subexpression,exception);
  if (subexpression_end == (const char *) NULL)
    return(0.0);
  *subexpression_end='\0';
  if (LocaleCompare(subexpression,"true") == 0)
    return(1.0);
  if (LocaleCompare(subexpression,"false") == 0)
    return(0.0);
  if (LocaleCompare(subexpression,"null") == 0)
    return(0.0);
  if (LocaleCompare(subexpression,"depth") == 0)
    {
      (*depth)++;
      return(0.0);
    }
  if (LocaleCompare(subexpression,"kurtosis") == 0)
    {
      double
        kurtosis,
        skewness;

      GetImageKurtosis(fx_info->images,&kurtosis,&skewness,exception);
      return(kurtosis);
    }
  if (LocaleCompare(subexpression,"maxima") == 0)
    {
      double
        maxima,
        minima;

      GetImageRange(fx_info->images,&minima,&maxima,exception);
      return(maxima);
    }
  if (LocaleCompare(subexpression,"mean") == 0)
    {
      double
        mean,
        standard_deviation;

      GetImageMean(fx_info->images,&mean,&standard_deviation,exception);
      return(mean);
    }
  if (LocaleCompare(subexpression,"minima") == 0)
    {
      double
        maxima,
        minima;

      GetImageRange(fx_info->images,&minima,&maxima,exception);
      return(minima);
    }
  if (LocaleCompare(subexpression,"skewness") == 0)
    {
      double
        kurtosis,
        skewness;

      GetImageKurtosis(fx_info->images,&kurtosis,&skewness,exception);
      return(skewness);
    }
  if (LocaleCompare(subexpression,"standard_deviation") == 0)
    {
      double
        mean,
        standard_deviation;

      GetImageMean(fx_info->images,&mean,&standard_deviation,exception);
      return(standard_deviation);
    }
  if (LocaleCompare(subexpression,"intensity") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(QuantumScale*GetPixelIntensity(image,fx_info->view[i]));
    }
  if (LocaleCompare(subexpression,"luma") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(QuantumScale*GetPixelLuma(image,fx_info->view[i]));
    }
  if (LocaleCompare(subexpression,"luminance") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(QuantumScale*GetPixelLuminance(image,fx_info->view[i]));
    }
  if (LocaleCompare(subexpression,"hue") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(GetPixelHue(image,fx_info->view[i]));
    }
  if (LocaleCompare(subexpression,"saturation") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(GetPixelSaturation(image,fx_info->view[i]));
    }
  if (LocaleCompare(subexpression,"lightness") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(GetPixelLightness(image,fx_info->view[i]));
    }
  if (LocaleCompare(subexpression,"resolution.x") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
            "NoSuchImage","`%s'",subexpression);
          return(0.0);
        }
      return(image->resolution.x);
    }
  if (LocaleCompare(subexpression,"resolution.y") == 0)
    {
      Image
        *image;

      ssize_t
        i;

      i=GetImageIndexInList(fx_info->images);
      image=GetImageFromList(fx_info->images,i);
      if (image == (Image *) NULL)
        {
          (void) Throw