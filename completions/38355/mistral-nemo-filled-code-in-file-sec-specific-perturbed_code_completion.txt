// <MASK>
template<typename OutputArray>
struct subset_offset_array_t
{
  template <typename InputArray>
  subset_offset_array_t (hb_subset_context_t *subset_context, OutputArray& out,
			 const void *base)
    : subset_context (subset_context), out (out), base (base) {}

  template <typename InputArray>
  bool operator () (InputArray&& input) const
  {
    auto snap = subset_context->serializer->snapshot ();
    auto *o = out.serialize_append (subset_context->serializer);
    if (unlikely (!o)) return false;
    bool ret = o->serialize_subset (subset_context, input, base, subset_context, &tag);
    if (!ret)
    {
      out.pop ();
      subset_context->serializer->revert (snap);
    }
    return ret;
  }

  private:
  hb_subset_context_t *subset_context;
  OutputArray &out;
  const void *base;
  const Tag &tag;
};