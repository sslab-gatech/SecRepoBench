xmlNodePtr ret;
xmlNodePtr parent;

if (ctxt->freeElems != NULL) {
    ret = ctxt->freeElems;
    ctxt->freeElems = ret->next;
    ctxt->freeElemsNr--;
    memset(ret, 0, sizeof(xmlNode));
    ret->type = XML_ELEMENT_NODE;

    if (ctxt->dictNames)
        ret->name = localname;
    else
        ret->name = xmlStrdup(localname);

    if (ctxt->linenumbers) {
        if (ctxt->input != NULL) {
            if (ctxt->input->line < 65535)
                ret->line = (short) ctxt->input->line;
            else
                ret->line = 65535;
        }
    }

    if (parent == NULL) {
#ifdef DEBUG_SAX_TREE
        xmlGenericError(xmlGenericErrorContext,
            "Setting %s as root\n", localname);
#endif
        xmlAddChild((xmlNodePtr) ctxt->myDoc, (xmlNodePtr) ret);
    } else {
        if (parent->type == XML_ELEMENT_NODE) {
#ifdef DEBUG_SAX_TREE
            xmlGenericError(xmlGenericErrorContext,
                "adding child %s to %s\n", localname, parent->name);
#endif
            xmlAddChild(parent, ret);
        } else {
#ifdef DEBUG_SAX_TREE
            xmlGenericError(xmlGenericErrorContext,
                "adding sibling %s to ", localname);
            xmlDebugDumpOneNode(stderr, parent, 0);
#endif
            xmlAddSibling(parent, ret);
        }
    }

    if (ctxt->node->children == NULL) {
        ctxt->node->children = ret;
        ctxt->node->last = ret;
    } else {
        ret->prev = ctxt->node->last;
        ctxt->node->last->next = ret;
        ctxt->node->last = ret;
    }

    if ((__xmlRegisterCallbacks) && (xmlRegisterNodeDefaultValue))
        xmlRegisterNodeDefaultValue(ret);
} else {
    if (ctxt->dictNames)
        ret = xmlNewDocNodeEatName(ctxt->myDoc, NULL,
                                   (xmlChar *) localname, NULL);
    else
        ret = xmlNewDocNode(ctxt->myDoc, NULL, localname, NULL);
    if (ret == NULL) {
        xmlSAX2ErrMemory(ctxt, "xmlSAX2StartElementNs");
        return;
    }
}