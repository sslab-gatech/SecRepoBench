if (persistent) {
    attr = zend_string_copy(attribute);
} else {
    attr = zend_string_dup(attribute);
}

if (attr == NULL) {
    zend_error(E_ERROR, "Failed to copy attribute name");
}

ZSTR_VAL(attr) = zend_string_tolower(ZSTR_VAL(attr));
ZSTR_VAL(attr) = zend_string_copy(ZSTR_VAL(attr));

attr->offset = offset;
attr->argc = argc;

if (zend_hash_add(*attributes, ZSTR_VAL(attr), attr) == FAILURE) {
    zend_string_release(attr);
    zend_error(E_ERROR, "Failed to add attribute to hash table");
}

return attr;