ZEND_API zend_attribute *zend_add_attribute(HashTable **attributes, zend_bool persistent, uint32_t offset, zend_string *attribute, uint32_t argc)
{
	if (*attributes == NULL) {
		*attributes = pemalloc(sizeof(HashTable), persistent);
		zend_hash_init(*attributes, 8, NULL, persistent? attr_pfree : attr_free, persistent);
	}

	zend_attribute *attr = pemalloc(ZEND_ATTRIBUTE_SIZE(argc), persistent);

	zend_string *name = zend_string_copy(attribute);
	zend_string *lcname = zend_string_tolower_ex(name, 1);
	zend_string_release(name);

	attr->offset = offset;
	attr->argc = argc;
	attr->name = zend_string_copy(lcname);
	zend_string_release(lcname);
	attr->lcname = zend_string_copy(lcname);
	zend_string_release(lcname);

	if (persistent) {
		zend_hash_update_ptr(*attributes, attr->lcname, attr);
	} else {
		zend_hash_add_ptr(*attributes, attr->lcname, attr);
	}

	return attr;
}