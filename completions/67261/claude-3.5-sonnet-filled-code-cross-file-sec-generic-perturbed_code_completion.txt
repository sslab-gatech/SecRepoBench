u8 *dst = NULL;
u32 res_size = buffer_length;
const char *res = (const char *) data;

#define PROBE_OK(_score, _mime) \
    if (dst) gf_free(dst); \
    *score = _score; \
    return _mime;

if (buffer_length > 3) {
    u32 bom_size = 0;
    if ((data[0]==0xFF) && (data[1]==0xFE)) {
        bom_size = 2;
        dst = gf_malloc(sizeof(char) * (1 + buffer_length));
        res_size = (u32) gf_utf16_to_utf8((u16*) (data+2), buffer_length-2, dst, buffer_length);
        dst[res_size] = 0;
        res = (const char *) dst;
    } else if ((data[0]==0xFE) && (data[1]==0xFF)) {
        bom_size = 2;
        dst = gf_malloc(sizeof(char) * (1 + buffer_length));
        res_size = (u32) gf_utf16_to_utf8((u16*) (data+2), buffer_length-2, dst, buffer_length);
        dst[res_size] = 0;
        res = (const char *) dst;
    } else if ((data[0]==0xEF) && (data[1]==0xBB) && (data[2]==0xBF)) {
        bom_size = 3;
        res = (const char *) data + 3;
        res_size = buffer_length - 3;
    }
}

while (res_size && strchr(" \n\r\t", res[0])) {
    res++;
    res_size--;
}
if (!res_size) {
    if (dst) gf_free(dst);
    return NULL;
}