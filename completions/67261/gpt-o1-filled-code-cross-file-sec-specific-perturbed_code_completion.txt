u8 *dst = NULL;
	u32 res_size = 0;
	const u8 *cur_data = data;
	u32 cur_size = buffer_length;

	/* detect and skip UTF BOM if present */
	if (cur_size >= 3 && cur_data[0] == 0xEF && cur_data[1] == 0xBB && cur_data[2] == 0xBF) {
		cur_data += 3;
		cur_size -= 3;
	} else if (cur_size >= 2 &&
	          ((cur_data[0] == 0xFE && cur_data[1] == 0xFF) || (cur_data[0] == 0xFF && cur_data[1] == 0xFE))) {
		cur_data += 2;
		cur_size -= 2;
	}

	/* allocate a copy of the data for potential modifications */
	dst = (u8 *) gf_malloc(cur_size + 1);
	if (!dst) {
		return NULL;
	}
	memcpy(dst, cur_data, cur_size);
	dst[cur_size] = 0;
	res_size = cur_size;

	/* strip leading whitespace */
	{
		u32 i = 0;
		while (i < res_size && (dst[i] == ' ' || dst[i] == '\t' || dst[i] == '\n' || dst[i] == '\r')) {
			i++;
		}
		if (i > 0) {
			u32 new_size = res_size - i;
			memmove(dst, dst + i, new_size);
			dst[new_size] = 0;
			res_size = new_size;
		}
	}

	/* define a helper macro to clean up and return a MIME type */
	#define PROBE_OK(_score, _mime) \
	do {                           \
		if (dst) gf_free(dst);     \
		*score = (_score);         \
		return (_mime);            \
	} while (0)

	/* the 'data' pointer will now reference our modified buffer */
	data = dst;