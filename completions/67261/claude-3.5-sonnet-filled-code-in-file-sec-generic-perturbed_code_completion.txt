char *dst = NULL;
u32 res_size = buffer_length;
const char *res = data;

if (data[0]==0xEF) {
    dst = gf_malloc(buffer_length+1);
    res_size = (u32) gf_utf8_wcstombs(dst, buffer_length+1, (const unsigned short **) &data);
    res = dst;
} else if ((data[0]==0xFE) && (data[1]==0xFF)) {
    dst = gf_malloc(buffer_length+1);
    res_size = (u32) gf_utf8_wcstombs(dst, buffer_length+1, (const unsigned short **) &data);
    res = dst;
}

while (res[0] && strchr(" \n\r\t", res[0]))
    res++;

#define PROBE_OK(_score, _mime) \
    *score = _score; \
    if (dst) gf_free(dst); \
    return _mime;