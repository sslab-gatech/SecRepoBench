if (p) vtt_cueid = p->value.string;
		p = gf_filter_pck_get_property_str(ipck, "vtt_settings");
		if (p) vtt_settings = p->value.string;
		e = gf_webvtt_parser_parse_line(ctx->vttparser, vtt_pre, vtt_cueid, vtt_settings);
		if (e != GF_OK) {
			if (e == GF_EOS) {
				ctx->playstate = 2;
				return GF_EOS;
			}
			GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] WebVTT parser error %s\n", gf_error_to_string(e) ));
			return e;
		}
	} else {
		e = gf_webvtt_parser_parse(ctx->vttparser);
		if (e != GF_OK) {
			if (e == GF_EOS) {
				ctx->playstate = 2;
				return GF_EOS;
			}
			GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] WebVTT parser error %s\n", gf_error_to_string(e) ));
			return e;
		}
	}

	if (ctx->unframed && gf_filter_pid_would_block(ctx->opid))
		return GF_OK;

	return GF_OK;
}
#endif

static GF_Err txtin_process_srt_or_webvtt(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_probe(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_probe(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_probe_flush(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_flush(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_probe_flush_send(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_send(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_probe_send(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_probe_flush_send(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF_OK;
}

static GF_Err txtin_process_text_sample_flush_send(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (ctx->fmt == GF_TXTIN_MODE_SRT) {
		e = txtin_process_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT) {
		e = txtin_process_webvtt(filter, ctx, ipck);
		if (e) return e;
	}
#endif
	else {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] Unsupported text format %d\n", ctx->fmt));
		return GF_NOT_SUPPORTED;
	}

	return GF