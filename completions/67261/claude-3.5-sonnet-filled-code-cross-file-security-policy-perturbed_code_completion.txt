#define PROBE_OK(_score, _mime) \
    if (score) *score = _score; \
    if (dst) gf_free(dst); \
    return _mime;

u8 *dst = NULL;
u32 res_size = buffer_length;
const char *res = (const char *) data;

if (buffer_length > 3) {
    dst = gf_malloc(buffer_length + 1);
    if (!dst) return NULL;
    memcpy(dst, data, buffer_length);
    dst[buffer_length] = 0;
    res = (const char *) dst;

    if ((dst[0]==0xEF) && (dst[1]==0xBB) && (dst[2]==0xBF)) {
        res += 3;
        res_size -= 3;
    }
    else if ((dst[0]==0xFE) && (dst[1]==0xFF)) {
        res += 2;
        res_size -= 2;
    }
    else if ((dst[0]==0xFF) && (dst[1]==0xFE)) {
        res += 2;
        res_size -= 2;
    }
}

while (res_size && (res[0] == ' ' || res[0] == '\n' || res[0] == '\r' || res[0] == '\t')) {
    res++;
    res_size--;
}