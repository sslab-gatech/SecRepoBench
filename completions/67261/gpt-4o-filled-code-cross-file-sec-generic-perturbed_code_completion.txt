u32 res_size = 0;
    char *dst = NULL;

    // Check for BOM and convert to UTF-8 if necessary
    if (buffer_length >= 3 && data[0] == 0xEF && data[1] == 0xBB && data[2] == 0xBF) {
        data += 3;
        buffer_length -= 3;
    }

    // Allocate memory for the processed data
    dst = (char *)gf_malloc(buffer_length + 1);
    if (!dst) {
        return NULL;
    }

    // Copy data to dst and strip leading whitespace
    while (buffer_length && (*data == ' ' || *data == '\n' || *data == '\t')) {
        data++;
        buffer_length--;
    }
    memcpy(dst, data, buffer_length);
    dst[buffer_length] = '\0';
    res_size = buffer_length;

    // Define the macro for returning MIME type
    #define PROBE_OK(s, mime) do { \
        if (dst) gf_free(dst); \
        *score = s; \
        return mime; \
    } while (0)