// Check for UTF-8 BOM and skip if present
	if (buffer_length >= 3 && data[0] == 0xEF && data[1] == 0xBB && data[2] == 0xBF) {
		data += 3;
		buffer_length -= 3;
	}
	
	// Allocate memory for processed string and copy data
	char *dst = gf_malloc(buffer_length + 1);
	memcpy(dst, data, buffer_length);
	dst[buffer_length] = '\0';
	
	// Strip leading whitespace
	char *txt = dst;
	while (*txt && (*txt == ' ' || *txt == '\n' || *txt == '\t')) {
		txt++;
	}
	
	// Macro for returning MIME type and freeing memory
#define PROBE_OK(s, mime) do { \
	*score = s; \
	fprintf(stderr, "Detected %s\n", mime); \
	if (dst) gf_free(dst); \
	return mime; \
} while(0)