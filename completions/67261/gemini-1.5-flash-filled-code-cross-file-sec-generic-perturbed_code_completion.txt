#define PROBE_OK(a,b) do { \
		score->score = a; \
		score->mime = b; \
		if (dst) gf_free(dst); \
		return (const char *) data; \
	} while (0)

	u32 res_size = buffer_length;
	u8 *dst = NULL;
	char *mime = NULL;
	if (res_size>1024) res_size = 1024;
	dst = (u8 *)gf_malloc(sizeof(u8) * (res_size + 1));
	if (!dst) return NULL;
	memcpy(dst, data, res_size);
	dst[res_size] = 0;

	//skip BOM
	if (res_size>=3) {
		if (!strncmp((char *)dst, "\xEF\xBB\xBF", 3)) {
			memmove(dst, dst + 3, res_size - 2);
			res_size -= 3;
		} else if (!strncmp((char *)dst, "\xFE\xFF", 2)) {
			u32 i;
			for (i=0; i<res_size; i+=2) {
				u8 tmp = dst[i];
				dst[i] = dst[i+1];
				dst[i+1] = tmp;
			}
			res_size -= 1;
		} else if (!strncmp((char *)dst, "\xFF\xFE", 2)) {
			u32 i;
			for (i=0; i<res_size; i+=2) {
				u8 tmp = dst[i];
				dst[i] = dst[i+1];
				dst[i+1] = tmp;
			}
			res_size -= 1;
		}
	}
	//skip leading spaces
	while (res_size && (dst[0] == ' ' || dst[0] == '\t' || dst[0] == '\r' || dst[0] == '\n')) {
		memmove(dst, dst + 1, res_size - 1);
		res_size--;
	}