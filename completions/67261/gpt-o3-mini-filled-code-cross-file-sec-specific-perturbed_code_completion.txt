u32 bom_len = 0, res_size;
char *dst = NULL;

/* Detect BOM (only UTF-8 BOM is processed here) */
if (buffer_length >= 3 && data[0] == 0xEF && data[1] == 0xBB && data[2] == 0xBF)
    bom_len = 3;

/* Allocate buffer for processed data (ensure space for null-terminator) */
res_size = buffer_length - bom_len;
dst = (char *)gf_malloc(res_size + 1);
if (!dst)
    return NULL;
memcpy(dst, data + bom_len, res_size);
dst[res_size] = '\0';

/* Strip leading whitespace characters */
char *trim = dst;
while (*trim && (*trim == ' ' || *trim == '\t' || *trim == '\n' || *trim == '\r'))
    trim++;
if (trim != dst) {
    size_t new_len = strlen(trim);
    memmove(dst, trim, new_len + 1); /* copy including null terminator */
    res_size = (u32)new_len;
}

/* Define macro to return MIME type and free allocated memory */
#ifndef PROBE_OK
#define PROBE_OK(val, type) do { \
    *score = val; \
    gf_free(dst); \
    return type; \
} while(0)
#endif