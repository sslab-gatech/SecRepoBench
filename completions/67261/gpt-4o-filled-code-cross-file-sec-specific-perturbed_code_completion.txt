u8 *dst = NULL;
    u32 res_size = 0;

    // Check for BOM and convert to UTF-8 if necessary
    if (buffer_length >= 3 && data[0] == 0xEF && data[1] == 0xBB && data[2] == 0xBF) {
        data += 3;
        buffer_length -= 3;
    }

    // Allocate memory for the processed data
    dst = (u8 *)gf_malloc(buffer_length + 1);
    if (!dst) {
        return NULL;
    }

    // Copy data to dst and null-terminate
    memcpy(dst, data, buffer_length);
    dst[buffer_length] = '\0';
    res_size = buffer_length;

    // Strip leading whitespace
    while (res_size && (dst[0] == ' ' || dst[0] == '\n' || dst[0] == '\t')) {
        dst++;
        res_size--;
    }

    // Define macro for returning MIME type
    #define PROBE_OK(score_val, mime_type) \
        do { \
            *score = score_val; \
            if (dst) gf_free(dst); \
            return mime_type; \
        } while (0)