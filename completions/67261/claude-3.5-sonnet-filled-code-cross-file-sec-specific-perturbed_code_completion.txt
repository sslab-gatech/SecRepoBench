u8 *dst = NULL;
u32 res_size = buffer_length;
const char *res = (const char *) data;

if (buffer_length > 3) {
    u32 bom_size = 0;
    if ((data[0]==0xFF) && (data[1]==0xFE)) {
        bom_size = 2;
        dst = (u8*)gf_malloc(sizeof(char) * (1 + buffer_length));
        if (!dst) return NULL;
        res_size = (u32) gf_utf16_to_utf8((u16*)data+1, buffer_length/2 - 1, dst, buffer_length);
        dst[res_size] = 0;
        res = (char *)dst;
    } else if ((data[0]==0xEF) && (data[1]==0xBB) && (data[2]==0xBF)) {
        bom_size = 3;
    }
    res += bom_size;
    res_size -= bom_size;
}

while (res_size && strchr(" \n\r\t", res[0])) {
    res++;
    res_size--;
}

#define PROBE_OK(_score, _mime) \
    if (score) *score = _score; \
    if (dst) gf_free(dst); \
    return _mime;