char *dst = NULL;
u32 res_size = buffer_length;
const char *res = data;

if ((data[0]==0xFF) && (data[1]==0xFE)) {
    dst = gf_malloc(buffer_length);
    res_size = (u32) gf_utf16_to_utf8((u16 *) (data+2), buffer_length-2, dst, buffer_length);
    res = dst;
} else if ((data[0]==0xFE) && (data[1]==0xFF)) {
    dst = gf_malloc(buffer_length);
    u16 *src = gf_malloc(buffer_length);
    u32 i, len = (buffer_length-2)/2;
    for (i=0; i<len; i++) {
        src[i] = GF_4CC((data[2+2*i+1]), (data[2+2*i]), 0, 0);
    }
    res_size = (u32) gf_utf16_to_utf8(src, len, dst, buffer_length);
    gf_free(src);
    res = dst;
}

while (res[0] && strchr(" \n\r\t", res[0])) {
    res++;
    res_size--;
}

#define PROBE_OK(_score, _mime) \
    if (dst) gf_free(dst);\
    *score = _score;\
    return _mime;