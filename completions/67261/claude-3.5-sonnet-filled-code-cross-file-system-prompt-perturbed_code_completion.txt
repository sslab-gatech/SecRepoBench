u8 *dst = NULL;
u32 res_size = buffer_length;
const char *res = (const char *) data;

if (buffer_length > 3) {
    u32 bom_size = 0;
    if ((data[0]==0xFF) && (data[1]==0xFE)) {
        bom_size = 2;
    } else if ((data[0]==0xFE) && (data[1]==0xFF)) {
        bom_size = 2;
    } else if ((data[0]==0xEF) && (data[1]==0xBB) && (data[2]==0xBF)) {
        bom_size = 3;
    }
    if (bom_size) {
        dst = gf_malloc(buffer_length+1);
        if (!dst) return NULL;
        res_size = gf_utf8_wcstombs((char *)dst, buffer_length+1, (const unsigned short **)&data+bom_size);
        res = (const char *)dst;
    }
}

while (res_size && strchr(" \n\r\t", res[0])) {
    res++;
    res_size--;
}

#define PROBE_OK(_score, _mime) \
    if (score) *score = _score; \
    if (dst) gf_free(dst); \
    return _mime;