char *dst = NULL;
u32 res_size = buffer_length;
const char *res = data;

if ((data[0]==0xFF) && (data[1]==0xFE)) {
    res_size = (u32) gf_utf16_to_utf8((u16 *) (data+2), buffer_length-2, &dst);
    res = dst;
} else if ((data[0]==0xFE) && (data[1]==0xFF)) {
    u32 i;
    u16 *src = (u16 *) (data+2);
    res_size = (buffer_length-2)/2;
    for (i=0; i<res_size; i++) {
        src[i] = GF_BSWAP16(src[i]);
    }
    res_size = (u32) gf_utf16_to_utf8(src, res_size, &dst);
    res = dst;
} else if ((data[0]==0xEF) && (data[1]==0xBB) && (data[2]==0xBF)) {
    res += 3;
    res_size -= 3;
}

while (res_size && (res[0] == ' ' || res[0] == '\n' || res[0] == '\r' || res[0] == '\t')) {
    res++;
    res_size--;
}

#define PROBE_OK(_score, _mime) \
    *score = _score; \
    if (dst) gf_free(dst); \
    return _mime;