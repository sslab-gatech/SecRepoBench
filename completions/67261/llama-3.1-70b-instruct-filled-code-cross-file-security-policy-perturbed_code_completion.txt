// Initialize variables for processing the data buffer and storing results.
u32 res_size = buffer_length;
char *dst = NULL;
const char *res = (const char *) data;

// Convert the input data into a UTF string using its byte order mark (BOM).
if (gf_strmemstr(data, res_size, "\xef\xbb\xbf")) {
    res += 3;
    res_size -= 3;
} else if (gf_strmemstr(data, res_size, "\xfe\xff")) {
    res += 2;
    res_size -= 2;
} else if (gf_strmemstr(data, res_size, "\xff\xfe")) {
    // Convert UTF-16 to UTF-8
    dst = gf_utf16_to_utf8((const u16 *) data, res_size / 2);
    if (dst) {
        res = dst;
        res_size = (u32) strlen(res);
    }
}

// Assign pointers to the processed data and allocate memory as needed.
if (!dst) {
    dst = gf_strdup(res);
    if (!dst) {
        return NULL;
    }
}

// Strip leading whitespace characters, including spaces, newlines, and tabs, from the processed data.
while (res_size > 0 && (*res =='' || *res == '\n' || *res == '\t')) {
    res++;
    res_size--;
}

// Define a macro to facilitate returning a MIME type and freeing allocated memory when a format is identified.
#define PROBE_OK(score, mime) \
    do { \
        *score = score; \
        if (dst) gf_free(dst); \
        return mime; \
    } while (0)