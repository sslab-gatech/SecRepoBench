AR);
            attr_id = H5Acreate(dset_id,"MATLAB_empty",H5T_NATIVE_INT,
                                aspace_id,H5P_DEFAULT,H5P_DEFAULT);
            if ( 0 > H5Awrite(attr_id,H5T_NATIVE_INT,&empty) )
                err = MATIO_E_GENERIC_WRITE_ERROR;
            H5Sclose(aspace_id);
            H5Aclose(attr_id);
        }
    }

    H5Sclose(mspace_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteCell73(hid_t id,matvar_t *matvar,const char *name,hid_t *refs_id,hsize_t *dims)
{
    int      err = MATIO_E_NO_ERROR;
    hsize_t  rank = matvar->rank;
    hsize_t  i, nelems = 1;
    hid_t    mspace_id, dset_id, space_id, type_id;
    hobj_ref_t *ref_ids;

    for ( i = 0; i < rank; i++ )
        nelems *= dims[i];

    mspace_id = H5Screate_simple(1,&nelems,NULL);
    dset_id = H5Dcreate(id,name,H5T_STD_REF_OBJ,mspace_id,
                        H5P_DEFAULT,H5P_DEFAULT,H5P_DEFAULT);
    space_id = H5Dget_space(dset_id);
    type_id = H5Dget_type(dset_id);

    ref_ids = (hobj_ref_t*)malloc(nelems*sizeof(*ref_ids));
    if ( NULL != ref_ids ) {
        for ( i = 0; i < nelems; i++ ) {
            hobj_ref_t ref;
            Mat_VarWriteRef(*refs_id,matvar,matvar->compression,refs_id,&ref);
            ref_ids[i] = ref;
        }
        H5Dwrite(dset_id,type_id,H5S_ALL,space_id,H5P_DEFAULT,ref_ids);
        free(ref_ids);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    H5Sclose(space_id);
    H5Dclose(dset_id);
    H5Sclose(mspace_id);

    return err;
}

static int
Mat_VarWriteChar73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims)
{
    int      err = MATIO_E_NO_ERROR;
    hsize_t  rank = matvar->rank;
    hsize_t  i, nelems = 1;
    hid_t    mspace_id, dset_id, space_id, type_id;
    char     *data;

    for ( i = 0; i < rank; i++ )
        nelems *= dims[i];

    data = (char*)malloc(nelems);
    if ( NULL != data ) {
        for ( i = 0; i < nelems; i++ )
            data[i] = (char)matvar->data.f8[i];

        mspace_id = H5Screate_simple(1,&nelems,NULL);
        dset_id = H5Dcreate(id,name,H5T_NATIVE_CHAR,mspace_id,
                            H5P_DEFAULT,H5P_DEFAULT,H5P_DEFAULT);
        space_id = H5Dget_space(dset_id);
        type_id = H5Dget_type(dset_id);

        err = Mat_H5WriteData(dset_id, type_id, mspace_id, space_id, 0, data);

        free(data);
        H5Sclose(space_id);
        H5Dclose(dset_id);
        H5Sclose(mspace_id);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_WriteEmptyVariable73(hid_t id,const char *name,hsize_t rank,size_t *dims)
{
    int      err = MATIO_E_NO_ERROR;
    hid_t    mspace_id, dset_id, type_id;

    mspace_id = H5Screate_simple(1,&rank,NULL);
    dset_id = H5Dcreate(id,name,H5T_NATIVE_HSIZE,mspace_id,
                        H5P_DEFAULT,H5P_DEFAULT,H5P_DEFAULT);
    type_id = H5Dget_type(dset_id);

    err = Mat_H5WriteData(dset_id, type_id, mspace_id, H5S_ALL, 0, dims);

    H5Sclose(mspace_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteLogical73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims)
{
    int      err = MATIO_E_NO_ERROR;
    hsize_t  rank = matvar->rank;
    hsize_t  i, nelems = 1;
    hid_t    mspace_id, dset_id, space_id, type_id;
    char     *data;

    for ( i = 0; i < rank; i++ )
        nelems *= dims[i];

    data = (char*)malloc(nelems);
    if ( NULL != data ) {
        for ( i = 0; i < nelems; i++ )
            data[i] = (char)(matvar->data.f8[i] ? 1 : 0);

        mspace_id = H5Screate_simple(1,&nelems,NULL);
        dset_id = H5Dcreate(id,name,H5T_NATIVE_CHAR,mspace_id,
                            H5P_DEFAULT,H5P_DEFAULT,H5P_DEFAULT);
        space_id = H5Dget_space(dset_id);
        type_id = H5Dget_type(dset_id);

        err = Mat_H5WriteData(dset_id, type_id, mspace_id, space_id, 0, data);

        free(data);
        H5Sclose(space_id);
        H5Dclose(dset_id);
        H5Sclose(mspace_id);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteNumeric73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims,hsize_t* max_dims)
{
    int      err = MATIO_E_NO_ERROR;
    hsize_t  rank = matvar->rank;
    hid_t    mspace_id, dset_id, space_id, type_id;
    int      isComplex = matvar->isComplex;
    void     *data;

    if ( matvar->isComplex ) {
        data = ComplexMalloc(Mat_SizeOfComplex(matvar));
    } else {
        data = malloc(Mat_SizeOf(matvar));
    }
    if ( NULL != data ) {
        if ( MAT_C_CHAR == matvar->class_type ) {
            err = Mat_VarWriteChar73(id,matvar,name,dims);
        } else if ( MAT_C_CELL == matvar->class_type ) {
            err = Mat_VarWriteCell73(id,matvar,name,matvar->internal->refs_id,dims);
        } else if ( MAT_C_LOGICAL == matvar->class_type ) {
            err = Mat_VarWriteLogical73(id,matvar,name,dims);
        } else {
            if ( NULL != max_dims ) {
                mspace_id = H5Screate_simple(rank,dims,max_dims);
            } else {
                mspace_id = H5Screate_simple(rank,dims,NULL);
            }
            dset_id = H5Dcreate(id,name,DataType(matvar->data_type,isComplex),
                                mspace_id,H5P_DEFAULT,H5P_DEFAULT,H5P_DEFAULT);
            space_id = H5Dget_space(dset_id);
            type_id = H5Dget_type(dset_id);

            err = Mat_H5WriteData(dset_id, type_id, mspace_id, space_id, isComplex, data);

            free(data);
            H5Sclose(space_id);
            H5Dclose(dset_id);
            H5Sclose(mspace_id);
        }
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteAppendNumeric73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims,int dim)
{
    int      err = MATIO_E_NO_ERROR;
    hsize_t  rank = matvar->rank;
    hid_t    mspace_id, dset_id, space_id, type_id;
    int      isComplex = matvar->isComplex;
    void     *data;

    if ( matvar->isComplex ) {
        data = ComplexMalloc(Mat_SizeOfComplex(matvar));
    } else {
        data = malloc(Mat_SizeOf(matvar));
    }
    if ( NULL != data ) {
        if ( MAT_C_CHAR == matvar->class_type ) {
            err = Mat_VarWriteChar73(id,matvar,name,dims);
        } else if ( MAT_C_CELL == matvar->class_type ) {
            err = Mat_VarWriteCell73(id,matvar,name,matvar->internal->refs_id,dims);
        } else if ( MAT_C_LOGICAL == matvar->class_type ) {
            err = Mat_VarWriteLogical73(id,matvar,name,dims);
        } else {
            if ( NULL != matvar->max_dims ) {
                mspace_id = H5Screate_simple(rank,dims,matvar->max_dims);
            } else {
                mspace_id = H5Screate_simple(rank,dims,NULL);
            }
            dset_id = H5Dopen(id,name,H5P_DEFAULT);
            space_id = H5Dget_space(dset_id);
            type_id = H5Dget_type(dset_id);

            err = Mat_H5WriteAppendData(dset_id, DataType(matvar->data_type,isComplex), rank, name, dims, dims, dim, isComplex, data);

            free(data);
            H5Sclose(space_id);
            H5Dclose(dset_id);
            H5Sclose(mspace_id);
        }
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteSparse73(hid_t id,matvar_t *matvar,const char *name)
{
    int      err = MATIO_E_NO_ERROR;
    hsize_t  rank = matvar->rank;
    hsize_t  i, nelems = 1;
    hid_t    mspace_id, dset_id, space_id, type_id;
    char     *data;

    for ( i = 0; i < rank; i++ )
        nelems *= matvar->dims[i];

    data = (char*)malloc(nelems);
    if ( NULL != data ) {
        for ( i = 0; i < nelems; i++ )
            data[i] = (char)(matvar->data.f8[i] ? 1 : 0);

        mspace_id = H5