buf = in->base;
    len = in->length;
    if (len > 3) {
        len -= 3;
    } else {
        len = 0;
    }

    for (;in->cur < in->base + len;) {
        if (incomment) {
            if ((in->cur[0] == '-') && (in->cur[1] == '-') &&
                (in->cur[2] == '>')) {
                in->cur += 3;
                incomment = 0;
                continue;
            }
        } else if (!ignoreAttrValue || !invalue) {
            if ((in->cur[0] == '<') && (in->cur[1] == '!') &&
                (in->cur[2] == '-') && (in->cur[3] == '-')) {
                in->cur += 4;
                incomment = 1;
                continue;
            }
        }
        if (!incomment && !invalue && (in->cur[0] == first)) {
            if (next == 0) {
                in->checkIndex = (in->cur - buf) + 1;
                return(in->checkIndex);
            }
            if ((in->cur[1] == next) &&
                ((third == 0) || (in->cur[2] == third))) {
                in->checkIndex = (in->cur - buf) + 1;
                return(in->checkIndex);
            }
        }
        if ((!incomment) && (!invalue) && (in->cur[0] == '<') &&
            (xmlIsNameStartChar(ctxt, in->cur[1]))) {
            int j = 1;
            while (xmlIsNameChar(ctxt, in->cur[j]))
                j++;
            if (in->cur[j] == '=') {
                invalue = 1;
                valdellim = 0;
            }
        } else if (invalue && (valdellim == 0) &&
                   ((in->cur[0] == '\'') || (in->cur[0] == '"'))) {
            valdellim = in->cur[0];
        } else if (invalue && (valdellim == in->cur[0])) {
            invalue = 0;
            valdellim = 0;
        }
        in->cur++;
    }
    in->checkIndex = (in->cur - buf);