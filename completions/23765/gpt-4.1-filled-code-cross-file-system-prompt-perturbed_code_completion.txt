if (in->buf == NULL) {
        buf = in->cur;
        len = in->length - (in->cur - in->base);
    } else {
        buf = in->cur;
        len = (int)xmlBufUse(in->buf->buffer) - (in->cur - in->base);
    }
    if (len <= 0)
        return (-1);

    /* Adjust len to avoid overrun for 3-char search */
    if (third != 0)
        len -= 2;
    else if (next != 0)
        len -= 1;

    int i;
    for (i = 0; i < len; i++) {
        xmlChar c = buf[i];

        /* Handle comment state */
        if (iscomment) {
            if (!incomment) {
                if ((c == '-') && (buf[i+1] == '-') && (buf[i+2] == '>')) {
                    incomment = 1;
                    i += 2;
                    continue;
                }
            } else {
                if ((c == '-') && (buf[i+1] == '-') && (buf[i+2] == '>')) {
                    incomment = 0;
                    i += 2;
                    continue;
                }
                continue;
            }
        }

        /* Handle attribute value skipping if requested */
        if (ignoreAttrValue) {
            if (!invalue) {
                if ((c == '\'') || (c == '"')) {
                    invalue = 1;
                    valdellim = c;
                    continue;
                }
            } else {
                if (c == valdellim) {
                    invalue = 0;
                    continue;
                }
                continue;
            }
        }

        /* Check for sequence */
        if (c == first) {
            if (next == 0) {
                ctxt->checkIndex = i + 1;
                return (i);
            } else if (buf[i+1] == next) {
                if (third == 0) {
                    ctxt->checkIndex = i + 2;
                    return (i);
                } else if (buf[i+2] == third) {
                    ctxt->checkIndex = i + 3;
                    return (i);
                }
            }
        }
    }
    ctxt->checkIndex = i;