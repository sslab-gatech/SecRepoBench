buf = in->cur;
    len = in->end - buf;
    if (next == 0)
        len = 1;
    else if (third == 0)
        len = 2;
    else
        len = 3;
    if (len > in->end - in->cur)
        len = in->end - in->cur;
    if (len <= 0)
        return (-1);
    incomment = iscomment;
    invalue = ignoreAttrValue;
    while (len > 0) {
        if (incomment) {
            if (*buf == '-') {
                if (len > 1 && buf[1] == '-') {
                    if (len > 2 && buf[2] == '>') {
                        incomment = 0;
                        buf += 3;
                        len -= 3;
                        in->cur = buf;
                        ctxt->checkIndex = in->cur - in->base;
                        return (ctxt->checkIndex);
                    }
                }
            }
        } else if (invalue) {
            if (*buf == valdellim) {
                invalue = 0;
                valdellim = 0x0;
            } else if (*buf == '"') {
                valdellim = '"';
            } else if (*buf == '\'') {
                valdellim = '\'';
            }
        } else if (*buf == '<') {
            if (len > 1 && buf[1] == '!') {
                if (len > 2 && buf[2] == '-') {
                    if (len > 3 && buf[3] == '-') {
                        incomment = 1;
                    }
                }
            } else if (len > 1 && buf[1] == '/') {
                /*
                 * this is an end tag, we don't want to parse it
                 * here.
                 */
                break;
            }
        } else if (*buf == first) {
            if (next == 0) {
                in->cur++;
                ctxt->checkIndex = in->cur - in->base;
                return (ctxt->checkIndex);
            } else if (len > 1 && buf[1] == next) {
                if (third == 0) {
                    in->cur += 2;
                    ctxt->checkIndex = in->cur - in->base;
                    return (ctxt->checkIndex);
                } else if (len > 2 && buf[2] == third) {
                    in->cur += 3;
                    ctxt->checkIndex = in->cur - in->base;
                    return (ctxt->checkIndex);
                }
            }
        }
        buf++;
        len--;
    }
    in->cur = buf;
    ctxt->checkIndex = in->cur - in->base;