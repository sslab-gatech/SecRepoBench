len = in->length - base;
    buf = in->base + base;

    if (len <= 0 || buf == NULL)
        return (-1);

    for (int i = 0; i < len; i++) {
        xmlChar cur = buf[i];

        // Check if we are inside a comment
        if (iscomment) {
            if (incomment) {
                if (cur == '-' && i + 2 < len && buf[i + 1] == '-' && buf[i + 2] == '>') {
                    incomment = 0;
                    i += 2; // Skip past the end of the comment
                }
                continue;
            } else if (cur == '<' && i + 3 < len && buf[i + 1] == '!' && buf[i + 2] == '-' && buf[i + 3] == '-') {
                incomment = 1;
                i += 3; // Skip past the start of the comment
                continue;
            }
        }

        // Check if we are inside an attribute value
        if (ignoreAttrValue) {
            if (invalue) {
                if (cur == valdellim) {
                    invalue = 0;
                    valdellim = 0x0;
                }
                continue;
            } else if (cur == '"' || cur == '\'') {
                invalue = 1;
                valdellim = cur;
                continue;
            }
        }

        // Match the sequence
        if (cur == first) {
            if (next == 0) {
                return (i + base);
            } else if (i + 1 < len && buf[i + 1] == next) {
                if (third == 0) {
                    return (i + base);
                } else if (i + 2 < len && buf[i + 2] == third) {
                    return (i + base);
                }
            }
        }
    }

    ctxt->checkIndex = base + len;