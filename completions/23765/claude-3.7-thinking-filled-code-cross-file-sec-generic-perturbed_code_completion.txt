buf = in->base;
if (in->buf != NULL)
    len = xmlBufUse(in->buf->buffer);
else
    len = in->length;

// Initialize or use existing checkIndex
if (ctxt->checkIndex == 0)
    ctxt->checkIndex = in->cur - in->base;

// Ensure checkIndex is within bounds
if (ctxt->checkIndex < 0)
    ctxt->checkIndex = 0;
else if (ctxt->checkIndex > (ptrdiff_t)(len))
    ctxt->checkIndex = len;

// Position at checkIndex
in->cur = in->base + ctxt->checkIndex;

while ((in->cur < in->base + len) && (in->cur[0] != 0)) {
    // Handle comments if needed
    if (iscomment && !incomment) {
        // Safely check for comment start
        if ((in->cur <= in->base + len - 4) && 
            (in->cur[0] == '<') && (in->cur[1] == '!') &&
            (in->cur[2] == '-') && (in->cur[3] == '-')) {
            incomment = 1;
            in->cur += 4;
            ctxt->checkIndex = in->cur - in->base;
            continue;
        }
    }

    // Skip attribute values if needed
    if (ignoreAttrValue && !incomment) {
        if (!invalue && (in->cur < in->base + len) && 
            ((in->cur[0] == '"') || (in->cur[0] == '\''))) {
            invalue = 1;
            valdellim = in->cur[0];
            in->cur++;
            ctxt->checkIndex = in->cur - in->base;
            continue;
        }
        if (invalue && (in->cur < in->base + len) && (in->cur[0] == valdellim)) {
            invalue = 0;
            in->cur++;
            ctxt->checkIndex = in->cur - in->base;
            continue;
        }
    }

    // Inside comment, look for end of comment
    if (incomment) {
        if ((in->cur <= in->base + len - 3) && 
            (in->cur[0] == '-') && (in->cur[1] == '-') && (in->cur[2] == '>')) {
            incomment = 0;
            in->cur += 3;
            ctxt->checkIndex = in->cur - in->base;
            continue;
        }
        in->cur++;
        ctxt->checkIndex = in->cur - in->base;
        continue;
    }

    // Skip content in attribute values
    if (invalue) {
        in->cur++;
        ctxt->checkIndex = in->cur - in->base;
        continue;
    }

    // Check for sequence matching
    if (in->cur[0] == first) {
        if (next == 0) {
            // Found single character match
            return (in->cur - in->base);
        }
        if ((in->cur < in->base + len - 1) && (in->cur[1] == next)) {
            if (third == 0) {
                // Found two character match
                return (in->cur - in->base);
            }
            if ((in->cur < in->base + len - 2) && (in->cur[2] == third)) {
                // Found three character match
                return (in->cur - in->base);
            }
        }
    }

    in->cur++;
    ctxt->checkIndex = in->cur - in->base;
}

// Update checkIndex for next call
ctxt->checkIndex = in->cur - in->base;