if (ctxt->checkIndex > base)
        base = ctxt->checkIndex;

    if (in->buf == NULL) {
        buf = in->base;
        len = in->length;
    } else {
        buf = xmlBufContent(in->buf->buffer);
        len = xmlBufUse(in->buf->buffer);
    }

    /* take into account the sequence length */
    if (third)
        len -= 2;
    else if (next)
        len--;

    for (; base < len; base++) {
        xmlChar c = buf[base];

        /* handle comments if requested */
        if (iscomment) {
            if (!incomment) {
                if ((base + 3 < len) &&
                    (c == '<') && (buf[base + 1] == '!') &&
                    (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                    incomment = 1;
                    base += 3;
                    continue;
                }
            } else {
                if ((base + 2 < len) &&
                    (c == '-') && (buf[base + 1] == '-') &&
                    (buf[base + 2] == '>')) {
                    incomment = 0;
                    base += 2;
                }
                continue;
            }
        }

        /* handle attribute values if ignoring them */
        if (ignoreAttrValue) {
            if (invalue) {
                if (c == valdellim)
                    invalue = 0;
                continue;
            } else {
                if ((c == '"') || (c == '\'')) {
                    invalue = 1;
                    valdellim = c;
                    continue;
                }
            }
        }

        /* check for the match of the search sequence */
        if (c == first) {
            if (third != 0) {
                if ((buf[base + 1] != next) ||
                    (buf[base + 2] != third))
                    continue;
            } else if (next != 0) {
                if (buf[base + 1] != next)
                    continue;
            }
            ctxt->checkIndex = 0;
            return (base - (in->cur - in->base));
        }
    }

    ctxt->checkIndex = base;
    return (-1);