buf = in->cur;
len = in->length - base;

while (len > 0) {
    if (iscomment && incomment) {
        if (*buf == '-' && *(buf + 1) == '-' && *(buf + 2) == '>') {
            incomment = 0;
            buf += 3;
            len -= 3;
            continue;
        }
    } else if (ignoreAttrValue && invalue) {
        if (*buf == valdellim) {
            invalue = 0;
        }
    } else {
        if (*buf == '<' && *(buf + 1) == '!' && *(buf + 2) == '-' && *(buf + 3) == '-') {
            incomment = 1;
            buf += 4;
            len -= 4;
            continue;
        } else if (*buf == '"' || *buf == '\'') {
            invalue = 1;
            valdellim = *buf;
        } else if (*buf == first) {
            if (next == 0 || (*(buf + 1) == next && (third == 0 || *(buf + 2) == third))) {
                ctxt->checkIndex = buf - in->base;
                return (buf - in->cur);
            }
        }
    }
    buf++;
    len--;
}

return (-1);