buf = in->base;
    len = in->length;
    if (in->buf != NULL) {
        buf = xmlBufContent(in->buf->buffer);
        len = xmlBufUse(in->buf->buffer);
    }

    if (base + 1 > len)
        return (-1);

    for (; base < len; base++) {
        if (buf[base] == '<' && buf[base + 1] == '!' && buf[base + 2] == '-' && buf[base + 3] == '-') {
            incomment = 1;
            base += 3;
            continue;
        }
        if (incomment) {
            if (buf[base] == '-' && buf[base + 1] == '-' && buf[base + 2] == '>') {
                incomment = 0;
                base += 2;
                continue;
            }
            continue;
        }
        if (ignoreAttrValue && !incomment) {
            if (buf[base] == '\'' || buf[base] == '"') {
                if (invalue) {
                    if (valdellim == buf[base]) {
                        invalue = 0;
                        valdellim = 0x0;
                    }
                } else {
                    invalue = 1;
                    valdellim = buf[base];
                }
            }
            if (invalue)
                continue;
        }
        if (buf[base] == first) {
            if (next == 0) {
                ctxt->checkIndex = base;
                return (base);
            }
            if (base + 1 >= len)
                return (-1);
            if (buf[base + 1] == next) {
                if (third == 0) {
                    ctxt->checkIndex = base + 1;
                    return (base);
                }
                if (base + 2 >= len)
                    return (-1);
                if (buf[base + 2] == third) {
                    ctxt->checkIndex = base + 2;
                    return (base);
                }
            }
        }
    }