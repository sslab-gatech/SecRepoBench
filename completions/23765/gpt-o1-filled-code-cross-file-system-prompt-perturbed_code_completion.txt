/*
     * Prepare to scan for the requested sequence in the input buffer.
     */
    if (in->buf == NULL) {
        len = in->length - base;
        buf = in->base + base;
    } else {
        len = (int)xmlBufUse(in->buf->buffer) - (in->cur - in->base);
        buf = in->base + base;
    }

    /*
     * We adjust len so there's enough room for comparison
     * of up to three characters.
     */
    if (third != 0)
        len -= 2;
    else if (next != 0)
        len -= 1;

    /*
     * Scan the buffer for the specified sequence.
     */
    for (int i = 0; i < len; i++) {
        xmlChar c = buf[i];

        /*
         * Check for the start or end of a comment if needed.
         */
        if (!incomment && c == '<' && (i + 3) < len &&
            buf[i + 1] == '!' && buf[i + 2] == '-' && buf[i + 3] == '-') {
            incomment = 1;
            i += 3; /* Advance past <!-- */
            continue;
        } else if (incomment) {
            /* Look for the end of comment: --> */
            if ((i + 2) < len && c == '-' && buf[i + 1] == '-' && buf[i + 2] == '>') {
                incomment = 0;
                i += 2; /* Advance past --> */
            }
            continue;
        }

        /*
         * If ignoring attribute values, track whether we are
         * inside a quoted value and skip it.
         */
        if (ignoreAttrValue) {
            if (!invalue) {
                if (c == '"' || c == '\'') {
                    invalue = 1;
                    valdellim = c;
                    continue;
                }
            } else {
                if (c == valdellim)
                    invalue = 0;
                continue;
            }
        }

        /*
         * Attempt to match the sequence:
         *   first,
         *   optional second,
         *   optional third.
         */
        if (c == first) {
            if (next == 0) {
                /* Sequence of one char found */
                in->cur = in->base + (base + i);
                ctxt->checkIndex = i;
                return (i);
            } else if ((i + 1) < len && buf[i + 1] == next) {
                if (third == 0) {
                    /* Sequence of two chars found */
                    in->cur = in->base + (base + i);
                    ctxt->checkIndex = i;
                    return (i);
                } else if ((i + 2) < (len + 1) && buf[i + 2] == third) {
                    /* Sequence of three chars found */
                    in->cur = in->base + (base + i);
                    ctxt->checkIndex = i;
                    return (i);
                }
            }
        }
    }

    /*
     * If we get here, the sequence wasn't found.
     * Update checkIndex and return -1.
     */
    ctxt->checkIndex = len;