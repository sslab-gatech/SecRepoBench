buf = in->base;
    len = in->length;
    if (len > 3) {
        len -= 3;
    }

    for (;in->cur < in->base + len;) {
        if (incomment) {
            if ((in->cur[0] == '-') && (in->cur[1] == '-') && (in->cur[2] == '>')) {
                in->cur += 3;
                incomment = 0;
                continue;
            }
        } else if (invalue && ignoreAttrValue) {
            if (in->cur[0] == valdellim) {
                invalue = 0;
                valdellim = 0x0;
            }
        } else if (in->cur[0] == '<') {
            if ((in->cur[1] == '!') && (in->cur[2] == '-') && (in->cur[3] == '-')) {
                incomment = 1;
                in->cur += 4;
                continue;
            }
        } else if (ignoreAttrValue && (in->cur[0] == '"' || in->cur[0] == '\'')) {
            invalue = 1;
            valdellim = in->cur[0];
        } else if (in->cur[0] == first) {
            if (next == 0)
                return (in->cur - buf);
            if (in->cur[1] == next) {
                if (third == 0)
                    return (in->cur - buf);
                if (in->cur[2] == third)
                    return (in->cur - buf);
            }
        }
        in->cur++;
    }

    ctxt->checkIndex = (in->cur - buf);