if (ctxt->checkIndex > base)
        base = ctxt->checkIndex;

    if (in->buf == NULL) {
        buf = in->base;
        len = in->length;
    } else {
        buf = xmlBufContent(in->buf->buffer);
        len = xmlBufUse(in->buf->buffer);
    }

    /* Adjust length to leave room for comparing up to 3 chars */
    len -= (third ? 2 : (next ? 1 : 0));

    for (; base < len; base++) {
        xmlChar c = buf[base];

        /*
         * If scanning in comments, detect start of comment <!--
         * and skip until end of comment --> if iscomment is set
         */
        if (iscomment) {
            if (!incomment) {
                if ((base + 3 < len) &&
                    (c == '<') && (buf[base + 1] == '!') &&
                    (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                    incomment = 1;
                    base += 3; /* move index to after <!-- */
                    continue;
                }
            } else {
                /* In a comment, look for --> */
                if ((base + 2 < len) &&
                    (c == '-') && (buf[base + 1] == '-') &&
                    (buf[base + 2] == '>')) {
                    incomment = 0;
                    base += 2; /* move index to after --> */
                    continue;
                } else {
                    /* still in comment */
                    continue;
                }
            }
        }

        /*
         * If ignoring attribute value text, detect start and end quotes
         */
        if (ignoreAttrValue) {
            if (!invalue) {
                if ((c == '\'') || (c == '\"')) {
                    valdellim = c; /* record quote char */
                    invalue = 1;
                    continue;
                }
            } else {
                /* skipping everything until we see the matching quote */
                if (c == (xmlChar)valdellim) {
                    invalue = 0;
                }
                continue;
            }
        }

        /*
         * Now check if the sequence matches (first, next, third)
         */
        if (c == first) {
            if (next == 0) {
                /* single-char sequence */
                ctxt->checkIndex = 0;
                return (base - (in->cur - in->base));
            }
            if ((base + 1 < len) && buf[base + 1] == next) {
                if (third == 0) {
                    /* two-char sequence */
                    ctxt->checkIndex = 0;
                    return (base - (in->cur - in->base));
                }
                if ((base + 2 < len) && buf[base + 2] == third) {
                    /* three-char sequence */
                    ctxt->checkIndex = 0;
                    return (base - (in->cur - in->base));
                }
            }
        }
    }

    /*
     * If not found, update the checkIndex to the current scan point
     * and return -1
     */
    ctxt->checkIndex = base;
#ifdef DEBUG_PUSH
    if (next == 0) {
        xmlGenericError(xmlGenericErrorContext,
                        "HPP: lookup '%c' failed\n", first);
    } else if (third == 0) {
        xmlGenericError(xmlGenericErrorContext,
                        "HPP: lookup '%c%c' failed\n", first, next);
    } else {
        xmlGenericError(xmlGenericErrorContext,
                        "HPP: lookup '%c%c%c' failed\n", first, next, third);
    }
#endif
    return (-1);