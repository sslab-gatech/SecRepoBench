buf = in->cur;
len = in->length - (in->cur - in->base);

if (len < 0) {
    return (-1);
}

for (int i = 0; i < len; ++i) {
    if (buf[i] == '<' && !incomment) {
        if ((i + 3 < len) && buf[i + 1] == '!' && buf[i + 2] == '-' && buf[i + 3] == '-') {
            incomment = 1;
            continue;
        }
    } else if (buf[i] == '>' && incomment) {
        if ((i >= 2) && buf[i - 1] == '-' && buf[i - 2] == '-') {
            incomment = 0;
            continue;
        }
    }

    if (ignoreAttrValue && invalue) {
        if (buf[i] == valdellim) {
            invalue = 0;
        }
        continue;
    }

    if ((buf[i] == '\'' || buf[i] == '"') && !incomment) {
        invalue = 1;
        valdellim = buf[i];
        continue;
    }

    if (buf[i] == first) {
        if (next == 0) {
            ctxt->checkIndex = base + i + 1;
            return base + i;
        } else if (i + 1 < len && buf[i + 1] == next) {
            if (third == 0) {
                ctxt->checkIndex = base + i + 2;
                return base + i;
            } else if (i + 2 < len && buf[i + 2] == third) {
                ctxt->checkIndex = base + i + 3;
                return base + i;
            }
        }
    }
}

ctxt->checkIndex = base + len;
return (-1);