buf = in->cur;
    len = in->end - buf;

    if ((next != 0) && (len > 1)) {
        if ((third != 0) && (len > 2)) {
            len -= 2;
        } else {
            len -= 1;
        }
    }

    for (int i = 0; i < len; i++) {
        if (iscomment) {
            if ((buf[i] == '-') && (i + 2 < len) && (buf[i + 1] == '-') &&
                (buf[i + 2] == '>')) {
                i += 2;
                incomment = 0;
            }
            if (incomment)
                continue;
        }
        if (ignoreAttrValue) {
            if (buf[i] == '\'' || buf[i] == '"') {
                if (invalue == 0) {
                    invalue = 1;
                    valdellim = buf[i];
                } else if (buf[i] == valdellim) {
                    invalue = 0;
                }
            }
            if (invalue)
                continue;
        }
        if (buf[i] == '<' && buf[i + 1] == '!' && buf[i + 2] == '-' &&
            buf[i + 3] == '-') {
            incomment = 1;
            continue;
        }

        if (buf[i] == first) {
            if (next == 0) {
                ctxt->checkIndex = base + i;
                return (base + i);
            } else if ((i + 1 < len) && (buf[i + 1] == next)) {
                if (third == 0) {
                    ctxt->checkIndex = base + i;
                    return (base + i);
                } else if ((i + 2 < len) && (buf[i + 2] == third)) {
                    ctxt->checkIndex = base + i;
                    return (base + i);
                }
            }
        }
    }
    ctxt->checkIndex = base + len;