if (ctxt->checkIndex > base)
    base = ctxt->checkIndex;

if (in->buf == NULL) {
    buf = in->base;
    len = in->length;
} else {
    buf = xmlBufContent(in->buf->buffer);
    len = xmlBufUse(in->buf->buffer);
}
/* take into account the sequence length */
if (third) len -= 2;
else if (next) len --;
for (;base < len;base++) {
    if (incomment) {
        if (base + 3 > len)
            return (-1);
        if ((buf[base] == '-') && (buf[base + 1] == '-') &&
            (buf[base + 2] == '>')) {
            incomment = 0;
            base += 2;
        }
        continue;
    }
    if (invalue) {
        if (buf[base] == valdellim) {
            invalue = 0;
            valdellim = 0x0;
        }
        continue;
    }
    if (buf[base] == first) {
        if (third!= 0) {
            if ((buf[base + 1]!= next) ||
                (buf[base + 2]!= third)) continue;
        } else if (next!= 0) {
            if (buf[base + 1]!= next) continue;
        }
        if (ignoreAttrValue) {
            if (buf[base + 1] == '=')
                invalue = 1;
            else if (buf[base + 1] =='')
                continue;
            else if (buf[base + 1] == '>') {
                if (iscomment)
                    incomment = 1;
                continue;
            }
        }
        if (iscomment) {
            incomment = 1;
            base += 2;
        }
        ctxt->checkIndex = 0;
        return(base - (in->cur - in->base));
    }
    if (buf[base] == '<') {
        if (base + 4 < len) {
            if ((buf[base + 1] == '!') && (buf[base + 2] == '-') &&
                (buf[base + 3] == '-'))
                incomment = 1;
        }
    }
    if (buf[base] == '"' || buf[base] == '\'') {
        valdellim = buf[base];
        invalue = 1;
    }
}
ctxt->checkIndex = base;