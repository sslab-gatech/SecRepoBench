if (in->buf == NULL) {
            buf = in->base;
            len = in->length;
        } else {
            buf = xmlBufContent(in->buf->buffer);
            len = xmlBufUse(in->buf->buffer);
        }

        if (base + ctxt->checkIndex >= len)
            return (-1);

        if (third) {
            for (; base < len; base++) {
                if (!incomment && !invalue && (base + 4 < len) && ignoreAttrValue) {
                    if ((buf[base] == '<') && (buf[base + 1] == '!') &&
                        (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                        incomment = 1;
                        /* do not increment past <! - some people use <!--> */
                        base += 2;
                    }
                }
                if (!incomment && ignoreAttrValue) {
                    if (buf[base] == valdellim) {
                        invalue = 0;
                        valdellim = 0x0;
                    } else if ((buf[base] == '\'') || (buf[base] == '"')) {
                        invalue = 1;
                        valdellim = buf[base];
                    }
                }
                if (incomment) {
                    if (base + 3 > len)
                        return (-1);
                    if ((buf[base] == '-') && (buf[base + 1] == '-') &&
                        (buf[base + 2] == '>')) {
                        incomment = 0;
                        base += 2;
                    }
                    continue;
                }
                if (invalue)
                    continue;
                if (buf[base] == first) {
                    if (buf[base + 1] == next) {
                        if (buf[base + 2] == third) {
                            ctxt->checkIndex = 0;
                            return (base - (in->cur - in->base));
                        }
                    }
                }
            }
        } else if (next) {
            for (; base < len; base++) {
                if (!incomment && !invalue && (base + 4 < len) && ignoreAttrValue) {
                    if ((buf[base] == '<') && (buf[base + 1] == '!') &&
                        (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                        incomment = 1;
                        /* do not increment past <! - some people use <!--> */
                        base += 2;
                    }
                }
                if (!incomment && ignoreAttrValue) {
                    if (buf[base] == valdellim) {
                        invalue = 0;
                        valdellim = 0x0;
                    } else if ((buf[base] == '\'') || (buf[base] == '"')) {
                        invalue = 1;
                        valdellim = buf[base];
                    }
                }
                if (incomment) {
                    if (base + 3 > len)
                        return (-1);
                    if ((buf[base] == '-') && (buf[base + 1] == '-') &&
                        (buf[base + 2] == '>')) {
                        incomment = 0;
                        base += 2;
                    }
                    continue;
                }
                if (invalue)
                    continue;
                if (buf[base] == first) {
                    if (buf[base + 1] == next) {
                        ctxt->checkIndex = 0;
                        return (base - (in->cur - in->base));
                    }
                }
            }
        } else {
            for (; base < len; base++) {
                if (!incomment && !invalue && (base + 4 < len) && ignoreAttrValue) {
                    if ((buf[base] == '<') && (buf[base + 1] == '!') &&
                        (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                        incomment = 1;
                        /* do not increment past <! - some people use <!--> */
                        base += 2;
                    }
                }
                if (!incomment && ignoreAttrValue) {
                    if (buf[base] == valdellim) {
                        invalue = 0;
                        valdellim = 0x0;
                    } else if ((buf[base] == '\'') || (buf[base] == '"')) {
                        invalue = 1;
                        valdellim = buf[base];
                    }
                }
                if (incomment) {
                    if (base + 3 > len)
                        return (-1);
                    if ((buf[base] == '-') && (buf[base + 1] == '-') &&
                        (buf[base + 2] == '>')) {
                        incomment = 0;
                        base += 2;
                    }
                    continue;
                }
                if (invalue)
                    continue;
                if (buf[base] == first) {
                    ctxt->checkIndex = 0;
                    return (base - (in->cur - in->base));
                }
            }
        }
        ctxt->checkIndex = base;