buf = in->base;
    len = in->length;
    if (len > 3) {
        len -= 3;
    }
    for (;in->cur < in->base + len;) {
        if (incomment) {
            if ((in->cur[0] == '-') && (in->cur[1] == '-') && (in->cur[2] == '>')) {
                incomment = 0;
                in->cur += 3;
                continue;
            }
        } else if (!ignoreAttrValue || !invalue) {
            if ((in->cur[0] == '<') && (in->cur[1] == '!') && (in->cur[2] == '-') && (in->cur[3] == '-')) {
                incomment = 1;
                in->cur += 4;
                continue;
            }
        }
        if (!incomment && ignoreAttrValue && !invalue) {
            if (in->cur[0] == '=') {
                invalue = 1;
                valdellim = 0x0;
            }
        } else if (!incomment && ignoreAttrValue && invalue) {
            if (valdellim == 0x0) {
                if (in->cur[0] == '"' || in->cur[0] == '\'')
                    valdellim = in->cur[0];
                else
                    valdellim = ' ';
            } else if (in->cur[0] == valdellim) {
                invalue = 0;
            }
        }
        if (!incomment && !invalue && (in->cur[0] == first)) {
            if (next == 0)
                return (in->cur - buf);
            if ((in->cur[1] == next) &&
                ((third == 0) || (in->cur[2] == third)))
                return (in->cur - buf);
        }
        NEXT;
    }
    ctxt->checkIndex = (in->cur - buf);