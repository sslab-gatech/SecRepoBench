if (ctxt->checkIndex > base)
        base = ctxt->checkIndex;

    if (in->buf == NULL) {
        buf = in->base;
        len = in->length;
    } else {
        buf = xmlBufContent(in->buf->buffer);
        len = xmlBufUse(in->buf->buffer);
    }

    for (; base < len; base++) {
        if (!incomment && (base + 4 < len)) {
            if ((buf[base] == '<') && (buf[base + 1] == '!') &&
                (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                incomment = 1;
                /* do not increment past <! - some people use <!--> */
                base += 2;
            }
        }
        if (incomment) {
            if (base + 3 > len)
                return (-1);
            if ((buf[base] == '-') && (buf[base + 1] == '-') &&
                (buf[base + 2] == '>')) {
                incomment = 0;
                base += 2;
            }
            continue;
        }
        if (ignoreAttrValue && !invalue && (buf[base] == '=')) {
            if (base + 1 < len && (buf[base + 1] == '"' || buf[base + 1] == '\'')) {
                invalue = 1;
                valdellim = buf[base + 1];
                base++;
            }
        } else if (invalue && (buf[base] == valdellim)) {
            invalue = 0;
        } else if (!invalue && buf[base] == first) {
            if ((next == 0) || ((base + 1 < len) && (buf[base + 1] == next))) {
                if ((third == 0) || ((base + 2 < len) && (buf[base + 2] == third))) {
                    ctxt->checkIndex = 0;
                    return (base - (in->cur - in->base));
                }
            }
        }
    }
    ctxt->checkIndex = base;
    return (-1);