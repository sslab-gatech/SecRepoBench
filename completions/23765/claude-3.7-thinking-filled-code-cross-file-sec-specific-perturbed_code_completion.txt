int i;
    
buf = in->base;
len = in->length;

/* Ensure valid buffer */
if (buf == NULL || len <= 0)
    return (-1);

/* Initialize state based on parameters */
incomment = iscomment;

/* Iterate through the buffer starting from current position */
for (i = in->cur - in->base; i < len; i++) {
    /* Handle comments */
    if (incomment) {
        /* Look for comment end */
        if (i + 2 < len && buf[i] == '-' && buf[i + 1] == '-' && buf[i + 2] == '>') {
            incomment = 0;
            i += 2;
        }
        continue;
    }
    
    /* Handle attribute values */
    if (ignoreAttrValue && invalue) {
        if (buf[i] == valdellim)
            invalue = 0;
        continue;
    }
    
    /* Check for attribute value start */
    if (ignoreAttrValue && !invalue && (buf[i] == '\'' || buf[i] == '"')) {
        valdellim = buf[i];
        invalue = 1;
        continue;
    }
    
    /* Check for comment start */
    if (!incomment && i + 3 < len && buf[i] == '<' && buf[i + 1] == '!' &&
        buf[i + 2] == '-' && buf[i + 3] == '-') {
        incomment = 1;
        i += 3;
        continue;
    }
    
    /* Check for sequence match */
    if (buf[i] == first) {
        if (next == 0)
            return i;
        if (i + 1 < len && buf[i + 1] == next) {
            if (third == 0)
                return i;
            if (i + 2 < len && buf[i + 2] == third)
                return i;
        }
    }
}

/* Update checkIndex to optimize future searches */
ctxt->checkIndex = i;