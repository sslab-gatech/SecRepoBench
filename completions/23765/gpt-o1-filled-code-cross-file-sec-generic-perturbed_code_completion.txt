/* Calculate how many characters we need to match (1 to 3). */
    int needed = 1;
    if (next != 0) needed++;
    if (third != 0) needed++;

    /* Obtain the number of remaining characters in the buffer. */
    if (in->buf == NULL) {
        len = in->length - (in->cur - in->base);
    } else {
        len = (int)xmlBufUse(in->buf->buffer) - (in->cur - in->base);
    }
    buf = in->cur;

    /* Scan through the buffer. */
    for (int i = 0; i + needed <= len; i++) {
        xmlChar c = buf[i];

        /* If we are inside a comment, check for its end. */
        if (incomment) {
            if ((i + 2 < len) && (c == '-') && (buf[i+1] == '-') && (buf[i+2] == '>')) {
                incomment = 0;
                i += 2; /* Skip past "-->" */
            }
            continue;
        } 
        /* If we are looking for a comment sequence, check for comment start. */
        else if (iscomment) {
            if ((i + 3 < len) && (c == '<') && (buf[i+1] == '!') &&
                (buf[i+2] == '-') && (buf[i+3] == '-')) {
                incomment = 1;
                i += 3; /* Skip past "<!--" */
                continue;
            }
        }

        /* If ignoring attribute values, skip over quoted strings. */
        if (ignoreAttrValue) {
            if (invalue) {
                /* Check if we've closed the quoted attribute. */
                if (c == valdellim) {
                    invalue = 0;
                }
                continue;
            } else {
                /* Check if we're starting a quoted attribute. */
                if ((c == '"') || (c == '\'')) {
                    valdellim = (char)c;
                    invalue = 1;
                    continue;
                }
            }
        }

        /* Check for the first character of the sequence. */
        if (c == first) {
            if (next == 0) {
                ctxt->checkIndex = base + i + 1;
                return (i);
            }
            /* Check if there's enough room for second char. */
            if (i + 1 < len && buf[i + 1] == next) {
                if (third == 0) {
                    ctxt->checkIndex = base + i + 2;
                    return (i);
                }
                /* Check if there's enough room for third char. */
                if (i + 2 < len && buf[i + 2] == third) {
                    ctxt->checkIndex = base + i + 3;
                    return (i);
                }
            }
        }
    }

    /* If we exit the loop, we didn't find the sequence. */
    ctxt->checkIndex = base + len;