buf = in->cur;
    len = in->end - buf;

    while (len > 0) {
        if (incomment) {
            if (buf[0] == '-' && buf[1] == '-' && buf[2] == '>') {
                incomment = 0;
                buf += 3;
                len -= 3;
                continue;
            }
            buf++;
            len--;
            continue;
        }

        if (ignoreAttrValue && invalue) {
            if (buf[0] == '"' || buf[0] == '\'') {
                invalue = 0;
            }
            buf++;
            len--;
            continue;
        }

        if (buf[0] == '<' && buf[1] == '!' && buf[2] == '-') {
            incomment = 1;
            buf += 3;
            len -= 3;
            continue;
        }

        if (buf[0] == first) {
            if (next == 0) {
                return (buf - in->cur);
            }
            if (len < 2 || buf[1] != next) {
                buf++;
                len--;
                continue;
            }
            if (third == 0) {
                return (buf - in->cur);
            }
            if (len < 3 || buf[2] != third) {
                buf++;
                len--;
                continue;
            }
            return (buf - in->cur);
        }
        buf++;
        len--;
    }