buf = in->cur;
    len = in->end - buf;

    if (len <= 0)
        return (-1);

    if (next == 0) {
        for (; len > 0; len--, buf++) {
            if ((*buf == '<') && (!iscomment) && (!invalue)) {
                if ((buf[1] == '!') && (buf[2] == '-') && (buf[3] == '-')) {
                    incomment = 1;
                }
            }
            if ((*buf == '"') && (ignoreAttrValue)) {
                if (invalue == 0) {
                    invalue = 1;
                    valdellim = '"';
                } else if (valdellim == '"') {
                    invalue = 0;
                }
            } else if ((*buf == '\'') && (ignoreAttrValue)) {
                if (invalue == 0) {
                    invalue = 1;
                    valdellim = '\'';
                } else if (valdellim == '\'') {
                    invalue = 0;
                }
            }
            if (incomment) {
                if ((*buf == '-') && (buf[1] == '-') && (buf[2] == '>')) {
                    incomment = 0;
                    buf += 2;
                    len -= 2;
                }
                continue;
            }
            if (invalue)
                continue;
            if (*buf == first) {
                ctxt->checkIndex = in->cur - in->base + (buf - in->cur);
                return (buf - in->cur);
            }
        }
        ctxt->checkIndex = in->cur - in->base + (buf - in->cur);
        return (-1);
    }

    if (len <= 1)
        return (-1);

    if (third == 0) {
        for (; len > 1; len--, buf++) {
            if ((*buf == '<') && (!iscomment) && (!invalue)) {
                if ((buf[1] == '!') && (buf[2] == '-') && (buf[3] == '-')) {
                    incomment = 1;
                }
            }
            if ((*buf == '"') && (ignoreAttrValue)) {
                if (invalue == 0) {
                    invalue = 1;
                    valdellim = '"';
                } else if (valdellim == '"') {
                    invalue = 0;
                }
            } else if ((*buf == '\'') && (ignoreAttrValue)) {
                if (invalue == 0) {
                    invalue = 1;
                    valdellim = '\'';
                } else if (valdellim == '\'') {
                    invalue = 0;
                }
            }
            if (incomment) {
                if ((*buf == '-') && (buf[1] == '-') && (buf[2] == '>')) {
                    incomment = 0;
                    buf += 2;
                    len -= 2;
                }
                continue;
            }
            if (invalue)
                continue;
            if ((*buf == first) && (buf[1] == next)) {
                ctxt->checkIndex = in->cur - in->base + (buf - in->cur);
                return (buf - in->cur);
            }
        }
        ctxt->checkIndex = in->cur - in->base + (buf - in->cur);
        return (-1);
    }

    if (len <= 2)
        return (-1);

    for (; len > 2; len--, buf++) {
        if ((*buf == '<') && (!iscomment) && (!invalue)) {
            if ((buf[1] == '!') && (buf[2] == '-') && (buf[3] == '-')) {
                incomment = 1;
            }
        }
        if ((*buf == '"') && (ignoreAttrValue)) {
            if (invalue == 0) {
                invalue = 1;
                valdellim = '"';
            } else if (valdellim == '"') {
                invalue = 0;
            }
        } else if ((*buf == '\'') && (ignoreAttrValue)) {
            if (invalue == 0) {
                invalue = 1;
                valdellim = '\'';
            } else if (valdellim == '\'') {
                invalue = 0;
            }
        }
        if (incomment) {
            if ((*buf == '-') && (buf[1] == '-') && (buf[2] == '>')) {
                incomment = 0;
                buf += 2;
                len -= 2;
            }
            continue;
        }
        if (invalue)
            continue;
        if ((*buf == first) && (buf[1] == next) && (buf[2] == third)) {
            ctxt->checkIndex = in->cur - in->base + (buf - in->cur);
            return (buf - in->cur);
        }
    }
    ctxt->checkIndex = in->cur - in->base + (buf - in->cur);