if (ctxt->checkIndex > base)
        base = ctxt->checkIndex;

    if (in->buf == NULL) {
        buf = in->base;
        len = in->length;
    } else {
        buf = xmlBufContent(in->buf->buffer);
        len = xmlBufUse(in->buf->buffer);
    }

    /* take into account the sequence length */
    if (third)
        len -= 2;
    else if (next)
        len--;

    for (; base < len; base++) {
        /* Handle comments if needed */
        if (!incomment && iscomment && (base + 4 <= len)) {
            if ((buf[base] == '<') && (buf[base + 1] == '!') &&
                (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
                incomment = 1;
                /* do not increment past <! - some people use <!--> */
                base += 2;
                continue;
            }
        }
        if (incomment) {
            if (base + 3 <= len) {
                if ((buf[base] == '-') && (buf[base + 1] == '-') &&
                    (buf[base + 2] == '>')) {
                    incomment = 0;
                    base += 2;
                }
            }
            continue;
        }

        /* Handle attribute values if needed */
        if (ignoreAttrValue && !invalue) {
            if (buf[base] == '\'' || buf[base] == '"') {
                invalue = 1;
                valdellim = buf[base];
                continue;
            }
        }
        if (invalue) {
            if (buf[base] == valdellim) {
                invalue = 0;
                valdellim = 0;
            }
            continue;
        }
        
        /* Check if we have a match for the sequence */
        if (buf[base] == first) {
            if (third != 0) {
                if ((base + 2 < len) && 
                    (buf[base + 1] == next) &&
                    (buf[base + 2] == third)) {
                    ctxt->checkIndex = 0;
#ifdef DEBUG_PUSH
                    xmlGenericError(xmlGenericErrorContext,
                                  "HPP: lookup '%c%c%c' found at %d\n",
                                  first, next, third, base);
#endif
                    return (base - (in->cur - in->base));
                }
            } else if (next != 0) {
                if ((base + 1 < len) && 
                    (buf[base + 1] == next)) {
                    ctxt->checkIndex = 0;
#ifdef DEBUG_PUSH
                    xmlGenericError(xmlGenericErrorContext,
                                  "HPP: lookup '%c%c' found at %d\n",
                                  first, next, base);
#endif
                    return (base - (in->cur - in->base));
                }
            } else {
                ctxt->checkIndex = 0;
#ifdef DEBUG_PUSH
                xmlGenericError(xmlGenericErrorContext,
                              "HPP: lookup '%c' found at %d\n",
                              first, base);
#endif
                return (base - (in->cur - in->base));
            }
        }
    }
    
    ctxt->checkIndex = base;