buf = in->base;
    len = in->length;
    if (len > 3) {
        len -= 3;
    } else {
        len = 0;
    }

    for (;base < len;) {
        if (incomment) {
            if ((buf[base] == '-') && (buf[base + 1] == '-') &&
                (buf[base + 2] == '>')) {
                incomment = 0;
                base += 3;
            } else {
                base++;
            }
            continue;
        }
        if (ignoreAttrValue && !invalue) {
            if (buf[base] == '"' || buf[base] == '\'') {
                invalue = 1;
                valdellim = buf[base];
                base++;
                continue;
            }
        }
        if (invalue) {
            if (buf[base] == valdellim) {
                invalue = 0;
                base++;
                continue;
            }
        }
        if ((buf[base] == '<') && (buf[base + 1] == '!') &&
            (buf[base + 2] == '-') && (buf[base + 3] == '-')) {
            incomment = 1;
            base += 4;
            continue;
        }
        if (buf[base] == first) {
            if (next == 0)
                return(base - (in->cur - in->base));
            if (buf[base + 1] == next) {
                if (third == 0)
                    return(base - (in->cur - in->base));
                if (buf[base + 2] == third)
                    return(base - (in->cur - in->base));
            }
        }
        base++;
    }
    ctxt->checkIndex = base;