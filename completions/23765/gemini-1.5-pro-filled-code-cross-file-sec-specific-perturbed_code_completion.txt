buf = in->cur;
    len = in->length - base;
    if (len <= 0)
        return (-1);
    if (third)
        len -= 2;
    else if (next)
        len -= 1;

    for (; len > 0; len--, buf++) {
        if (!incomment && !invalue) {
            if (ignoreAttrValue) {
                if (*buf == '<') {
                    const xmlChar *end;

                    end = htmlSkipTag(buf, in->end);
                    if (end != NULL) {
                        len -= end - buf - 1;
                        buf = end - 1;
                        continue;
                    }
                }
            }
            if (ctxt->checkIndex > 0)
                ctxt->checkIndex--;
            if (*buf == '<' && (buf + 4 <= in->end) &&
                (buf[1] == '!') && (buf[2] == '-') && buf[3] == '-') {
                incomment = 1;
            }
            if (*buf == '<' && ignoreAttrValue) {
                const xmlChar *end;

                end = htmlSkipTag(buf, in->end);
                if (end != NULL) {
                    len -= end - buf - 1;
                    buf = end - 1;
                    continue;
                }
            }
            if (*buf == '<' && !ignoreAttrValue && !incomment) {
                int level = 0;
                const xmlChar *attr;

                attr = htmlScanAttribute(buf, in->end);
                if (attr != NULL) {
                    len -= attr - buf - 1;
                    buf = attr - 1;
                    continue;
                } else {
                    const xmlChar *end;

                    end = htmlSkipTag(buf, in->end);
                    if (end != NULL) {
                        len -= end - buf - 1;
                        buf = end - 1;
                        continue;
                    }
                }
            }
        } else if (incomment) {
            if ((buf + 2 <= in->end) && (*buf == '-') && (buf[1] == '-') &&
                (buf[2] == '>')) {
                buf += 2;
                len -= 2;
                incomment = 0;
            }
        }
        if (*buf == first) {
            if (!next)
                return (buf - in->base);
            if ((len > 1) && (buf[1] == next)) {
                if (!third)
                    return (buf - in->base);
                if ((len > 2) && (buf[2] == third))
                    return (buf - in->base);
            }
        }
    }
    ctxt->checkIndex = 0;