buf = in->cur;
    len = in->end - buf;

    while (len > 0) {
        if (incomment) {
            if (buf[0] == '-' && buf[1] == '-' && (len > 2) && buf[2] == '>') {
                incomment = 0;
                buf += 3;
                len -= 3;
                continue;
            }
            buf++;
            len--;
            continue;
        }

        if (ignoreAttrValue && invalue) {
            if (buf[0] == '"' || buf[0] == '\'') {
                invalue = 1;
                buf++;
                len--;
                continue;
            }
        }

        if (buf[0] == '<') {
            if (buf[1] == '!') {
                if (buf[2] == '-' && buf[3] == '-') {
                    incomment = 1;
                }
            }
        }

        if (buf[0] == first) {
            if (next == 0) {
                return (buf - in->base);
            }
            if (len > 1 && buf[1] == next) {
                if (third == 0) {
                    return (buf - in->base);
                }
                if (len > 2 && buf[2] == third) {
                    return (buf - in->base);
                }
            }
        }

        buf++;
        len--;
    }

    ctxt->checkIndex = buf - in->base;