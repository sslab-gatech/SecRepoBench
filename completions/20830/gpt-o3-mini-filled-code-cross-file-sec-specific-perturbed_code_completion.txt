#define TMP_BUF_SIZE 512
{
  char tmp_buf[TMP_BUF_SIZE];
  u_int16_t copy_len = (flow_packet->payload_packet_len < (TMP_BUF_SIZE - 1)) ? flow_packet->payload_packet_len : (TMP_BUF_SIZE - 1);
  memcpy(tmp_buf, flow_packet->payload, copy_len);
  tmp_buf[copy_len] = '\0';

  // Point to the command starting position within the temporary buffer.
  char *cmd = tmp_buf + command_start;

  // Find the first double quote: start of the username.
  char *user_start = strchr(cmd, '\"');
  if (!user_start) {
    goto imap_excluded;
  }
  user_start++; // skip the double quote

  // Find the ending double quote for the username.
  char *user_end = strchr(user_start, '\"');
  if (!user_end) {
    goto imap_excluded;
  }
  size_t username_len = user_end - user_start;
  if (username_len >= sizeof(flow->protos.ftp_imap_pop_smtp.username))
    username_len = sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1;
  memcpy(flow->protos.ftp_imap_pop_smtp.username, user_start, username_len);
  flow->protos.ftp_imap_pop_smtp.username[username_len] = '\0';

  // Find the first double quote after the username for the start of the password.
  char *pass_start = strchr(user_end + 1, '\"');
  if (!pass_start) {
    goto imap_excluded;
  }
  pass_start++; // skip the double quote

  // Find the ending double quote for the password.
  char *pass_end = strchr(pass_start, '\"');
  if (!pass_end) {
    goto imap_excluded;
  }
  size_t password_len = pass_end - pass_start;
  if (password_len >= sizeof(flow->protos.ftp_imap_pop_smtp.password))
    password_len = sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1;
  memcpy(flow->protos.ftp_imap_pop_smtp.password, pass_start, password_len);
  flow->protos.ftp_imap_pop_smtp.password[password_len] = '\0';
}