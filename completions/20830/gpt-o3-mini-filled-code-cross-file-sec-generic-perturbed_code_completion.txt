{
  /* Use a local buffer to safely copy the payload */
  u_int16_t len = flow_packet->payload_packet_len;
  /* Ensure the copy buffer does not exceed a reasonable maximum size */
  if(len > 1023) len = 1023;
  char copybuf[len + 1];
  memcpy(copybuf, flow_packet->payload, len);
  copybuf[len] = '\0';

  /* Locate the first pair of double quotes for the username */
  char *first_quote = strchr(copybuf, '\"');
  if(first_quote) {
    char *second_quote = strchr(first_quote + 1, '\"');
    if(second_quote && second_quote - first_quote > 1) {
      size_t username_len = second_quote - first_quote - 1;
      size_t max_username = sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1;
      if(username_len > max_username)
        username_len = max_username;
      memcpy(flow->protos.ftp_imap_pop_smtp.username, first_quote + 1, username_len);
      flow->protos.ftp_imap_pop_smtp.username[username_len] = '\0';

      /* Locate the next pair of double quotes for the password */
      char *third_quote = strchr(second_quote + 1, '\"');
      if(third_quote) {
        char *fourth_quote = strchr(third_quote + 1, '\"');
        if(fourth_quote && fourth_quote - third_quote > 1) {
          size_t password_len = fourth_quote - third_quote - 1;
          size_t max_password = sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1;
          if(password_len > max_password)
            password_len = max_password;
          memcpy(flow->protos.ftp_imap_pop_smtp.password, third_quote + 1, password_len);
          flow->protos.ftp_imap_pop_smtp.password[password_len] = '\0';
        }
      }
    }
  }
}