// <MASK>
if(flow->l4.tcp.mail_imap_stage < 4) {
  // search for the first double quote character, marking the start of the username
  while (i < flow_packet->payload_packet_len) {
    if(flow_packet->payload[i] == '"') {
      username_start = i;
      break;
    }
    i++;
  }

  if(username_start == 0 || username_start == (flow_packet->payload_packet_len - 1)) {
    goto imap_excluded;
  }

  // find the next double quote to identify the end of the username
  i = username_start + 1;
  while (i < flow_packet->payload_packet_len) {
    if(flow_packet->payload[i] == '"') {
      username_end = i;
      break;
    }
    i++;
  }

  if(username_end == 0 || username_end == (flow_packet->payload_packet_len - 1)) {
    goto imap_excluded;
  }

  // locate the next pair of double quotes to extract the password
  i = username_end + 1;
  while (i < flow_packet->payload_packet_len) {
    if(flow_packet->payload[i] == '"') {
      password_start = i + 1;
      break;
    }
    i++;
  }

  if(password_start == 0 || password_start == (flow_packet->payload_packet_len - 1)) {
    goto imap_excluded;
  }

  i = password_start;
  while (i < flow_packet->payload_packet_len) {
    if(flow_packet->payload[i] == '"') {
      password_end = i;
      break;
    }
    i++;
  }

  if(password_end == 0 || password_end == (flow_packet->payload_packet_len - 1)) {
    goto imap_excluded;
  }

  // extract the username and password from the packet payload
  strncpy(flow->protos.ftp_imap_pop_smtp.username, &(flow_packet->payload[username_start + 1]), username_end - username_start - 1);
  flow->protos.ftp_imap_pop_smtp.username[username_end - username_start - 1] = '\0';

  strncpy(flow->protos.ftp_imap_pop_smtp.password, &(flow_packet->payload[password_start]), password_end - password_start);
  flow->protos.ftp_imap_pop_smtp.password[password_end - password_start] = '\0';
}
// </MASK>