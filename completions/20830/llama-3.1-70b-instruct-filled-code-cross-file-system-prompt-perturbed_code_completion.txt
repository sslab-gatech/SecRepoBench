// Extract and store the "username" and "password" from the IMAP LOGIN command.
// Copy the packet payload into a temporary string buffer.
// Ensure the copied string is null-terminated.
// Locate the first double quote character, marking the start of the username.
// Find the next double quote to identify the end of the username and store it.
// Locate the next pair of double quotes to extract the password and store it.
// The extracted username and password are stored within the flow structure.

u_int16_t login_pos = command_start + 5;
u_int16_t quote_pos = 0;
u_int16_t username_end = 0;
u_int16_t password_end = 0;
u_int16_t i = 0;

// Copy the packet payload into a temporary string buffer
char temp_buffer[flow_packet->payload_packet_len + 1];
memcpy(temp_buffer, flow_packet->payload, flow_packet->payload_packet_len);
temp_buffer[flow_packet->payload_packet_len] = '\0';

// Locate the first double quote character, marking the start of the username
quote_pos = login_pos;
while (quote_pos < flow_packet->payload_packet_len && flow_packet->payload[quote_pos]!= '"') {
  quote_pos++;
}

if (quote_pos < flow_packet->payload_packet_len) {
  // Find the next double quote to identify the end of the username and store it
  username_end = quote_pos + 1;
  while (username_end < flow_packet->payload_packet_len && flow_packet->payload[username_end]!= '"') {
    username_end++;
  }

  if (username_end < flow_packet->payload_packet_len) {
    // Extract the username
    memset(flow->protos.ftp_imap_pop_smtp.username, 0, sizeof(flow->protos.ftp_imap_pop_smtp.username));
    memcpy(flow->protos.ftp_imap_pop_smtp.username, &temp_buffer[quote_pos + 1], username_end - quote_pos - 1);

    // Locate the next pair of double quotes to extract the password and store it
    quote_pos = username_end + 1;
    while (quote_pos < flow_packet->payload_packet_len && flow_packet->payload[quote_pos]!= '"') {
      quote_pos++;
    }

    if (quote_pos < flow_packet->payload_packet_len) {
      password_end = quote_pos + 1;
      while (password_end < flow_packet->payload_packet_len && flow_packet->payload[password_end]!= '"') {
        password_end++;
      }

      if (password_end < flow_packet->payload_packet_len) {
        // Extract the password
        memset(flow->protos.ftp_imap_pop_smtp.password, 0, sizeof(flow->protos.ftp_imap_pop_smtp.password));
        memcpy(flow->protos.ftp_imap_pop_smtp.password, &temp_buffer[quote_pos + 1], password_end - quote_pos - 1);
      }
    }
  }
}