char temp_buffer[flow_packet->payload_packet_len + 1];
char *username_start, *username_end, *password_start, *password_end;
size_t username_len, password_len;

if (flow_packet->payload_packet_len > sizeof(temp_buffer) - 1) {
  // Payload is too large, skip extraction
  flow->l4.tcp.mail_imap_stage += 1;
  saw_command = 1;
} else {
  memcpy(temp_buffer, flow_packet->payload, flow_packet->payload_packet_len);
  temp_buffer[flow_packet->payload_packet_len] = '\0';

  username_start = strchr(temp_buffer + command_start, '"');
  if (username_start) {
    username_start++;
    username_end = strchr(username_start, '"');
    if (username_end) {
      username_len = username_end - username_start;
      if (username_len < sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1) {
        memcpy(flow->protos.ftp_imap_pop_smtp.username, username_start, username_len);
        flow->protos.ftp_imap_pop_smtp.username[username_len] = '\0';

        password_start = strchr(username_end + 1, '"');
        if (password_start) {
          password_start++;
          password_end = strchr(password_start, '"');
          if (password_end) {
            password_len = password_end - password_start;
            if (password_len < sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1) {
              memcpy(flow->protos.ftp_imap_pop_smtp.password, password_start, password_len);
              flow->protos.ftp_imap_pop_smtp.password[password_len] = '\0';
            }
          }
        }
      }
    }
  }

  flow->l4.tcp.mail_imap_stage += 1;
  saw_command = 1;
}