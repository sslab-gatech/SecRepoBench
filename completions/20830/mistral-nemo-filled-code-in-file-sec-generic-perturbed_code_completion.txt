// Extract and store the "username" and "password" from the IMAP LOGIN command.
// Copy the packet payload into a temporary string buffer.
char *username = strndup(&flow_packet->payload[space_pos + 1], command_start - space_pos - 1);
char *password = strndup(&flow_packet->payload[command_start + 1], space_pos - command_start - 1);

// Ensure the copied strings are null-terminated.
username[command_start - space_pos - 1] = '\0';
password[space_pos - command_start - 1] = '\0';

// Locate the first double quote character, marking the start of the username.
char *quote_pos = strchr(username, '"');
if (quote_pos) {
  // Find the next double quote to identify the end of the username and store it.
  char *end_quote_pos = strchr(quote_pos + 1, '"');
  if (end_quote_pos) {
    *end_quote_pos = '\0';
    quote_pos++;
  } else {
    NDPI_LOG_WARN(ndpi_struct, "Invalid IMAP LOGIN command format: missing closing quote for username\n");
    goto imap_excluded;
  }
}

// Locate the next pair of double quotes to extract the password and store it.
quote_pos = strchr(password, '"');
if (quote_pos) {
  char *end_quote_pos = strchr(quote_pos + 1, '"');
  if (end_quote_pos) {
    *end_quote_pos = '\0';
    quote_pos++;
  } else {
    NDPI_LOG_WARN(ndpi_struct, "Invalid IMAP LOGIN command format: missing closing quote for password\n");
    goto imap_excluded;
  }
}

// Store the extracted username and password within the flow structure.
strncpy(flow->protos.ftp_imap_pop_smtp.username, username, sizeof(flow->protos.ftp_imap_pop_smtp.username));
strncpy(flow->protos.ftp_imap_pop_smtp.password, password, sizeof(flow->protos.ftp_imap_pop_smtp.password));

// Free the temporary string buffers.
free(username);
free(password);