{
  /* Safely copy payload into a local buffer (ensure null termination). */
  char tmpbuf[512];
  size_t cplen = (flow_packet->payload_packet_len < (sizeof(tmpbuf) - 1))
                   ? flow_packet->payload_packet_len
                   : (sizeof(tmpbuf) - 1);
  memcpy(tmpbuf, flow_packet->payload, cplen);
  tmpbuf[cplen] = '\0';

  /* Search for quoted username and password in the LOGIN command. */
  if(command_start < cplen) {
    char *start = &tmpbuf[command_start];
    char *quote1 = strchr(start, '"');
    if(quote1) {
      char *quote2 = strchr(quote1 + 1, '"');
      if(quote2 && (quote2 > quote1 + 1)) {
        /* Extract username. */
        size_t user_len = (size_t)(quote2 - (quote1 + 1));
        if(user_len >= sizeof(flow->protos.ftp_imap_pop_smtp.username)) {
          user_len = sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1;
        }
        memcpy(flow->protos.ftp_imap_pop_smtp.username, quote1 + 1, user_len);
        flow->protos.ftp_imap_pop_smtp.username[user_len] = '\0';

        /* Find next quoted sequence for password. */
        char *quote3 = strchr(quote2 + 1, '"');
        if(quote3) {
          char *quote4 = strchr(quote3 + 1, '"');
          if(quote4 && (quote4 > quote3 + 1)) {
            /* Extract password. */
            size_t pass_len = (size_t)(quote4 - (quote3 + 1));
            if(pass_len >= sizeof(flow->protos.ftp_imap_pop_smtp.password)) {
              pass_len = sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1;
            }
            memcpy(flow->protos.ftp_imap_pop_smtp.password, quote3 + 1, pass_len);
            flow->protos.ftp_imap_pop_smtp.password[pass_len] = '\0';
          }
        }
      }
    }
  }
}