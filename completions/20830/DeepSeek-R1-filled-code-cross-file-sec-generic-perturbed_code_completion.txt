// Extract and store the "username" and "password" from the IMAP LOGIN command.
u_int16_t pos = command_start + 5; // "LOGIN" is 5 characters
u_int16_t max_pos = flow_packet->payload_packet_len;

// Skip whitespace after "LOGIN"
while (pos < max_pos && (flow_packet->payload[pos] == ' ' || flow_packet->payload[pos] == '\t')) {
    pos++;
}

if (pos < max_pos && flow_packet->payload[pos] == '"') {
    u_int16_t username_start = pos + 1;
    u_int16_t username_end = username_start;

    // Find closing quote for username
    while (username_end < max_pos && flow_packet->payload[username_end] != '"') {
        username_end++;
    }

    if (username_end < max_pos) {
        u_int16_t password_start = username_end + 1;

        // Skip whitespace between username and password
        while (password_start < max_pos && (flow_packet->payload[password_start] == ' ' || flow_packet->payload[password_start] == '\t')) {
            password_start++;
        }

        if (password_start < max_pos && flow_packet->payload[password_start] == '"') {
            password_start++;
            u_int16_t password_end = password_start;

            // Find closing quote for password
            while (password_end < max_pos && flow_packet->payload[password_end] != '"') {
                password_end++;
            }

            if (password_end < max_pos) {
                // Extract username
                u_int16_t user_len = username_end - username_start;
                if (user_len > 0) {
                    u_int16_t copy_len = user_len < sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1 ? user_len : sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1;
                    memcpy(flow->protos.ftp_imap_pop_smtp.username, &flow_packet->payload[username_start], copy_len);
                    flow->protos.ftp_imap_pop_smtp.username[copy_len] = '\0';
                }

                // Extract password
                u_int16_t pass_len = password_end - password_start;
                if (pass_len > 0) {
                    u_int16_t copy_len = pass_len < sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1 ? pass_len : sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1;
                    memcpy(flow->protos.ftp_imap_pop_smtp.password, &flow_packet->payload[password_start], copy_len);
                    flow->protos.ftp_imap_pop_smtp.password[copy_len] = '\0';
                }
            }
        }
    }
}