// Extract and store the "username" and "password" from the IMAP LOGIN command.
// Copy the packet payload into a temporary string buffer.
char temp_buffer[flow_packet->payload_packet_len + 1];
memcpy(temp_buffer, flow_packet->payload, flow_packet->payload_packet_len);
temp_buffer[flow_packet->payload_packet_len] = '\0';

// Ensure the copied string is null-terminated.
if (temp_buffer[flow_packet->payload_packet_len - 1]!= '\0') {
    NDPI_LOG_DBG2(ndpi_struct, "IMAP LOGIN command payload is not null-terminated\n");
    goto imap_excluded;
}

// Locate the first double quote character, marking the start of the username.
u_int16_t username_start = 0;
while (username_start < flow_packet->payload_packet_len && temp_buffer[username_start]!= '"') {
    username_start++;
}

if (username_start == flow_packet->payload_packet_len) {
    NDPI_LOG_DBG2(ndpi_struct, "IMAP LOGIN command payload does not contain a double quote character\n");
    goto imap_excluded;
}

// Find the next double quote to identify the end of the username and store it.
u_int16_t username_end = username_start + 1;
while (username_end < flow_packet->payload_packet_len && temp_buffer[username_end]!= '"') {
    username_end++;
}

if (username_end == flow_packet->payload_packet_len) {
    NDPI_LOG_DBG2(ndpi_struct, "IMAP LOGIN command payload does not contain a closing double quote character for the username\n");
    goto imap_excluded;
}

// Extract the username.
u_int16_t username_len = username_end - username_start - 1;
if (username_len > NDPI_MAX_USERNAME_LEN - 1) {
    username_len = NDPI_MAX_USERNAME_LEN - 1;
}
memcpy(flow->protos.ftp_imap_pop_smtp.username, &temp_buffer[username_start + 1], username_len);
flow->protos.ftp_imap_pop_smtp.username[username_len] = '\0';

// Locate the next pair of double quotes to extract the password and store it.
u_int16_t password_start = username_end + 1;
while (password_start < flow_packet->payload_packet_len && temp_buffer[password_start]!= '"') {
    password_start++;
}

if (password_start == flow_packet->payload_packet_len) {
    NDPI_LOG_DBG2(ndpi_struct, "IMAP LOGIN command payload does not contain a double quote character for the password\n");
    goto imap_excluded;
}

u_int16_t password_end = password_start + 1;
while (password_end < flow_packet->payload_packet_len && temp_buffer[password_end]!= '"') {
    password_end++;
}

if (password_end == flow_packet->payload_packet_len) {
    NDPI_LOG_DBG2(ndpi_struct, "IMAP LOGIN command payload does not contain a closing double quote character for the password\n");
    goto imap_excluded;
}

// Extract the password.
u_int16_t password_len = password_end - password_start - 1;
if (password_len > NDPI_MAX_PASSWORD_LEN - 1) {
    password_len = NDPI_MAX_PASSWORD_LEN - 1;
}
memcpy(flow->protos.ftp_imap_pop_smtp.password, &temp_buffer[password_start + 1], password_len);
flow->protos.ftp_imap_pop_smtp.password[password_len] = '\0';