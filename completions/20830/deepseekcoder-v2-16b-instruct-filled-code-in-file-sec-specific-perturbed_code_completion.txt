// Extract and store the "username" and "password" from the IMAP LOGIN command.
// Copy the packet payload into a temporary string buffer.
char temp_payload[flow_packet->payload_packet_len + 1];
memcpy(temp_payload, flow_packet->payload, flow_packet->payload_packet_len);
temp_payload[flow_packet->payload_packet_len] = '\0';

// Ensure the copied string is null-terminated.
char *username = NULL, *password = NULL;
char *username_start = NULL, *username_end = NULL;
char *password_start = NULL, *password_end = NULL;
char *quote = "\"";

// Locate the first double quote character, marking the start of the username.
username_start = strstr(temp_payload, quote);
if (username_start != NULL) {
    // Find the next double quote to identify the end of the username and store it.
    username_end = strchr(username_start + 1, '"');
    if (username_end != NULL) {
        // Calculate the length of the username.
        size_t username_len = username_end - username_start - 1;
        // Allocate memory for the username and copy it.
        username = (char *)malloc(username_len + 1);
        if (username != NULL) {
            memcpy(username, username_start + 1, username_len);
            username[username_len] = '\0';
        }
    }
}

// Locate the next pair of double quotes to extract the password and store it.
password_start = strstr(username_end, quote);
if (password_start != NULL) {
    // Find the next double quote to identify the end of the password and store it.
    password_end = strchr(password_start + 1, '"');
    if (password_end != NULL) {
        // Calculate the length of the password.
        size_t password_len = password_end - password_start - 1;
        // Allocate memory for the password and copy it.
        password = (char *)malloc(password_len + 1);
        if (password != NULL) {
            memcpy(password, password_start + 1, password_len);
            password[password_len] = '\0';
        }
    }
}

// The extracted username and password are stored within the flow structure.
if (username != NULL && password != NULL) {
    strncpy(flow->protos.ftp_imap_pop_smtp.username, username, NDPI_PROTOCOLS_MAX_STRING_LENGTH - 1);
    strncpy(flow->protos.ftp_imap_pop_smtp.password, password, NDPI_PROTOCOLS_MAX_STRING_LENGTH - 1);
}

// Free allocated memory for username and password.
if (username != NULL) {
    free(username);
}
if (password != NULL) {
    free(password);
}