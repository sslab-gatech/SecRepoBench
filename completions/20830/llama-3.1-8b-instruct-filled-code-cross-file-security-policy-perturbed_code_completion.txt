// Extract and store the "username" and "password" from the IMAP LOGIN command.
// Copy the packet payload into a temporary string buffer.
// Ensure the copied string is null-terminated.
// Locate the first double quote character, marking the start of the username.
// Find the next double quote to identify the end of the username and store it.
// Locate the next pair of double quotes to extract the password and store it.
// The extracted username and password are stored within the flow structure.
// <MASK>
char temp_buffer[flow_packet->payload_packet_len + 1];
memcpy(temp_buffer, flow_packet->payload, flow_packet->payload_packet_len);
temp_buffer[flow_packet->payload_packet_len] = '\0';

u_int8_t username_start = 0;
u_int8_t username_end = 0;
u_int8_t password_start = 0;
u_int8_t password_end = 0;

for (u_int8_t i = 0; i < flow_packet->payload_packet_len; i++) {
  if (temp_buffer[i] == '"') {
    if (username_start == 0) {
      username_start = i + 1;
    } else if (username_end == 0) {
      username_end = i;
      break;
    }
  }
}

if (username_start!= 0 && username_end!= 0) {
  for (u_int8_t i = username_end + 1; i < flow_packet->payload_packet_len; i++) {
    if (temp_buffer[i] == '"') {
      password_start = i + 1;
      break;
    }
  }

  if (password_start!= 0) {
    for (u_int8_t i = password_start; i < flow_packet->payload_packet_len; i++) {
      if (temp_buffer[i] == '"') {
        password_end = i;
        break;
      }
    }

    if (password_end!= 0) {
      flow->l4.tcp.mail_imap_username[0] = '\0';
      flow->l4.tcp.mail_imap_password[0] = '\0';
      strncpy(flow->l4.tcp.mail_imap_username, &(temp_buffer[username_start]), username_end - username_start);
      strncpy(flow->l4.tcp.mail_imap_password, &(temp_buffer[password_start]), password_end - password_start);
    }
  }
}

flow->l4.tcp.mail_imap_stage += 1;
saw_command = 1;