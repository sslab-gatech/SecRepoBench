char temp_buffer[256];
u_int16_t username_start, username_end, password_start, password_end;

if(flow_packet->payload_packet_len < sizeof(temp_buffer)) {
  strncpy(temp_buffer, (char*)flow_packet->payload, flow_packet->payload_packet_len);
  temp_buffer[flow_packet->payload_packet_len] = '\0';

  username_start = command_start + 6; // Skip "LOGIN "
  username_end = username_start;
  while(username_end < flow_packet->payload_packet_len && temp_buffer[username_end] != '"') username_end++;

  if(username_end < flow_packet->payload_packet_len) {
    password_start = username_end + 2; // Skip closing quote and space
    password_end = password_start;
    while(password_end < flow_packet->payload_packet_len && temp_buffer[password_end] != '"') password_end++;

    if(password_end < flow_packet->payload_packet_len) {
      u_int16_t username_len = ndpi_min(username_end - username_start, sizeof(flow->protos.ftp_imap_pop_smtp.username) - 1);
      u_int16_t password_len = ndpi_min(password_end - password_start, sizeof(flow->protos.ftp_imap_pop_smtp.password) - 1);

      strncpy(flow->protos.ftp_imap_pop_smtp.username, &temp_buffer[username_start], username_len);
      flow->protos.ftp_imap_pop_smtp.username[username_len] = '\0';

      strncpy(flow->protos.ftp_imap_pop_smtp.password, &temp_buffer[password_start], password_len);
      flow->protos.ftp_imap_pop_smtp.password[password_len] = '\0';
    }
  }
}