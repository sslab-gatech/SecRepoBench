// Extract and store the "username" and "password" from the IMAP LOGIN command.
// Copy the packet payload into a temporary string buffer.
char temp_payload[flow_packet->payload_packet_len + 1];
memcpy(temp_payload, flow_packet->payload, flow_packet->payload_packet_len);
temp_payload[flow_packet->payload_packet_len] = '\0'; // Ensure null termination

// Locate the first double quote character, marking the start of the username.
const u_int8_t *username_start = strchr(temp_payload, '"');
if (!username_start) {
    goto imap_excluded;
}
username_start++; // Move past the first double quote

// Find the next double quote to identify the end of the username and store it.
const u_int8_t *username_end = strchr(username_start, '"');
if (!username_end) {
    goto imap_excluded;
}

// Ensure the username is not empty
if (username_start >= username_end) {
    goto imap_excluded;
}

// Store the username
u_int16_t username_len = username_end - username_start;
memcpy(flow->protos.ftp_imap_pop_smtp.username, username_start, username_len);
flow->protos.ftp_imap_pop_smtp.username[username_len] = '\0'; // Null-terminate the username

// Locate the next pair of double quotes to extract the password and store it.
const u_int8_t *password_start = strchr(username_end, '"');
if (!password_start || password_start[1] != '"') {
    goto imap_excluded;
}
password_start += 2; // Move past the second double quote

// Find the next double quote to identify the end of the password and store it.
const u_int8_t *password_end = strchr(password_start, '"');
if (!password_end) {
    goto imap_excluded;
}

// Ensure the password is not empty
if (password_start >= password_end) {
    goto imap_excluded;
}

// Store the password
u_int16_t password_len = password_end - password_start;
memcpy(flow->protos.ftp_imap_pop_smtp.password, password_start, password_len);
flow->protos.ftp_imap_pop_smtp.password[password_len] = '\0'; // Null-terminate the password

// Log the extracted username and password
NDPI_LOG_INFO(ndpi_struct, "Extracted username: %s, password: %s\n", flow->protos.ftp_imap_pop_smtp.username, flow->protos.ftp_imap_pop_smtp.password);