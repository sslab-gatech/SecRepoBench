if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->sub_charenc && codeccontext->sub_charenc[0]) {
        /* For known text-based subtitle codecs, validate and set encoding mode.
         * For bitmap-based subtitles, ignore the character encoding with a warning.
         */
        if (codec->id == AV_CODEC_ID_SUBRIP ||
            codec->id == AV_CODEC_ID_SSA   ||
            codec->id == AV_CODEC_ID_ASS) {
            /* If the encoding mode is automatic, switch it to pre-decoder mode
             * and validate the encoding using iconv if available.
             */
            if (codeccontext->sub_charenc_mode == SUB_CHARENC_MODE_AUTOMATIC) {
#ifdef HAVE_ICONV
                {
                    iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (cd == (iconv_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding: %s\n",
                               codeccontext->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    iconv_close(cd);
                }
#endif
                codeccontext->sub_charenc_mode = SUB_CHARENC_MODE_PREDECODER;
            }
        } else {
            av_log(codeccontext, AV_LOG_WARNING,
                   "Subtitle character encoding is ignored for bitmap-based subtitle codecs\n");
        }
    }
} else if (codeccontext->sub_charenc && codeccontext->sub_charenc[0]) {
    av_log(codeccontext, AV_LOG_WARNING,
           "Subtitle character encoding is specified but the codec is not a subtitle codec; ignoring it\n");
}