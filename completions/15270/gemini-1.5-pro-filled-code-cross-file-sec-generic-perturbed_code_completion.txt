if (codeccontext->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
            if (codeccontext->sub_charenc_mode != FF_SUB_CHARENC_MODE_DO_NOTHING) {
                av_log(codeccontext, AV_LOG_WARNING,
                       "Codec '%s' is bitmap-based, ignoring character encoding setting.\n",
                       codeccontext->codec_descriptor->name);
                codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_DO_NOTHING;
            }
        } else if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC) {
            codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
        }

        if (codeccontext->sub_charenc && codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR, "Unable to open iconv context with input character encoding \"%s\"\n",
                       codeccontext->sub_charenc);

                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
#else
            av_log(codeccontext, AV_LOG_WARNING, "Character encoding set, but libiconv is unavailable. Ensure that the subtitles are UTF-8 encoded or recompile FFmpeg with libiconv support.\n");
#endif
        }