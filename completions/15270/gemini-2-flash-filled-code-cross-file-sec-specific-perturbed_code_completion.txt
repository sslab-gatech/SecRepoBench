if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
            if (codeccontext->subtitle_header) {
                av_freep(&codeccontext->subtitle_header);
                codeccontext->subtitle_header_size = 0;
            }
            if (codeccontext->codec_id == AV_CODEC_ID_DVD_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_XSUB) {
                if (codeccontext->sub_text_format) {
                    av_log(codeccontext, AV_LOG_WARNING, "Character encoding not supported for bitmap-based subtitle codec '%s', ignoring.\n", avcodec_get_name(codeccontext->codec_id));
                }
            } else {
                if (codeccontext->sub_text_format == AV_SUBTITLE_TEXT_FMT_AUTO) {
                    codeccontext->sub_text_format = AV_SUBTITLE_TEXT_FMT_PRE_DECODER;
                }
#if HAVE_ICONV
                if (codeccontext->sub_text_format == AV_SUBTITLE_TEXT_FMT_PRE_DECODER &&
                    codeccontext->encoding) {
                    char *test_string = "test";
                    size_t test_len = strlen(test_string);
                    char *out_buf = NULL;
                    size_t out_len = 0;
                    if (av_iconv(NULL, codeccontext->encoding, "UTF-8", test_string, test_len, &out_buf, &out_len) < 0) {
                        av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle encoding '%s' specified\n", codeccontext->encoding);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    av_free(out_buf);
                }
#endif
            }
        }