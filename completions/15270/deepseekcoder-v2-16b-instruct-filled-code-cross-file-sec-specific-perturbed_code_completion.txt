// Check if subtitle character encoding is set and handle accordingly.
    // Ensure that character encoding is only used with subtitle codecs.
    // If the codec is bitmap-based, character encoding is ignored with a warning.
    // For text-based subtitle codecs, set the character encoding mode to pre-decoder
    // if it is in automatic mode and validate the input encoding using iconv if available.
    if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->subtitle_header) {
        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_FORCED) {
            av_log(codeccontext, AV_LOG_WARNING, "Forced subtitle encoding not supported, ignoring.\n");
        }
        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_TEXT) {
            if (codeccontext->subtitle_encoding) {
                av_log(codeccontext, AV_LOG_WARNING, "Subtitle encoding already set, ignoring.\n");
            } else {
                codeccontext->subtitle_encoding = av_strdup(codeccontext->subtitle_header->subtitle_format);
                if (!codeccontext->subtitle_encoding) {
                    ret = AVERROR(ENOMEM);
                    goto free_and_end;
                }
                if (iconv_open("UTF-8", codeccontext->subtitle_encoding) == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_WARNING, "Invalid subtitle encoding '%s', ignoring.\n", codeccontext->subtitle_encoding);
                    av_free(codeccontext->subtitle_encoding);
                    codeccontext->subtitle_encoding = NULL;
                } else {
                    av_log(codeccontext, AV_LOG_INFO, "Subtitle encoding set to '%s'.\n", codeccontext->subtitle_encoding);
                }
            }
        } else {
            av_log(codeccontext, AV_LOG_WARNING, "Non-text subtitle content, ignoring encoding setting.\n");
        }
    }