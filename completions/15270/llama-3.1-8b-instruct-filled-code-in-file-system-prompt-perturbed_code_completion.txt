if (av_codec_is_decoder(codeccontext->codec)) {
    if (!codeccontext->bit_rate)
        codeccontext->bit_rate = get_bit_rate(codeccontext);
    /* validate channel layout from the decoder */
    if (codeccontext->channel_layout) {
        int channels = av_get_channel_layout_nb_channels(codeccontext->channel_layout);
        if (!codeccontext->channels)
            codeccontext->channels = channels;
        else if (channels!= codeccontext->channels) {
            char buf[512];
            av_get_channel_layout_string(buf, sizeof(buf), -1, codeccontext->channel_layout);
            av_log(codeccontext, AV_LOG_WARNING,
                   "Channel layout '%s' with %d channels does not match specified number of channels %d: "
                   "ignoring specified channel layout\n",
                   buf, channels, codeccontext->channels);
            codeccontext->channel_layout = 0;
        }
    }
    if (codeccontext->channels && codeccontext->channels < 0 ||
        codeccontext->channels > FF_SANE_NB_CHANNELS) {
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
    // Check if subtitle character encoding is set and handle accordingly.
    // Ensure that character encoding is only used with subtitle codecs.
    // If the codec is bitmap-based, character encoding is ignored with a warning.
    // For text-based subtitle codecs, set the character encoding mode to pre-decoder
    // if it is in automatic mode and validate the input encoding using iconv if available.
    if (codeccontext->codec->type == AVMEDIA_TYPE_SUBTITLE) {
        if (codeccontext->codec->priv_class == &avcodec_subtitle_class) {
            if (codeccontext->codec->priv_data_size > 0) {
                if (av_codec_is_subtitle_codec(codeccontext->codec)) {
                    if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_data) {
                        if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_data_size > 0) {
                            if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class) {
                                if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0) {
                                    if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data) {
                                        if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec)) {
                                            if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class) {
                                                if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0) {
                                                    if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                        if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                            if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                    if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                        if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                            if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                    if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                        if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                            if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                                if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                                    if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data_size > 0) {
                                                                                                        if (av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->priv_data && av_codec_is_subtitle_codec(codeccontext->codec) && codeccontext->codec->priv_class == &avcodec_subtitle_class && codeccontext->codec->priv_data_size > 0 && codeccontext->codec->pri