if (codeccontext->charenc_mode != FF_SUB_CHARENC_MODE_DO_NOTHING) {
    if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE) {
        av_log(codeccontext, AV_LOG_ERROR,
               "Character encoding is only supported with subtitle codecs\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
    if (ff_sub_text_is_bitmap(codeccontext->codec_id)) {
        if (codeccontext->charenc_mode != FF_SUB_CHARENC_MODE_AUTOMATIC ||
            codeccontext->sub_charenc) {
            av_log(codeccontext, AV_LOG_WARNING,
                   "Character encoding is ignored for bitmap-based subtitle codec '%s'\n",
                   avcodec_get_name(codeccontext->codec_id));
        }
        codeccontext->charenc_mode = FF_SUB_CHARENC_MODE_DO_NOTHING;
        av_freep(&codeccontext->sub_charenc);
    } else {
        if (codeccontext->charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
            codeccontext->charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
#if HAVE_ICONV
        if (codeccontext->sub_charenc) {
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR,
                       "Invalid input character encoding: '%s'\n",
                       codeccontext->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
        }
#endif
    }
}