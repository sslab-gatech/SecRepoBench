if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->subtitle_header) {
        if (codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE) {
            av_log(codeccontext, AV_LOG_WARNING, "Ignoring subtitle encoding for bitmap-based subtitles\n");
        } else {
            if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
                codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;

            if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
                iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                if (cd == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_ERROR, "Unable to open iconv context "
                           "with input character encoding \"%s\"\n", codeccontext->sub_charenc);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
#else
                av_log(codeccontext, AV_LOG_WARNING, "Subtitle character encoding is set, "
                       "but iconv is not compiled in. Encoding will be ignored.\n");
#endif
            }
        }
    }
}