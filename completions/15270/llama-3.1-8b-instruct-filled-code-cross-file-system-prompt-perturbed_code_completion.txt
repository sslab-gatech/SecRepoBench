if (av_codec_is_decoder(codeccontext->codec)) {
    if (codeccontext->codec->priv_data_size > 0 && codeccontext->priv_data) {
        if (codeccontext->codec->priv_class) {
            if (av_codec_is_subtitle_codec(codeccontext->codec)) {
                if (codeccontext->codec->priv_data_size > 0 && codeccontext->priv_data) {
                    if (av_opt_find(codeccontext->priv_data, "charset") == NULL) {
                        av_log(codeccontext, AV_LOG_WARNING, "Character encoding not set for subtitle codec, using default\n");
                        av_opt_set(codeccontext->priv_data, "charset", "utf-8", 0);
                    } else {
                        const char *charset = av_opt_get(codeccontext->priv_data, "charset", 0);
                        if (av_strneq(charset, "auto", 4)) {
                            if (av_iconv_available()) {
                                AVIOContext *pb = avio_alloc_context(NULL, 0, 0, NULL, NULL, NULL, NULL);
                                if (pb) {
                                    int ret = av_iconv(codeccontext->priv_data, "auto", "utf-8", pb);
                                    if (ret >= 0) {
                                        av_log(codeccontext, AV_LOG_INFO, "Character encoding set to utf-8\n");
                                        av_opt_set(codeccontext->priv_data, "charset", "utf-8", 0);
                                    } else {
                                        av_log(codeccontext, AV_LOG_WARNING, "Failed to set character encoding to utf-8\n");
                                    }
                                    avio_free_context(pb);
                                }
                            } else {
                                av_log(codeccontext, AV_LOG_WARNING, "Character encoding not set, iconv not available\n");
                            }
                        }
                    }
                }
            }
        }
    }
}