if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    const AVCodecDescriptor *desc = avcodec_descriptor_get(codeccontext->codec_id);
    
    // Check if subtitle character encoding is set
    if (codeccontext->sub_charenc) {
        // Check if this is a bitmap-based subtitle codec
        int bitmap_subtitle = 0;
        if (desc && desc->props & AV_CODEC_PROP_BITMAP_SUB)
            bitmap_subtitle = 1;
        else if (codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE ||
                 codeccontext->codec_id == AV_CODEC_ID_DVD_SUBTITLE ||
                 codeccontext->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE ||
                 codeccontext->codec_id == AV_CODEC_ID_XSUB)
            bitmap_subtitle = 1;
            
        if (bitmap_subtitle) {
            // For bitmap-based subtitle codecs, character encoding is ignored with a warning
            av_log(codeccontext, AV_LOG_WARNING,
                   "Ignoring character encoding with bitmap subtitle codec\n");
        } else {
            // For text-based subtitle codecs
            // Set the character encoding mode to pre-decoder if it is in automatic mode
            if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
                codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
                
            // Validate the input encoding using iconv if available
            #if CONFIG_ICONV
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                ret = AVERROR(EINVAL);
                av_log(codeccontext, AV_LOG_ERROR, "Character encoding '%s' is not supported\n",
                       codeccontext->sub_charenc);
                goto free_and_end;
            }
            iconv_close(cd);
            #endif
        }
    }
}