if (codeccontext->subtitle_encoding == AV_CODEC_ID_NONE) {
            if (codeccontext->codec_id == AV_CODEC_ID_SSA ||
                codeccontext->codec_id == AV_CODEC_ID_ASS ||
                codeccontext->codec_id == AV_CODEC_ID_DVD_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_TEXT) {
                codeccontext->subtitle_encoding = AV_CODEC_SUB_ENC_MODE_AUTOMATIC;
            }
        } else if (codeccontext->subtitle_encoding == AV_CODEC_SUB_ENC_MODE_AUTOMATIC) {
            codeccontext->subtitle_encoding = AV_CODEC_SUB_ENC_MODE_PRE_DECODER;
        }
        if (codeccontext->subtitle_encoding == AV_CODEC_SUB_ENC_MODE_PRE_DECODER &&
            codeccontext->codec_id != AV_CODEC_ID_BITMAP_SUB &&
            codeccontext->codec_id != AV_CODEC_ID_XSUB) {
            if (CONFIG_ICONV) {
                iconv_t cd;
                char *inbuf = "test";
                char outbuf[1024];
                size_t inbytesleft = strlen(inbuf);
                size_t outbytesleft = sizeof(outbuf);
                cd = iconv_open(codeccontext->subtitle_encoding_str, "UTF-8");
                if (cd == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_WARNING, "iconv_open failed for encoding %s\n",
                           codeccontext->subtitle_encoding_str);
                } else {
                    if (iconv(cd, &inbuf, &inbytesleft, (char **)&outbuf, &outbytesleft) == (size_t)-1) {
                        av_log(codeccontext, AV_LOG_WARNING, "iconv failed for encoding %s\n",
                               codeccontext->subtitle_encoding_str);
                    }
                    iconv_close(cd);
                }
            } else {
                av_log(codeccontext, AV_LOG_WARNING, "iconv not available, cannot validate subtitle encoding\n");
            }
        } else if (codeccontext->subtitle_encoding != AV_CODEC_SUB_ENC_MODE_AUTOMATIC &&
                   codeccontext->codec_id == AV_CODEC_ID_BITMAP_SUB) {
            av_log(codeccontext, AV_LOG_WARNING, "Ignoring subtitle encoding for bitmap-based subtitle codec\n");
        }