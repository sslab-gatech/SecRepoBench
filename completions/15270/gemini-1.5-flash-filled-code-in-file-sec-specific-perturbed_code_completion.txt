if (codeccontext->subtitle_encoding == AV_CODEC_ID_NONE) {
            if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE &&
                codeccontext->codec_id != AV_CODEC_ID_TTF &&
                codeccontext->codec_id != AV_CODEC_ID_DVBSUB &&
                codeccontext->codec_id != AV_CODEC_ID_PGSSUB &&
                codeccontext->codec_id != AV_CODEC_ID_DVDSUB &&
                codeccontext->codec_id != AV_CODEC_ID_SUBRIP &&
                codeccontext->codec_id != AV_CODEC_ID_SSA &&
                codeccontext->codec_id != AV_CODEC_ID_ASS &&
                codeccontext->codec_id != AV_CODEC_ID_WEBVTT) {
                av_log(codeccontext, AV_LOG_WARNING,
                       "Subtitle encoding is not set, using UTF-8\n");
                codeccontext->subtitle_encoding = AV_CODEC_ID_UTF8;
            }
        } else if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE) {
            av_log(codeccontext, AV_LOG_WARNING,
                   "Subtitle encoding is ignored for non-subtitle codecs\n");
            codeccontext->subtitle_encoding = AV_CODEC_ID_NONE;
        } else if (codeccontext->codec_id == AV_CODEC_ID_TTF ||
                   codeccontext->codec_id == AV_CODEC_ID_DVBSUB ||
                   codeccontext->codec_id == AV_CODEC_ID_PGSSUB ||
                   codeccontext->codec_id == AV_CODEC_ID_DVDSUB ||
                   codeccontext->codec_id == AV_CODEC_ID_SUBRIP ||
                   codeccontext->codec_id == AV_CODEC_ID_SSA ||
                   codeccontext->codec_id == AV_CODEC_ID_ASS ||
                   codeccontext->codec_id == AV_CODEC_ID_WEBVTT) {
            if (codeccontext->subtitle_encoding == AV_CODEC_ID_AUTOMATIC) {
                codeccontext->subtitle_encoding_mode = AV_SUBTITLE_ENCODING_MODE_PRE_DECODER;
            }
#if CONFIG_ICONV
            if (codeccontext->subtitle_encoding != AV_CODEC_ID_NONE &&
                codeccontext->subtitle_encoding != AV_CODEC_ID_UTF8 &&
                codeccontext->subtitle_encoding != AV_CODEC_ID_AUTOMATIC) {
                iconv_t cd = iconv_open("UTF-8", avcodec_get_name(codeccontext->subtitle_encoding));
                if (cd == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_ERROR,
                           "Failed to open iconv for subtitle encoding\n");
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
            }
#endif
        } else {
            av_log(codeccontext, AV_LOG_WARNING,
                   "Subtitle encoding is ignored for bitmap-based subtitle codecs\n");
            codeccontext->subtitle_encoding = AV_CODEC_ID_NONE;
        }