if (codeccontext->sub_charenc) {
            if (av_codec_is_decoder(codec) && codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
                if (codec->id == AV_CODEC_ID_DVD_SUBTITLE || codec->id == AV_CODEC_ID_DVB_SUBTITLE ||
                    codec->id == AV_CODEC_ID_HDMV_PGS_SUBTITLE || codec->id == AV_CODEC_ID_XSUB) {
                    av_log(codeccontext, AV_LOG_WARNING, "Bitmap subtitle codec '%s' doesn't support character encoding\n", codec->name);
                    codeccontext->sub_charenc = NULL;
                } else {
                    if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
                        codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
#if CONFIG_ICONV
                    iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (cd == (iconv_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding: %s\n", codeccontext->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    iconv_close(cd);
#endif
                }
            } else {
                av_log(codeccontext, AV_LOG_WARNING, "Character encoding specified for non-subtitle codec\n");
                codeccontext->sub_charenc = NULL;
            }
        }