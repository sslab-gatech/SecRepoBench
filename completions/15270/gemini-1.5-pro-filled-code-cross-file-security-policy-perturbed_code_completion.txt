if (codeccontext->sub_charenc) {
            if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE) {
                av_log(codeccontext, AV_LOG_WARNING, "Codec type is not subtitle, ignoring sub_charenc\n");
                codeccontext->sub_charenc_mode = SUB_CHARENC_MODE_DO_NOTHING;
            } else if (codeccontext->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
                av_log(codeccontext, AV_LOG_WARNING, "Codec is bitmap based, ignoring sub_charenc\n");
                codeccontext->sub_charenc_mode = SUB_CHARENC_MODE_DO_NOTHING;
            } else if (codeccontext->sub_charenc_mode == SUB_CHARENC_MODE_AUTO) {
                codeccontext->sub_charenc_mode = SUB_CHARENC_MODE_PRE_DECODER;
            }
#if CONFIG_ICONV
            if (codeccontext->sub_charenc_mode == SUB_CHARENC_MODE_PRE_DECODER) {
                if (codeccontext->sub_charenc[0] == '\0') {
                    av_log(codeccontext, AV_LOG_ERROR, "No input character encoding specified, but sub_charenc_mode is set to PRE_DECODER\n");
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                codeccontext->iconv_in = iconv_open("UTF-8", codeccontext->sub_charenc);
                if (codeccontext->iconv_in == (iconv_t)-1) {

                    if (errno == EINVAL) {
                        av_log(codeccontext, AV_LOG_ERROR, "The specified input character encoding '%s' is not supported\n", codeccontext->sub_charenc);

                    } else
                        av_log(codeccontext, AV_LOG_ERROR, "iconv_open() failed: %s\n", strerror(errno));

                    ret = AVERROR(errno == EINVAL ? EINVAL : ENOMEM); // If EINVAL, return EINVAL, otherwise ENOMEM.

                    goto free_and_end;
                }
            }
#endif
            if (codeccontext->sub_charenc[strlen(codeccontext->sub_charenc) - 1] == '\n')
                codeccontext->sub_charenc[strlen(codeccontext->sub_charenc) - 1] = '\0';
        } else {
            codeccontext->sub_charenc_mode = SUB_CHARENC_MODE_DO_NOTHING;
        }