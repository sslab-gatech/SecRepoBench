if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->sub_charenc) {
    if (codeccontext->codec->capabilities & AV_CODEC_CAP_BITMAP_SUB) {
        av_log(codeccontext, AV_LOG_WARNING,
               "Ignoring character encoding \"%s\" for bitmap subtitle\n",
               codeccontext->sub_charenc);
    } else {
        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
            codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
#if CONFIG_ICONV
        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                ret = AVERROR(EINVAL);
                av_log(codeccontext, AV_LOG_ERROR, "Unable to open iconv context "
                       "for character encoding \"%s\"\n", codeccontext->sub_charenc);
                goto free_and_end;
            }
            iconv_close(cd);
        }
#endif
    }
}