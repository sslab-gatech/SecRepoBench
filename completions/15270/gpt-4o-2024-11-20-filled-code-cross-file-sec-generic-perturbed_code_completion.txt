if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
            if (codeccontext->sub_charenc) {
                if (codeccontext->codec->caps_internal & FF_CODEC_CAP_BITMAP_SUB) {
                    av_log(codeccontext, AV_LOG_WARNING,
                           "Character encoding is not applicable for bitmap-based subtitle codec '%s', ignoring.\n",
                           codeccontext->codec->name);
                    codeccontext->sub_charenc = NULL;
                } else {
                    if (!codeccontext->sub_charenc_mode)
                        codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;

                    if (codeccontext->sub_charenc_mode != FF_SUB_CHARENC_MODE_PRE_DECODER) {
                        av_log(codeccontext, AV_LOG_ERROR,
                               "Invalid character encoding mode for subtitle codec '%s'.\n",
                               codeccontext->codec->name);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }

#if CONFIG_ICONV
                    codeccontext->internal->iconv_ctx = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (codeccontext->internal->iconv_ctx == (iconv_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR,
                               "Unable to open iconv context with character encoding '%s'.\n",
                               codeccontext->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
#else
                    av_log(codeccontext, AV_LOG_ERROR,
                           "Character encoding support requires iconv, which is not enabled in this build.\n");
                    ret = AVERROR(ENOSYS);
                    goto free_and_end;
#endif
                }
            }
        }