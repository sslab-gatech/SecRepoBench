if (codeccontext->sub_charenc_mode != AV_SUB_CHARENC_MODE_DO_NOTHING) {
            if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE) {
                av_log(codeccontext, AV_LOG_WARNING, "Codec is not a subtitle codec, ignoring sub_charenc options\n");
                codeccontext->sub_charenc = NULL;
                codeccontext->sub_charenc_mode = AV_SUB_CHARENC_MODE_DO_NOTHING;
            } else if (codeccontext->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
                av_log(codeccontext, AV_LOG_WARNING, "Codec is a bitmap subtitle codec, ignoring sub_charenc options\n");
                codeccontext->sub_charenc = NULL;
                codeccontext->sub_charenc_mode = AV_SUB_CHARENC_MODE_DO_NOTHING;
            } else if (codeccontext->sub_charenc_mode == AV_SUB_CHARENC_MODE_AUTOMATIC) {
                // if the user does not specify the mode, set it to pre-decoder by default.
                codeccontext->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_DECODER;
            }
        }

        if (codeccontext->sub_charenc_mode == AV_SUB_CHARENC_MODE_PRE_DECODER) {
            if (codeccontext->sub_charenc) {
#if CONFIG_ICONV
                iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                if (cd == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_ERROR, "Unable to open iconv context with input character encoding \"%s\"\n",
                        codeccontext->sub_charenc);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
#else
                av_log(codeccontext, AV_LOG_WARNING, "Character encoding subtitles requested, but iconv is not available. "
                                            "Subtitles will not be processed.\n");
                ret = AVERROR(ENOSYS);
                goto free_and_end;
#endif
            }
        }