if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->subtitle_header) {
        av_log(codeccontext, AV_LOG_WARNING, "Subtitle header already set.\n");
    } else if (codeccontext->extradata && codeccontext->extradata_size > 0) {
        codeccontext->subtitle_header = av_malloc(codeccontext->extradata_size);
        if (!codeccontext->subtitle_header) {
            ret = AVERROR(ENOMEM);
            goto free_and_end;
        }
        memcpy(codeccontext->subtitle_header, codeccontext->extradata, codeccontext->extradata_size);
    }

    if (codeccontext->charenc) {
        if (!av_codec_is_decoder(codec)) {
            av_log(codeccontext, AV_LOG_WARNING, "Character encoding is only applicable for subtitle decoders.\n");
        } else {
            if (codec->props & FF_CODEC_PROP_BITMAP_SUB) {
                av_log(codeccontext, AV_LOG_WARNING, "Character encoding is not applicable for bitmap-based subtitles.\n");
            } else {
                if (codeccontext->charenc_mode == AVCODEC_CHARACTER_ENCODING_PRE_DECODER) {
                    // Validate input encoding using iconv if available
                    // Assuming iconv-related functions are defined elsewhere in the project
                    if (!have_iconv()) {
                        av_log(codeccontext, AV_LOG_ERROR, "iconv support is required for character encoding conversion but it is not available.\n");
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    if (validate_input_encoding(codeccontext->charenc)) {
                        av_log(codeccontext, AV_LOG_ERROR, "Invalid input character encoding specified.\n");
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                } else if (codeccontext->charenc_mode == AVCODEC_CHARACTER_ENCODING_AUTOMATIC) {
                    codeccontext->charenc_mode = AVCODEC_CHARACTER_ENCODING_PRE_DECODER;
                }
            }
        }
    }
}