if (codeccontext->subtitle_header) {
    if (codeccontext->subtitle_header_size < 0) {
        av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle header size\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
    codeccontext->subtitle_header = av_malloc(codeccontext->subtitle_header_size);
    if (!codeccontext->subtitle_header) {
        ret = AVERROR(ENOMEM);
        goto free_and_end;
    }
    memcpy(codeccontext->subtitle_header, codeccontext->codec->subtitle_header, codeccontext->subtitle_header_size);
}

if (codeccontext->codec->subtitle_encoding_mode == SUBTITLE_ENCODING_MODE_AUTOMATIC) {
    if (codeccontext->subtitle_character_encoding) {
        if (!iconv_open("UTF-8", codeccontext->subtitle_character_encoding)) {
            av_log(codeccontext, AV_LOG_ERROR, "Unsupported subtitle character encoding: %s\n", codeccontext->subtitle_character_encoding);
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
        codeccontext->codec->subtitle_encoding_mode = SUBTITLE_ENCODING_MODE_PRE_DECODER;
    } else {
        av_log(codeccontext, AV_LOG_WARNING, "Subtitle character encoding not set, defaulting to UTF-8\n");
        codeccontext->subtitle_character_encoding = av_strdup("UTF-8");
        if (!codeccontext->subtitle_character_encoding) {
            ret = AVERROR(ENOMEM);
            goto free_and_end;
        }
        codeccontext->codec->subtitle_encoding_mode = SUBTITLE_ENCODING_MODE_PRE_DECODER;
    }
} else if (codeccontext->codec->subtitle_encoding_mode == SUBTITLE_ENCODING_MODE_BITMAP) {
    if (codeccontext->subtitle_character_encoding) {
        av_log(codeccontext, AV_LOG_WARNING, "Subtitle character encoding ignored for bitmap subtitles\n");
        av_freep(&codeccontext->subtitle_character_encoding);
    }
}