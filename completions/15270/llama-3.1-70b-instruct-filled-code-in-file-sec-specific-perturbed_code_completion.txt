if (avctx->codec_id == AV_CODEC_ID_TEXT && avctx->subtitle_header) {
    if (avctx->codec_descriptor->props & AV_CODEC_PROP_TEXT_SUB) {
        if (avctx->subtitle_header->type == 0) {
            av_log(avctx, AV_LOG_WARNING, "No character encoding set, defaulting to UTF-8.\n");
            avctx->subtitle_header->type = 0x03;
        }
        if (avctx->subtitle_header->type!= 0x03) {
            av_log(avctx, AV_LOG_ERROR, "Unsupported subtitle character encoding: %d\n", avctx->subtitle_header->type);
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
    } else {
        av_log(avctx, AV_LOG_WARNING, "Ignoring character encoding for bitmap subtitles.\n");
        avctx->subtitle_header->type = 0;
    }
}