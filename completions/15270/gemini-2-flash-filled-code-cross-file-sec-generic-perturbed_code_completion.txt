if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
            if (codeccontext->subtitle_header) {
                av_freep(&codeccontext->subtitle_header);
            }

            if (codeccontext->codec_id == AV_CODEC_ID_DVD_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE ||
                codeccontext->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
                if (codeccontext->sub_text_format) {
                    av_log(codeccontext, AV_LOG_WARNING, "Character encoding not supported for bitmap subtitle codecs, ignoring.\n");
                }
            } else {
                if (codeccontext->sub_text_format == SUB_TEXT_FMT_AUTO) {
                    codeccontext->sub_text_format = SUB_TEXT_FMT_PRE_DECODER;
                }
#if HAVE_ICONV
                if (codeccontext->sub_text_format == SUB_TEXT_FMT_PRE_DECODER &&
                    codeccontext->sub_charenc) {
                    iconv_t cd = (iconv_t)(intptr_t)-1;
                    cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (cd == (iconv_t)(intptr_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding %s, using UTF-8.\n", codeccontext->sub_charenc);
                        av_free(codeccontext->sub_charenc);
                        codeccontext->sub_charenc = NULL;
                    } else {
                        iconv_close(cd);
                    }
                }
#endif
            }
        }