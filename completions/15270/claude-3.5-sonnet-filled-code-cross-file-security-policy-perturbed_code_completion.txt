if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->codec->capabilities & AV_CODEC_CAP_BITMAP_SUB) {
        if (codeccontext->sub_charenc)
            av_log(codeccontext, AV_LOG_WARNING, "Ignoring character encoding for bitmap-based subtitle codec\n");
    } else {
        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTO) {
            codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
        }

        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
            if (codeccontext->sub_charenc) {
                if (codeccontext->sub_charenc[0]) {
#if CONFIG_ICONV
                    iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (cd == (iconv_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR, "Unable to open iconv context for character encoding '%s'\n", codeccontext->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    iconv_close(cd);
#else
                    av_log(codeccontext, AV_LOG_WARNING, "Character encoding '%s' not validated (iconv not available)\n", codeccontext->sub_charenc);
#endif
                } else {
                    av_log(codeccontext, AV_LOG_WARNING, "Empty character encoding, ignoring\n");
                    av_freep(&codeccontext->sub_charenc);
                }
            }
        }
    }
}