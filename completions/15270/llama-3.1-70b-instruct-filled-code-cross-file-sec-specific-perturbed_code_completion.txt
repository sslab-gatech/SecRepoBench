if (codeccontext->subtitle_header && codeccontext->codec_id == AV_CODEC_ID_TEXT) {
    if (avctx->subtitle_char_encoding_mode == AV_SUBTITLE_CHAR_ENCODING_MODE_AUTO) {
        avctx->subtitle_char_encoding_mode = AV_SUBTITLE_CHAR_ENCODING_MODE_PRE_DECODER;
    }
    if (avctx->subtitle_char_encoding_mode == AV_SUBTITLE_CHAR_ENCODING_MODE_PRE_DECODER) {
        if (avctx->subtitle_char_encoding) {
            if (avcodec_char_encoding_mode_is_valid(avctx->subtitle_char_encoding) < 0) {
                av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding '%s'\n", avctx->subtitle_char_encoding);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
        } else {
            avctx->subtitle_char_encoding = "UTF-8";
        }
    }
} else if (codeccontext->codec_id == AV_CODEC_ID_BITMAP && avctx->subtitle_char_encoding) {
    av_log(codeccontext, AV_LOG_WARNING, "Ignoring subtitle character encoding for bitmap-based subtitle codec\n");
    avctx->subtitle_char_encoding = NULL;
}