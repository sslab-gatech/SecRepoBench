// Check if subtitle character encoding is set and handle accordingly.
        // Ensure that character encoding is only used with subtitle codecs.
        // If the codec is bitmap-based, character encoding is ignored with a warning.
        // For text-based subtitle codecs, set the character encoding mode to pre-decoder
        // if it is in automatic mode and validate the input encoding using iconv if available.
        if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->sub_charenc) {
            // Detect simple bitmap-based subtitles (this list may be extended as needed)
            int is_bitmap_sub =
                   codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE  ||
                   codeccontext->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE ||
                   codeccontext->codec_id == AV_CODEC_ID_XSUB          ||
                   codeccontext->codec_id == AV_CODEC_ID_VOBSUB;

            if (is_bitmap_sub) {
                av_log(codeccontext, AV_LOG_WARNING,
                       "Ignoring character encoding option for bitmap-based subtitles.\n");
            } else {
                if (!strcmp(codeccontext->sub_charenc, "auto")) {
                    codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
                } else {
#if CONFIG_ICONV
                    iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (cd == (iconv_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR,
                               "Could not open iconv for encoding '%s'\n",
                               codeccontext->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    iconv_close(cd);
#else
                    av_log(codeccontext, AV_LOG_WARNING,
                           "Character encoding '%s' requested, but iconv not compiled.\n",
                           codeccontext->sub_charenc);
#endif
                    codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
                }
            }
        }