if (codec->codec_type == AVMEDIA_TYPE_SUBTITLE && codec->sub_charenc) {
    const AVCodecDescriptor *desc = avcodec_descriptor_get(codec->codec_id);
    if (desc && (desc->props & AV_CODEC_PROP_BITMAP_SUB)) {
        av_log(codec, AV_LOG_WARNING, 
               "Character encoding '%s' is ignored for bitmap subtitles\n", 
               codec->sub_charenc);
    } else {
        par->sub_charenc = av_strdup(codec->sub_charenc);
        if (!par->sub_charenc)
            return AVERROR(ENOMEM);
        
        if (codec->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
            par->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
        else
            par->sub_charenc_mode = codec->sub_charenc_mode;
        
#if CONFIG_ICONV
        iconv_t cd = iconv_open("UTF-8", codec->sub_charenc);
        if (cd == (iconv_t)-1) {
            av_log(codec, AV_LOG_WARNING, 
                   "Subtitle encoding '%s' not recognized by iconv\n", 
                   codec->sub_charenc);
        } else {
            iconv_close(cd);
        }
#endif
    }
}