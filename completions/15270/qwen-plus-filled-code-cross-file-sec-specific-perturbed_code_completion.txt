if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->properties & FF_CODEC_PROPERTY_TEXT_SUB) {
        if (codeccontext->sub_charenc_mode == AV_SUBCHAR_ENCODING_PRE_DECODER) {
            if (!codeccontext->sub_charenc) {
                av_log(codeccontext, AV_LOG_WARNING, "Character encoding not specified for text-based subtitle codec.\n");
            } else {
                // Validate the input encoding using iconv if available.
                // Assuming a function validate_encoding exists which uses iconv to check the encoding validity.
                if (!validate_encoding(codeccontext->sub_charenc)) {
                    av_log(codeccontext, AV_LOG_ERROR, "Invalid or unsupported character encoding: %s\n", codeccontext->sub_charenc);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
            }
        } else if (codeccontext->sub_charenc_mode == AV_SUBCHAR_ENCODING_AUTOMATIC && codeccontext->sub_charenc) {
            codeccontext->sub_charenc_mode = AV_SUBCHAR_ENCODING_PRE_DECODER;
            if (!validate_encoding(codeccontext->sub_charenc)) {
                av_log(codeccontext, AV_LOG_ERROR, "Invalid or unsupported character encoding: %s\n", codeccontext->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
        }
    } else if (codeccontext->properties & FF_CODEC_PROPERTY_BITMAP_SUB) {
        if (codeccontext->sub_charenc || codeccontext->sub_charenc_mode != AV_SUBCHAR_ENCODING_NONE) {
            av_log(codeccontext, AV_LOG_WARNING, "Character encoding is ignored for bitmap-based subtitle codec.\n");
            codeccontext->sub_charenc = NULL;
            codeccontext->sub_charenc_mode = AV_SUBCHAR_ENCODING_NONE;
        }
    }
}