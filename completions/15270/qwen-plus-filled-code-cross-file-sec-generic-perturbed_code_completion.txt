if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->subtitle_header && codeccontext->coded_frame) {
        av_log(codeccontext, AV_LOG_WARNING, "Subtitle header already set; ignoring redundant data.\n");
    } else if (codeccontext->charenc_mode == AV_CODEC_CHARENC_MODE_PRE_DECODER && 
               codeccontext->charenc) {
        // Validate and set the character encoding for text-based subtitles
        if (!avcodec_decode_subtitle2(codeccontext, NULL, NULL, NULL)) {
            codeccontext->subtitle_header = av_malloc(AV_INPUT_BUFFER_PADDING_SIZE);
            if (!codeccontext->subtitle_header) {
                ret = AVERROR(ENOMEM);
                goto free_and_end;
            }
            if (iconv_codec_validate_input(codeccontext->charenc, codeccontext->subtitle_header, AV_INPUT_BUFFER_PADDING_SIZE)) {
                av_log(codeccontext, AV_LOG_ERROR, "Invalid character encoding specified.\n");
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
        } else {
            av_log(codeccontext, AV_LOG_WARNING, "Character encoding not applicable to bitmap subtitles.\n");
            codeccontext->charenc_mode = AV_CODEC_CHARENC_MODE_AUTOMATIC;
        }
    } else if (codeccontext->charenc_mode != AV_CODEC_CHARENC_MODE_AUTOMATIC) {
        av_log(codeccontext, AV_LOG_WARNING, "Character encoding mode set but no text subtitle data available.\n");
    }
}