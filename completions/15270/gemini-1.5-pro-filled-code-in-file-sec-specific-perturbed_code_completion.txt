if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTO) {
        codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
    } else if (codeccontext->sub_charenc_mode != FF_SUB_CHARENC_MODE_IGNORE &&
               codeccontext->sub_charenc_mode != FF_SUB_CHARENC_MODE_PRE_DECODER) {
        av_log(codeccontext, AV_LOG_WARNING, "Invalid subtitle character encoding mode: %d\n",
               codeccontext->sub_charenc_mode);
        codeccontext->sub_charenc = NULL;
        codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_IGNORE;
    }

    if (codeccontext->sub_charenc && codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
        iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
        if (cd == (iconv_t)-1) {
            ret = AVERROR(EINVAL);

            if (codeccontext->err_recognition & AV_EF_EXPLODE)
                goto free_and_end;

            av_log(codeccontext, AV_LOG_WARNING, "Invalid subtitle encoding: %s. "
                   "Decoder will continue without converting.\n", codeccontext->sub_charenc);
            codeccontext->sub_charenc = NULL;
        }
        iconv_close(cd);
#else
        if (codeccontext->sub_charenc) {
            av_log(codeccontext, AV_LOG_WARNING, "Subtitle encoding not supported. "
                   "Decoder will continue without converting.\n");
            codeccontext->sub_charenc = NULL;
        }
#endif
    }

    if (codeccontext->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
        if (codeccontext->sub_charenc) {
            av_log(codeccontext, AV_LOG_WARNING, "Codec '%s' is bitmap-based, "
                   "ignoring character encoding: %s.\n", codeccontext->codec_descriptor->name,
                   codeccontext->sub_charenc);
            codeccontext->sub_charenc = NULL;
        }
    }
}