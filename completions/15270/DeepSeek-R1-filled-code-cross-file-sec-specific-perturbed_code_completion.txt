if (codeccontext->sub_charenc[0]) {
            if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE || !av_codec_is_decoder(codec)) {
                av_log(codeccontext, AV_LOG_ERROR, "Character encoding is only supported by subtitle decoders\n");
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            if (codec->capabilities & AV_CODEC_CAP_BITMAP_SUB) {
                av_log(codeccontext, AV_LOG_WARNING, "Codec '%s' is bitmap-based, ignoring character encoding\n", codec->name);
                codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_DO_NOTHING;
            } else {
                if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTO)
                    codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
#ifdef HAVE_ICONV
                iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                if (cd == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding '%s'\n", codeccontext->sub_charenc);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
#endif
            }
        }