if (codeccontext->subtitle_header && codeccontext->codec->type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->subtitle_header->format == 0) {
        // Automatic mode, set the character encoding mode to pre-decoder
        codeccontext->subtitle_header->format = 1;
    } else if (codeccontext->subtitle_header->format == 1) {
        // Pre-decoder mode, validate the input encoding using iconv if available
        if (avcodec_iconv_check(codeccontext->subtitle_header->data, codeccontext->subtitle_header->size) < 0) {
            av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding\n");
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
    }
} else if (codeccontext->codec->type == AVMEDIA_TYPE_SUBTITLE) {
    av_log(codeccontext, AV_LOG_WARNING, "Subtitle character encoding not set\n");
}