if (codeccontext->codec->type != AVMEDIA_TYPE_SUBTITLE && codeccontext->sub_charenc) {
    av_log(codeccontext, AV_LOG_WARNING,
           "Character encoding is only applicable for subtitle codecs; ignoring provided encoding '%s'\n",
           codeccontext->sub_charenc);
    av_freep(&codeccontext->sub_charenc);
} else if (codeccontext->codec->type == AVMEDIA_TYPE_SUBTITLE) {
    /* For bitmap-based subtitle codecs (e.g. DVD or DVB subtitles),
     * character encoding is not applicable. */
    if (codeccontext->codec->id == AV_CODEC_ID_DVD_SUBTITLE ||
        codeccontext->codec->id == AV_CODEC_ID_DVB_SUBTITLE) {
        if (codeccontext->sub_charenc) {
            av_log(codeccontext, AV_LOG_WARNING,
                   "Bitmap-based subtitle codec '%s' does not use character encoding; ignoring '%s'\n",
                   codeccontext->codec->name, codeccontext->sub_charenc);
            av_freep(&codeccontext->sub_charenc);
        }
    } else {
        /* For text-based subtitle codecs, if set to "automatic"
         * switch to pre-decoder mode and validate the encoding. */
        if (codeccontext->sub_charenc && !strcmp(codeccontext->sub_charenc, "automatic")) {
            av_log(codeccontext, AV_LOG_DEBUG,
                   "Subtitle character encoding set to automatic; switching to pre-decoder mode\n");
            av_freep(&codeccontext->sub_charenc);
            codeccontext->sub_charenc = av_strdup("predec");
            if (!codeccontext->sub_charenc) {
                ret = AVERROR(ENOMEM);
                goto free_and_end;
            }
        }
#if HAVE_ICONV
        if (codeccontext->sub_charenc) {
            iconv_t conv = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (conv == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR,
                       "Invalid subtitle character encoding: '%s'\n", codeccontext->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(conv);
        }
#endif
    }
}