if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
        if (codec->props_flags & AV_CODEC_PROP_TEXT_SUB) {
            if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC) {
                codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
            }
            if (codeccontext->sub_charenc) {
#ifdef HAVE_ICONV
                iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                if (cd == (iconv_t)-1) {
                    av_log(codeccontext, AV_LOG_ERROR, "Invalid character encoding specified: %s\n", codeccontext->sub_charenc);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
#endif
            }
        } else if (codec->props_flags & AV_CODEC_PROP_BITMAP_SUB) {
            if (codeccontext->sub_charenc) {
                av_log(codeccontext, AV_LOG_WARNING, "Character encoding specified for bitmap subtitle codec, ignoring.\n");
                av_freep(&codeccontext->sub_charenc);
            }
        }
    } else {
        if (codeccontext->sub_charenc) {
            av_log(codeccontext, AV_LOG_ERROR, "Character encoding specified for non-subtitle codec.\n");
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
    }