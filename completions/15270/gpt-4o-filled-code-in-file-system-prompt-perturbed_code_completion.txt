if (codeccontext->sub_charenc) {
            if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE) {
                av_log(codeccontext, AV_LOG_WARNING,
                       "Character encoding is only used with subtitles codecs\n");
            } else if (codeccontext->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
                av_log(codeccontext, AV_LOG_WARNING,
                       "Character encoding is not applicable for bitmap subtitles\n");
            } else {
                if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
                    codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
#if CONFIG_ICONV
                if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
                    iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
                    if (cd == (iconv_t)-1) {
                        av_log(codeccontext, AV_LOG_ERROR,
                               "Unable to open iconv context with charset: %s\n",
                               codeccontext->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    iconv_close(cd);
                }
#endif
            }
        }