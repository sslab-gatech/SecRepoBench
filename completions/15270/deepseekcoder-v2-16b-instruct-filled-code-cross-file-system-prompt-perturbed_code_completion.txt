// Check if subtitle character encoding is set and handle accordingly.
    // Ensure that character encoding is only used with subtitle codecs.
    // If the codec is bitmap-based, character encoding is ignored with a warning.
    // For text-based subtitle codecs, set the character encoding mode to pre-decoder
    // if it is in automatic mode and validate the input encoding using iconv if available.
    if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->subtitle_header) {
        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_FORCED) {
            av_log(codeccontext, AV_LOG_WARNING, "Forced subtitle encoding not supported, ignoring.\n");
        }

        if (codeccontext->subtitle_header->num_rects > 0) {
            int i;
            for (i = 0; i < codeccontext->subtitle_header->num_rects; i++) {
                AVSubtitleRect *rect = codeccontext->subtitle_header->rects[i];
                if (rect->type == SUBTITLE_BITMAP) {
                    av_log(codeccontext, AV_LOG_WARNING, "Bitmap subtitles detected, character encoding ignored.\n");
                    continue;
                }

                if (rect->flags & AV_SUBTITLE_FLAG_TEXT) {
                    if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_NATIVE) {
                        av_log(codeccontext, AV_LOG_WARNING, "Native subtitle encoding not supported, ignoring.\n");
                    } else {
                        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_FORCED) {
                            av_log(codeccontext, AV_LOG_WARNING, "Forced subtitle encoding not supported, ignoring.\n");
                        } else {
                            if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_DEFAULT) {
                                av_log(codeccontext, AV_LOG_WARNING, "Default subtitle encoding not supported, ignoring.\n");
                            } else {
                                if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_DEPRECATED) {
                                    av_log(codeccontext, AV_LOG_WARNING, "Deprecated subtitle encoding not supported, ignoring.\n");
                                } else {
                                    if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_UNSYNC) {
                                        av_log(codeccontext, AV_LOG_WARNING, "Unsync subtitle encoding not supported, ignoring.\n");
                                    } else {
                                        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_INVALID) {
                                            av_log(codeccontext, AV_LOG_WARNING, "Invalid subtitle encoding not supported, ignoring.\n");
                                        } else {
                                            if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_UNSUPPORTED) {
                                                av_log(codeccontext, AV_LOG_WARNING, "Unsupported subtitle encoding not supported, ignoring.\n");
                                            } else {
                                                if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_BITMAP) {
                                                    av_log(codeccontext, AV_LOG_WARNING, "Bitmap subtitle encoding not supported, ignoring.\n");
                                                } else {
                                                    if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_TEXT) {
                                                        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_PRE_DECODER) {
                                                            av_log(codeccontext, AV_LOG_INFO, "Setting subtitle character encoding mode to pre-decoder.\n");
                                                            codeccontext->subtitle_header->flags |= AV_SUBTITLE_FLAG_PRE_DECODER;
                                                        }
                                                        if (codeccontext->subtitle_header->flags & AV_SUBTITLE_FLAG_AUTO) {
                                                            char *input_encoding = NULL;
                                                            if (iconv_open("UTF-8", "auto") != (iconv_t)-1) {
                                                                input_encoding = "auto";
                                                            } else if (iconv_open("UTF-8", "ISO-8859-1") != (iconv_t)-1) {
                                                                input_encoding = "ISO-8859-1";
                                                            } else if (iconv_open("UTF-8", "UTF-8") != (iconv_t)-1) {
                                                                input_encoding = "UTF-8";
                                                            }
                                                            if (input_encoding) {
                                                                av_log(codeccontext, AV_LOG_INFO, "Validating input encoding using iconv: %s.\n", input_encoding);
                                                                iconv_t cd = iconv_open("UTF-8", input_encoding);
                                                                if (cd != (iconv_t)-1) {
                                                                    iconv_close(cd);
                                                                    av_log(codeccontext, AV_LOG_INFO, "Input encoding is valid.\n");
                                                                } else {
                                                                    av_log(codeccontext, AV_LOG_ERROR, "Invalid input encoding.\n");
                                                                    ret = AVERROR(EINVAL);
                                                                    goto free_and_end;
                                                                }
                                                            } else {
                                                                av_log(codeccontext, AV_LOG_ERROR, "Unsupported input encoding.\n");
                                                                ret = AVERROR(EINVAL);
                                                                goto free_and_end;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }