if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->subtitle_character_encoding) {
    /* Check if the subtitle codec is text-based */
    if (   codeccontext->codec_id == AV_CODEC_ID_ASS
        || codeccontext->codec_id == AV_CODEC_ID_SSA
        || codeccontext->codec_id == AV_CODEC_ID_SRT
        || codeccontext->codec_id == AV_CODEC_ID_SUBRIP
        || codeccontext->codec_id == AV_CODEC_ID_TEXT ) {

        /* If in 'auto' mode, set to a safe pre-decoder default (e.g., "UTF-8") */
        if (!strcmp(codeccontext->subtitle_character_encoding, "auto")) {
            /* Replace with your safe default logic if needed; this is just an example */
            av_log(codeccontext, AV_LOG_VERBOSE, "Auto-detecting character encoding, defaulting to UTF-8.\n");
            codeccontext->subtitle_character_encoding = "UTF-8";
        }

#ifdef HAVE_ICONV
        {
            /* Validate the input encoding using iconv */
            iconv_t cd = iconv_open("UTF-8", codeccontext->subtitle_character_encoding);
            if (cd == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR,
                       "Failed to open iconv for the specified subtitle encoding '%s'.\n",
                       codeccontext->subtitle_character_encoding);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
        }
#endif

    } else {
        /* For bitmap-based (or otherwise unsupported) subtitle codecs, ignore the setting */
        av_log(codeccontext, AV_LOG_WARNING,
               "Ignoring subtitle character encoding for a non-text-based subtitle codec.\n");
    }
}