if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->sub_charenc) {
    /* Check if this is a bitmap subtitle codec */
    int is_bitmap_sub = 0;
    switch (codeccontext->codec_id) {
        case AV_CODEC_ID_DVD_SUBTITLE:
        case AV_CODEC_ID_HDMV_PGS_SUBTITLE:
        case AV_CODEC_ID_XSUB:
        case AV_CODEC_ID_DVB_SUBTITLE:
            is_bitmap_sub = 1;
            break;
        default:
            break;
    }
    
    if (is_bitmap_sub) {
        /* For bitmap subtitles, character encoding is ignored */
        av_log(codeccontext, AV_LOG_WARNING,
               "Ignoring character encoding \"%s\" for bitmap subtitle codec %s\n",
               codeccontext->sub_charenc, avcodec_get_name(codeccontext->codec_id));
    } else {
        /* For text-based subtitles, set automatic mode to pre-decoder */
        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
            codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
            
        /* Validate the encoding using iconv if available */
#if CONFIG_ICONV
        iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
        if (cd == (iconv_t)-1) {
            av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding \"%s\"\n",
                   codeccontext->sub_charenc);
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
        iconv_close(cd);
#else
        av_log(codeccontext, AV_LOG_WARNING, 
               "Character encoding \"%s\" is set but iconv is not compiled in\n",
               codeccontext->sub_charenc);
#endif
    }
}