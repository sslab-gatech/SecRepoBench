if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE && codeccontext->sub_charenc &&
    codeccontext->sub_charenc[0]) {
    /* Check if the codec is bitmapâ€based: for these, character encoding is meaningless */
    if (codec->id == AV_CODEC_ID_DVD_SUBTITLE ||
        codec->id == AV_CODEC_ID_DVB_SUBTITLE ||
        codec->id == AV_CODEC_ID_XSUB) {
        av_log(codeccontext, AV_LOG_WARNING,
               "Character encoding '%s' is ignored for bitmap subtitles.\n",
               codeccontext->sub_charenc);
    } else {
        /* For text-based subtitle codecs, if the encoding mode is set to automatic,
         * switch it to pre-decoder mode */
        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_AUTOMATIC)
            codeccontext->sub_charenc_mode = FF_SUB_CHARENC_PRE_DECODER;
#ifdef HAVE_ICONV
        {
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR,
                       "Invalid subtitle character encoding '%s'.\n",
                       codeccontext->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
        }
#endif
    }
}