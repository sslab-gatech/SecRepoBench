// Check if subtitle character encoding is set and handle accordingly.
// Ensure that character encoding is only used with subtitle codecs.
// If the codec is bitmap-based, character encoding is ignored with a warning.
// For text-based subtitle codecs, set the character encoding mode to pre-decoder
// if it is in automatic mode and validate the input encoding using iconv if available.
if (codeccontext->subtitle_header && av_codec_is_decoder(codeccontext->codec) &&
    codeccontext->codec_descriptor->type == AVMEDIA_TYPE_SUBTITLE) {
    AVSubSubtitle *sub = codeccontext->subtitle_header;
    if (sub->charenc) {
        if (sub->charenc_mode == AV_SUBTITLE_CHARENC_MODE_AUTOMATIC) {
            sub->charenc_mode = AV_SUBTITLE_CHARENC_MODE_PRE_DECODER;
#if HAVE_ICONV
            if (iconv_open(NULL, sub->charenc) == (size_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR, "iconv_open failed with character encoding %s\n", sub->charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
#endif
        }
    } else {
        av_log(codeccontext, AV_LOG_WARNING, "No character encoding specified for text-based subtitle codec\n");
    }
}