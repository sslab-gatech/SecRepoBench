if (avctx->codec_id == AV_CODEC_ID_TEXT && avctx->codec_descriptor->props & AV_CODEC_PROP_TEXT_SUB) {
    if (avctx->sub_charenc) {
        if (avctx->sub_charenc_mode == AV_SUB_CHARENC_MODE_AUTOMATIC) {
            avctx->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_DECODER;
        }
        if (avctx->sub_charenc_mode == AV_SUB_CHARENC_MODE_PRE_DECODER) {
            if (avcodec_charenc_from_tag(avctx->sub_charenc) < 0) {
                av_log(avctx, AV_LOG_ERROR, "Invalid subtitle character encoding tag: %d\n", avctx->sub_charenc);
                avctx->sub_charenc_mode = AV_SUB_CHARENC_MODE_DO_NOTHING;
            }
        }
    }
} else if (avctx->sub_charenc_mode!= AV_SUB_CHARENC_MODE_DO_NOTHING) {
    av_log(avctx, AV_LOG_WARNING, "Character encoding mode set for non-text subtitles, ignoring.\n");
    avctx->sub_charenc_mode = AV_SUB_CHARENC_MODE_DO_NOTHING;
}