if (avctx->codec_id == AV_CODEC_ID_TEXT && avctx->codec_descriptor->props & AV_CODEC_PROP_TEXT_SUB) {
    if (avctx->subtitle_header) {
        av_log(avctx, AV_LOG_ERROR, "Subtitle header already set\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
    if (avctx->extradata_size > 0) {
        avctx->subtitle_header = av_mallocz(avctx->extradata_size + AV_INPUT_BUFFER_PADDING_SIZE);
        if (!avctx->subtitle_header) {
            ret = AVERROR(ENOMEM);
            goto free_and_end;
        }
        memcpy(avctx->subtitle_header, avctx->extradata, avctx->extradata_size);
        avctx->subtitle_header_size = avctx->extradata_size;
    }
    if (avctx->character_encoding) {
        if (avctx->character_encoding == AV_CODEC_CHAR_ENC_AUTO) {
            if (avctx->codec_id == AV_CODEC_ID_SSA) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_ASS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_MOV_TEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_MAC;
            } else if (avctx->codec_id == AV_CODEC_ID_SRT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_MICRODVD) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBRIP) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_WEBVTT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_TELETEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_XSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_REALTEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SAMI) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_MPL2) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_ASS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_JACOSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SRT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER1) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_KATE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_XSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_TELETEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_REALTEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SAMI) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_MPL2) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_ASS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_JACOSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SRT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER1) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_KATE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_XSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_TELETEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_REALTEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SAMI) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_MPL2) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_ASS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_JACOSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SRT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER1) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_KATE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_XSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_TELETEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_REALTEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SAMI) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_MPL2) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_ASS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_JACOSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SRT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER1) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SUBVIEWER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_KATE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_XSUB) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_TELETEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_DVB_SUBTITLE) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_REALTEXT) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_SAMI) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_MPL2) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_VPLAYER) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_PJS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_LATIN1;
            } else if (avctx->codec_id == AV_CODEC_ID_ASS) {
                avctx->character_encoding = AV_CODEC_CHAR_ENC_UTF8;
            } else if (avctx->codec_id == AV_CODEC_ID_