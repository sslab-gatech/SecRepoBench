if (codeccontext->sub_charenc) {
        if (codeccontext->codec_type != AVMEDIA_TYPE_SUBTITLE) {
            av_log(codeccontext, AV_LOG_ERROR, "Character encoding specified for non-subtitle codec\n");
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
        if (codeccontext->codec_id == AV_CODEC_ID_DVD_SUBTITLE ||
            codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE ||
            codeccontext->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE ||
            codeccontext->codec_id == AV_CODEC_ID_XSUB) {
            av_log(codeccontext, AV_LOG_WARNING, "Ignoring character encoding for bitmap subtitle codec\n");
            codeccontext->sub_charenc = NULL;
        } else {
            if (codeccontext->sub_charenc_mode == AV_SUB_CHARENC_MODE_AUTO)
                codeccontext->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_DECODER;
#ifdef HAVE_ICONV
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding: %s\n", codeccontext->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
#endif
        }
    }