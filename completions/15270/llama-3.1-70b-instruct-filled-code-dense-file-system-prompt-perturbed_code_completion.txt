if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->subtitle_header) {
        av_log(avctx, AV_LOG_ERROR, "Subtitle header already set\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
    if (avctx->sub_charenc) {
        avctx->subtitle_header = av_mallocz(sizeof(*avctx->subtitle_header) + strlen(avctx->sub_charenc) + 1);
        if (!avctx->subtitle_header) {
            ret = AVERROR(ENOMEM);
            goto free_and_end;
        }
        avctx->subtitle_header->type = SUBTITLE_ASS;
        strcpy(avctx->subtitle_header->data, avctx->sub_charenc);
    } else if (avctx->sub_charenc_mode == SUB_CHARENC_MODE_PRE_DECODER) {
        avctx->sub_charenc = avcodec_descriptor_get_by_id(avctx->codec_id)->sub_charenc;
        if (!avctx->sub_charenc) {
            av_log(avctx, AV_LOG_ERROR, "No character encoding specified and unable to determine from codec\n");
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
        avctx->subtitle_header = av_mallocz(sizeof(*avctx->subtitle_header) + strlen(avctx->sub_charenc) + 1);
        if (!avctx->subtitle_header) {
            ret = AVERROR(ENOMEM);
            goto free_and_end;
        }
        avctx->subtitle_header->type = SUBTITLE_ASS;
        strcpy(avctx->subtitle_header->data, avctx->sub_charenc);
    }
} else if (avctx->sub_charenc) {
    av_log(avctx, AV_LOG_WARNING, "Character encoding specified for non-subtitle codec, ignoring\n");
    avctx->sub_charenc = NULL;
}