if (codeccontext->sub_charenc) {
    if (avcodec_is_subtitle(codeccontext->codec)) {
        if (avcodec_is_encoder(codeccontext->codec)) {
            // For text-based subtitle encoders, set the character encoding mode to pre-encoder.
            codeccontext->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_ENC;
        } else {
            // For text-based subtitle decoders, set the character encoding mode to pre-decoder.
            codeccontext->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_DEC;
        }
        // Validate the input encoding using iconv if available.
        if (iconv_valid(codeccontext->sub_charenc)) {
            // If the input encoding is valid, proceed with the decoding or encoding process.
        } else {
            av_log(codeccontext, AV_LOG_ERROR, "Invalid subtitle character encoding: %s\n", codeccontext->sub_charenc);
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
    } else {
        // If the codec is bitmap-based, character encoding is ignored with a warning.
        av_log(codeccontext, AV_LOG_WARNING, "Ignoring character encoding for bitmap-based codec: %s\n", codeccontext->sub_charenc);
    }
}