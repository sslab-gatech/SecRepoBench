if (streaming) {
    /*
     * In streaming mode, the attribute can disappear so we don't
     * establish a pointer to it. Instead, we record the attribute name.
     */
    if (attr->parent != NULL) {
        ret->line = xmlGetLineNo(attr->parent);
    }
    
    if (attr->name != NULL) {
        if (doc->dict) {
            ret->name = (const xmlChar *)
                       xmlDictLookup(doc->dict, attr->name, -1);
        } else {
            ret->name = xmlStrdup(attr->name);
            if (ret->name == NULL) {
                xmlFreeID(ret);
                return(-1);
            }
        }
    }
} else {
    /*
     * Not in streaming mode, establish links in both directions.
     */
    ret->attr = attr;
    if (attr->parent != NULL) {
        ret->line = xmlGetLineNo(attr->parent);
    }
}

/*
 * Add the ID to the hash table.
 */
if (xmlHashAddEntry(table, identifier, ret) < 0) {
    xmlFreeID(ret);
    return(-1);
}

/*
 * Set up the ID and attribute relationship
 */
attr->atype = XML_ATTRIBUTE_ID;
if (!streaming) {
    attr->id = ret;
}

/*
 * If a pointer to the ID was provided, set it.
 */
if (id != NULL) {
    *id = ret;
}

return(0);