static int
xmlAddIDSafe(xmlDocPtr doc, const xmlChar *identifier, xmlAttrPtr attr,
             int streaming, xmlIDPtr *id) {
    xmlIDPtr ret;
    xmlIDTablePtr table;

    if (id!= NULL)
        *id = NULL;

    if (doc == NULL) {
	return(-1);
    }
    if ((identifier == NULL) || (identifier[0] == 0)) {
	return(0);
    }
    if (attr == NULL) {
	return(-1);
    }

    /*
     * Create the ID table if needed.
     */
    table = (xmlIDTablePtr) doc->ids;
    if (table == NULL)  {
        doc->ids = table = xmlHashCreateDict(0, doc->dict);
        if (table == NULL)
            return(-1);
    } else {
        ret = xmlHashLookup(table, identifier);
        if (ret!= NULL) {
            /*
             * Update the attribute to make entities work.
             */
            if (ret->attr!= NULL) {
                ret->attr->id = NULL;
                ret->attr = attr;
            }
	    attr->atype = XML_ATTRIBUTE_ID;
            attr->id = ret;
            return(0);
        }
    }

    ret = (xmlIDPtr) xmlMalloc(sizeof(xmlID));
    if (ret == NULL)
	return(-1);
    memset(ret, 0, sizeof(*ret));

    /*
     * fill the structure.
     */
    ret->doc = doc;
    ret->value = xmlStrdup(identifier);
    if (ret->value == NULL) {
        xmlFreeID(ret);
        return(-1);
    }
    // Check if the function is operating in streaming mode. If it is, handle the case
    // where the attribute is temporary and will disappear, by setting the ID's name
    // based on the document's dictionary or duplicating the attribute's name.
    // If not in streaming mode, associate the attribute with the ID.
    // Record the line number from the attribute's parent element.
    // Add the new ID to the document's ID table. If adding the entry fails, free the ID
    // and return an error. Set the attribute type to ID, and associate the attribute
    // with the ID if not in streaming mode. If an ID pointer is provided as an argument,
    // assign the newly created ID to it. Return success.
    if (streaming) {
        // Operating in streaming mode, attr is gonna disappear
        ret->name = xmlStrdup(attr->name);
        if (ret->name == NULL) {
            xmlFreeID(ret);
            return(-1);
        }
        ret->attr = NULL;
    } else {
        ret->name = NULL;
        ret->attr = attr;
    }
    ret->lineno = xmlGetLineNo(attr->parent);

    /* To add a reference :-
     * References are maintained as a list of references,
     * Lookup the entry, if no entry create new nodelist
     * Add the owning node to the NodeList
     * Return the ref
     */

    if (NULL == (ref_list = xmlHashLookup(table, value))) {
        int res;

        if (NULL == (ref_list = xmlListCreate(xmlFreeRef, xmlDummyCompare)))
	    goto failed;
        res = xmlHashAdd(table, value, ref_list);
        if (res <= 0) {
            xmlListDelete(ref_list);
	    goto failed;
        }
    }
    if (xmlListAppend(ref_list, ret)!= 0)
        goto failed;
    return(ret);

failed:
    xmlVErrMemory(ctxt);
    if (ret!= NULL) {
        if (ret->value!= NULL)
	    xmlFree((char *)ret->value);
        if (ret->name!= NULL)
	    xmlFree((char *)ret->name);
        xmlFree(ret);
    }
    return(NULL);
}