static void pe_parse_debug_directory(
    PE* pe)
{
  PIMAGE_DATA_DIRECTORY data_dir;
  PIMAGE_DEBUG_DIRECTORY debug_dir;
  int64_t debug_dir_offset;
  int64_t pcv_hdr_offset;
  int i, dcount;
  size_t pdb_path_len;
  char* pdb_path = NULL;
  
  data_dir = pe_get_directory_entry(
      pe, IMAGE_DIRECTORY_ENTRY_DEBUG);

  if (data_dir == NULL)
    return;

  if (yr_le32toh(data_dir->Size) == 0)
    return;

  if (yr_le32toh(data_dir->Size) % sizeof(IMAGE_DEBUG_DIRECTORY)!= 0)
    return;

  if (yr_le32toh(data_dir->VirtualAddress) == 0)
    return;

  debug_dir_offset = pe_rva_to_offset(
      pe, yr_le32toh(data_dir->VirtualAddress));

  if (debug_dir_offset < 0)
    return;

  dcount = yr_le32toh(data_dir->Size) / sizeof(IMAGE_DEBUG_DIRECTORY);

  for (i = 0; i < dcount; i++)
  {
    debug_dir = (PIMAGE_DEBUG_DIRECTORY) \
        (pe->data + debug_dir_offset + i * sizeof(IMAGE_DEBUG_DIRECTORY));
    
    if (!struct_fits_in_pe(pe, debug_dir, IMAGE_DEBUG_DIRECTORY))
      break;
  
    if (yr_le32toh(debug_dir->Type)!= IMAGE_DEBUG_TYPE_CODEVIEW)
      continue;
    
    if (yr_le32toh(debug_dir->AddressOfRawData) == 0)
      continue;
    
    pcv_hdr_offset = pe_rva_to_offset(
        pe, yr_le32toh(debug_dir->AddressOfRawData));

    if (pcv_hdr_offset < 0)
      continue;

    PCV_HEADER codeview_header = (PCV_HEADER) (pe->data + pcv_hdr_offset);

    // Determine the type of CodeView debug information by checking the signature.
    // Depending on the signature, cast the header to the appropriate PDB structure.
    // Extract the PDB file name from the structure if it fits within the PE bounds.
    // Compute the length of the PDB path and ensure it's within valid limits.
    // If a valid PDB path is found, store the path in the object associated with the PE.
    // Stop further processing after successfully storing a valid PDB path.
    if (codeview_header->Signature == 0x53444643) // 'CDb'
    {
      PDB_HEADER pdb_header = (PDB_HEADER) codeview_header;

      if (pdb_header->Length < sizeof(PDB_HEADER) ||
          pdb_header->Length > pe->data_size - pcv_hdr_offset)
        continue;

      if (!struct_fits_in_pe(pe, pdb_header, PDB_HEADER))
        continue;

      pdb_path_len = yr_min(
          pdb_header->Length - sizeof(PDB_HEADER),
          MAX_PDB_PATH_LENGTH);

      pdb_path = (char*) yr_malloc(pdb_path_len + 1);

      if (pdb_path == NULL)
        continue;

      memcpy(pdb_path, (char*) (codeview_header + 1), pdb_path_len);
      pdb_path[pdb_path_len] = '\0';

      set_string(pdb_path, pe->object, "pdb_path");

      yr_free(pdb_path);
    }
    else if (codeview_header->Signature == 0x53444644) // 'CdB'
    {
      PDB2_HEADER pdb_header = (PDB2_HEADER) codeview_header;

      if (pdb_header->Length < sizeof(PDB2_HEADER) ||
          pdb_header->Length > pe->data_size - pcv_hdr_offset)
        continue;

      if (!struct_fits_in_pe(pe, pdb_header, PDB2_HEADER))
        continue;

      pdb_path_len = yr_min(
          pdb_header->Length - sizeof(PDB2_HEADER),
          MAX_PDB_PATH_LENGTH);

      pdb_path = (char*) yr_malloc(pdb_path_len + 1);

      if (pdb_path == NULL)
        continue;

      memcpy(pdb_path, (char*) (codeview_header + 1), pdb_path_len);
      pdb_path[pdb_path_len] = '\0';

      set_string(pdb_path, pe->object, "pdb_path");

      yr_free(pdb_path);
    }
    else if (codeview_header->Signature == 0x53444645) // 'CdDb'
    {
      PDB3_HEADER pdb_header = (PDB3_HEADER) codeview_header;

      if (pdb_header->Length < sizeof(PDB3_HEADER) ||
          pdb_header->Length > pe->data_size - pcv_hdr_offset)
        continue;

      if (!struct_fits_in_pe(pe, pdb_header, PDB3_HEADER))
        continue;

      pdb_path_len = yr_min(
          pdb_header->Length - sizeof(PDB3_HEADER),
          MAX_PDB_PATH_LENGTH);

      pdb_path = (char*) yr_malloc(pdb_path_len + 1);

      if (pdb_path == NULL)
        continue;

      memcpy(pdb_path, (char*) (codeview_header + 1), pdb_path_len);
      pdb_path[pdb_path_len] = '\0';

      set_string(pdb_path, pe->object, "pdb_path");

      yr_free(pdb_path);
    }
  }
}