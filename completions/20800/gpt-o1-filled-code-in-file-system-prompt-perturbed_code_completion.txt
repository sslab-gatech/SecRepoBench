#if !defined(CVINFO_PDB20)
#define CVINFO_PDB20 0x3031424E  // "NB10"
#endif
#if !defined(CVINFO_PDB70)
#define CVINFO_PDB70 0x53445352  // "RSDS"
#endif

// Make sure the signature field fits in the PE buffer before reading it.
if (struct_fits_in_pe(pe, codeview_header, sizeof(DWORD)))
{
  DWORD cv_signature = yr_le32toh(codeview_header->dwSig);

  // Handle NB10 (PDB 2.0) and RSDS (PDB 7.0) CodeView signatures.
  switch (cv_signature)
  {
    case CVINFO_PDB20:
    {
      PCV_INFO_PDB20 cv_info = (PCV_INFO_PDB20) codeview_header;
      // Verify the entire CV_INFO_PDB20 structure fits, up to the first byte of PdbFileName.
      if (struct_fits_in_pe(pe, cv_info, sizeof(CV_INFO_PDB20)))
      {
        // Calculate how many bytes remain for the path string.
        size_t remaining = pe->data_size - (pcv_hdr_offset + sizeof(CV_INFO_PDB20) - 1);
        // Ensure there's space for at least one character.
        if (remaining > 0)
        {
          pdb_path_len = strnlen((char*) cv_info->PdbFileName, remaining);
          // If there's a valid PDB filename, store it.
          if (pdb_path_len > 0 && pdb_path_len < remaining)
          {
            pdb_path = (char*) yr_malloc(pdb_path_len + 1);
            if (pdb_path != NULL)
            {
              memcpy(pdb_path, cv_info->PdbFileName, pdb_path_len);
              pdb_path[pdb_path_len] = '\0';
              set_string(pdb_path, pe->object, "pdb_path");
              yr_free(pdb_path);
              // Stop after storing a valid path
              break;
            }
          }
        }
      }
      break;
    }

    case CVINFO_PDB70:
    {
      PCV_INFO_PDB70 cv_info = (PCV_INFO_PDB70) codeview_header;
      // Verify the entire CV_INFO_PDB70 structure fits, up to the first byte of PdbFileName.
      if (struct_fits_in_pe(pe, cv_info, sizeof(CV_INFO_PDB70)))
      {
        size_t remaining = pe->data_size - (pcv_hdr_offset + sizeof(CV_INFO_PDB70) - 1);
        if (remaining > 0)
        {
          pdb_path_len = strnlen((char*) cv_info->PdbFileName, remaining);
          if (pdb_path_len > 0 && pdb_path_len < remaining)
          {
            pdb_path = (char*) yr_malloc(pdb_path_len + 1);
            if (pdb_path != NULL)
            {
              memcpy(pdb_path, cv_info->PdbFileName, pdb_path_len);
              pdb_path[pdb_path_len] = '\0';
              set_string(pdb_path, pe->object, "pdb_path");
              yr_free(pdb_path);
              break;
            }
          }
        }
      }
      break;
    }

    default:
      // Other CodeView signatures are not currently parsed for PDB path.
      break;
  }
}