{
  double
    value;

  FxInfo
    *fx_info;

  MagickStatusType
    status;

  PixelInfo
    pixel;

  /* Ensure an image is available */
  if (image == (Image *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
        "NoImageForProperty","\"%%[%s]\"",lookup_pattern);
      continue;
    }

  /* Initialize pixel info and parse expression after "hex:" */
  GetPixelInfo(image,&pixel);
  fx_info=AcquireFxInfo(image,lookup_pattern+4,exception);

  /* Evaluate each channel expression and scale result into pixel */
  status=FxEvaluateChannelExpression(fx_info,RedPixelChannel,0,0,&value,exception);
  pixel.red=(double) QuantumRange*value;
  status&=FxEvaluateChannelExpression(fx_info,GreenPixelChannel,0,0,&value,exception);
  pixel.green=(double) QuantumRange*value;
  status&=FxEvaluateChannelExpression(fx_info,BluePixelChannel,0,0,&value,exception);
  pixel.blue=(double) QuantumRange*value;
  /* If CMYK, evaluate black channel too */
  if (image->colorspace == CMYKColorspace)
    {
      status&=FxEvaluateChannelExpression(fx_info,BlackPixelChannel,0,0,&value,exception);
      pixel.black=(double) QuantumRange*value;
    }
  /* Evaluate alpha channel */
  status&=FxEvaluateChannelExpression(fx_info,AlphaPixelChannel,0,0,&value,exception);
  pixel.alpha=(double) QuantumRange*value;

  fx_info=DestroyFxInfo(fx_info);
  if (status != MagickFalse)
    {
      char
        hex[MagickPathExtent];

      /* Format the result as a hex string.
         If alpha is effectively opaque, omit it (standard #RRGGBB).
         Otherwise, include it (#RRGGBBAA).
      */
      if (ClampToQuantum(pixel.alpha) < (QuantumRange - 0.5))
        (void) FormatLocaleString(hex,MagickPathExtent,"#%02X%02X%02X%02X",
          ScaleQuantumToChar(ClampToQuantum(pixel.red)),
          ScaleQuantumToChar(ClampToQuantum(pixel.green)),
          ScaleQuantumToChar(ClampToQuantum(pixel.blue)),
          ScaleQuantumToChar(ClampToQuantum(pixel.alpha)));
      else
        (void) FormatLocaleString(hex,MagickPathExtent,"#%02X%02X%02X",
          ScaleQuantumToChar(ClampToQuantum(pixel.red)),
          ScaleQuantumToChar(ClampToQuantum(pixel.green)),
          ScaleQuantumToChar(ClampToQuantum(pixel.blue)));

      /* Append to the result text */
      AppendString2Text(hex);
    }
  continue;
}