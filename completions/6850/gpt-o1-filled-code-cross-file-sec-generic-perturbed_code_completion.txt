{
  double
    value;

  FxInfo
    *fx_info;

  MagickStatusType
    status;

  PixelInfo
    pixel;

  /*
    HEX - color value calculator in hex notation (#RRGGBB or #RRGGBBAA).
  */
  if (image == (Image *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),
        OptionWarning,"NoImageForProperty","\"%%[%s]\"",lookup_pattern);
      continue;
    }
  GetPixelInfo(image,&pixel);
  fx_info=AcquireFxInfo(image,lookup_pattern+4,exception);
  status=FxEvaluateChannelExpression(fx_info,RedPixelChannel,0,0,
    &value,exception);
  pixel.red=(double) QuantumRange*value;
  status&=FxEvaluateChannelExpression(fx_info,GreenPixelChannel,0,0,
    &value,exception);
  pixel.green=(double) QuantumRange*value;
  status&=FxEvaluateChannelExpression(fx_info,BluePixelChannel,0,0,
    &value,exception);
  pixel.blue=(double) QuantumRange*value;
  if (image->colorspace == CMYKColorspace)
    {
      status&=FxEvaluateChannelExpression(fx_info,BlackPixelChannel,0,0,
        &value,exception);
      pixel.black=(double) QuantumRange*value;
    }
  status&=FxEvaluateChannelExpression(fx_info,AlphaPixelChannel,0,0,
    &value,exception);
  pixel.alpha=(double) QuantumRange*value;
  fx_info=DestroyFxInfo(fx_info);
  if (status != MagickFalse)
    {
      char
        hex_color[MagickPathExtent];

      Quantum
        red=(Quantum) ClampToQuantum(pixel.red),
        green=(Quantum) ClampToQuantum(pixel.green),
        blue=(Quantum) ClampToQuantum(pixel.blue),
        alpha=(Quantum) ClampToQuantum(pixel.alpha);

      /*
        If alpha is fully opaque, omit it; otherwise include alpha channel.
      */
      if (alpha != (Quantum) QuantumRange)
        (void) FormatLocaleString(hex_color,MagickPathExtent,"#%02X%02X%02X%02X",
          ScaleQuantumTo8(red),ScaleQuantumTo8(green),
          ScaleQuantumTo8(blue),ScaleQuantumTo8(alpha));
      else
        (void) FormatLocaleString(hex_color,MagickPathExtent,"#%02X%02X%02X",
          ScaleQuantumTo8(red),ScaleQuantumTo8(green),
          ScaleQuantumTo8(blue));
      AppendString2Text(hex_color);
    }
  continue;
}