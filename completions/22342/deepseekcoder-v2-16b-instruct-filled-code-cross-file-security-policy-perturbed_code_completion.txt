u_int32_t payload_packet_len = packet->payload_packet_len;
  u_int8_t *payload = packet->payload;

  if (payload_packet_len >= 3 && payload[0] == 0x03 && payload[1] == 0x00 && payload[2] == 0x00) {
    // This is a TPKT packet
    u_int16_t tpkt_length = ntohs(*(u_int16_t *)(payload + 2));
    if (payload_packet_len >= 4 + tpkt_length && tpkt_length > 0) {
      // Check if the TPKT payload is valid
      u_int8_t *tpkt_payload = payload + 4;
      if (tpkt_payload[0] == 0x01 && tpkt_payload[1] == 0x00) {
        // This is likely H.323
        NDPI_LOG_INFO(ndpi_struct, "Detected H.323 protocol\n");
        stream->detected_protocol = NDPI_PROTOCOL_H323;
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN, NULL, 0);
        return;
      }
    }
  }

  if (packet->udp != NULL) {
    sport = ntohs(packet->udp->source);
    dport = ntohs(packet->udp->dest);

    if ((sport == 102 || dport == 102) && payload_packet_len >= 3) {
      if (payload[0] == 0x01 && payload[1] == 0x00 && payload[2] == 0x00) {
        // This is a TPKT packet on UDP
        u_int16_t tpkt_length = ntohs(*(u_int16_t *)(payload + 2));
        if (payload_packet_len >= 4 + tpkt_length && tpkt_length > 0) {
          // Check if the TPKT payload is valid
          u_int8_t *tpkt_payload = payload + 4;
          if (tpkt_payload[0] == 0x01 && tpkt_payload[1] == 0x00) {
            // This is likely H.323
            NDPI_LOG_INFO(ndpi_struct, "Detected H.323 protocol\n");
            stream->detected_protocol = NDPI_PROTOCOL_H323;
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN, NULL, 0);
            return;
          }
        }
      }
    }
  }

  // Exclude non-H.323 protocols from detection if conditions are not satisfied.