if(packet->tcp != NULL) {
    /* Validate that the payload is large enough for a TPKT header */
    if(packet->payload_packet_len < 4)
      return;

    /* Check that the TPKT version is 3 (the expected value) */
    if(packet->payload[0] != 3)
      return;

    /* Extract the TPKT length from bytes 2–3 and verify against the packet’s payload length */
    u_int16_t tpkt_length = ntohs(*(u_int16_t *)(packet->payload + 2));
    if(tpkt_length != packet->payload_packet_len)
      return;

    /* Inspect a payload byte (e.g. the 5th byte) to help distinguish H.323 from similar protocols like RDP */
    if(packet->payload_packet_len > 4 && packet->payload[4] == 0x0C) {
        NDPI_LOG_DBG(ndpi_struct, "H.323 TCP packet detected\n");
        ndpi_struct->detected_protocol = NDPI_PROTOCOL_H323;
        ndpi_struct->protocol_counters.h323++;
        /* Example criterion for broadcast detection: check if TCP destination port matches a known H.323 broadcast port */
        if(packet->tcp->dest == ntohs(1719))
            ndpi_struct->protocol_counters.h323_broadcast++;
    }
} else if(packet->udp != NULL) {
    sport = ntohs(packet->udp->source);
    dport = ntohs(packet->udp->dest);

    /* Ensure that there is enough UDP payload to examine the signature */
    if(packet->payload_packet_len < 8)
        return;

    /* Check for a characteristic H.323 pattern in the UDP payload.
       Here we assume the first two bytes (for example, 0x01, 0x02) indicate H.323. */
    if(packet->payload[0] == 0x01 && packet->payload[1] == 0x02) {
        NDPI_LOG_DBG(ndpi_struct, "H.323 UDP packet detected\n");
        ndpi_struct->detected_protocol = NDPI_PROTOCOL_H323;
        ndpi_struct->protocol_counters.h323++;
        /* Identify broadcast packets by checking if the destination port corresponds to a known broadcast port */
        if(dport == 1719)
            ndpi_struct->protocol_counters.h323_broadcast++;
    }
}