if(packet->tcp != NULL) {
    /* Ensure there is enough data for the TPKT header (4 bytes) */
    if(packet->payload_packet_len < 4)
        return;

    /* Verify that the TPKT version is 3 */
    if(packet->payload[0] != 3)
        return;

    /* Safely extract the total length from the TPKT header */
    u_int16_t tpkt_length = ((u_int16_t)packet->payload[2] << 8) | packet->payload[3];
    if(tpkt_length < 4 || tpkt_length > packet->payload_packet_len)
        return;

    /* Check for an H.323 broadcast indication.
       This example assumes that a specific payload pattern (bytes 4 and 5) identifies an H.323 broadcast.
       Adjust the pattern as required by your protocol specification. */
    if(tpkt_length >= 6 && packet->payload[4] == 0x08 && packet->payload[5] == 0x00) {
        NDPI_LOG_DBG(ndpi_struct, "H.323 broadcast detected (TCP)\n");
        stream->h323_flags |= NDPI_H323_BROADCAST;
    }

    /* Mark this stream as H.323 */
    stream->detected_protocol = NDPI_PROTOCOL_H323;
    ndpi_struct->num_h323_packets++;
}
else if(packet->udp != NULL) {
    /* Safely retrieve UDP source and destination ports */
    sport = ntohs(packet->udp->source);
    dport = ntohs(packet->udp->dest);

    /* Ensure there is a minimal payload to examine the UDP H.323 structure */
    if(packet->payload_packet_len < 4)
        return;

    /* Check a specific payload pattern to detect H.323 over UDP.
       In this example, a pattern of 0x01, 0x02 at the beginning is used.
       Adjust the pattern as required by your protocol specification. */
    if(packet->payload[0] == 0x01 && packet->payload[1] == 0x02) {
        NDPI_LOG_DBG(ndpi_struct, "H.323 broadcast detected (UDP)\n");
        stream->h323_flags |= NDPI_H323_BROADCAST;
    }

    /* Mark this stream as H.323 */
    stream->detected_protocol = NDPI_PROTOCOL_H323;
    ndpi_struct->num_h323_packets++;
}