{
    const u_int8_t *payload = packet->payload;
    u_int32_t payload_len = packet->payload_len;

    if (payload_len < sizeof(struct tpkt))
      return;

    struct tpkt *tpkt_p = (struct tpkt *)payload;

    if (payload_len != ntohs(tpkt_p->len))
      return;

    /* Check for RAS or H225 message inside */
    if (payload[sizeof(struct tpkt)] == 0x08 || /* H.225 RAS */
        payload[sizeof(struct tpkt)] == 0x28 || /* H.245 */
        payload[sizeof(struct tpkt)] == 0x04 || /* Q931 */
        payload[sizeof(struct tpkt)] == 0x20 || /* H.235 Media */
        payload[sizeof(struct tpkt)] == 0x24 || /* H.235 Control */
        payload[sizeof(struct tpkt)] == 0x05)
    { /* H.248 */
      NDPI_LOG_DBG(ndpi_struct, "found H323\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
      return;
    }

    /*
     * Some buggy H323 implementation use UDP and don't use TPKT.
     * So we check for Q931 message type inside.
     */
    if (packet->udp != NULL) {
      sport = ntohs(packet->udp->source), dport = ntohs(packet->udp->dest);

      if (payload_len > 4 &&
          (payload[0] == 0x08 && payload[1] == 0x11 && payload[2] == 0x00 && payload[3] == 0x01)) {
        NDPI_LOG_DBG(ndpi_struct, "found H323 broadcast\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
        return;
      }

      if (payload_len > 4 &&
          (payload[0] == 0x04 && payload[1] == 0x11 && payload[2] == 0x00 && payload[3] == 0x01)) {
        NDPI_LOG_DBG(ndpi_struct, "found H323 broadcast\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
        return;
      }

      if (payload_len > 4 &&
          (payload[0] == 0x84 && payload[1] == 0x11 && payload[2] == 0x00 && payload[3] == 0x01)) {
        NDPI_LOG_DBG(ndpi_struct, "found H323 broadcast\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }

    /* Avoid false detection of other protocols such as RDP */
    if (payload[sizeof(struct tpkt)] == 0x3 &&
        packet->payload_len > 12 &&
        (packet->payload[11] == 0x03 || packet->payload[11] == 0x01))
      return;
  }