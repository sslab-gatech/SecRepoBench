{
    if(packet->payload_packet_len >= 4) {
      u_int16_t tpkt_len = ntohs(get_u_int16_t(packet->payload, 2));

      if(tpkt_len == packet->payload_packet_len) {
        if((packet->payload[0] == 0x03) && (packet->payload[1] == 0) &&
           (packet->payload[4] == 0x08) && (packet->payload[5] == 0x02)) {
          NDPI_LOG_INFO(ndpi_struct, "Found H323\n");
          ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
          stream->h323_valid_packets++;

          if(packet->iph != NULL) {
            if((ntohl(packet->iph->daddr) & 0xF0000000) == 0xE0000000)
              ndpi_set_risk(ndpi_struct, stream, NDPI_H323_BROADCAST);
          }
          return;
        } else if((tpkt_len > 4) &&
                  (packet->payload[4] != 0x03) && (packet->payload[4] != 0x08)) {
          NDPI_LOG_DBG(ndpi_struct, "Excluding RDP connection\n");
          NDPI_ADD_PROTOCOL_TO_BITMASK(stream->excluded_protocol_bitmask, NDPI_PROTOCOL_H323);
          return;
        }
      }
    }
  }

  if(packet->udp != NULL) {
    sport = ntohs(packet->udp->source), dport = ntohs(packet->udp->dest);

    if(((sport == 1718) || (dport == 1718) || (sport == 1719) || (dport == 1719)) &&
       (packet->payload_packet_len >= 5)) {
      if((packet->payload[0] == 0x16) && (packet->payload[1] == 0x80) &&
         (packet->payload[4] == 0x06) && (packet->payload[5] == 0x00)) {
        NDPI_LOG_INFO(ndpi_struct, "Found H323 (LRQ)\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
        stream->h323_valid_packets++;

        if((ntohl(packet->iph->daddr) & 0xF0000000) == 0xE0000000)
          ndpi_set_risk(ndpi_struct, stream, NDPI_H323_BROADCAST);
        return;
      }
    }
  }

  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);