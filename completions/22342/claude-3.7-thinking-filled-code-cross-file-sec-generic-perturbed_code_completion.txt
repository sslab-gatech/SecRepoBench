if(packet->payload_packet_len >= 4) {
      if(packet->payload[0] == 0x03) { /* TPKT version 3 */
        u_int16_t len = ntohs(*((u_int16_t*)&packet->payload[2]));
        
        /* Check if the TPKT length matches the packet length */
        if(len == packet->payload_packet_len) {
          /* Distinguish H.323 from RDP */
          if(packet->payload_packet_len > 10 && 
             packet->payload[4] != 0x00 && 
             packet->payload[5] != 0x00) {
            
            stream->h323_valid_packets++;
            
            if(packet->tcp->dest == htons(1720) || packet->tcp->source == htons(1720)) {
              NDPI_LOG_INFO(ndpi_struct, "Found H.323 Call Signaling\n");
            }

            ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
            return;
          }
        }
      }
    }
    /* Check for UDP-based H.323 */
    else if(packet->udp) {
      sport = ntohs(packet->udp->source);
      dport = ntohs(packet->udp->dest);

      /* Check for H.323 RAS on standard port 1719 */
      if((sport == 1719 || dport == 1719) && packet->payload_packet_len >= 6) {
        if(packet->payload[0] >= 0x00 && packet->payload[0] <= 0x04) { /* RAS message type range */
          NDPI_LOG_INFO(ndpi_struct, "Found H.323 RAS\n");
          ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
          return;
        }
      }
      
      /* Check for H.323 broadcast */
      if(packet->payload_packet_len >= 7 &&
         packet->payload[0] == 0x80 && 
         packet->payload[4] == 0x06 && 
         packet->payload[5] == 0x00) {
        
        NDPI_LOG_INFO(ndpi_struct, "Found H.323 Broadcast\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }

    /* No match found, exclude from detection */
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);