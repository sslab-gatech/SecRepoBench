{
    if(packet->payload_packet_len > 4) {
      /* TPKT header: 0x03, 0x00, len_hi, len_lo */
      if(packet->payload[0] == 0x03 && packet->payload[1] == 0x00) {
        u_int16_t tpkt_len = (packet->payload[2] << 8) | packet->payload[3];
        if(tpkt_len == packet->payload_packet_len) {
          /* Check for H.323 vs RDP */
          if(packet->payload[4] == 0x02 && packet->payload[5] == 0x01) {
            /* Looks like H.323 */
            stream->h323_valid_packets++;
            if(stream->h323_valid_packets > 2) {
              NDPI_LOG_INFO(ndpi_struct, "found H323\n");
              ndpi_int_add_connection(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_REAL_PROTOCOL);
              return;
            }
          } else if(packet->payload[4] == 0x03 && packet->payload[5] == 0x00) {
            /* Looks like RDP, exclude */
            NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
            return;
          }
        }
      }
    }
  } else if(packet->udp != NULL) {
    dport = ntohs(packet->udp->dest);
    sport = ntohs(packet->udp->source);
    if(packet->payload_packet_len > 4) {
      /* H.323 broadcast detection */
      if(packet->payload[0] == 0x05 && packet->payload[1] == 0x00 &&
         packet->payload[2] == 0x0b && packet->payload[3] == 0x00) {
        NDPI_LOG_INFO(ndpi_struct, "found H323 (UDP broadcast)\n");
        ndpi_int_add_connection(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_REAL_PROTOCOL);
        return;
      }
    }
  }

  NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
  return;
}