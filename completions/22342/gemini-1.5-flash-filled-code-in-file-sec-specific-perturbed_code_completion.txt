{
    struct tpkt *tpkt_header;
    u_int32_t len;

    if (packet->payload_len < sizeof(struct tpkt))
      return;

    tpkt_header = (struct tpkt *)packet->payload;
    len = ntohs(tpkt_header->len);

    if (len > packet->payload_len)
      return;

    if (tpkt_header->version != 3)
      return;

    if (packet->udp != NULL) {
      sport = ntohs(packet->udp->source);
      dport = ntohs(packet->udp->dest);
    } else if (packet->tcp != NULL) {
      sport = ntohs(packet->tcp->source);
      dport = ntohs(packet->tcp->dest);
    }

    if (len >= 4 && packet->payload[2] == 0x00 && packet->payload[3] == 0x01) {
      stream->detected_protocol = NDPI_PROTOCOL_H323;
      stream->detected_protocol_id = NDPI_PROTOCOL_H323;
      NDPI_LOG_DBG(ndpi_struct, "H323 detected\n");
    }
  }