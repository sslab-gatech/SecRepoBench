{
  const uint8_t *payload = packet->payload;
  uint16_t payload_len   = packet->payload_packet_len;

  if(packet->tcp != NULL) {
    /* Perform initial validation for TPKT-based H.323 over TCP */
    if(payload_len >= 4 && payload[0] == 0x03) {
      uint16_t tpkt_len = (payload[2] << 8) | payload[3];

      /* Verify TPKT length */
      if(tpkt_len <= payload_len) {
        /* Distinguish H.323 packets from RDP by checking specific payload bytes */
        /* (Example check: often RDP includes certain cookie/byte patterns that we exclude here) */
        if(!(payload_len > 10 && payload[10] == 0x43)) {
          NDPI_LOG_DBG(ndpi_struct, "Detected H.323 TPKT packet\n");

          /* Increment H.323 packet count */
          stream->h323_packet_count++;

          /* Identify possible H.323 broadcast if size or payload pattern is indicative */
          if(tpkt_len > 512) {
            NDPI_LOG_DBG(ndpi_struct, "Possible H.323 broadcast detected\n");
            stream->h323_broadcast = 1;
          }

          /* Mark the flow as H.323 */
          ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323);
          return;
        }
      }
    }
  } else if(packet->udp != NULL) {
    sport = ntohs(packet->udp->source);
    dport = ntohs(packet->udp->dest);

    /* Example quick checks for H.323 over UDP */
    if(payload_len > 8) {
      /* Validate a particular pattern in the first bytes that might indicate H.323 */
      if(payload[0] == 0x08 && payload[1] == 0x00) {
        NDPI_LOG_DBG(ndpi_struct, "Detected H.323 packet over UDP\n");

        /* Increment H.323 packet count */
        stream->h323_packet_count++;

        /* Check for patterns that suggest H.323 broadcast behavior */
        if(payload_len > 1024) {
          NDPI_LOG_DBG(ndpi_struct, "Possible H.323 broadcast detected\n");
          stream->h323_broadcast = 1;
        }

        /* Mark the flow as H.323 */
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323);
        return;
      }
    }
  }

  /* If none of the criteria for H.323 is met, exclude this protocol */
  NDPI_LOG_DBG(ndpi_struct, "Not H.323, marking as unknown\n");
  NDPI_ADD_PROTOCOL_TO_BITMASK(ndpi_struct->detection_bitmask, NDPI_PROTOCOL_UNKNOWN);
}