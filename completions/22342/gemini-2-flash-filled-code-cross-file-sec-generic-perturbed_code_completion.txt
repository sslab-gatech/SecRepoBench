{
    if(packet->tcp != NULL)
    {
      u_int32_t tpkt_len;

      if(packet->payload_len < 4)
	return;

      /* TPKT */
      if((packet->payload[0] == 0x03) &&
	 (packet->payload[1] == 0x00))
      {
	tpkt_len = (packet->payload[2] << 8) | packet->payload[3];

	if(tpkt_len > packet->payload_len)
	  return;

	/*
	  H.323 uses 0x15 as first byte after TPKT header,
	  RDP uses 0x70
	*/
	if((packet->payload_len > 5) && (packet->payload[4] == 0x00))
	{
	  if(packet->payload[5] == 0x15)
	  {
	    NDPI_LOG_DBG(ndpi_struct, "found h323 over tpkt\n");
	    stream->h323.pkts_num++;

	    if((packet->payload_len >= 12) &&
	       (packet->payload[8] == 0x68) &&
	       (packet->payload[9] == 0x05) &&
	       (packet->payload[10] == 0x00) &&
	       (packet->payload[11] == 0x07))
	    {
	      NDPI_LOG_DBG(ndpi_struct, "found h323 broadcast\n");
	      stream->h323.broadcast = 1;
	    }

	    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
	    return;
	  }
	}
      }
    } else if(packet->udp != NULL) {
      sport = ntohs(packet->udp->source);
      dport = ntohs(packet->udp->dest);

      if(packet->payload_len > 8)
      {
	/* H.323 ASN.1 preamble */
	if((packet->payload[0] == 0x30) &&
	   (packet->payload[1] > 0x80) &&
	   (packet->payload[2] == 0xa0) &&
	   (packet->payload[3] > 0x80))
	{
	  NDPI_LOG_DBG(ndpi_struct, "found h323 over udp\n");
	  ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
	  return;
	}
	/* H.323 broadcast */
	else if((packet->payload_len == 598) &&
		(packet->payload[0] == 0x00) &&
		(packet->payload[1] == 0x00) &&
		(packet->payload[2] == 0x05) &&
		(packet->payload[3] == 0x01) &&
		(packet->payload[4] == 0x00) &&
		(packet->payload[5] == 0x0b) &&
		(packet->payload[6] == 0x68) &&
		(packet->payload[7] == 0x00))
	{
	  NDPI_LOG_DBG(ndpi_struct, "found h323 broadcast\n");
	  ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
	  return;
	}
      }
    }

    NDPI_LOG_DBG(ndpi_struct, "exclude h323\n");
    NDPI_ADD_PROTOCOL_TO_BITMASK(stream->exclude_protocol_bitmask, NDPI_PROTOCOL_H323);
  }