// <MASK>
{
  // Check if the packet is using TCP and perform initial validation of the payload
  if (packet->tcp != NULL) {
    u_int16_t tpkt_len = ntohs(packet->tcp->th_doff * 4);
    if (tpkt_len >= 4 && packet->payload[0] == 0x03 && packet->payload[1] == 0x00) {
      // Determine the length of the TPKT protocol and verify if it matches the expected length
      u_int16_t h323_len = (packet->payload[2] << 8) + packet->payload[3];
      if (h323_len == tpkt_len - 4) {
        // Inspect specific payload byte values to distinguish between H.323 and RDP protocols
        if (packet->payload[4] == 0x05 && packet->payload[5] == 0x00 && packet->payload[6] == 0x03 && packet->payload[7] == 0x00) {
          // Increment the count of valid H.323 packets and identify H.323 broadcast if conditions are met
          stream->detected_protocol = NDPI_PROTOCOL_H323;
          if (packet->payload[8] == 0x80 && packet->payload[9] == 0x04) {
            stream->l4.tcp.h323_call_type = NDPI_H323_BROADCAST;
          }
        }
      }
    }
  } else if (packet->udp != NULL) {
    // For UDP packets, compute source and destination ports and validate the payload structure
    dport = ntohs(packet->udp->dest);
    sport = ntohs(packet->udp->source);
    if ((dport == 1718 || dport == 1719 || dport == 1720 || sport == 1718 || sport == 1719 || sport == 1720) &&
        packet->payload_packet_len >= 12 && packet->payload[0] == 0x00 && packet->payload[1] == 0x00 && packet->payload[2] == 0x00 && packet->payload[3] == 0x00) {
      // Identify H.323 broadcasts by checking specific byte patterns and packet length
      if (packet->payload_packet_len == 12 && packet->payload[4] == 0x80 && packet->payload[5] == 0x04) {
        stream->detected_protocol = NDPI_PROTOCOL_H323;
        stream->l4.tcp.h323_call_type = NDPI_H323_BROADCAST;
      } else {
        // Exclude non-H.323 protocols from detection if conditions are not satisfied
        NDPI_ADD_PROTOCOL_TO_BITMASK(stream->excluded_protocol_bitmask, NDPI_PROTOCOL_H323);
      }
    }
  }
}