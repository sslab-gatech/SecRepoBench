// Check if the packet is using TCP and perform initial validation of the payload.
if ((packet->tcp!= NULL) && (packet->tcp->dest!= ntohs(102))) {
  // Determine the length of the TPKT protocol and verify if it matches the expected length.
  u_int16_t tpkt_len = ntohs(packet->tcp->th->doff) * 4;
  if (tpkt_len >= 4) {
    // Inspect specific payload byte values to distinguish between H.323 and RDP protocols.
    u_char *payload = packet->payload;
    if (payload[0] == 0x00 && payload[1] == 0x01 && payload[2] == 0x00 && payload[3] == 0x01) {
      // H.323 protocol detected
      ndpi_struct->detection_bitmask |= NDPI_PROTOCOL_H323;
      if (packet->ip->src.s_addr == INADDR_BROADCAST) {
        // H.323 broadcast detected
        ndpi_struct->detection_bitmask |= NDPI_PROTOCOL_H323_BROADCAST;
      }
    } else {
      // RDP protocol detected
      ndpi_struct->detection_bitmask |= NDPI_PROTOCOL_RDP;
    }
  } else {
    // Invalid TPKT protocol length
    return;
  }
} else if ((packet->udp!= NULL) && (packet->udp->dest!= ntohs(102))) {
  // For UDP packets, compute source and destination ports and validate the payload structure.
  dport = ntohs(packet->udp->dest);
  sport = ntohs(packet->udp->src);
  // Identify H.323 broadcasts by checking specific byte patterns and packet length.
  if (dport == 1720 && sport == 1720) {
    // H.323 broadcast detected
    ndpi_struct->detection_bitmask |= NDPI_PROTOCOL_H323_BROADCAST;
  }
  // Exclude non-H.323 protocols from detection if conditions are not satisfied.
  // For example, if the packet contains the string "RDP" in the payload, it's likely RDP and not H.323.
  if (strstr((char *)packet->payload, "RDP")!= NULL) {
    return;
  }
}