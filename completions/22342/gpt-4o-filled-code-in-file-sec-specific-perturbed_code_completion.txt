{
    const u_int8_t *payload = packet->payload;
    u_int16_t payload_len = packet->payload_packet_len;

    if (payload_len < sizeof(struct tpkt)) {
      NDPI_LOG_DBG(ndpi_struct, "Payload too short for TPKT\n");
      return;
    }

    struct tpkt *tpkt_header = (struct tpkt *)payload;
    u_int16_t tpkt_len = ntohs(tpkt_header->len);

    if (tpkt_header->version != 3 || tpkt_len < 4 || tpkt_len > payload_len) {
      NDPI_LOG_DBG(ndpi_struct, "Invalid TPKT header\n");
      return;
    }

    if (payload[4] == 0x08 && payload[5] == 0x02) {
      NDPI_LOG_DBG(ndpi_struct, "Detected H.323 packet\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323);
    } else {
      NDPI_LOG_DBG(ndpi_struct, "Not an H.323 packet\n");
    }
  }