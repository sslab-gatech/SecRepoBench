{
    u_int16_t len;
    u_int8_t *payload = packet->payload;
    u_int16_t payload_len = packet->payload_packet_len;

    if(payload_len < 4) return; // Not enough data for TPKT header

    // Check for TPKT version and reserved fields
    if(payload[0] != 0x03 || payload[1] != 0x00) return;

    // Extract TPKT length
    len = (payload[2] << 8) + payload[3];

    // Validate TPKT length
    if(len != payload_len) return;

    // Check for H.225.0 CS message (Q.931)
    if(payload_len >= 9 && payload[4] == 0x08 && payload[5] == 0x02) {
      NDPI_LOG_INFO(ndpi_struct, "found H.323\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323);
      return;
    }

    // Check for H.245 message
    if(payload_len >= 10 && payload[4] == 0x02 && payload[5] == 0x01 && payload[6] == 0x00) {
      NDPI_LOG_INFO(ndpi_struct, "found H.323\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323);
      return;
    }
  }