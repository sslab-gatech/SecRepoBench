{
    /* For TCP packets - continue after the initial port 102 check */
    if(packet->tcp != NULL) {
      /* Check for valid TPKT header (used by H.323) */
      if(packet->payload_packet_len >= 4 && 
         packet->payload[0] == 0x03 && /* TPKT version */
         packet->payload[1] == 0x00) { /* Reserved byte */
        
        /* Calculate expected TPKT length */
        u_int16_t tpkt_len = ntohs(*((u_int16_t *)(packet->payload + 2)));
        
        /* Check if length matches */
        if(tpkt_len == packet->payload_packet_len) {
          /* Distinguish H.323 from RDP (which also uses TPKT) */
          if(packet->payload_packet_len > 5) {
            /* H.225 Call Signaling typically has 0x08 in the 5th byte */
            if(packet->payload[4] == 0x08) {
              ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
              return;
            }
          }
        }
      }
    } 
    /* For UDP packets */
    else if(packet->udp != NULL) {
      /* Get UDP port numbers */
      sport = ntohs(packet->udp->source);
      dport = ntohs(packet->udp->dest);
      
      /* H.323 related ports */
      if(((sport == 1718) || (sport == 1719) || (sport == 1720) || 
          (dport == 1718) || (dport == 1719) || (dport == 1720)) &&
         packet->payload_packet_len >= 8) {
        
        /* Check for H.323 RAS messages pattern */
        if(packet->payload[0] == 0x80 && 
           packet->payload[1] == 0x08 && 
           packet->payload[2] == 0xe7) {
          
          /* H.323 broadcast detection */
          if(packet->payload[4] == 0x00) {
            ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_H323, NDPI_PROTOCOL_UNKNOWN);
            return;
          }
        }
      }
    }
    
    /* Exclude H.323 if not detected by now */
    NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
}