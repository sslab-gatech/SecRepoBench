hb_buffer_t *buf = hb_serialize_context_get_buffer (c);
unsigned int region_count = src->get_region_count ();
unsigned int axis_count = src->get_axis_count ();
unsigned int i;

if (!hb_buffer_allocation_successful (buf, region_count * sizeof (VarRegion)))
  return false;

VarRegionList *dest = (VarRegionList *) hb_buffer_get_content (buf);
dest->set_region_count (region_count);
dest->set_axis_count (axis_count);

for (i = 0; i < region_count; i++) {
  unsigned int mapped_region_index = regionmapping.get_forward (i);
  if (mapped_region_index >= region_count)
    return false; // Invalid region index

  VarRegion *src_region = src->get_region (i);
  VarRegion *dest_region = dest->get_region (mapped_region_index);

  if (!src_region->serialize (c, dest_region, regionmapping))
    return false;
}

return true;