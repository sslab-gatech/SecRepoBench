bool VariationDevice::serialize (hb_serialize_context_t *c,
                                 const VariationDevice *src,
                                 const hb_bimap_t &region_mapping,
                                 const hb_inc_bimap_t &inner_mapping)
{
  TRACE_SERIALIZE (this);
  if (unlikely (!c->extend_min (*this))) return_trace (false);

  outerIndex = src->outerIndex;
  innerIndex = src->innerIndex;
  deltaFormat = src->deltaFormat;

  if (unlikely (!regions.serialize (c, src->regions, region_mapping))) return_trace (false);

  unsigned int set_count = 0;
  for (unsigned int i = 0; i < inner_mapping.length; i++)
    if (inner_mapping[i].get_population () > 0) set_count++;

  unsigned int size = min_size + HBUINT32::static_size * set_count;
  if (unlikely (!c->allocate_size<HBUINT32> (size))) return_trace (false);

  hb_inc_bimap_t region_map;
  for (unsigned int i = 0; i < inner_mapping.length; i++)
    (src+src->regions).collect_region_refs (region_map, inner_mapping[i]);
  region_map.sort ();

  if (unlikely (!dataSets.serialize (c, src->dataSets, inner_mapping, region_map))) return_trace (false);

  return_trace (true);
}