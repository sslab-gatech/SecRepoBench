// <MASK>
if (m->matrix_changed > 1) {
    av_log(m->avctx, AV_LOG_ERROR, "Matrix configuration has been changed more than once per access unit.\n");
    return AVERROR_INVALIDDATA;
}

// Determine the maximum number of primitive matrices allowed based on the codec type.
if (m->codec_type == MLP_CODEC_TYPE_1) {
    max_matrices = 4;
} else if (m->codec_type == MLP_CODEC_TYPE_2) {
    max_matrices = 8;
} else {
    av_log(m->avctx, AV_LOG_ERROR, "Unsupported codec type.\n");
    return AVERROR_INVALIDDATA;
}

// Retrieve the number of primitive matrices from the bitstream.
mat = get_bits(gbp, 4);

// Validate that the number of primitive matrices does not exceed the allowed maximum.
if (mat > max_matrices) {
    av_log(m->avctx, AV_LOG_ERROR, "Too many primitive matrices specified.\n");
    return AVERROR_INVALIDDATA;
}