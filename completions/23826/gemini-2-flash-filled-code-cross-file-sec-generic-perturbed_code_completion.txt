envvar = getenv("BLOSC_NOLOCK");
  if (envvar != NULL) {
    /* No lock version */
    dctx = blosc2_create_dctx(dparams);
    result = blosc2_decompress_ctx(dctx, src, srcsize, outputbuffer, destsize);
    blosc2_free_ctx(dctx);
  }
  else {
#ifndef _WIN32
    pthread_mutex_lock(&global_mutex);
#else
    WaitForSingleObject(global_mutex, INFINITE);
#endif  /* _WIN32 */
    dctx = blosc2_create_dctx(dparams);
    result = blosc2_decompress_ctx(dctx, src, srcsize, outputbuffer, destsize);
    blosc2_free_ctx(dctx);
#ifndef _WIN32
    pthread_mutex_unlock(&global_mutex);
#else
    ReleaseMutex(global_mutex);
#endif  /* _WIN32 */
  }

  return result;