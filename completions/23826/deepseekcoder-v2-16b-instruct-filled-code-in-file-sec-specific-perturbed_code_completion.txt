flags |= BLOSC_DODELTA;
  }

  return flags;
}


static int initialize_context_decompression(
  blosc2_context* context, const void* src, int32_t srcsize, void* dest,
  int32_t destsize, int32_t typesize, int nthreads, blosc2_schunk* schunk) {

  /* Set parameters */
  context->do_compress = 0;
  context->src = (const uint8_t*)src;
  context->srcsize = srcsize;
  context->dest = (uint8_t*)dest;
  context->output_bytes = 0;
  context->destsize = destsize;
  context->sourcesize = srcsize;
  context->typesize = typesize;
  context->filter_flags = get_filter_flags(context->header_flags, typesize);
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    context->filters[i] = 0;
    context->filters_meta[i] = 0;
  }
  context->nthreads = nthreads;
  context->schunk = schunk;

  /* Check buffer size limits */
  if (srcsize > BLOSC_MAX_BUFFERSIZE) {
    fprintf(stderr, "Input buffer size cannot exceed %d bytes\n",
            BLOSC_MAX_BUFFERSIZE);
    return 0;
  }

  if (destsize < BLOSC_MAX_OVERHEAD) {
    fprintf(stderr, "Output buffer size should be larger than %d bytes\n",
            BLOSC_MAX_OVERHEAD);
    return -2;
  }

  /* Compute number of blocks in buffer */
  context->nblocks = context->sourcesize / context->blocksize;
  context->leftover = context->sourcesize % context->blocksize;
  context->nblocks = (context->leftover > 0) ?
                     (context->nblocks + 1) : context->nblocks;

  return 1;
}


/* Initialize the context for non-contextual API */
void blosc_init() {
  if (g_initlib == 0) {
    g_global_context = (blosc2_context*)my_malloc(sizeof(blosc2_context));
    g_global_context->header_flags = 0;
    g_global_context->filter_flags = 0;
    g_global_context->blocksize = BLOSC_BLOSCLZ_MAX_BUFFERSIZE;
    g_global_context->typesize = 1;
    g_global_context->compcode = BLOSC_BLOSCLZ;
    g_global_context->nthreads = 1;
    g_global_context->new_nthreads = 1;
    g_global_context->serial_context = NULL;
    g_global_context->thread_contexts = NULL;
    g_global_context->thread_giveup_code = 0;
    g_global_context->thread_nblock = 0;
    g_global_context->dref_not_init = 1;
    g_global_context->use_dict = 0;
    g_global_context->dict_cdict = NULL;
    g_global_context->dict_ddict = NULL;
    g_global_context->do_compress = 0;
    g_global_context->output_bytes = 0;
    g_global_context->destsize = 0;
    g_global_context->sourcesize = 0;
    g_global_context->src = NULL;
    g_global_context->dest = NULL;
    g_global_context->srcsize = 0;
    g_global_context->leftover = 0;
    g_global_context->nblocks = 0;
    g_global_context->btune = NULL;
    g_global_context->block_maskout = NULL;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->barr_init = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->barr_finish = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->pparams = NULL;
    g_global_context->prefilter = NULL;
    g_global_context->delta_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->dref_not_init = 1;
    g_global_context->use_dict = 0;
    g_global_context->dict_cdict = NULL;
    g_global_context->dict_ddict = NULL;
    g_global_context->do_compress = 0;
    g_global_context->output_bytes = 0;
    g_global_context->destsize = 0;
    g_global_context->sourcesize = 0;
    g_global_context->src = NULL;
    g_global_context->dest = NULL;
    g_global_context->srcsize = 0;
    g_global_context->leftover = 0;
    g_global_context->nblocks = 0;
    g_global_context->btune = NULL;
    g_global_context->block_maskout = NULL;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->barr_init = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->barr_finish = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->pparams = NULL;
    g_global_context->prefilter = NULL;
    g_global_context->delta_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->dref_not_init = 1;
    g_global_context->use_dict = 0;
    g_global_context->dict_cdict = NULL;
    g_global_context->dict_ddict = NULL;
    g_global_context->do_compress = 0;
    g_global_context->output_bytes = 0;
    g_global_context->destsize = 0;
    g_global_context->sourcesize = 0;
    g_global_context->src = NULL;
    g_global_context->dest = NULL;
    g_global_context->srcsize = 0;
    g_global_context->leftover = 0;
    g_global_context->nblocks = 0;
    g_global_context->btune = NULL;
    g_global_context->block_maskout = NULL;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->barr_init = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->barr_finish = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->pparams = NULL;
    g_global_context->prefilter = NULL;
    g_global_context->delta_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->dref_not_init = 1;
    g_global_context->use_dict = 0;
    g_global_context->dict_cdict = NULL;
    g_global_context->dict_ddict = NULL;
    g_global_context->do_compress = 0;
    g_global_context->output_bytes = 0;
    g_global_context->destsize = 0;
    g_global_context->sourcesize = 0;
    g_global_context->src = NULL;
    g_global_context->dest = NULL;
    g_global_context->srcsize = 0;
    g_global_context->leftover = 0;
    g_global_context->nblocks = 0;
    g_global_context->btune = NULL;
    g_global_context->block_maskout = NULL;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->barr_init = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->barr_finish = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->pparams = NULL;
    g_global_context->prefilter = NULL;
    g_global_context->delta_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->dref_not_init = 1;
    g_global_context->use_dict = 0;
    g_global_context->dict_cdict = NULL;
    g_global_context->dict_ddict = NULL;
    g_global_context->do_compress = 0;
    g_global_context->output_bytes = 0;
    g_global_context->destsize = 0;
    g_global_context->sourcesize = 0;
    g_global_context->src = NULL;
    g_global_context->dest = NULL;
    g_global_context->srcsize = 0;
    g_global_context->leftover = 0;
    g_global_context->nblocks = 0;
    g_global_context->btune = NULL;
    g_global_context->block_maskout = NULL;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->count_threads_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->barr_init = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->barr_finish = (pthread_barrier_t)PTHREAD_BARRIER_INITIALIZER;
    g_global_context->pparams = NULL;
    g_global_context->prefilter = NULL;
    g_global_context->delta_cv = (pthread_cond_t)PTHREAD_COND_INITIALIZER;
    g_global_context->delta_mutex = (pthread_mutex_t)PTHREAD_MUTEX_INITIALIZER;
    g_global_context->dref_not_init = 1;
    g_global_context->use_dict = 0;
    g_global_context->dict_cdict = NULL;
    g_global