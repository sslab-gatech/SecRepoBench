MEMCPYED) {
    flags |= BLOSC_MEMCPYED;
  }

  return flags;
}


static int initialize_context_decompression(
  blosc2_context* context, const void* src, int32_t srcsize, void* dest,
  int32_t destsize, int32_t typesize, int compressor, int nthreads,
  blosc2_schunk* schunk) {

  /* Set parameters */
  context->do_compress = 0;
  context->src = (const uint8_t*)src;
  context->srcsize = srcsize;
  context->dest = (uint8_t*)dest;
  context->output_bytes = 0;
  context->destsize = destsize;
  context->sourcesize = srcsize;
  context->typesize = typesize;
  context->filter_flags = get_filter_flags(context->header_flags, typesize);
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    context->filters[i] = 0;
    context->filters_meta[i] = 0;
  }
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->end_threads = 0;

  /* Compute number of blocks in buffer */
  context->nblocks = context->sourcesize / context->blocksize;
  context->leftover = context->sourcesize % context->blocksize;
  context->nblocks = (context->leftover > 0) ?
                     (context->nblocks + 1) : context->nblocks;

  return 1;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx(blosc2_context* context, int32_t typesize,
                     int32_t blocksize, int clevel, int compressor,
                     int nthreads) {
  context->typesize = typesize;
  context->blocksize = blocksize;
  context->clevel = clevel;
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->use_dict = 0;
  context->dict_cdict = NULL;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = NULL;
  context->srcsize = 0;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = 0;
  context->filter_flags = 0;
  context->header_flags = 0;
  context->bstarts = NULL;
  context->dref_not_init = 1;
  context->use_dict = 0;
  context->dict_cdict = NULL;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = NULL;
  context->srcsize = 0;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = 0;
  context->filter_flags = 0;
  context->header_flags = 0;
  context->bstarts = NULL;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx_from_config(blosc2_context* context, int32_t typesize,
                                 int32_t blocksize, int clevel, int compressor,
                                 int nthreads, const char* config) {
  context->typesize = typesize;
  context->blocksize = blocksize;
  context->clevel = clevel;
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->use_dict = 0;
  context->dict_cdict = NULL;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = NULL;
  context->srcsize = 0;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = 0;
  context->filter_flags = 0;
  context->header_flags = 0;
  context->bstarts = NULL;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx_from_dict(blosc2_context* context, int32_t typesize,
                               int32_t blocksize, int clevel, int compressor,
                               int nthreads, const void* cdict, int32_t cdictsize) {
  context->typesize = typesize;
  context->blocksize = blocksize;
  context->clevel = clevel;
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->use_dict = 1;
  context->dict_cdict = (void*)cdict;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = NULL;
  context->srcsize = 0;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = 0;
  context->filter_flags = 0;
  context->header_flags = 0;
  context->bstarts = NULL;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx_from_dict_decompress(blosc2_context* context,
                                          int32_t typesize, int32_t blocksize,
                                          int compressor, int nthreads,
                                          const void* cdict, int32_t cdictsize) {
  context->typesize = typesize;
  context->blocksize = blocksize;
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->use_dict = 1;
  context->dict_cdict = (void*)cdict;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = NULL;
  context->srcsize = 0;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = 0;
  context->filter_flags = 0;
  context->header_flags = 0;
  context->bstarts = NULL;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx_from_header(blosc2_context* context, const void* src,
                                 int32_t srcsize, int32_t typesize,
                                 int compressor, int nthreads,
                                 const uint8_t* header_flags,
                                 const uint8_t* filters,
                                 const uint8_t* filters_meta) {
  context->typesize = typesize;
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->use_dict = 0;
  context->dict_cdict = NULL;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = (const uint8_t*)src;
  context->srcsize = srcsize;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = srcsize;
  context->filter_flags = get_filter_flags(*header_flags, typesize);
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    context->filters[i] = filters[i];
    context->filters_meta[i] = filters_meta[i];
  }
  context->header_flags = *header_flags;
  context->bstarts = NULL;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx_from_header_decompress(blosc2_context* context,
                                            const void* src, int32_t srcsize,
                                            int32_t typesize, int compressor,
                                            int nthreads,
                                            const uint8_t* header_flags,
                                            const uint8_t* filters,
                                            const uint8_t* filters_meta) {
  context->typesize = typesize;
  context->compcode = compressor;
  context->nthreads = nthreads;
  context->new_nthreads = nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->use_dict = 0;
  context->dict_cdict = NULL;
  context->dict_ddict = NULL;
  context->block_maskout = NULL;
  context->do_compress = 0;
  context->src = (const uint8_t*)src;
  context->srcsize = srcsize;
  context->dest = NULL;
  context->output_bytes = 0;
  context->destsize = 0;
  context->sourcesize = srcsize;
  context->filter_flags = get_filter_flags(*header_flags, typesize);
  for (int i = 0; i < BLOSC2_MAX_FILTERS; i++) {
    context->filters[i] = filters[i];
    context->filters_meta[i] = filters_meta[i];
  }
  context->header_flags = *header_flags;
  context->bstarts = NULL;
}


/* Initialize the context for non-contextual API */
void blosc2_init_ctx_from_schunk(blosc2_context* context,
                                 blosc2_schunk* schunk) {
  context->typesize = schunk->typesize;
  context->blocksize = schunk->blocksize;
  context->clevel = schunk->clevel;
  context->compcode = schunk->compcode;
  context->nthreads = schunk->nthreads;
  context->new_nthreads = schunk->nthreads;
  context->serial_context = NULL;
  context->thread_contexts = NULL;
  context->thread_giveup_code = 0;
  context->thread_nblock = 0;
  context->threads_started = 0;
  context->dref_not_init = 1;
  context->