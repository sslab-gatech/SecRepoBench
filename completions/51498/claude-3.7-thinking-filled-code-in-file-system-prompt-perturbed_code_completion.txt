if (!checkcpdtable.empty() && !scpd &&
    ((!words && !onlycpdrule) || (words && onlycpdrule))) {
  for (size_t k = 0; k < checkcpdtable.size(); ++k) {
    const char* r = st.c_str() + i;
    if (strncmp(r, checkcpdtable[k].pattern.c_str(),
                checkcpdtable[k].pattern.size()) != 0)
      continue;

    // pattern matched
    soldi = i;
    oldlen = len;
    oldcmin = cmin;
    oldcmax = cmax;

    // replace the matched pattern with the replacement pattern
    st.replace(i, checkcpdtable[k].pattern.size(), checkcpdtable[k].pattern2);
    
    // adjust length
    len = st.size();
    
    // handle pattern3 for simplified compound words
    if (simplifiedcpd && !checkcpdtable[k].pattern3.empty()) {
      size_t pos = st.find(checkcpdtable[k].pattern3);
      if (pos != std::string::npos) {
        st.erase(pos, checkcpdtable[k].pattern3.size());
        len = st.size();
      }
    }

    setcminmax(&cmin, &cmax, st.c_str(), len);
    scpd = k + 1;
    
    // We've made a substitution, so break out of the loop
    break;
  }
}