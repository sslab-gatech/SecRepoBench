if (!checkcpdtable.empty() && scpd < checkcpdtable.size()) {
    const std::string &pat = checkcpdtable[scpd].pattern;
    const std::string &rep = checkcpdtable[scpd].pattern2;
    size_t patlen = pat.size();

    // Try to match the pattern near index i
    // (for example, matching at i - patlen if the pattern is a suffix)
    if (i >= (int) patlen && st.compare(i - patlen, patlen, pat) == 0) {
        // Store old bounds so we can revert if needed
        oldcmin = cmin;
        oldcmax = cmax;
        oldlen = len;
        soldi = i;

        // Replace the matched pattern
        st.replace(i - patlen, patlen, rep);

        // Update various indices and length parameters
        i = i - patlen + rep.size();
        len = st.size();
        cmax = (int) len;

        // We applied this compound pattern, so stop here.
        break;
    }
}