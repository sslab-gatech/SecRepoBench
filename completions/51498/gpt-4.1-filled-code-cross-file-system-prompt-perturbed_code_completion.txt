if (simplifiedcpd && !checkcpdtable.empty() && scpd < checkcpdtable.size()) {
  // Save current state to allow backtracking after pattern replacement
  soldi = i;
  oldlen = len;
  oldcmin = cmin;
  oldcmax = cmax;

  // Find a matching pattern in the compound pattern table
  const std::string& pat = checkcpdtable[scpd].pat;
  const std::string& rep = checkcpdtable[scpd].rep;
  int patlen = pat.size();

  // Only try to match if enough characters remain
  if (i + patlen <= (int)st.size() && 
      (patlen == 0 || strncmp(st.c_str() + i, pat.c_str(), patlen) == 0)) {
    // Replace pattern with replacement in 'st'
    st.replace(i, patlen, rep);
    // Adjust indices and length
    len = st.size();
    cmin = i + rep.size();
    cmax = len;
    i = cmin - 1; // -1 because the for loop will increment i
    continue;
  }
}