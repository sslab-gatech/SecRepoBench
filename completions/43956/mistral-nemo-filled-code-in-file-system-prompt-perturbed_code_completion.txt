// Assuming 'image' is the input image and 'mask' is the mask image
Image * FillMaskedRegion(Image * image, Image * mask, ExceptionInfo * exception) {
  CacheView
    *image_view,
    *mask_view;

  Quantum
    *magick_restrict p,
    *q;

  ssize_t
    y;

  MagickBooleanType
    status;

  status = MagickTrue;
  image_view = AcquireVirtualCacheView(image, exception);
  mask_view = AcquireAuthenticCacheView(mask, exception);
  if (image_view == (CacheView *) NULL || mask_view == (CacheView *) NULL) {
    status = MagickFalse;
    goto FillMaskedRegionCleanup;
  }

  for (y = 0; y < (ssize_t) image->rows; y++) {
    const Quantum
      *magick_restrict p_mask;

    Quantum
      *magick_restrict q;

    ssize_t
      x;

    p = GetCacheViewVirtualPixels(image_view, 0, y, image->columns, 1, exception);
    q = QueueCacheViewAuthenticPixels(image_view, 0, y, image->columns, 1, exception);
    p_mask = GetCacheViewVirtualPixels(mask_view, 0, y, mask->columns, 1, exception);
    if ((p == (const Quantum *) NULL) || (q == (Quantum *) NULL) || (p_mask == (const Quantum *) NULL)) {
      status = MagickFalse;
      goto FillMaskedRegionCleanup;
    }

    for (x = 0; x < (ssize_t) image->columns; x++) {
      ssize_t i;

      for (i = 0; i < (ssize_t) GetPixelChannels(image); i++) {
        PixelChannel channel = GetPixelChannelChannel(image, i);
        if (GetPixelColor(mask, p_mask) == MagickBlack) {
          SetPixelChannel(image, channel, GetPixelColor(image, p), q);
        } else {
          SetPixelChannel(image, channel, GetPixelColor(mask, p_mask), q);
        }
        p_mask += GetPixelChannels(mask);
      }
      p += GetPixelChannels(image);
      q += GetPixelChannels(image);
    }

    if (SyncCacheViewAuthenticPixels(image_view, exception) == MagickFalse) {
      status = MagickFalse;
      goto FillMaskedRegionCleanup;
    }
  }

FillMaskedRegionCleanup:
  image_view = DestroyCacheView(image_view);
  mask_view = DestroyCacheView(mask_view);

  if (status == MagickFalse) {
    image = DestroyImage(image);
  }

  return image;
}