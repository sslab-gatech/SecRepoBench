#include <MagickCore/MagickCore.h>

void FillMaskedRegion(Image *image, ExceptionInfo *exception) {
  CacheView
    *image_view;

  Quantum
    *magick_restrict p;

  ssize_t
    y;

  image_view = AcquireVirtualCacheView(image, exception);
  if (image_view == (CacheView *) NULL) {
    (void) ThrowMagickException(exception, GetMagickModule(), ResourceLimitFatalError,
      "Memory allocation failed for cache view", image->filename);
    return;
  }

  for (y = 0; y < (ssize_t) image->rows; y++) {
    p = GetCacheViewVirtualPixels(image_view, 0, y, image->columns, 1, exception);
    if (p == (Quantum *) NULL) {
      (void) ThrowMagickException(exception, GetMagickModule(), ResourceLimitFatalError,
        "Memory allocation failed for image pixels", image->filename);
      break;
    }

    // Fill in the masked region here using the p pointer.
    // For example, you can set all pixels in the region to a specific color:
    for (ssize_t x = 0; x < (ssize_t) image->columns; x++) {
      p[x] = QuantumRange / 2; // Set pixel to gray color.
    }

    if (SyncCacheViewAuthenticPixels(image_view, exception) == MagickFalse) {
      (void) ThrowMagickException(exception, GetMagickModule(), ResourceLimitFatalError,
        "SyncCacheViewAuthenticPixels failed", image->filename);
      break;
    }
  }

  image_view = DestroyCacheView(image_view);
}