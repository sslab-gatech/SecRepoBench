if (s->num_primitive_matrices > max_primitive_matrices) {
        av_log(m->avctx, AV_LOG_ERROR, "Too many primitive matrices.\n");
        return AVERROR_INVALIDDATA;
    }

    for (unsigned int mat = 0; mat < s->num_primitive_matrices; mat++) {
        unsigned int outch = get_bits(gbp, 4);
        unsigned int coeff_shift = get_bits(gbp, 4);
        unsigned int lsb_bypass = get_bits1(gbp);
        unsigned int max_outch = s->max_matrix_channel + (s->noise_shift ? 2 : 0);

        if (outch > max_outch) {
            av_log(m->avctx, AV_LOG_ERROR, "Matrix output channel %u exceeds maximum %u.\n",
                   outch, max_outch);
            goto error;
        }

        if (coeff_shift > 14) {
            av_log(m->avctx, AV_LOG_ERROR, "Fractional bits %u exceeds maximum 14.\n", coeff_shift);
            goto error;
        }

        for (unsigned int channel = 0; channel <= s->max_matrix_channel; channel++) {
            int coeff_val = get_sbits(gbp, coeff_shift + 1);
            s->matrix_out_ch[mat][channel] = coeff_val * (1 << coeff_shift);
        }

        s->lsb_bypass[mat] = lsb_bypass;
    }

    if (get_bits1(gbp)) {
        s->matrix_noise_shift = get_bits(gbp, 4);
    } else {
        s->matrix_noise_shift = 0;
    }

    return 0;

error:
    memset(s->matrix_out_ch, 0, sizeof(s->matrix_out_ch));
    memset(s->lsb_bypass, 0, sizeof(s->lsb_bypass));
    return AVERROR_INVALIDDATA;