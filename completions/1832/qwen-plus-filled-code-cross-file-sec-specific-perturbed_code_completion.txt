if (s->num_primitive_matrices > max_primitive_matrices) {
    av_log(m->avctx, AV_LOG_ERROR, "Number of primitive matrices exceeds maximum allowed.\n");
    return AVERROR_INVALIDDATA;
}

for (mat = 0; mat < s->num_primitive_matrices; mat++) {
    if (mat >= max_primitive_matrices) {
        av_log(m->avctx, AV_LOG_ERROR, "Matrix index exceeds maximum allowed.\n");
        return AVERROR_INVALIDDATA;
    }

    s->matrix_out_channel[mat] = get_bits(gbp, 4);
    channel = s->matrix_out_channel[mat];

    if (channel > s->max_matrix_channel) {
        av_log(m->avctx, AV_LOG_ERROR, "Output channel index exceeds maximum matrix channel.\n");
        return AVERROR_INVALIDDATA;
    }

    s->fractional_bits[mat] = get_bits(gbp, 4);
    if (s->fractional_bits[mat] > 14) {
        av_log(m->avctx, AV_LOG_ERROR, "Fractional bits exceed maximum allowed value.\n");
        return AVERROR_INVALIDDATA;
    }

    s->lsb_bypassed[mat] = get_bits1(gbp);

    if (!s->noise_type_set)
        s->max_matrix_channel += 2;

    s->coefficient_value[mat] = get_sbits(gbp, 16 - s->fractional_bits[mat]) << s->fractional_bits[mat];

    if (s->noise_type_set) {
        s->matrix_noise_shift[mat] = get_bits(gbp, 4);
    } else {
        s->matrix_noise_shift[mat] = 0;
    }
}