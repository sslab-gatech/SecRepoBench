if (memcmp(&packet->line[i].ptr[j], "SEND ", 5) == 0 ||
    memcmp(&packet->line[i].ptr[j], "CHAT ", 5) == 0 ||
    memcmp(&packet->line[i].ptr[j], "chat ", 5) == 0 ||
    memcmp(&packet->line[i].ptr[j], "sslchat ", 8) == 0 ||
    memcmp(&packet->line[i].ptr[j], "TSEND ", 6) == 0) {

    j += (packet->line[i].ptr[j] == 's' && packet->line[i].ptr[j+1] == 's') ? 8 : 
         (packet->line[i].ptr[j] == 'T') ? 6 : 5;

    int space_count = 0;
    u_int16_t port = 0;
    char *num_start = NULL;

    for (k = j; k < packet->line[i].len && space_count < 3; k++) {
        if (packet->line[i].ptr[k] == ' ') {
            space_count++;
            if (space_count == 3) num_start = &packet->line[i].ptr[k+1];
        }
    }

    if (num_start && (port = (u_int16_t)atoi(num_start)) != 0) {
        struct ndpi_id_struct *target = (flow->src == src_id) ? src_id : dst;
        if (!target) return;

        int found = 0, min_index = 0;
        u_int32_t min_ts = 0xFFFFFFFF;

        for (counter = 0; counter < target->irc_number_of_port; counter++) {
            if (target->irc_port[counter] == port) {
                target->last_time_port_used[counter] = packet->tick_timestamp;
                found = 1;
                break;
            }
            if (target->last_time_port_used[counter] < min_ts) {
                min_ts = target->last_time_port_used[counter];
                min_index = counter;
            }
        }

        if (!found) {
            if (target->irc_number_of_port < NDPI_MAX_IRC_PORTS) {
                target->irc_port[target->irc_number_of_port] = port;
                target->last_time_port_used[target->irc_number_of_port++] = packet->tick_timestamp;
            } else {
                int exists = 0;
                for (counter = 0; counter < NDPI_MAX_IRC_PORTS; counter++) {
                    if (target->irc_port[counter] == port) {
                        exists = 1;
                        break;
                    }
                }
                if (!exists) {
                    target->irc_port[min_index] = port;
                    target->last_time_port_used[min_index] = packet->tick_timestamp;
                }
            }
        }

        if (src_id) src_id->irc_ts = packet->tick_timestamp;
        if (dst) dst->irc_ts = packet->tick_timestamp;
    }
}