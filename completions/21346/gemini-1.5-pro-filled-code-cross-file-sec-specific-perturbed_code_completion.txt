for (k = j; k < packet->line[i].len; k++) {
  if (memcmp(&packet->line[i].ptr[k], "SEND ", 5) == 0
      || memcmp(&packet->line[i].ptr[k], "CHAT ", 5) == 0
      || memcmp(&packet->line[i].ptr[k], "chat ", 5) == 0
      || memcmp(&packet->line[i].ptr[k], "sslchat ", 8) == 0
      || memcmp(&packet->line[i].ptr[k], "TSEND ", 6) == 0) {
    j = k;
    break;
  }
}

space = 0;
for (k = j; k < packet->line[i].len; k++) {
  if (packet->line[i].ptr[k] == ' ') {
    space++;
    if (space == 3) {
      k++;
      port = ndpi_parse_irc_port(ndpi_struct, &packet->line[i].ptr[k], packet->line[i].len - k);
      if (port != 0) {
        if (src_id != NULL) {
          if (src_id->irc_number_of_port < MAX_IRC_PORTS_TRACKED) {
            int l;
            for (l = 0; l < src_id->irc_number_of_port; l++) {
              if (src_id->irc_port[l] == port) {
                goto skip_add_port;
              }
            }
            src_id->irc_port[src_id->irc_number_of_port] = port;
            src_id->last_time_port_used[src_id->irc_number_of_port] = packet->tick_timestamp;
            src_id->irc_number_of_port++;
          } else {
            less = src_id->last_time_port_used[0];
            u_int16_t less_index = 0;
            int l;
            for (l = 1; l < src_id->irc_number_of_port; l++) {
              if (src_id->last_time_port_used[l] < less) {
                less = src_id->last_time_port_used[l];
                less_index = l;
              }
            }
            for (l = 0; l < src_id->irc_number_of_port; l++) {
              if (src_id->irc_port[l] == port) {
                goto skip_add_port;
              }
            }
            src_id->irc_port[less_index] = port;
            src_id->last_time_port_used[less_index] = packet->tick_timestamp;
          }
        } else if (dst != NULL) {
          if (dst->irc_number_of_port < MAX_IRC_PORTS_TRACKED) {
            int l;
            for (l = 0; l < dst->irc_number_of_port; l++) {
              if (dst->irc_port[l] == port) {
                goto skip_add_port;
              }
            }
            dst->irc_port[dst->irc_number_of_port] = port;
            dst->last_time_port_used[dst->irc_number_of_port] = packet->tick_timestamp;
            dst->irc_number_of_port++;
          } else {
            less = dst->last_time_port_used[0];
            u_int16_t less_index = 0;
            int l;
            for (l = 1; l < dst->irc_number_of_port; l++) {
              if (dst->last_time_port_used[l] < less) {
                less = dst->last_time_port_used[l];
                less_index = l;
              }
            }
            for (l = 0; l < dst->irc_number_of_port; l++) {
              if (dst->irc_port[l] == port) {
                goto skip_add_port;
              }
            }
            dst->irc_port[less_index] = port;
            dst->last_time_port_used[less_index] = packet->tick_timestamp;
          }
        }
      skip_add_port:
      if (src_id != NULL) {
          src_id->irc_ts = packet->tick_timestamp;
      } else if (dst != NULL) {
          dst->irc_ts = packet->tick_timestamp;
      }
        break;
      }
    }
  }
}