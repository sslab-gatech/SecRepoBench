if (j + 4 < packet->line[i].len && memcmp(&packet->line[i].ptr[j], "SEND ", 5) == 0) {
  j += 4;
} else if (j + 4 < packet->line[i].len && memcmp(&packet->line[i].ptr[j], "CHAT ", 5) == 0) {
  j += 4;
} else if (j + 4 < packet->line[i].len && memcmp(&packet->line[i].ptr[j], "chat ", 5) == 0) {
  j += 4;
} else if (j + 7 < packet->line[i].len && memcmp(&packet->line[i].ptr[j], "sslchat ", 8) == 0) {
  j += 7;
} else if (j + 5 < packet->line[i].len && memcmp(&packet->line[i].ptr[j], "TSEND ", 6) == 0) {
  j += 5;
} else {
  continue;
}

space = 0;
for (k = j; k < packet->line[i].len; k++) {
  if (packet->line[i].ptr[k] == ' ') {
    space++;
    if (space == 3) {
      k++;
      if (sscanf((const char *)&packet->line[i].ptr[k], "%hu", &port) == 1) {
        if (src_id != NULL) {
          if (src_id->irc_number_of_port < MAX_IRC_PORTS_TRACKED) {
            int l;
            for (l = 0; l < src_id->irc_number_of_port; l++) {
              if (src_id->irc_port[l] == port) {
                goto skip_add_port;
              }
            }
            src_id->irc_port[src_id->irc_number_of_port] = port;
            src_id->irc_number_of_port++;
          } else {
            int l, min_idx = 0;
            u_int32_t min_ts = src_id->last_time_port_used[0];
            for (l = 1; l < src_id->irc_number_of_port; l++) {
              if (src_id->last_time_port_used[l] < min_ts) {
                min_ts = src_id->last_time_port_used[l];
                min_idx = l;
              }
              if (src_id->irc_port[l] == port) {
                goto skip_add_port;
              }
            }
            src_id->irc_port[min_idx] = port;
          }
        skip_add_port:;
          src_id->irc_ts = packet->tick_timestamp;
        } else if (dst != NULL) {
          if (dst->irc_number_of_port < MAX_IRC_PORTS_TRACKED) {
            int l;
            for (l = 0; l < dst->irc_number_of_port; l++) {
              if (dst->irc_port[l] == port) {
                goto skip_add_port2;
              }
            }
            dst->irc_port[dst->irc_number_of_port] = port;
            dst->irc_number_of_port++;
          } else {
            int l, min_idx = 0;
            u_int32_t min_ts = dst->last_time_port_used[0];
            for (l = 1; l < dst->irc_number_of_port; l++) {
              if (dst->last_time_port_used[l] < min_ts) {
                min_ts = dst->last_time_port_used[l];
                min_idx = l;
              }
              if (dst->irc_port[l] == port) {
                goto skip_add_port2;
              }
            }
            dst->irc_port[min_idx] = port;
          }
        skip_add_port2:;
          dst->irc_ts = packet->tick_timestamp;
        }
      }
      break;
    }
  }
}