{
    // Handle pre-behavior for envelopes: only process OffsetRepeat, Repeat and Oscillate
    if ((*it).pre == LWO::PrePostBehaviour_OffsetRepeat ||
        (*it).pre == LWO::PrePostBehaviour_Repeat ||
        (*it).pre == LWO::PrePostBehaviour_Oscillate)
    {
        // period is the length of the envelope's defined keys
        const double period = delta;
        if(period <= 0.0) {
            (*it).old_first = 0;
        }
        else {
            // number of originally defined keys
            const std::vector<LWO::Key> origKeys = (*it).keys;
            // difference of value from first to last key; used for offsetIncrementation
            const float diff = origKeys.back().value - origKeys.front().value;
            // Determine how many full periods we need to insert before the current first key.
            // The envelope is to be extended from the global beginning "first" up to the envelope's first key.
            const int repCount = static_cast<int>(ceil((firsttime - first) / period));
            // Container for the keys to be inserted
            std::vector<LWO::Key> preKeys;
            // Replicate the entire envelope for each repetition period.
            // We work backwards in time: rep==1 means one period before the original keys.
            for(int rep = repCount; rep > 0; --rep) {
                for(size_t i = 0; i < origKeys.size(); ++i) {
                    // Compute new time by subtracting rep periods
                    double newTime = origKeys[i].time - rep * period;
                    if(newTime < first)
                        continue; // skip keys that fall before the global animation start
                    LWO::Key newKey = origKeys[i];
                    newKey.time = newTime;
                    // Adjust key value based on pre-behavior type
                    if((*it).pre == LWO::PrePostBehaviour_OffsetRepeat) {
                        // Each repetition adds an offset equal to diff
                        newKey.value += rep * diff;
                    } else if((*it).pre == LWO::PrePostBehaviour_Oscillate) {
                        // For oscillation, every odd repetition reverses the value curve.
                        // A simple way: mirror the value around the midpoint defined by the first and last keys.
                        if(rep % 2 == 1) {
                            newKey.value = origKeys.back().value - (origKeys[i].value - origKeys.front().value);
                        }
                    }
                    // For Repeat, no modification is necessary.
                    preKeys.push_back(newKey);
                }
            }
            // Ensure the keys are sorted in ascending time order.
            std::sort(preKeys.begin(), preKeys.end(),
                      [](const LWO::Key &a, const LWO::Key &b) { return a.time < b.time; });
            // Insert the new pre-keys at the front of the envelope key vector.
            (*it).keys.insert((*it).keys.begin(), preKeys.begin(), preKeys.end());
            // Save the count of inserted keys for later removal in ClearAnimRangeSetup()
            (*it).old_first = preKeys.size();
        }
    }
}