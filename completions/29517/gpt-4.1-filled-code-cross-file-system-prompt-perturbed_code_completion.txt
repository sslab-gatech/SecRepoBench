if ( H5Aexists_by_name(dset_id,".","MATLAB_fields",H5P_DEFAULT) ) {
    /* The structure defines its fields using the "MATLAB_fields" attribute */
    err = Mat_H5ReadFieldNames(matvariable, dset_id, &nfields);
    if ( err < 0 ) {
        return err;
    }
    matvariable->internal->num_fields = (size_t)nfields;
} else {
    /* No "MATLAB_fields" attribute, so get the number of links in the group */
    struct ReadGroupInfoIterData {
        matvar_t *matvar;
        size_t nfields;
    } group_data;
    hsize_t nlinks = 0;
    H5G_info_t group_info;
    herr_t herr;

    herr = H5Gget_info(dset_id, &group_info);
    if ( herr < 0 ) {
        return MATIO_E_GENERIC_READ_ERROR;
    }
    nlinks = group_info.nlinks;
    if ( nlinks > 0 ) {
        size_t i;
        group_data.matvar = matvariable;
        group_data.nfields = 0;
        /* Allocate space for fieldnames */
        matvariable->internal->fieldnames = (char**)calloc((size_t)nlinks, sizeof(char*));
        if ( NULL == matvariable->internal->fieldnames ) {
            return MATIO_E_OUT_OF_MEMORY;
        }
        /* Iterate over links to collect field names */
        H5Literate(dset_id, H5_INDEX_NAME, H5_ITER_NATIVE, NULL,
                   Mat_H5ReadGroupInfoIterate, &group_data);
        nfields = group_data.nfields;
        matvariable->internal->num_fields = (size_t)nfields;
        /* If fewer fields were found than nlinks, shrink the array */
        if ( nfields < nlinks ) {
            char **tmp = (char**)realloc(matvariable->internal->fieldnames, nfields * sizeof(char*));
            if ( tmp != NULL ) {
                matvariable->internal->fieldnames = tmp;
            }
        }
    } else {
        nfields = 0;
        matvariable->internal->num_fields = 0;
        matvariable->internal->fieldnames = NULL;
    }
}