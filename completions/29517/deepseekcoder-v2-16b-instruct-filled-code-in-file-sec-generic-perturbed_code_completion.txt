_NO_ERROR;
    hid_t    dset_id, space_id, type_id;
    hsize_t  dims[1];
    int      rank = 1;

    if ( NULL == name )
        return MATIO_E_BAD_ARGUMENT;

    if ( NULL != class_name ) {
        matvar->class_type = ClassStr2ClassType(class_name);
        matvar->data_type  = ClassType2DataType(matvar->class_type);
    }

    dims[0] = 0;
    space_id = H5Screate_simple(rank, dims, NULL);
    type_id  = ClassType2H5T(matvar->class_type);
    dset_id  = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    if ( dset_id < 0 ) {
        err = MATIO_E_GENERIC_WRITE_ERROR;
    }

    return err;
}

static int
Mat_VarWriteCell73(hid_t id,matvar_t *matvar,const char *name,hid_t *refs_id,hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hsize_t i, nelems;
    matvar_t **cells;
    hobj_ref_t *ref_ids;

    if ( NULL == name || NULL == matvar || NULL == refs_id || NULL == dims )
        return MATIO_E_BAD_ARGUMENT;

    nelems = 1;
    for ( i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    cells = (matvar_t**)malloc(nelems*sizeof(*cells));
    if ( NULL != cells ) {
        ref_ids = (hobj_ref_t*)malloc(nelems*sizeof(*ref_ids));
        if ( NULL != ref_ids ) {
            for ( i = 0; i < nelems; i++ ) {
                cells[i] = Mat_VarCalloc();
                err = Mat_VarWriteRef(*refs_id, cells[i], matvar->compression, refs_id, &ref_ids[i]);
                if ( err ) {
                    break;
                }
            }
            if ( !err ) {
                err = Mat_VarWriteEmpty(*refs_id, matvar, name, NULL);
            }
            if ( !err ) {
                err = H5Dwrite(*refs_id, H5T_STD_REF_OBJ, H5S_ALL, H5S_ALL, H5P_DEFAULT, ref_ids);
            }
            free(ref_ids);
        } else {
            err = MATIO_E_OUT_OF_MEMORY;
        }
        free(cells);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteChar73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;
    char *data;

    if ( NULL == name || NULL == matvar || NULL == dims )
        return MATIO_E_BAD_ARGUMENT;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    data = (char*)malloc(nelems);
    if ( NULL != data ) {
        memcpy(data, matvar->data, nelems);
        space_id = H5Screate_simple(1, dims, NULL);
        type_id  = H5Tcopy(H5T_C_S1);
        H5Tset_size(type_id,dims[0]);
        dset_id  = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
        H5Sclose(space_id);
        H5Tclose(type_id);
        if ( dset_id < 0 ) {
            err = MATIO_E_GENERIC_WRITE_ERROR;
        } else {
            err = H5Dwrite(dset_id, H5T_NATIVE_CHAR, H5S_ALL, H5S_ALL, H5P_DEFAULT, data);
        }
        free(data);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_WriteEmptyVariable73(hid_t id,const char *name,hsize_t rank,size_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    if ( NULL == name || NULL == dims )
        return MATIO_E_BAD_ARGUMENT;

    space_id = H5Screate_simple(rank, dims, NULL);
    type_id  = H5Tcopy(H5T_NATIVE_HSIZE);
    dset_id  = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    if ( dset_id < 0 ) {
        err = MATIO_E_GENERIC_WRITE_ERROR;
    }

    return err;
}

static int
Mat_VarWriteLogical73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;
    char *data;

    if ( NULL == name || NULL == matvar || NULL == dims )
        return MATIO_E_BAD_ARGUMENT;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    data = (char*)malloc(nelems);
    if ( NULL != data ) {
        memcpy(data, matvar->data, nelems);
        space_id = H5Screate_simple(1, dims, NULL);
        type_id  = H5Tcopy(H5T_NATIVE_INT);
        H5Tset_size(type_id,1);
        dset_id  = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
        H5Sclose(space_id);
        H5Tclose(type_id);
        if ( dset_id < 0 ) {
            err = MATIO_E_GENERIC_WRITE_ERROR;
        } else {
            err = H5Dwrite(dset_id, H5T_NATIVE_INT, H5S_ALL, H5S_ALL, H5P_DEFAULT, data);
        }
        free(data);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteNumeric73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims,hsize_t* max_dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;
    void *data;

    if ( NULL == name || NULL == matvar || NULL == dims )
        return MATIO_E_BAD_ARGUMENT;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    if ( !matvar->isComplex ) {
        data = malloc(nelems*matvar->data_size);
    } else {
        data = ComplexMalloc(nelems*matvar->data_size);
    }
    if ( NULL != data ) {
        memcpy(data, matvar->data, nelems*matvar->data_size);
        space_id = H5Screate_simple(matvar->rank, dims, max_dims);
        type_id  = DataType(ClassType2H5T(matvar->class_type), matvar->isComplex);
        dset_id  = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
        H5Sclose(space_id);
        H5Tclose(type_id);
        if ( dset_id < 0 ) {
            err = MATIO_E_GENERIC_WRITE_ERROR;
        } else {
            err = Mat_H5WriteData(dset_id, type_id, H5S_ALL, H5S_ALL, matvar->isComplex, data);
        }
        free(data);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteAppendNumeric73(hid_t id,matvar_t *matvar,const char *name,hsize_t *dims,int dim)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;
    void *data;

    if ( NULL == name || NULL == matvar || NULL == dims )
        return MATIO_E_BAD_ARGUMENT;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    if ( !matvar->isComplex ) {
        data = malloc(nelems*matvar->data_size);
    } else {
        data = ComplexMalloc(nelems*matvar->data_size);
    }
    if ( NULL != data ) {
        memcpy(data, matvar->data, nelems*matvar->data_size);
        space_id = H5Screate_simple(matvar->rank, dims, NULL);
        type_id  = DataType(ClassType2H5T(matvar->class_type), matvar->isComplex);
        dset_id  = H5Dopen(id, name, H5P_DEFAULT);
        if ( dset_id < 0 ) {
            dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
        } else {
            H5Dset_extent(dset_id, dims);
            H5Sclose(space_id);
            space_id = H5Dget_space(dset_id);
        }
        H5Sclose(space_id);
        H5Tclose(type_id);
        if ( dset_id < 0 ) {
            err = MATIO_E_GENERIC_WRITE_ERROR;
        } else {
            err = Mat_H5WriteData(dset_id, type_id, H5S_ALL, H5S_ALL, matvar->isComplex, data);
        }
        free(data);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }

    return err;
}

static int
Mat_VarWriteSparse73(hid_t id,matvar_t *matvar,const char *name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;
    char *data;

    if ( NULL == name || NULL == matvar )
        return MATIO_E_BAD_ARGUMENT;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= matvar->dims[i];
    }

    data = (char*)malloc(nelems);
    if ( NULL != data ) {
        memset(data, 0, ne