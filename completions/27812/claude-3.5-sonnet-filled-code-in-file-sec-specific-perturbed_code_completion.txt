if (ret < 0) {
    BLOSC_TRACE_ERROR("Unable to get meta info from frame.");
    return -1;
}

int64_t trailer_offset = get_trailer_offset(frame, header_len, cbytes);
if (trailer_offset < 0) {
    BLOSC_TRACE_ERROR("Unable to get trailer offset.");
    return -1;
}

int32_t usermeta_len;
uint8_t* trailer = frame->sdata + trailer_offset;
if (frame->sdata != NULL) {
    memcpy(&usermeta_len, trailer + FRAME_TRAILER_USERMETA_LEN_OFFSET, sizeof(int32_t));
} else {
    FILE* fp = fopen(frame->fname, "rb");
    if (fp == NULL) {
        BLOSC_TRACE_ERROR("Unable to open file %s", frame->fname);
        return -1;
    }
    if (fseek(fp, trailer_offset + FRAME_TRAILER_USERMETA_LEN_OFFSET, SEEK_SET) != 0) {
        BLOSC_TRACE_ERROR("Unable to seek to usermeta length in file %s", frame->fname);
        fclose(fp);
        return -1;
    }
    if (fread(&usermeta_len, sizeof(int32_t), 1, fp) != 1) {
        BLOSC_TRACE_ERROR("Unable to read usermeta length from file %s", frame->fname);
        fclose(fp);
        return -1;
    }
    fclose(fp);
}
usermeta_len = sw32_(&usermeta_len);

if (usermeta_len == 0) {
    *usermeta = NULL;
    return 0;
}

*usermeta = malloc((size_t)usermeta_len);
if (*usermeta == NULL) {
    BLOSC_TRACE_ERROR("Unable to allocate memory for usermeta");
    return -1;
}

if (frame->sdata != NULL) {
    memcpy(*usermeta, trailer + FRAME_TRAILER_USERMETA_OFFSET, usermeta_len);
} else {
    FILE* fp = fopen(frame->fname, "rb");
    if (fp == NULL) {
        BLOSC_TRACE_ERROR("Unable to open file %s", frame->fname);
        free(*usermeta);
        return -1;
    }
    if (fseek(fp, trailer_offset + FRAME_TRAILER_USERMETA_OFFSET, SEEK_SET) != 0) {
        BLOSC_TRACE_ERROR("Unable to seek to usermeta in file %s", frame->fname);
        fclose(fp);
        free(*usermeta);
        return -1;
    }
    if (fread(*usermeta, 1, usermeta_len, fp) != (size_t)usermeta_len) {
        BLOSC_TRACE_ERROR("Unable to read complete usermeta from file %s", frame->fname);
        fclose(fp);
        free(*usermeta);
        return -1;
    }
    fclose(fp);
}