ref = (xmlXIncludeRefPtr) xmlMalloc(sizeof(xmlXIncludeRef));
if (ref == NULL) {
    xmlXIncludeErr(include_context, cur, XML_XINCLUDE_NO_HREF,
                  "Out of memory\n", NULL);
    return(-1);
}
memset(ref, 0, sizeof(xmlXIncludeRef));
ref->elem = cur;
ref->replace = 1;

/* 
 * Create a new reference for the xinclude node 
 */
if (include_context->incNr >= include_context->incMax) {
    xmlXIncludeRefPtr *tmp;
    int newMax = include_context->incMax ? include_context->incMax * 2 : 4;
    
    tmp = (xmlXIncludeRefPtr *) xmlRealloc(include_context->incTab, 
                                           newMax * sizeof(xmlXIncludeRefPtr));
    if (tmp == NULL) {
        xmlXIncludeErr(include_context, cur, XML_XINCLUDE_NO_HREF,
                      "Out of memory\n", NULL);
        xmlFree(ref);
        return(-1);
    }
    include_context->incTab = tmp;
    include_context->incMax = newMax;
}

/* 
 * Check if we're in fuzzing mode and have reached the limit 
 */
if ((include_context->incNr > MAX_INCLUDES_LIMIT) && 
    (include_context->max_depth == MAX_NESTED_INCLUDES)) {
    xmlXIncludeErr(include_context, cur, XML_XINCLUDE_RECURSION,
                  "Maximum inclusion limit reached\n", NULL);
    xmlFree(ref);
    return(-1);
}

include_context->incTab[include_context->incNr++] = ref;

/*
 * Load the node content
 */
ret = xmlXIncludeLoadNode(include_context, ref);
if (ret < 0) {
    /* 
     * The error has already been signaled, we mark this reference
     * to avoid replacing the node in phase 2
     */
    ref->replace = 0;
}