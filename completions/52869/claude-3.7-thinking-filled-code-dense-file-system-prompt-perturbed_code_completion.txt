ref = (xmlXIncludeRefPtr) xmlMalloc(sizeof(xmlXIncludeRef));
if (ref == NULL) {
    xmlXIncludeErr(include_context, cur, XML_XINCLUDE_NO_MEMORY,
                   "malloc failed\n", NULL);
    return(-1);
}
memset(ref, 0, sizeof(xmlXIncludeRef));
ref->elem = cur;
ref->replace = 1;  /* Mark for direct inclusion */

/* Check if we need to resize the incTab array */
if (include_context->incNr >= include_context->incMax) {
    xmlXIncludeRefPtr *tmp;
    int newMax = include_context->incMax ? include_context->incMax * 2 : 4;
    
    tmp = (xmlXIncludeRefPtr *) xmlRealloc(include_context->incTab, 
                                          newMax * sizeof(xmlXIncludeRefPtr));
    if (tmp == NULL) {
        xmlXIncludeErr(include_context, cur, XML_XINCLUDE_NO_MEMORY,
                       "realloc failed\n", NULL);
        xmlFree(ref);
        return(-1);
    }
    include_context->incTab = tmp;
    include_context->incMax = newMax;
}

/* In fuzzing mode, limit the total expansions */
if ((include_context->parseFlags & XML_PARSE_XINCLUDE_FUZZ) && 
    (include_context->incNr >= XML_XINCLUDE_FUZZ_MAX)) {
    xmlFree(ref);
    return(-1);
}

/* Add the reference to the array */
include_context->incTab[include_context->incNr++] = ref;
ret++;