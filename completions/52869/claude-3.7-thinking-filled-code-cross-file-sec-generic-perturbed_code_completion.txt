ref = (xmlXIncludeRefPtr) xmlMalloc(sizeof(xmlXIncludeRef));
if (ref == NULL) {
    xmlXIncludeErr(include_context, cur, 
                   XML_XINCLUDE_NO_MEMORY, 
                   "failed to allocate XInclude reference\n", NULL);
    return(-1);
}
memset(ref, 0, sizeof(xmlXIncludeRef));
ref->elem = cur;
ref->replace = 1; /* Mark for replacement */

/* Check if we need to grow the inclusions table */
if (include_context->incNr >= include_context->incMax) {
    xmlXIncludeRefPtr *tmp;
    int newSize = include_context->incMax ? include_context->incMax * 2 : 4;
    
    /* If in fuzzing mode, limit the total number of expansions */
    if ((include_context->flags & XML_XINCLUDE_FUZZ_MODE) && 
        (include_context->incNr >= XML_XINCLUDE_MAX_DEPTH)) {
        xmlXIncludeErr(include_context, cur, 
                       XML_XINCLUDE_RECURSION, 
                       "XInclude recursion or limit detected\n", NULL);
        xmlFree(ref);
        return(-1);
    }
    
    tmp = (xmlXIncludeRefPtr *) xmlRealloc(include_context->incTab, 
                                           newSize * sizeof(xmlXIncludeRefPtr));
    if (tmp == NULL) {
        xmlXIncludeErr(include_context, cur, 
                       XML_XINCLUDE_NO_MEMORY, 
                       "failed to grow XInclude references table\n", NULL);
        xmlFree(ref);
        return(-1);
    }
    include_context->incTab = tmp;
    include_context->incMax = newSize;
}

include_context->incTab[include_context->incNr++] = ref;
if (xmlXIncludeLoadNode(include_context, ref) < 0) {
    /* Loading failed, but this will be handled through fallbacks */
    ret = -1;
}