xmlXIncludeRefPtr ref = NULL;
xmlNodePtr new_tree = NULL;
xmlNodePtr fallback = NULL;
int ret = 0;

ref = xmlXIncludeAddRef(include_context, cur);
if (ref == NULL) {
    return(-1);
}

if (include_context->fuzzing) {
    if (include_context->total_includes >= include_context->max_includes) {
        xmlXIncludeErr(include_context, cur, XML_XINCLUDE_MAX_INCLUSIONS,
                       "Maximum number of inclusions reached\n", NULL);
        return(-1);
    }
    include_context->total_includes++;
}

ret = xmlXIncludeLoadNode(include_context, ref);
if (ret < 0) {
    if (ref->fallback == NULL) {
        xmlXIncludeErr(include_context, cur, XML_XINCLUDE_NO_FALLBACK,
                       "could not load %s, and no fallback was found\n",
                       ref->href);
        return(-1);
    }
    fallback = ref->fallback;
    new_tree = xmlXIncludeCopyRange(include_context, fallback);
    if (new_tree == NULL) {
        xmlXIncludeErr(include_context, cur, XML_XINCLUDE_NO_FALLBACK,
                       "could not load %s, and no fallback was found\n",
                       ref->href);
        return(-1);
    }
} else {
    new_tree = ref->inc;
}

if (new_tree!= NULL) {
    xmlXIncludeExpandNode(include_context, new_tree);
    ref->expanded = 1;
    ref->replace = 1;
}