{
    /* Limit the total number of expansions in fuzzing mode */
    #define MAX_FUZZ_INCLUDES 1000
    if ((include_context->fuzz) && (include_context->incNr >= MAX_FUZZ_INCLUDES)) {
        xmlXIncludeErr(include_context, cur, XML_XINCLUDE_MAX_FUZZ,
                       "Fuzzing mode: maximum inclusion expansions reached\n", NULL);
    } else {
        /* Allocate and initialize a new reference for this include node */
        ref = (xmlXIncludeRefPtr) xmlMalloc(sizeof(*ref));
        if (ref == NULL) {
            xmlXIncludeErr(include_context, cur, XML_XINCLUDE_MEMORY_ERROR,
                           "Memory allocation failed\n", NULL);
        } else {
            ref->elem = cur;
            ref->replace = 1; /* mark as a direct include */
            /* Ensure there is enough room in the include table */
            if (include_context->incNr >= include_context->incMax) {
                int newMax = include_context->incMax * 2;
                xmlXIncludeRefPtr *tmp = (xmlXIncludeRefPtr *)
                    xmlRealloc(include_context->incTab, newMax * sizeof(xmlXIncludeRefPtr));
                if (tmp == NULL) {
                    xmlXIncludeErr(include_context, cur, XML_XINCLUDE_MEMORY_ERROR,
                                   "Memory reallocation failed\n", NULL);
                    xmlFree(ref);
                } else {
                    include_context->incTab = tmp;
                    include_context->incMax = newMax;
                }
            }
            /* Add the new reference if there's room */
            if (include_context->incNr < include_context->incMax) {
                include_context->incTab[include_context->incNr++] = ref;
                if (xmlXIncludeLoadNode(include_context, ref) < 0) {
                    /* If expansion fails, mark not to be processed later */
                    ref->replace = 0;
                }
            }
        }
    }
}