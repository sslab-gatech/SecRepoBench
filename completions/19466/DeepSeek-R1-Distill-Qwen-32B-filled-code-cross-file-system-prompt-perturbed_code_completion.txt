// Extract server name from certificate
u_int8_t server_name_len = packet->payload[i+3];
if (i+4+server_name_len > packet->payload_packet_len) {
    continue; // Not enough data
}

strncpy(buffer, (char*)&packet->payload[i+4], server_name_len);
buffer[server_name_len] = '\0';

// Validate server name
if (ndpi_validate_hostname(buffer) || ndpi_validate_ip_address(buffer)) {
    // Store server name
    if (!ndpi_struct->disable_metadata_export) {
        snprintf(flow->protos.stun_ssl.ssl.server_certificate,
                 sizeof(flow->protos.stun_ssl.ssl.server_certificate), "%s", buffer);
    }
    
    // Match server name to known protocols
    if (ndpi_match_hostname_protocol(ndpi_struct, flow, buffer)) {
        return 1; // Protocol detected
    }
    
    return 1; // Valid server name found
}