int offset = i + 3;
u_int16_t server_name_len;

server_name_len = (packet->payload[offset] << 8) + packet->payload[offset + 1];
offset += 2;

if (offset + server_name_len < packet->payload_packet_len) {
  size_t len = ndpi_min(server_name_len, buffer_len - 1);
  if (len > 0) {
    memcpy(buffer, &packet->payload[offset], len);
    buffer[len] = '\0';

    stripCertificateTrailer(buffer, buffer_len);
#ifdef DEBUG_TLS
    printf("Server certificate: %s\n", buffer);
#endif

    if (!ndpi_struct->disable_metadata_export) {
      snprintf(flow->protos.stun_ssl.ssl.server_certificate,
               sizeof(flow->protos.stun_ssl.ssl.server_certificate), "%s", buffer);
    }

    // Optionally attempt to match the server name to a known protocol
    // and set the flow's detected protocol accordingly.

    return 1; // Indicate success
  }
}