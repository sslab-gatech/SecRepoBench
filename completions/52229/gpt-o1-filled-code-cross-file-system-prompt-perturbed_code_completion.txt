{
    const char *prefix = (strncasecmp(http_server_name, "Apache/", 7) == 0) ? "Apache/" : "nginx/";
    const char *version_start = http_server_name + off;
    /* Skip the prefix itself */
    version_start += strlen(prefix);

    /* Skip any leading spaces */
    while(*version_start && isspace((unsigned char)*version_start))
        version_start++;

    /* Extract the version string */
    char version[32];
    memset(version, 0, sizeof(version));
    for(u_int i = 0; i < sizeof(version) - 1 && version_start[i] && !isspace((unsigned char)version_start[i]); i++) {
        version[i] = version_start[i];
    }

    /* Parse the version into major.minor.patch */
    int major = 0, minor = 0, patch = 0;
    if(sscanf(version, "%d.%d.%d", &major, &minor, &patch) >= 2) {
        int is_apache = (strncasecmp(http_server_name, "Apache/", 7) == 0);
        int is_outdated = 0;

        /*
         * For demonstration purposes, define some sample minimum versions:
         * - Apache: 2.4.49
         * - nginx: 1.18.0
         */
        if(is_apache) {
            if(major < 2 || (major == 2 && (minor < 4 || (minor == 4 && patch < 49)))) {
                is_outdated = 1;
            }
        } else {
            if(major < 1 || (major == 1 && (minor < 18 || (minor == 18 && patch < 0)))) {
                is_outdated = 1;
            }
        }

        /* If obsolete, set a risk indicator with a message about the outdated version */
        if(is_outdated) {
            char risk_msg[128];
            snprintf(risk_msg, sizeof(risk_msg),
                     "Outdated %s server version detected: %s",
                     is_apache ? "Apache" : "nginx", version);
            ndpi_set_risk(ndpi_struct, flow, NDPI_HTTP_NUMERIC_IP_HOST, risk_msg);
        }
    }
}