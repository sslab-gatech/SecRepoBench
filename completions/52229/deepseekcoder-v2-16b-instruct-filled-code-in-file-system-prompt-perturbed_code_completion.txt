flow->l4.tcp.http_stage = 1;
    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);
    return;
  } else if(packet->http_check_content && (packet->payload_packet_len > 0)) {
    ndpi_http_check_human_redeable_content(ndpi_struct, flow, packet->payload, packet->payload_packet_len);
    packet->http_check_content = 0; /* One packet is enough */
  }

  if(flow->l4.tcp.http_stage == 1) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 2;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 2) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 3;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 3) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 4;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 4) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 5;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 5) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 6;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 6) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 7;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 7) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 8;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 8) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 9;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 9) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 10;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 10) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 11;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 11) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 12;
      return;
    }

    if(packet->http_num_headers > 0) {
      ndpi_int_http_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, NDPI_PROTOCOL_CATEGORY_WEB);
      return;
    }

    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    http_bitmask_exclude_other(flow);
    return;
  }

  if(flow->l4.tcp.http_stage == 12) {
    NDPI_LOG_DBG2(ndpi_struct, "HTTP stage %d: \n", flow->l4.tcp.http_stage);

    ndpi_parse_packet_line_info(ndpi_struct, flow);
    check_content_type_and_change_protocol(ndpi_struct, flow);
    ndpi_validate_http_content(ndpi_struct, flow);

    if(flow->http_detected) {
      flow->l4.tcp.http_stage = 13;
      return;
    }

    if(packet->http_num_headers >