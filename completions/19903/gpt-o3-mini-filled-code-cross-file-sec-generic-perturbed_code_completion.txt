{
  const char *p = expression;
  while (isspace((int)((unsigned char)*p)))
    p++;
  if (*p == '(')
  {
    /* Evaluate subexpression enclosed in parentheses */
    ssize_t paren_level = 1;
    const char *q = p + 1;
    while (*q && paren_level)
    {
      if (*q == '(')
        paren_level++;
      else if (*q == ')')
        paren_level--;
      q++;
    }
    if (paren_level != 0)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
        "MismatchedParenthesis","`%s'",expression);
      FxReturn(0.0);
    }
    /* Extract the inner expression and evaluate it recursively */
    char *inner = AcquireString(p+1);
    inner[q - p - 1] = '\0';
    double value = FxEvaluateSubexpression(fx_info,channel,x,y,inner,
      depth+1,beta,exception);
    inner = DestroyString(inner);
    FxReturn(value);
  }
  else if (isalpha((int)((unsigned char)*p)))
  {
    /* Parse a function name */
    char func[32];
    size_t i = 0;
    while (isalpha((int)((unsigned char)*p)) && (i < sizeof(func)-1))
      func[i++] = *p++;
    func[i] = '\0';
    while (isspace((int)((unsigned char)*p)))
      p++;
    if (*p == '(')
    {
      /* Evaluate the function argument within parentheses */
      ssize_t paren_level = 1;
      const char *q = p + 1;
      while (*q && paren_level)
      {
        if (*q == '(')
          paren_level++;
        else if (*q == ')')
          paren_level--;
        q++;
      }
      if (paren_level != 0)
      {
        (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
          "MismatchedParenthesis","`%s'",expression);
        FxReturn(0.0);
      }
      char *arg = AcquireString(p+1);
      arg[q - p - 1] = '\0';
      double arg_value = FxEvaluateSubexpression(fx_info,channel,x,y,arg,
        depth+1,beta,exception);
      arg = DestroyString(arg);
      double result;
      if (LocaleCompare(func,"abs") == 0)
        result = fabs(arg_value);
      else if (LocaleCompare(func,"acos") == 0)
        result = acos(arg_value);
      else if (LocaleCompare(func,"asin") == 0)
        result = asin(arg_value);
      else if (LocaleCompare(func,"atan") == 0)
        result = atan(arg_value);
      else if (LocaleCompare(func,"cos") == 0)
        result = cos(arg_value);
      else if (LocaleCompare(func,"sin") == 0)
        result = sin(arg_value);
      else if (LocaleCompare(func,"tan") == 0)
        result = tan(arg_value);
      else if (LocaleCompare(func,"exp") == 0)
        result = exp(arg_value);
      else if (LocaleCompare(func,"log") == 0)
        result = log(arg_value);
      else if (LocaleCompare(func,"sqrt") == 0)
        result = sqrt(arg_value);
      else if (LocaleCompare(func,"pi") == 0)
        result = 3.14159265358979323846;
      else if (LocaleCompare(func,"e") == 0)
        result = 2.71828182845904523536;
      else
      {
        (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
          "UnrecognizedFunction","`%s'",func);
        FxReturn(0.0);
      }
      FxReturn(result);
    }
  }
}