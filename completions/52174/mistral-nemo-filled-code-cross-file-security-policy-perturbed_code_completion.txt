if (flow->l4.tcp.irc_stage == 1) {
    NDPI_LOG_DBG2(detection_module, "Searching for IRC username in packet payload");
    char *username_start = strchr(packet->payload, ' ');
    if (username_start != NULL) {
      char *username_end = strchr(username_start + 1, ' ');
      if (username_end != NULL) {
        size_t username_len = username_end - username_start;
        char username[username_len + 1];
        strncpy(username, username_start + 1, username_len);
        username[username_len] = '\0';
        NDPI_LOG_INFO(detection_module, "Found IRC username: %s", username);
        ndpi_int_irc_add_connection(detection_module, flow, NDPI_CONFIDENCE_DPI);
        flow->l4.tcp.irc_stage = 2;
      }
    }
  }