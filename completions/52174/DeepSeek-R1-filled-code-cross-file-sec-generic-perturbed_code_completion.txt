if (memcmp(packet->payload, "USER ", 5) == 0) {
    char username[256];
    u_int16_t len = 0;
    for (i = 5; i < packet->payload_packet_len && len < sizeof(username)-1; i++) {
        if (packet->payload[i] == ' ' || packet->payload[i] == '\r' || packet->payload[i] == '\n' || packet->payload[i] == '\0')
            break;
        username[len++] = packet->payload[i];
    }
    username[len] = '\0';
    NDPI_LOG_INFO(detection_module, "Found IRC username: %s", username);
}

ndpi_set_risk(detection_module, flow, NDPI_CLEAR_TEXT_CREDENTIALS);

if (!(flow->risk & NDPI_CLEAR_TEXT_CREDENTIALS)) {
    NDPI_LOG_INFO(detection_module, "IRC clear text credentials detected");
}

if (flow->l4.tcp.irc_stage == 2) {
    NDPI_LOG_INFO(detection_module, "found irc");
    ndpi_int_irc_add_connection(detection_module, flow, NDPI_CONFIDENCE_DPI);
    flow->l4.tcp.irc_stage = 3;
}
if (flow->l4.tcp.irc_stage == 1) {
    NDPI_LOG_DBG2(detection_module, "second time, stage=2");
    flow->l4.tcp.irc_stage = 2;
}
if (flow->l4.tcp.irc_stage == 0) {
    NDPI_LOG_DBG2(detection_module, "first time, stage=1");
    flow->l4.tcp.irc_stage = 1;
}