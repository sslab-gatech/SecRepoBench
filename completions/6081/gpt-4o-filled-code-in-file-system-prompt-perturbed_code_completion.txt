/*
      Entity.
    */
    if (strncmp(xml,"ENTITY",6) == 0)
      {
        xml+=strspn(xml+6,XMLWhitespace)+6;
        if (*xml == '%')
          {
            xml+=strspn(xml+1,XMLWhitespace)+1;
            state='%';
          }
        else
          state='&';
        t=xml;
        xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","missing entity name");
            return(MagickFalse);
          }
        *xml++='\0';
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","missing entity value");
            return(MagickFalse);
          }
        q=(*xml == '"') || (*xml == '\'') ? *xml++ : ' ';
        v=xml;
        if (q != ' ')
          {
            xml=strchr(xml,q);
            if (xml == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","missing %c",q);
                return(MagickFalse);
              }
            *xml='\0';
          }
        else
          {
            c=(*xml);
            if (isalpha((int) ((unsigned char) c)) != 0)
              {
                xml+=strcspn(xml,XMLWhitespace);
                c=(*xml);
                *xml='\0';
              }
            else
              if (c == '#')
                {
                  xml+=strcspn(xml,">");
                  c=(*xml);
                  *xml='\0';
                }
              else
                {
                  (void) ThrowMagickException(exception,GetMagickModule(),
                    OptionWarning,"ParseError","unexpected character: '%c'",c);
                  return(MagickFalse);
                }
          }
        if (state == '%')
          {
            /*
              Parameter entity.
            */
            if (root->standalone != MagickFalse)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","parameter entity not allowed");
                return(MagickFalse);
              }
            if (ValidateEntities(t,v,0,predefined_entitites) == MagickFalse)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","circular entity: '%s'",t);
                return(MagickFalse);
              }
            predefined_entitites=(char **) ResizeQuantumMemory(
              predefined_entitites,(size_t) (index+4),sizeof(*predefined_entitites));
            if (predefined_entitites == (char **) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            predefined_entitites[index++]=ConstantString(t);
            predefined_entitites[index++]=ConstantString(v);
            predefined_entitites[index]=(char *) NULL;
          }
        else
          {
            /*
              General entity.
            */
            if (ValidateEntities(t,v,0,entities) == MagickFalse)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","circular entity: '%s'",t);
                return(MagickFalse);
              }
            entities=(char **) ResizeQuantumMemory(entities,(size_t) (index+4),
              sizeof(*entities));
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            entities[index++]=ConstantString(t);
            entities[index++]=ConstantString(v);
            entities[index]=(char *) NULL;
          }
        if (q != ' ')
          xml++;
        continue;
      }
    /*
      Attlist.
    */
    if (strncmp(xml,"ATTLIST",7) == 0)
      {
        xml+=strspn(xml+7,XMLWhitespace)+7;
        t=xml;
        xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","missing attlist name");
            return(MagickFalse);
          }
        *xml++='\0';
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","missing attribute name");
            return(MagickFalse);
          }
        if (root->attributes[0] == (char **) NULL)
          {
            root->attributes=(char ***) AcquireMagickMemory(sizeof(*root->attributes));
            if (root->attributes == (char ***) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            *root->attributes=(char **) NULL;
          }
        i=0;
        while ((root->attributes[i] != (char **) NULL) &&
               (strcmp(root->attributes[i][0],t) != 0))
          i++;
        if (root->attributes[i] == (char **) NULL)
          {
            root->attributes=(char ***) ResizeQuantumMemory(root->attributes,
              (size_t) (i+2),sizeof(*root->attributes));
            if (root->attributes == (char ***) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            root->attributes[i]=(char **) AcquireMagickMemory(4*sizeof(**root->attributes));
            if (root->attributes[i] == (char **) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            root->attributes[i+1]=(char **) NULL;
            root->attributes[i][0]=ConstantString(t);
            root->attributes[i][1]=(char *) NULL;
            root->attributes[i][2]=(char *) NULL;
            root->attributes[i][3]=(char *) NULL;
          }
        j=1;
        while (root->attributes[i][j] != (char *) NULL)
          j+=3;
        root->attributes[i]=(char **) ResizeQuantumMemory(root->attributes[i],
          (size_t) (j+4),sizeof(**root->attributes));
        if (root->attributes[i] == (char **) NULL)
          ThrowFatalException(ResourceLimitFatalError,
            "MemoryAllocationFailed");
        root->attributes[i][j+3]=(char *) NULL;
        while (*xml != '\0')
        {
          root->attributes[i][j]=xml;
          xml+=strcspn(xml,XMLWhitespace);
          if (*xml == '\0')
            {
              (void) ThrowMagickException(exception,GetMagickModule(),
                OptionWarning,"ParseError","missing attribute type");
              return(MagickFalse);
            }
          *xml++='\0';
          xml+=strspn(xml,XMLWhitespace);
          if (*xml == '\0')
            {
              (void) ThrowMagickException(exception,GetMagickModule(),
                OptionWarning,"ParseError","missing attribute type");
              return(MagickFalse);
            }
          xml+=strcspn(xml,XMLWhitespace);
          if (*xml == '\0')
            {
              (void) ThrowMagickException(exception,GetMagickModule(),
                OptionWarning,"ParseError","missing attribute default");
              return(MagickFalse);
            }
          xml+=strspn(xml,XMLWhitespace);
          if (*xml == '\0')
            {
              (void) ThrowMagickException(exception,GetMagickModule(),
                OptionWarning,"ParseError","missing attribute default");
              return(MagickFalse);
            }
          q=(*xml == '"') || (*xml == '\'') ? *xml++ : ' ';
          root->attributes[i][j+1]=xml;
          if (q != ' ')
            {
              xml=strchr(xml,q);
              if (xml == (char *) NULL)
                {
                  (void) ThrowMagickException(exception,GetMagickModule(),
                    OptionWarning,"ParseError","missing %c",q);
                  return(MagickFalse);
                }
              *xml='\0';
            }
          else
            {
              xml+=strcspn(xml,XMLWhitespace);
              if (*xml != '\0')
                *xml++='\0';
            }
          root->attributes[i][j+1]=ParseEntities(root->attributes[i][j+1],
            root->entities,'*');
          j+=3;
          xml+=strspn(xml,XMLWhitespace);
        }
        continue;
      }
    /*
      Comment.
    */
    if (strncmp(xml,"--",2) == 0)
      {
        xml=strstr(xml+2,"--");
        if ((xml == (char *) NULL) || ((*(xml+=2) != '>') && (*xml != '\0')) ||
            ((*xml == '\0') && (terminal != '>')))
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","unclosed <!--");
            return(MagickFalse);
          }
        continue;
      }
    /*
      Processing instructions.
    */
    if (*xml == '?')
      {
        do
        {
          xml=strchr(xml,'?');
          if (xml == (char *) NULL)
            break;
          xml++;
        } while ((*xml != '\0') && (*xml != '>'));
        if ((xml == (char *) NULL) || ((*xml == '\0') && (terminal != '>')))
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","unclosed <?");
            return(MagickFalse);
          }
        ParseProcessingInstructions(root,tag+1,(size_t) (xml-tag-2));
        continue;
      }
    /*
      Unknown declaration.
    */
    (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
      "ParseError","unexpected <!%s",tag);
    return(MagickFalse);