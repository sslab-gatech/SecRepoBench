// <MASK>
char *c, *n, *t, *v;
int state = 0;

// Parse the DOCTYPE declaration
while (xml != NULL) {
    // Check for ENTITY declarations
    if (strncmp(xml, "<!ENTITY", 8) == 0) {
        xml += 8;
        xml += strspn(xml, XMLWhitespace);
        if (strncmp(xml, "%", 1) == 0) {
            // Parameter entity
            xml++;
            xml += strspn(xml, XMLWhitespace);
            n = xml;
            xml += strcspn(xml, XMLWhitespace);
            *xml++ = '\0';
            xml += strspn(xml, XMLWhitespace);
            if (strncmp(xml, "SYSTEM", 6) == 0) {
                xml += 6;
                xml += strspn(xml, XMLWhitespace);
                c = xml;
                xml = strchr(xml, '>');
                if (xml == NULL) {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed <!ENTITY %s", n);
                    return MagickFalse;
                }
                *xml++ = '\0';
                if (!ValidateEntities(n, c, 1, root->entities)) {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "circular entity reference %s", n);
                    return MagickFalse;
                }
                root->entities = (char **)ResizeQuantumMemory(root->entities, (size_t)(i+3), sizeof(*root->entities));
                if (root->entities == NULL)
                    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
                root->entities[i++] = ConstantString(n);
                root->entities[i++] = ConstantString(c);
                root->entities[i] = (char *)NULL;
            } else {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected SYSTEM in <!ENTITY %s", n);
                return MagickFalse;
            }
        } else {
            // General entity
            n = xml;
            xml += strcspn(xml, XMLWhitespace);
            *xml++ = '\0';
            xml += strspn(xml, XMLWhitespace);
            if (strncmp(xml, "SYSTEM", 6) == 0) {
                xml += 6;
                xml += strspn(xml, XMLWhitespace);
                c = xml;
                xml = strchr(xml, '>');
                if (xml == NULL) {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed <!ENTITY %s", n);
                    return MagickFalse;
                }
                *xml++ = '\0';
                if (!ValidateEntities(n, c, 1, root->entities)) {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "circular entity reference %s", n);
                    return MagickFalse;
                }
                root->entities = (char **)ResizeQuantumMemory(root->entities, (size_t)(i+3), sizeof(*root->entities));
                if (root->entities == NULL)
                    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
                root->entities[i++] = ConstantString(n);
                root->entities[i++] = ConstantString(c);
                root->entities[i] = (char *)NULL;
            } else {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected SYSTEM in <!ENTITY %s", n);
                return MagickFalse;
            }
        }
    }
    // Check for ATTLIST declarations
    else if (strncmp(xml, "<!ATTLIST", 9) == 0) {
        xml += 9;
        xml += strspn(xml, XMLWhitespace);
        t = xml;
        xml += strcspn(xml, XMLWhitespace);
        *xml++ = '\0';
        xml += strspn(xml, XMLWhitespace);
        while (*xml != '>') {
            n = xml;
            xml += strcspn(xml, XMLWhitespace);
            *xml++ = '\0';
            xml += strspn(xml, XMLWhitespace);
            if (strncmp(xml, "CDATA", 5) == 0) {
                xml += 5;
                xml += strspn(xml, XMLWhitespace);
                v = xml;
                xml = strchr(xml, '>');
                if (xml == NULL) {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed <!ATTLIST %s %s", t, n);
                    return MagickFalse;
                }
                *xml++ = '\0';
            } else {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected CDATA in <!ATTLIST %s %s", t, n);
                return MagickFalse;
            }
            i = 0;
            while (root->attributes[i] != NULL && strcmp(root->attributes[i][0], t) != 0)
                i++;
            if (root->attributes[i] == NULL) {
                root->attributes = (char ***)ResizeQuantumMemory(root->attributes, (size_t)(i+2), sizeof(*root->attributes));
                if (root->attributes == NULL)
                    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
                root->attributes[i] = (char **)AcquireQuantumMemory(4, sizeof(**root->attributes));
                if (root->attributes[i] == NULL)
                    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
                root->attributes[i][0] = ConstantString(t);
                root->attributes[i][1] = ConstantString(n);
                root->attributes[i][2] = ConstantString(v);
                root->attributes[i][3] = NULL;
                root->attributes[i+1] = NULL;
            } else {
                j = 1;
                while (root->attributes[i][j] != NULL)
                    j += 3;
                root->attributes[i] = (char **)ResizeQuantumMemory(root->attributes[i], (size_t)(j+4), sizeof(**root->attributes));
                if (root->attributes[i] == NULL)
                    ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
                root->attributes[i][j] = ConstantString(n);
                root->attributes[i][j+1] = ConstantString(v);
                root->attributes[i][j+2] = NULL;
                root->attributes[i][j+3] = NULL;
            }
            xml += strspn(xml, XMLWhitespace);
        }
    }
    // Check for comments and processing instructions
    else if (strncmp(xml, "<!--", 4) == 0) {
        xml = strstr(xml, "-->");
        if (xml == NULL) {
            (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed <!--");
            return MagickFalse;
        }
        xml += 3;
    } else if (strncmp(xml, "<?", 2) == 0) {
        xml = strstr(xml, "?>");
        if (xml == NULL) {
            (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed <?");
            return MagickFalse;
        }
        xml += 2;
        ParseProcessingInstructions(root, tag + 2, (size_t)(xml - tag - 4));
    } else {
        (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unexpected markup in DOCTYPE");
        return MagickFalse;
    }
    xml += strspn(xml, XMLWhitespace);
    if (*xml == ']') {
        xml++;
        xml += strspn(xml, XMLWhitespace);
    }
    if (*xml == '>') {
        xml++;
        break;
    }
}
// </MASK>