{
  char
    *start,
    *end;

  size_t
    entity_length;

  start=xml;
  while (*start != '\0')
  {
    if ((*start == '<') && (*(start+1) == '!'))
    {
      if ((strstr(start,"ENTITY") != NULL) || (strstr(start,"ATTLIST") != NULL))
      {
        end=strchr(start,'>');
        if (end == NULL)
        {
          ThrowXMLException(CorruptImageError,"InvalidDOCTYPE");
          break;
        }
        *end='\0';
        if ( strstr(start,"ENTITY") != NULL )
        {
          t=start+7; // Skip past "<!ENTITY"
          while (isspace((unsigned char)*t)) t++;
          v=strchr(t,' ');
          if (v == NULL)
          {
            ThrowXMLException(CorruptImageError,"MalformedEntityDeclaration");
            break;
          }
          *v='\0';
          entity_length=v-t;
          n=(char *) AcquireQuantumMemory(entity_length+1,sizeof(*n));
          if (n == NULL)
          {
            ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            break;
          }
          (void) CopyMagickMemory(n,t,entity_length);
          n[entity_length]='\0';

          // Parse the value part of the ENTITY declaration
          v++;
          while (isspace((unsigned char)*v)) v++;
          q=strchr(v,'\"');
          if (q == NULL)
          {
            RelinquishMagickMemory(n);
            ThrowXMLException(CorruptImageError,"MalformedEntityValue");
            break;
          }
          q++;
          end=strchr(q,'\"');
          if (end == NULL)
          {
            RelinquishMagickMemory(n);
            ThrowXMLException(CorruptImageError,"MalformedEntityValue");
            break;
          }
          *end='\0';
          c=(char *) AcquireQuantumMemory(strlen(q)+1,sizeof(*c));
          if (c == NULL)
          {
            RelinquishMagickMemory(n);
            ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            break;
          }
          (void) CopyMagickString(c,q,strlen(q)+1);

          // Store the entity in the predefined_entities list
          entities=(char **) AcquireQuantumMemory(NumberEntities+2,sizeof(*entities));
          if (entities == NULL)
          {
            RelinquishMagickMemory(n);
            RelinquishMagickMemory(c);
            ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            break;
          }
          for (i=0; predefined_entitites[i] != NULL; i++)
            entities[i]=predefined_entitites[i];
          entities[i++]=n;
          entities[i++]=c;
          entities[i]=NULL;
          predefined_entitites=RelinquishMagickMemory(predefined_entitites);
          predefined_entitites=entities;
        }
        else if ( strstr(start,"ATTLIST") != NULL )
        {
          // Handle ATTLIST declarations here if needed
        }
      }
      else
      {
        // Process comments or processing instructions
        end=strchr(start,'>');
        if (end == NULL)
        {
          ThrowXMLException(CorruptImageError,"InvalidDOCTYPE");
          break;
        }
        *end='\0';
      }
    }
    start=end+1;
  }
}