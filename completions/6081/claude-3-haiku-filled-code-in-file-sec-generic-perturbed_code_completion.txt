// <MASK>
char *c, *n, *t, *v;
int state = 0;

// Parse the DOCTYPE declaration
while (xml != NULL) {
    // Check for ENTITY declarations
    if (strncmp(xml, "<!ENTITY", 8) == 0) {
        xml += 8;
        xml += strspn(xml, XMLWhitespace);
        if (*xml == '%') {
            // Parameter entity
            xml++;
            xml += strspn(xml, XMLWhitespace);
            n = xml;
            xml += strcspn(xml, XMLWhitespace);
            *xml++ = '\0';
            xml += strspn(xml, XMLWhitespace);
            if (*xml != 'S' || strncmp(xml, "SYSTEM", 6) != 0) {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected SYSTEM in parameter entity declaration");
                return MagickFalse;
            }
            xml += 6;
            xml += strspn(xml, XMLWhitespace);
            if (*xml != '"' && *xml != '\'') {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing quote in parameter entity declaration");
                return MagickFalse;
            }
            q = xml++;
            xml += strcspn(xml, q);
            if (*xml != q[0]) {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing closing quote in parameter entity declaration");
                return MagickFalse;
            }
            *xml++ = '\0';
            if (ValidateEntities(n, q, 1, root->entities) == MagickFalse) {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "circular entity reference in parameter entity declaration");
                return MagickFalse;
            }
            root->entities = (char **)ResizeQuantumMemory(root->entities, (size_t)(i+3), sizeof(*root->entities));
            if (root->entities == NULL)
                ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
            root->entities[i++] = ConstantString(n);
            root->entities[i++] = ConstantString(q);
            root->entities[i] = NULL;
        } else {
            // General entity
            n = xml;
            xml += strcspn(xml, XMLWhitespace);
            *xml++ = '\0';
            xml += strspn(xml, XMLWhitespace);
            if (*xml != 'S' || strncmp(xml, "SYSTEM", 6) != 0) {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected SYSTEM in entity declaration");
                return MagickFalse;
            }
            xml += 6;
            xml += strspn(xml, XMLWhitespace);
            if (*xml != '"' && *xml != '\'') {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing quote in entity declaration");
                return MagickFalse;
            }
            q = xml++;
            xml += strcspn(xml, q);
            if (*xml != q[0]) {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing closing quote in entity declaration");
                return MagickFalse;
            }
            *xml++ = '\0';
            if (ValidateEntities(n, q, 1, root->entities) == MagickFalse) {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "circular entity reference in entity declaration");
                return MagickFalse;
            }
            root->entities = (char **)ResizeQuantumMemory(root->entities, (size_t)(i+3), sizeof(*root->entities));
            if (root->entities == NULL)
                ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
            root->entities[i++] = ConstantString(n);
            root->entities[i++] = ConstantString(q);
            root->entities[i] = NULL;
        }
    }
    // Check for ATTLIST declarations
    else if (strncmp(xml, "<!ATTLIST", 9) == 0) {
        xml += 9;
        xml += strspn(xml, XMLWhitespace);
        t = xml;
        xml += strcspn(xml, XMLWhitespace);
        *xml++ = '\0';
        xml += strspn(xml, XMLWhitespace);
        i = 0;
        while (root->attributes[i] != NULL && strcmp(root->attributes[i][0], t) != 0)
            i++;
        if (root->attributes[i] == NULL) {
            root->attributes = (char ***)ResizeQuantumMemory(root->attributes, (size_t)(i+2), sizeof(*root->attributes));
            if (root->attributes == NULL)
                ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
            root->attributes[i] = (char **)AcquireQuantumMemory(4, sizeof(**root->attributes));
            if (root->attributes[i] == NULL)
                ThrowFatalException(ResourceLimitFatalError, "MemoryAllocationFailed");
            root->attributes[i][0] = ConstantString(t);
            root->attributes[i][1] = NULL;
            root->attributes[i+1] = NULL;
        }
        j = 1;
        while (*xml != '>' && *xml != '\0') {
            xml += strspn(xml, XMLWhitespace);
            n = xml;
            xml += strcspn(xml, XMLWhitespace);
            *xml++ = '\0';
            xml += strspn(xml, XMLWhitespace);
            if (*xml == '#') {
                xml++;
                if (strncmp(xml, "REQUIRED", 8) == 0) {
                    xml += 8;
                    root->attributes[i][j++] = ConstantString(n);
                    root->attributes[i][j++] = ConstantString("REQUIRED");
                    root->attributes[i][j++] = NULL;
                } else if (strncmp(xml, "IMPLIED", 7) == 0) {
                    xml += 7;
                    root->attributes[i][j++] = ConstantString(n);
                    root->attributes[i][j++] = ConstantString("IMPLIED");
                    root->attributes[i][j++] = ConstantString("");
                } else if (strncmp(xml, "FIXED", 5) == 0) {
                    xml += 5;
                    xml += strspn(xml, XMLWhitespace);
                    if (*xml != '"' && *xml != '\'') {
                        (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing quote in FIXED attribute declaration");
                        return MagickFalse;
                    }
                    q = xml++;
                    xml += strcspn(xml, q);
                    if (*xml != q[0]) {
                        (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing closing quote in FIXED attribute declaration");
                        return MagickFalse;
                    }
                    *xml++ = '\0';
                    root->attributes[i][j++] = ConstantString(n);
                    root->attributes[i][j++] = ConstantString("FIXED");
                    root->attributes[i][j++] = ConstantString(q);
                } else {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected REQUIRED, IMPLIED, or FIXED in attribute declaration");
                    return MagickFalse;
                }
            } else if (*xml == '(') {
                xml++;
                v = xml;
                while (*xml != ')' && *xml != '\0')
                    xml++;
                if (*xml == '\0') {
                    (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "missing closing parenthesis in attribute declaration");
                    return MagickFalse;
                }
                *xml++ = '\0';
                root->attributes[i][j++] = ConstantString(n);
                root->attributes[i][j++] = ConstantString("ENUMERATION");
                root->attributes[i][j++] = ConstantString(v);
            } else {
                (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "expected #REQUIRED, #IMPLIED, #FIXED, or enumeration in attribute declaration");
                return MagickFalse;
            }
        }
        if (*xml == '\0') {
            (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed <!ATTLIST");
            return MagickFalse;
        }
        xml++;
    }
    // Check for comments and processing instructions
    else if (strncmp(xml, "<!--", 4) == 0) {
        xml = strstr(xml, "-->");
        if (xml == NULL) {
            (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed comment");
            return MagickFalse;
        }
        xml += 3;
    } else if (strncmp(xml, "<?", 2) == 0) {
        xml = strstr(xml, "?>");
        if (xml == NULL) {
            (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unclosed processing instruction");
            return MagickFalse;
        }
        xml += 2;
        ParseProcessingInstructions(root, xml - (xml - tag), (size_t)(xml - tag - 2));
    } else {
        (void) ThrowMagickException(exception, GetMagickModule(), OptionWarning, "ParseError", "unexpected content in DOCTYPE");
        return MagickFalse;
    }
    xml += strspn(xml, XMLWhitespace);
}