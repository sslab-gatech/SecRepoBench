{
  /* Loop until the DOCTYPE declaration is fully processed */
  while (*xml != '\0')
  {
    /* Skip any leading whitespace */
    while (isspace((int) *xml))
      xml++;

    /* Check for the end of DOCTYPE declaration */
    if (*xml == '>')
    {
      xml++;
      break;
    }

    /* Process ENTITY declarations */
    if (strncmp(xml, "ENTITY", 6) == 0)
    {
      xml += 6;
      while (isspace((int) *xml))
        xml++;

      /* Optionally handle parameter entity (preceded by '%') */
      MagickBooleanType is_parameter = MagickFalse;
      if (*xml == '%')
      {
        is_parameter = MagickTrue;
        xml++;
        while (isspace((int) *xml))
          xml++;
      }

      /* Parse the entity name */
      char *start = xml;
      while (*xml && !isspace((int) *xml) && *xml != '"' && *xml != '\'' && *xml != '>')
        xml++;
      if (start == xml)
        ThrowException(exception,ParseError,"MissingEntityName",xml);
      size_t name_length = xml - start;
      char *entity_name = (char *) AcquireMagickMemory(name_length+1);
      if (entity_name == (char *) NULL)
        ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
      strncpy(entity_name, start, name_length);
      entity_name[name_length] = '\0';

      /* Skip whitespace before the entity value */
      while (isspace((int) *xml))
        xml++;

      /* The entity value should be enclosed in quotes */
      char quote = *xml;
      if (quote != '"' && quote != '\'')
      {
        ThrowException(exception,ParseError,"MissingQuotesForEntityValue",entity_name);
        entity_name = DestroyString(entity_name);
        break;
      }
      xml++;
      start = xml;
      while (*xml && *xml != quote)
        xml++;
      if (*xml != quote)
      {
        ThrowException(exception,ParseError,"UnterminatedEntityValue",entity_name);
        entity_name = DestroyString(entity_name);
        break;
      }
      size_t value_length = xml - start;
      char *entity_value = (char *) AcquireMagickMemory(value_length+1);
      if (entity_value == (char *) NULL)
        ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
      strncpy(entity_value, start, value_length);
      entity_value[value_length] = '\0';
      xml++;  /* Skip closing quote */

      /* Log the parsed entity (or store it as needed) */
      (void) LogMagickEvent(TraceEvent,GetMagickModule(),
                            "Parsed %sENTITY: %s = %s",
                            is_parameter ? "parameter " : "", entity_name, entity_value);

      /* In a complete implementation, add the entity to the appropriate structure.
         For example, one might reallocate root->entities to include this new entry. */

      entity_name = DestroyString(entity_name);
      entity_value = DestroyString(entity_value);
      continue;
    }
    /* Process ATTLIST declarations */
    else if (strncmp(xml, "ATTLIST", 7) == 0)
    {
      xml += 7;
      /* For simplicity, skip processing details of ATTLIST and log its occurrence */
      char *attlist_start = xml;
      while (*xml && *xml != '>')
        xml++;
      if (*xml == '>')
        xml++;
      (void) LogMagickEvent(TraceEvent,GetMagickModule(),
                            "Parsed ATTLIST declaration: %.30s", attlist_start);
      continue;
    }
    /* Process comments and processing instructions */
    else if (strncmp(xml, "<!--", 4) == 0)
    {
      xml += 4;
      /* Skip until the end of the comment */
      char *comment_start = xml;
      while (*xml && strncmp(xml, "-->", 3) != 0)
        xml++;
      if (strncmp(xml, "-->", 3) == 0)
        xml += 3;
      (void) LogMagickEvent(TraceEvent,GetMagickModule(),
                            "Parsed comment: %.30s", comment_start);
      continue;
    }
    else if (strncmp(xml, "<?", 2) == 0)
    {
      xml += 2;
      /* Skip until the end of the processing instruction */
      char *pi_start = xml;
      while (*xml && strncmp(xml, "?>", 2) != 0)
        xml++;
      if (strncmp(xml, "?>", 2) == 0)
        xml += 2;
      (void) LogMagickEvent(TraceEvent,GetMagickModule(),
                            "Parsed processing instruction: %.30s", pi_start);
      continue;
    }
    /* If none of the above, simply advance one character */
    else
    {
      xml++;
    }
  }
}