entities=(char **) AcquireMagickMemory(sizeof(char *)*length);
  if (entities == (char **) NULL)
    ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
  index=0;
  c=xml;
  while (*c != '\0')
  {
    if (strncmp(c,"<!ENTITY",8) == 0)
    {
      c+=8;
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      if (*c == '%')
        {
          c++;
          while (isspace((int) ((unsigned char) *c)) != 0)
            c++;
        }
      t=c;
      while ((isalnum((int) ((unsigned char) *c)) != 0) || (*c == '_') || (*c == '-'))
        c++;
      if (c == t)
        continue;
      q=(*c);
      *c='\0';
      v=(char *) AcquireMagickMemory(strlen(t)+1);
      if (v == (char *) NULL)
        ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
      (void) CopyMagickString(v,t,strlen(t)+1);
      *c=q;
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      if (*c == '"')
        q='"';
      else
        if (*c == '\'')
          q='\'';
        else
          continue;
      c++;
      t=c;
      while ((*c != '\0') && (*c != q))
        c++;
      if (*c == '\0')
        continue;
      *c='\0';
      entities[index]=(char *) AcquireMagickMemory(strlen(t)+1);
      if (entities[index] == (char *) NULL)
        ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
      (void) CopyMagickString(entities[index],t,strlen(t)+1);
      *c=q;
      index++;
    }
    c++;
  }
  entities[index]=(char *) NULL;
  root->entities=entities;