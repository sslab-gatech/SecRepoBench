c=xml;
  entities=(char **) AcquireMagickMemory(sizeof(char *)*MaxEntities);
  if (entities == (char **) NULL)
    ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
  for (index=0; *c != '\0'; )
  {
    if (isspace((int) ((unsigned char) *c)) != 0)
      {
        c++;
        continue;
      }
    if (strncmp(c,"<!ENTITY",8) == 0)
      {
        c+=8;
        while (isspace((int) ((unsigned char) *c)) != 0)
          c++;
        if (*c == '%')
          {
            c++;
            while (isspace((int) ((unsigned char) *c)) != 0)
              c++;
          }
        n=c;
        while ((isalnum((int) ((unsigned char) *c)) != 0) || (*c == '_') ||
               (*c == '-') || (*c == ':'))
          c++;
        if (n == c)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionError,"InvalidEntityDeclaration","`%s'",c);
            break;
          }
        *c='\0';
        c++;
        while (isspace((int) ((unsigned char) *c)) != 0)
          c++;
        q=(*c == '"') || (*c == '\'') ? *c : '\0';
        if (q != '\0')
          c++;
        t=c;
        while ((*c != '\0') && ((*c != q) || (q == '\0')))
          c++;
        if (*c == '\0')
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionError,"UnterminatedEntityDeclaration","`%s'",n);
            break;
          }
        *c='\0';
        c++;
        v=AcquireString(t);
        if (v == (char *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              ResourceLimitError,"MemoryAllocationFailed","`%s'",n);
            break;
          }
        entities[index++]=n;
        entities[index++]=v;
        continue;
      }
    c++;
  }
  entities[index]=(char *) NULL;
  root->entities=entities;