for (xml[length]='\0'; xml != (char *) NULL; )
{
  while ((*xml != '\0') && (strncmp(xml,"<!ENTITY",8) != 0))
    xml++;
  if (*xml == '\0')
    break;
  xml+=8;
  xml+=strspn(xml,XMLWhitespace);
  n=xml;
  xml+=strcspn(xml,XMLWhitespace ">");
  if (*xml == '>')
    {
      (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
        "ParseError","malformed entity");
      return(MagickFalse);
    }
  *xml='\0';
  xml+=strspn(xml+1,XMLWhitespace)+1;
  q=(*xml == '"') ? '"' : (*xml == '\'') ? '\'' : '\0';
  if (q != '\0')
    xml++;
  t=xml;
  while ((*xml != '\0') && (*xml != q) && (*xml != '>'))
    xml++;
  if (*xml == '\0')
    {
      (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
        "ParseError","malformed entity");
      return(MagickFalse);
    }
  *xml='\0';
  v=ParseEntities(t,predefined_entitites,0);
  if (v == (char *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
        "MemoryAllocationFailed","`%s'","");
      return(MagickFalse);
    }
  for (i=0; predefined_entitites[i] != (char *) NULL; i+=2)
  {
    if (LocaleCompare(predefined_entitites[i],n) == 0)
      {
        if (LocaleCompare(predefined_entitites[i+1],v) != 0)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
              "ParseError","conflicting entity");
            v=DestroyString(v);
            return(MagickFalse);
          }
        v=DestroyString(v);
        break;
      }
  }
  if (predefined_entitites[i] == (char *) NULL)
    {
      predefined_entitites=(char **) ResizeQuantumMemory(predefined_entitites,
        (i+4),sizeof(*predefined_entitites));
      if (predefined_entitites == (char **) NULL)
        {
          v=DestroyString(v);
          return(MagickFalse);
        }
      predefined_entitites[i]=ConstantString(n);
      predefined_entitites[i+1]=v;
      predefined_entitites[i+2]=(char *) NULL;
      predefined_entitites[i+3]=(char *) NULL;
    }
  xml++;
  while ((*xml != '\0') && (*xml != '>'))
    xml++;
  if (*xml != '\0')
    xml++;
}