// <MASK>
// Allocate memory for the entities array
entities = (char **)AcquireMagickMemory(sizeof(char *) * (length + 1));
if (entities == NULL) {
    ThrowFatalException(ResourceLimitError, "MemoryAllocationFailed");
}

// Initialize the entities array
for (i = 0; i < length; i++) {
    entities[i] = NULL;
}
entities[length] = NULL;

// Parse the XML string and process the different components of the DOCTYPE declaration
c = xml;
q = '\0';
index = 0;
while (*c != '\0') {
    // Handle ENTITY declarations
    if (strncmp(c, "<!ENTITY", 8) == 0) {
        c += 8;
        while (*c == ' ' || *c == '\t') {
            c++;
        }
        if (*c == '%') {
            // Parameter entity
            c++;
            while (*c == ' ' || *c == '\t') {
                c++;
            }
            n = c;
            while (*c != ' ' && *c != '\t' && *c != '\n' && *c != '>' && *c != '\0') {
                c++;
            }
            *c = '\0';
            entities[index++] = ConstantString(n);
            c++;
        } else {
            // General entity
            n = c;
            while (*c != ' ' && *c != '\t' && *c != '\n' && *c != '>' && *c != '\0') {
                c++;
            }
            *c = '\0';
            entities[index++] = ConstantString(n);
            c++;
        }
    }
    // Handle ATTLIST declarations
    else if (strncmp(c, "<!ATTLIST", 9) == 0) {
        c += 9;
        while (*c == ' ' || *c == '\t') {
            c++;
        }
        n = c;
        while (*c != ' ' && *c != '\t' && *c != '\n' && *c != '>' && *c != '\0') {
            c++;
        }
        *c = '\0';
        // Parse and store default attributes, managing memory for new attribute tags as necessary
        c++;
    }
    // Handle comments and processing instructions
    else if (*c == '<') {
        if (strncmp(c, "<!--", 4) == 0) {
            // Comment
            c += 4;
            while (*c != '>' && *c != '\0') {
                c++;
            }
            if (*c == '>') {
                c++;
            }
        } else if (strncmp(c, "<?", 2) == 0) {
            // Processing instruction
            c += 2;
            while (*c != '>' && *c != '\0') {
                c++;
            }
            if (*c == '>') {
                c++;
            }
        } else {
            // Malformed or incomplete declaration, handle appropriately
            ThrowException(exception, CorruptImageError, "MalformedXMLDeclaration", xml);
            break;
        }
    }
    // Handle other components of the DOCTYPE declaration
    else {
        c++;
    }
}

// Free the entities array
for (i = 0; entities[i] != NULL; i++) {
    entities[i] = DestroyString(entities[i]);
}
entities = (char **)RelinquishMagickMemory(entities);
// </MASK>