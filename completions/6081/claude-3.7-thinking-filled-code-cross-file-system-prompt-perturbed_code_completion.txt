c=xml;
while ((c != (char *) NULL) && (*c != '\0'))
{
  while (isspace((int) ((unsigned char) *c)) != 0)
    c++;
  if (*c == '\0')
    break;
  if (strncmp(c,"<!--",4) == 0)
    {
      for (c+=4; (strncmp(c,"-->",3) != 0) && (*c != '\0'); c++);
      if (*c != '\0')
        c+=3;
      continue;
    }
  if (strncmp(c,"<?",2) == 0)
    {
      for (c+=2; (strncmp(c,"?>",2) != 0) && (*c != '\0'); c++);
      if (*c != '\0')
        c+=2;
      continue;
    }
  if (strncmp(c,"<!ENTITY",8) == 0)
    {
      c+=8;
      if (isspace((int) ((unsigned char) *c)) == 0)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
            "ParseError","unexpected token in <!ENTITY");
          break;
        }
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      if (*c == '%')
        {
          for ( ; (*c != ';') && (*c != '\0'); c++);
          if (*c != '\0')
            c++;
          continue;
        }
      n=c;
      while ((isalnum((int) ((unsigned char) *c)) != 0) || (*c == '_') || 
             (*c == '-') || (*c == ':'))
        c++;
      if (n == c)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
            "ParseError","entity name missing");
          break;
        }
      *c='\0';
      t=n;
      n=ConstantString(n);
      *c='X';
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      if ((*c != '"') && (*c != '\''))
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
            "ParseError","entity value missing");
          break;
        }
      q=(*c);
      c++;
      v=c;
      while ((*c != q) && (*c != '\0'))
        c++;
      if (*c == '\0')
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
            "ParseError","unexpected end of entity value");
          break;
        }
      *c='\0';
      v=ConstantString(v);
      *c=q;
      c++;
      for (i=0; predefined_entitites[i] != (char *) NULL; i+=2);
      index=(i+2);
      entities=(char **) ResizeQuantumMemory(predefined_entitites,(size_t) index+1,
        sizeof(*predefined_entitites));
      if (entities == (char **) NULL)
        {
          n=DestroyString(n);
          v=DestroyString(v);
          (void) ThrowMagickException(exception,GetMagickModule(),
            ResourceLimitError,"MemoryAllocationFailed","`%s'",
            "entities");
          break;
        }
      predefined_entitites=entities;
      predefined_entitites[i]=n;
      predefined_entitites[i+1]=v;
      predefined_entitites[index]=(char *) NULL;
      root->entities=predefined_entitites;
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      if (*c == '>')
        c++;
      continue;
    }
  if (strncmp(c,"<!ATTLIST",9) == 0)
    {
      char
        **attribute;

      c+=9;
      if (isspace((int) ((unsigned char) *c)) == 0)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
            "ParseError","unexpected token in <!ATTLIST");
          break;
        }
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      n=c;
      while ((isalnum((int) ((unsigned char) *c)) != 0) || (*c == '_') || 
             (*c == '-') || (*c == ':'))
        c++;
      if (n == c)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
            "ParseError","attribute name missing");
          break;
        }
      *c='\0';
      t=ConstantString(n);
      *c='X';
      while ((*c != '>') && (*c != '\0'))
        {
          while ((isspace((int) ((unsigned char) *c)) != 0) || (*c == '\n'))
            c++;
          if (*c == '>')
            break;
          n=c;
          while ((isalnum((int) ((unsigned char) *c)) != 0) || (*c == '_') || 
                 (*c == '-') || (*c == ':'))
            c++;
          if (n == c)
            break;
          while ((*c != '\'') && (*c != '"') && (*c != '\0') && 
                 (isspace((int) ((unsigned char) *c)) == 0))
            c++;
          while (isspace((int) ((unsigned char) *c)) != 0)
            c++;
          if ((*c != '\'') && (*c != '"'))
            continue;
          q=(*c++);
          v=c;
          while ((*c != q) && (*c != '\0'))
            c++;
          if (*c == '\0')
            break;
          *c='\0';
          for (i=0; sentinel[i] != (char *) NULL; i+=3);
          attribute=(char **) ResizeQuantumMemory(root->attributes,(size_t) (i+5),
            sizeof(*root->attributes));
          if (attribute == (char **) NULL)
            {
              t=DestroyString(t);
              (void) ThrowMagickException(exception,GetMagickModule(),
                ResourceLimitError,"MemoryAllocationFailed","`%s'",
                "attributes");
              break;
            }
          root->attributes=attribute;
          root->attributes[i]=t;
          root->attributes[i+1]=ConstantString(n);
          root->attributes[i+2]=ConstantString(v);
          root->attributes[i+3]=(char *) NULL;
          root->attributes[i+4]=(char *) NULL;
          *c=q;
          c++;
        }
      if (*c == '>')
        c++;
      continue;
    }
  if (strncmp(c,"<!ELEMENT",9) == 0)
    {
      for ( ; (*c != '>') && (*c != '\0'); c++);
      if (*c == '>')
        c++;
      continue;
    }
  if (strncmp(c,"<!NOTATION",10) == 0)
    {
      for ( ; (*c != '>') && (*c != '\0'); c++);
      if (*c == '>')
        c++;
      continue;
    }
  if (*c == ']')
    {
      c++;
      while (isspace((int) ((unsigned char) *c)) != 0)
        c++;
      if (*c == '>')
        {
          c++;
          break;
        }
    }
  if (*c == '>')
    {
      c++;
      break;
    }
  c++;
  xml=c;