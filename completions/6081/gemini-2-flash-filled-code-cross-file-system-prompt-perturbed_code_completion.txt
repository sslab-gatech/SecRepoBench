c=xml;
    while ((c=GetStringToken(c,"<!",">",&t)) != (char *) NULL)
    {
      if (LocaleNCompare(t,"ENTITY",6) == 0)
        {
          /*
            ENTITY.
          */
          char
            *entity,
            *name;

          size_t
            length;

          t+=6;
          while (isspace((int) (*t)) != 0)
            t++;
          if (*t == '%')
            {
              /*
                Parameter entity.
              */
              t++;
              while (isspace((int) (*t)) != 0)
                t++;
              name=t;
              while ((isalnum((int) (*t)) != 0) || (*t == '-') || (*t == '_') ||
                     (*t == '.'))
                t++;
              length=(size_t) (t-name);
              entity=AcquireString((char *) NULL);
              (void) CopyMagickString(entity,name,length+1);
              while (isspace((int) (*t)) != 0)
                t++;
              if (*t == '"')
                q='"';
              else
                if (*t == '\'')
                  q='\'';
                else
                  q='\0';
              if (q != '\0')
                t++;
              name=t;
              while (((*t != q) && (*t != '\0')) &&
                     ((t-xml) < (ssize_t) length))
                t++;
              length=(size_t) (t-name);
              if (q != '\0')
                t++;
              if ((length == 0) || ((t-xml) >= (ssize_t) length))
                {
                  entity=DestroyString(entity);
                  ThrowException(exception,XMLTreeError,"InvalidParameterEntity",
                    xml);
                  return(MagickFalse);
                }
              v=AcquireString((char *) NULL);
              (void) CopyMagickString(v,name,length+1);
              /*
                Check for circular definition.
              */
              for (i=0; root->entities[i] != (char *) NULL; i+=2)
                if (LocaleCompare(root->entities[i],entity) == 0)
                  {
                    entity=DestroyString(entity);
                    v=DestroyString(v);
                    ThrowException(exception,XMLTreeError,
                      "CircularParameterEntity",xml);
                    return(MagickFalse);
                  }
              /*
                Add parameter entity.
              */
              for (i=0; root->entities[i] != (char *) NULL; i+=2) ;
              entities=(char **) AcquireMagickMemory((size_t) (i+3)*
                sizeof(*entities));
              if (entities == (char **) NULL)
                {
                  entity=DestroyString(entity);
                  v=DestroyString(v);
                  ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
                }
              (void) CopyMagickMemory(entities,root->entities,(size_t) (i+1)*
                sizeof(*entities));
              entities[i]=entity;
              entities[i+1]=v;
              entities[i+2]=(char *) NULL;
              root->entities=(char **) RelinquishMagickMemory(root->entities);
              root->entities=entities;
            }
          else
            {
              /*
                General entity.
              */
              name=t;
              while ((isalnum((int) (*t)) != 0) || (*t == '-') || (*t == '_') ||
                     (*t == '.'))
                t++;
              length=(size_t) (t-name);
              entity=AcquireString((char *) NULL);
              (void) CopyMagickString(entity,name,length+1);
              while (isspace((int) (*t)) != 0)
                t++;
              if (*t == '"')
                q='"';
              else
                if (*t == '\'')
                  q='\'';
                else
                  q='\0';
              if (q != '\0')
                t++;
              name=t;
              while (((*t != q) && (*t != '\0')) &&
                     ((t-xml) < (ssize_t) length))
                t++;
              length=(size_t) (t-name);
              if (q != '\0')
                t++;
              if ((length == 0) || ((t-xml) >= (ssize_t) length))
                {
                  entity=DestroyString(entity);
                  ThrowException(exception,XMLTreeError,"InvalidGeneralEntity",
                    xml);
                  return(MagickFalse);
                }
              v=AcquireString((char *) NULL);
              (void) CopyMagickString(v,name,length+1);
              /*
                Check for circular definition.
              */
              for (i=0; predefined_entitites[i] != (char *) NULL; i+=2)
                if (LocaleCompare(predefined_entitites[i],entity) == 0)
                  {
                    entity=DestroyString(entity);
                    v=DestroyString(v);
                    ThrowException(exception,XMLTreeError,
                      "CircularGeneralEntity",xml);
                    return(MagickFalse);
                  }
              /*
                Add general entity.
              */
              for (i=0; predefined_entitites[i] != (char *) NULL; i+=2) ;
              entities=(char **) AcquireMagickMemory((size_t) (i+3)*
                sizeof(*entities));
              if (entities == (char **) NULL)
                {
                  entity=DestroyString(entity);
                  v=DestroyString(v);
                  ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
                }
              (void) CopyMagickMemory(entities,predefined_entitites,(size_t) (i+1)*
                sizeof(*entities));
              entities[i]=entity;
              entities[i+1]=v;
              entities[i+2]=(char *) NULL;
              predefined_entitites=(char **) RelinquishMagickMemory(predefined_entitites);
              predefined_entitites=entities;
            }
        }
      else
        if (LocaleNCompare(t,"ATTLIST",7) == 0)
          {
            /*
              ATTLIST.
            */
            char
              *attribute,
              *tag;

            size_t
              length;

            t+=7;
            while (isspace((int) (*t)) != 0)
              t++;
            tag=t;
            while ((isalnum((int) (*t)) != 0) || (*t == '-') || (*t == '_') ||
                   (*t == '.'))
              t++;
            length=(size_t) (t-tag);
            if (length == 0)
              {
                ThrowException(exception,XMLTreeError,"InvalidAttlist",xml);
                return(MagickFalse);
              }
            n=AcquireString((char *) NULL);
            (void) CopyMagickString(n,tag,length+1);
            while (isspace((int) (*t)) != 0)
              t++;
            attribute=t;
            while ((isalnum((int) (*t)) != 0) || (*t == '-') || (*t == '_') ||
                   (*t == '.'))
              t++;
            length=(size_t) (t-attribute);
            if (length == 0)
              {
                n=DestroyString(n);
                ThrowException(exception,XMLTreeError,"InvalidAttribute",xml);
                return(MagickFalse);
              }
            v=AcquireString((char *) NULL);
            (void) CopyMagickString(v,attribute,length+1);
            /*
              Add default attribute.
            */
            for (i=0; root->attributes[i] != (char **) NULL; i++)
            {
              if (LocaleCompare(root->attributes[i][0],n) == 0)
                break;
            }
            if (root->attributes[i] == (char **) NULL)
              {
                /*
                  Allocate new attribute tag.
                */
                for (i=0; root->attributes[i] != (char **) NULL; i++) ;
                entities=(char ***) AcquireMagickMemory((size_t) (i+2)*
                  sizeof(*entities));
                if (entities == (char ***) NULL)
                  ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
                (void) CopyMagickMemory(entities,root->attributes,(size_t) (i+1)*
                  sizeof(*entities));
                entities[i]=(char **) NULL;
                entities[i+1]=(char **) NULL;
                root->attributes=(char ***) RelinquishMagickMemory(root->attributes);
                root->attributes=entities;
                root->attributes[i]=(char **) AcquireMagickMemory(3*
                  sizeof(**entities));
                if (root->attributes[i] == (char **) NULL)
                  ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
                root->attributes[i][0]=ConstantString(n);
                root->attributes[i][1]=(char *) NULL;
                root->attributes[i][2]=(char *) NULL;
              }
            /*
              Add attribute.
            */
            for (index=1; root->attributes[i][index] != (char *) NULL; index++) ;
            entities=(char **) AcquireMagickMemory((size_t) (index+2)*
              sizeof(*entities));
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            (void) CopyMagickMemory(entities,root->attributes[i],(size_t) (index+1)*
              sizeof(*entities));
            entities[index]=ConstantString(v);
            entities[index+1]=(char *) NULL;
            root->attributes[i]=(char **) RelinquishMagickMemory(
              root->attributes[i]);
            root->attributes[i]=entities;
            n=DestroyString(n);
            v=DestroyString(v);
          }
        else
          if (LocaleNCompare(t,"--",2) == 0)
            {
              /*
                Comment.
              */
              t+=2;
              while (isspace((int) (*t)) != 0)
                t++;
              while ((LocaleNCompare(t,"--",2) != 0) && (*t != '\0'))
                t++;
              if (*t == '\0')
                {
                  ThrowException(exception,XMLTreeError,"UnterminatedComment",
                    xml);
                  return(MagickFalse);
                }
              t+=2;
            }
          else
            if (*t == '?')
              {
                /*
                  Processing instruction.
                */
                char
                  **instructions;

                ssize_t
                  j;

                /*
                  Add processing instruction.
                */
                for (i=0; root->processing_instructions[i] != (char **) NULL; i++) ;
                entities=(char ***) AcquireMagickMemory((size_t) (i+2)*
                  sizeof(*entities));
                if (entities == (char ***) NULL)
                  ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
                (void) CopyMagickMemory(entities,root->processing_instructions,
                  (size_t) (i+1)*sizeof(*entities));
                entities[i]=(char **) NULL;
                entities[i+1]=(char **) NULL;
                root->processing_instructions=(char ***) RelinquishMagickMemory(
                  root->processing_instructions);
                root->processing_instructions=entities;
                root->processing_instructions[i]=(char **) AcquireMagickMemory(
                  3*sizeof(**entities));
                if (root->processing_instructions[i] == (char **) NULL)
                  ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
                root->processing_instructions[i][0]=AcquireString((char *) NULL);
                root->processing_instructions[i][1]=(char *) NULL;
                root->processing_instructions[i][2]=(char *) NULL;
                t++;
                name=t;
                while ((isalnum((int) (*t)) != 0) || (*t == '-') || (*t == '_') ||
                       (*t == '.'))
                  t++;
                length=(size_t) (t-name);
                (void) CopyMagickString(root->processing_instructions[i][0],name,
                  length+1);
                while ((*t != '?') && (*t != '\0'))
                  t++;
                if (*t == '\0')
                  {
                    ThrowException(exception,XMLTreeError,
                      "UnterminatedProcessingInstruction",xml);
                    return(MagickFalse);
                  }
                *t='\0';
                t++;
                if (*t != '>')
                  {
                    ThrowException(exception,XMLTreeError,
                      "UnterminatedProcessingInstruction",xml);
                    return(MagickFalse);