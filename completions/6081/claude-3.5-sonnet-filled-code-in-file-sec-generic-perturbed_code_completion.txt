for (xml[length]='\0'; xml != (char *) NULL; )
{
  while ((*xml != '\0') && (strncmp(xml,"<!ENTITY",8) != 0) &&
         (strncmp(xml,"<!ATTLIST",9) != 0) && (strncmp(xml,"<!--",4) != 0) &&
         (strncmp(xml,"<?",2) != 0))
    xml++;
  if (*xml == '\0')
    break;
  if (strncmp(xml,"<!ENTITY",8) == 0)
  {
    /* Parse entity definition */
    xml+=8;
    xml+=strspn(xml,XMLWhitespace);
    n=xml;
    while ((*xml != '\0') && (isalnum((int) ((unsigned char) *xml)) ||
           (*xml == '_') || (*xml == '-') || (*xml == '.')))
      xml++;
    if (*xml == '%')
      xml++;
    if ((xml-n > 0) && (*xml != '\0'))
    {
      *xml='\0';
      t=n;
      xml++;
      xml+=strspn(xml,XMLWhitespace);
      q=(*xml);
      xml++;
      v=xml;
      while ((*xml != '\0') && (*xml != q))
        xml++;
      if (*xml != '\0')
      {
        *xml++='\0';
        v=ParseEntities(v,predefined_entitites,0);
        if (t == n)
          {
            /* General entity */
            (void) AddChildToXMLTree(root,t,v);
          }
        else
          {
            /* Parameter entity */
            i=0;
            while ((predefined_entitites[i] != (char *) NULL) &&
                   (strcmp(predefined_entitites[i],n) != 0))
              i+=2;
            if (predefined_entitites[i] == (char *) NULL)
              {
                predefined_entitites=(char **) ResizeQuantumMemory(
                  predefined_entitites,(size_t) (i+4),sizeof(*predefined_entitites));
                if (predefined_entitites == (char **) NULL)
                  ThrowFatalException(ResourceLimitFatalError,
                    "MemoryAllocationFailed");
                predefined_entitites[i]=ConstantString(n);
                predefined_entitites[i+1]=ConstantString(v);
                predefined_entitites[i+2]=(char *) NULL;
                predefined_entitites[i+3]=(char *) NULL;
              }
          }
        v=DestroyString(v);
      }
    }
  }
  else if (strncmp(xml,"<!ATTLIST",9) == 0)
  {
    /* Parse attribute list definition */
    xml+=9;
    xml+=strspn(xml,XMLWhitespace);
    n=xml;
    while ((*xml != '\0') && (*xml != '\n') && (*xml != '>'))
      xml++;
    if (*xml != '\0')
    {
      *xml++='\0';
      /* Add attribute to default attributes list */
      for (i=0; root->attributes[i] != (char **) NULL; i++);
      root->attributes=(char ***) ResizeQuantumMemory(root->attributes,
        (size_t) (i+2),sizeof(*root->attributes));
      if (root->attributes == (char ***) NULL)
        ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
      root->attributes[i]=StringToStringInfo(n);
      root->attributes[i+1]=(char **) NULL;
    }
  }
  else if (strncmp(xml,"<!--",4) == 0)
    {
      /* Skip comments */
      xml=strstr(xml+4,"-->");
      if (xml != (char *) NULL)
        xml+=3;
    }
  else if (strncmp(xml,"<?",2) == 0)
    {
      /* Processing instructions */
      xml+=2;
      xml+=strspn(xml,XMLWhitespace);
      n=xml;
      while ((*xml != '\0') && (*xml != '?'))
        xml++;
      if (*xml != '\0')
      {
        *xml++='\0';
        ParseProcessingInstructions(root,n,(size_t) (xml-n));
      }
    }
}