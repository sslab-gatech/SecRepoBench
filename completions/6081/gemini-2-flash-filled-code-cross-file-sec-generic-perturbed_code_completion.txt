xml=strchr(xml,'[');
    if (xml == (char *) NULL)
      break;
    xml++;
    c=xml;
    while (isspace((int) (*c)) != 0)
      c++;
    if (LocaleNCompare(c,"ENTITY",6) == 0)
      {
        /*
          Parse entity.
        */
        MagickBooleanType
          parameter_entity;

        parameter_entity=MagickFalse;
        c+=6;
        while (isspace((int) (*c)) != 0)
          c++;
        if (*c == '%')
          {
            parameter_entity=MagickTrue;
            c++;
            while (isspace((int) (*c)) != 0)
              c++;
          }
        n=c;
        while ((isalnum((int) (*c)) != 0) || (*c == '-') || (*c == '_') ||
               (*c == '.'))
          c++;
        q=(*c);
        *c='\0';
        v=c+1;
        if (q != ' ')
          {
            *c=q;
            xml=strchr(c,']');
            if (xml == (char *) NULL)
              break;
            xml++;
            continue;
          }
        while (isspace((int) (*v)) != 0)
          v++;
        if (*v == '"')
          {
            v++;
            t=v;
            while ((*v != '"') && (*v != '\0'))
              v++;
            if (*v == '\0')
              {
                *c=q;
                xml=strchr(c,']');
                if (xml == (char *) NULL)
                  break;
                xml++;
                continue;
              }
            *v='\0';
            v=InterpretLocale(t,(char **) NULL,exception);
            if (v == (char *) NULL)
              v=ConstantString(t);
            *c=q;
            c=xml;
            xml=strchr(c,']');
            if (xml == (char *) NULL)
              {
                v=DestroyString(v);
                break;
              }
            xml++;
            if (parameter_entity != MagickFalse)
              {
                v=DestroyString(v);
                continue;
              }
            /*
              Check for circular entity definition.
            */
            for (i=0; predefined_entitites[i] != (char *) NULL; i+=2)
              if (LocaleCompare(n,predefined_entitites[i]) == 0)
                ThrowXMLWarningException(XMLWarning,"CircularEntityReference",
                  xml);
            index=0;
            for (i=0; root->entities[index] != (char *) NULL; i+=2)
            {
              if (LocaleCompare(n,root->entities[index]) == 0)
                {
                  root->entities[index+1]=DestroyString(
                    root->entities[index+1]);
                  root->entities[index+1]=v;
                  break;
                }
              index+=2;
            }
            if (root->entities[index] == (char *) NULL)
              {
                entities=(char **) AcquireMagickMemory((size_t) (index+3)*
                  sizeof(*entities));
                if (entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitError,
                    "MemoryAllocationFailed");
                (void) CopyMagickMemory(entities,root->entities,(size_t) (index+1)*
                  sizeof(*entities));
                entities[index]=ConstantString(n);
                entities[index+1]=v;
                entities[index+2]=(char *) NULL;
                root->entities=(char **) RelinquishMagickMemory(root->entities);
                root->entities=entities;
              }
            continue;
          }
        if (*v == '\'')
          {
            v++;
            t=v;
            while ((*v != '\'') && (*v != '\0'))
              v++;
            if (*v == '\0')
              {
                *c=q;
                xml=strchr(c,']');
                if (xml == (char *) NULL)
                  break;
                xml++;
                continue;
              }
            *v='\0';
            v=InterpretLocale(t,(char **) NULL,exception);
            if (v == (char *) NULL)
              v=ConstantString(t);
            *c=q;
            c=xml;
            xml=strchr(c,']');
            if (xml == (char *) NULL)
              {
                v=DestroyString(v);
                break;
              }
            xml++;
            if (parameter_entity != MagickFalse)
              {
                v=DestroyString(v);
                continue;
              }
            /*
              Check for circular entity definition.
            */
            for (i=0; predefined_entitites[i] != (char *) NULL; i+=2)
              if (LocaleCompare(n,predefined_entitites[i]) == 0)
                ThrowXMLWarningException(XMLWarning,"CircularEntityReference",
                  xml);
            index=0;
            for (i=0; root->entities[index] != (char *) NULL; i+=2)
            {
              if (LocaleCompare(n,root->entities[index]) == 0)
                {
                  root->entities[index+1]=DestroyString(
                    root->entities[index+1]);
                  root->entities[index+1]=v;
                  break;
                }
              index+=2;
            }
            if (root->entities[index] == (char *) NULL)
              {
                entities=(char **) AcquireMagickMemory((size_t) (index+3)*
                  sizeof(*entities));
                if (entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitError,
                    "MemoryAllocationFailed");
                (void) CopyMagickMemory(entities,root->entities,(size_t) (index+1)*
                  sizeof(*entities));
                entities[index]=ConstantString(n);
                entities[index+1]=v;
                entities[index+2]=(char *) NULL;
                root->entities=(char **) RelinquishMagickMemory(root->entities);
                root->entities=entities;
              }
            continue;
          }
        *c=q;
        xml=strchr(c,']');
        if (xml == (char *) NULL)
          break;
        xml++;
        continue;
      }
    if (LocaleNCompare(c,"ATTLIST",7) == 0)
      {
        /*
          Parse attribute list.
        */
        c+=7;
        while (isspace((int) (*c)) != 0)
          c++;
        n=c;
        while ((isalnum((int) (*c)) != 0) || (*c == '-') || (*c == '_') ||
               (*c == '.'))
          c++;
        q=(*c);
        *c='\0';
        *c=q;
        c=xml;
        xml=strchr(c,']');
        if (xml == (char *) NULL)
          break;
        xml++;
        continue;
      }
    if (LocaleNCompare(c,"ELEMENT",7) == 0)
      {
        c+=7;
        while (isspace((int) (*c)) != 0)
          c++;
        n=c;
        while ((isalnum((int) (*c)) != 0) || (*c == '-') || (*c == '_') ||
               (*c == '.'))
          c++;
        q=(*c);
        *c='\0';
        *c=q;
        c=xml;
        xml=strchr(c,']');
        if (xml == (char *) NULL)
          break;
        xml++;
        continue;
      }
    c=xml;
    xml=strchr(c,']');
    if (xml == (char *) NULL)
      break;
    xml++;