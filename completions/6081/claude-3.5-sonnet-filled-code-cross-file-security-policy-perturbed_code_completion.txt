while (*xml != '\0' && strncmp(xml, "]>", 2) != 0)
{
  if (length < 9)  // Minimum length for a valid entity declaration
    break;

  c = xml;
  if (strncmp(c, "<!ENTITY", 8) == 0)
  {
    c += 8;
    while (isspace((int) ((unsigned char) *c)))
      c++;
    n = c;
    while (isalnum((int) ((unsigned char) *c)) || (*c == '_') || (*c == '-'))
      c++;
    if (n == c)
      break;
    if (isspace((int) ((unsigned char) *c)))
      *c++ = '\0';
    else
      break;
    while (isspace((int) ((unsigned char) *c)))
      c++;
    q = (*c);
    if ((q != '"') && (q != '\''))
      break;
    c++;
    t = c;
    while ((*c != '\0') && (*c != q))
      c++;
    if (*c == '\0')
      break;
    *c++ = '\0';
    v = ConstantString(t);
    entities = (char **) ResizeQuantumMemory(root->entities,
      (root->number_entities+2),sizeof(*root->entities));
    if (entities == (char **) NULL)
    {
      v=DestroyString(v);
      break;
    }
    root->entities = entities;
    root->entities[root->number_entities++] = ConstantString(n);
    root->entities[root->number_entities] = v;
    xml = c;
  }
  else if (strncmp(c, "<!ATTLIST", 9) == 0)
  {
    // Process ATTLIST declarations
    // (Simplified for brevity, expand as needed)
    while (*c != '>' && *c != '\0')
      c++;
    if (*c == '\0')
      break;
    xml = c + 1;
  }
  else if (strncmp(c, "<!--", 4) == 0)
  {
    // Skip comments
    c += 4;
    while (strncmp(c, "-->", 3) != 0 && *c != '\0')
      c++;
    if (*c == '\0')
      break;
    xml = c + 3;
  }
  else if (strncmp(c, "<?", 2) == 0)
  {
    // Skip processing instructions
    c += 2;
    while (strncmp(c, "?>", 2) != 0 && *c != '\0')
      c++;
    if (*c == '\0')
      break;
    xml = c + 2;
  }
  else
  {
    // Skip unknown content
    xml++;
  }

  length = strlen(xml);
}

if (*xml == '\0')
{
  (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
    "ParseError","Unterminated DOCTYPE declaration");
  return(MagickFalse);
}