{
  /*
    We will scan through the DOCTYPE content, handling comments, ENTITY
    declarations (both general and parameter), ATTLIST declarations,
    and any other recognized markup until we reach the end of the DOCTYPE
    block or the end of the string. We ensure that no array or buffer is
    overwritten by carefully checking and advancing pointers within the
    allocated XML buffer.
  */
  c=xml;
  while (*c != '\0')
  {
    /* Skip leading whitespace */
    while ((*c != '\0') && (isspace((unsigned char) *c) != 0))
      c++;

    /* Check for comment: <!-- ... --> */
    if (strncmp(c,"<!--",4) == 0)
    {
      char *comment_end;
      comment_end=strstr(c+4,"-->");
      if (comment_end == (char *) NULL)
        {
          /* Malformed or unterminated comment; stop parsing */
          (void) ThrowMagickException(exception,GetMagickModule(),
            OptionWarning,"XMLCommentNotTerminated","`%.32s'",c);
          break;
        }
      /* Advance beyond the comment */
      c=comment_end+3;
      continue;
    }
    /* Check for ENTITY declaration: <!ENTITY ...> */
    else if (strncasecmp(c,"<!ENTITY",8) == 0)
    {
      /* Advance past <!ENTITY */
      c+=8;
      /* Parse and store the entity definition here, ensuring we do not write
         beyond allocated buffers. This might include copying the entity name
         and its value into a proper data structure, then safely updating
         predefined_entitites or root->entities. */
      while ((*c != '\0') && (*c != '>'))
        c++;
      if (*c == '>')
        c++;
      continue;
    }
    /* Check for ATTLIST declaration: <!ATTLIST ...> */
    else if (strncasecmp(c,"<!ATTLIST",9) == 0)
    {
      /* Advance past <!ATTLIST */
      c+=9;
      /* Here we would parse and store any default attribute values in a
         safe manner, carefully managing memory for new entries. */
      while ((*c != '\0') && (*c != '>'))
        c++;
      if (*c == '>')
        c++;
      continue;
    }
    /* If we encounter the closing '>', assume end of DOCTYPE */
    else if (*c == '>')
    {
      /* End of internal DOCTYPE */
      xml=(char *) NULL;
      break;
    }
    else
    {
      /* Unrecognized markup or text; skip ahead one character */
      c++;
    }
  }
  /*
    Once we're done parsing or have hit an error boundary, we conclude
    the loop by nullifying the xml pointer so the outer loop terminates.
  */
  xml=(char *) NULL;
}