{
    char *p = xml;
    char *end;
    MagickBooleanType
      status = MagickTrue;

    /* Loop through all tokens within the DOCTYPE's internal subset. */
    while ((*p != '\0') && (status != MagickFalse))
      {
        /* Skip any leading whitespace. */
        while (isspace((int) (unsigned char) *p) != 0)
          p++;
        /* If we've reached the end or found ']', we're done. */
        if ((*p == '\0') || (*p == ']'))
          break;

        /* Handle comments: <!-- ... --> */
        if (strncmp(p,"!--",3) == 0)
          {
            end=strstr(p+3,"--");
            if ((end == (char *) NULL) || (*(end+2) != '>'))
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","unclosed <!--");
                return(MagickFalse);
              }
            p=end+3;
            continue;
          }
        /* Handle ENTITY declarations: <!ENTITY ...> */
        else if (strncmp(p,"!ENTITY",7) == 0)
          {
            p += 7;
            while (isspace((int) (unsigned char) *p) != 0)
              p++;
            /* Parse and store the entity, handle param vs. general entity. */
            status=ParseDoctypeEntity(root,&p,predefined_entitites,exception);
            if (status == MagickFalse)
              return(MagickFalse);
            continue;
          }
        /* Handle ATTLIST declarations: <!ATTLIST ...> */
        else if (strncmp(p,"!ATTLIST",8) == 0)
          {
            p += 8;
            while (isspace((int) (unsigned char) *p) != 0)
              p++;
            /* Parse and store any default attributes. */
            status=ParseDoctypeAttlist(root,&p,exception);
            if (status == MagickFalse)
              return(MagickFalse);
            continue;
          }
        /* Handle processing instructions: <? ... ?> */
        else if (*p == '?')
          {
            /* Find the end of the processing instruction. */
            char *pi_end=strstr(p+1,"?>");
            if (pi_end == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","unclosed <?");
                return(MagickFalse);
              }
            ParseProcessingInstructions(root,p+1,(size_t) (pi_end - (p+1)));
            p=pi_end+2;
            continue;
          }
        /* Otherwise, skip unknown directives or content until next whitespace. */
        end=p+strcspn(p,XMLWhitespace "[]>");
        if (*end == '\0')
          p=end;
        else
          p=end+1;
      }
  }