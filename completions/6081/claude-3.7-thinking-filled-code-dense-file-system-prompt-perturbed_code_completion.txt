c=(*xml);
while (*xml != '\0')
{
    if ((*xml == '<') || (*xml == ' '))
    {
        /*
          Skip whitespace.
        */
        xml++;
        continue;
    }
    if ((*xml == '%') && (*(xml+1) != '\0'))
    {
        /*
          Parameter entity.
        */
        xml++;
        n=xml;
        while ((*xml != '\0') && (*xml != ';') && (*xml != '\n'))
          xml++;
        if (*xml == '\0')
          break;
        if (*xml != ';')
          {
            /*
              Skip past malformed entity.
            */
            xml++;
            continue;
          }
        *xml='\0';
        xml++;
        entities=(char **) ResizeQuantumMemory(predefined_entitites,(size_t)
          (i+3),sizeof(*entities));
        if (entities == (char **) NULL)
          ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
        predefined_entitites=entities;
        entities[i]=ConstantString(n);
        entities[i+1]=(char *) NULL;
        entities[i+2]=(char *) NULL;
        i+=2;
        continue;
    }
    if (strncmp(xml,"!ENTITY",7) == 0)
    {
        /*
          Parse entity declaration.
        */
        xml+=7;
        c=(*xml);
        while ((isspace((int) ((unsigned char) c)) != 0) && (*xml != '\0'))
          c=(*++xml);
        if (*xml == '\0')
          break;
        if (*xml == '%')
          {
            /*
              Parameter entity.
            */
            xml++;
            while ((isspace((int) ((unsigned char) *xml)) != 0) &&
                   (*xml != '\0'))
              xml++;
            if (*xml == '\0')
              break;
            n=xml;
            while ((isspace((int) ((unsigned char) *xml)) == 0) &&
                   (*xml != '\0'))
              xml++;
            if (*xml == '\0')
              break;
            *xml='\0';
            xml++;
            while ((isspace((int) ((unsigned char) *xml)) != 0) &&
                   (*xml != '\0'))
              xml++;
            if (*xml == '\0')
              break;
            q=(*xml);
            xml++;
            if ((q != '"') && (q != '\''))
              {
                xml++;
                continue;
              }
            t=xml;
            while ((*xml != '\0') && (*xml != q))
              xml++;
            if (*xml == '\0')
              break;
            *xml='\0';
            xml++;
            entities=(char **) ResizeQuantumMemory(predefined_entitites,(size_t)
              (i+3),sizeof(*entities));
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            predefined_entitites=entities;
            entities[i]=ConstantString(n);
            entities[i+1]=ConstantString(t);
            entities[i+2]=(char *) NULL;
            i+=2;
            continue;
          }
        n=xml;
        while ((isspace((int) ((unsigned char) *xml)) == 0) &&
               (*xml != '\0'))
          xml++;
        if (*xml == '\0')
          break;
        *xml='\0';
        xml++;
        while ((isspace((int) ((unsigned char) *xml)) != 0) &&
               (*xml != '\0'))
          xml++;
        if (*xml == '\0')
          break;
        q=(*xml);
        xml++;
        if ((q != '"') && (q != '\''))
          {
            xml++;
            continue;
          }
        t=xml;
        while ((*xml != '\0') && (*xml != q))
          xml++;
        if (*xml == '\0')
          break;
        *xml='\0';
        xml++;
        index=0;
        while ((predefined_entitites[index] != (char *) NULL) &&
               (strcmp(predefined_entitites[index],n) != 0))
          index+=2;
        if (predefined_entitites[index] == (char *) NULL)
          {
            /*
              General entity.
            */
            if (ValidateEntities(n,t,0,predefined_entitites) == MagickFalse)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionError,"CircularReferenceInEntityDefinition",
                  "`%s'",n);
                break;
              }
            entities=(char **) ResizeQuantumMemory(predefined_entitites,
              (size_t) (i+3),sizeof(*entities));
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            predefined_entitites=entities;
            entities[i]=ConstantString(n);
            entities[i+1]=ConstantString(t);
            entities[i+2]=(char *) NULL;
            i+=2;
            continue;
          }
        v=ConstantString(t);
        if (entities[index+1] != (char *) NULL)
          entities[index+1]=DestroyString(entities[index+1]);
        entities[index+1]=v;
        continue;
    }
    if (strncmp(xml,"!ATTLIST",8) == 0)
    {
        /*
          Parse default attribute list declaration.
        */
        char
          **attributes,
          *attribute_name;

        xml+=8;
        while ((isspace((int) ((unsigned char) *xml)) != 0) && (*xml != '\0'))
          xml++;
        if (*xml == '\0')
          break;
        n=xml;
        while ((isspace((int) ((unsigned char) *xml)) == 0) &&
               (*xml != '\0'))
          xml++;
        if (*xml == '\0')
          break;
        *xml='\0';
        xml++;
        /*
          Search for ATTLIST in default attributes list.
        */
        index=0;
        while ((root->attributes[index] != (char **) NULL) &&
               (strcmp(n,root->attributes[index][0]) != 0))
          index++;
        if (root->attributes[index] == (char **) NULL)
          {
            /*
              New ATTLIST.
            */
            attributes=(char **) AcquireMagickMemory(sizeof(*attributes));
            if (attributes == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            *attributes=(char *) NULL;
            attributes[0]=ConstantString(n);
            root->attributes=(char ***) ResizeQuantumMemory(root->attributes,
              (size_t) (index+2),sizeof(*root->attributes));
            if (root->attributes == (char ***) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            root->attributes[index]=attributes;
            root->attributes[index+1]=(char **) NULL;
          }
        attribute_name=(char *) NULL;
        for ( ; ; )
        {
          /*
            Skip whitespace.
          */
          while ((isspace((int) ((unsigned char) *xml)) != 0) &&
                 (*xml != '\0'))
            xml++;
          if (*xml == '\0')
            break;
          if (*xml == '>')
            {
              xml++;
              break;
            }
          n=xml;
          while ((isspace((int) ((unsigned char) *xml)) == 0) &&
                 (*xml != '\0'))
            xml++;
          if (*xml == '\0')
            break;
          *xml='\0';
          if (strcmp(n,"#FIXED") == 0)
            {
              /*
                #FIXED keyword.
              */
              xml++;
              continue;
            }
          c=(*xml);
          *xml='\0';
          xml++;
          if (attribute_name == (char *) NULL)
            {
              /*
                Attribute name.
              */
              attribute_name=ConstantString(n);
              continue;
            }
          if ((c == *n) && (*(n+1) == '\0'))
            {
              /*
                Attribute value.
              */
              t=xml;
              while ((*xml != '\0') && (*xml != c))
                xml++;
              if (*xml == '\0')
                break;
              *xml='\0';
              xml++;
              attributes=root->attributes[index];
              if (strcmp(n+1,"CDATA") != 0)
                {
                  v=ConstantString("IMPLIED");
                  i=1;
                  while (attributes[i] != (char *) NULL)
                    i+=3;
                  attributes=(char **) ResizeQuantumMemory(attributes,
                    (size_t) (i+4),sizeof(*attributes));
                  if (attributes == (char **) NULL)
                    ThrowFatalException(ResourceLimitError,
                      "MemoryAllocationFailed");
                  root->attributes[index]=attributes;
                  attributes[i]=attribute_name;
                  attributes[i+1]=v;
                  attributes[i+2]=ConstantString(t);
                  attributes[i+3]=(char *) NULL;
                }
              else
                attribute_name=DestroyString(attribute_name);
              attribute_name=(char *) NULL;
              continue;
            }
          if (attribute_name != (char *) NULL)
            attribute_name=DestroyString(attribute_name);
          attribute_name=(char *) NULL;
          continue;
        }
        if (attribute_name != (char *) NULL)
          attribute_name=DestroyString(attribute_name);
        continue;
    }
    if (strncmp(xml,"!ELEMENT",8) == 0)
    {
        /*
          Skip ELEMENT declarations.
        */
        xml+=8;
        for ( ; (*xml != '\0') && (*xml != '>'); xml++);
        if (*xml == '>')
          xml++;
        continue;
    }
    if (strncmp(xml,"!NOTATION",9) == 0)
    {
        /*
          Skip NOTATION declarations.
        */
        xml+=9;
        for ( ; (*xml != '\0') && (*xml != '>'); xml++);
        if (*xml == '>')
          xml++;
        continue;
    }
    if (strncmp(xml,"!--",3) == 0)
    {
        /*
          Comment.
        */
        xml+=3;
        for ( ; ; )
        {
          while ((*xml != '-') && (*xml != '\0'))
            xml++;
          if (*xml == '\0')
            break;
          xml++;
          if (*xml == '-')
            {
              xml++;
              if (*xml == '>')
                {
                  xml++;
                  break;
                }
            }
        }
        continue;
    }
    if (strncmp(xml,"?",1) == 0)
    {
        /*
          Processing instructions.
        */
        xml++;
        n=xml;
        while ((*xml != '?') && (*xml != '\0'))
          xml++;
        if (*xml == '\0')
          break;
        *xml='\0';
        ParseProcessingInstructions(root,n,(size_t) (xml-n));
        xml++;
        if (*xml == '>')
          xml++;
        continue;
    }
    xml++;
}