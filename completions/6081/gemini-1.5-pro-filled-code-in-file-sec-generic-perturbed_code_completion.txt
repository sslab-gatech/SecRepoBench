xml+=strspn(xml+1,XMLWhitespace)+1;
    t=xml;
    xml+=strcspn(xml," \t\r\n>");
    if (*xml == '\0')
      break;
    c=(*xml);
    *xml='\0';
    if (c != '>')
      xml+=strspn(xml+1,XMLWhitespace)+1;
    if (LocaleNCompare(t,"<!ENTITY",8) == 0)
      {
        /*
          Parse ENTITY declaration.
        */
        entities=predefined_entitites;
        if (strchr(t,'%') != (char *) NULL)
          entities=root->entities;
        if (entities == (char **) NULL)
          {
            entities=(char **) AcquireMagickMemory(sizeof(sentinel));
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            (void) CopyMagickMemory(entities,sentinel,sizeof(sentinel));
          }
        i=0;
        while ((entities[i] != (char *) NULL) && (strcmp(entities[i],t+8) != 0))
          i+=2;
        if (entities[i] == (char *) NULL)
          {
            if (entities == predefined_entitites)
              {
                predefined_entitites=(char **) ResizeQuantumMemory(
                  predefined_entitites,(size_t) (i+4),sizeof(*entities));
                entities=predefined_entitites;
              }
            else
              {
                root->entities=(char **) ResizeQuantumMemory(root->entities,
                  (size_t) (i+4),sizeof(*entities));
                entities=root->entities;
              }
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            entities[i+2]=(char *) NULL;
            entities[i+3]=(char *) NULL;
            entities[i]=ConstantString(t+8);
            entities[i+1]=ConstantString(xml);
          }
        else
          {
            entities[i+1]=DestroyString(entities[i+1]);
            entities[i+1]=ConstantString(xml);
          }
        if (ValidateEntities(entities[i],entities[i+1],1,entities) == 0)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","circular entity declaration");
            break;
          }
      }
    else
      if (LocaleNCompare(t,"<!ATTLIST",9) == 0)
        {
          /*
            Parse default attribute.
          */
          t+=9;
          t+=strspn(t,XMLWhitespace)+1;
          n=t;
          t+=strcspn(t,XMLWhitespace);
          if (*t == '\0')
            break;
          *t='\0';
          t++;
          if (root->attributes[0] == (char **) NULL)
            {
              root->attributes=(char ***) AcquireCriticalMemory(sizeof(
                *root->attributes));
              *root->attributes=(char **) NULL;
            }
          i=0;
          while ((root->attributes[i] != (char **) NULL) &&
                 (strcmp(root->attributes[i][0],n) != 0))
            i++;
          if (root->attributes[i] == (char **) NULL)
            {
              root->attributes=(char ***) ResizeQuantumMemory(
                root->attributes,(size_t) (i+2),sizeof(*root->attributes));
              if (root->attributes == (char ***) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              root->attributes[i]=(char **) AcquireQuantumMemory(4,
                sizeof(**root->attributes));
              if (root->attributes[i] == (char **) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              root->attributes[i+1]=(char **) NULL;
              root->attributes[i][0]=ConstantString(n);
              root->attributes[i][1]=(char *) NULL;
              root->attributes[i][2]=ConstantString("");
              root->attributes[i][3]=ConstantString("");
            }
          t+=strspn(t,XMLWhitespace)+1;
          v=t;
          t+=strcspn(t,XMLWhitespace);
          if (*t == '\0')
            break;
          *t='\0';
          t++;
          q=*v;
          if ((*v != '\0') && ((q == '\'') || (q == '"')))
            {
              v++;
              if (*v == '\0')
                break;
              v[strlen(v)-1]='\0';
            }
          t+=strspn(t,XMLWhitespace)+1;
          if (LocaleNCompare(t,"#FIXED",6) == 0)
            {
              t+=6;
              t+=strspn(t,XMLWhitespace)+1;
              q=*t;
              if ((*t != '\0') && ((q == '\'') || (q == '"')))
                {
                  t++;
                  if (*t == '\0')
                    break;
                  t[strlen(t)-1]='\0';
                }
              j=1;
              while ((root->attributes[i][j] != (char *) NULL) &&
                     (strcmp(root->attributes[i][j],v) != 0))
                j+=3;
              if (root->attributes[i][j] == (char *) NULL)
                {
                  j=1;
                  while (root->attributes[i][j] != (char *) NULL)
                    j+=3;
                  root->attributes[i]=(char **) ResizeQuantumMemory(
                    root->attributes[i],(size_t) (j+4),
                    sizeof(**root->attributes));
                  if (root->attributes[i] == (char **) NULL)
                    ThrowFatalException(ResourceLimitFatalError,
                      "MemoryAllocationFailed");
                  root->attributes[i][j+3]=(char *) NULL;
                  root->attributes[i][j]=ConstantString(v);
                  root->attributes[i][j+1]=(char *) NULL;
                  root->attributes[i][j+2]=ConstantString("f");
                }
              if (root->attributes[i][j+1] != (char *) NULL)
                root->attributes[i][j+1]=DestroyString(
                  root->attributes[i][j+1]);
              root->attributes[i][j+1]=ConstantString(t);
            }
        }
    else
      if (LocaleNCompare(t,"<!--",4) == 0)
        {
          /*
            Skip over comment.
          */
          xml=strstr(xml,"--");
          if (xml == (char *) NULL)
            break;
          xml+=2;
        }
      else
        if (LocaleNCompare(t,"<?",2) == 0)
          {
            /*
              Skip over processing instructions.
            */
            xml=strstr(xml,"?>");
            if (xml == (char *) NULL)
              break;
          }
    xml+=strspn(xml,XMLWhitespace)+1;