/*
      ENTITY.
    */
    if (strncmp(xml,"<!ENTITY",8) == 0)
    {
      xml+=8;
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '%')
      {
        xml+=strspn(xml+1,XMLWhitespace)+1;
        state='%';
      }
      else
        state='&';
      t=xml;
      xml+=strcspn(xml,XMLWhitespace);
      if (*xml == '\0')
        continue;
      *xml++='\0';
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '\0')
        continue;
      q=(*xml == '"') || (*xml == '\'') ? *xml++ : ' ';
      v=xml;
      if (q != ' ')
      {
        xml=strchr(xml,q);
        if (xml == (char *) NULL)
          continue;
        *xml='\0';
      }
      else
      {
        xml+=strcspn(xml,XMLWhitespace ">");
        if (*xml != '\0')
          *xml='\0';
      }
      if (ValidateEntities(t,v,0,entities) == MagickFalse)
      {
        (void) ThrowMagickException(exception,GetMagickModule(),
          OptionWarning,"ParseError","circular entity %s",t);
        continue;
      }
      index=0;
      while ((entities[index] != (char *) NULL) &&
             (strcmp(entities[index],t) != 0))
        index+=2;
      if (entities[index] != (char *) NULL)
        entities[index+1]=DestroyString(entities[index+1]);
      else
      {
        entities=(char **) ResizeQuantumMemory(entities,(size_t) (index+4),
          sizeof(*entities));
        if (entities == (char **) NULL)
          ThrowFatalException(ResourceLimitFatalError,
            "MemoryAllocationFailed");
        entities[index+2]=(char *) NULL;
        entities[index]=ConstantString(t);
      }
      entities[index+1]=ConstantString(v);
      continue;
    }
    /*
      ATTLIST.
    */
    if (strncmp(xml,"<!ATTLIST",9) == 0)
    {
      xml+=9;
      xml+=strspn(xml,XMLWhitespace);
      t=xml;
      xml+=strcspn(xml,XMLWhitespace);
      if (*xml == '\0')
        continue;
      *xml++='\0';
      i=0;
      while ((root->attributes[i] != (char **) NULL) &&
             (strcmp(root->attributes[i][0],t) != 0))
        i++;
      if (root->attributes[i] == (char **) NULL)
      {
        root->attributes=(char ***) ResizeQuantumMemory(root->attributes,
          (size_t) (i+2),sizeof(*root->attributes));
        if (root->attributes == (char ***) NULL)
          ThrowFatalException(ResourceLimitFatalError,
            "MemoryAllocationFailed");
        root->attributes[i]=(char **) AcquireQuantumMemory(2,sizeof(**root->attributes));
        if (root->attributes[i] == (char **) NULL)
          ThrowFatalException(ResourceLimitFatalError,
            "MemoryAllocationFailed");
        root->attributes[i+1]=(char **) NULL;
        root->attributes[i][0]=ConstantString(t);
        root->attributes[i][1]=(char *) NULL;
      }
      while (isspace((int) ((unsigned char) *xml)) != 0)
        xml++;
      while (*xml != '\0')
      {
        t=xml;
        xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        *xml++='\0';
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        if ((*xml != '#') || (strncmp(xml,"#FIXED",6) == 0))
        {
          xml+=strcspn(xml,XMLWhitespace);
          xml+=strspn(xml,XMLWhitespace);
          if (*xml == '\0')
            break;
        }
        if (*xml == '#')
        {
          xml+=strcspn(xml,XMLWhitespace);
          xml+=strspn(xml,XMLWhitespace);
          if (*xml == '\0')
            break;
        }
        q=(*xml == '"') || (*xml == '\'') ? *xml++ : ' ';
        v=xml;
        if (q != ' ')
        {
          xml=strchr(xml,q);
          if (xml == (char *) NULL)
            break;
          *xml='\0';
        }
        else
        {
          xml+=strcspn(xml,XMLWhitespace ">");
          if (*xml != '\0')
            *xml='\0';
        }
        j=1;
        while (root->attributes[i][j] != (char *) NULL)
          j+=3;
        root->attributes[i]=(char **) ResizeQuantumMemory(root->attributes[i],
          (size_t) (j+4),sizeof(**root->attributes));
        if (root->attributes[i] == (char **) NULL)
          ThrowFatalException(ResourceLimitFatalError,
            "MemoryAllocationFailed");
        root->attributes[i][j+3]=(char *) NULL;
        root->attributes[i][j]=ConstantString(t);
        root->attributes[i][j+1]=ConstantString(v);
        root->attributes[i][j+2]=ConstantString(q == ' ' ? "*" : " ");
        xml+=strspn(xml,XMLWhitespace);
      }
      continue;
    }
    /*
      Comment or processing instruction.
    */
    if (strncmp(xml,"<!--",4) == 0)
    {
      xml=strstr(xml+4,"-->");
      if (xml == (char *) NULL)
        break;
      xml+=3;
      continue;
    }
    if (strncmp(xml,"<?",2) == 0)
    {
      xml=strstr(xml+2,"?>");
      if (xml == (char *) NULL)
        break;
      xml+=2;
      continue;
    }
    xml=strchr(xml,'<');
  }
  root->entities=entities;