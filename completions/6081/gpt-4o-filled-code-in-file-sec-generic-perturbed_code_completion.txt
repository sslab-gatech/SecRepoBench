/*
      Parse through the XML string to identify and process different components of a DOCTYPE declaration.
    */
    xml+=strspn(xml,XMLWhitespace);
    if (*xml == '\0')
      break;
    if (strncmp(xml,"<!ENTITY",8) == 0)
    {
      /*
        When encountering an ENTITY declaration, parse and store the entity definitions in the appropriate data structure.
      */
      xml+=8;
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '%')
        xml+=strspn(xml+1,XMLWhitespace)+1;
      t=xml;
      xml+=strcspn(xml,XMLWhitespace);
      if (*xml == '\0')
        break;
      *xml='\0';
      xml++;
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '\0')
        break;
      q=(*xml == '"') || (*xml == '\'') ? *xml : ' ';
      if (q != ' ')
        xml++;
      v=xml;
      if (q != ' ')
      {
        xml=strchr(xml,q);
        if (xml == (char *) NULL)
          break;
        *xml='\0';
        xml++;
      }
      else
        xml+=strcspn(xml,XMLWhitespace);
      if (*xml == '\0')
        break;
      if (*xml != '>')
        xml+=strspn(xml,XMLWhitespace);
      if (*xml != '>')
        break;
      /*
        Handle both parameter and general entities, updating predefined entities as needed.
      */
      if (entities == root->entities)
      {
        entities=(char **) AcquireMagickMemory((size_t) (i+4)*sizeof(*entities));
        if (entities == (char **) NULL)
          ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
        (void) CopyMagickMemory(entities,root->entities,i*sizeof(*entities));
        root->entities=entities;
      }
      entities[i++]=ConstantString(t);
      entities[i++]=ConstantString(v);
      entities[i]=(char *) NULL;
      if (ValidateEntities(t,v,0,entities) == MagickFalse)
      {
        (void) ThrowMagickException(exception,GetMagickModule(),OptionWarning,
          "ParseError","circular entity declaration: &%s;",t);
        return(MagickFalse);
      }
      continue;
    }
    if (strncmp(xml,"<!ATTLIST",9) == 0)
    {
      /*
        For ATTLIST declarations, parse and store default attributes, managing memory for new attribute tags as necessary.
      */
      xml+=9;
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '\0')
        break;
      t=xml;
      xml+=strcspn(xml,XMLWhitespace);
      if (*xml == '\0')
        break;
      *xml='\0';
      xml++;
      xml+=strspn(xml,XMLWhitespace);
      if (*xml == '\0')
        break;
      if (root->attributes == (char ***) sentinel)
      {
        root->attributes=(char ***) AcquireMagickMemory(2*sizeof(*root->attributes));
        if (root->attributes == (char ***) NULL)
          ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
        root->attributes[0]=(char **) NULL;
      }
      index=0;
      while ((root->attributes[index] != (char **) NULL) &&
             (strcmp(root->attributes[index][0],t) != 0))
        index++;
      if (root->attributes[index] == (char **) NULL)
      {
        root->attributes=(char ***) ResizeQuantumMemory(root->attributes,
          (size_t) (index+2),sizeof(*root->attributes));
        if (root->attributes == (char ***) NULL)
          ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
        root->attributes[index]=(char **) AcquireMagickMemory(2*sizeof(**root->attributes));
        if (root->attributes[index] == (char **) NULL)
          ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
        root->attributes[index+1]=(char **) NULL;
        root->attributes[index][0]=ConstantString(t);
        root->attributes[index][1]=(char *) NULL;
      }
      while (*xml != '>')
      {
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        n=xml;
        xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        *xml='\0';
        xml++;
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        if ((*xml != '#') || (strncmp(xml,"#FIXED",6) == 0))
        {
          xml+=strcspn(xml,XMLWhitespace);
          xml+=strspn(xml,XMLWhitespace);
          if (*xml == '\0')
            break;
        }
        q=(*xml == '"') || (*xml == '\'') ? *xml : ' ';
        if (q != ' ')
          xml++;
        v=xml;
        if (q != ' ')
        {
          xml=strchr(xml,q);
          if (xml == (char *) NULL)
            break;
          *xml='\0';
          xml++;
        }
        else
          xml+=strcspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        xml+=strspn(xml,XMLWhitespace);
        if (*xml == '\0')
          break;
        j=1;
        while ((root->attributes[index][j] != (char *) NULL) &&
               (strcmp(root->attributes[index][j],n) != 0))
          j+=3;
        if (root->attributes[index][j] == (char *) NULL)
        {
          root->attributes[index]=(char **) ResizeQuantumMemory(
            root->attributes[index],(size_t) (j+4),sizeof(**root->attributes));
          if (root->attributes[index] == (char **) NULL)
            ThrowFatalException(ResourceLimitFatalError,"MemoryAllocationFailed");
          root->attributes[index][j+3]=(char *) NULL;
          root->attributes[index][j]=ConstantString(n);
          root->attributes[index][j+2]=ConstantString(" ");
        }
        if (*v != '\0')
        {
          root->attributes[index][j+1]=ConstantString(v);
          root->attributes[index][j+2]=ConstantString("c");
        }
      }
      continue;
    }
    if (strncmp(xml,"<!--",4) == 0)
    {
      /*
        Process comments and processing instructions by identifying their boundaries and calling appropriate processing functions.
      */
      xml=strstr(xml+4,"-->");
      if (xml == (char *) NULL)
        break;
      xml+=3;
      continue;
    }
    if (strncmp(xml,"<?",2) == 0)
    {
      xml=strstr(xml+2,"?>");
      if (xml == (char *) NULL)
        break;
      xml+=2;
      continue;
    }
    /*
      Continue parsing until the end of the DOCTYPE declaration or the input string is reached.
    */
    xml=strchr(xml,'>');
    if (xml == (char *) NULL)
      break;
    xml++;
  }