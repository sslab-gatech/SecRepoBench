c=strchr(xml,';');
    if (c == (char *) NULL)
      break;
    *c='\0';
    if (strncmp(xml,"ENTITY",6) == 0)
      {
        /*
          Entity declaration.
        */
        xml+=strspn(xml+6,XMLWhitespace);
        if (*xml == '%')
          {
            /*
              Parameter entity.
            */
            xml++;
            t=xml;
            xml+=strcspn(xml,XMLWhitespace);
            *xml='\0';
            xml+=strspn(xml+1,XMLWhitespace);
            v=xml;
            xml=strchr(xml,'"');
            if (xml == (char *) NULL)
              xml=strchr(xml,'\'');
            if (xml == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","missing quote");
                return(MagickFalse);
              }
            q=(*xml);
            *xml='\0';
            xml++;
            xml=strchr(xml,q);
            if (xml == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","missing quote");
                return(MagickFalse);
              }
            *xml='\0';
            xml++;
            if (ValidateEntities(t,v,0,root->entities) == MagickFalse)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","circular entity reference");
                return(MagickFalse);
              }
            index=0;
            while ((root->entities[index] != (char *) NULL) &&
                   (strcmp(root->entities[index],t) != 0))
              index+=2;
            if (root->entities[index] == (char *) NULL)
              {
                root->entities=(char **) ResizeQuantumMemory(root->entities,
                  (size_t) (index+4),sizeof(*root->entities));
                if (root->entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitFatalError,
                    "MemoryAllocationFailed");
                root->entities[index]=ConstantString(t);
                root->entities[index+2]=(char *) NULL;
              }
            root->entities[index+1]=ConstantString(v);
          }
        else
          {
            /*
              General entity.
            */
            t=xml;
            xml+=strcspn(xml,XMLWhitespace);
            *xml='\0';
            xml+=strspn(xml+1,XMLWhitespace);
            v=xml;
            xml=strchr(xml,'"');
            if (xml == (char *) NULL)
              xml=strchr(xml,'\'');
            if (xml == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","missing quote");
                return(MagickFalse);
              }
            q=(*xml);
            *xml='\0';
            xml++;
            xml=strchr(xml,q);
            if (xml == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","missing quote");
                return(MagickFalse);
              }
            *xml='\0';
            xml++;
            if (ValidateEntities(t,v,0,root->entities) == MagickFalse)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","circular entity reference");
                return(MagickFalse);
              }
            index=0;
            while ((root->entities[index] != (char *) NULL) &&
                   (strcmp(root->entities[index],t) != 0))
              index+=2;
            if (root->entities[index] == (char *) NULL)
              {
                root->entities=(char **) ResizeQuantumMemory(root->entities,
                  (size_t) (index+4),sizeof(*root->entities));
                if (root->entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitFatalError,
                    "MemoryAllocationFailed");
                root->entities[index]=ConstantString(t);
                root->entities[index+2]=(char *) NULL;
              }
            root->entities[index+1]=ConstantString(v);
          }
      }
    else
      if (strncmp(xml,"ATTLIST",7) == 0)
        {
          /*
            Attribute list declaration.
          */
          xml+=strspn(xml+7,XMLWhitespace);
          t=xml;
          xml+=strcspn(xml,XMLWhitespace);
          *xml='\0';
          xml+=strspn(xml+1,XMLWhitespace);
          while (*xml != '\0')
            {
              xml+=strcspn(xml,XMLWhitespace);
              v=xml;
              xml+=strcspn(xml,XMLWhitespace);
              *xml='\0';
              xml+=strspn(xml+1,XMLWhitespace);
              n=xml;
              xml=strchr(xml,'"');
              if (xml == (char *) NULL)
                xml=strchr(xml,'\'');
              if (xml == (char *) NULL)
                {
                  (void) ThrowMagickException(exception,GetMagickModule(),
                    OptionWarning,"ParseError","missing quote");
                  return(MagickFalse);
                }
              q=(*xml);
              *xml='\0';
              xml++;
              xml=strchr(xml,q);
              if (xml == (char *) NULL)
                {
                  (void) ThrowMagickException(exception,GetMagickModule(),
                    OptionWarning,"ParseError","missing quote");
                  return(MagickFalse);
                }
              *xml='\0';
              xml++;
              if (root->attributes == (char ***) NULL)
                {
                  root->attributes=(char ***) AcquireCriticalMemory(sizeof(
                    *root->attributes));
                  *root->attributes=(char **) NULL;
                }
              i=0;
              while ((root->attributes[i] != (char **) NULL) &&
                     (strcmp(root->attributes[i][0],t) != 0))
                i++;
              if (root->attributes[i] == (char **) NULL)
                {
                  root->attributes=(char ***) ResizeQuantumMemory(
                    root->attributes,(size_t) (i+2),
                    sizeof(*root->attributes));
                  if (root->attributes == (char ***) NULL)
                    ThrowFatalException(ResourceLimitFatalError,
                      "MemoryAllocationFailed");
                  root->attributes[i]=(char **) AcquireQuantumMemory(4,
                    sizeof(**root->attributes));
                  if (root->attributes[i] == (char **) NULL)
                    ThrowFatalException(ResourceLimitFatalError,
                      "MemoryAllocationFailed");
                  root->attributes[i][0]=ConstantString(t);
                  root->attributes[i][1]=(char *) NULL;
                  root->attributes[i+1]=(char **) NULL;
                }
              j=1;
              while (root->attributes[i][j] != (char *) NULL)
                j+=3;
              root->attributes[i]=(char **) ResizeQuantumMemory(
                root->attributes[i],(size_t) (j+4),
                sizeof(**root->attributes));
              if (root->attributes[i] == (char **) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              root->attributes[i][j]=ConstantString(v);
              root->attributes[i][j+1]=ConstantString(n);
              root->attributes[i][j+2]=ConstantString("");
              root->attributes[i][j+3]=(char *) NULL;
              xml+=strspn(xml,XMLWhitespace);
            }
        }
    else
      if (strncmp(xml,"<!--",4) == 0)
        {
          /*
            Comment.
          */
          xml=strstr(xml+4,"-->");
          if (xml == (char *) NULL)
            {
              (void) ThrowMagickException(exception,GetMagickModule(),
                OptionWarning,"ParseError","unclosed <!--");
              return(MagickFalse);
            }
          xml+=2;
        }
      else
        if (strncmp(xml,"<?",2) == 0)
          {
            /*
              Processing instructions.
            */
            xml=strstr(xml+2,"?>");
            if (xml == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","unclosed <?");
                return(MagickFalse);
              }
            xml++;
          }
        else
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              OptionWarning,"ParseError","unexpected character");
            return(MagickFalse);
          }
    xml=c+1;