c=strchr(xml,'>');
    if (c == (char *) NULL)
      break;
    *c='\0';
    if (strncmp(xml,"<!ENTITY",8) == 0)
      {
        /*
          Entity declaration.
        */
        t=xml+8;
        t+=strspn(t,XMLWhitespace);
        q=*t;
        *t='\0';
        t+=strspn(t,XMLWhitespace "%");
        if (*t == '%')
          {
            /*
              Parameter entity.
            */
            index=0;
            while ((entities[index] != (char *) NULL) &&
                   (strncmp(entities[index],t+1,strlen(t+1)) != 0))
              index+=2;
            if (entities[index] != (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","circular parameter entity");
                return(MagickFalse);
              }
            v=t+1;
            v+=strspn(v,XMLWhitespace);
            q=*v;
            *v='\0';
            v+=strspn(v,XMLWhitespace);
            if (*v != '\0')
              {
                entities=(char **) ResizeQuantumMemory(entities,(size_t)
                  (index+4),sizeof(*entities));
                if (entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitFatalError,
                    "MemoryAllocationFailed");
                entities[index]=ConstantString(t+1);
                entities[index+1]=v;
                entities[index+2]=(char *) NULL;
              }
          }
        else
          {
            /*
              General entity.
            */
            index=0;
            while ((entities[index] != (char *) NULL) &&
                   (strncmp(entities[index],t,strlen(t)) != 0))
              index+=2;
            if (entities[index] != (char *) NULL)
              {
                if (ValidateEntities(t,entities[index+1],0,entities) ==
                    MagickFalse)
                  {
                    (void) ThrowMagickException(exception,GetMagickModule(),
                      OptionWarning,"ParseError","circular entity");
                    return(MagickFalse);
                  }
              }
            v=t;
            v+=strspn(v,XMLWhitespace);
            q=*v;
            *v='\0';
            v+=strspn(v,XMLWhitespace);
            if (*v != '\0')
              {
                entities=(char **) ResizeQuantumMemory(entities,(size_t)
                  (index+4),sizeof(*entities));
                if (entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitFatalError,
                    "MemoryAllocationFailed");
                entities[index]=ConstantString(t);
                entities[index+1]=v;
                entities[index+2]=(char *) NULL;
              }
          }
        *t=q;
      }
    else
      if (strncmp(xml,"<!ATTLIST",9) == 0)
        {
          /*
            Attribute list declaration.
          */
          t=xml+9;
          t+=strspn(t,XMLWhitespace);
          q=*t;
          *t='\0';
          t+=strspn(t,XMLWhitespace);
          if (*t == '\0')
            {
              (void) ThrowMagickException(exception,GetMagickModule(),
                OptionWarning,"ParseError","malformed <!ATTLIST");
              return(MagickFalse);
            }
          if (root->attributes[0] == (char **) NULL)
            {
              root->attributes=(char ***) AcquireCriticalMemory(sizeof(
                *root->attributes));
              *root->attributes=(char **) NULL;
            }
          i=0;
          while ((root->attributes[i] != (char **) NULL) &&
                 (strcmp(t,root->attributes[i][0]) != 0))
            i++;
          if (root->attributes[i] == (char **) NULL)
            {
              root->attributes=(char ***) ResizeQuantumMemory(
                root->attributes,(size_t) (i+2),sizeof(*root->attributes));
              if (root->attributes == (char ***) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              root->attributes[i]=(char **) AcquireQuantumMemory(4,
                sizeof(**root->attributes));
              if (root->attributes[i] == (char **) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              root->attributes[i][0]=ConstantString(t);
              root->attributes[i][1]=(char *) NULL;
              root->attributes[i+1]=(char **) NULL;
            }
          *t=q;
        }
      else
        if (strncmp(xml,"<!--",4) == 0)
          {
            /*
              Comment.
            */
            t=strstr(xml+4,"-->");
            if (t != (char *) NULL)
              *t='\0';
          }
        else
          if (strncmp(xml,"<?",2) == 0)
            {
              /*
                Processing instructions.
              */
              t=strstr(xml+2,"?>");
              if (t != (char *) NULL)
                *t='\0';
            }
    xml=c+1;