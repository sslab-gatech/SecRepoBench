c=xml;
while (*c != '\0')
  {
    /*
      Skip whitespace.
    */
    while (isspace((int) ((unsigned char) *c)))
      c++;
    if (*c == '\0')
      break;
    if (LocaleNCompare(c,"<!--",4) == 0)
      {
        /*
          Comment.
        */
        t=strstr(c,"-->");
        if (t == (char *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
              "UnterminatedComment","`%s'",c);
            break;
          }
        c=t+3;
        continue;
      }
    if (LocaleNCompare(c,"<!ENTITY",8) == 0)
      {
        /*
          Entity declaration.
        */
        c+=8;
        while (isspace((int) ((unsigned char) *c)))
          c++;
        if (*c == '%')
          {
            /*
              Parameter entity.
            */
            c++;
            while (isspace((int) ((unsigned char) *c)))
              c++;
            t=c;
            while ((*c != '\0') && !isspace((int) ((unsigned char) *c)) &&
                   (*c != '"') && (*c != '\'') && (*c != '>'))
              c++;
            if (c == t)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                  "MissingEntityName","`%s'",t);
                break;
              }
            n=(char *) AcquireQuantumMemory((size_t) (c-t+2),sizeof(*n));
            if (n == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
                  "MemoryAllocationFailed","`%s'",t);
                break;
              }
            (void) CopyMagickString(n,t,(size_t) (c-t+1));
            while (isspace((int) ((unsigned char) *c)))
              c++;
            if ((*c != '\'') && (*c != '"'))
              {
                (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                  "MissingEntityValue","`%s'",n);
                n=DestroyString(n);
                break;
              }
            q=(*c++);
            t=c;
            while ((*c != '\0') && (*c != q))
              c++;
            if (*c == '\0')
              {
                (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                  "UnterminatedEntityValue","`%s'",n);
                n=DestroyString(n);
                break;
              }
            v=(char *) AcquireQuantumMemory((size_t) (c-t+2),sizeof(*v));
            if (v == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
                  "MemoryAllocationFailed","`%s'",t);
                n=DestroyString(n);
                break;
              }
            (void) CopyMagickString(v,t,(size_t) (c-t+1));
            c++;
            /*
              Store parameter entity.
            */
            index=0;
            while (predefined_entitites[index] != (char *) NULL)
              index++;
            predefined_entitites=(char **) ResizeQuantumMemory(predefined_entitites,
              (size_t) (index+3),sizeof(*predefined_entitites));
            if (predefined_entitites == (char **) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
                  "MemoryAllocationFailed","`%s'",n);
                n=DestroyString(n);
                v=DestroyString(v);
                break;
              }
            predefined_entitites[index]=n;
            predefined_entitites[index+1]=v;
            predefined_entitites[index+2]=(char *) NULL;
            continue;
          }
        else
          {
            /*
              General entity.
            */
            t=c;
            while ((*c != '\0') && !isspace((int) ((unsigned char) *c)) &&
                   (*c != '"') && (*c != '\'') && (*c != '>'))
              c++;
            if (c == t)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                  "MissingEntityName","`%s'",t);
                break;
              }
            n=(char *) AcquireQuantumMemory((size_t) (c-t+2),sizeof(*n));
            if (n == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
                  "MemoryAllocationFailed","`%s'",t);
                break;
              }
            (void) CopyMagickString(n,t,(size_t) (c-t+1));
            while (isspace((int) ((unsigned char) *c)))
              c++;
            if ((*c != '\'') && (*c != '"'))
              {
                (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                  "MissingEntityValue","`%s'",n);
                n=DestroyString(n);
                break;
              }
            q=(*c++);
            t=c;
            while ((*c != '\0') && (*c != q))
              c++;
            if (*c == '\0')
              {
                (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
                  "UnterminatedEntityValue","`%s'",n);
                n=DestroyString(n);
                break;
              }
            v=(char *) AcquireQuantumMemory((size_t) (c-t+2),sizeof(*v));
            if (v == (char *) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
                  "MemoryAllocationFailed","`%s'",t);
                n=DestroyString(n);
                break;
              }
            (void) CopyMagickString(v,t,(size_t) (c-t+1));
            c++;
            /*
              Store general entity.
            */
            entities=root->entities;
            index=0;
            while (entities[index] != (char *) NULL)
              index++;
            entities=(char **) ResizeQuantumMemory(entities,(size_t) (index+3),
              sizeof(*entities));
            if (entities == (char **) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
                  "MemoryAllocationFailed","`%s'",n);
                n=DestroyString(n);
                v=DestroyString(v);
                break;
              }
            entities[index]=n;
            entities[index+1]=v;
            entities[index+2]=(char *) NULL;
            root->entities=entities;
            continue;
          }
      }
    if (LocaleNCompare(c,"<!ATTLIST",9) == 0)
      {
        /*
          ATTLIST declaration.
        */
        c+=9;
        while (isspace((int) ((unsigned char) *c)))
          c++;
        t=c;
        while ((*c != '\0') && !isspace((int) ((unsigned char) *c)) &&
               (*c != '>'))
          c++;
        if (c == t)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
              "MissingAttlistTag","`%s'",t);
            break;
          }
        n=(char *) AcquireQuantumMemory((size_t) (c-t+2),sizeof(*n));
        if (n == (char *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),ResourceLimitError,
              "MemoryAllocationFailed","`%s'",t);
            break;
          }
        (void) CopyMagickString(n,t,(size_t) (c-t+1));
        /*
          Skip to end of ATTLIST declaration.
        */
        t=strchr(c,'>');
        if (t == (char *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
              "UnterminatedAttlist","`%s'",n);
            n=DestroyString(n);
            break;
          }
        c=t+1;
        n=DestroyString(n);
        continue;
      }
    if (LocaleNCompare(c,"<?",2) == 0)
      {
        /*
          Processing instruction.
        */
        t=strstr(c,"?>");
        if (t == (char *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
              "UnterminatedProcessingInstruction","`%s'",c);
            break;
          }
        c=t+2;
        continue;
      }
    /*
      Skip to next markup declaration or end.
    */
    t=strchr(c,'<');
    if (t == (char *) NULL)
      break;
    c=t;
  }
break;