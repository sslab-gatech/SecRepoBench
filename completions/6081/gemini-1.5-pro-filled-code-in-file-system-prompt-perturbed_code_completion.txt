if (strncmp(xml,"<!--",4) == 0)
      {
        /*
          Comment.
        */
        xml=strstr(xml,"-->");
        if (xml != (char *) NULL)
          {
            xml+=3;
            continue;
          }
        (void) ThrowMagickException(exception,GetMagickModule(),
          OptionWarning,"ParseError","unclosed <!--");
        predefined_entitites=(char **) RelinquishMagickMemory(
          predefined_entitites);
        return(MagickFalse);
      }
    if (strncmp(xml,"<?",2) == 0)
      {
        /*
          Processing instructions.
        */
        xml=strstr(xml,"?>");
        if (xml != (char *) NULL)
          {
            xml+=2;
            continue;
          }
        (void) ThrowMagickException(exception,GetMagickModule(),
          OptionWarning,"ParseError","unclosed <?");
        predefined_entitites=(char **) RelinquishMagickMemory(
          predefined_entitites);
        return(MagickFalse);
      }
    t=strchr(xml,'>');
    if (t == (char *) NULL)
      break;
    *t='\0';
    c=xml[1];
    if (isalpha((int) ((unsigned char) c)) == 0)
      {
        xml=t+1;
        continue;
      }
    xml++;
    if (strncmp(xml,"ENTITY",6) != 0)
      {
        xml=t+1;
        continue;
      }
    xml+=6;
    while (isspace((int) ((unsigned char) *xml)) != 0)
      xml++;
    if (*xml == '%')
      {
        /*
          Parameter entity.
        */
        xml++;
        while (isspace((int) ((unsigned char) *xml)) != 0)
          xml++;
        n=xml;
        xml+=strcspn(xml,XMLWhitespace ">");
        if (*xml != '\0')
          *xml++='\0';
        while (isspace((int) ((unsigned char) *xml)) != 0)
          xml++;
      }
    else
      n=(char *) NULL;
    v=xml;
    q=(*xml);
    if ((q == '\'') || (q == '"'))
      {
        /*
          Value is quoted.
        */
        xml++;
        v=xml;
        while ((*xml != '\0') && (*xml != q))
          xml++;
        if (*xml != '\0')
          *xml++='\0';
      }
    else
      {
        /*
          Value is not quoted.
        */
        xml+=strcspn(xml,XMLWhitespace ">");
        if (*xml != '\0')
          *xml++='\0';
      }
    if (n != (char *) NULL)
      {
        /*
          Add new parameter entity.
        */
        if (root->entities == (char **) NULL)
          {
            root->entities=(char **) AcquireMagickMemory(sizeof(sentinel));
            if (root->entities == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            (void) CopyMagickMemory(root->entities,sentinel,sizeof(sentinel));
          }
        i=0;
        while ((root->entities[i] != (char *) NULL) &&
               (strcmp(root->entities[i],n) != 0))
          i+=2;
        if (root->entities[i] == (char *) NULL)
          {
            if (ValidateEntities(n,v,1,root->entities) == 0)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  OptionWarning,"ParseError","circular entity declaration");
                predefined_entitites=(char **) RelinquishMagickMemory(
                  predefined_entitites);
                return(MagickFalse);
              }
            root->entities=(char **) ResizeQuantumMemory(root->entities,
              (size_t) (i+4),sizeof(*root->entities));
            if (root->entities == (char **) NULL)
              ThrowFatalException(ResourceLimitFatalError,
                "MemoryAllocationFailed");
            root->entities[i]=ConstantString(n);
            root->entities[i+2]=(char *) NULL;
          }
        root->entities[i+1]=ParseEntities(v,root->entities,'%');
      }
    else
      if (n == (char *) NULL)
        {
          /*
            Add new general entity.
          */
          i=0;
          while ((predefined_entitites[i] != (char *) NULL) &&
                 (strcmp(predefined_entitites[i],v) != 0))
            i+=2;
          if (predefined_entitites[i] == (char *) NULL)
            {
              if (ValidateEntities(v,v,1,predefined_entitites) == 0)
                {
                  (void) ThrowMagickException(exception,GetMagickModule(),
                    OptionWarning,"ParseError","circular entity declaration");
                  predefined_entitites=(char **) RelinquishMagickMemory(
                    predefined_entitites);
                  return(MagickFalse);
                }
              predefined_entitites=(char **) ResizeQuantumMemory(
                predefined_entitites,(size_t) (i+4),
                sizeof(*predefined_entitites));
              if (predefined_entitites == (char **) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              predefined_entitites[i]=ConstantString(v);
              predefined_entitites[i+2]=(char *) NULL;
            }
          index=i;
          i=0;
          while ((root->entities[i] != (char *) NULL) &&
                 (strcmp(root->entities[i],v) != 0))
            i+=2;
          if (root->entities[i] == (char *) NULL)
            {
              root->entities=(char **) ResizeQuantumMemory(root->entities,
                (size_t) (i+4),sizeof(*root->entities));
              if (root->entities == (char **) NULL)
                ThrowFatalException(ResourceLimitFatalError,
                  "MemoryAllocationFailed");
              root->entities[i]=ConstantString(v);
              root->entities[i+2]=(char *) NULL;
            }
          root->entities[i+1]=predefined_entitites[index+1];
        }
    xml=t+1;