c=strchr(xml,';');
    if (c == (char *) NULL)
      break;
    *c='\0';
    if (strncmp(xml,"ENTITY",6) == 0)
      {
        /*
          Entity declaration.
        */
        xml+=strspn(xml+6,XMLWhitespace);
        if (*xml == '%')
          {
            /*
              Parameter entity.
            */
            xml++;
            t=xml;
            xml+=strcspn(xml,XMLWhitespace);
            *xml='\0';
            xml+=strspn(xml+1,XMLWhitespace);
            if (*xml == '\"')
              {
                xml++;
                v=xml;
                xml=strchr(xml,'\"');
                if (xml == (char *) NULL)
                  ThrowFatalException(OptionError,"missing quote");
                *xml='\0';
                xml++;
              }
            else
              if (*xml == '\'')
                {
                  xml++;
                  v=xml;
                  xml=strchr(xml,'\'');
                  if (xml == (char *) NULL)
                    ThrowFatalException(OptionError,"missing quote");
                  *xml='\0';
                  xml++;
                }
              else
                {
                  v=xml;
                  xml=strchr(xml,';');
                  if (xml == (char *) NULL)
                    ThrowFatalException(OptionError,"missing semicolon");
                  *xml='\0';
                  xml++;
                }
            if (ValidateEntities(t,v,0,root->entities) == MagickFalse)
              ThrowFatalException(OptionError,"circular entity reference");
            index=0;
            while ((root->entities[index] != (char *) NULL) &&
                   (strcmp(root->entities[index],t) != 0))
              index+=2;
            if (root->entities[index] == (char *) NULL)
              {
                root->entities=(char **) ResizeQuantumMemory(root->entities,
                  (size_t) (index+4),sizeof(*root->entities));
                if (root->entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitError,
                    "MemoryAllocationFailed");
                root->entities[index]=ConstantString(t);
                root->entities[index+2]=(char *) NULL;
              }
            root->entities[index+1]=ConstantString(v);
          }
        else
          {
            /*
              General entity.
            */
            t=xml;
            xml+=strcspn(xml,XMLWhitespace);
            *xml='\0';
            xml+=strspn(xml+1,XMLWhitespace);
            if (*xml == '\"')
              {
                xml++;
                v=xml;
                xml=strchr(xml,'\"');
                if (xml == (char *) NULL)
                  ThrowFatalException(OptionError,"missing quote");
                *xml='\0';
                xml++;
              }
            else
              if (*xml == '\'')
                {
                  xml++;
                  v=xml;
                  xml=strchr(xml,'\'');
                  if (xml == (char *) NULL)
                    ThrowFatalException(OptionError,"missing quote");
                  *xml='\0';
                  xml++;
                }
              else
                {
                  v=xml;
                  xml=strchr(xml,';');
                  if (xml == (char *) NULL)
                    ThrowFatalException(OptionError,"missing semicolon");
                  *xml='\0';
                  xml++;
                }
            if (ValidateEntities(t,v,0,root->entities) == MagickFalse)
              ThrowFatalException(OptionError,"circular entity reference");
            index=0;
            while ((root->entities[index] != (char *) NULL) &&
                   (strcmp(root->entities[index],t) != 0))
              index+=2;
            if (root->entities[index] == (char *) NULL)
              {
                root->entities=(char **) ResizeQuantumMemory(root->entities,
                  (size_t) (index+4),sizeof(*root->entities));
                if (root->entities == (char **) NULL)
                  ThrowFatalException(ResourceLimitError,
                    "MemoryAllocationFailed");
                root->entities[index]=ConstantString(t);
                root->entities[index+2]=(char *) NULL;
              }
            root->entities[index+1]=ConstantString(v);
          }
      }
    else
      if (strncmp(xml,"ATTLIST",7) == 0)
        {
          /*
            Attribute list declaration.
          */
          xml+=strspn(xml+7,XMLWhitespace);
          t=xml;
          xml+=strcspn(xml,XMLWhitespace);
          *xml='\0';
          xml+=strspn(xml+1,XMLWhitespace);
          for ( ; ; )
            {
              xml+=strspn(xml,XMLWhitespace);
              n=xml;
              xml+=strcspn(xml,XMLWhitespace);
              q=*xml;
              *xml='\0';
              xml+=strspn(xml+1,XMLWhitespace);
              if (*xml == '\"')
                {
                  xml++;
                  v=xml;
                  xml=strchr(xml,'\"');
                  if (xml == (char *) NULL)
                    ThrowFatalException(OptionError,"missing quote");
                  *xml='\0';
                  xml++;
                }
              else
                if (*xml == '\'')
                  {
                    xml++;
                    v=xml;
                    xml=strchr(xml,'\'');
                    if (xml == (char *) NULL)
                      ThrowFatalException(OptionError,"missing quote");
                    *xml='\0';
                    xml++;
                  }
                else
                  {
                    v=xml;
                    xml=strchr(xml,';');
                    if (xml == (char *) NULL)
                      ThrowFatalException(OptionError,"missing semicolon");
                    *xml='\0';
                    xml++;
                  }
              if (root->attributes[0] == (char **) NULL)
                {
                  root->attributes=(char ***) AcquireCriticalMemory(sizeof(
                    *root->attributes));
                  *root->attributes=(char **) NULL;
                }
              i=0;
              while ((root->attributes[i] != (char **) NULL) &&
                     (strcmp(t,root->attributes[i][0]) != 0))
                i++;
              if (root->attributes[i] == (char **) NULL)
                {
                  root->attributes=(char ***) ResizeQuantumMemory(
                    root->attributes,(size_t) (i+2),
                    sizeof(*root->attributes));
                  if (root->attributes == (char ***) NULL)
                    ThrowFatalException(ResourceLimitError,
                      "MemoryAllocationFailed");
                  root->attributes[i]=(char **) AcquireQuantumMemory(4,
                    sizeof(**root->attributes));
                  if (root->attributes[i] == (char **) NULL)
                    ThrowFatalException(ResourceLimitError,
                      "MemoryAllocationFailed");
                  root->attributes[i+1]=(char **) NULL;
                  root->attributes[i][0]=ConstantString(t);
                  root->attributes[i][1]=(char *) root->attributes[i+1];
                  root->attributes[i][2]=(char *) NULL;
                  root->attributes[i][3]=(char *) NULL;
                }
              j=1;
              while (root->attributes[i][j] != (char *) NULL)
                j+=3;
              root->attributes[i]=(char **) ResizeQuantumMemory(
                root->attributes[i],(size_t) (j+4),sizeof(**root->attributes));
              if (root->attributes[i] == (char **) NULL)
                ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
              root->attributes[i][j+3]=(char *) NULL;
              root->attributes[i][j]=ConstantString(n);
              root->attributes[i][j+1]=ConstantString(v);
              root->attributes[i][j+2]=ConstantString(" ");
              if (q == '>')
                break;
            }
        }
      else
        if (strncmp(xml,"<!--",4) == 0)
          {
            /*
              Comment.
            */
            xml=strstr(xml+4,"-->");
            if (xml == (char *) NULL)
              ThrowFatalException(OptionError,"unclosed comment");
          }
        else
          if (*xml == '?')
            {
              /*
                Processing instructions.
              */
              xml=strstr(xml+1,"?>");
              if (xml == (char *) NULL)
                ThrowFatalException(OptionError,"unclosed processing instruction");
            }
          else
            {
              ThrowFatalException(OptionError,"unexpected character");
            }
    xml=c+1;