c=xml;
    while (*c != '\0')
    {
      // Check for ENTITY declaration
      if (strncmp(c, "<!ENTITY", 8) == 0 && (c + 8 < xml + length))
      {
        c += 8;
        // Skip whitespace
        while (isspace((int) *c) && (c < xml + length))
          c++;
        // Parse entity name
        n=c;
        while (!isspace((int) *c) && *c != '\0' && *c != '"' && *c != '\'' && (c < xml + length))
          c++;
        if (c >= xml + length)
          break;
        *c='\0';
        c++;
        // Skip whitespace
        while (isspace((int) *c) && (c < xml + length))
          c++;
        // Parse entity value
        q=(*c == '"') || (*c == '\'') ? *c : '\0';
        if (q == '\0')
          break;
        c++;
        v=c;
        while ((*c != q) && *c != '\0' && (c < xml + length))
          c++;
        if (c >= xml + length)
          break;
        *c='\0';
        c++;
        // Store entity
        index=0;
        while ((predefined_entitites[index] != (char *) NULL) &&
               (strcmp(predefined_entitites[index],n) != 0))
          index++;
        if (predefined_entitites[index] == (char *) NULL)
          {
            entities=(char **) ResizeQuantumMemory(predefined_entitites,
              (size_t) (index+2),sizeof(*entities));
            if (entities == (char **) NULL)
              ThrowFatalException(ResourceLimitError,"MemoryAllocationFailed");
            predefined_entitites=entities;
            predefined_entitites[index]=ConstantString(n);
            predefined_entitites[index+1]=(char *) NULL;
          }
        predefined_entitites[index]=ConstantString(v);
      }
      // Check for ATTLIST declaration
      else if (strncmp(c, "<!ATTLIST", 9) == 0 && (c + 9 < xml + length))
      {
        c += 9;
        // Skip to the end of the ATTLIST declaration
        while (*c != '>' && *c != '\0' && (c < xml + length))
          c++;
        if (*c == '>')
          c++;
      }
      else
        c++;
    }