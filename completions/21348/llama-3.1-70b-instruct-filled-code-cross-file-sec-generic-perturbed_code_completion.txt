// Calculate the initial offset for the TZSP header within the UDP payload.
u_int offset = ip_offset+ip_len+sizeof(struct ndpi_udphdr);

// Verify the TZSP version and type, and that it encapsulates Ethernet frames.
if(packet[offset] == TZSP_VERSION && packet[offset+1] == TZSP_TYPE_ETHERNET) {
  // Iterate through the TZSP tags in the packet, adjusting the offset as needed.
  u_int tag_offset = offset + 2;
  while(packet[tag_offset]!= TZSP_TAG_END) {
    u_int tag_len = packet[tag_offset+1];
    if(packet[tag_offset] == TZSP_TAG_PADDING) {
      // Handle PADDING tags by skipping over them.
      tag_offset += tag_len + 2;
    } else {
      // For other tags, adjust the offset and continue processing.
      tag_offset += tag_len + 2;
    }
  }

  // If a valid encapsulated Ethernet frame is found, adjust the eth_offset and
  // jump back to datalink type checking for further processing of the encapsulated frame.
  eth_offset = tag_offset + 2;
  goto datalink_check;
}