u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
      if (header->caplen < offset + 4) {
        return detected_protocol; /* Too short for TZSP header */
      }

      /* Check TZSP version and type */
      if (packet[offset] != 0x00 || packet[offset + 1] != 0x01) {
        return detected_protocol; /* Not a valid TZSP packet */
      }

      /* Calculate the encapsulated Ethernet frame offset */
      offset += 4; // Skip TZSP header
      if (header->caplen < offset + 14) {
        return detected_protocol; /* Too short for Ethernet frame */
      }

      eth_offset = offset; // Set the new Ethernet offset
      goto datalink_check; // Recheck the datalink type