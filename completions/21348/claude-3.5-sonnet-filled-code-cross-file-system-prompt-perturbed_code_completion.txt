u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
u_int8_t tzsp_version = packet[offset];
u_int8_t tzsp_type = packet[offset + 1];

if (tzsp_version == 1 && tzsp_type == 0 && header->caplen > offset + 4) {
  u_int16_t encapsulated_protocol = ntohs(*(u_int16_t*)(packet + offset + 2));
  
  if (encapsulated_protocol == 1) { // Ethernet
    offset += 4;
    
    while (offset < header->caplen - 1) {
      u_int8_t tag_type = packet[offset];
      
      if (tag_type == 1) { // TZSP_TAG_END
        offset++;
        break;
      } else if (tag_type == 0) { // TZSP_TAG_PADDING
        offset++;
      } else {
        if (offset + 2 > header->caplen)
          break;
        u_int8_t tag_length = packet[offset + 1];
        offset += 2 + tag_length;
      }
    }
    
    if (offset < header->caplen) {
      eth_offset = offset;
      goto datalink_check;
    }
  }
}