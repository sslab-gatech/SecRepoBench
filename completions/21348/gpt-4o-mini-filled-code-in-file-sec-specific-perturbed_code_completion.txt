if (header->caplen < eth_offset + sizeof(struct ndpi_tzsp_header))
      return detected_protocol; /* Too short for TZSP header */

    struct ndpi_tzsp_header *tzsp = (struct ndpi_tzsp_header *)&packet[eth_offset];
    if (tzsp->version != 1 || tzsp->type != 0) {
      workflow->stats.total_discarded_bytes += header->len;
      return detected_protocol; /* Invalid TZSP version or type */
    }

    u_int16_t encapsulated_len = ntohs(tzsp->len);
    if (header->caplen < eth_offset + sizeof(struct ndpi_tzsp_header) + encapsulated_len)
      return detected_protocol; /* Too short for encapsulated packet */

    eth_offset += sizeof(struct ndpi_tzsp_header);
    header->caplen = eth_offset + encapsulated_len; /* Adjust caplen for encapsulated packet */
    packet += eth_offset; /* Move packet pointer to encapsulated packet */

    /* Continue processing the encapsulated packet */
    goto datalink_check;