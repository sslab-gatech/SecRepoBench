if (offset + 4 < header->caplen) {
  u_int8_t tzsp_version = packet[offset];
  u_int8_t tzsp_type = packet[offset + 1];
  u_int16_t tzsp_encaps_length = ntohs(*(u_int16_t *)&packet[offset + 2]);

  if (tzsp_version == 1 && tzsp_type == 1) { // TZSP version 1, encapsulating Ethernet frames
    offset += 4; // Move past the TZSP header

    while (offset < header->caplen) {
      u_int8_t tag_type = packet[offset];
      u_int8_t tag_length = packet[offset + 1];

      if (tag_type == 0) { // END tag
        break;
      } else if (tag_type == 1) { // PADDING tag
        offset += tag_length;
      } else if (tag_type == 2) { // ENCAPSULATED_FRAME tag
        if (tag_length >= 14) { // Minimum Ethernet frame size
          eth_offset = offset;
          datalink_type = DLT_EN10MB; // Treat encapsulated frame as Ethernet
          goto datalink_check;
        }
        break;
      } else {
        offset += tag_length;
      }
    }
  }
}