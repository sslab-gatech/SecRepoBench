u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
      if (header->caplen < offset + 4) {
        return(detected_protocol); /* Too short for TZSP header */
      }

      u_int8_t tzsp_version = packet[offset];
      u_int8_t tzsp_type = packet[offset + 1];

      if (tzsp_version != 0x01) {
        return(detected_protocol); /* Unsupported TZSP version */
      }

      if (tzsp_type != 0x00) {
        return(detected_protocol); /* Unsupported TZSP type */
      }

      u_int16_t encapsulated_len = ntohs(*(u_int16_t *)&packet[offset + 2]);
      if (header->caplen < offset + 4 + encapsulated_len) {
        return(detected_protocol); /* Too short for encapsulated packet */
      }

      eth_offset = offset + 4; // Adjust eth_offset to point to the encapsulated packet
      goto datalink_check; // Recheck the datalink type for the encapsulated frame