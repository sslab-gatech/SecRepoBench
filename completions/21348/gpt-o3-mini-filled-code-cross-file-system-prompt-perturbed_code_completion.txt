{
  u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
  if (header->caplen < offset + 2)
    return detected_protocol; /* Not enough data for TZSP header */

  u_int8_t tzsp_version = packet[offset++];
  u_int8_t tzsp_type = packet[offset++];

  /* Verify TZSP version, must be 1 */
  if (tzsp_version != 1)
    return detected_protocol;

  /* Parse TZSP tags; tags are in TLV format, ending with tag type 1 */
  while (offset < header->caplen) {
    u_int8_t tag_type = packet[offset++];
    if (tag_type == 1) /* END tag */
      break;
    if (offset >= header->caplen)
      return detected_protocol;
    u_int8_t tag_len = packet[offset++];
    if (header->caplen < offset + tag_len)
      return detected_protocol;
    offset += tag_len;
  }

  /* Set eth_offset to the beginning of the encapsulated Ethernet frame */
  eth_offset = offset;
  goto datalink_check;
}