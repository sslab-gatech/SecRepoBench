// Check for TZSP (TaZman Sniffer Protocol) encapsulation in UDP packets.
      u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);

      if (offset + 2 > header->caplen) {
        return detected_protocol; // Too short for TZSP header
      }

      u_int8_t tzsp_version = packet[offset];
      u_int8_t tzsp_type = packet[offset + 1];

      if (tzsp_version != 1 || tzsp_type != 0) {
        return detected_protocol; // Not a valid TZSP packet
      }

      offset += 2; // Skip TZSP version and type

      // Process TZSP tags
      while (offset < header->caplen) {
        u_int8_t tag_type = packet[offset];
        offset++;

        if (tag_type == 1) { // END tag
          break;
        } else if (tag_type == 0) { // PADDING tag
          continue;
        } else {
          if (offset + 1 > header->caplen) {
            return detected_protocol; // Malformed TZSP tag
          }
          u_int8_t tag_length = packet[offset];
          offset += 1 + tag_length; // Skip tag length and tag data
        }
      }

      if (offset + sizeof(struct ndpi_ethhdr) > header->caplen) {
        return detected_protocol; // No encapsulated Ethernet frame
      }

      eth_offset = offset; // Set offset to encapsulated Ethernet frame
      goto datalink_check; // Reprocess as Ethernet