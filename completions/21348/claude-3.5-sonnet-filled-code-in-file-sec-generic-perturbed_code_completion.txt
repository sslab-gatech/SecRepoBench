u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
u_int tzsp_type, tzsp_encap;

if (offset + 4 < header->caplen) {
  tzsp_type = packet[offset + 1];
  tzsp_encap = ntohs(*((u_int16_t*)&packet[offset + 2]));
  
  if (tzsp_type == 1 && tzsp_encap == 1) { // TZSP_TYPE_RECEIVED_TAG_LIST and TZSP_ENCAP_ETHERNET
    offset += 4;
    
    while (offset < header->caplen) {
      u_int8_t tag_type = packet[offset];
      
      if (tag_type == 0) { // TZSP_TAG_END
        offset++;
        break;
      } else if (tag_type == 1) { // TZSP_TAG_PADDING
        offset++;
      } else {
        u_int8_t tag_len = packet[offset + 1];
        offset += tag_len + 2;
      }
    }
    
    if (offset < header->caplen) {
      eth_offset = offset;
      goto datalink_check;
    }
  }
}