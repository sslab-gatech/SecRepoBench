// TZSP (TaZman Sniffer Protocol) encapsulation handling
u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
u_int8_t tzsp_version = packet[offset];
u_int8_t tzsp_type = packet[offset + 1];

if (tzsp_version == 0x01 && tzsp_type == 0x00) { // TZSP version 1, TZSP_TYPE_ETHERNET
    offset += 4; // Skip TZSP header
    while (offset < header->caplen) {
        u_int8_t tag_type = packet[offset];
        u_int8_t tag_len = packet[offset + 1];
        if (tag_type == 0x00) { // TZSP_TAG_END
            break;
        } else if (tag_type == 0x01) { // TZSP_TAG_PADDING
            offset += 2;
        } else {
            offset += 2 + tag_len;
            if (tag_type == 0x09) { // TZSP_TAG_PACKET_ID
                eth_offset = offset;
                goto datalink_check;
            }
        }
    }
}