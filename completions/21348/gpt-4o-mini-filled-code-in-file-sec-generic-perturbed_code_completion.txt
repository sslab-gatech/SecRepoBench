if((header->caplen < (ip_offset + sizeof(struct ndpi_tzsp_header))) || 
       (packet[ip_offset] != 0x00) || 
       (packet[ip_offset + 1] != 0x00)) {
      workflow->stats.total_discarded_bytes += header->len;
      return detected_protocol;
    }

    struct ndpi_tzsp_header *tzsp_header = (struct ndpi_tzsp_header *)&packet[ip_offset];
    u_int16_t encapsulated_len = ntohs(tzsp_header->len);

    if(encapsulated_len > header->caplen - ip_offset) {
      workflow->stats.total_discarded_bytes += header->len;
      return detected_protocol;
    }

    ip_offset += sizeof(struct ndpi_tzsp_header);
    goto datalink_check;