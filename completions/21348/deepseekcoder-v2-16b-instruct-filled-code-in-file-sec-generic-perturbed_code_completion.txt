s_syn_count++;
            begin_or_end_tcp = 1;
        }
        if(tcph->fin){
            flow->c_to_s_fin_count++;
            begin_or_end_tcp = 1;
        }
    }

    if(begin_or_end_tcp){
        gettimeofday(&tdiff, NULL);
        timersub(&tdiff, &when, &tdiff);
        if(begin_or_end_tcp == 1){
            flow->iat_c_to_s[flow->c_to_s_syn_count-1] = tdiff.tv_sec * 1000000 + tdiff.tv_usec;
        } else {
            flow->iat_c_to_s[flow->c_to_s_fin_count-1] = tdiff.tv_sec * 1000000 + tdiff.tv_usec;
        }
    }

    if(ndpi_flow != NULL) {
      ndpi_flow->last_seen = time;
      ndpi_flow->last_seen_tv = when;

      if(proto == IPPROTO_TCP) {
        if(tcph != NULL) {
          ndpi_flow->l4.tcp.src_port = sport;
          ndpi_flow->l4.tcp.dst_port = dport;
          ndpi_flow->l4.tcp.flags = tcph->flags;
          ndpi_flow->l4.tcp.window_size = ntohs(tcph->window);
          ndpi_flow->l4.tcp.seq_num = ntohl(tcph->seq);
          ndpi_flow->l4.tcp.ack_num = ntohl(tcph->ack_seq);
          ndpi_flow->l4.tcp.data_offset = tcph->doff;
          ndpi_flow->l4.tcp.urg_ptr = ntohs(tcph->urg_ptr);
          ndpi_flow->l4.tcp.checksum = ntohs(tcph->check);
          ndpi_flow->l4.tcp.options = tcph->options;
        }
      } else if(proto == IPPROTO_UDP) {
        if(udph != NULL) {
          ndpi_flow->l4.udp.src_port = sport;
          ndpi_flow->l4.udp.dst_port = dport;
          ndpi_flow->l4.udp.length = ntohs(udph->len);
          ndpi_flow->l4.udp.checksum = ntohs(udph->check);
        }
      } else if(proto == IPPROTO_ICMP) {
        ndpi_flow->l4.icmp.type = packet->icmp_type;
        ndpi_flow->l4.icmp.code = packet->icmp_code;
        ndpi_flow->l4.icmp.checksum = packet->icmp_checksum;
        ndpi_flow->l4.icmp.id = packet->icmp_id;
        ndpi_flow->l4.icmp.sequence = packet->icmp_sequence;
      } else if(proto == IPPROTO_ICMPV6) {
        ndpi_flow->l4.icmpv6.type = packet->icmpv6_type;
        ndpi_flow->l4.icmpv6.code = packet->icmpv6_code;
        ndpi_flow->l4.icmpv6.checksum = packet->icmpv6_checksum;
        ndpi_flow->l4.icmpv6.id = packet->icmpv6_id;
        ndpi_flow->l4.icmpv6.sequence = packet->icmpv6_sequence;
      }

      ndpi_flow->l3.ip.src_ip = flow->src_ip;
      ndpi_flow->l3.ip.dst_ip = flow->dst_ip;
      ndpi_flow->l3.ip.protocol = proto;
      ndpi_flow->l3.ip.tos = iph->tos;
      ndpi_flow->l3.ip.ttl = iph->ttl;
      ndpi_flow->l3.ip.id = iph->id;
      ndpi_flow->l3.ip.frag_off = iph->frag_off;
      ndpi_flow->l3.ip.checksum = iph->check;

      ndpi_flow->l3.ip6.src_ip6 = iph6->ip6_src;
      ndpi_flow->l3.ip6.dst_ip6 = iph6->ip6_dst;
      ndpi_flow->l3.ip6.flow_label = iph6->ip6_flow_info & 0x0FFFFF;
      ndpi_flow->l3.ip6.hop_limit = iph6->ip6_hop_limit;
      ndpi_flow->l3.ip6.payload_len = ntohs(iph6->ip6_hdr.ip6_un1_plen);
      ndpi_flow->l3.ip6.next_header = iph6->ip6_hdr.ip6_un1_nxt;
      ndpi_flow->l3.ip6.traffic_class = iph6->ip6_hdr.ip6_flow;

      ndpi_flow->l3.ip.packet_len = rawsize;
      ndpi_flow->l3.ip.ip_offset = ip_offset;

      ndpi_flow->l3.ip6.packet_len = rawsize;
      ndpi_flow->l3.ip6.ip_offset = ip_offset;

      ndpi_flow->l3.ip.src_id = src;
      ndpi_flow->l3.ip.dst_id = dst;

      ndpi_flow->l3.ip.tunnel_type = tunnel_type;

      ndpi_flow->l3.ip.vlan_id = vlan_id;

      ndpi_flow->l3.ip.packet_id = header->caplen;

      ndpi_flow->l3.ip.src_to_dst_direction = src_to_dst_direction;

      ndpi_flow->l3.ip.packet_timestamp = header->ts;

      ndpi_flow->l3.ip.packet_index = workflow->stats.ip_packet_count;

      ndpi_flow->l3.ip.packet_direction = 0;

      ndpi_flow->l3.ip.packet_flags = 0;

      ndpi_flow->l3.ip.packet_flags |= (flow->src_ip == iph->saddr) ? NDPI_PKT_DIR_SRC_TO_DST : NDPI_PKT_DIR_DST_TO_SRC;

      ndpi_flow->l3.ip.packet_flags |= (flow->src_port == htons(sport)) ? NDPI_PKT_DIR_SRC_TO_DST : NDPI_PKT_DIR_DST_TO_SRC;

      ndpi_flow->l3.ip.packet_flags |= (flow->dst_port == htons(dport)) ? NDPI_PKT_DIR_SRC_TO_DST : NDPI_PKT_DIR_DST_TO_SRC;

      ndpi_flow->l3.ip.packet_flags |= (proto == IPPROTO_TCP) ? NDPI_PKT_PROTO_TCP : NDPI_PKT_PROTO_UDP;

      ndpi_flow->l3.ip.packet_flags |= (proto == IPPROTO_ICMP) ? NDPI_PKT_PROTO_ICMP : NDPI_PKT_PROTO_OTHER;

      ndpi_flow->l3.ip.packet_flags |= (proto == IPPROTO_ICMPV6) ? NDPI_PKT_PROTO_ICMPV6 : NDPI_PKT_PROTO_OTHER;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN) ? NDPI_PKT_TUNNEL_VXLAN : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_GENEVE) ? NDPI_PKT_TUNNEL_GENEVE : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_NVGRE) ? NDPI_PKT_TUNNEL_NVGRE : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN_GPE) ? NDPI_PKT_TUNNEL_VXLAN_GPE : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_GRE) ? NDPI_PKT_TUNNEL_GRE : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_IPIP) ? NDPI_PKT_TUNNEL_IPIP : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_IP6IP6) ? NDPI_PKT_TUNNEL_IP6IP6 : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_ERSPAN) ? NDPI_PKT_TUNNEL_ERSPAN : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_MPLS) ? NDPI_PKT_TUNNEL_MPLS : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_MPLS_UDP) ? NDPI_PKT_TUNNEL_MPLS_UDP : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_MPLS_GRE) ? NDPI_PKT_TUNNEL_MPLS_GRE : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_MPLS_IPIP) ? NDPI_PKT_TUNNEL_MPLS_IPIP : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_MPLS_ERSPAN) ? NDPI_PKT_TUNNEL_MPLS_ERSPAN : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN_UDP) ? NDPI_PKT_TUNNEL_VXLAN_UDP : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN_GPE_UDP) ? NDPI_PKT_TUNNEL_VXLAN_GPE_UDP : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN_UDP_GPE) ? NDPI_PKT_TUNNEL_VXLAN_UDP_GPE : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN_UDP_GPE_IPIP) ? NDPI_PKT_TUNNEL_VXLAN_UDP_GPE_IPIP : NDPI_PKT_TUNNEL_NONE;

      ndpi_flow->l3.ip.packet_flags |= (tunnel_type == NDPI_TUNNEL_VXLAN_UDP_IPIP) ? NDPI