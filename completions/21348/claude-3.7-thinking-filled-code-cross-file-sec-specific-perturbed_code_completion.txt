/* TZSP */
tunnel_type = ndpi_tzsp_tunnel;
u_int offset = ip_offset+ip_len+sizeof(struct ndpi_udphdr);
if(offset + 4 < header->caplen) { /* Minimum TZSP header length is 4 bytes */
  u_int8_t version = packet[offset];
  u_int8_t type = packet[offset+1];
  
  if(version == 1 && type == 0) { /* We only handle version 1, type 0 (ethernet) */
    offset += 4;
    
    /* Skip over TZSP tags */
    while(offset < header->caplen) {
      u_int8_t tag_type = packet[offset];
      
      if(tag_type == 0) { /* END Tag */
        offset++;
        break;
      } else if(tag_type == 1) { /* PADDING Tag */
        offset++;
      } else {
        /* Other tags have a length field */
        if(offset + 1 >= header->caplen) break;
        u_int8_t tag_len = packet[offset+1];
        
        if(offset + 2 + tag_len > header->caplen) break;
        offset += 2 + tag_len;
      }
    }
    
    if(offset < header->caplen) {
      /* Encapsulated ethernet frame */
      eth_offset = offset;
      datalink_type = DLT_EN10MB;
      goto datalink_check;
    }
  }
}