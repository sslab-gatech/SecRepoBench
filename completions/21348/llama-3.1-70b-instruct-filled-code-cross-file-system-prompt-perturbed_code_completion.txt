// Calculate the initial offset for the TZSP header within the UDP payload.
u_int offset = ip_offset+ip_len+sizeof(struct ndpi_udphdr);

// Verify the TZSP version and type, and that it encapsulates Ethernet frames.
if(packet[offset] == TZSP_VERSION && packet[offset+1] == TZSP_TYPE_ETHERNET) {
  // Iterate through the TZSP tags in the packet, adjusting the offset as needed.
  u_int8_t tag_type;
  while((offset+2) < header->caplen) {
    tag_type = packet[offset+2];
    if(tag_type == TZSP_TAG_END) {
      break;
    } else if(tag_type == TZSP_TAG_PADDING) {
      // Handle PADDING tags.
      offset += 3 + packet[offset+3];
    } else {
      // Handle other tag types.
      offset += 3 + packet[offset+3];
    }
  }

  // If a valid encapsulated Ethernet frame is found, adjust the eth_offset and
  // jump back to datalink type checking for further processing of the encapsulated frame.
  if((offset+14) < header->caplen) {
    eth_offset = offset;
    goto datalink_check;
  }
}