{
  u_int tzsp_offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
  if (header->caplen < tzsp_offset + 2)
    return(detected_protocol);

  u_int8_t tzsp_version = packet[tzsp_offset];
  u_int8_t tzsp_type = packet[tzsp_offset + 1];
  if (tzsp_version != 1)
    return(detected_protocol);
  tzsp_offset += 2;

  /* Iterate through TZSP tags until the END tag (tag type 1) is found */
  while (1) {
    if (header->caplen < tzsp_offset + 2)
      return(detected_protocol);

    u_int8_t tag_type = packet[tzsp_offset++];
    if (tag_type == 1)  /* END tag */
      break;

    u_int8_t tag_len = packet[tzsp_offset++];
    if (header->caplen < tzsp_offset + tag_len)
      return(detected_protocol);
    tzsp_offset += tag_len;
  }

  eth_offset = tzsp_offset;
  goto datalink_check;
}