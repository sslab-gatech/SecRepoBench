u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
      
      if((offset + 4) >= header->caplen) break; /* Too short for TZSP header */
      
      /* Check TZSP version (must be 1) and type (must be 0 for encapsulated Ethernet) */
      if((packet[offset] != 1) || (packet[offset+1] != 0)) break;
      
      offset += 2; /* Skip version and type */
      
      /* Process TZSP tags */
      while(offset < header->caplen) {
        u_int8_t tag_type = packet[offset];
        u_int8_t tag_len;
        
        if(tag_type == 0) { /* END tag */
          offset += 1;
          break;
        } else if(tag_type == 1) { /* PADDING tag */
          offset += 1;
          continue;
        }
        
        if((offset + 1) >= header->caplen) break;
        tag_len = packet[offset+1];
        
        if((offset + 2 + tag_len) > header->caplen) break;
        offset += 2 + tag_len;
      }
      
      if((offset + sizeof(struct ndpi_ethhdr)) > header->caplen) break;
      
      /* Found encapsulated Ethernet frame */
      eth_offset = offset;
      datalink_type = DLT_EN10MB;
      goto datalink_check;