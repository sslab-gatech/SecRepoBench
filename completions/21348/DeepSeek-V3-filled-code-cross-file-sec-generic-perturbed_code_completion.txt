u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
      
      /* Check TZSP header */
      if((offset + 4) > header->caplen) break;
      
      u_int8_t version = packet[offset];
      u_int8_t type = packet[offset+1];
      
      if(version != 1 || type != 0) break; /* Only support version 1, type 0 (Ethernet) */
      
      offset += 4; /* Skip version, type, encapsulated protocol and flags */
      
      /* Process TZSP tags */
      while(offset < header->caplen) {
        u_int8_t tag_type = packet[offset];
        u_int8_t tag_len;
        
        if(tag_type == 0) break; /* END tag */
        
        if(tag_type == 1) { /* PADDING tag */
          offset++;
          continue;
        }
        
        if((offset + 2) > header->caplen) break;
        tag_len = packet[offset+1];
        
        if((offset + 2 + tag_len) > header->caplen) break;
        offset += 2 + tag_len;
      }
      
      if(offset + 14 > header->caplen) break; /* Need at least Ethernet header */
      
      /* Found encapsulated Ethernet frame */
      eth_offset = offset;
      datalink_type = DLT_EN10MB;
      goto datalink_check;