u_int offset = ip_offset + ip_len + sizeof(struct ndpi_udphdr);
u_int16_t tzsp_version = ntohs(*(u_int16_t*)&packet[offset]);
u_int16_t tzsp_type = ntohs(*(u_int16_t*)&packet[offset+2]);

if((tzsp_version == 1) && (tzsp_type == 0) && (offset+4 < header->caplen)) {
  offset += 4;

  while(offset < header->caplen) {
    u_int8_t tag_type = packet[offset];
    u_int8_t tag_len;

    switch(tag_type) {
      case 0: // TZSP_TAG_END
        offset = header->caplen;
        break;
      case 1: // TZSP_TAG_PADDING
        offset++;
        break;
      default:
        tag_len = packet[offset+1];
        offset += tag_len + 2;
        break;
    }
  }

  if(offset < header->caplen) {
    eth_offset = offset;
    goto datalink_check;
  }
}