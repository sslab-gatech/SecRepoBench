/* TZSP */
tunnel_type = ndpi_tzsp_tunnel;
u_int offset = ip_offset+ip_len+sizeof(struct ndpi_udphdr);

if((offset+4) < header->caplen) {
  u_int8_t version = packet[offset];
  u_int8_t type = packet[offset+1];
  u_int16_t encapsulates = ntohs(*((u_int16_t*)&packet[offset+2]));
  
  if((version == 1) && (type == 0) && (encapsulates == 1)) { /* TZSP_TYPE_RECEIVED_TAG_LIST */
    u_int8_t stop = 0, tag_type;
    u_int16_t tag_len;
    
    offset += 4;
    
    while((!stop) && (offset < header->caplen)) {
      tag_type = packet[offset];
      
      switch(tag_type) {
      case 0: /* TZSP_TAG_END */
        stop = 1;
        offset++;
        break;
      case 1: /* TZSP_TAG_PADDING */
        offset++;
        break;
      default:
        if(offset+1 >= header->caplen) {
          stop = 1;
          break;
        }
        
        tag_len = packet[offset+1];
        
        if(offset+2+tag_len > header->caplen) {
          stop = 1;
          break;
        }
        
        offset += tag_len + 2;
        break;
      }
    }
    
    if(offset < header->caplen) {
      eth_offset = offset;
      datalink_type = DLT_EN10MB;
      goto datalink_check;
    }
  }
}