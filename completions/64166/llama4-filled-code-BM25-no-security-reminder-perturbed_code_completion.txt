cmsDeviceLink* DeviceLinkPtr = NULL;
if (DeviceLink != NULL) {
    DeviceLinkPtr = cmsDeviceLinkDup(DeviceLink);
    if (DeviceLinkPtr == NULL) {
        cmsSignalError(m->ContextID, cmsERROR_OUTOFMEMORY, "Failed to duplicate DeviceLink");
        cmsPipelineFree(DeviceLink);
        cmsDeleteTransform(xform);
        return 0;
    }

    // Always force a CLUT
    cmsDeviceLinkSetFlags(DeviceLinkPtr, cmsFLAGS_FORCE_CLUT);

    // Optimize for color rendering
    if (!_cmsOptimizePipeline(m->ContextID, DeviceLinkPtr, NULL)) {
        cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "Failed to optimize pipeline");
        cmsDeviceLinkFree(DeviceLinkPtr);
        cmsPipelineFree(DeviceLink);
        cmsDeleteTransform(xform);
        return 0;
    }
}