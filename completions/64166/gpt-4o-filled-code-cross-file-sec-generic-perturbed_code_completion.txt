if (DeviceLink == NULL) {
    cmsDeleteTransform(xform);
    return 0;
}

// Force the use of a CLUT
dwFlags |= cmsFLAGS_FORCE_CLUT;

// Optimize the pipeline for color rendering
if (!_cmsOptimizePipeline(DeviceLink, Intent, dwFlags, &OutputFormat, &InFrm, m->ContextID)) {
    cmsPipelineFree(DeviceLink);
    cmsDeleteTransform(xform);
    return 0;
}