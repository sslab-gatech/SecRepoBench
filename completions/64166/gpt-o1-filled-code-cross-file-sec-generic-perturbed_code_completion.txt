if (DeviceLink == NULL) {
    cmsDeleteTransform(xform);
    cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "DeviceLink is NULL. Cannot proceed");
    return 0;
}

dwFlags |= cmsFLAGS_FORCE_CLUT;

if (!_cmsOptimizePipeline(m->ContextID, DeviceLink, Intent, &InFrm, &OutputFormat, dwFlags)) {
    cmsPipelineFree(DeviceLink);
    cmsDeleteTransform(xform);
    cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "Unable to optimize pipeline");
    return 0;
}