// Checks if the DeviceLink is NULL and deletes the transform if it is.
// If the DeviceLink exists, it forces the use of a CLUT by setting the cmsFLAGS_FORCE_CLUT flag.
// Proceeds to optimize the pipeline for color rendering using the _cmsOptimizePipeline function.

if (DeviceLink == NULL) {
    cmsDeleteTransform(xform);
    return 0;
}

// Force the use of a CLUT
dwFlags |= cmsFLAGS_FORCE_CLUT;

// Optimize the pipeline
_cmsOptimizePipeline(m->ContextID, &DeviceLink, Intent, &InputFormat, &OutFrm, &dwFlags);

// Emit the CLUT
_cmsIOPrintf(m, "/RenderTable ");

first = cmsPipelineGetPtrToFirstStage(DeviceLink);
if (first != NULL) {
    WriteCLUT(m, first, "<", ">\n", "", "", lFixWhite, ColorSpace);
}

_cmsIOPrintf(m, " %d {} bind ", nChannels);

for (i=1; i < nChannels; i++)
    _cmsIOPrintf(m, "dup ");

_cmsIOPrintf(m, "]\n");