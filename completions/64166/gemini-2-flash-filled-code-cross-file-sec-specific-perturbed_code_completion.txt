if (DeviceLink == NULL) {
        cmsDeleteTransform(xform);
        cmsSignalError(m ->ContextID, cmsERROR_COLORSPACE_CHECK, "Cannot duplicate devicelink");
        return 0;
    }

    cmsPipelineSetOptimization(DeviceLink, TRUE);
    _cmsOptimizePipeline(DeviceLink);

    if (dwFlags & cmsFLAGS_FORCE_CLUT)
    {
        cmsStage* clut = cmsPipelineCheckAndRetreiveStages(DeviceLink, 1, cmsSigClutElemType, NULL);
        if (clut == NULL)
        {
            cmsUInt32Number clutPoints[MAXCHANNELS];
            cmsUInt32Number i;
            cmsUInt32Number inputChannels = cmsGetInputChannels(hProfile);

            if (inputChannels > MAXCHANNELS)
            {
                cmsPipelineFree(DeviceLink);
                cmsDeleteTransform(xform);
                cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "Too many input channels for CLUT");
                return 0;
            }

            for (i = 0; i < inputChannels; i++)
            {
                clutPoints[i] = 17;
            }

            if (!cmsPipelineInsertStage(DeviceLink, cmsAT_END, cmsStageAllocCLUT(m->ContextID, clutPoints, inputChannels, nChannels, TYPE_FLT)))
            {
                cmsPipelineFree(DeviceLink);
                cmsDeleteTransform(xform);
                cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "Cannot insert CLUT stage");
                return 0;
            }
        }
    }