if (DeviceLink == NULL) {
    cmsDeleteTransform(xform);
    cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "Failed to obtain a device link");
    return 0;
}

{
    cmsPipeline* optimized = _cmsOptimizePipeline(DeviceLink, cmsFLAGS_FORCE_CLUT);
    if (optimized == NULL) {
        cmsPipelineFree(DeviceLink);
        cmsDeleteTransform(xform);
        cmsSignalError(m->ContextID, cmsERROR_COLORSPACE_CHECK, "Pipeline optimization for CLUT failed");
        return 0;
    }
    DeviceLink = optimized;
}