char* num_str = malloc(str_len + 1);
if (!num_str) {
    PLIST_JSON_ERR("%s: Out of memory\n", __func__);
    return NULL;
}
memcpy(num_str, str_val, str_len);
num_str[str_len] = '\0';

double dval = strtod(num_str, &endp);
if (endp != num_str + str_len) {
    PLIST_JSON_ERR("%s: invalid numerical value '%.*s'\n", __func__, (int)str_len, str_val);
    free(num_str);
    return NULL;
}

int is_integer = 1;
const char* p = num_str;
if (*p == '-') p++;
for (; *p; p++) {
    if (*p == '.' || *p == 'e' || *p == 'E') {
        is_integer = 0;
        break;
    }
}

if (is_integer) {
    if (*num_str == '-') {
        errno = 0;
        long long ival = strtoll(num_str, NULL, 10);
        if (errno == ERANGE) {
            parsed_value = plist_new_real(dval);
        } else {
            parsed_value = plist_new_int(ival);
        }
    } else {
        errno = 0;
        unsigned long long uval = strtoull(num_str, NULL, 10);
        if (errno == ERANGE) {
            parsed_value = plist_new_real(dval);
        } else {
            parsed_value = plist_new_uint(uval);
        }
    }
} else {
    parsed_value = plist_new_real(dval);
}

free(num_str);