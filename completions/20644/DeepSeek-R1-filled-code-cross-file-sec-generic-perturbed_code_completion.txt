if(recheck_type)
    goto ether_type_check;

  workflow->stats.vlan_count += vlan_packet;

iph_check:
  if((ip_offset + sizeof(struct ndpi_iphdr)) > header->caplen) {
    workflow->stats.total_discarded_bytes += header->len;
    return(nproto);
  }

  iph = (struct ndpi_iphdr *)&packet[ip_offset];
  frag_off = ntohs(iph->frag_off);
  proto = iph->protocol;

  if(header->caplen < header->len) {
    static u_int8_t caplen_warning_used = 0;
    if(!caplen_warning_used && !workflow->prefs.quiet_mode) {
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "Captured packet size smaller than actual packet size\n");
      caplen_warning_used = 1;
    }
  }