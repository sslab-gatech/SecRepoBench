if(iph->version == IPVERSION) {
    ip_len = ((u_int16_t)iph->ihl * 4);
    iph6 = NULL;

    if(header->caplen < ip_offset + ip_len) {
      workflow->stats.total_discarded_bytes += header->len;
      return(nproto);
    }

    if(iph->protocol == IPPROTO_IPV6) {
      ip_offset += ip_len;
      if (ip_len > 0)
        goto iph_check;
    }

    // ... rest of the code ...
  }