if(recheck_type) {
  goto ether_type_check;
}

if(vlan_packet) {
  workflow->stats.vlan_count++;
}

iph_check:
if(header->caplen < (ip_offset + 20)) {
  return(nproto);
}

iph = (struct ndpi_iphdr *)&packet[ip_offset];
frag_off = ntohs(iph->frag_off);
proto = iph->protocol;

if(header->caplen < (ip_offset + ntohs(iph->tot_len))) {
  static u_int8_t ip_packet_truncated_warning_used = 0;

  if(!ip_packet_truncated_warning_used) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
               "WARNING: Captured packet size < actual packet size. Some layer data missing.\n");
    ip_packet_truncated_warning_used = 1;
  }

  workflow->stats.total_discarded_bytes += header->len;
  return(nproto);
}