if(recheck_type) goto ether_type_check;

if(vlan_packet) workflow->stats.vlan_count++;

iph = (struct ndpi_iphdr *) &packet[ip_offset];

if(((bpf_u_int32)ip_offset + sizeof(struct ndpi_iphdr)) > header->caplen)
  return(nproto);

if(iph->version == IPVERSION) {
  frag_off = ntohs(iph->frag_off);
  proto = iph->protocol;
} else {
  static u_int8_t ipv4_warning_used = 0;

  if(ipv4_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
	       "\n\nWARNING: only IPv4/IPv6 packets are supported in this demo (nDPI supports both IPv4 and IPv6), all other packets will be discarded\n\n");
    ipv4_warning_used = 1;
  }
  workflow->stats.total_discarded_bytes +=  header->len;
  return(nproto);
}

if(header->caplen < header->len) {
  static u_int8_t truncated_warning_used = 0;

  if(truncated_warning_used == 0 && !workflow->prefs.quiet_mode) {
    NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
	     "\n\nWARNING: some packets have been truncated by the sniffer/capture tool. Packets that are not complete cannot be analyzed correctly.\n\n");
    truncated_warning_used = 1;
  }
}