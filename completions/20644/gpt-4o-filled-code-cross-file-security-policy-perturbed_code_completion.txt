iph_check:
  // Ensure the packet has enough data for an IP header
  if(header->caplen < (ip_offset + sizeof(struct ndpi_iphdr))) {
    workflow->stats.total_discarded_bytes += header->len;
    return(nproto); // Not enough data for IP header
  }

  iph = (struct ndpi_iphdr *)&packet[ip_offset];

  // Check if the packet is Ethernet with IP protocol
  if(iph->version == IPVERSION) {
    frag_off = ntohs(iph->frag_off);
    proto = iph->protocol;

    // Check if the captured packet size is less than the actual packet size
    if(header->caplen < header->len) {
      static u_int8_t capture_size_warning_used = 0;

      if(capture_size_warning_used == 0) {
        if(!workflow->prefs.quiet_mode)
          NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
                   "\n\nWARNING: captured packet size is less than actual packet size\n\n");
        capture_size_warning_used = 1;
      }
    }
  }