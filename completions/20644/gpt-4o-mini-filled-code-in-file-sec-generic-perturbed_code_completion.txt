if(header->caplen < (ip_offset + sizeof(struct ndpi_iphdr))) {
      workflow->stats.total_discarded_bytes += header->len;
      return(nproto);
    }

    iph = (struct ndpi_iphdr *)&packet[ip_offset];
    if(iph->version != IPVERSION) {
      goto v4_warning;
    }

    frag_off = ntohs(iph->frag_off);
    proto = iph->protocol;

    if(header->caplen < (ip_offset + ip_len)) {
      workflow->stats.total_discarded_bytes += header->len;
      return(nproto);
    }