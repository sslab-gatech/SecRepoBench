if(header->caplen < ip_offset) {
  static u_int8_t caplen_warning_used = 0;

  if(caplen_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
	       "\n\nWARNING: captured packets size is too short (%u vs %u): "
	       "nDPI cannot properly dissect this traffic\n\n",
	       header->caplen, ip_offset);
    caplen_warning_used = 1;
  }

  workflow->stats.total_discarded_bytes +=  header->len;
  return(nproto);
}

iph = (struct ndpi_iphdr *) &packet[ip_offset];

iph_check:
if((iph->version == IPVERSION) || (iph->version == 0x6 /* IPv6 */)) {
  ;
} else {
  workflow->stats.total_discarded_bytes +=  header->len;
  return(nproto);
}