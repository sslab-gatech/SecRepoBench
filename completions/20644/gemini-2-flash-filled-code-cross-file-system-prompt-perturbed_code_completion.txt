if(recheck_type)
    goto ether_type_check;

  if(vlan_packet)
    workflow->stats.vlan_count++;

iph_check:
  if(header->caplen < (ip_offset + 20))
    return(nproto);

  iph = (struct ndpi_iphdr *) &packet[ip_offset];

  if((cprototype == ETH_P_IP) || (cprototype == ETH_P_IPV6) || (datalink_type == DLT_RAW)) {
    frag_off = ntohs(iph->frag_off);
    proto = iph->protocol;
  } else {
    /* We don't know the ethertype, so we can't proceed */
    return(nproto);
  }

  if(header->caplen < header->len) {
    static u_int8_t caplen_warning_used = 0;

    if(caplen_warning_used == 0) {
      if(!workflow->prefs.quiet_mode)
	NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "\n\nWARNING: caplen < len, this is not a problem but it means that the packets are truncated\n\n");
      caplen_warning_used = 1;
    }
  }