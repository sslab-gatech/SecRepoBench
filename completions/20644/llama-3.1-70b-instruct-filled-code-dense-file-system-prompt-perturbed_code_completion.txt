if(recheck_type)
  goto ether_type_check;

if(vlan_packet)
  workflow->stats.vlan_packet_count++;

if(ip_offset >= header->caplen)
  goto v4_warning;

iph = (struct ndpi_iphdr *) &packet[ip_offset];

if(header->caplen < (ip_offset + sizeof(struct ndpi_iphdr)))
  goto v4_warning;

if(iph->version!= IPVERSION) {
  iph6 = (struct ndpi_ipv6hdr *)&packet[ip_offset];
  if(header->caplen < (ip_offset + sizeof(struct ndpi_ipv6hdr)))
    goto v4_warning;
  goto iph_check;
}

if(ntohs(iph->tot_len) > header->caplen) {
  static u_int8_t ipv4_warning_used = 0;

  if(ipv4_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
	       "\n\nWARNING: captured packet size is less than actual packet size (nDPI supports this)\n\n");
    ipv4_warning_used = 1;
  }

  workflow->stats.total_discarded_bytes +=  header->len;
  return(nproto);
}

frag_off = ntohs(iph->frag_off);
proto = iph->protocol;