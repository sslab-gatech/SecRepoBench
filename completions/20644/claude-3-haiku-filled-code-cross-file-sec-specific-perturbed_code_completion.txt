if(iph != NULL) {
  frag_off = ntohs(iph->frag_off);
  proto = iph->protocol;

  if(header->caplen < (ip_offset + ip_len)) {
    static u_int8_t ip_truncated_warning_used = 0;

    if(ip_truncated_warning_used == 0) {
      if(!workflow->prefs.quiet_mode)
        NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
                 "\n\nWARNING: IP packet capture size is smaller than IP packet size, truncated packet analysis\n\n");
      ip_truncated_warning_used = 1;
    }

    workflow->stats.total_discarded_bytes += header->len;
    return(nproto);
  }
} else if(iph6 != NULL) {
  frag_off = ntohs(iph6->ip6_hdr.ip6_offlg & 0xF8FF);
  proto = iph6->ip6_hdr.ip6_un1_nxt;
}

if(proto == IPPROTO_TCP) {
  struct ndpi_tcphdr *tcph = (struct ndpi_tcphdr *)&packet[ip_offset+ip_len];
  *sport = ntohs(tcph->source), *dport = ntohs(tcph->dest);
  *src = &workflow->src[*sport % MAX_NDPI_FLOWS];
  *dst = &workflow->dst[*dport % MAX_NDPI_FLOWS];
  *payload = (u_int8_t *)&packet[ip_offset+ip_len+sizeof(struct ndpi_tcphdr)];
  *payload_len = header->caplen - (ip_offset+ip_len+sizeof(struct ndpi_tcphdr));
  *proto = IPPROTO_TCP;
  *src_to_dst_direction = 1;
} else if(proto == IPPROTO_UDP) {
  struct ndpi_udphdr *udph = (struct ndpi_udphdr *)&packet[ip_offset+ip_len];
  *sport = ntohs(udph->source), *dport = ntohs(udph->dest);
  *src = &workflow->src[*sport % MAX_NDPI_FLOWS];
  *dst = &workflow->dst[*dport % MAX_NDPI_FLOWS];
  *payload = (u_int8_t *)&packet[ip_offset+ip_len+sizeof(struct ndpi_udphdr)];
  *payload_len = header->caplen - (ip_offset+ip_len+sizeof(struct ndpi_udphdr));
  *proto = IPPROTO_UDP;
  *src_to_dst_direction = 1;
} else {
  *sport = *dport = 0;
  *src = &workflow->src[0];
  *dst = &workflow->dst[0];
  *payload = (u_int8_t *)&packet[ip_offset+ip_len];
  *payload_len = header->caplen - (ip_offset+ip_len);
  *proto = proto;
  *src_to_dst_direction = 1;
}

return(get_ndpi_flow_info(workflow, 4, vlan_id, tunnel_type,
                          iph, iph6, ip_offset, ip_len,
                          (iph != NULL) ? ntohs(iph->tot_len) : ntohs(iph6->ip6_hdr.ip6_un1_plen),
                          sport, dport, src, dst, proto,
                          payload, payload_len, src_to_dst_direction, header->ts));