if(recheck_type)
    goto ether_type_check;

  if(vlan_packet)
    workflow->stats.vlan_count++;

iph_check:
  if(header->caplen < ip_offset + sizeof(struct ndpi_iphdr))
    return(nproto);

  iph = (struct ndpi_iphdr *) &packet[ip_offset];

  if((cprototype == ETH_P_IP) && (iph->version == IPVERSION))
    ;
  else if(cprototype == ETH_P_IPV6 && iph->version == 6)
    ;
  else {
    static u_int8_t ipv6_warning_used = 0;

    frag_off = ntohs(iph->frag_off);
    proto = iph->protocol;

    if(header->len < header->caplen) {
      if(ipv6_warning_used == 0) {
	if(!workflow->prefs.quiet_mode)
	  NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "\n\nWARNING: Snaplen smaller than packet size, detection may be inaccurate\n\n");
	ipv6_warning_used = 1;
      }
    }