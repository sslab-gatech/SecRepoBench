if (recheck_type) goto ether_type_check;

if (vlan_packet) workflow->stats.vlan_count++;

iph = (struct ndpi_iphdr *)&packet[ip_offset];

if ((bpf_u_int32)ip_offset + sizeof(struct ndpi_iphdr) > header->caplen)
  return(nproto);

if(iph->ihl < 5 || iph->version != 4)
  goto v4_warning;

frag_off = ntohs(iph->frag_off);
proto = iph->protocol;

if(header->len < header->caplen) {
  static u_int8_t caplen_warning_used = 0;
  
  if(caplen_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "\n\nWARNING: packet capture size is less than actual packet size\n");
    caplen_warning_used = 1;
  }
}