if(recheck_type)
  goto ether_type_check;

if(vlan_packet)
  workflow->stats.vlan_count++;

iph_check:
if((header->caplen < ip_offset + sizeof(struct ndpi_iphdr)) || (packet == NULL)) {
  workflow->stats.total_discarded_bytes += header->len;
  return(nproto); /* Too short */
}

iph = (struct ndpi_iphdr *) &packet[ip_offset];

/* Get fragment offset */
frag_off = ntohs(iph->frag_off);

/* Proto */
proto = iph->protocol;

/* Check if we're facing an incomplete packet [caplen < len] */
if(header->caplen < header->len) {
  static u_int8_t cap_warning_used = 0;
  
  if(cap_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "\n\nWARNING: packet capture size limited, consider using "
                "-s 0 (unlimited) capture size\n");
    cap_warning_used = 1;
  }
  
  workflow->stats.total_discarded_bytes += header->len;
  return(nproto);
}