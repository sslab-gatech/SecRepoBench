if(recheck_type) {
    ip_offset = eth_offset;
    goto ether_type_check;
  }

  if(vlan_packet) {
    workflow->stats.vlan_count++;
  }

  iph = (struct ndpi_iphdr *)&packet[ip_offset];

  if(iph->version != IPVERSION) {
    goto v4_warning;
  }

  ip_len = ((u_int16_t)iph->ihl * 4);
  iph6 = NULL;

  if(iph->protocol == IPPROTO_IPV6) {
    ip_offset += ip_len;
    if (ip_len > 0)
      goto iph_check;
  }

  if((frag_off & 0x1FFF) != 0) {
    static u_int8_t ipv4_frags_warning_used = 0;
    workflow->stats.fragmented_count++;

    if(ipv4_frags_warning_used == 0) {
      if(!workflow->prefs.quiet_mode)
        NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "\n\nWARNING: IPv4 fragments are not handled by this demo (nDPI supports them)\n");
      ipv4_frags_warning_used = 1;
    }

    workflow->stats.total_discarded_bytes +=  header->len;
    return(nproto);
  }