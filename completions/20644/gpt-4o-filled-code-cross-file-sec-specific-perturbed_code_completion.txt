iph_check:
if((ip_offset + sizeof(struct ndpi_iphdr)) > header->caplen) {
  workflow->stats.total_discarded_bytes += header->len;
  return(nproto);
}

iph = (struct ndpi_iphdr *) &packet[ip_offset];

if(iph->version == IPVERSION) {
  ip_len = ((u_int16_t)iph->ihl * 4);
  iph6 = NULL;

  if((ip_offset + ip_len) > header->caplen) {
    workflow->stats.total_discarded_bytes += header->len;
    return(nproto);
  }

  frag_off = ntohs(iph->frag_off);
  proto = iph->protocol;

  if(header->caplen < header->len) {
    static u_int8_t cap_warning_used = 0;

    if(cap_warning_used == 0) {
      if(!workflow->prefs.quiet_mode)
        NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
                 "\n\nWARNING: packet capture size is smaller than packet size\n\n");
      cap_warning_used = 1;
    }
  }
} else {
  goto v4_warning;
}