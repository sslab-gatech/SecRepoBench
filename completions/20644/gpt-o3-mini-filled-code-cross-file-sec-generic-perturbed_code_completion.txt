if ((header->caplen - ip_offset) < sizeof(struct ndpi_iphdr)) {
    static u_int8_t incomplete_ip_header_logged = 0;
    if (!incomplete_ip_header_logged && !workflow->prefs.quiet_mode) {
        NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
                 "WARNING: Incomplete IP header detected (caplen=%u, required=%zu bytes).\n",
                 header->caplen, sizeof(struct ndpi_iphdr));
        incomplete_ip_header_logged = 1;
    }
    workflow->stats.total_discarded_bytes += header->len;
    return(nproto);
}
iph = (struct ndpi_iphdr *) &packet[ip_offset];
frag_off = ntohs(iph->frag_off) & 0x1FFF;
proto = iph->protocol;