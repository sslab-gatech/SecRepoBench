if(recheck_type)
  goto ether_type_check;

if(vlan_packet)
  workflow->stats.vlan_packet_count++;

iph_check:
if(header->caplen < (ip_offset + sizeof(struct ndpi_iphdr)))
  return(nproto);

iph = (struct ndpi_iphdr *) &packet[ip_offset];

if(header->caplen < (ip_offset + iph->ihl * 4))
  return(nproto);

if(cprototype!= ETH_P_IP && cprototype!= ETH_P_IPV6) {
  static u_int8_t ether_warning_used = 0;

  if(ether_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
               "\n\nWARNING: only Ethernet with IP protocol is supported in this demo (nDPI supports both IPv4 and IPv6), all other packets will be discarded\n\n");
    ether_warning_used = 1;
  }
  workflow->stats.total_discarded_bytes +=  header->len;
  return(nproto);
}

frag_off = ntohs(iph->frag_off);
proto = iph->protocol;

if(header->len < header->caplen) {
  static u_int8_t capture_size_warning_used = 0;

  if(capture_size_warning_used == 0) {
    if(!workflow->prefs.quiet_mode)
      NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
               "\n\nWARNING: capture size is less than actual packet size, some packets will be discarded\n\n");
    capture_size_warning_used = 1;
  }
}