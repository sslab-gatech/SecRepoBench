if(recheck_type)
    goto ether_type_check;

  if(vlan_packet)
    workflow->stats.vlan_packet_count++;

iph_check:
  if(ip_offset + sizeof(struct ndpi_iphdr) > header->caplen) {
    static u_int8_t cap_len_warning_used = 0;

    if(cap_len_warning_used == 0) {
      if(!workflow->prefs.quiet_mode)
        NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG, "Capture length smaller than expected\n");
      cap_len_warning_used = 1;
    }

    workflow->stats.total_discarded_bytes += header->len;
    return(nproto);
  }

  iph = (struct ndpi_iphdr *)&packet[ip_offset];
  proto = iph->protocol;
  frag_off = ntohs(iph->frag_off);