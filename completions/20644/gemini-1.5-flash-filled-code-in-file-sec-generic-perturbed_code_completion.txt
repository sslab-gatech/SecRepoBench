iph_check:
  if(((bpf_u_int32)ip_offset + sizeof(struct ndpi_iphdr)) > header->caplen) {
    goto v4_warning;
  }

  iph = (struct ndpi_iphdr *) &packet[ip_offset];

  if(iph->version == IPVERSION && cprototype != ETH_P_IP) {
    goto v4_warning;
  } else if(iph->version == 6 && cprototype != ETH_P_IPV6) {
    goto v4_warning;
  }

  if(vlan_packet)
    workflow->stats.vlan_packet_count++;

  if(recheck_type == 1)
    goto ether_type_check;

  if(iph->version == IPVERSION) {
    frag_off = ntohs(iph->frag_off);
    proto = iph->protocol;
  }