host_protocol_id = ndpi_network_ptree_match(ndpi_str, &addr);
	}
      }
    }

    if(flow->guessed_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
      ret.master_protocol = NDPI_PROTOCOL_UNKNOWN,
	ret.app_protocol = flow->guessed_protocol_id;
      ndpi_fill_protocol_category(ndpi_str, flow, &ret);
      goto invalidate_ptr;
    }

    if(flow->guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
      ret.master_protocol = NDPI_PROTOCOL_UNKNOWN,
	ret.app_protocol = flow->guessed_host_protocol_id;
      ndpi_fill_protocol_category(ndpi_str, flow, &ret);
      goto invalidate_ptr;
    }
  }

  /* Detect protocol */
  a = ndpi_detection_process_packet_bitmask(ndpi_str, flow, packet, packetlen, ndpi_selection_packet);

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_AND_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_AND_PROTOCOL_AND_IP_ID) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_IP_ID) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_IP_ID_AND_PAYLOAD) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_IP_ID_AND_PAYLOAD_AND_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2_AND_IP_ID_2) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2_AND_IP_ID_2_AND_PAYLOAD_2) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2_AND_IP_ID_2_AND_PAYLOAD_2_AND_PROTOCOL_2) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2_AND_IP_ID_2_AND_PAYLOAD_2_AND_PROTOCOL_2_AND_PAYLOAD_ID_3) {
    ret.master_protocol = flow->detected_protocol_stack[1], ret.app_protocol = flow->detected_protocol_stack[0];
    ndpi_fill_protocol_category(ndpi_str, flow, &ret);
    goto invalidate_ptr;
  }

  if(a & NDPI_PROTOCOL_BITMASK_PROTOCOL_FOUND_BY_PAYLOAD_ID_AND_IP_ID_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_AND_IP_ID_2_AND_PAYLOAD_AND_PROTOCOL_AND_PAYLOAD_ID_2_AND_IP_ID_2_AND_PAYLOAD_2_AND_PROTOCOL_2_AND_PAYLOAD_ID_3