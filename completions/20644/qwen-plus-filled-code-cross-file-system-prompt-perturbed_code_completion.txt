if(recheck_type) goto ether_type_check;

if(vlan_packet)
  workflow->stats.vlan_count++;

iph = (struct ndpi_iphdr *)&packet[ip_offset];

if(ip_offset + sizeof(struct ndpi_iphdr) > header->caplen)
  return(nproto);

if(iph->version == IPVERSION) {
  frag_off = ntohs(iph->frag_off);
  proto = iph->protocol;
}

if(header->caplen < header->len && workflow->prefs.warn_truncated) {
  static u_int8_t truncated_warning_used = 0;

  if(!truncated_warning_used) {
    NDPI_LOG(0, workflow->ndpi_struct, NDPI_LOG_DEBUG,
	     "\n\nWARNING: some packets are truncated: you should increase the snaplen (e.g. -s 1500 for standard Ethernet)\n");
    truncated_warning_used = 1;
  }
}