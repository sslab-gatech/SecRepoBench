ctry = try_chars;

if (utf8) {
  // For UTF-8 mode, convert to UTF-16 and get the lengths
  std::vector<w_char> ctry_utf16;
  u8_u16(ctry_utf16, ctry);
  ctryl = ctry_utf16.size();
  
  if (pAMgr) {
    std::vector<w_char> ckey_utf16;
    u8_u16(ckey_utf16, ckey);
    ckeyl = ckey_utf16.size();
  }
} else {
  // For non-UTF-8 mode, use the string lengths directly
  ctryl = ctry.length();
  
  if (pAMgr) {
    ckeyl = ckey.length();
  }
}