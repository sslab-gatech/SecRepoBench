int digit = 0;
while (p < end && isdigit((unsigned char)*p)) {
  digit = digit * 10 + (*p - '0');
  p++;
}

if (p == end || digit > INT_MAX) {
  mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid format string: %S", mrb_str_new(mrb, p, end - p));
  return NULL;
}

*valp = digit;
return p;