const char *start = p;
  mrb_int n = 0;

  while (p < end && isdigit((unsigned char)*p)) {
    if (n > (INT_MAX - (*p - '0')) / 10) {
      return NULL;
    }
    n = n * 10 + (*p++ - '0');
  }

  if (p == start) {
    return NULL; /* no digits scanned */
  }

  *valp = (int)n;
  return p;