while (p < end && isdigit((unsigned char)*p)) {
  mrb_int digit = *p - '0';
  if ((nextnumber > MRB_INT_MAX / 10) || 
      ((nextnumber == MRB_INT_MAX / 10) && (digit > MRB_INT_MAX % 10))) {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "Numeric overflow in format string");
  }
  nextnumber = nextnumber * 10 + digit;
  p++;
}
if (p == end || !isdigit((unsigned char)*(p-1))) {
  mrb_raise(mrb, E_ARGUMENT_ERROR, "Malformed format string");
}