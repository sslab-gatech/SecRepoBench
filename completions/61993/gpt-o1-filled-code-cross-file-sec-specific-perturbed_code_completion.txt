if (!csv_stream) {
	if (bptr > buf && *(bptr - 1) == '\0') {
		bptr--;
	}
	break;
} else {
	size_t new_len = 0;
	char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);

	if (!new_buf) {
		if (bptr > buf && *(bptr - 1) == '\0') {
			bptr--;
		}
		break;
	}

	/* Validate that we can safely add new_len to temp_len without overflow */
	if (new_len > SIZE_MAX - temp_len) {
		efree(new_buf);
		if (bptr > buf && *(bptr - 1) == '\0') {
			bptr--;
		}
		break;
	}

	temp_len += new_len;
	char *new_temp = erealloc(temp, temp_len + 1);
	tptr = new_temp + (tptr - temp);
	temp = new_temp;

	efree(buf);
	buf_len = new_len;
	bptr = buf = new_buf;
	hunk_begin = buf;

	line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
	line_end_len = buf_len - (size_t)(limit - buf);

	state = 0;
}