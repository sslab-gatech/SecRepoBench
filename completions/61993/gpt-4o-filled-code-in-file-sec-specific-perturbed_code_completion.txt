if (!csv_stream) {
    /* Handle the case of an unterminated enclosure */
    if (bptr > buf && *(bptr - 1) == '\0') {
        bptr--;
    }
    goto quit_loop;
}

char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
if (!new_buf) {
    /* Handle the case of an unterminated enclosure */
    if (bptr > buf && *(bptr - 1) == '\0') {
        bptr--;
    }
    goto quit_loop;
}