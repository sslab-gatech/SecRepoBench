if (csv_stream == NULL) {
    // Handle the case of an unterminated enclosure, potentially adjusting the position pointer to exclude the null character if needed,
    // and then exit the loop.
    if (tptr > temp) {
        tptr--;
    }
    *comp_end = '\0';
    return values;
} else {
    // Read the next line from the stream.
    size_t new_len;
    char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
    if (new_buf == NULL) {
        // Handle the unterminated enclosure similarly and exit the loop.
        if (tptr > temp) {
            tptr--;
        }
        *comp_end = '\0';
        return values;
    }

    // Update the buffer and related state variables for the new line.
    temp_len += new_len;
    char *new_temp = erealloc(temp, temp_len);
    tptr = new_temp + (size_t)(tptr - temp);
    temp = new_temp;

    efree(buf);
    buf_len = new_len;
    bptr = buf = new_buf;
    hunk_begin = buf;

    line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
    line_end_len = buf_len - (size_t)(limit - buf);

    state = 0;
}