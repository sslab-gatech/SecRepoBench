if (md->ulc) {
    ch = md->lc;
    md->ulc = 0;
}

if (php_stream_eof(md->stream)) {
    break;
}

if (ch == '\n') {
    size_t new_len = php_stream_get_line(md->stream, NULL, 0, &new_len);
    if (new_len > temp_len) {
        temp_len += new_len;
        char *new_temp = erealloc(temp, temp_len);
        tptr = new_temp + (size_t)(tptr - temp);
        temp = new_temp;
    }
    char *new_buf = emalloc(new_len);
    php_stream_get_line(md->stream, new_buf, new_len, &new_len);
    efree(buf);
    buf_len = new_len;
    bptr = buf = new_buf;
    hunk_begin = buf;

    line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
    line_end_len = buf_len - (size_t)(limit - buf);

    state = 0;
} else {
    php_error_docref(NULL, E_WARNING, "Enclosure opened for %zu bytes but no matching closing enclosure was found in that range", temp_len);
    efree(temp);
    zend_array_destroy(values);
    values = NULL;
    break;
}