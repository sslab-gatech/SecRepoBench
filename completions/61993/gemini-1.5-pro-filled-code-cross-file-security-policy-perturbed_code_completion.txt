if (csv_stream == NULL) {
	/* In case of string stream, we have to simulate EOF */
	inc_len = 0;
	/* Check if the last character is an enclosure.
	 * This allows to handle unterminated enclosures like fgetcsv() does */
	if (bptr > buf && *(bptr - 1) == enclosure) {
		*(bptr - 1) = '\0';
		tptr--;
	}
	break;
}

size_t new_len;
char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
if (!new_buf) {
	/* simulate EOF */
	inc_len = 0;
	/* Check if the last character is an enclosure.
	 * This allows to handle unterminated enclosures like fgetcsv() does */
	if (bptr > buf && *(bptr - 1) == enclosure) {
		*(bptr - 1) = '\0';
		tptr--;
	}
	break;
}