if (csv_stream == NULL) {
    // Handle the case of an unterminated enclosure
    if (hunk_begin != line_end) {
        // Adjust the position pointer to exclude the null character if needed
        bptr = line_end;
    }
    break;
}

ssize_t new_len = php_stream_get_line(csv_stream, buf, buf_len, &buf_len);
if (new_len <= 0) {
    // Handle the case where reading fails
    if (hunk_begin != line_end) {
        bptr = line_end; // Adjust position pointer
    }
    break;
}

// Update the buffer and related state variables for the new line
buf[new_len] = '\0'; // Ensure null termination
limit = buf + new_len;
line_end = (char *)php_fgetcsv_lookup_trailing_spaces(buf, new_len);
line_end_len = new_len - (size_t)(limit - buf);