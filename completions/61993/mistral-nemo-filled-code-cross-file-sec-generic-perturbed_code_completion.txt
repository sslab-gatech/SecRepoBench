/* nothing can be fetched if stream is NULL (e.g. str_getcsv()) */
	if (csv_stream == NULL) {
		if (hunk_begin != line_end) {
			/* add the embedded line end to the field */
			memcpy(tptr, hunk_begin, bptr - hunk_begin);
			tptr += (bptr - hunk_begin);
			hunk_begin = bptr;
		}

		/* add the embedded line end to the field */
		memcpy(tptr, line_end, line_end_len);
		tptr += line_end_len;

		/* unterminated enclosure, adjust position pointer to exclude null character */
		bptr--;

		/* nothing can be fetched, exit the loop */
		break;
	} else {
		/* read the next line from the stream */
		char *new_buf;
		size_t new_len;
		if (php_stream_get_line(csv_stream, NULL, 0, &new_len) == NULL) {
			/* reading failed, handle unterminated enclosure similarly and exit the loop */
			if (hunk_begin != line_end) {
				/* add the embedded line end to the field */
				memcpy(tptr, hunk_begin, bptr - hunk_begin);
				tptr += (bptr - hunk_begin);
				hunk_begin = bptr;
			}

			/* add the embedded line end to the field */
			memcpy(tptr, line_end, line_end_len);
			tptr += line_end_len;

			/* unterminated enclosure, adjust position pointer to exclude null character */
			bptr--;

			/* reading failed, exit the loop */
			break;
		}

		new_buf = emalloc(new_len + 1);
		if (php_stream_get_line(csv_stream, new_buf, new_len + 1, &new_len) == NULL) {
			efree(new_buf);
			/* reading failed, handle unterminated enclosure similarly and exit the loop */
			if (hunk_begin != line_end) {
				/* add the embedded line end to the field */
				memcpy(tptr, hunk_begin, bptr - hunk_begin);
				tptr += (bptr - hunk_begin);
				hunk_begin = bptr;
			}

			/* add the embedded line end to the field */
			memcpy(tptr, line_end, line_end_len);
			tptr += line_end_len;

			/* unterminated enclosure, adjust position pointer to exclude null character */
			bptr--;

			/* reading failed, exit the loop */
			break;
		}

		temp_len += new_len;
		char *new_temp = erealloc(temp, temp_len);
		tptr = new_temp + (size_t)(tptr - temp);
		temp = new_temp;

		efree(buf);
		buf_len = new_len;
		bptr = buf = new_buf;
		hunk_begin = buf;

		line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
		line_end_len = buf_len - (size_t)(limit - buf);

		state = 0;
	}