if (!csv_stream) {
    if (hunk_begin != line_end) {
        memcpy(tptr, hunk_begin, bptr - hunk_begin);
        tptr += (bptr - hunk_begin);
        hunk_begin = bptr;
    }
    if (state != 2) {
        /* Unterminated enclosure, treat as a normal character and add a null character to terminate the string. */
        *tptr++ = *hunk_begin;
    }
    break;
} else {
    new_len = php_stream_get_line(csv_stream, NULL, 0, &new_buf_len);
    if (new_len == 0) {
        if (hunk_begin != line_end) {
            memcpy(tptr, hunk_begin, bptr - hunk_begin);
            tptr += (bptr - hunk_begin);
            hunk_begin = bptr;
        }
        if (state != 2) {
            /* Unterminated enclosure, treat as a normal character and add a null character to terminate the string. */
            *tptr++ = *hunk_begin;
        }
        break;
    } else {
        new_buf = emalloc(new_len + 1);
        memcpy(new_buf, csv_stream->readbuf, new_len);
        new_buf[new_len] = '\0'; /* for safety */
    }
}