if (hunk_begin != line_end) {
		memcpy(tptr, hunk_begin, bptr - hunk_begin);
		tptr += (bptr - hunk_begin);
		hunk_begin = bptr;
	}

	/* add the embedded line end to the field */
	memcpy(tptr, line_end, line_end_len);
	tptr += line_end_len;

	/* nothing can be fetched if stream is NULL (e.g. str_getcsv()) */
	if (csv_stream == NULL) {
		/* handle unterminated enclosure */
		if (bptr == limit) {
			/* adjust position pointer to exclude null character */
			bptr--;
		}
		/* exit loop */
		continue;
	}

	/* read next line from stream */
	if ((new_len = php_stream_get_line(csv_stream, NULL, 0, &new_buf)) <= 0) {
		/* handle unterminated enclosure */
		if (bptr == limit) {
			/* adjust position pointer to exclude null character */
			bptr--;
		}
		/* exit loop */
		continue;
	}

	temp_len += new_len;
	char *new_temp = erealloc(temp, temp_len);
	tptr = new_temp + (size_t)(tptr - temp);
	temp = new_temp;

	efree(buf);
	buf_len = new_len;
	bptr = buf = new_buf;
	hunk_begin = buf;

	line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
	line_end_len = buf_len - (size_t)(limit - buf);

	state = 0;