// <MASK>
if (stream == NULL) {
    // handle the case of an unterminated enclosure
    if (hunk_begin!= line_end) {
        memcpy(tptr, hunk_begin, bptr - hunk_begin);
        tptr += (bptr - hunk_begin);
    }

    // add the embedded line end to the field
    memcpy(tptr, line_end, line_end_len);
    tptr += line_end_len;

    // nothing can be fetched if stream is NULL (e.g. str_getcsv())
    // so we just exit the loop
    break;
} else {
    // read the next line from the stream
    if (php_stream_get_line(stream, buf, buf_len, &new_len) == NULL) {
        // handle the unterminated enclosure similarly
        if (hunk_begin!= line_end) {
            memcpy(tptr, hunk_begin, bptr - hunk_begin);
            tptr += (bptr - hunk_begin);
        }

        // add the embedded line end to the field
        memcpy(tptr, line_end, line_end_len);
        tptr += line_end_len;

        // exit the loop
        break;
    }

    // update the buffer and related state variables for the new line
    temp_len += new_len;
    char *new_temp = erealloc(temp, temp_len);
    tptr = new_temp + (size_t)(tptr - temp);
    temp = new_temp;

    efree(buf);
    buf_len = new_len;
    bptr = buf = new_buf;
    hunk_begin = buf;

    line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
    line_end_len = buf_len - (size_t)(limit - buf);

    state = 0;
}
// </MASK>