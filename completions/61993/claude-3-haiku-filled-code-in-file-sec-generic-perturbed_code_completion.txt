if (stream == NULL) {
    if (buf) {
        efree(buf);
    }
    RETURN_FALSE;
}

char *new_buf;
size_t new_len;
if (php_stream_get_line(stream, &new_buf, PHP_STREAM_COPY_ALL, &new_len) == NULL) {
    if (buf) {
        efree(buf);
    }
    RETURN_FALSE;
}

temp_len += new_len;
char *new_temp = erealloc(temp, temp_len);
tptr = new_temp + (size_t)(tptr - temp);
temp = new_temp;

efree(buf);
buf_len = new_len;
bptr = buf = new_buf;
hunk_begin = buf;

line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
line_end_len = buf_len - (size_t)(limit - buf);

state = 0;