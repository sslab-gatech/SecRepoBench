if (!csv_stream) {
    /* Handle the case of an unterminated enclosure when the stream is NULL */
    if (hunk_begin != line_end) {
        bptr = line_end;
    }
    goto quit_loop_2;
} else {
    /* Read the next line from the stream */
    size_t new_len;
    char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
    if (!new_buf) {
        /* Handle the case of an unterminated enclosure */
        if (hunk_begin != line_end) {
            bptr = line_end;
        }
        goto quit_loop_2;
    }
    /* Update buffer and related state variables */
    temp_len += new_len;
    char *new_temp = erealloc(temp, temp_len);
    tptr = new_temp + (size_t)(tptr - temp);
    temp = new_temp;

    efree(buf);
    buf_len = new_len;
    bptr = buf = new_buf;
    hunk_begin = buf;

    line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
    line_end_len = buf_len - (size_t)(limit - buf);

    state = 0;
}