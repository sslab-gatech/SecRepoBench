if (csv_stream == NULL) {
    /* For str_getcsv(), we can't read more lines */
    bptr = (char *)memchr(bptr, '\0', limit - bptr);
    if (bptr) {
        bptr++;
    }
    break;
}

/* For file streams, read next line */
if (php_stream_get_line(csv_stream, NULL, 0, &buf_len) == NULL) {
    /* Unterminated enclosure at end of file */
    bptr = (char *)memchr(bptr, '\0', limit - bptr);
    if (bptr) {
        bptr++;
    }
    break;
}

/* Update buffer and state for new line */
buf = emalloc(buf_len + 1);
if (php_stream_get_line(csv_stream, buf, buf_len + 1, &buf_len) == NULL) {
    efree(buf);
    bptr = (char *)memchr(bptr, '\0', limit - bptr);
    if (bptr) {
        bptr++;
    }
    break;
}

bptr = buf;
hunk_begin = buf;
line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
line_end_len = buf_len - (size_t)(limit - buf);