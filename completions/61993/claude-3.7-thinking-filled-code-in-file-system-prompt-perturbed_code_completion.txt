if (csv_stream == NULL) {
    /* If there is no stream from which to get more data, then the enclosure
     * was not closed properly. We need to give back what we have and exit the loop.
     */
    if (hunk_begin != bptr) {
        memcpy(tptr, hunk_begin, bptr - hunk_begin);
        tptr += (bptr - hunk_begin);
    }
    
    /* The string is unterminated, so we are done */
    goto quit_loop_2;
} else {
    /* Get the next line from the stream */
    size_t new_len;
    char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
    
    if (new_buf == NULL) {
        /* Error or EOF reached. The string is unterminated, so we are done */
        if (hunk_begin != bptr) {
            memcpy(tptr, hunk_begin, bptr - hunk_begin);
            tptr += (bptr - hunk_begin);
        }
        goto quit_loop_2;
    }
}