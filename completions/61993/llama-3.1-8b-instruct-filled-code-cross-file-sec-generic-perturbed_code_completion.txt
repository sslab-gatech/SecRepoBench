if (stream == NULL) {
    /* handle the case of an unterminated enclosure, potentially adjusting the position pointer to exclude the null character if needed, and then exit the loop */
    if (hunk_begin!= line_end) {
        memcpy(tptr, hunk_begin, bptr - hunk_begin);
        tptr += (bptr - hunk_begin);
        hunk_begin = bptr;
    }

    /* add the embedded line end to the field */
    memcpy(tptr, line_end, line_end_len);
    tptr += line_end_len;

    /* nothing can be fetched if stream is NULL (e.g. str_getcsv()) */
    temp_len += line_end_len;
    char *new_temp = erealloc(temp, temp_len);
    tptr = new_temp + (size_t)(tptr - temp);
    temp = new_temp;

    return values;
} else {
    /* nothing can be fetched if stream is NULL (e.g. str_getcsv()) */
    if (php_stream_get_line(stream, buf, buf_len, &buf_len) == NULL) {
        /* handle the case of an unterminated enclosure, potentially adjusting the position pointer to exclude the null character if needed, and then exit the loop */
        if (hunk_begin!= line_end) {
            memcpy(tptr, hunk_begin, bptr - hunk_begin);
            tptr += (bptr - hunk_begin);
            hunk_begin = bptr;
        }

        /* add the embedded line end to the field */
        memcpy(tptr, line_end, line_end_len);
        tptr += line_end_len;

        temp_len += line_end_len;
        char *new_temp = erealloc(temp, temp_len);
        tptr = new_temp + (size_t)(tptr - temp);
        temp = new_temp;

        return values;
    } else {
        /* nothing can be fetched if stream is NULL (e.g. str_getcsv()) */
        efree(buf);
        buf = emalloc(buf_len);
        if (php_stream_get_line(stream, buf, buf_len, &buf_len) == NULL) {
            /* handle the case of an unterminated enclosure, potentially adjusting the position pointer to exclude the null character if needed, and then exit the loop */
            if (hunk_begin!= line_end) {
                memcpy(tptr, hunk_begin, bptr - hunk_begin);
                tptr += (bptr - hunk_begin);
                hunk_begin = bptr;
            }

            /* add the embedded line end to the field */
            memcpy(tptr, line_end, line_end_len);
            tptr += line_end_len;

            temp_len += line_end_len;
            char *new_temp = erealloc(temp, temp_len);
            tptr = new_temp + (size_t)(tptr - temp);
            temp = new_temp;

            return values;
        } else {
            line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
            line_end_len = buf_len - (size_t)(limit - buf);
            state = 0;
        }
    }
}