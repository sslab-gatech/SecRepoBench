if (csv_stream == NULL) {
    /* Handle the case of an unterminated enclosure when the stream is NULL */
    if (bptr > buf && *(bptr - 1) == '\0') {
        bptr--; /* Exclude the null character */
    }
    goto quit_loop_2;
} else {
    /* Read the next line from the stream */
    size_t new_len;
    char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);

    if (new_buf == NULL) {
        /* Handle the case of an unterminated enclosure when reading fails */
        if (bptr > buf && *(bptr - 1) == '\0') {
            bptr--; /* Exclude the null character */
        }
        goto quit_loop_2;
    }
}