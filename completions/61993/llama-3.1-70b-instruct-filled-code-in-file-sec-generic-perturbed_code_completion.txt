if (md->ulc) {
    ch = md->lc;
    md->ulc = 0;
}

if (php_stream_eof(md->stream)) {
    break;
}

if (ch == '\n') {
    size_t new_len;
    ssize_t bytes_read;
    char *new_buf = php_stream_read(md->stream, &bytes_read);
    if (bytes_read > 0) {
        new_len = bytes_read;
        temp_len += new_len;
        char *new_temp = erealloc(temp, temp_len);
        tptr = new_temp + (size_t)(tptr - temp);
        temp = new_temp;

        efree(buf);
        buf_len = new_len;
        bptr = buf = new_buf;
        hunk_begin = buf;

        line_end = limit = (char *)php_fgetcsv_lookup_trailing_spaces(buf, buf_len);
        line_end_len = buf_len - (size_t)(limit - buf);

        state = 0;
    } else {
        if (bytes_read == -1) {
            php_error_docref(NULL, E_WARNING, "An error occurred while reading CSV data");
        }
        zend_array_destroy(values);
        values = NULL;
        break;
    }
} else {
    zend_array_destroy(values);
    values = NULL;
    break;
}