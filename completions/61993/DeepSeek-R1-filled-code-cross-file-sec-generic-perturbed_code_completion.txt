size_t new_len;
char *new_buf = NULL;

if (csv_stream) {
    new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
} else {
    new_buf = NULL;
    new_len = 0;
}

if (new_buf == NULL) {
    memcpy(tptr, line_end, line_end_len);
    tptr += line_end_len;
    line_end_len = 0;
    break;
}