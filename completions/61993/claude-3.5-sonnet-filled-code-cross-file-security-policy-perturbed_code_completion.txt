if (csv_stream == NULL) {
    bptr--;  // Exclude the null character
    goto quit_loop_2;
}

char *new_buf = NULL;
size_t new_len = 0;
if (php_stream_get_line(csv_stream, NULL, 0, &new_len) == NULL) {
    bptr--;  // Exclude the null character
    goto quit_loop_2;
}

new_buf = emalloc(new_len + 1);
if (php_stream_get_line(csv_stream, new_buf, new_len + 1, &new_len) == NULL) {
    efree(new_buf);
    bptr--;  // Exclude the null character
    goto quit_loop_2;
}