if (!csv_stream) {
    /* Handle the case of an unterminated enclosure for str_getcsv */
    if (hunk_begin != line_end) {
        memcpy(tptr, hunk_begin, bptr - hunk_begin);
        tptr += (bptr - hunk_begin);
    }
    break;
}

/* Read the next line from the stream */
char *new_buf;
size_t new_len = php_stream_get_line(csv_stream, &new_buf, 0, &buf_len);
if (new_len == 0 || !new_buf) {
    /* Handle the case of an unterminated enclosure at EOF */
    if (hunk_begin != line_end) {
        memcpy(tptr, hunk_begin, bptr - hunk_begin);
        tptr += (bptr - hunk_begin);
    }
    break;
}