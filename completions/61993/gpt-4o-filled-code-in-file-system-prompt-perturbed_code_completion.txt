if (!csv_stream) {
    /* no stream, we have an unterminated enclosure,
     * return the buffer, minus the null character */
    if (bptr > buf && bptr[-1] == '\0') {
        bptr--;
    }
    goto quit_loop_2;
}

size_t new_len;
char *new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len);
if (!new_buf) {
    /* no new line, we have an unterminated enclosure,
     * return the buffer, minus the null character */
    if (bptr > buf && bptr[-1] == '\0') {
        bptr--;
    }
    goto quit_loop_2;
}