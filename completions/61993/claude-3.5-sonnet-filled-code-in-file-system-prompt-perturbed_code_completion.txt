if (csv_stream == NULL) {
    if (bptr < buf + buf_len) {
        // Exclude the null character if it's present at the end
        if (*(buf + buf_len - 1) == '\0') {
            buf_len--;
        }
    }
    goto quit_loop_2;
} else {
    char *new_buf;
    size_t new_len;
    if ((new_buf = php_stream_get_line(csv_stream, NULL, 0, &new_len)) == NULL) {
        if (bptr < buf + buf_len) {
            // Exclude the null character if it's present at the end
            if (*(buf + buf_len - 1) == '\0') {
                buf_len--;
            }
        }
        goto quit_loop_2;
    }