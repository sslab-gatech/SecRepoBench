// Search the cached magic entries for a match.
LockSemaphoreInfo(magic_cache_semaphore);
p=GetFirstLinkedListNode(magic_cache);
while (p!= (const MagicInfo *) NULL)
{
  if (p->size <= size)
    {
      if (memcmp(magic, p->magic, p->size) == 0)
        break;
    }
  p=GetNextLinkedListNode(p);
}
UnlockSemaphoreInfo(magic_cache_semaphore);

// If no match is found in the cache, or if the magic is null, proceed to search the main magic list.
if (p == (const MagicInfo *) NULL)
{
  LockSemaphoreInfo(magic_list_semaphore);
  p=GetFirstLinkedListNode(magic_list);
  while (p!= (const MagicInfo *) NULL)
  {
    if (p->size <= size)
    {
      if (memcmp(magic, p->magic, p->size) == 0)
        break;
    }
    p=GetNextLinkedListNode(p);
  }
  // Unlock the semaphore and return null if no match is found.
  if (p == (const MagicInfo *) NULL)
    {
      UnlockSemaphoreInfo(magic_list_semaphore);
      return((const MagicInfo *) NULL);
    }
}