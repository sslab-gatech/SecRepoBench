// Ensure the exception pointer is not null and that the magic list and cache are initialized.
  if (exception == (ExceptionInfo *) NULL)
    return((const MagicInfo *) NULL);
  if (IsMagicCacheInstantiated() == MagickFalse)
    return((const MagicInfo *) NULL);
  if (magic == (const unsigned char *) NULL)
    return((const MagicInfo *) NULL);

  LockSemaphoreInfo(magic_cache_semaphore);
  ResetLinkedListIterator(magic_cache);
  p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache);
  while (p != (const MagicInfo *) NULL)
  {
    if (MatchesMagic(magic, size, p) != MagickFalse)
      {
        UnlockSemaphoreInfo(magic_cache_semaphore);
        return(p);
      }
    p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache);
  }
  UnlockSemaphoreInfo(magic_cache_semaphore);

  LockSemaphoreInfo(magic_list_semaphore);
  ResetLinkedListIterator(magic_list);
  p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
  while (p != (const MagicInfo *) NULL)
  {
    if (MatchesMagic(magic, size, p) != MagickFalse)
      {
        UnlockSemaphoreInfo(magic_list_semaphore);
        return(p);
      }
    p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
  }
  UnlockSemaphoreInfo(magic_list_semaphore);