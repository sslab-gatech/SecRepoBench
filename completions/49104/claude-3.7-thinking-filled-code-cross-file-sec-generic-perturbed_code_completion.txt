if (exception == (ExceptionInfo *) NULL)
  return((const MagicInfo *) NULL);

if ((magic_list == (LinkedListInfo *) NULL) ||
    (IsMagicCacheInstantiated() == MagickFalse))
  return((const MagicInfo *) NULL);

p=(const MagicInfo *) NULL;
if (magic != (const unsigned char *) NULL)
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    ResetLinkedListIterator(magic_cache);
    p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    while (p != (const MagicInfo *) NULL)
      {
        if ((size >= p->length) &&
            (memcmp(magic,p->magic,p->length) == 0))
          break;
        p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
      }
    UnlockSemaphoreInfo(magic_cache_semaphore);
    if (p != (const MagicInfo *) NULL)
      return(p);
  }

if (magic_list_semaphore == (SemaphoreInfo *) NULL)
  ActivateSemaphoreInfo(&magic_list_semaphore);
LockSemaphoreInfo(magic_list_semaphore);
ResetLinkedListIterator(magic_list);
p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
while (p != (const MagicInfo *) NULL)
  {
    if ((magic != (const unsigned char *) NULL) &&
        (size >= p->length) &&
        (memcmp(magic,p->magic,p->length) == 0))
      break;
    p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
  }