if (exception == (ExceptionInfo *) NULL)
  ThrowFatalException(OptionError,"Null exception pointer encountered");
if ((magic_list == (LinkedListInfo *) NULL) || (magic_cache == (LinkedListInfo *) NULL))
  {
    if (IsMagicCacheInstantiated() == MagickFalse)
      return((const MagicInfo *) NULL);
  }
p=(const MagicInfo *) NULL;
if ((magic != (const unsigned char *) NULL) && (size > 0))
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    for (p=(const MagicInfo *) GetFirstValueInLinkedList(magic_cache); p != (const MagicInfo *) NULL; p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache))
    {
      if ((size >= p->offset + p->length) && (memcmp(p->pattern,magic+p->offset,p->length) == 0))
        break;
    }
    UnlockSemaphoreInfo(magic_cache_semaphore);
  }
if (p == (const MagicInfo *) NULL)
  {
    LockSemaphoreInfo(magic_list_semaphore);
    ResetLinkedListIterator(magic_list);
    for (p=(const MagicInfo *) GetNextValueInLinkedList(magic_list); p != (const MagicInfo *) NULL; p=(const MagicInfo *) GetNextValueInLinkedList(magic_list))
    {
      if ((size >= p->offset + p->length) && (memcmp(p->pattern,magic+p->offset,p->length) == 0))
        break;
    }
  }