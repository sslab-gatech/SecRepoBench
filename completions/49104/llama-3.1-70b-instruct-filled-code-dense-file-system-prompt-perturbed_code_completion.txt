p=(const MagicInfo *) NULL;
if (magic!= (const unsigned char *) NULL)
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    ResetLinkedListIterator(magic_cache);
    p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    while (p!= (const MagicInfo *) NULL)
    {
      if ((size_t) (p->offset+p->extent) > size)
        {
          p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
          continue;
        }
      if (memcmp(magic+p->offset,p->magic,p->extent) == 0)
        break;
      p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    }
    UnlockSemaphoreInfo(magic_cache_semaphore);
  }
if (p == (const MagicInfo *) NULL)
  {
    LockSemaphoreInfo(magic_list_semaphore);
    ResetLinkedListIterator(magic_list);
    p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
    while (p!= (const MagicInfo *) NULL)
    {
      if ((size_t) (p->offset+p->extent) > size)
        {
          p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
          continue;
        }
      if (memcmp(magic+p->offset,p->magic,p->extent) == 0)
        break;
      p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
    }
  }