// Ensure the exception pointer is not null and that the magic list and cache are initialized.
  // If magic is not null, search the cached magic entries for a match.
  // Lock the cache semaphore to safely iterate through the cached list and compare each entry with the input.
  // If a match is found, return the matching entry from the cache and unlock the semaphore.
  // If no match is found in the cache, or if the magic is null, proceed to search the main magic list.
  // Lock the list semaphore to safely iterate through the main list and compare each entry with the input.
  // For each entry, if a match is found, break the loop to return the matching entry.
  // If a match is found during either search, return the matching entry; otherwise, unlock the semaphore and return null.
  if (exception == (ExceptionInfo *) NULL)
  {
    if (p != (const MagicInfo *) NULL)
    {
      LockSemaphoreInfo(magic_cache_semaphore);
      (void) InsertValueInSortedLinkedList(magic_cache,CompareMagickInfoExtent,
        NULL,p);
      UnlockSemaphoreInfo(magic_cache_semaphore);
    }
    return(p);
  }

  if (magic == (const unsigned char *) NULL)
  {
    UnlockSemaphoreInfo(magic_list_semaphore);
    if (p != (const MagicInfo *) NULL)
    {
      LockSemaphoreInfo(magic_cache_semaphore);
      (void) InsertValueInSortedLinkedList(magic_cache,CompareMagickInfoExtent,
        NULL,p);
      UnlockSemaphoreInfo(magic_cache_semaphore);
    }
    return(p);
  }

  LockSemaphoreInfo(magic_cache_semaphore);
  p = (const MagicInfo *) SearchCachedMagicEntries(magic, size);
  if (p != (const MagicInfo *) NULL)
  {
    UnlockSemaphoreInfo(magic_cache_semaphore);
    if (p != (const MagicInfo *) NULL)
    {
      LockSemaphoreInfo(magic_cache_semaphore);
      (void) InsertValueInSortedLinkedList(magic_cache,CompareMagickInfoExtent,
        NULL,p);
      UnlockSemaphoreInfo(magic_cache_semaphore);
    }
    return(p);
  }
  UnlockSemaphoreInfo(magic_cache_semaphore);

  LockSemaphoreInfo(magic_list_semaphore);
  p = (const MagicInfo *) SearchMainMagicList(magic, size);
  if (p != (const MagicInfo *) NULL)
  {
    UnlockSemaphoreInfo(magic_list_semaphore);
    if (p != (const MagicInfo *) NULL)
    {
      LockSemaphoreInfo(magic_cache_semaphore);
      (void) InsertValueInSortedLinkedList(magic_cache,CompareMagickInfoExtent,
        NULL,p);
      UnlockSemaphoreInfo(magic_cache_semaphore);
    }
    return(p);
  }
  UnlockSemaphoreInfo(magic_list_semaphore);

  if (p != (const MagicInfo *) NULL)
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    (void) InsertValueInSortedLinkedList(magic_cache,CompareMagickInfoExtent,
      NULL,p);
    UnlockSemaphoreInfo(magic_cache_semaphore);
  }
  return(p);