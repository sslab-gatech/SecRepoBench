assert(exception != (ExceptionInfo *) NULL);
  if (magic_list == (LinkedListInfo *) NULL)
    {
      if (magic_list_semaphore == (SemaphoreInfo *) NULL)
        ActivateSemaphoreInfo(&magic_list_semaphore);
      LockSemaphoreInfo(magic_list_semaphore);
      if (magic_list == (LinkedListInfo *) NULL)
        magic_list=AcquireMagicList(exception);
      UnlockSemaphoreInfo(magic_list_semaphore);
    }
  if (magic_cache == (LinkedListInfo *) NULL)
    (void) IsMagicCacheInstantiated();
  p=(const MagicInfo *) NULL;
  if (magic != (const unsigned char *) NULL)
    {
      const MagicInfo
        *q;

      LockSemaphoreInfo(magic_cache_semaphore);
      ResetLinkedListIterator(magic_cache);
      q=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
      while (q != (const MagicInfo *) NULL)
      {
        if ((q->length != 0) && (q->length <= size) &&
            (memcmp(magic,q->magic,q->length) == 0))
          {
            p=q;
            break;
          }
        q=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
      }
      UnlockSemaphoreInfo(magic_cache_semaphore);
      if (p != (const MagicInfo *) NULL)
        return(p);
    }
  LockSemaphoreInfo(magic_list_semaphore);
  ResetLinkedListIterator(magic_list);
  p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
  while (p != (const MagicInfo *) NULL)
  {
    if ((p->length != 0) && (p->length <= size) &&
        (memcmp(magic,p->magic,p->length) == 0))
      break;
    p=(const MagicInfo *) GetNextValueInLinkedList(magic_list);
  }