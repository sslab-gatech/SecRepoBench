assert(exception != (ExceptionInfo *) NULL);
  assert(magic_list_semaphore != (SemaphoreInfo *) NULL);
  assert(magic_cache_semaphore != (SemaphoreInfo *) NULL);

  p = (const MagicInfo *) NULL;

  if (magic != (const unsigned char *) NULL)
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    if (IsMagicCacheInstantiated() != MagickFalse)
    {
      ResetLinkedListIterator(magic_cache);
      while ((p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache)) != (const MagicInfo *) NULL)
      {
        if ((size >= p->length) && (memcmp(magic, p->magic, p->length) == 0))
          break;
      }
    }
    UnlockSemaphoreInfo(magic_cache_semaphore);
    if (p != (const MagicInfo *) NULL)
      return p;
  }

  LockSemaphoreInfo(magic_list_semaphore);
  if (magic_list == (LinkedListInfo *) NULL)
    magic_list = GetMagicList("*", 0, exception);
  if (magic_list != (LinkedListInfo *) NULL)
  {
    ResetLinkedListIterator(magic_list);
    while ((p = (const MagicInfo *) GetNextValueInLinkedList(magic_list)) != (const MagicInfo *) NULL)
    {
      if ((magic == (const unsigned char *) NULL) || ((size >= p->length) && (memcmp(magic, p->magic, p->length) == 0)))
        break;
    }
  }