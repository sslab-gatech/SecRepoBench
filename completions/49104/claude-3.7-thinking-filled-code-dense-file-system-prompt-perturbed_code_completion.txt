assert(exception != (ExceptionInfo *) NULL);
if (IsMagicTreeInstantiated(exception) == MagickFalse)
  return((const MagicInfo *) NULL);
p=(const MagicInfo *) NULL;
if ((magic != (const unsigned char *) NULL) && (size > 0))
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    ResetLinkedListIterator(magic_cache);
    p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    while (p != (const MagicInfo *) NULL)
    {
      if ((size_t) (p->offset+p->length) <= size)
        if (memcmp(magic+p->offset,p->magic,p->length) == 0)
          break;
      p=(const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    }
    if (p != (const MagicInfo *) NULL)
      {
        (void) InsertValueInLinkedList(magic_cache,0,
          RemoveElementByValueFromLinkedList(magic_cache,p));
        UnlockSemaphoreInfo(magic_cache_semaphore);
        return(p);
      }
    UnlockSemaphoreInfo(magic_cache_semaphore);
  }
LockSemaphoreInfo(magic_list_semaphore);
ResetSplayTreeIterator(magic_list);
p=(const MagicInfo *) GetNextValueInSplayTree(magic_list);
while (p != (const MagicInfo *) NULL)
  {
    if ((magic != (const unsigned char *) NULL) && (size > 0))
      {
        if ((size_t) (p->offset+p->length) <= size)
          if (memcmp(magic+p->offset,p->magic,p->length) == 0)
            break;
      }
    p=(const MagicInfo *) GetNextValueInSplayTree(magic_list);
  }