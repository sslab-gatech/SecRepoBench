if (magic != (const unsigned char *) NULL)
{
  LockSemaphoreInfo(magic_cache_semaphore);
  p=FindValueInSortedLinkedList(magic_cache,CompareMagickInfoExtent,magic,size);
  if (p == (const MagicInfo *) NULL)
    {
      p=(const MagicInfo *) AcquireCriticalMagickInfo();
      p->magic=AcquireString(magic,size);
      p->size=size;
      p->next=(MagicInfo *) NULL;
    }
  UnlockSemaphoreInfo(magic_cache_semaphore);
}
else
{
  LockSemaphoreInfo(magic_list_semaphore);
  p=FindValueInSortedLinkedList(magic_list,MagicCompare,magic,size);
  if (p == (const MagicInfo *) NULL)
    {
      p=(const MagicInfo *) AcquireCriticalMagickInfo();
      p->magic=AcquireString(magic,size);
      p->size=size;
      p->next=(MagicInfo *) NULL;
      (void) InsertValueInSortedLinkedList(magic_list,MagicInfoCompare,NULL,p);
    }
  UnlockSemaphoreInfo(magic_list_semaphore);
}