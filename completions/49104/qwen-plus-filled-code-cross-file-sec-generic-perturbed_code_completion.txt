if (exception == (ExceptionInfo *) NULL)
  ThrowFatalException(ExceptionAccessError,"Null exception pointer encountered");

if ((magic_list == (LinkedListInfo *) NULL) || 
    (magic_cache == (LinkedListInfo *) NULL))
{
  if (IsMagicCacheInstantiated() == MagickFalse)
    return((const MagicInfo *) NULL);
}

p = (const MagicInfo *) NULL;

if ((magic != (const unsigned char *) NULL) && (size > 0))
{
  LockSemaphoreInfo(magic_cache_semaphore);
  for (i=0; i < GetLinkedListLength(magic_cache); i++)
  {
    const MagicInfo *cached_info = (const MagicInfo *) GetLinkedListItem(magic_cache, i);
    if (CompareMagickInfoExtent(cached_info, magic, size) == 0)
    {
      p = cached_info;
      break;
    }
  }
  UnlockSemaphoreInfo(magic_cache_semaphore);

  if (p != (const MagicInfo *) NULL)
    return(p);
}

LockSemaphoreInfo(magic_list_semaphore);
for (i=0; i < GetLinkedListLength(magic_list); i++)
{
  const MagicInfo *list_info = (const MagicInfo *) GetLinkedListItem(magic_list, i);
  if ((magic == (const unsigned char *) NULL) || 
      (CompareMagickInfoExtent(list_info, magic, size) == 0))
  {
    p = list_info;
    break;
  }
}