if (magic != NULL)
{
  size_t magic_size = size;
  if (magic_size > sizeof(p->magic))
    magic_size = sizeof(p->magic);

  if (IsMagicCacheInstantiated() != MagickFalse)
  {
    LockSemaphoreInfo(magic_cache_semaphore);
    if (FindValueInLinkedList(magic_cache,magic,magic_size,MagicCompare) == NULL)
    {
      p = (MagicInfo *) AllocateMemory(sizeof(*p));
      if (p != NULL)
      {
        p->magic = (unsigned char *) AllocateMemory(magic_size);
        if (p->magic != NULL)
        {
          memcpy(p->magic, magic, magic_size);
          p->magic[magic_size] = '\0';
          p->name = GetMagicName(p);
          (void) InsertValueInSortedLinkedList(magic_cache,MagicInfoCompare,NULL,p);
        }
        else
        {
          p = DestroyMagicInfo(p);
        }
      }
    }
    else
    {
      p = (MagicInfo *) FindValueInLinkedList(magic_cache,magic,magic_size,MagicCompare);
    }
    UnlockSemaphoreInfo(magic_cache_semaphore);
  }
  else
  {
    p = NULL;
  }
}
else
{
  p = NULL;
}