if (exception == (ExceptionInfo *) NULL)
  exception = (ExceptionInfo *) NULL;
if (magic == (const unsigned char *) NULL)
  return((const MagicInfo *) NULL);
if (IsMagicCacheInstantiated() == MagickFalse)
  return((const MagicInfo *) NULL);
LockSemaphoreInfo(magic_cache_semaphore);
ResetLinkedListIterator(magic_cache);
p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache);
for (; p!= (const MagicInfo *) NULL; )
{
  if (MatchesMagic(magic, size, p)!= MagickFalse)
    break;
  p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache);
}
if (p == (const MagicInfo *) NULL)
{
  UnlockSemaphoreInfo(magic_cache_semaphore);
  if (IsMagicListInstantiated(exception) == MagickFalse)
    return((const MagicInfo *) NULL);
  LockSemaphoreInfo(magic_list_semaphore);
  ResetLinkedListIterator(magic_list);
  p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
  for (; p!= (const MagicInfo *) NULL; )
  {
    if (MatchesMagic(magic, size, p)!= MagickFalse)
      break;
    p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
  }
  UnlockSemaphoreInfo(magic_list_semaphore);
}
else
  UnlockSemaphoreInfo(magic_cache_semaphore);