p=(const MagicInfo *) NULL;
if (magic != (const unsigned char *) NULL)
  {
    if (IsMagicCacheInstantiated() != MagickFalse)
      {
        LockSemaphoreInfo(magic_cache_semaphore);
        for (p=(const MagicInfo *) GetLinkedListNodeHead(magic_cache); p != (const MagicInfo *) NULL; )
        {
          if ((p->length <= size) && (memcmp(p->pattern,magic,p->length) == 0))
            break;
          p=(const MagicInfo *) GetNextLinkedListNode(magic_cache);
        }
        UnlockSemaphoreInfo(magic_cache_semaphore);
        if (p != (const MagicInfo *) NULL)
          return(p);
      }
  }
LockSemaphoreInfo(magic_list_semaphore);
for (p=(const MagicInfo *) GetLinkedListNodeHead(magic_list); p != (const MagicInfo *) NULL; )
{
  if ((p->length <= size) && (memcmp(p->pattern,magic,p->length) == 0))
    break;
  p=(const MagicInfo *) GetNextLinkedListNode(magic_list);
}