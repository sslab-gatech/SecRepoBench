LockSemaphoreInfo(magic_list_semaphore);
if (magic == NULL) {
    p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
    while (p != (const MagicInfo *) NULL) {
        if (MatchesMagic(magic, size, p)) {
            break;
        }
        p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
    }
} else {
    LockSemaphoreInfo(magic_cache_semaphore);
    ResetLinkedListIterator(magic_cache);
    p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    while (p != (const MagicInfo *) NULL) {
        if (MatchesMagic(magic, size, p)) {
            break;
        }
        p = (const MagicInfo *) GetNextValueInLinkedList(magic_cache);
    }
    if (p == (const MagicInfo *) NULL) {
        ResetLinkedListIterator(magic_list);
        p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
        while (p != (const MagicInfo *) NULL) {
            if (MatchesMagic(magic, size, p)) {
                break;
            }
            p = (const MagicInfo *) GetNextValueInLinkedList(magic_list);
        }
    }
    UnlockSemaphoreInfo(magic_cache_semaphore);
}