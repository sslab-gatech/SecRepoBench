// Search the cached magic entries for a match.
LockSemaphoreInfo(magic_cache_semaphore);
p=GetFirstValueInLinkedList(magic_cache);
while (p!= (const MagicInfo *) NULL)
{
  if (memcmp(p->magic,magic,p->offset) == 0)
    break;
  p=GetNextValueInLinkedList(magic_cache);
}
UnlockSemaphoreInfo(magic_cache_semaphore);

// If no match is found in the cache, or if the magic is null, proceed to search the main magic list.
if (p == (const MagicInfo *) NULL)
{
  LockSemaphoreInfo(magic_list_semaphore);
  p=GetFirstValueInLinkedList(magic_list);
  while (p!= (const MagicInfo *) NULL)
  {
    if (memcmp(p->magic,magic,p->offset) == 0)
      break;
    p=GetNextValueInLinkedList(magic_list);
  }
}