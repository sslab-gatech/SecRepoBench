->line[0].ptr[filename_start], "HTTP/1.", 7) == 0)) {
     return;
   }
 
   parse_response_code(ndpi_struct, flow);
 
   check_content_type_and_change_protocol(ndpi_struct, flow);
 
   ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, master_protocol, NDPI_CONFIDENCE_DPI);
 }
 
 static void process_response(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   struct ndpi_packet_struct *packet = &ndpi_struct->packet;
   u_int16_t master_protocol;
 
   ndpi_parse_packet_line_info(ndpi_struct, flow);
 
   master_protocol = NDPI_PROTOCOL_HTTP;
 
   if(packet->parsed_lines == 0 ||
      !(packet->line[0].len >= 7 &&
        strncasecmp((const char *)packet->line[0].ptr, "HTTP/1.", 7) == 0)) {
     return;
   }
 
   parse_response_code(ndpi_struct, flow);
 
   check_content_type_and_change_protocol(ndpi_struct, flow);
 
   ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_HTTP, master_protocol, NDPI_CONFIDENCE_DPI);
 }
 
 static void ndpi_search_http_tcp(struct ndpi_detection_module_struct *ndpi_struct,
          struct ndpi_flow_struct *flow) {
   struct ndpi_packet_struct *packet = &ndpi_struct->packet;
   u_int16_t filename_start;
 
   if(packet->payload_packet_len == 0)
     return;
 
   if(is_request(ndpi_struct, flow)) {
     process_request(ndpi_struct, flow, filename_start);
   } else if(is_response(ndpi_struct, flow)) {
     process_response(ndpi_struct, flow);
   }
 }
 
 /* ************************************************************* */
 
 static void ndpi_init_http_variables(struct ndpi_detection_module_struct *ndpi_struct,
            struct ndpi_flow_struct *flow) {
   flow->http.request_content_type = NULL;
   flow->http.content_type = NULL;
   flow->http.user_agent = NULL;
   flow->http.server = NULL;
   flow->http.nat_ip = NULL;
   flow->http.url = NULL;
   flow->http.filename = NULL;
   flow->http.detected_os = NULL;
   flow->http.method = NDPI_HTTP_METHOD_UNKNOWN;
   flow->http.response_status_code = 0;
 }
 
 /* ************************************************************* */
 
 static void ndpi_free_http_variables(struct ndpi_detection_module_struct *ndpi_struct,
            struct ndpi_flow_struct *flow) {
   if(flow->http.request_content_type) ndpi_free(flow->http.request_content_type);
   if(flow->http.content_type) ndpi_free(flow->http.content_type);
   if(flow->http.user_agent) ndpi_free(flow->http.user_agent);
   if(flow->http.server) ndpi_free(flow->http.server);
   if(flow->http.nat_ip) ndpi_free(flow->http.nat_ip);
   if(flow->http.url) ndpi_free(flow->http.url);
   if(flow->http.filename) ndpi_free(flow->http.filename);
   if(flow->http.detected_os) ndpi_free(flow->http.detected_os);
 }
 
 /* ************************************************************* */
 
 static void ndpi_http_init(struct ndpi_detection_module_struct *ndpi_struct,
            struct ndpi_flow_struct *flow) {
   ndpi_init_http_variables(ndpi_struct, flow);
 }
 
 /* ************************************************************* */
 
 static void ndpi_http_exit(struct ndpi_detection_module_struct *ndpi_struct,
            struct ndpi_flow_struct *flow) {
   ndpi_free_http_variables(ndpi_struct, flow);
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_idempotent(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.method == NDPI_HTTP_METHOD_GET ||
      flow->http.method == NDPI_HTTP_METHOD_HEAD ||
      flow->http.method == NDPI_HTTP_METHOD_PUT ||
      flow->http.method == NDPI_HTTP_METHOD_DELETE)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_safe(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.method == NDPI_HTTP_METHOD_GET ||
      flow->http.method == NDPI_HTTP_METHOD_HEAD)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_idempotent_post(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.method == NDPI_HTTP_METHOD_POST)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_cacheable(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.method == NDPI_HTTP_METHOD_GET ||
      flow->http.method == NDPI_HTTP_METHOD_HEAD)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_chunked(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "multipart/byteranges", 21) == 0)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_keep_alive(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "multipart/byteranges", 21) == 0)
     return 0;
   return 1;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_upgrade(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.method == NDPI_HTTP_METHOD_GET &&
      flow->http.upgrade)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_connection(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_key(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0 &&
      flow->http.upgrade &&
      flow->http.key)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_version(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0 &&
      flow->http.upgrade &&
      flow->http.version)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_protocol(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0 &&
      flow->http.upgrade &&
      flow->http.version &&
      flow->http.protocol)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_extensions(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0 &&
      flow->http.upgrade &&
      flow->http.version &&
      flow->http.extensions)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_origin(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0 &&
      flow->http.upgrade &&
      flow->http.version &&
      flow->http.origin)
     return 1;
   return 0;
 }
 
 /* ************************************************************* */
 
 static int ndpi_http_is_websocket_host(struct ndpi_detection_module_struct *ndpi_struct,
           struct ndpi_flow_struct *flow) {
   if(flow->http.content_type &&
      strncasecmp((const char *)flow->http.content_type, "websocket", 9) == 0 &&
      flow->http.connection &&
      strncasecmp((const char *)flow->http.connection, "upgrade", 7) == 0 &&
      flow->http.upgrade &&
      flow