const char *p = char_buffer, *pend = char_buffer + len;
  char buf[1024]; // Ensure this buffer size is sufficient for typical use cases
  char *n = buf;

  // Trim leading whitespace
  while (p < pend && ISSPACE(*p)) p++;

  // Check for hexadecimal prefixes
  if (p + 1 < pend && (*p == '0') && (*(p+1) == 'x' || *(p+1) == 'X')) {
    p += 2;
  }

  // Prepare and copy valid characters to the buffer, removing underscores
  while (p < pend) {
    if (*p == '_' && n > buf && isdigit(n[-1]) && (p + 1 < pend) && isdigit(p[1])) {
      // Skip underscores between digits
      p++;
      continue;
    }
    if (isdigit((unsigned char)*p) || *p == '.' || *p == 'e' || *p == 'E' || *p == '+' || *p == '-') {
      if (n - buf < sizeof(buf) - 1) { // Prevent buffer overflow
        *n++ = *p;
      } else {
        break; // Stop copying if buffer nears capacity
      }
    } else {
      break; // Stop at invalid character
    }
    p++;
  }