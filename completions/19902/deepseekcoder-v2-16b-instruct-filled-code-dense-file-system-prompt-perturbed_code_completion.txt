// <MASK>
  char buf[len + 1];
  const char *p = char_buffer;
  const char *pend = char_buffer + len;
  char *n = buf;
  while (p < pend && ISSPACE(*p)) p++;
  if (p < pend && (*p == '0' && (p[1] == 'x' || p[1] == 'X'))) {
    p += 2;
    while (p < pend && ISXDIGIT(*p)) *n++ = *p++;
  } else {
    int underscore = 0;
    while (p < pend) {
      if (*p == '_') {
        if (underscore) continue;
        underscore = 1;
      } else {
        *n++ = *p;
        underscore = 0;
      }
      p++;
    }
  }
  *n = '\0';
  p = buf;
  pend = n;
  goto nocopy;