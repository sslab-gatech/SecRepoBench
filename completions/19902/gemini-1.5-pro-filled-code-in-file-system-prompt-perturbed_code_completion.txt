char *end;
  double d;
  const char *n;

  if (len == 0) {
    if (badcheck) goto bad;
    return 0.0;
  }
  while (len > 0 && ISSPACE(*s)) {
    s++;
    len--;
  }
  if (s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    return mrb_str_len_to_inum(state, s, len, 16, badcheck).f;
  }
  if (badcheck && memchr(s, '\0', len)) {
    mrb_raise(state, E_ARGUMENT_ERROR, "string contains null byte");
  }

  /* remove underscores between digits */
  char buf[len + 1];
  n = buf;
  while (len--) {
    if (*s == '_') {
      if (badcheck && (s[1] == '_' || !ISALNUM(s[1]))) {
        goto bad;
      }
      s++;
      continue;
    }
    *n++ = *s++;
  }