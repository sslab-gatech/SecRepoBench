{
  const char *s = char_buffer;
  const char *end_buf = char_buffer + len;
  char buf[len + 1];  /* Buffer size is exactly the input length plus '\0' */
  char *ptr;

  /* 1. Trim leading whitespace */
  while (s < end_buf && ISSPACE(*s)) {
    s++;
  }

  /* 2. If the string begins with a hexadecimal prefix ("0x" or "0X"), copy it */
  if (s + 1 < end_buf && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    buf[0] = s[0];
    buf[1] = s[1];
    s += 2;
    ptr = buf + 2;
  }
  else {
    ptr = buf;
  }

  /* 3. Copy the rest of the string into buf while removing underscores between digits */
  for (; s < end_buf; s++) {
    if (*s == '_') {
      /* Only skip underscore if the previous character is a digit and the
         next character is also a digit */
      if (ptr != buf && isdigit((unsigned char)ptr[-1]) &&
          (s + 1 < end_buf && isdigit((unsigned char)s[1])))
      {
        continue;
      }
    }
    *ptr++ = *s;
  }

  /* Set pointer n to the end of the cleaned buffer; the cleaned buffer
     will then be null-terminated (see *n = '\0' below) */
  n = ptr;
}