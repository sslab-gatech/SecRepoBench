const char *p = s;
  const char *pend = s + len;
  char buf[256]; // Ensure the buffer is large enough for typical use cases
  char *n = buf;
  
  // Step 1: Trim leading whitespace
  while (p < pend && ISSPACE(*p)) p++;
  
  // Step 2: Check for hexadecimal prefix
  if (p + 1 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
  }
  
  // Step 3 & 4: Copy valid characters to buffer, removing underscores
  while (p < pend && n < buf + sizeof(buf) - 1) {
    if (*p == '_') {
      p++;
      continue;
    }
    *n++ = *p++;
  }
  
  // Ensure buffer is null-terminated
  if (n >= buf + sizeof(buf) - 1) {
    if (badcheck) goto bad;
    *n = '\0';
    return 0.0; // Return 0.0 if buffer overflows and badcheck is not set
  }