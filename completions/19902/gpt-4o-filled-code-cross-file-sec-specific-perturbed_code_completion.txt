const char *s = char_buffer;
  const char *send = char_buffer + len;
  char buf[256]; // Ensure the buffer is large enough for typical use cases
  char *n = buf;
  const char *p, *pend;
  char c;

  // Trim leading whitespace
  while (s < send && ISSPACE(*s)) s++;

  // Check for hexadecimal prefix
  if (s + 2 < send && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    *n++ = *s++;
    *n++ = *s++;
  }

  // Copy valid characters to buffer, removing underscores
  while (s < send) {
    c = *s++;
    if (c == '_') continue; // Skip underscores
    if (n - buf >= sizeof(buf) - 1) break; // Prevent buffer overflow
    *n++ = c;
  }