const char *p = char_buffer;
const char *pend = p + len;
char buf[64];
char *n = buf;
double d;
const char *end;

while (p < pend && ISSPACE(*p)) p++;

if (p + 2 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  while (p < pend && ISXDIGIT(*p)) {
    if (n < buf + sizeof(buf) - 1) *n++ = *p;
    p++;
  }
} else {
  while (p < pend) {
    if (ISDIGIT(*p) || *p == '.' || *p == 'e' || *p == 'E' || *p == '-' || *p == '+') {
      if (n < buf + sizeof(buf) - 1) *n++ = *p;
    } else if (*p == '_' && n > buf && ISDIGIT(*(n-1)) && p+1 < pend && ISDIGIT(*(p+1))) {
      // Skip underscore between digits
    } else {
      break;
    }
    p++;
  }
}

if (n == buf) {
  if (badcheck) goto bad;
  return 0.0;
}

if (n >= buf + sizeof(buf)) {
  if (badcheck) goto bad;
  n = buf + sizeof(buf) - 1;
}

goto nocopy;