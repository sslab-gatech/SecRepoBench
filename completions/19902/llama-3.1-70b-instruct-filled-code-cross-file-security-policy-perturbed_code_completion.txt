const char *p = s, *n = buf, *pend = buf + sizeof(buf) - 1;
while (p < s + len && n < pend) {
  if (ISSPACE(*p)) {
    p++;
  } else if (*p == '_') {
    p++;
  } else {
    *n++ = *p++;
  }
}
if (n >= pend) {
  mrb_raisef(state, E_ARGUMENT_ERROR, "buffer overflow");
  /* not reached */
}