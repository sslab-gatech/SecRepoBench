const char *p = s;
  const char *pend = s + len;
  char *n;
  char *end;
  double d;
  char buf[MRB_DOUBLE_SPRINTF_LEN];

  /* skip leading spaces */
  while (p < pend && ISSPACE(*p)) {
    p++;
  }
  if (p >= pend) {
    if (badcheck) goto bad;
    return 0.0;
  }

  /* hex or oct */
  n = buf;
  if (*p == '0') {
    p++;
    if (p < pend && (*p == 'x' || *p == 'X')) {
      p++;
      while (p < pend) {
        if (*p == '_') {
          p++;
          continue;
        }
        if (!ISXDIGIT(*p)) {
          if (badcheck) goto bad;
          break;
        }
        *n++ = *p++;
      }
      goto nocopy;
    }
  }

  /* decimal or float */
  while (p < pend) {
    switch (*p) {
      case '_':
        p++;
        continue;
      case '.': case 'e': case 'E':
        *n++ = *p++;
        break;
      case '+': case '-':
        if (n > buf && (*(n-1) == 'e' || *(n-1) == 'E')) {
          *n++ = *p++;
        }
        else if (badcheck) {
          goto bad;
        }
        else {
          goto nocopy;
        }
        break;
      default:
        if (ISDIGIT(*p)) {
          *n++ = *p++;
        }
        else {
          if (badcheck) goto bad;
          goto nocopy;
        }
        break;
    }
  }