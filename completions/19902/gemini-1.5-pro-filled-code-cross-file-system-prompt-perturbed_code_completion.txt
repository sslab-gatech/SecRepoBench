const char *p = char_buffer;
  const char *pend = char_buffer + len;
  char *n, *buf, *end;
  double d;

  /* skip spaces */
  while (p < pend && ISSPACE(*p)) {
    p++;
  }
  if (p >= pend) {
    if (badcheck) goto bad;
    return 0.0;
  }

  /* hex or oct */
  n = buf = (char*)mrb_malloc(mrb, len + 1);
  if (*p == '0') {
    char c = tolower((unsigned char)*(p + 1));
    if (c == 'x' || c == 'X') {
      p += 2;
      while (p < pend) {
        if (*p == '_') {
          p++;
          continue;
        }
        c = tolower((unsigned char)*p);
        if (!ISXDIGIT(c)) {
          if (badcheck) goto bad;
          break;
        }
        *n++ = c;
        p++;
      }
      goto nocopy;
    }
  }

  /* decimal or float */
  while (p < pend) {
    if (*p == '_') {
      p++;
      continue;
    }
    if (!ISDIGIT(*p)) {
      if (*p == '.' || tolower((unsigned char)*p) == 'e' || *p == '-' || *p == '+') {
        *n++ = *p;
        p++;
        continue;
      }
      if (badcheck) goto bad;
      break;
    }
    *n++ = *p++;
  }