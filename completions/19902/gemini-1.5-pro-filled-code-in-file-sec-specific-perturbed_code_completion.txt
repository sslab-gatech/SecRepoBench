double d = 0.0;
  char *end = NULL;
  const char *p = s;
  char buf[256]; // Buffer to store the cleaned input
  char *n = buf;

  while (ISSPACE(*p)) {
    p++;
  }
  if (*p == '-') {
    *n++ = *p++;
  }
  else if (*p == '+') {
    p++;
  }
  if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
    while (p < s + len) {
      if (ISXDIGIT(*p)) {
        *n++ = *p++;
      }
      else if (*p == '_') {
        p++;
      }
      else {
        break;
      }
    }
    if (n == buf || n >= buf + sizeof(buf)) {
      if (badcheck) goto bad;
      return 0.0;
    }
    if (badcheck && *p == '\0') {
      goto nullbyte;
    }
    goto nocopy;
  }

  while (p < s + len) {
    if (ISDIGIT(*p) || *p == '.' || *p == 'e' || *p == 'E' ||
        *p == '-' || *p == '+') {
      *n++ = *p++;
    }
    else if (*p == '_') {
      p++;
    }
    else {
      break;
    }
    if (n >= buf + sizeof(buf)) {
      goto bad;
    }
  }
  if (badcheck && *p == '\0') {
nullbyte:
    mrb_raise(state, E_ARGUMENT_ERROR, "string contains null byte");
    /* not reached */
  }