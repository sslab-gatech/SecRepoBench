char buf[256];
  char *p = buf;
  char *pend = buf + sizeof(buf) - 1;
  double d;

  while (isspace(*string)) string++; // Trim leading whitespace

  if (*string == '-' || *string == '+') {
    *p++ = *string++;
  }

  while (*string && (isdigit(*string) || *string == '.' || *string == 'e' || *string == 'E' || *string == '-')) {
    if (p < pend) {
      *p++ = *string;
    }
    string++;
  }

  *p = '\0'; // Null-terminate the buffer

  d = strtod(buf, NULL); // Convert the string to a double

  if (badcheck) {
    if (string[0] != '\0') {
      mrb_raisef(state, E_ARGUMENT_ERROR, "invalid string for float(%!s)", buf);
    }
  }

  return d;