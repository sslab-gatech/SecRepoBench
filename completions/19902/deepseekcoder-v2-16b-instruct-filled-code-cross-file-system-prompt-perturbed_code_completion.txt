char buf[1024];
  char *p, *pend, *n;
  double d;
  const char *end;

  // Copy the input string to the buffer, removing underscores
  n = buf;
  p = buf;
  pend = buf + sizeof(buf) - 1;

  // Skip leading whitespace
  while (char_buffer < len && ISSPACE(*char_buffer)) {
    char_buffer++;
  }

  // Check for and handle hexadecimal prefixes "0x" or "0X"
  if (len >= 2 && (char_buffer[0] == '0' && (char_buffer[1] == 'x' || char_buffer[1] == 'X'))) {
    char_buffer += 2;
    len -= 2;
  }

  // Copy valid characters to the buffer, removing underscores
  while (char_buffer < len && p < pend) {
    if (*char_buffer != '_') {
      *p++ = *char_buffer;
    }
    char_buffer++;
  }

  // Null-terminate the buffer
  *p = '\0';

  // Handle null byte termination
  if (p > buf && p[-1] == '\0') {
    p--;
  }

  // Convert the cleaned string in the buffer to a double
  d = mrb_float_read(buf, &end);

  // Check for formatting errors when 'badcheck' is true
  if (badcheck) {
    if (end == buf || *end != '\0') {
      goto bad;
    }
  }

  return d;