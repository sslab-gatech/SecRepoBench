const char *s = char_buffer;
  const char *send = s + len;
  char buf[128], *n = buf;
  const char *p, *pend;
  double d;
  char *end;

  /* Trim leading whitespace */
  while (s < send && ISSPACE(*s)) s++;

  /* Check for empty string after trimming */
  if (s >= send) {
    if (badcheck) goto bad;
    return 0.0;
  }

  /* Handle sign */
  if (*s == '+' || *s == '-') {
    *n++ = *s++;
  }

  /* Check for hex prefix */
  mrb_bool hex = FALSE;
  if (s + 2 <= send && s[0] == '0' && (s[1] | 0x20) == 'x') {
    hex = TRUE;
    *n++ = *s++;
    *n++ = *s++;
  }

  /* Process main number characters */
  while (s < send && n < buf + sizeof(buf) - 1) {
    if (*s == '_') {
      /* Validate underscore placement */
      if (n == buf || (s+1 >= send) || 
          (hex ? !ISHEX(*(s+1)) : !ISDIGIT(*(s+1)))) {
        if (badcheck) goto bad;
        break;
      }
      s++;
      continue;
    }

    if (hex ? ISHEX(*s) : ISDIGIT(*s)) {
      *n++ = *s++;
    }
    else if (*s == '.' || (hex && (*s | 0x20) == 'p') || (!hex && (*s | 0x20) == 'e')) {
      *n++ = *s++;
      /* Handle exponent part */
      if ((*s == '+' || *s == '-') && (s[-1] | 0x20) == (hex ? 'p' : 'e')) {
        *n++ = *s++;
      }
    }
    else {
      break;
    }
  }