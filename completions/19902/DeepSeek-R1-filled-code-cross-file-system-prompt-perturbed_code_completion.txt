char buf[128], *n = buf;
  const char *e = s + len;
  mrb_bool is_hex = FALSE;

  while (s < e && ISSPACE(*s)) {
    s++;
  }

  if (e - s >= 2 && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    is_hex = TRUE;
    if (n + 2 >= buf + sizeof(buf)) {
      if (badcheck) goto bad;
    }
    else {
      *n++ = *s++;
      *n++ = *s++;
    }
  }

  for (; s < e && n < buf + sizeof(buf) - 1; s++) {
    if (*s == '_') {
      mrb_bool prev_ok = (n > buf) && (ISDIGIT(*(n-1)) || (is_hex && ISHEX(*(n-1))));
      mrb_bool next_ok = (s + 1 < e) && (ISDIGIT(*(s+1)) || (is_hex && ISHEX(*(s+1))));
      if (!prev_ok || !next_ok) {
        if (badcheck) goto bad;
        continue;
      }
      continue;
    }
    if (is_hex) {
      if (!ISHEX(*s) && *s != '.' && *s != 'p' && *s != 'P' && *s != '+' && *s != '-') {
        if (badcheck) goto bad;
        continue;
      }
    }
    else {
      if (!ISDIGIT(*s) && *s != '.' && *s != 'e' && *s != 'E' && *s != '+' && *s != '-') {
        if (badcheck) goto bad;
        continue;
      }
    }
    *n++ = *s;
  }