char *buf = (char *)malloc(len + 1);
  if (buf == NULL) {
    mrb_raisef(mrb, E_RUNTIME_ERROR, "memory allocation failed");
  }

  // Trim leading whitespace
  while (len > 0 && isspace((unsigned char)*char_buffer)) {
    char_buffer++;
    len--;
  }

  // Check for hexadecimal prefix
  if (len >= 2 && (char_buffer[0] == '0' && (char_buffer[1] == 'x' || char_buffer[1] == 'X'))) {
    char_buffer += 2;
    len -= 2;
  }

  // Copy valid characters to buffer
  char *p = buf;
  const char *end = char_buffer + len;
  while (char_buffer < end) {
    if (isdigit((unsigned char)*char_buffer) || *char_buffer == '.' || *char_buffer == '-' || *char_buffer == '+') {
      *p++ = *char_buffer;
    } else if (*char_buffer == '_') {
      // Ignore underscores
    } else {
      // Invalid character found
      if (badcheck) {
        free(buf);
        goto bad;
      }
    }
    char_buffer++;
  }
  
  *p = '\0'; // Null-terminate the buffer

  double d = strtod(buf, &end);
  free(buf);