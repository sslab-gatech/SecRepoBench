char *buf = (char *)malloc(len + 1);
  if (buf == NULL) {
    mrb_raisef(state, E_RUNTIME_ERROR, "memory allocation failed");
  }

  // Trim leading whitespace
  while (len > 0 && isspace((unsigned char)*s)) {
    s++;
    len--;
  }

  // Check for hexadecimal prefix
  if (len >= 2 && (s[0] == '0' && (s[1] == 'x' || s[1] == 'X'))) {
    s += 2;
    len -= 2;
  }

  // Copy valid characters to buffer
  char *p = buf;
  const char *end = s + len;
  while (s < end) {
    if (isdigit((unsigned char)*s) || *s == '.' || *s == '-' || *s == '+') {
      *p++ = *s;
    } else if (*s == '_') {
      // Skip underscores
    } else {
      if (badcheck) {
        free(buf);
        goto bad;
      }
    }
    s++;
  }
  *p = '\0';

  // Convert to double
  double d = strtod(buf, &end);
  free(buf);