const char *p, *end, *n, *pend;
char buf[len + 1];
size_t i = 0;

// Trim leading whitespace
while (i < len && ISSPACE(char_buffer[i])) i++;

// Check for hexadecimal prefix
if (i + 1 < len && (char_buffer[i] == '0' && (char_buffer[i + 1] == 'x' || char_buffer[i + 1] == 'X'))) {
  i += 2;
}

// Copy valid characters to buffer, skipping underscores
for (n = buf; i < len; i++) {
  if (char_buffer[i] != '_') {
    *n++ = char_buffer[i];
  }
}

// Null-terminate the buffer
*n = '\0';
p = buf;
pend = n;