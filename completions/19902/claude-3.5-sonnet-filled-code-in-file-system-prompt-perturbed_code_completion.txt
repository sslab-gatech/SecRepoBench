const char *p = s;
const char *pend = s + len;
char *buf, *n;

// Skip leading whitespace
while (p < pend && ISSPACE(*p)) p++;

// Check for hexadecimal prefix
if (p + 2 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  return mrb_float_read(s, NULL);
}

// Allocate buffer for cleaned input
buf = (char*)mrb_malloc(state, len + 1);
n = buf;

// Copy valid characters to buffer, removing underscores
while (p < pend) {
  if (*p == '_') {
    p++;
    continue;
  }
  if (!ISDIGIT(*p) && *p != '.' && *p != 'e' && *p != 'E' && *p != '-' && *p != '+') {
    break;
  }
  *n++ = *p++;
}

// Handle null byte termination and check for errors
if (badcheck) {
  if (n == buf) goto bad;
  while (p < pend && ISSPACE(*p)) p++;
  if (p < pend) goto bad;
}