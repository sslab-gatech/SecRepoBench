const char *p = s;
  const char *pend = s + len;
  char *n;
  char *buf;
  char *end;
  double d;
  size_t blen = len + 1;

  if (len == 0) return 0.0;

  /* skip leading spaces */
  while (p < pend && ISSPACE(*p)) p++;

  /* check sign */
  if (*p == '-') {
    p++; blen++;
  }
  else if (*p == '+') { p++; }

  /* skip spaces after sign */
  while (p < pend && ISSPACE(*p)) p++;

  /* check for inf, nan */
  if (p+2 < pend && p[0] == 'i' && p[1] == 'n' && p[2] == 'f') {
    if (p+7 < pend && p[3] == 'i' && p[4] == 'n' && p[5] == 'i' && p[6] == 't' && p[7] == 'y') {
      return INFINITY;
    }
    return atof("inf");
  }
  if (p+2 < pend && p[0] == 'n' && p[1] == 'a' && p[2] == 'n') {
    return atof("nan");
  }

  /* hexadecimal */
  if (p+1 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    return mrb_str_to_dbl(state, p, (size_t)(pend - p), badcheck);
  }

  buf = (char *)mrb_malloc(state, blen);
  n = buf;
  while (p < pend) {
    if (*p == '_') {
      p++;
      if (p >= pend || !ISDIGIT(*p)) {
        if (badcheck) goto bad;
        break;
      }
    }
    *n++ = *p++;
  }