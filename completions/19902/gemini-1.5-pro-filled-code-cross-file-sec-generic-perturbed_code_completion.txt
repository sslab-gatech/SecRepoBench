const char *p = char_buffer;
  const char *pend = char_buffer + len;
  char *buf, *n, *end;
  double d;

  /* skip leading spaces */
  while (p < pend && ISSPACE(*p)) {
    p++;
  }
  if (p >= pend) {
    if (badcheck) goto bad;
    return 0.0;
  }

  /* hex or oct */
  if (*p == '0') {
    char c = tolower((unsigned char)*(p + 1));
    if (c == 'x' || c == 'b') {
      return mrb_cstr_to_inum(mrb, p, c == 'x' ? 16 : 2, badcheck).f;
    }
  }

  buf = (char *)mrb_malloc(mrb, len + 1);
  n = buf;
  while (p < pend && *p) {
    if (*p == '_') {
      p++;
      continue;
    }
    *n++ = *p++;
  }