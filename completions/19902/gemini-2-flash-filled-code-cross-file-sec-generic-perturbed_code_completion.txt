const char *p = char_buffer;
  const char *pend = p + len;
  char *buf, *n;
  const char *end;
  double d;
  int neg = 0;
  int hex = 0;
  size_t buflen;

  /* skip leading whitespaces */
  while (p < pend && ISSPACE(*p)) p++;
  if (p == pend) return 0.0;

  if (*p == '-') {
    neg = 1;
    p++;
  }
  else if (*p == '+') {
    p++;
  }

  if (pend - p >= 2 && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
    hex = 1;
  }

  buflen = pend - p + 1;
  buf = (char *)mrb_malloc(mrb, buflen);
  n = buf;

  while (p < pend) {
    if (ISDIGIT(*p)) {
      *n++ = *p;
    }
    else if (*p == '_') {
      if (ISDIGIT(n[-1])) {
        p++;
        continue;
      }
      else {
        mrb_free(mrb, buf);
        if (badcheck) {
          mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid string for float(%!s)", char_buffer);
        }
        return 0.0;
      }
    }
    else if (*p == '.' || *p == 'e' || *p == 'E' ||
             (*p == 'i' && pend - p >= 3 && strncmp(p, "inf", 3) == 0) ||
             (*p == 'I' && pend - p >= 3 && strncmp(p, "INF", 3) == 0) ||
             (*p == 'n' && pend - p >= 3 && strncmp(p, "nan", 3) == 0) ||
             (*p == 'N' && pend - p >= 3 && strncmp(p, "NAN", 3) == 0) ) {
      *n++ = *p;
    }
    else {
      break;
    }
    p++;
  }