const char *s = char_buffer;
  const char *send = char_buffer + len;
  char *n, *buf;
  double d;
  const char *p, *pend, *end;

  // Allocate a buffer to store the cleaned string
  buf = (char *)mrb_malloc(mrb, len + 1);
  n = buf;

  // Step 1: Trim leading whitespace
  while (s < send && ISSPACE(*s)) s++;

  // Step 2: Handle hexadecimal prefix
  if (s + 2 < send && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    if (badcheck) goto bad;
    mrb_free(mrb, buf);
    return 0.0; // Hexadecimal strings are not valid for float conversion
  }

  // Step 3 & 4: Copy valid characters, removing underscores
  while (s < send) {
    if (*s == '_') {
      if (badcheck && (s == char_buffer || s + 1 == send || !ISDIGIT(*(s + 1)))) {
        goto bad;
      }
      s++;
      continue;
    }
    if (!ISDIGIT(*s) && *s != '.' && *s != 'e' && *s != 'E' && *s != '+' && *s != '-') {
      if (badcheck) goto bad;
      break;
    }
    *n++ = *s++;
  }

  // Step 5: Null-terminate the cleaned string
  *n = '\0';
  p = buf;
  pend = n;

  // Free the buffer after use
  mrb_free(mrb, buf);