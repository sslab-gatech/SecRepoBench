char *end;
  double d;
  const char *q;
  char *n;
  char buf[24]; /* enough for 22 digits of max value + sign + NUL */
  char *p, *pend;

  while (ISSPACE(*s)) {
    s++;
  }

  if (s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    return mrb_str_len_to_inum(state, s, len, 16, badcheck);
  }

  if (!ISDIGIT(*s) && *s != '-' && *s != '+' && *s != '.') {
    if (badcheck) goto bad;
    return 0.0;
  }

  n = buf;
  p = (char*)s;
  pend = p + len;
  while (p < pend) {
    if (*p == '_') {
      if (badcheck && (p == s || p + 1 == pend || !ISDIGIT(*(p-1)) || !ISDIGIT(*(p+1)))) {
        goto bad;
      }
      p++;
      continue;
    }
    if (badcheck && *p == '\0') {
      goto bad;
    }
    *n++ = *p++;
    if (n - buf >= sizeof(buf)-1) {
      break;
    }
  }
  if (badcheck && n == buf) {
    goto bad;
  }
  if (badcheck && *(n-1) == '_') {
    goto bad;
  }