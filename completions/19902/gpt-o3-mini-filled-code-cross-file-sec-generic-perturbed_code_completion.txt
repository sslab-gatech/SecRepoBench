{
  const char *p_start = char_buffer;
  const char *p_end = char_buffer + len;
  char *dst;
  int is_hex = 0;

  /* Skip leading whitespace */
  while (p_start < p_end && ISSPACE(*p_start)) {
    p_start++;
  }

  /* Check for hexadecimal prefix "0x" or "0X" */
  if (p_end - p_start >= 2 && p_start[0] == '0' &&
      (p_start[1] == 'x' || p_start[1] == 'X')) {
    is_hex = 1;
  }

  /* Copy characters into buf, removing underscores */
  dst = buf;
  for (const char *s = p_start; s < p_end; s++) {
    if (*s == '_') {
      if (badcheck) {
        /* Underscore must be between valid digits/letters */
        if (dst == buf || s + 1 == p_end) {
          goto bad;
        }
        {
          char prev = *(dst - 1);
          char next = *(s + 1);
          if (is_hex) {
            int valid_prev = ((prev >= '0' && prev <= '9') ||
                              (prev >= 'a' && prev <= 'f') ||
                              (prev >= 'A' && prev <= 'F'));
            int valid_next = ((next >= '0' && next <= '9') ||
                              (next >= 'a' && next <= 'f') ||
                              (next >= 'A' && next <= 'F'));
            if (!valid_prev || !valid_next) {
              goto bad;
            }
          }
          else {
            if (!isdigit((unsigned char)prev) || !isdigit((unsigned char)next)) {
              goto bad;
            }
          }
        }
      }
      continue;  /* Skip underscore */
    }
    *dst++ = *s;
  }
  n = dst;
}