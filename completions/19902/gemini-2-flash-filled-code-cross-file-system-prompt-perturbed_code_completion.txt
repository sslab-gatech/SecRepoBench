const char *p = char_buffer;
  const char *pend = char_buffer + len;
  char buf[sizeof(double) * 3];
  char *n = buf;
  double d;
  const char *end;

  /* skip leading whitespace */
  while (p < pend && ISSPACE(*p)) p++;
  if (p == pend) return 0.0;

  /* check for hexadecimal prefix */
  if (pend - p >= 2 && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    if (badcheck) {
      mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid string for float(%!s)", char_buffer);
    }
    return 0.0;
  }

  /* copy valid chars to buffer, removing underscores */
  while (p < pend) {
    if (ISDIGIT(*p)) {
      *n++ = *p++;
    }
    else if (*p == '.') {
      *n++ = *p++;
    }
    else if (*p == 'e' || *p == 'E') {
      *n++ = *p++;
      if (p < pend && (*p == '+' || *p == '-')) {
        *n++ = *p++;
      }
    }
    else if (*p == '_') {
      p++; /* skip */
    }
    else {
      break;
    }
    if (n >= buf + sizeof(buf) - 1) {
      break;
    }
  }