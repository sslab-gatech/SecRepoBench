char buf[512];
const char *s = char_buffer, *send = s + len;
char *n = buf;
char *end, *pend;

/* If there's nothing to parse, return 0.0 or raise if badcheck is set */
if (len == 0) {
  if (badcheck) goto bad;
  return 0.0;
}

/* 1. Skip leading whitespace */
while (s < send && ISSPACE(*s)) {
  s++;
}

/* 2. Copy optional sign */
if (s < send && (*s == '+' || *s == '-')) {
  *n++ = *s++;
}

/* 3. Copy characters until whitespace, ignoring underscores and stopping at null byte if badcheck */
for (; s < send; s++) {
  if (ISSPACE(*s)) break;
  if (*s == '_') continue;
  if (*s == '\0') {
    if (badcheck) goto bad;
    break;
  }
  *n++ = *s;
  if ((size_t)(n - buf) >= sizeof(buf) - 1) break;
}

/* 4. Null-terminate the buffer and prepare for float reading */
*n = '\0';
p = buf;
pend = n;
goto nocopy;