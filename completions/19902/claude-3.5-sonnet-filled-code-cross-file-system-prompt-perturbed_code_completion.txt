const char *s0 = s, *send = s + len;

while (s < send && ISSPACE(*s)) s++;

if (s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
  return mrb_str_to_dbl(state, s, send - s, badcheck);
}

char buf[64];
char *p = buf;
char *n = buf + sizeof(buf) - 1;
char prev = 0;

while (s < send) {
  char c = *s++;
  if (c == '_') {
    if (p == buf) {
      if (badcheck) goto bad;
      continue;
    }
    if (prev == '_') {
      if (badcheck) goto bad;
      continue;
    }
  }
  else if (c == '\0') {
    if (badcheck) goto bad;
    continue;
  }
  else if (ISSPACE(c)) {
    while (s < send && ISSPACE(*s)) s++;
    if (s >= send) break;
    if (badcheck) goto bad;
  }
  if (p == n) {
    p = buf;
    goto nocopy;
  }
  prev = c;
  *p++ = c;
}