const char *p = char_buffer;
const char *pend = p + len;
char buf[64];
char *n = buf;
double d;
const char *end;

while (p < pend && ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  mrb_int num = mrb_str_len_to_inum(mrb, p, pend - p, 16, FALSE);
  return (double)num;
}

while (p < pend) {
  if (*p == '_') {
    p++;
    continue;
  }
  if (n - buf >= sizeof(buf) - 1) break;
  *n++ = *p++;
}

if (n == buf) {
  if (badcheck) goto bad;
  return 0.0;
}

if (*(n-1) == '\0') {
  n--;
  goto nocopy;
}