const char *p = s, *pend = s + len;
char *buf, *n;
double d;

while (p < pend && ISSPACE(*p)) p++;
if (p < pend && (*p == '+' || *p == '-')) p++;

if (p + 2 < pend && (p[0] == '0') && ((p[1] == 'x') || (p[1] == 'X'))) {
    return mrb_float_read(p, NULL);
}

size_t buf_size = len + 1;  // +1 for null terminator
buf = (char*)mrb_malloc(state, buf_size);
if (!buf) {
    mrb_raise(state, E_RUNTIME_ERROR, "Out of memory");
}

n = buf;
while (p < pend) {
    char c = *p++;
    if (c == '_') continue;
    if (n - buf >= (ptrdiff_t)buf_size - 1) {
        mrb_free(state, buf);
        mrb_raise(state, E_ARGUMENT_ERROR, "string too long");
    }
    *n++ = c;
}