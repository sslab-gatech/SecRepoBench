const char *p = char_buffer;
const char *pend = p + len;
char buf[64];  // Fixed-size buffer to prevent stack overflow
char *n = buf;

while (p < pend && ISSPACE(*p)) p++;

if (p < pend && (*p == '+' || *p == '-')) {
    *n++ = *p++;
}

if (p + 1 < pend && (p[0] == '0') && (p[1] == 'x' || p[1] == 'X')) {
    *n++ = *p++;
    *n++ = *p++;
}

while (p < pend) {
    char c = *p++;
    if (c == '_') continue;
    if (n - buf >= (int)sizeof(buf) - 1) {
        if (badcheck) goto bad;
        break;
    }
    *n++ = c;
}

if (n == buf) {
    if (badcheck) goto bad;
    return 0.0;
}