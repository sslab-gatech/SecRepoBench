const char *p = char_buffer;
  const char *pend = p + len;
  char buf[128];
  char *n = buf;
  double d;
  char *end;

  // trim leading whitespace
  while (p < pend && ISSPACE(*p)) p++;
  if (p == pend) return 0.0;

  if (pend - p > 1 && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    /* hexadecimal */
    return (double)mrb_str_len_to_inum(mrb, p, len, 16, badcheck);
  }

  while (p < pend) {
    if (ISDIGIT(*p)) {
      *n++ = *p;
    }
    else if (*p == '_') {
      /* skip */
    }
    else if (*p == '.' || *p == 'e' || *p == 'E' || *p == '+' || *p == '-') {
      *n++ = *p;
    }
    else {
      break;
    }
    if (n >= buf + sizeof(buf) - 1) {
      /* buffer overflow */
      return 0.0;
    }
    p++;
  }