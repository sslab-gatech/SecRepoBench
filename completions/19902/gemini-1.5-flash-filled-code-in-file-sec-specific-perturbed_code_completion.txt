char buf[256];
  char *p, *pend, *n;
  double d;
  char *end;
  size_t len = strlen(s);
  int base = 10;

  p = (char *)s;
  while (ISSPACE(*p)) {
    p++;
  }
  if (p[0] == '0') {
    switch (p[1]) {
      case 'x': case 'X':
        base = 16;
        break;
      case 'b': case 'B':
        base = 2;
        break;
      case 'o': case 'O':
        base = 8;
        break;
      default:
        base = 8;
        break;
    }
  }
  n = buf;
  pend = buf + sizeof(buf) - 1;
  for (; p < s + len; p++) {
    if (*p == '_') continue;
    if (!ISXDIGIT(*p) || (base == 10 && !ISDIGIT(*p)) || (base == 16 && !ISXDIGIT(*p)) || (base == 2 && (*p != '0' && *p != '1')) || (base == 8 && !ISOCTAL(*p))) {
      goto nocopy;
    }
    if (n < pend) *n++ = *p;
  }