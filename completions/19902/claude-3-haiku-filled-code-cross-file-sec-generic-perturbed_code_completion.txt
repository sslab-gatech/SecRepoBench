char *n, *p, *pend, *buf;
double d;

buf = alloca(len + 1);
memcpy(buf, s, len);
buf[len] = '\0';

p = buf;
while (ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  d = strtod(p, &end);
} else {
  d = strtod(p, &end);
}

if (badcheck) {
  if (p == end) {
    mrb_raisef(state, E_ARGUMENT_ERROR, "invalid string for float(%!s)", s);
  }
  while (end < buf + len && ISSPACE(*end)) end++;
  if (end < buf + len) {
    mrb_raisef(state, E_ARGUMENT_ERROR, "invalid string for float(%!s)", s);
  }
}

return d;