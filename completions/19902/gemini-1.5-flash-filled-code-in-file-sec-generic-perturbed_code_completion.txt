char *n = (char *)malloc(len + 1);
  char *p, *pend, *end;
  double d;
  char buf[256];

  if (!s) {
    if (badcheck) {
      goto bad;
    }
    return 0.0;
  }
  p = (char *)s;
  pend = p + len;
  while (p < pend && ISSPACE(*p)) {
    p++;
  }
  if (p >= pend) {
    if (badcheck) {
      goto bad;
    }
    return 0.0;
  }
  if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
    while (p < pend) {
      int c = *p;
      if (ISXDIGIT(c)) {
        *n++ = c;
      }
      else if (c == '_') {
        p++;
        if (p == pend || *p == '_') {
          if (badcheck) goto bad;
          break;
        }
      }
      else {
        break;
      }
      p++;
    }
    goto nocopy;
  }
  while (p < pend) {
    int c = *p;
    if (ISDIGIT(c) || c == '.' || c == '+' || c == '-' || c == 'e' || c == 'E') {
      *n++ = c;
    }
    else if (c == '_') {
      p++;
      if (p == pend || *p == '_') {
        if (badcheck) goto bad;
        break;
      }
    }
    else {
      break;
    }
    p++;
  }