const char *pend_input = char_buffer + len;
char buf[len + 1];
char *n = buf;
const char *p_orig = char_buffer;

/* 1. Trim leading whitespace */
while (p_orig < pend_input && ISSPACE(*p_orig)) {
  p_orig++;
}

/* 2. Check for and handle hexadecimal prefixes "0x" or "0X" */
if ((pend_input - p_orig) >= 2 && p_orig[0] == '0' &&
    (p_orig[1] == 'x' || p_orig[1] == 'X')) {
  *n++ = *p_orig++; /* copy '0' */
  *n++ = *p_orig++; /* copy 'x' or 'X' */
}

/* 3 & 4. Copy characters to buffer, removing underscores between digits */
for (; p_orig < pend_input; p_orig++) {
  if (*p_orig == '_') {
    /* Remove underscore if it is between two digits */
    if (n != buf && isdigit((unsigned char)n[-1]) &&
        (p_orig + 1 < pend_input) && isdigit((unsigned char)(p_orig[1])))
    {
      continue;
    }
  }
  *n++ = *p_orig;
}