char *buf = (char *)malloc(len + 1);
if (!buf) {
    mrb_raisef(mrb, E_ARGUMENT_ERROR, "memory allocation failed");
    return 0.0; // Return 0.0 on failure
}

const char *p = char_buffer;
const char *pend = char_buffer + len;
char *n = buf;

// Step 1: Trim leading whitespace
while (p < pend && ISSPACE(*p)) p++;

// Step 2: Check for hexadecimal prefixes
if (p + 1 < pend && (*p == '0') && (p[1] == 'x' || p[1] == 'X')) {
    p += 2; // Skip "0x" or "0X"
}

// Step 3: Prepare a buffer to store cleaned input
while (p < pend && *p != '\0') {
    if (isdigit(*p) || *p == '.' || *p == '-' || *p == '+' || *p == 'e' || *p == 'E') {
        *n++ = *p; // Copy valid characters
    } else if (*p != '_') {
        // Invalid character found
        if (badcheck) goto bad;
    }
    p++;
}

// Step 4: Handle null byte termination
*n = '\0';