for (; p < pend; p++) {
    if (p - buf >= buf_size) {
      // Buffer is full, truncate input and return a safe value.
      *pend = '\0';
      return d;
    }
    if (ISSPACE(*p)) continue;
    if (*p == '_') continue;
    if (badcheck && (*p == '+' || *p == '-')) {
      // Handle sign character, but only if 'badcheck' is true.
      if (p > buf) {
        // If there's already a sign character, raise an error.
        goto bad;
      }
      *p = '0';
    }
    *pend++ = *p;
  }
  *pend = '\0';
  goto nocopy;