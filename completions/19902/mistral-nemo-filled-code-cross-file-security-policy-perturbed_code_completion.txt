for (; p < pend; p++) {
    if (p - buf >= buf_size) {
      // Buffer is full, truncate input and return a safe value.
      *pend = '\0';
      return d;
    }
    if (ISSPACE(*p)) continue;
    if (*p == '_') continue;
    if (badcheck && *p == '.') {
      // Check for invalid floating point format.
      if (p == pend - 1 || *(p + 1) == '\0') goto bad;
    }
    *n++ = *p;
  }
  *n = '\0';