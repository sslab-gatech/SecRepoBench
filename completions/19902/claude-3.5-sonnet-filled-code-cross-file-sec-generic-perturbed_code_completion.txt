const char *p = char_buffer;
const char *pend = p + len;
char buf[64];
char *n = buf;
double d;
const char *end;

while (p < pend && ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  while (p < pend && ISXDIGIT(*p)) {
    if (n < buf + sizeof(buf) - 1) *n++ = *p;
    p++;
  }
} else {
  while (p < pend) {
    if (n >= buf + sizeof(buf) - 1) break;
    if (*p == '_') {
      p++;
      continue;
    }
    if (!ISDIGIT(*p) && *p != '.' && *p != 'e' && *p != 'E' &&
        *p != '+' && *p != '-') break;
    *n++ = *p++;
  }
}

if (n == buf) {
  if (badcheck) goto bad;
  return 0.0;
}

if (p < pend) {
  if (badcheck) goto bad;
}