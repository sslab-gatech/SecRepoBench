const char *p = s;
char buf[64], *n = buf;
char *end;
double d;

while (p < s + len && ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  return mrb_float_read(p, NULL);
}

for (; p < s + len && n < buf + sizeof(buf) - 1; p++) {
  if (*p == '_') continue;
  if (!ISDIGIT(*p) && *p != '.' && *p != 'e' && *p != 'E' &&
      *p != '+' && *p != '-') break;
  *n++ = *p;
}

if (n == buf) {
  if (badcheck) goto bad;
  return 0.0;
}

if (p < s + len) {
  if (badcheck) goto bad;
}