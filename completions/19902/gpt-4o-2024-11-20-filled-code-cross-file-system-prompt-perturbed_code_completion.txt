const char *s = char_buffer;
  const char *send = char_buffer + len;
  char *n, *buf;
  double d;
  const char *p, *pend, *end;

  /* Allocate buffer for cleaned input */
  buf = (char *)mrb_malloc(mrb, len + 1);
  n = buf;

  /* Trim leading whitespace */
  while (s < send && ISSPACE(*s)) s++;

  /* Handle hexadecimal prefix */
  if (s + 1 < send && *s == '0' && (*(s + 1) == 'x' || *(s + 1) == 'X')) {
    if (badcheck) goto bad;
    goto nocopy;
  }

  /* Remove underscores and copy valid characters */
  while (s < send) {
    if (*s == '_') {
      s++;
      continue;
    }
    if (!ISALNUM(*s) && *s != '.' && *s != 'e' && *s != 'E' && *s != '+' && *s != '-') {
      if (badcheck) goto bad;
      break;
    }
    *n++ = *s++;
  }