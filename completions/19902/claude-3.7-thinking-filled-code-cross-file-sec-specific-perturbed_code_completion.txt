char *p, *pend, buf[64];
  char *n = buf;
  const char *s = char_buffer;
  char *end;
  double d;

  while (s < char_buffer + len && ISSPACE(*s)) s++;

  if (s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    /* hexadecimal */
    s += 2;
    if (s >= char_buffer + len) {
      if (badcheck) goto bad;
      return 0.0;
    }
    for (;;) {
      if (s >= char_buffer + len) break;
      if (ISXDIGIT(*s)) {
        if (n - buf >= (int)sizeof(buf) - 1) break;
        *n++ = *s++;
      }
      else if (*s == '_') {
        s++;
      }
      else {
        break;
      }
    }
    if (n == buf) {
      if (badcheck) goto bad;
      return 0.0;
    }
    goto nocopy;
  }
  /* decimal */
  for (;;) {
    if (s >= char_buffer + len) break;
    if (ISDIGIT(*s) || *s == '.' || *s == 'e' || *s == 'E' || *s == '-' || *s == '+') {
      if (n - buf >= (int)sizeof(buf) - 1) break;
      *n++ = *s++;
    }
    else if (*s == '_') {
      if (s == char_buffer || !ISDIGIT(*(s-1)) || s >= char_buffer + len - 1 || !ISDIGIT(*(s+1))) {
        if (badcheck) goto bad;
        return 0.0;
      }
      s++;
    }
    else {
      break;
    }
  }
  if (n == buf) {
    if (badcheck) goto bad;
    return 0.0;
  }