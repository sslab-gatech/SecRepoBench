{
  char buf[256];
  char *n = buf;
  const char *s = char_buffer;
  const char *end_s = s + len;

  /* 1. Trim leading whitespace. */
  while (s < end_s && ISSPACE(*s)) {
    s++;
  }

  /* 3. Prepare buffer (buf) and 4. copy characters, removing underscores. */
  while (s < end_s && (n < (buf + sizeof(buf) - 1))) {
    if (*s == '_') {
      s++;
      continue;
    }
    *n++ = *s++;
  }

  /* 5. End of string will be handled below after <MASK>, so just continue. */
}