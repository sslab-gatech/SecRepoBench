char buf[40];
  char *n = buf;
  const char *p = s;
  const char *pend = s + len;
  double d;
  char *end;

  while (p < pend && ISSPACE(*p)) p++;
  if (p < pend && (*p == '+' || *p == '-')) *n++ = *p++;
  if (p < pend && (p[0] == '0' && (p[1] == 'x' || p[1] == 'X'))) {
    if (badcheck) goto bad;
    return 0.0;
  }
  while (p < pend) {
    if (n >= buf + sizeof(buf) - 1) {
      if (badcheck) goto bad;
      goto nocopy;
    }
    if (*p == '_') {
      p++;
      if (badcheck && p < pend && *p == '_') goto bad;
      continue;
    }
    if (badcheck && *p == '\0') goto nullbyte;
    if (ISDIGIT(*p) || *p == '.' || *p == 'e' || *p == 'E') {
      *n++ = *p++;
    }
    else {
      break;
    }
  }