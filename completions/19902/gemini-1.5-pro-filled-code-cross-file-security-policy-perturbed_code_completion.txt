const char *p = char_buffer;
  const char *pend = char_buffer + len;
  char *buf = (char *)mrb_malloc(mrb, len + 1);
  char *n = buf;
  double d;
  const char *end;

  /* skip leading spaces */
  while (p < pend && ISSPACE(*p))
    p++;
  /* skip trailing spaces */
  while (p < pend && ISSPACE(pend[-1]))
    pend--;

  if (p < pend && (*p == '+' || *p == '-')) {
    *n++ = *p++;
  }
  if (p < pend && *p == '0') {
    if (p + 1 < pend && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      goto nocopy;
    }
  }

  while (p < pend) {
    if (*p == '_') {
      p++;
      continue;
    }
    if (n >= buf + len) { // Check for buffer overflow
      break;             // Truncate if necessary
    }
    *n++ = *p++;
  }