char buf[128];
char *n = buf + sizeof(buf) - 1;
char *p = buf;
const char *pend;
mrb_bool prev_digit = FALSE;

while (len > 0 && ISSPACE(*s)) {
    s++;
    len--;
}

if (len > 0 && (*s == '+' || *s == '-')) {
    if (p < n) {
        *p++ = *s++;
        len--;
    }
    else if (badcheck) goto bad;
}

mrb_bool is_hex = FALSE;
if (len >= 2 && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    if (p + 2 <= n) {
        *p++ = *s++;
        *p++ = *s++;
        len -= 2;
        is_hex = TRUE;
    }
    else if (badcheck) goto bad;
}

for (size_t i = 0; i < len; i++) {
    char c = s[i];
    if (c == '_') {
        if (prev_digit && i + 1 < len) {
            char next = s[i+1];
            if (ISDIGIT(next) || (is_hex && ISHEX(next))) {
                prev_digit = FALSE;
                continue;
            }
        }
        if (badcheck) goto bad;
        continue;
    }

    int valid = ISDIGIT(c) || (is_hex && (ISHEX(c) || c == '.' || tolower(c) == 'p')) || (!is_hex && (c == '.' || tolower(c) == 'e'));
    
    if (valid) {
        if (p >= n) {
            if (badcheck) goto bad;
            break;
        }
        *p++ = c;
        prev_digit = ISDIGIT(c) || (is_hex && ISHEX(c));
    }
    else {
        if (badcheck) goto bad;
        break;
    }
}

if (p == buf && badcheck) goto bad;
*p = '\0';