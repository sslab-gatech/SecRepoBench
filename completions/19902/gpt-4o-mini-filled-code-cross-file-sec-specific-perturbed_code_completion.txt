char *buf = (char *)malloc(len + 1);
if (buf == NULL) {
    mrb_raisef(mrb, E_ARGUMENT_ERROR, "memory allocation failed");
    return 0.0; // or some appropriate error value
}

const char *p = char_buffer;
const char *pend = char_buffer + len;
char *n = buf;

while (p < pend && *p != '\0') {
    if (ISDIGIT(*p) || *p == '.' || *p == '-' || *p == '+' || *p == 'e' || *p == 'E') {
        *n++ = *p;
    } else if (*p == '_') {
        // Skip underscores
    } else {
        if (badcheck) {
            free(buf);
            goto bad;
        }
    }
    p++;
}

*n = '\0'; // Null-terminate the buffer

double d = mrb_float_read(buf, &end);
free(buf);