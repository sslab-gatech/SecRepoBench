char buf[256];
  const char *s = char_buffer;
  const char *send = char_buffer + len;
  char *n = buf;
  const char *p, *pend;
  char *end;
  double d;

  // Step 1: Trim leading whitespace
  while (s < send && ISSPACE(*s)) s++;

  // Step 2: Handle hexadecimal prefix
  if (s + 2 < send && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    if (badcheck) goto bad;
    return 0.0; // Hexadecimal floats are not supported
  }

  // Step 3: Copy valid characters to buffer, removing underscores
  while (s < send) {
    if (*s == '_') {
      s++;
      continue;
    }
    if (n - buf >= (ptrdiff_t)(sizeof(buf) - 1)) {
      if (badcheck) goto bad;
      break; // Prevent buffer overflow
    }
    *n++ = *s++;
  }