#ifndef MRB_WITHOUT_FLOAT
double
mrb_str_len_to_dbl(mrb_state *state, const char *s, size_t len, mrb_bool badcheck)
{
  // Parse a string to a double value, handling various string formats.
  // 1. Trim leading whitespace from the input string.
  // 2. Check for and handle hexadecimal prefixes "0x" or "0X".
  // 3. Prepare a buffer to store cleaned input by removing underscores between digits.
  // 4. Iterate over the string, copying valid characters to the buffer.
  // 5. Handle null byte termination, and check for formatting errors when 'badcheck' is true.
  // 6. Convert the cleaned string in the buffer to a double using a library function.
  // 7. Return the parsed double value.
  // <MASK>
  char buf[1024];
  char *p = buf;
  char *pend = buf + sizeof(buf);
  char *n = pend;
  double d;

  if (len == 0) {
    if (badcheck) {
      mrb_raisef(state, E_ARGUMENT_ERROR, "invalid string for float(%!s)", s);
      /* not reached */
    }
    return 0.0;
  }

  p = buf;
  pend = buf + sizeof(buf);
  while (p < pend) {
    if (*s == '_') {
      s++;
      if (p < pend && *s == '_') {
        if (badcheck) {
          mrb_raisef(state, E_ARGUMENT_ERROR, "invalid string for float(%!s)", s);
          /* not reached */
        }
        break;
      }
      continue;
    }
    if (badcheck && *s == '\0') {
      goto nullbyte;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'o' || p[1] == 'O')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'd' || p[1] == 'D')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      s += 2;
      continue;
    }
    if (p < pend && *s == '0' && (p[1] == 'b' || p[1] == 'B')) {
      p += 2;