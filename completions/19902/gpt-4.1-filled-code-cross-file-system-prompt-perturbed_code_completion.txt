const char *p = char_buffer;
  const char *pend = char_buffer + len;
  char buf[128];
  char *n = buf;
  double d;
  const char *end;

  /* 1. Trim leading whitespace */
  while (p < pend && ISSPACE(*p)) p++;

  /* 2. Check for hexadecimal prefix */
  if ((pend - p) >= 2 && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    if (badcheck) {
      mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid string for float(%!s)", char_buffer);
      /* not reached */
    }
    return 0.0;
  }

  /* 3. Prepare buffer and 4. Copy valid chars, removing underscores between digits */
  {
    const char *q = p;
    char prev = '\0';
    while (q < pend) {
      if (*q == '_') {
        /* underscore must be between digits */
        if (n == buf || !ISDIGIT(prev) || q+1 == pend || !ISDIGIT(*(q+1))) {
          if (badcheck) {
            mrb_raisef(mrb, E_ARGUMENT_ERROR, "invalid string for float(%!s)", char_buffer);
            /* not reached */
          }
          break;
        }
        q++;
        continue;
      }
      *n++ = *q;
      prev = *q;
      q++;
    }
    pend = q;
  }