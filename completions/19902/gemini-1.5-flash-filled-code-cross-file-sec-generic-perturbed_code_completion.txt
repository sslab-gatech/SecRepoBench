char buf[64];
  char *p, *n, *pend;
  double d;
  char *end;

  p = (char *)char_buffer;
  while (p < (char *)char_buffer + len && ISSPACE(*p)) p++;
  if (p >= (char *)char_buffer + len) {
    if (badcheck) goto bad;
    return 0.0;
  }
  n = buf;
  pend = buf + sizeof(buf) - 1;
  if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
    while (p < (char *)char_buffer + len) {
      if (ISXDIGIT(*p)) {
        *n++ = *p++;
      } else if (*p == '_') {
        p++;
      } else {
        break;
      }
      if (n >= pend) break;
    }
  } else {
    while (p < (char *)char_buffer + len) {
      if (ISDIGIT(*p) || *p == '.' || *p == '+' || *p == '-') {
        *n++ = *p++;
      } else if (*p == '_') {
        p++;
      } else {
        break;
      }
      if (n >= pend) break;
    }
  }