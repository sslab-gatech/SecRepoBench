const char *s = char_buffer;
  const char *send = char_buffer + len;
  char *buf = (char*)mrb_malloc(mrb, len + 1);
  char *n = buf;
  mrb_bool digit_before = FALSE;

  /* 1. Trim leading whitespace */
  while (s < send && ISSPACE(*s)) {
    s++;
  }

  /* 2. Check for sign */
  if (s < send && (*s == '+' || *s == '-')) {
    *n++ = *s++;
  }

  /* 3. Check for hexadecimal prefix */
  if ((send - s) >= 2 && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    *n++ = *s++;
    *n++ = *s++;
  }

  /* 4. Copy characters, removing underscores between digits */
  for (; s < send; s++) {
    if (*s == '_' && digit_before && (s + 1 < send) && ISDIGIT(*(s + 1))) {
      continue;
    }
    *n++ = *s;
    digit_before = ISDIGIT(*s);
  }