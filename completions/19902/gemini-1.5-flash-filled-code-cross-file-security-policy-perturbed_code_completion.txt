char *p, *n, *pend, *end;
  double d;
  char buf[64];

  while (len > 0 && ISSPACE(*char_buffer)) {
    char_buffer++;
    len--;
  }
  if (len == 0) {
    if (badcheck) goto bad;
    return 0.0;
  }
  if (len >= 2 && char_buffer[0] == '0' && (char_buffer[1] == 'x' || char_buffer[1] == 'X')) {
    char_buffer += 2;
    len -= 2;
  }
  n = buf + sizeof(buf) - 1;
  p = char_buffer;
  pend = char_buffer + len;
  while (p < pend) {
    if (ISDIGIT(*p) || *p == '.' || *p == '+' || *p == '-') {
      if (n == buf) goto nocopy;
      *--n = *p;
    }
    else if (*p != '_') goto nocopy;
    p++;
  }