{
  const char *s = char_buffer, *endp = char_buffer + len;
  char *n = buf;

  /* 1. Trim leading whitespace. */
  while (s < endp && ISSPACE(*s)) {
    s++;
  }

  /* 2. Check for sign. */
  if (s < endp && (*s == '+' || *s == '-')) {
    *n++ = *s++;
  }

  /* 3. Check for and handle hexadecimal prefix "0x" or "0X". */
  if ((endp - s) >= 2 && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    *n++ = *s++;
    *n++ = *s++;
  }

  /* 4. Copy valid characters, removing underscores between digits. */
  while (s < endp && !ISSPACE(*s)) {
    if (*s == '_') {
      s++;
      continue;
    }
    *n++ = *s++;
  }

  /* 5. Null-terminate the cleaned buffer. */
  *n = '\0';

  /* Prepare pointers for conversion. */
  p = buf;
  pend = n;
}