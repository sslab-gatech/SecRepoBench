const char *s = char_buffer;
  const char *send = s + len;
  char *n = buf;

  /* 1. Trim leading whitespace */
  while (s < send && ISSPACE(*s)) s++;
  if (s == send) {
    /* only whitespace */
    if (badcheck) goto bad;
    goto nocopy;
  }

  /* 2. Copy sign if present */
  if (*s == '+' || *s == '-') {
    *n++ = *s++;
  }

  /* 3. Check for hex prefix "0x" or "0X" */
  if ((send - s) >= 2 && s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    *n++ = *s++;
    *n++ = *s++;
  }

  /* 4. Copy valid characters, removing underscores */
  for (; s < send; s++) {
    if (*s == '_') {
      /* skip underscores */
      if (badcheck && (s + 1 < send) && (s[1] == '_')) goto bad;
      continue;
    }
    if (badcheck && *s == '\0') {
      goto nullbyte;
    }
    *n++ = *s;
  }