double
mrb_str_len_to_dbl(mrb_state *mrb, const char *char_buffer, size_t len, mrb_bool badcheck)
{
  char *buf, *p, *n, *end;
  double d;
  const char *s = char_buffer;

  if (len == 0) return 0.0;

  /* Allocate a buffer for the copy */
  buf = (char*)mrb_malloc(mrb, len + 1);
  p = buf;
  n = p;

  /* Copy the string, skipping underscores */
  for (size_t i = 0; i < len; i++) {
    if (s[i] == '_') continue;

    if (s[i] == '\0' && badcheck) {
      mrb_free(mrb, buf);
      mrb_raise(mrb, E_ARGUMENT_ERROR, "string contains null byte");
    }

    *n++ = s[i];
  }