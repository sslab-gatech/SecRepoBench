const char *p = char_buffer;
const char *pend = char_buffer + len;
const char *n;
char *buf = alloca(len + 1);
char *end = buf + len;
char *q = buf;

// Trim leading whitespace from the input string.
while (p < pend && ISSPACE(*p)) p++;

// Check for and handle hexadecimal prefixes "0x" or "0X".
if (p + 2 <= pend && (memcmp(p, "0x", 2) == 0 || memcmp(p, "0X", 2) == 0)) {
  p += 2;
}

// Prepare a buffer to store cleaned input by removing underscores between digits.
while (p < pend) {
  if (*p == '_') {
    p++;
  } else {
    *q++ = *p++;
  }
}

// Handle null byte termination.
*q = '\0';

// Check for formatting errors when 'badcheck' is true.
if (badcheck && q > buf && *(q - 1) == '_') {
  goto bad;
}