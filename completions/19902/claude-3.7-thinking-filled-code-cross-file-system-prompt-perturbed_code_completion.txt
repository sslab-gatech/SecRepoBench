const char *p = char_buffer;
  const char *pend = p + len;
  char *buf, *n;
  double d;
  const char *end;

  while (p<pend && ISSPACE(*p)) p++;
  if (p == pend) {
    if (badcheck) goto bad;
    return 0.0;
  }

  if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    mrb_int v = 0;
    p += 2;
    if (p >= pend) {
      if (badcheck) goto bad;
      return 0.0;
    }
    while (p < pend) {
      int c = *p;
      int n;

      if (c >= '0' && c <= '9') {
        n = c - '0';
      }
      else if (c >= 'a' && c <= 'f') {
        n = c - 'a' + 10;
      }
      else if (c >= 'A' && c <= 'F') {
        n = c - 'A' + 10;
      }
      else {
        break;
      }
      v = v * 16 + n;
      p++;
    }
    if (p == char_buffer + 2) {
      if (badcheck) goto bad;
      return 0.0;
    }
    if (badcheck && p < pend) goto bad;
    return (double)v;
  }

  buf = (char*)mrb_malloc(mrb, len+1);
  n = buf;
  while (p < pend) {
    if (*p == '_') {
      p++;
      continue;
    }
    if (n == buf && (*p == '+' || *p == '-')) {
      *n++ = *p++;
      continue;
    }
    if (ISDIGIT(*p) || *p == '.' || *p == 'e' || *p == 'E' || *p == '+' || *p == '-') {
      *n++ = *p++;
      continue;
    }
    break;
  }
  if (n == buf) {
    mrb_free(mrb, buf);
    if (badcheck) goto bad;
    return 0.0;
  }