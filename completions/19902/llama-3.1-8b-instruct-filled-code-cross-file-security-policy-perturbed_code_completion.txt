// <MASK>
if (badcheck) {
  if (p == end) goto bad;
  while (end < pend && ISSPACE(*end)) end++;
  if (end < pend) goto bad;
}
if (p == end) {
  *n = '\0';
  return d;
}
while (p < end) {
  if (ISSPACE(*p)) {
    p = char_backtrack(p, end);
    if (p == end) break;
    *n++ = *p++;
  } else if (*p == '_') {
    p++;
  } else {
    *n++ = *p++;
  }
}
*pend = '\0';
if (badcheck) {
  if (n == buf) goto bad;
  if (n > pend) goto bad;
}
d = mrb_float_read(buf, &end);
if (p!= end) goto bad;
return d;