char *n, *p, *pend;
  char buf[256];
  double d;
  char *end;

  while (ISSPACE(*s)) {
    s++;
    len--;
  }
  if (len == 0) {
    if (badcheck) goto bad;
    return 0.0;
  }
  if (s[0] == '0') {
    if (s[1] == 'x' || s[1] == 'X') {
      if (len < 3) {
        if (badcheck) goto bad;
        return 0.0;
      }
      s += 2;
      len -= 2;
    }
  }
  n = buf;
  pend = s + len;
  for (p = s; p < pend; p++) {
    if (*p == '_') {
      if (p + 1 < pend && p[1] == '_') {
        if (badcheck) goto bad;
        break;
      }
      continue;
    }
    *n++ = *p;
  }