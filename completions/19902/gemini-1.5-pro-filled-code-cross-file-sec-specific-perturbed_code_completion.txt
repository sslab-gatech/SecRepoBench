const char *p = s;
  const char *pend = s + len;
  char *n;
  char *end;
  double d;
  char buf[MRB_DOUBLE_SPRINTF_LEN];

  /* skip leading spaces */
  while (p < pend && ISSPACE(*p)) {
    p++;
  }
  if (p >= pend) {
    if (badcheck) goto bad;
    return 0.0;
  }

  n = buf;
  if (*p == '0') {
    if ((p + 1 < pend) && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      while (p < pend && ISXDIGIT(*p)) {
        *n++ = *p++;
      }
    }
    else {
      while (p < pend && ISOCTDIGIT(*p)) {
        *n++ = *p++;
      }
    }
  }
  else {
    while (p < pend && ISDIGIT(*p)) {
      *n++ = *p++;
    }
  }
  if (p < pend && *p == '.') {
    *n++ = '.';
    p++;
    while (p < pend && ISDIGIT(*p)) {
      *n++ = *p++;
    }
  }
  if (p < pend && (*p == 'e' || *p == 'E')) {
    *n++ = *p++;
    if (p < pend && (*p == '+' || *p == '-')) {
      *n++ = *p++;
    }
    while (p < pend && ISDIGIT(*p)) {
      *n++ = *p++;
    }
  }
  while (p < pend && *p == '_') {
    p++;
    while (p < pend && ISDIGIT(*p)) {
      *n++ = *p++;
    }
  }
  if (n > buf + sizeof(buf) - 1) {
    goto bad;
  }