double d;
  const char *p, *pend;
  char *buf, *n;
  size_t len_trimmed;

  /* extract double from string */
  p = char_buffer;
  pend = p + len;
  while (p < pend && ISSPACE(*p)) p++;

  len_trimmed = 0;
  if (p < pend) {
    if (p[0] == '0' && (p + 1 < pend) && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      while (p < pend && ISXDIGIT(*p)) { p++; len_trimmed++;}
    }
  }
  if (len_trimmed == 0) {
    while (p < pend && ISDIGIT(*p)) { p++; len_trimmed++;}
  }
  if (len_trimmed == 0) {
    if (badcheck) goto bad;
    return 0.0;
  }

  buf = (char *)mrb_malloc(mrb, len_trimmed + 1);
  n = buf;
  p = char_buffer;
  pend = p + len;
  while (p < pend && ISSPACE(*p)) p++;
  if (p < pend) {
    if (p[0] == '0' && (p + 1 < pend) && (p[1] == 'x' || p[1] == 'X')) {
      p += 2;
      while (p < pend && ISXDIGIT(*p)) *n++ = *p++;
    }
  }
  if (n == buf) {
    while (p < pend && ISDIGIT(*p)) {
      *n++ = *p++;
    }
  }
  if (p < pend && *p == '.') {
    *n++ = '.';
    p++;
    while (p < pend && ISDIGIT(*p)) *n++ = *p++;
  }
  if (p < pend && (*p == 'e' || *p == 'E')) {
    *n++ = 'e';
    p++;
    if (p < pend && (*p == '+' || *p == '-')) *n++ = *p++;
    while (p < pend && ISDIGIT(*p)) *n++ = *p++;
  }