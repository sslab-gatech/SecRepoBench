#include <stdint.h>

struct ndpi_flow_info {
  // ... other fields
  u_int32_t flow_id;
  u_int32_t hashval;
  u_int16_t vlan_id;
  u_int8_t protocol;
  u_int8_t src_ip[4];
  u_int8_t dst_ip[4];
  u_int16_t src_port;
  u_int16_t dst_port;
  // ... other fields
};

struct ndpi_workflow {
  // ... other fields
  struct ndpi_flow_info *ndpi_flows_root[1];
  // ... other fields
};

struct ndpi_flow_info *ndpi_tsearch(struct ndpi_flow_info *flow, void **root, int (*cmp)(const void *, const void *)) {
  struct ndpi_flow_info **p, *q;
  int i, cmp_result;

  if(!root || !flow || !cmp)
    return NULL;

  for(i = 0; i < 1; i++) {
    p = (struct ndpi_flow_info **)root[i];
    q = p ? *p : NULL;

    while(q) {
      cmp_result = cmp(flow, q);
      if(cmp_result < 0) {
        p = &q->left;
      } else if(cmp_result > 0) {
        p = &q->right;
      } else {
        return q;
      }
      q = *p;
    }

    *p = flow;
    flow->left = flow->right = NULL;
    return flow;
  }

  return NULL;
}