4_header_len,
						 struct ndpi_tcphdr **tcph,
						 struct ndpi_udphdr **udph,
						 u_int16_t *sport,
						 u_int16_t *dport,
						 u_int8_t *proto,
						 u_int8_t **payload,
						 u_int16_t *payload_len,
						 u_int8_t *src_to_dst_direction,
						 pkt_timeval when) {
  struct ndpi_flow_info *flow = NULL;
  u_int32_t hash = 0;
  u_int16_t sport_local, dport_local;
  u_int8_t proto_local;
  u_int8_t *payload_local;
  u_int16_t payload_len_local;
  u_int8_t src_to_dst_direction_local;

  if(version == IPVERSION) {
    if(iph == NULL)
      return(NULL);

    sport_local = iph->source, dport_local = iph->dest;
    proto_local = iph->protocol;
    payload_local = (u_int8_t *)iph + ip_offset;
    payload_len_local = ipsize;
    src_to_dst_direction_local = 1;
  } else {
    if(iph6 == NULL)
      return(NULL);

    sport_local = iph6->ip6_src.s6_addr32[3], dport_local = iph6->ip6_dst.s6_addr32[3];
    proto_local = iph6->ip6_hdr.ip6_un1_nxt;
    payload_local = (u_int8_t *)iph6 + ip_offset;
    payload_len_local = ipsize;
    src_to_dst_direction_local = 1;
  }

  hash = ndpi_flow_hash(workflow, version, vlan_id, tunnel_type,
			sport_local, dport_local, proto_local);

  flow = ndpi_flow_info_lookup(workflow->ndpi_flows_root[hash % workflow->prefs.num_roots], hash);

  if(flow == NULL) {
    flow = ndpi_flow_info_new(workflow->ndpi_flows_root[hash % workflow->prefs.num_roots], hash);

    if(flow == NULL)
      return(NULL);

    flow->hash = hash;
    flow->version = version;
    flow->vlan_id = vlan_id;
    flow->tunnel_type = tunnel_type;
    flow->sport = sport_local;
    flow->dport = dport_local;
    flow->proto = proto_local;
    flow->ndpi_flow = ndpi_flow_struct_new(workflow->ndpi_struct, version, vlan_id,
					    tunnel_type, sport_local, dport_local, proto_local);

    if(flow->ndpi_flow == NULL) {
      ndpi_flow_info_free(flow);
      return(NULL);
    }

    flow->ndpi_flow->flow_id = hash;
    flow->ndpi_flow->flow_last_pkt_time = when;
    flow->ndpi_flow->flow_first_pkt_time = when;
    flow->ndpi_flow->flow_last_pkt_time_ms = ((uint64_t)when.tv_sec) * TICK_RESOLUTION + when.tv_usec / (1000000 / TICK_RESOLUTION);
    flow->ndpi_flow->flow_first_pkt_time_ms = flow->ndpi_flow->flow_last_pkt_time_ms;

    flow->ndpi_flow->src_port = sport_local;
    flow->ndpi_flow->dst_port = dport_local;
    flow->ndpi_flow->l4_proto = proto_local;
    flow->ndpi_flow->src_to_dst_direction = src_to_dst_direction_local;

    flow->ndpi_flow->src_to_dst_packets = 0;
    flow->ndpi_flow->src_to_dst_bytes = 0;
    flow->ndpi_flow->src_to_dst_goodput_bytes = 0;
    flow->ndpi_flow->dst_to_src_packets = 0;
    flow->ndpi_flow->dst_to_src_bytes = 0;
    flow->ndpi_flow->dst_to_src_goodput_bytes = 0;

    flow->ndpi_flow->src2dst_last_pkt_time = when;
    flow->ndpi_flow->dst2src_last_pkt_time = when;

    flow->ndpi_flow->iat_c_to_s = ndpi_data_new();
    flow->ndpi_flow->iat_s_to_c = ndpi_data_new();
    flow->ndpi_flow->pktlen_c_to_s = ndpi_data_new();
    flow->ndpi_flow->pktlen_s_to_c = ndpi_data_new();

    if((flow->ndpi_flow->iat_c_to_s == NULL) || (flow->ndpi_flow->iat_s_to_c == NULL) ||
       (flow->ndpi_flow->pktlen_c_to_s == NULL) || (flow->ndpi_flow->pktlen_s_to_c == NULL)) {
      ndpi_flow_info_free(flow);
      return(NULL);
    }

    flow->ndpi_flow->entropy = ndpi_entropy_new();

    if(flow->ndpi_flow->entropy == NULL) {
      ndpi_flow_info_free(flow);
      return(NULL);
    }

    flow->ndpi_flow->first_seen_ms = 0;
    flow->ndpi_flow->last_seen_ms = 0;
    flow->ndpi_flow->flow_last_pkt_time = when;
    flow->ndpi_flow->flow_first_pkt_time = when;
    flow->ndpi_flow->flow_last_pkt_time_ms = ((uint64_t)when.tv_sec) * TICK_RESOLUTION + when.tv_usec / (1000000 / TICK_RESOLUTION);
    flow->ndpi_flow->flow_first_pkt_time_ms = flow->ndpi_flow->flow_last_pkt_time_ms;

    flow->ndpi_flow->src2dst_last_pkt_time_ms = flow->ndpi_flow->flow_last_pkt_time_ms;
    flow->ndpi_flow->dst2src_last_pkt_time_ms = flow->ndpi_flow->flow_last_pkt_time_ms;

    flow->ndpi_flow->src2dst_packets = 0;
    flow->ndpi_flow->src2dst_bytes = 0;
    flow->ndpi_flow->src2dst_goodput_bytes = 0;
    flow->ndpi_flow->dst2src_packets = 0;
    flow->ndpi_flow->dst2src_bytes = 0;
    flow->ndpi_flow->dst2src_goodput_bytes = 0;

    flow->ndpi_flow->iat_flow = ndpi_data_new();

    if(flow->ndpi_flow->iat_flow == NULL) {
      ndpi_flow_info_free(flow);
      return(NULL);
    }

    flow->ndpi_flow->packet_counter = 0;
    flow->ndpi_flow->packet_direction_counter[0] = 0;
    flow->ndpi_flow->packet_direction_counter[1] = 0;
    flow->ndpi_flow->byte_counter[0] = 0;
    flow->ndpi_flow->byte_counter[1] = 0;

    flow->ndpi_flow->payload_len_bin = ndpi_bin_new(MAX_NUM_BIN_PKTS, 0, 0);
    flow->ndpi_flow->payload_len_bin_src2dst = ndpi_bin_new(MAX_NUM_BIN_PKTS, 0, 0);
    flow->ndpi_flow->payload_len_bin_dst2src = ndpi_bin_new(MAX_NUM_BIN_PKTS, 0, 0);

    if((flow->ndpi_flow->payload_len_bin == NULL) || (flow->ndpi_flow->payload_len_bin_src2dst == NULL) ||
       (flow->ndpi_flow->payload_len_bin_dst2src == NULL)) {
      ndpi_flow_info_free(flow);
      return(NULL);
    }

    flow->ndpi_flow->has_human_readeable_strings = 0;
    flow->ndpi_flow->human_readeable_string_buffer[0] = '\0';

    flow->ndpi_flow->detected_protocol.app_protocol = NDPI_PROTOCOL_UNKNOWN;
    flow->ndpi_flow->detected_protocol.master_protocol = NDPI_PROTOCOL_UNKNOWN;
    flow->ndpi_flow->detected_protocol.category = NDPI_PROTOCOL_CATEGORY_UNSPECIFIED;

    flow->ndpi_flow->check_extra_packets = 0;
    flow->ndpi_flow->protocol_id_already_guessed = 0;
    flow->ndpi_flow->guessed_protocol_id = 0;
    flow->ndpi_flow->guessed_host_protocol_id = NDPI_PROTOCOL_UNKNOWN;
    flow->ndpi_flow->detection_completed = 0;
    flow->ndpi_flow->risk_checked = 0;
    flow->ndpi_flow->tree_risk_checked = 0;
    flow->ndpi_flow->risk = 0;
    flow->ndpi_flow->category = NDPI_PROTOCOL_CATEGORY_UNSPECIFIED;

    flow->ndpi_flow->setup_packet_direction = 0;
    flow->ndpi_flow->init_finished = 0;

    flow->ndpi_flow->c_to_s_init_win = 0;
    flow->ndpi_flow->s_to_c_init_win = 0;

    flow->ndpi_flow->iat_c_to_s->mean = 0;
    flow->ndpi_flow->iat_c_to_s->var = 0;
    flow->ndpi_flow->iat_s_to_c->mean = 0;
    flow->ndpi_flow->iat_s_to_c->var = 0;

    flow->ndpi_flow->entropy->src2dst_pkt_count = 0;
    flow->ndpi_flow->entropy->dst2src_pkt_count = 0;
    flow->ndpi_flow->entropy->src2dst_opackets = 0;
    flow->ndpi_flow->entropy->dst2src_opackets = 0;
    flow->ndpi_flow->entropy->src2dst_l4_bytes = 0;
    flow->ndpi_flow->entropy->dst2src_l4_bytes = 0;
    flow->ndpi_flow->entropy->src2dst_byte_count = 0;
    flow->ndpi_flow->entropy->dst2src_byte_count = 0;
    flow->ndpi_flow->entropy->score = 0;

    flow->ndpi_flow->src2dst_start = when;
    flow->ndpi_flow->dst2src_start = when;

    flow->ndpi_flow->bidirectional = 0;

    flow->ndpi_flow->next_tcp_seq_nr[0] = 0;
    flow->ndpi_flow->next_tcp_seq_nr[1] = 0;

    flow->ndpi_flow->l4.tcp.seen_syn = 0;
    flow->ndpi_flow->l4.tcp.seen_syn_ack = 0;
    flow->ndpi_flow->l4.tcp.seen_ack = 0;

    flow->ndpi_flow->l4.udp.seen_udp = 0;

    flow->ndpi_flow->num_processed_pkts = 0;
  }

  if(tcph != NULL)