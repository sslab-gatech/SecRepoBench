memset(dNSName, 0, sizeof(dNSName));

if (general_name_type == 0x87) { /* ipAddress */
  /* Convert binary IP to string */
  if (len == 4) {
    /* IPv4 */
    snprintf(dNSName, sizeof(dNSName), "%u.%u.%u.%u",
             packet->payload[i + 2], packet->payload[i + 3],
             packet->payload[i + 4], packet->payload[i + 5]);
  } else if (len == 16) {
    /* IPv6 */
    snprintf(dNSName, sizeof(dNSName),
             "%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x:"
             "%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x",
             packet->payload[i + 2],  packet->payload[i + 3],
             packet->payload[i + 4],  packet->payload[i + 5],
             packet->payload[i + 6],  packet->payload[i + 7],
             packet->payload[i + 8],  packet->payload[i + 9],
             packet->payload[i + 10], packet->payload[i + 11],
             packet->payload[i + 12], packet->payload[i + 13],
             packet->payload[i + 14], packet->payload[i + 15],
             packet->payload[i + 16], packet->payload[i + 17]);
  } else {
    /* Invalid length for ipAddress */
    break;
  }
} else {
  /* rfc822Name (0x81) or dNSName (0x82) */
  if (len >= sizeof(dNSName)) {
    /* Prevent overflow */
    break;
  }
  memcpy(dNSName, &packet->payload[i + 2], len);
  dNSName[len] = '\0';
  cleanupServerName(dNSName, len);
}

#ifdef DEBUG_TLS
printf("[TLS subjectAltName] type=0x%02X name=%s\n", general_name_type, dNSName);
#endif

/* Check match against SNI if needed */
if (!matched_name && flow->host_server_name[0] != '\0') {
  if (!strncasecmp(flow->host_server_name, dNSName, strlen(dNSName))
      && (strlen(flow->host_server_name) == strlen(dNSName))) {
    matched_name = 1;
  }
}

/* Store the extracted name in server_names list */
if (flow->protos.tls_quic.server_names == NULL) {
  flow->protos.tls_quic.server_names = ndpi_strdup(dNSName);
} else {
  char *old_names = flow->protos.tls_quic.server_names;
  u_int new_len = strlen(old_names) + strlen(dNSName) + 2;
  flow->protos.tls_quic.server_names = ndpi_malloc(new_len);
  if (flow->protos.tls_quic.server_names) {
    snprintf(flow->protos.tls_quic.server_names, new_len, "%s,%s", old_names, dNSName);
    ndpi_free(old_names);
  } else {
    flow->protos.tls_quic.server_names = old_names; /* rollback on alloc failure */
  }
}

/* Move forward */
i += len;