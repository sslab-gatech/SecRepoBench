// Parse the payload to extract the DNS name or IP address from the subjectAltName extension.
char dNSName[256];
int dNSNameLen = 0;
if (general_name_type == 0x82) { // dNSName
  dNSNameLen = packet->payload[i + 1];
  if (dNSNameLen < sizeof(dNSName)) {
    memcpy(dNSName, &packet->payload[i + 2], dNSNameLen);
    dNSName[dNSNameLen] = '\0';
    if (ndpi_is_printable_string(dNSName, dNSNameLen)) {
      if (strcmp(connection->host_server_name, dNSName) == 0) {
        matched_name = 1;
      } else if (connection->server_names == NULL) {
        connection->server_names = ndpi_strdup(dNSName);
      } else {
        char* new_server_names = ndpi_malloc(strlen(connection->server_names) + dNSNameLen + 2);
        sprintf(new_server_names, "%s,%s", connection->server_names, dNSName);
        ndpi_free(connection->server_names);
        connection->server_names = new_server_names;
      }
      ndpi_match_host_subprotocol(ndpi_struct, connection, dNSName, dNSNameLen);
    } else {
      ndpi_set_risk(ndpi_struct, connection, NDPI_INVALID_CHARACTERS);
    }
  } else {
    ndpi_set_risk(ndpi_struct, connection, NDPI_TLS_SUSPICIOUS_EXTENSION);
  }
} else if (general_name_type == 0x87) { // ipAddress
  char ipAddress[46];
  dNSNameLen = packet->payload[i + 1];
  if (dNSNameLen <= 16) { // IPv4
    sprintf(ipAddress, "%u.%u.%u.%u", packet->payload[i + 2], packet->payload[i + 3], packet->payload[i + 4], packet->payload[i + 5]);
  } else { // IPv6
    sprintf(ipAddress, "%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x",
      packet->payload[i + 2], packet->payload[i + 3], packet->payload[i + 4], packet->payload[i + 5],
      packet->payload[i + 6], packet->payload[i + 7], packet->payload[i + 8], packet->payload[i + 9],
      packet->payload[i + 10], packet->payload[i + 11], packet->payload[i + 12], packet->payload[i + 13],
      packet->payload[i + 14], packet->payload[i + 15], packet->payload[i + 16], packet->payload[i + 17]);
  }
  if (strcmp(connection->host_server_name, ipAddress) == 0) {
    matched_name = 1;
  } else if (connection->server_names == NULL) {
    connection->server_names = ndpi_strdup(ipAddress);
  } else {
    char* new_server_names = ndpi_malloc(strlen(connection->server_names) + strlen(ipAddress) + 2);
    sprintf(new_server_names, "%s,%s", connection->server_names, ipAddress);
    ndpi_free(connection->server_names);
    connection->server_names = new_server_names;
  }
  ndpi_match_host_subprotocol(ndpi_struct, connection, ipAddress, strlen(ipAddress));
}