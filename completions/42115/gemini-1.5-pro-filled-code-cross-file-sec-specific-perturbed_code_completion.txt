if(len < sizeof(dNSName)) {
		    int j = 0, is_ipv6 = 0, is_ipv4 = 0;
		    char ip_address[INET6_ADDRSTRLEN];

		    memset(ip_address, 0, sizeof(ip_address));
		    memset(dNSName, 0, sizeof(dNSName));

		    if(general_name_type == 0x87) {
		      /* It's an IP address */
		      if(len == 4) is_ipv4 = 1; else if(len == 16) is_ipv6 = 1;
		    }

		    for(j=0; j<len; j++) {
		      if(general_name_type != 0x87) {
			dNSName[j] = packet->payload[i+2+j];
		      } else {
			/* Convert the address to string format */
			snprintf(&ip_address[strlen(ip_address)],
				 sizeof(ip_address) - strlen(ip_address),
				 is_ipv4 ? "%u." : "%02x:", packet->payload[i+2+j]);
		      }
		    }

		    if(general_name_type != 0x87) {
		      ndpi_sanitize_string(dNSName, len);
		    } else {
		      if(is_ipv4) {
			ip_address[strlen(ip_address)-1] = '\0'; /* remove trailing dot */
			len = strlen(ip_address);
			if(len < sizeof(dNSName)) {
			  strncpy(dNSName, ip_address, len);
			}
		      } else if(is_ipv6) {
			ip_address[strlen(ip_address)-1] = '\0'; /* remove trailing colon */
			len = strlen(ip_address);
			if(len < sizeof(dNSName)) {
			  strncpy(dNSName, ip_address, len);
			}
		      }
		    }

		    if(len) {
		      if(ndpi_is_printable_string(dNSName, len) != 0) {
			ndpi_set_risk(ndpi_struct, connection, NDPI_INVALID_CHARACTERS);
		      }

		      if(connection->host_server_name[0] != '\0') {
			if(!strcmp(dNSName, connection->host_server_name)) {
			  matched_name = 1;
			}
		      }

		      if(flow->server_names == NULL) {
			flow->server_names = ndpi_strdup(dNSName);
		      } else {
			char *new_server_names = NULL;
			int new_len = strlen(flow->server_names) + strlen(dNSName) + 1 /* , */ + 1 /* \0 */;

			new_server_names = malloc(new_len);
			if(new_server_names) {
			  snprintf(new_server_names, new_len, "%s,%s", flow->server_names, dNSName);
			  free(flow->server_names);
			  flow->server_names = new_server_names;
			}
		      }

		      ndpi_detect_subprotocol_by_hostname(ndpi_struct, connection, dNSName, len);
		    }
		  }

		  i += 2; /* skip type and len */
		}