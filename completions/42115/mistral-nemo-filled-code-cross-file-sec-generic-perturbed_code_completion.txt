// Parse the payload to extract the DNS name or IP address from the subjectAltName extension.
u_int8_t len = packet->payload[i + 1];
char dNSName[256];
memcpy(dNSName, &packet->payload[i + 2], len);
dNSName[len] = '\0';

// Convert the extracted address to a string format for IPv4 and IPv6.
char *ip_str = ndpi_get_ip_str(packet, dNSName, len);

// Clean up the extracted DNS name and ensure it is printable.
ndpi_cleanup_string(dNSName, len);

// Check if the extracted DNS name matches the host server name.
if (strcmp(dNSName, connection->host_server_name) == 0) {
  matched_name = 1;
}

// If a match is found, set the matched_name flag and update the server names list in the flow structure.
if (matched_name) {
  if (connection->server_names == NULL) {
    connection->server_names = ndpi_strdup(dNSName);
  } else {
    char *tmp = connection->server_names;
    asprintf(&connection->server_names, "%s,%s", tmp, dNSName);
    free(tmp);
  }
}

// Attempt to detect a subprotocol based on the DNS name and update the flow structure accordingly.
ndpi_detect_subprotocol_by_dns_name(ndpi_struct, flow, dNSName);