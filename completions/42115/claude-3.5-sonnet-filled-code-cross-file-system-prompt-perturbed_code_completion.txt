if(len > sizeof(dNSName) - 1) len = sizeof(dNSName) - 1;
memcpy(dNSName, &packet->payload[i + 2], len);
dNSName[len] = '\0';

if(general_name_type == 0x87) {
  char ipStr[INET6_ADDRSTRLEN];
  if(len == 4) {
    inet_ntop(AF_INET, dNSName, ipStr, sizeof(ipStr));
  } else if(len == 16) {
    inet_ntop(AF_INET6, dNSName, ipStr, sizeof(ipStr));
  } else {
    ipStr[0] = '\0';
  }
  strncpy(dNSName, ipStr, sizeof(dNSName));
  dNSName[sizeof(dNSName) - 1] = '\0';
}

ndpi_hostname_sni_set(dNSName, len);

if(ndpi_is_printable_string((uint8_t *)dNSName, len) == 0) {
  ndpi_set_risk(ndpi_struct, connection, NDPI_INVALID_CHARACTERS);
}

if(strcmp(dNSName, connection->host_server_name) == 0) {
  matched_name = 1;
}

if(connection->protos.tls_quic.server_names == NULL) {
  connection->protos.tls_quic.server_names = ndpi_strdup(dNSName);
} else {
  u_int len = strlen(connection->protos.tls_quic.server_names);
  char *newstr = (char*)ndpi_realloc(connection->protos.tls_quic.server_names, len + strlen(dNSName) + 2);
  if(newstr) {
    connection->protos.tls_quic.server_names = newstr;
    snprintf(&newstr[len], strlen(dNSName) + 2, ",%s", dNSName);
  }
}

ndpi_check_dga_name(ndpi_struct, connection, dNSName, 1);

u_int16_t subproto;
if((subproto = ndpi_match_host_subprotocol(ndpi_struct, connection, dNSName, strlen(dNSName),
                                           NDPI_PROTOCOL_TLS, NDPI_PROTOCOL_UNKNOWN)) != NDPI_PROTOCOL_UNKNOWN) {
  ndpi_set_detected_protocol(ndpi_struct, connection, subproto, NDPI_PROTOCOL_TLS);
}