static const uint8_t rcon[14] = {
        0x01, 0x02, 0x04, 0x08,
        0x10, 0x20, 0x40, 0x80,
        0x1B, 0x36, 0x6C, 0xD8,
        0xAB, 0x4D
    };
    int j, col;

    /* Expand the key into round keys */
    for (i = 1; i <= rounds; i++) {
        /* Rotate and apply S-box + Rcon on the first word */
        t  = tk[KC - 1][0] ^ sbox[tk[0][1]] ^ rcon[rconpointer++];
        tk[0][0] ^= t;
        t  = tk[KC - 1][1] ^ sbox[tk[0][2]];
        tk[0][1] ^= t;
        t  = tk[KC - 1][2] ^ sbox[tk[0][3]];
        tk[0][2] ^= t;
        t  = tk[KC - 1][3] ^ sbox[tk[0][0]];
        tk[0][3] ^= t;

        /* XOR in the previous words */
        for (j = 1; j < KC; j++)
            for (col = 0; col < 4; col++)
                tk[j][col] ^= tk[j - 1][col];

        /* For 256-bit keys, do an extra subword step */
        if (KC == 8) {
            t = tk[4][0] ^ sbox[tk[3][1]];
            tk[4][0] ^= t;
            t = tk[4][1] ^ sbox[tk[3][2]];
            tk[4][1] ^= t;
            t = tk[4][2] ^ sbox[tk[3][3]];
            tk[4][2] ^= t;
            t = tk[4][3] ^ sbox[tk[3][0]];
            tk[4][3] ^= t;

            for (j = 5; j < 8; j++)
                for (col = 0; col < 4; col++)
                    tk[j][col] ^= tk[j - 1][col];
        }

        /* Store this round's key */
        memcpy(a->round_key[i].u8, tk, KC * 4);
    }

    /* For decryption, apply inverse MixColumns to round keys (except first and last)
       and reverse their order for easier use in decryption. */
    if (decrypt) {
        /* Inverse MixColumns on intermediate round keys */
        for (i = 1; i < rounds; i++)
            aes_shiftrows_inv_mixcolumns(a->round_key[i].u8, dec_multbl);

        /* Reverse all round keys except the first (0) and last (rounds) */
        for (i = 1; i <= rounds / 2; i++) {
            uint8_t tmp[16];
            memcpy(tmp, a->round_key[i].u8, 16);
            memcpy(a->round_key[i].u8, a->round_key[rounds - i].u8, 16);
            memcpy(a->round_key[rounds - i].u8, tmp, 16);
        }
    }