for (i = 0; i < rounds; i++) {
    uint8_t temp[4];
    if (i % KC == 0) {
        t = tk[0][3];
        tk[0][3] = tk[0][2];
        tk[0][2] = tk[0][1];
        tk[0][1] = tk[0][0];
        tk[0][0] = t;
        tk[0][0] = sbox[tk[0][0]] ^ rcon[rconpointer++];
        tk[0][1] = sbox[tk[0][1]];
        tk[0][2] = sbox[tk[0][2]];
        tk[0][3] = sbox[tk[0][3]];
    } else if (KC > 6 && i % KC == 4) {
        tk[0][0] = sbox[tk[0][0]];
        tk[0][1] = sbox[tk[0][1]];
        tk[0][2] = sbox[tk[0][2]];
        tk[0][3] = sbox[tk[0][3]];
    }

    for (t = 0; t < 4; t++)
        tk[0][t] ^= tk[KC - 1][t];
    memcpy(tk[1], tk[0], 4 * sizeof(uint8_t));

    for (t = 1; t < KC; t++)
        for (int j = 0; j < 4; j++)
            tk[t][j] ^= tk[t - 1][j];

    memcpy(a->round_key[i + 1].u8, tk[0], KC * 4);
}

if (decrypt) {
    for (i = 1; i < rounds; i++) {
        temp[0] = inv_sbox[a->round_key[i].u8[13]];
        temp[1] = inv_sbox[a->round_key[i].u8[14]];
        temp[2] = inv_sbox[a->round_key[i].u8[15]];
        temp[3] = inv_sbox[a->round_key[i].u8[12]];
        a->round_key[i].u8[12] = temp[0];
        a->round_key[i].u8[13] = temp[1];
        a->round_key[i].u8[14] = temp[2];
        a->round_key[i].u8[15] = temp[3];

        temp[0] = inv_sbox[a->round_key[i].u8[9]];
        temp[1] = inv_sbox[a->round_key[i].u8[10]];
        temp[2] = inv_sbox[a->round_key[i].u8[11]];
        temp[3] = inv_sbox[a->round_key[i].u8[8]];
        a->round_key[i].u8[8] = temp[0];
        a->round_key[i].u8[9] = temp[1];
        a->round_key[i].u8[10] = temp[2];
        a->round_key[i].u8[11] = temp[3];

        temp[0] = inv_sbox[a->round_key[i].u8[5]];
        temp[1] = inv_sbox[a->round_key[i].u8[6]];
        temp[2] = inv_sbox[a->round_key[i].u8[7]];
        temp[3] = inv_sbox[a->round_key[i].u8[4]];
        a->round_key[i].u8[4] = temp[0];
        a->round_key[i].u8[5] = temp[1];
        a->round_key[i].u8[6] = temp[2];
        a->round_key[i].u8[7] = temp[3];

        temp[0] = inv_sbox[a->round_key[i].u8[1]];
        temp[1] = inv_sbox[a->round_key[i].u8[2]];
        temp[2] = inv_sbox[a->round_key[i].u8[3]];
        temp[3] = inv_sbox[a->round_key[i].u8[0]];
        a->round_key[i].u8[0] = temp[0];
        a->round_key[i].u8[1] = temp[1];
        a->round_key[i].u8[2] = temp[2];
        a->round_key[i].u8[3] = temp[3];
    }
} else {
    for (i = 0; i <= rounds / 2; i++) {
        FFSWAP(uint32_t, a->round_key[i].u32[0], a->round_key[rounds - i].u32[0]);
        FFSWAP(uint32_t, a->round_key[i].u32[1], a->round_key[rounds - i].u32[1]);
        FFSWAP(uint32_t, a->round_key[i].u32[2], a->round_key[rounds - i].u32[2]);
        FFSWAP(uint32_t, a->round_key[i].u32[3], a->round_key[rounds - i].u32[3]);
    }
}