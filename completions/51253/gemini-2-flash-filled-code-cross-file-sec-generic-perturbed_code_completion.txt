for (i = KC; i <= rounds; i++) {
        t = tk[KC - 1][0];
        tk[i][0] = tk[i - KC][0] ^ sbox[tk[i - 1][1]] ^ rconpointer;
        tk[i][1] = tk[i - KC][1] ^ sbox[tk[i - 1][2]];
        tk[i][2] = tk[i - KC][2] ^ sbox[tk[i - 1][3]];
        tk[i][3] = tk[i - KC][3] ^ sbox[t];
        if (!((i + 1) % KC))
            rconpointer++;

        a->round_key[i].u8[0] = tk[i][0];
        a->round_key[i].u8[1] = tk[i][1];
        a->round_key[i].u8[2] = tk[i][2];
        a->round_key[i].u8[3] = tk[i][3];

        t = tk[KC - 1][1];
        tk[i][1] = tk[i - KC][1] ^ sbox[tk[i - 1][2]] ^ rconpointer;
        tk[i][2] = tk[i - KC][2] ^ sbox[tk[i - 1][3]];
        tk[i][3] = tk[i - KC][3] ^ sbox[t];
        tk[i][4] = tk[i - KC][4] ^ sbox[tk[i - 1][0]];
        if (!((i + 2) % KC))
            rconpointer++;

        a->round_key[i].u8[4] = tk[i][1];
        a->round_key[i].u8[5] = tk[i][2];
        a->round_key[i].u8[6] = tk[i][3];
        a->round_key[i].u8[7] = tk[i][4];

        t = tk[KC - 1][2];
        tk[i][2] = tk[i - KC][2] ^ sbox[tk[i - 1][3]] ^ rconpointer;
        tk[i][3] = tk[i - KC][3] ^ sbox[t];
        tk[i][4] = tk[i - KC][4] ^ sbox[tk[i - 1][0]];
        tk[i][5] = tk[i - KC][5] ^ sbox[tk[i - 1][1]];
        if (!((i + 3) % KC))
            rconpointer++;

        a->round_key[i].u8[8]  = tk[i][2];
        a->round_key[i].u8[9]  = tk[i][3];
        a->round_key[i].u8[10] = tk[i][4];
        a->round_key[i].u8[11] = tk[i][5];

        t = tk[KC - 1][3];
        tk[i][3] = tk[i - KC][3] ^ sbox[t] ^ rconpointer;
        tk[i][4] = tk[i - KC][4] ^ sbox[tk[i - 1][0]];
        tk[i][5] = tk[i - KC][5] ^ sbox[tk[i - 1][1]];
        tk[i][6] = tk[i - KC][6] ^ sbox[tk[i - 1][2]];
        if (!((i + 4) % KC))
            rconpointer++;

        a->round_key[i].u8[12] = tk[i][3];
        a->round_key[i].u8[13] = tk[i][4];
        a->round_key[i].u8[14] = tk[i][5];
        a->round_key[i].u8[15] = tk[i][6];

        if (key_bits > 128) {
            t = tk[KC - 1][4];
            tk[i][4] = tk[i - KC][4] ^ sbox[tk[i - 1][0]] ^ rconpointer;
            tk[i][5] = tk[i - KC][5] ^ sbox[tk[i - 1][1]];
            tk[i][6] = tk[i - KC][6] ^ sbox[tk[i - 1][2]];
            tk[i][7] = tk[i - KC][7] ^ sbox[tk[i - 1][3]];
            if (!((i + 5) % KC))
                rconpointer++;

            a->round_key[i].u8[16] = tk[i][4];
            a->round_key[i].u8[17] = tk[i][5];
            a->round_key[i].u8[18] = tk[i][6];
            a->round_key[i].u8[19] = tk[i][7];
        }
        if (key_bits > 192) {
            t = tk[KC - 1][5];
            tk[i][5] = tk[i - KC][5] ^ sbox[tk[i - 1][1]] ^ rconpointer;
            tk[i][6] = tk[i - KC][6] ^ sbox[tk[i - 1][2]];
            tk[i][7] = tk[i - KC][7] ^ sbox[tk[i - 1][3]];
            tk[i][0] = tk[i - KC][0] ^ sbox[t];
            if (!((i + 6) % KC))
                rconpointer++;

            a->round_key[i].u8[20] = tk[i][5];
            a->round_key[i].u8[21] = tk[i][6];
            a->round_key[i].u8[22] = tk[i][7];
            a->round_key[i].u8[23] = tk[i][0];

            t = tk[KC - 1][6];
            tk[i][6] = tk[i - KC][6] ^ sbox[tk[i - 1][2]] ^ rconpointer;
            tk[i][7] = tk[i - KC][7] ^ sbox[tk[i - 1][3]];
            tk[i][0] = tk[i - KC][0] ^ sbox[t];
            tk[i][1] = tk[i - KC][1] ^ sbox[tk[i - 1][0]];
            if (!((i + 7) % KC))
                rconpointer++;

            a->round_key[i].u8[24] = tk[i][6];
            a->round_key[i].u8[25] = tk[i][7];
            a->round_key[i].u8[26] = tk[i][0];
            a->round_key[i].u8[27] = tk[i][1];

            t = tk[KC - 1][7];
            tk[i][7] = tk[i - KC][7] ^ sbox[tk[i - 1][3]] ^ rconpointer;
            tk[i][0] = tk[i - KC][0] ^ sbox[t];
            tk[i][1] = tk[i - KC][1] ^ sbox[tk[i - 1][0]];
            tk[i][2] = tk[i - KC][2] ^ sbox[tk[i - 1][1]];
            if (!((i + 8) % KC))
                rconpointer++;

            a->round_key[i].u8[28] = tk[i][7];
            a->round_key[i].u8[29] = tk[i][0];
            a->round_key[i].u8[30] = tk[i][1];
            a->round_key[i].u8[31] = tk[i][2];
        }
    }

    if (decrypt) {
        for (i = 1; i < rounds; i++) {
            inv_mix_col(&a->round_key[i]);
        }

        for (i = 0; i < (rounds >> 1); i++) {
            AV_SWAP(uint32_t, a->round_key[i].u32[0], a->round_key[rounds - i].u32[0]);
            AV_SWAP(uint32_t, a->round_key[i].u32[1], a->round_key[rounds - i].u32[1]);
            AV_SWAP(uint32_t, a->round_key[i].u32[2], a->round_key[rounds - i].u32[2]);
            AV_SWAP(uint32_t, a->round_key[i].u32[3], a->round_key[rounds - i].u32[3]);
            if (key_bits > 128) {
                AV_SWAP(uint32_t, a->round_key[i].u32[4], a->round_key[rounds - i].u32[4]);
            }
            if (key_bits > 192) {
                AV_SWAP(uint32_t, a->round_key[i].u32[5], a->round_key[rounds - i].u32[5]);
                AV_SWAP(uint32_t, a->round_key[i].u32[6], a->round_key[rounds - i].u32[6]);
                AV_SWAP(uint32_t, a->round_key[i].u32[7], a->round_key[rounds - i].u32[7]);
            }
        }
    }