// Generate round keys for AES encryption or decryption.
// Iterates over the key schedule and computes each round key
// using the provided S-box and Rcon tables. The initial key is
// expanded into a series of round keys using an XOR-based process
// with a cyclic shift and substitution for the first word of each
// key. If decryption is requested, the round keys are modified
// using inverse subshift and mix transformations. Finally, if
// encryption is intended, the round keys are reversed for use
// in the forward order during encryption.
for (i = KC; i < rounds * 4; i++) {
    t = tk[i - 1][0];
    if (i % KC == 0) {
        t = sbox[t >> 16 & 255] ^ sbox[t >> 8 & 255] ^ sbox[t & 255] ^ sbox[t >> 24] ^ rcon[rconpointer++];
    } else if (KC > 6 && i % KC == 4) {
        t = sbox[t >> 24] ^ sbox[t >> 16 & 255] ^ sbox[t >> 8 & 255] ^ sbox[t & 255];
    }
    tk[i][0] = tk[i - KC][0] ^ t;
    tk[i][1] = tk[i - KC][1] ^ tk[i][0];
    tk[i][2] = tk[i - KC][2] ^ tk[i][1];
    tk[i][3] = tk[i - KC][3] ^ tk[i][2];
}

if (decrypt) {
    for (i = 0; i < rounds; i++) {
        for (sidx = 0; sidx < 4; sidx++) {
            t = a->round_key[i].u8[sidx * 4 + 0];
            a->round_key[i].u8[sidx * 4 + 0] = a->round_key[i].u8[sidx * 4 + 1];
            a->round_key[i].u8[sidx * 4 + 1] = a->round_key[i].u8[sidx * 4 + 2];
            a->round_key[i].u8[sidx * 4 + 2] = a->round_key[i].u8[sidx * 4 + 3];
            a->round_key[i].u8[sidx * 4 + 3] = t;
        }
        for (sidx = 0; sidx < 4; sidx++) {
            a->round_key[i].u32[sidx] = dec_multbl[0][sbox[a->round_key[i].u8[sidx * 4 + 0]]] ^
                                        dec_multbl[1][sbox[a->round_key[i].u8[sidx * 4 + 1]]] ^
                                        dec_multbl[2][sbox[a->round_key[i].u8[sidx * 4 + 2]]] ^
                                        dec_multbl[3][sbox[a->round_key[i].u8[sidx * 4 + 3]]];
        }
    }
} else {
    for (i = 0; i < (rounds + 1) / 2; i++) {
        FFSWAP(uint32_t, a->round_key[i], a->round_key[rounds - i]);
    }
}