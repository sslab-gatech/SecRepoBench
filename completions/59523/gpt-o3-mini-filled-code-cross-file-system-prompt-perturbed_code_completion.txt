if (is_utf8)
  {
    const char *src = *(const char **)value;
    /* Allocate wide string memory: f->size indicates the maximum number
       of wide characters (including the terminating null) */
    size_t num_chars = f->size;
    wchar_t *wstr = malloc(num_chars * sizeof(wchar_t));
    if (!wstr)
      return;
    /* Convert from UTF-8 to wide character string.
       Note: mbstowcs() conversion depends on the current locale;
       in production code, a robust conversion function might be needed. */
    mbstowcs(wstr, src, num_chars - 1);
    wstr[num_chars - 1] = L'\0';
    memcpy(old, &wstr, sizeof(wstr));
  }
else
  {
    const char *src = *(const char **)value;
    char *new_str = malloc(f->size);
    if (!new_str)
      return;
    strncpy(new_str, src, f->size - 1);
    new_str[f->size - 1] = '\0';
    memcpy(old, &new_str, sizeof(new_str));
  }