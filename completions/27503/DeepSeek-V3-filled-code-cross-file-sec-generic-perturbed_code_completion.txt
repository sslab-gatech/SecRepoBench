switch (tag)
{
    case ID_SCE:
    case ID_LFE:
        // mono channel
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        status = alac_decode_element(p, bits, sampleBuffer + channelIndex, numSamples, numChannels, &partialFrame);
        channelIndex++;
        break;

    case ID_CPE:
        // stereo channel pair
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        if (channelIndex + 1 >= numChannels)
        {
            status = kALAC_ParamError;
            goto Exit;
        }
        status = alac_decode_element(p, bits, sampleBuffer + channelIndex, numSamples, numChannels, &partialFrame);
        channelIndex += 2;
        break;

    case ID_CCE:
    case ID_DSE:
        // not implemented - skip the element
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        status = alac_decode_skip_element(bits);
        break;

    case ID_PCE:
        // not implemented - skip the element
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        status = alac_decode_skip_element(bits);
        break;

    case ID_FIL:
        // fill element - skip the element
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        status = alac_decode_skip_element(bits);
        break;

    case ID_END:
        // frame end
        goto NoMoreChannels;

    default:
        status = kALAC_ParamError;
        goto Exit;
}

if (status != ALAC_noErr)
    goto Exit;

// if we decoded a partial frame, bail immediately
if (partialFrame)
    break;

// byte-align the bitstream
BitBufferByteAlign(bits, false);