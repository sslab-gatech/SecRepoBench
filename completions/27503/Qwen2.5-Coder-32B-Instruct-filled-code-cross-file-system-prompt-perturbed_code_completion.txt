switch (tag)
{
    case ID_SCE:
        // mono
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        status = DecodeMono(p, bits, sampleBuffer + channelIndex, numSamples, &extraBits);
        channelIndex++;
        break;

    case ID_CPE:
        // stereo
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        if (channelIndex + 1 >= numChannels)
        {
            status = kALAC_ChannelLimitExceeded;
            break;
        }
        status = DecodeStereo(p, bits, sampleBuffer + channelIndex, sampleBuffer + channelIndex + 1, numSamples, &extraBits);
        channelIndex += 2;
        break;

    case ID_LFE:
        // LFE channel (subwoofer)
        elementInstanceTag = BitBufferReadSmall(bits, 4);
        status = DecodeMono(p, bits, sampleBuffer + channelIndex, numSamples, &extraBits);
        channelIndex++;
        break;

    case ID_END:
        goto NoMoreChannels;

    default:
        status = kALAC_UnsupportedOperation;
        break;
}

if (status != ALAC_noErr)
    break;

// Align the bitstream to byte boundaries
BitBufferByteAlign(bits, false);