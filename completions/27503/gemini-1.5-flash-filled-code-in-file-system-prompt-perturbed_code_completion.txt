switch (tag)
		{
			case kALAC_DataElement:
				status = alac_data_stream_element (bits) ;
				break ;

			case kALAC_FillElement:
				status = alac_fill_element (bits) ;
				break ;

			case kALAC_MonoAudioElement:
			case kALAC_LowFrequencyAudioElement:
				// read header
				headerByte = BitBufferReadSmall (bits, 8) ;
				partialFrame = (headerByte >> 7) & 0x01 ;
				escapeFlag = (headerByte >> 6) & 0x01 ;
				mixBits = (headerByte >> 4) & 0x03 ;
				numU = (headerByte >> 2) & 0x03 ;
				numV = headerByte & 0x03 ;
				modeU = numU ? (uint8_t) (BitBufferReadSmall (bits, 2) + 1) : 0 ;
				modeV = numV ? (uint8_t) (BitBufferReadSmall (bits, 2) + 1) : 0 ;
				denShiftU = numU ? BitBufferReadSmall (bits, 2) : 0 ;
				denShiftV = numV ? BitBufferReadSmall (bits, 2) : 0 ;
				pbFactorU = numU ? (uint16_t) (1 << denShiftU) : 0 ;
				pbFactorV = numV ? (uint16_t) (1 << denShiftV) : 0 ;
				unusedHeader = BitBufferReadSmall (bits, 16) ;

				// read coefs
				for (i = 0 ; i < numU ; i++)
					coefsU [i] = (int16_t) BitBufferReadSmall (bits, 16) ;
				for (i = 0 ; i < numV ; i++)
					coefsV [i] = (int16_t) BitBufferReadSmall (bits, 16) ;

				// read mix residuals
				mixResiduals = (int8_t) BitBufferReadSmall (bits, mixBits) ;

				// decode samples
				out32 = sampleBuffer + channelIndex ;
				for (i = 0 ; i < numSamples ; i++)
				{
					val = alac_decode_sample (p, bits, coefsU, coefsV, numU, numV, modeU, modeV, pbFactorU, pbFactorV, pb, mixResiduals) ;
					*out32 = val ;
					out32 += numChannels ;
				}

				// handle partial frames
				if (partialFrame)
				{
					extraBits = BitBufferReadSmall (bits, 8) ;
					BitBufferAdvance (bits, extraBits) ;
				}

				channelIndex++ ;
				break ;

			case kALAC_StereoAudioElement:
				// read header
				headerByte = BitBufferReadSmall (bits, 8) ;
				partialFrame = (headerByte >> 7) & 0x01 ;
				escapeFlag = (headerByte >> 6) & 0x01 ;
				mixBits = (headerByte >> 4) & 0x03 ;
				numU = (headerByte >> 2) & 0x03 ;
				numV = headerByte & 0x03 ;
				modeU = numU ? (uint8_t) (BitBufferReadSmall (bits, 2) + 1) : 0 ;
				modeV = numV ? (uint8_t) (BitBufferReadSmall (bits, 2) + 1) : 0 ;
				denShiftU = numU ? BitBufferReadSmall (bits, 2) : 0 ;
				denShiftV = numV ? BitBufferReadSmall (bits, 2) : 0 ;
				pbFactorU = numU ? (uint16_t) (1 << denShiftU) : 0 ;
				pbFactorV = numV ? (uint16_t) (1 << denShiftV) : 0 ;
				unusedHeader = BitBufferReadSmall (bits, 16) ;

				// read coefs
				for (i = 0 ; i < numU ; i++)
					coefsU [i] = (int16_t) BitBufferReadSmall (bits, 16) ;
				for (i = 0 ; i < numV ; i++)
					coefsV [i] = (int16_t) BitBufferReadSmall (bits, 16) ;

				// read mix residuals
				mixResiduals = (int8_t) BitBufferReadSmall (bits, mixBits) ;

				// decode samples
				out32 = sampleBuffer + channelIndex ;
				for (i = 0 ; i < numSamples ; i++)
				{
					val = alac_decode_sample (p, bits, coefsU, coefsV, numU, numV, modeU, modeV, pbFactorU, pbFactorV, pb, mixResiduals) ;
					*out32 = val ;
					out32 += numChannels ;
				}

				// handle partial frames
				if (partialFrame)
				{
					extraBits = BitBufferReadSmall (bits, 8) ;
					BitBufferAdvance (bits, extraBits) ;
				}

				channelIndex++ ;
				break ;

			default:
				status = kALAC_UnsupportedOperation ;
				break ;
		}

		// byte align the bitstream
		BitBufferByteAlign (bits, false) ;

		// check for end of frame
		if (channelIndex >= numChannels)
			goto NoMoreChannels ;