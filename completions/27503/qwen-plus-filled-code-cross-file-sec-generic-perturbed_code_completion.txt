switch (tag)
{
	case ID_SCE: // Single Channel Element (Mono)
		// Read mono channel parameters
		elementInstanceTag = BitBufferReadSmall (bits, 4) ;
		if (channelIndex >= numChannels)
		{
			status = kALAC_ParamError ;
			goto Exit ;
		}

		// Check for compressed or uncompressed frame
		headerByte = BitBufferReadSmall (bits, 12) ;
		if (headerByte & 0x1) // Frame not compressed
		{
			partialFrame = (headerByte >> 3) & 0x1 ;
			if (partialFrame)
				numSamples = BitBufferRead (bits, 32) ;

			switch (p->mBitDepth)
			{
				case 16:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 16) ;
					break ;
				case 20:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 20) << 12 ;
					break ;
				case 24:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 24) << 8 ;
					break ;
				case 32:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 32) ;
					break ;
			}
		}
		else // Compressed frame
		{
			partialFrame = (headerByte >> 3) & 0x1 ;
			if (partialFrame)
				numSamples = BitBufferRead (bits, 32) ;

			// Decode the compressed frame
			mixBits = BitBufferReadSmall (bits, 8) ;
			mixResiduals = BitBufferReadSmall (bits, 8) ;
			modeU = BitBufferReadSmall (bits, 4) ;
			denShiftU = BitBufferReadSmall (bits, 4) ;
			pbFactorU = BitBufferReadSmall (bits, 5) ;
			numU = BitBufferReadSmall (bits, 3) ;
			for (i = 0 ; i < numU ; i++)
				coefsU[i] = BitBufferReadSigned (bits, 16) ;

			out32 = sampleBuffer + channelIndex * numSamples ;
			set_ag_params (&agParams, p->mb, pbFactorU, p->kb, numSamples, numSamples, MAX_RUN_DEFAULT) ;
			status = dyn_decomp (&agParams, bits, out32, numSamples, p->mBitDepth, &extraBits) ;
			if (status != ALAC_noErr)
				goto Exit ;

			pc_block_inv (out32, coefsU, numU, denShiftU, numSamples) ;
		}

		channelIndex++ ;
		break ;

	case ID_CPE: // Channel Pair Element (Stereo)
		// Read stereo channel parameters
		elementInstanceTag = BitBufferReadSmall (bits, 4) ;
		if (channelIndex + 1 >= numChannels)
		{
			status = kALAC_ParamError ;
			goto Exit ;
		}

		// Check for compressed or uncompressed frame
		headerByte = BitBufferReadSmall (bits, 12) ;
		if (headerByte & 0x1) // Frame not compressed
		{
			partialFrame = (headerByte >> 3) & 0x1 ;
			if (partialFrame)
				numSamples = BitBufferRead (bits, 32) ;

			switch (p->mBitDepth)
			{
				case 16:
					for (i = 0 ; i < numSamples ; i++)
					{
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 16) ;
						sampleBuffer[(channelIndex + 1) * numSamples + i] = BitBufferReadSigned (bits, 16) ;
					}
					break ;
				case 20:
					for (i = 0 ; i < numSamples ; i++)
					{
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 20) << 12 ;
						sampleBuffer[(channelIndex + 1) * numSamples + i] = BitBufferReadSigned (bits, 20) << 12 ;
					}
					break ;
				case 24:
					for (i = 0 ; i < numSamples ; i++)
					{
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 24) << 8 ;
						sampleBuffer[(channelIndex + 1) * numSamples + i] = BitBufferReadSigned (bits, 24) << 8 ;
					}
					break ;
				case 32:
					for (i = 0 ; i < numSamples ; i++)
					{
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 32) ;
						sampleBuffer[(channelIndex + 1) * numSamples + i] = BitBufferReadSigned (bits, 32) ;
					}
					break ;
			}
		}
		else // Compressed frame
		{
			partialFrame = (headerByte >> 3) & 0x1 ;
			if (partialFrame)
				numSamples = BitBufferRead (bits, 32) ;

			// Decode left channel
			mixBits = BitBufferReadSmall (bits, 8) ;
			mixResiduals = BitBufferReadSmall (bits, 8) ;
			modeU = BitBufferReadSmall (bits, 4) ;
			denShiftU = BitBufferReadSmall (bits, 4) ;
			pbFactorU = BitBufferReadSmall (bits, 5) ;
			numU = BitBufferReadSmall (bits, 3) ;
			for (i = 0 ; i < numU ; i++)
				coefsU[i] = BitBufferReadSigned (bits, 16) ;

			out32 = sampleBuffer + channelIndex * numSamples ;
			set_ag_params (&agParams, p->mb, pbFactorU, p->kb, numSamples, numSamples, MAX_RUN_DEFAULT) ;
			status = dyn_decomp (&agParams, bits, out32, numSamples, p->mBitDepth, &extraBits) ;
			if (status != ALAC_noErr)
				goto Exit ;

			pc_block_inv (out32, coefsU, numU, denShiftU, numSamples) ;

			// Decode right channel
			modeV = BitBufferReadSmall (bits, 4) ;
			denShiftV = BitBufferReadSmall (bits, 4) ;
			pbFactorV = BitBufferReadSmall (bits, 5) ;
			numV = BitBufferReadSmall (bits, 3) ;
			for (i = 0 ; i < numV ; i++)
				coefsV[i] = BitBufferReadSigned (bits, 16) ;

			out32 = sampleBuffer + (channelIndex + 1) * numSamples ;
			set_ag_params (&agParams, p->mb, pbFactorV, p->kb, numSamples, numSamples, MAX_RUN_DEFAULT) ;
			status = dyn_decomp (&agParams, bits, out32, numSamples, p->mBitDepth, &extraBits) ;
			if (status != ALAC_noErr)
				goto Exit ;

			pc_block_inv (out32, coefsV, numV, denShiftV, numSamples) ;
		}

		channelIndex += 2 ;
		break ;

	case ID_LFE: // Low Frequency Effect (LFE) channel
		// Read LFE channel parameters
		elementInstanceTag = BitBufferReadSmall (bits, 4) ;
		if (channelIndex >= numChannels)
		{
			status = kALAC_ParamError ;
			goto Exit ;
		}

		// Check for compressed or uncompressed frame
		headerByte = BitBufferReadSmall (bits, 12) ;
		if (headerByte & 0x1) // Frame not compressed
		{
			partialFrame = (headerByte >> 3) & 0x1 ;
			if (partialFrame)
				numSamples = BitBufferRead (bits, 32) ;

			switch (p->mBitDepth)
			{
				case 16:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 16) ;
					break ;
				case 20:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 20) << 12 ;
					break ;
				case 24:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 24) << 8 ;
					break ;
				case 32:
					for (i = 0 ; i < numSamples ; i++)
						sampleBuffer[channelIndex * numSamples + i] = BitBufferReadSigned (bits, 32) ;
					break ;
			}
		}
		else // Compressed frame
		{
			partialFrame = (headerByte >> 3) & 0x1 ;
			if (partialFrame)
				numSamples = BitBufferRead (bits, 32) ;

			// Decode the compressed frame
			mixBits = BitBufferReadSmall (bits, 8) ;
			mixResiduals = BitBufferReadSmall (bits, 8) ;
			modeU = BitBufferReadSmall (bits, 4) ;
			denShiftU = BitBufferReadSmall (bits, 4) ;
			pbFactorU = BitBufferReadSmall (bits, 5) ;
			numU = BitBufferReadSmall (bits, 3) ;
			for (i = 0 ; i < numU ; i++)
				coefsU[i] = BitBufferReadSigned (bits, 16) ;

			out32 = sampleBuffer + channelIndex * numSamples ;
			set_ag_params (&agParams, p->mb, pbFactorU, p->kb, numSamples, numSamples, MAX_RUN_DEFAULT) ;
			status = dyn_decomp (&agParams, bits, out32, numSamples, p->mBitDepth, &extraBits) ;
			if (status != ALAC_noErr)
				goto Exit ;

			pc_block_inv (out32, coefsU, numU, denShiftU, numSamples) ;
		}

		channelIndex++ ;
		break ;

	default:
		// Unsupported element type
		status = kALAC_UnsupportedOperation ;
		goto Exit ;
}