if (bytecnt == 0 || bytecnt > nbytes - offset)
    bytecnt = nbytes - offset;
if (bytecnt > ms->regex_max)
    bytecnt = ms->regex_max;

buf = RCAST(const char *, source) + offset;
end = last = RCAST(const char *, source) + bytecnt + offset;
/* mget() guarantees buf <= last */
for (lines = linecnt, b = buf; lines && b < end &&
     ((b = CAST(const char *,
         memchr(c = b, '\n', CAST(size_t, (end - b)))))
     || (b = CAST(const char *,
         memchr(c, '\r', CAST(size_t, (end - c))))));
     lines--, b++) {
    last = b;
    if (b < end - 1 && b[0] == '\r' && b[1] == '\n')
        b++;
}
if (lines)
    last = RCAST(const char *, source) + bytecnt;

ms->search.s = buf;
ms->search.s_len = last - buf;
ms->search.offset = offset;
ms->search.rm_len = 0;