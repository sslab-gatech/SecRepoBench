const char *buf, *end, *last;
size_t bytecnt = 0, linecnt = 0;

if (m->str_flags & REGEX_LINE_COUNT) {
    linecnt = m->vallen;
    bytecnt = linecnt * 80; /* Assume 80 characters per line */
} else {
    bytecnt = m->vallen;
}

if (bytecnt == 0 || bytecnt > nbytes - offset)
    bytecnt = nbytes - offset;