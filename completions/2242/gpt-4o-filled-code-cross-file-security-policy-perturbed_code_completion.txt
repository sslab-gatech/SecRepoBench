const char *buf, *end, *last, *c;
size_t lines, bytecnt, linecnt;
int32_t regex_flags;

// Initialize bytecnt and linecnt based on the magic structure
bytecnt = m->vallen;
linecnt = 0;

// Check if the source is valid
if (source == NULL || offset >= nbytes) {
    ms->search.s = NULL;
    ms->search.s_len = 0;
    ms->search.offset = 0;
    return -1;
}

// Determine the byte count and line count for the search
if (m->str_flags & REGEX_LINE_COUNT) {
    linecnt = bytecnt;
    bytecnt = linecnt * 80; // Assume 80 characters per line
} else {
    bytecnt = m->vallen;
}

// Ensure bytecnt does not exceed the available bytes
if (bytecnt == 0 || bytecnt > nbytes - offset)
    bytecnt = nbytes - offset;
if (bytecnt > ms->regex_max)
    bytecnt = ms->regex_max;

// Set the buffer pointers
buf = RCAST(const char *, source) + offset;
end = last = RCAST(const char *, source) + bytecnt + offset;