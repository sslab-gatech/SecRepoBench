const char *buf, *end, *last;
size_t bytecnt, lines;
int b, c;

if (offset > nbytes)
    offset = CAST(uint32_t, nbytes);
ms->search.s = RCAST(const char *, source) + offset;
ms->search.s_len = nbytes - offset;
ms->search.offset = offset;

if (m->str_flags & REGEX_LINE_COUNT) {
    bytecnt = 0;
    for (lines = m->str_range; lines && b < end && ((b = CAST(const char *,
         memchr(c = b, '\n', CAST(size_t, (end - b)))))
         || (b = CAST(const char *, memchr(c, '\r', CAST(size_t, (end - c))))));
         lines--, b++) {
        last = b;
        if (b < end - 1 && b[0] == '\r' && b[1] == '\n')
            b++;
        bytecnt++;
    }
    if (lines)
        last = RCAST(const char *, source) + bytecnt;
} else {
    bytecnt = m->str_range;
    if (bytecnt == 0 || bytecnt > nbytes - offset)
        bytecnt = nbytes - offset;
    if (bytecnt > ms->regex_max)
        bytecnt = ms->regex_max;
    buf = RCAST(const char *, source) + offset;
    end = last = RCAST(const char *, source) + bytecnt + offset;
}

ms->search.s = buf;
ms->search.s_len = last - buf;
ms->search.offset = offset;
ms->search.rm_len = 0;