case FILE_REGEX: {
    // Declare pointers and size variables to define the search region in the data.
    const unsigned char *src = source + offset;
    const unsigned char *esrc = source + nbytes;
    char *buf = RCAST(char *, ms->search.s);
    char *ebuf = RCAST(char *, ms->search.s) + ms->search.s_len;
    size_t bytecnt = 0;
    size_t linecnt = 0;
    const unsigned char *c = NULL;
    const unsigned char *last = NULL;
    const unsigned char *end = NULL;

    // Check if the source string is valid and initialize the search length and pointer accordingly.
    if (ms->search.s == NULL || ms->search.s_len == 0) {
        ms->search.s = NULL;
        ms->search.s_len = 0;
        return 0;
    }

    // Determine the byte count and line count for the search based on the flags and range in'm'.
    if ((m->str_flags & REGEX_OFFSET_START)!= 0) {
        bytecnt = ms->search.s_len;
        linecnt = 1;
    } else {
        bytecnt = m->vallen;
        linecnt = 0;
    }

    // If a line count flag is set, calculate the byte count by multiplying the line count by a constant.
    // Otherwise, set the byte count to the specified range without line counting.
    if (linecnt > 0 && (m->str_flags & REGEX_LINE_COUNT)!= 0) {
        bytecnt = linecnt * 64;
    }

    // Check if the byte count is valid and adjust it if necessary.
    if (bytecnt == 0 || bytecnt > nbytes - offset)
        bytecnt = nbytes - offset;
    if (bytecnt > ms->regex_max)
        bytecnt = ms->regex_max;

    // Initialize the search region pointers.
    buf = RCAST(char *, source) + offset;
    end = last = RCAST(char *, source) + bytecnt + offset;

    // Iterate over the search region and count the number of lines.
    for (lines = linecnt, b = buf; lines && b < end &&
         ((b = CAST(char *,
             memchr(c = b, '\n', CAST(size_t, (end - b)))))
         || (b = CAST(char *,
             memchr(c, '\r', CAST(size_t, (end - c))))));
         lines--, b++) {
        last = b;
        if (b < end - 1 && b[0] == '\r' && b[1] == '\n')
            b++;
    }

    // Adjust the search region pointers based on the number of lines.
    if (lines)
        last = RCAST(char *, source) + bytecnt;

    // Update the search region information.
    ms->search.s = buf;
    ms->search.s_len = last - buf;
    ms->search.offset = offset;
    ms->search.rm_len = 0;
    return 0;
}