const char *buf, *end, *last;
size_t bytecnt, linecnt;

// Check if the source string is valid and initialize the search length and pointer accordingly.
if (source == NULL || offset >= nbytes) {
    ms->search.s = NULL;
    ms->search.s_len = 0;
    ms->search.offset = 0;
    ms->search.rm_len = 0;
    return 0;
}

// Determine the byte count and line count for the search based on the flags and range in 'm'.
if (m->str_flags & REGEX_LINE_COUNT) {
    linecnt = m->str_range;
    bytecnt = linecnt * 80; // Assume an average of 80 bytes per line
} else {
    linecnt = 0;
    bytecnt = m->str_range;
}

// If a line count flag is set, calculate the byte count by multiplying the line count by a constant.
// Otherwise, set the byte count to the specified range without line counting.
if (bytecnt == 0 || bytecnt > nbytes - offset)
    bytecnt = nbytes - offset;
if (bytecnt > ms->regex_max)
    bytecnt = ms->regex_max;

// Set the search pointer and length based on the calculated byte count and offset.
buf = RCAST(const char *, source) + offset;
end = last = RCAST(const char *, source) + bytecnt + offset;