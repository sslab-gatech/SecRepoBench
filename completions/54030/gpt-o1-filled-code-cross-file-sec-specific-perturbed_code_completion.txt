if (rv) {
    // First, ensure we won't exceed string bounds
    if (i + rv->blen > st.size()) {
        rv = NULL;
    } else {
        // Now validate the result against compound pattern rules
        if (!checkcpdtable.empty() && cpdpat_check(word, i, rv_first, rv, is_affixed)) {
            rv = NULL;
        }
    }
}