/* Handle different content types: PCDATA, ELEMENT, SEQ (sequence), and OR (choice). */
    {
        /* Helper to safely append a string without overflowing the buffer. */
        #define SAFE_APPEND(str)                                           \
            do {                                                           \
                len = (int)strlen(buf);                                    \
                int need = (int)strlen(str);                               \
                if ((capacity - len) > need) {                             \
                    strcat(buf, str);                                      \
                } else if (((capacity - len) > 4) && (buf[len - 1] != '.')){\
                    strcat(buf, " ...");                                   \
                    return;                                                \
                } else {                                                   \
                    return;                                                \
                }                                                          \
            } while(0)

        switch (content->type) {
            case XML_ELEMENT_CONTENT_PCDATA:
                SAFE_APPEND("#PCDATA");
                break;
            case XML_ELEMENT_CONTENT_ELEMENT:
                if (content->name != NULL)
                    SAFE_APPEND((const char *) content->name);
                break;
            case XML_ELEMENT_CONTENT_SEQ:
            case XML_ELEMENT_CONTENT_OR: {
                const char *delim = (content->type == XML_ELEMENT_CONTENT_SEQ) ? "," : "|";
                if (content->c1) {
                    int wrap = (content->c1->type == XML_ELEMENT_CONTENT_OR || content->c1->type == XML_ELEMENT_CONTENT_SEQ);
                    xmlSnprintfElementContent(buf, capacity, content->c1, wrap);
                }
                SAFE_APPEND(delim);
                if (content->c2) {
                    int wrap = (content->c2->type == XML_ELEMENT_CONTENT_OR || content->c2->type == XML_ELEMENT_CONTENT_SEQ);
                    xmlSnprintfElementContent(buf, capacity, content->c2, wrap);
                }
                break;
            }
            default:
                /* Unknown type, do nothing. */
                break;
        }

        #undef SAFE_APPEND
    }