switch (content->type) {
    case XML_ELEMENT_CONTENT_PCDATA:
        if (capacity - len > 7)
            strcat(buf, "#PCDATA");
        else
            goto truncate;
        break;
    case XML_ELEMENT_CONTENT_ELEMENT:
        if (content->prefix != NULL) {
            if (capacity - len > strlen(content->prefix) + strlen((char*)content->name) + 2) {
                strcat(buf, (char*)content->prefix);
                strcat(buf, ":");
                strcat(buf, (char*)content->name);
            } else
                goto truncate;
        } else {
            if (capacity - len > strlen((char*)content->name)) {
                strcat(buf, (char*)content->name);
            } else
                goto truncate;
        }
        break;
    case XML_ELEMENT_CONTENT_SEQ:
        xmlSnprintfElementContent(buf, capacity, content->c1, 1);
        if (buf[len - 1] != ')') {
            if (capacity - len > 1)
                strcat(buf, ",");
            else
                goto truncate;
        }
        xmlSnprintfElementContent(buf, capacity, content->c2, 0);
        break;
    case XML_ELEMENT_CONTENT_OR:
        xmlSnprintfElementContent(buf, capacity, content->c1, 1);
        if (buf[len - 1] != ')') {
            if (capacity - len > 1)
                strcat(buf, "|");
            else
                goto truncate;
        }
        xmlSnprintfElementContent(buf, capacity, content->c2, 0);
        break;
}
goto done;

truncate:
if ((capacity - len > 4) && (buf[len - 1] != '.'))
    strcat(buf, " ...");

done: