if (ctx->bytes_in_header) {
    // Try to find a start code by appending up to 4 bytes from the new data to the stored header
    u8 tmp[8];
    s32 sc_pos = -1;
    u32 to_copy = (ctx->bytes_in_header > 4) ? 4 : ctx->bytes_in_header;
    u32 lookahead = (remain > 4) ? 4 : remain;
    memcpy(tmp, ctx->hdr_store, to_copy);
    memcpy(tmp + to_copy, start, lookahead);

    // Search for start code in the combined buffer
    for (u32 i = 0; i + 3 < to_copy + lookahead; i++) {
        if (tmp[i] == 0x00 && tmp[i+1] == 0x00 && tmp[i+2] == 0x01) {
            sc_pos = i;
            break;
        }
    }

    if (sc_pos >= 0) {
        // Found a start code, determine its type and location
        if (sc_pos + 3 < to_copy + lookahead) {
            forced_sc_type = tmp[sc_pos + 3];
            sc_type_forced = GF_TRUE;
        }
        // The number of bytes before the start code
        current = sc_pos;
        bytes_from_store = (current < (s32)ctx->bytes_in_header) ? current : ctx->bytes_in_header;
        hdr_offset = (bytes_from_store < (u32)current) ? (current - bytes_from_store) : 0;
        // Reset header store
        ctx->bytes_in_header = 0;
    } else {
        // No start code found, treat stored bytes as continuation of previous data
        if (ctx->opid && ctx->bytes_in_header) {
            dst_pck = gf_filter_pck_new_alloc(ctx->opid, ctx->bytes_in_header, &packet_data);
            if (!dst_pck) return GF_OUT_OF_MEM;
            if (ctx->src_pck) gf_filter_pck_merge_properties(ctx->src_pck, dst_pck);
            memcpy(packet_data, ctx->hdr_store, ctx->bytes_in_header);
            gf_filter_pck_set_framing(dst_pck, GF_FALSE, GF_FALSE);
            gf_filter_pck_set_cts(dst_pck, GF_FILTER_NO_TS);
            gf_filter_pck_set_dts(dst_pck, GF_FILTER_NO_TS);
            if (byte_offset != GF_FILTER_NO_BO) {
                gf_filter_pck_set_byte_offset(dst_pck, byte_offset - ctx->bytes_in_header);
            }
            mpgviddmx_enqueue_or_dispatch(ctx, dst_pck, GF_FALSE, GF_FALSE);
        }
        ctx->bytes_in_header = 0;
        // Continue processing with current data
        current = -1;
    }
}