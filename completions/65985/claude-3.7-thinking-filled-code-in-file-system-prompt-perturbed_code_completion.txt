if (ctx->bytes_in_header) {
    Bool start_code_found = GF_FALSE;
    
    // Check if combining stored bytes with new packet creates a start code
    if (ctx->bytes_in_header + remain >= 4) {
        u8 tmp_buf[4];
        u32 i;
        
        // Fill temp buffer with header bytes
        for (i = 0; i < ctx->bytes_in_header; i++) {
            tmp_buf[i] = ctx->hdr_store[i];
        }
        
        // Fill remaining bytes from start of packet
        for (i = ctx->bytes_in_header; i < 4; i++) {
            tmp_buf[i] = start[i - ctx->bytes_in_header];
        }
        
        // Check for start code
        if ((tmp_buf[0] == 0) && (tmp_buf[1] == 0) && (tmp_buf[2] == 1)) {
            start_code_found = GF_TRUE;
            sc_type_forced = GF_TRUE;
            forced_sc_type = tmp_buf[3];
            hdr_offset = 4 - ctx->bytes_in_header;
            bytes_from_store = ctx->bytes_in_header;
            current = 0;  // We found a start code at position 0
        }
    }
    
    if (!start_code_found) {
        // No start code found spanning header and packet
        // Dispatch stored bytes if we're in a frame
        if (ctx->frame_started) {
            dst_pck = gf_filter_pck_new_alloc(ctx->opid, ctx->bytes_in_header, &packet_data);
            if (!dst_pck) return GF_OUT_OF_MEM;
            
            if (ctx->src_pck) gf_filter_pck_merge_properties(ctx->src_pck, dst_pck);
            memcpy(packet_data, ctx->hdr_store, ctx->bytes_in_header);
            gf_filter_pck_set_framing(dst_pck, GF_FALSE, GF_FALSE);
            gf_filter_pck_set_cts(dst_pck, GF_FILTER_NO_TS);
            gf_filter_pck_set_dts(dst_pck, GF_FILTER_NO_TS);
            
            if (byte_offset != GF_FILTER_NO_BO) {
                gf_filter_pck_set_byte_offset(dst_pck, byte_offset - ctx->bytes_in_header);
            }
            
            mpgviddmx_enqueue_or_dispatch(ctx, dst_pck, GF_FALSE, GF_FALSE);
        }
        
        // Look for start code in current packet
        current = mpgviddmx_next_start_code(start, remain);
    }
    
    ctx->bytes_in_header = 0;  // We've handled the stored bytes
}