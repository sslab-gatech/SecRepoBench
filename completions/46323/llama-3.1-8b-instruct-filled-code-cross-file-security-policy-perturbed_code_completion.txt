if (copy!= NULL) {
    if (cur->children!= NULL) {
        cur = cur->children;
        insert = copy;
        continue;
    }

    while (1) {
        if (cur->next!= NULL) {
            cur = cur->next;
            break;
        }

        cur = cur->parent;
        insert = insert->parent;
        if (cur == node) {
            cur = NULL;
            break;
        }
    }
    xmlAddChild(insert, copy);
}