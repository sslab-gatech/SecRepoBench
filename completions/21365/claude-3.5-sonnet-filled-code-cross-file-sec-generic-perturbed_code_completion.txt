if (flow->packet.payload_packet_len >= 34) {
  u_int16_t offset = 32;
  u_int8_t name_length = flow->packet.payload[offset];
  
  if (name_length > 0 && name_length <= 63 && offset + name_length + 1 <= flow->packet.payload_packet_len) {
    char netbios_name[64] = {0};
    int i, j;
    
    for (i = 0, j = 0; i < name_length; i += 2, j++) {
      if (offset + i + 1 >= flow->packet.payload_packet_len) break;
      char c = ((flow->packet.payload[offset + i] - 'A') << 4) | (flow->packet.payload[offset + i + 1] - 'A');
      if (c > 0 && c < 127) netbios_name[j] = c;
    }
    
    if (j > 0) {
      snprintf(flow->host_server_name, sizeof(flow->host_server_name), "%s", netbios_name);
    }
  }
}

ndpi_int_change_packet_protocol(detectionmodulestruct, flow, NDPI_PROTOCOL_NETBIOS, sub_protocol);