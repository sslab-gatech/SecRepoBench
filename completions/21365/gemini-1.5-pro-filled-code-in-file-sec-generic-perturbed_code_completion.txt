char netbios_name[256];
  u_int offset = 0;

  if (packet->payload_packet_len > 17 && packet->payload[16] == 0x20) {
    offset = 17; // Typical offset for NetBIOS name in some packets
  } else if (packet->payload_packet_len > 13 && packet->payload[12] > 0 && packet->payload[12] < 32) {
      offset = 13;
  } else {
      offset = 17;
  }

  if (ndpi_netbios_name_interpret((char *)(packet->payload + offset), packet->payload_packet_len - offset, netbios_name, sizeof(netbios_name)) > 0) {
    if (flow->host_server_name[0] == '\0') {
      strncpy(flow->host_server_name, netbios_name, sizeof(flow->host_server_name) - 1);
      flow->host_server_name[sizeof(flow->host_server_name) - 1] = '\0';
    }
  }

  NDPI_PROTOCOL_BITMASK proto_bitmask = 0;
  NDPI_ADD_PROTOCOL_TO_BITMASK(ndpi_struct, &proto_bitmask, NDPI_PROTOCOL_NETBIOS);
  ndpi_set_detected_protocol(ndpi_struct, flow, proto_bitmask, NDPI_PROTOCOL_NETBIOS);

  if (sub_protocol != NDPI_PROTOCOL_UNKNOWN) {
      NDPI_ADD_PROTOCOL_TO_BITMASK(ndpi_struct, &proto_bitmask, sub_protocol);
      ndpi_set_detected_protocol(ndpi_struct, flow, proto_bitmask, sub_protocol);
  }