u_int32_t offset = 0;

  if (sub_protocol == NDPI_NETBIOS_SUBPROTOCOL_NAME_QUERY_REQUEST ||
      sub_protocol == NDPI_NETBIOS_SUBPROTOCOL_NAME_REGISTRATION_REQUEST) {
    offset = 34; // Adjust offset for name query and registration requests.
  } else if (sub_protocol == NDPI_NETBIOS_SUBPROTOCOL_NAME_QUERY_RESPONSE ||
             sub_protocol == NDPI_NETBIOS_SUBPROTOCOL_NAME_REGISTRATION_RESPONSE) {
    if (flow->packet.payload_packet_len > 35 && flow->packet.payload[34] != 0x20) {
      offset = 35; // Adjust offset for name query and registration responses based on payload content.
    }
  }

  if (offset > 0 && offset + 15 < flow->packet.payload_packet_len) {
    // Copy the NetBIOS name from the payload to the flow's host server name.
    memcpy(flow->host_server_name, flow->packet.payload + offset, 15);
    flow->host_server_name[15] = '\0'; // Null-terminate the name.
  }

  if (sub_protocol == NDPI_NETBIOS_SUBPROTOCOL_SESSION_REQUEST) {
    ndpi_int_change_packet_protocol(detectionmodulestruct, flow, NDPI_PROTOCOL_NETBIOS, NDPI_PROTOCOL_NETBIOS_SSN);
  } else if (sub_protocol == NDPI_NETBIOS_SUBPROTOCOL_SESSION_MESSAGE) {
    // Check if the SMB dissector is enabled and update the protocol accordingly.
    if (ndpi_is_protocol_detected(detectionmodulestruct, NDPI_PROTOCOL_SMB) > 0) {
      ndpi_int_change_packet_protocol(detectionmodulestruct, flow, NDPI_PROTOCOL_NETBIOS, NDPI_PROTOCOL_SMB);
    } else {
      ndpi_int_change_packet_protocol(detectionmodulestruct, flow, NDPI_PROTOCOL_NETBIOS, NDPI_PROTOCOL_NETBIOS_SSN);
    }
  }