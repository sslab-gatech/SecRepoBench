u_int8_t name_offset = 1; // Default offset
  u_int8_t name_length;
  char netbios_name[256] = {0}; // Ensure enough space for the name

  if (flow->packet.payload_packet_len > 0) {
    if (flow->packet.payload[0] == 0x20 || flow->packet.payload[0] == 0x21) {
      name_offset = 2; // Adjust offset if the first byte indicates a different format
    }

    if (flow->packet.payload_packet_len > name_offset) {
      name_length = flow->packet.payload[name_offset];

      if ((name_offset + 1 + name_length) <= flow->packet.payload_packet_len && name_length < sizeof(netbios_name)) {
        memcpy(netbios_name, &flow->packet.payload[name_offset + 1], name_length);
        netbios_name[name_length] = '\0'; // Null-terminate the name

        NDPI_LOG_DBG(detectionmodulestruct, "NetBIOS name: %s\n", netbios_name);

        ndpi_set_host_server_name(detectionmodulestruct, flow, netbios_name, strlen(netbios_name));
      }
    }
  }

  if (sub_protocol != NDPI_PROTOCOL_UNKNOWN) {
    NDPI_LOG_DBG(detectionmodulestruct, "Setting NetBIOS sub-protocol: %u\n", sub_protocol);
    ndpi_int_change_packet_protocol(detectionmodulestruct, flow, NDPI_PROTOCOL_NETBIOS, sub_protocol);
  }