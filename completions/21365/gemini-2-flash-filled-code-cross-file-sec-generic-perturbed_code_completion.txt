u_int offset = 1; // Default offset
  u_int name_start = offset;
  u_int name_length;
  struct ndpi_packet_struct *packet = &flow->packet;

  if (packet->payload_packet_len <= 2)
    return;

  if (packet->payload[0] == 0x20) {
    offset = 2;
    name_start = offset;
  }

  if (packet->payload_packet_len <= offset)
    return;

  name_length = packet->payload[offset - 1];

  if (name_length > 30 || (name_start + name_length) > packet->payload_packet_len)
    return;

  if (name_length > 0) {
    char netbios_name[31];
    memcpy(netbios_name, &packet->payload[name_start], name_length);
    netbios_name[name_length] = '\0';

    NDPI_LOG_DBG(detectionmodulestruct, "NetBIOS name: %s\n", netbios_name);

    ndpi_strncpy(flow->host_server_name, netbios_name, sizeof(flow->host_server_name) - 1);
  }

  ndpi_int_change_packet_protocol(detectionmodulestruct,
                               flow,
                               NDPI_PROTOCOL_NETBIOS,
                               sub_protocol);
}