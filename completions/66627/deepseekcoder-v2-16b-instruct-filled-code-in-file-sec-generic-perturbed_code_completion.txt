space_id = H5Dget_space(dset_id);
            H5Sselect_hyperslab(space_id, H5S_SELECT_SET, size_offset_dims, NULL, mdims, NULL);
            mspace_id = H5Screate_simple(rank, mdims, NULL);
            err = Mat_H5WriteData(dset_id, h5_type, mspace_id, space_id, isComplex, data);
            H5Sclose(mspace_id);
        } else {
            err = MATIO_E_OUT_OF_MEMORY;
        }
        free(size_offset_dims);
    } else {
        err = MATIO_E_BAD_ARGUMENT;
    }
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteEmpty(hid_t id, matvar_t *matvar, const char *name, const char *class_name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t dims[1];

    dims[0] = 0;
    type_id = H5Tcopy(H5T_STD_I64LE);
    dset_id = H5Dcreate(id, name, type_id, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    H5Tclose(type_id);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, dims, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteCell73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t i, nrefs;

    nrefs = (hsize_t)matvar->nbytes / sizeof(hobj_ref_t);
    dset_id = H5Dcreate(id, name, H5T_STD_REF_OBJ, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, &nrefs, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    *refs_id = H5Dcreate(id, name, H5T_STD_REF_OBJ, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( *refs_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(*refs_id);
    H5Sset_extent_simple(space_id, 1, &nrefs, NULL);
    H5Sclose(space_id);

    for ( i = 0; i < nrefs; i++ ) {
        H5DOwrite_ref(id, name, H5P_DEFAULT, i, matvar->internal->hdf5_ref);
    }

    return err;
}

static int
Mat_VarWriteChar73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t i, nchars;

    nchars = (hsize_t)matvar->nbytes;
    dset_id = H5Dcreate(id, name, H5T_NATIVE_CHAR, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, &nchars, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    type_id = H5Dget_type(dset_id);
    for ( i = 0; i < nchars; i++ ) {
        H5Dwrite(dset_id, type_id, H5S_ALL, H5S_ALL, H5P_DEFAULT, matvar->data + i);
    }
    H5Tclose(type_id);

    return err;
}

static int
Mat_WriteEmptyVariable73(hid_t id, const char *name, hsize_t rank, size_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = SizeType2H5T();
    if ( type_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    dset_id = H5Dcreate(id, name, type_id, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    H5Tclose(type_id);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, rank, dims, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteLogical73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t i, nlogicals;

    nlogicals = (hsize_t)matvar->nbytes;
    dset_id = H5Dcreate(id, name, H5T_NATIVE_INT8, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, &nlogicals, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    type_id = H5Dget_type(dset_id);
    for ( i = 0; i < nlogicals; i++ ) {
        H5Dwrite(dset_id, type_id, H5S_ALL, H5S_ALL, H5P_DEFAULT, matvar->data + i);
    }
    H5Tclose(type_id);

    return err;
}

static int
Mat_VarWriteNumeric73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims, hsize_t *max_dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t rank = matvar->rank;
    int isComplex = matvar->isComplex;

    type_id = DataType(DataType2H5T(matvar->data_type), isComplex);
    if ( type_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    dset_id = H5Dcreate(id, name, type_id, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    H5Tclose(type_id);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, rank, dims, max_dims);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteAppendNumeric73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims, int dim)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id;
    int rank = matvar->rank;
    int isComplex = matvar->isComplex;

    dset_id = H5Dopen(id, name, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, rank, dims, NULL);
    H5Sclose(space_id);

    err = Mat_H5WriteData(dset_id, DataType2H5T(matvar->data_type), H5S_ALL, H5S_ALL, isComplex,
                          matvar->data);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteSparse73(hid_t id, matvar_t *matvar, const char *name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t i, nrows, ncols;

    nrows = matvar->dims[0];
    ncols = matvar->dims[1];
    type_id = H5T_NATIVE_HSIZE;
    dset_id = H5Dcreate(id, name, type_id, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, &nrows, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    dset_id = H5Dcreate(id, "jc", type_id, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, &ncols, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    dset_id = H5Dcreate(id, "ir", type_id, H5S_SCALAR, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, &nrows, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    dset_id = H5Dcreate(id, "