herr_t herr;
int err = MATIO_E_NO_ERROR;
int rank;

/* Open the attribute named "MATLAB_fields" */
attr_id = H5Aopen(dset_id, "MATLAB_fields", H5P_DEFAULT);
if ( attr_id < 0 ) {
    return MATIO_E_GENERIC_READ_ERROR;
}

/* Get the dataspace of the attribute */
dspace_id = H5Aget_space(attr_id);
if ( dspace_id < 0 ) {
    H5Aclose(attr_id);
    return MATIO_E_GENERIC_READ_ERROR;
}

/* Get the rank of the dataspace */
rank = H5Sget_simple_extent_ndims(dspace_id);
if ( rank < 0 ) {
    /* Error retrieving the rank */
    H5Sclose(dspace_id);
    H5Aclose(attr_id);
    return MATIO_E_GENERIC_READ_ERROR;
}

if ( rank == 0 ) {
    /* Scalar dataspace, no fields */
    *nfields = 0;
} else {
    /* Get the dimensions of the dataspace */
    hsize_t *dims = (hsize_t *)malloc(rank * sizeof(hsize_t));
    if ( dims == NULL ) {
        H5Sclose(dspace_id);
        H5Aclose(attr_id);
        return MATIO_E_OUT_OF_MEMORY;
    }

    herr = H5Sget_simple_extent_dims(dspace_id, dims, NULL);
    if ( herr < 0 ) {
        free(dims);
        H5Sclose(dspace_id);
        H5Aclose(attr_id);
        return MATIO_E_GENERIC_READ_ERROR;
    }

    *nfields = dims[0]; /* Use the first dimension as the number of fields */
    free(dims);
}