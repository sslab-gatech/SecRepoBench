select_hyperslab(space_id, H5S_SELECT_SET, size_offset_dims, NULL, mdims, NULL);
            mspace_id = H5Screate_simple(rank, mdims, NULL);
            err = Mat_H5WriteData(dset_id, h5_type, mspace_id, space_id, isComplex, data);
            H5Sclose(mspace_id);
        } else {
            err = MATIO_E_OUT_OF_MEMORY;
        }
        free(size_offset_dims);
    } else {
        err = MATIO_E_BAD_ARGUMENT;
    }
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteRef(hid_t id, matvar_t *matvar, enum matio_compression compression, hid_t *refs_id,
                hobj_ref_t *ref)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, attr_id, space_id;
    hsize_t dims[1] = {1};

    dset_id = H5Dopen(id, "#refs#", H5P_DEFAULT);
    if ( dset_id < 0 ) {
        dset_id = H5Dcreate(id, "#refs#", H5T_STD_REF_OBJ, H5S_SCALAR, H5P_DEFAULT);
        if ( dset_id < 0 ) {
            return MATIO_E_GENERIC_WRITE_ERROR;
        }
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, dims, NULL);
    H5Sclose(space_id);

    attr_id = H5Acreate(dset_id, matvar->name, H5T_STD_REF_OBJ, H5S_SCALAR, H5P_DEFAULT);
    if ( attr_id < 0 ) {
        H5Dclose(dset_id);
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    *ref = H5Rcreate2(dset_id, H5P_OBJECT_COPY, H5P_DEFAULT, matvar->internal->hdf5_ref);
    if ( *ref < 0 ) {
        H5Aclose(attr_id);
        H5Dclose(dset_id);
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    H5Awrite(attr_id, H5T_STD_REF_OBJ, &(*ref));
    H5Aclose(attr_id);
    H5Dclose(dset_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteEmpty(hid_t id, matvar_t *matvar, const char *name, const char *class_name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id;
    hsize_t dims[1] = {0};

    dset_id = H5Dcreate(id, name, H5T_STD_REF_OBJ, H5S_SCALAR, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 1, dims, NULL);
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteCell73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id;
    hsize_t i, nelems = 1;

    for ( i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    dset_id = H5Dcreate(id, name, H5T_STD_REF_OBJ, H5S_SIMPLE, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, matvar->rank, dims, NULL);
    H5Sclose(space_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteChar73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id;
    hsize_t nelems = 1;

    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    dset_id = H5Dcreate(id, name, H5T_NATIVE_CHAR, H5S_SIMPLE, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, matvar->rank, dims, NULL);
    H5Sclose(space_id);

    if ( nelems ) {
        herr_t herr = H5Dwrite(dset_id, H5T_NATIVE_CHAR, H5S_ALL, H5S_ALL, H5P_DEFAULT, matvar->data);
        if ( herr < 0 ) {
            err = MATIO_E_GENERIC_WRITE_ERROR;
        }
    }

    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteNumeric73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims, hsize_t *max_dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = DataType2H5T(matvar->data_type);
    if ( type_id < 0 ) {
        return MATIO_E_BAD_TYPE;
    }

    dset_id = H5Dcreate(id, name, type_id, H5S_SIMPLE, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, matvar->rank, dims, max_dims);
    H5Sclose(space_id);

    if ( matvar->nbytes ) {
        err = Mat_H5WriteData(dset_id, type_id, H5S_ALL, H5S_ALL, matvar->isComplex, matvar->data);
    }

    H5Tclose(type_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteAppendNumeric73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims, int dim)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = DataType2H5T(matvar->data_type);
    if ( type_id < 0 ) {
        return MATIO_E_BAD_TYPE;
    }

    dset_id = H5Dopen(id, name, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        dset_id = H5Dcreate(id, name, type_id, H5S_SIMPLE, H5P_DEFAULT);
        if ( dset_id < 0 ) {
            H5Tclose(type_id);
            return MATIO_E_GENERIC_WRITE_ERROR;
        }
        space_id = H5Dget_space(dset_id);
        H5Sset_extent_simple(space_id, matvar->rank, dims, NULL);
        H5Sclose(space_id);
    } else {
        space_id = H5Dget_space(dset_id);
    }

    if ( dim < 1 || dim > matvar->rank ) {
        H5Sclose(space_id);
        H5Tclose(type_id);
        H5Dclose(dset_id);
        return MATIO_E_BAD_ARGUMENT;
    }

    hsize_t *size_offset_dims;
    size_offset_dims = (hsize_t *)malloc(matvar->rank * sizeof(*size_offset_dims));
    if ( NULL != size_offset_dims ) {
        hsize_t offset;
        hid_t mspace_id;
        int k;

        (void)H5Sget_simple_extent_dims(space_id, size_offset_dims, NULL);
        offset = size_offset_dims[matvar->rank - dim];
        size_offset_dims[matvar->rank - dim] += dims[dim - 1];
        H5Dset_extent(dset_id, size_offset_dims);
        for ( k = 0; k < matvar->rank; k++ ) {
            size_offset_dims[k] = 0;
        }
        size_offset_dims[matvar->rank - dim] = offset;
        /* Need to reopen */
        H5Sclose(space_id);
        space_id = H5Dget_space(dset_id);
        H5Sselect_hyperslab(space_id, H5S_SELECT_SET, size_offset_dims, NULL, dims, NULL);
        mspace_id = H5Screate_simple(matvar->rank, dims, NULL);
        err = Mat_H5WriteData(dset_id, type_id, mspace_id, space_id, matvar->isComplex, matvar->data);
        H5Sclose(mspace_id);
    } else {
        err = MATIO_E_OUT_OF_MEMORY;
    }
    free(size_offset_dims);
    H5Sclose(space_id);
    H5Tclose(type_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteSparse73(hid_t id, matvar_t *matvar, const char *name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t dims[2] = {matvar->dims[0], matvar->dims[1] - 1};

    type_id = H5Tcreate(H5T_COMPOUND, 2 * sizeof(hsize_t));
    H5Tinsert(type_id, "row", 0, H5T_NATIVE_HSIZE);
    H5Tinsert(type_id, "col", sizeof(hsize_t), H5T_NATIVE_HSIZE);

    dset_id = H5Dcreate(id, name, type_id, H5S_SIMPLE, H5P_DEFAULT);
    if ( dset_id < 0 ) {
        H5Tclose(type_id);
        return MATIO_E_GENERIC_WRITE_ERROR;
    }
    space_id = H5Dget_space(dset_id);
    H5Sset_extent_simple(space_id, 2, dims, NULL);
    H5Sclose(space_id);
    H5Tclose(type_id);

    if ( matvar->nbytes ) {
        mat_complex_split_t *complex_data = (mat_complex_split_t *)mat