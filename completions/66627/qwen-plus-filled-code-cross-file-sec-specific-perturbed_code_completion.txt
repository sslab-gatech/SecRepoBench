attr_id = H5Aopen_by_name(dset_id, ".", "MATLAB_fields", H5P_DEFAULT, H5P_DEFAULT);
if ( attr_id < 0 ) {
    return MATIO_E_ATTRIBUTE_NOT_FOUND;
}
dspace_id = H5Aget_space(attr_id);
if ( dspace_id < 0 ) {
    H5Aclose(attr_id);
    return MATIO_E_INVALID_DATASPACE;
}
if ( H5Sget_simple_extent_ndims(dspace_id) != 1 ) {
    H5Sclose(dspace_id);
    H5Aclose(attr_id);
    return MATIO_E_INVALID_DATASPACE;
}
if ( H5Sget_simple_extent_dims(dspace_id, nfields, NULL) < 0 ) {
    H5Sclose(dspace_id);
    H5Aclose(attr_id);
    return MATIO_E_INVALID_DATASPACE;
}
int err = MATIO_E_NO_ERROR;
if ( *nfields > 0 && *nfields <= H5S_UNLIMITED ) {
    // Proceed with existing logic for valid number of fields
} else {
    err = MATIO_E_INVALID_FIELD_COUNT;
}
H5Sclose(dspace_id);