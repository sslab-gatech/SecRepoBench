// Check if the payload length is sufficient
  if(packet->payload_packet_len < 8) {
    return;
  }

  // Adjust payload pointer if over TCP
  if(packet->tcp != NULL) {
    ovpn_payload += 2;
  }

  // Extract operation code
  operationcode = ovpn_payload[0];

  // Check if over UDP and perform additional checks
  if(packet->udp != NULL) {
    if(flow->packet_counter == 0 && packet->payload_packet_len == 14 && operationcode == 0x38) {
      // Identify as OpenVPN
      flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
    } else if(flow->openvpn_counter < 3 && operationcode == 0x38) {
      // Attempt to extract and store session ID
      session_remote = &ovpn_payload[1];
      alen = ovpn_payload[13];
      if(alen == 0) {
        failed = 1;
      } else {
        // Store session ID
        memcpy(flow->openvpn_session_id, session_remote, alen);
      }
    } else if(flow->openvpn_counter >= 3 && flow->openvpn_counter < 10 && operationcode == 0x40) {
      // Verify session ID matches
      session_remote = &ovpn_payload[1];
      alen = ovpn_payload[13];
      if(alen != 0 && memcmp(flow->openvpn_session_id, session_remote, alen) == 0) {
        // Identify as OpenVPN
        flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
      } else {
        failed = 1;
      }
    }
  }

  // Increment OpenVPN counter
  flow->openvpn_counter++;

  // If detection attempt fails, exclude protocol
  if(failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }