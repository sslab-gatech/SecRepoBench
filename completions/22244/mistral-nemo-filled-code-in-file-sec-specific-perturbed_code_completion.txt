if (packet->payload_length >= 10) {
    ovpn_payload = (packet->tcp_payload_offset > 0) ? packet->payload + packet->tcp_payload_offset : packet->payload;
    operationcode = ovpn_payload[0];
    if (packet->tcp_payload_offset > 0) {
      if (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
        if (packet->packet_direction == NDPI_DIRECTION_SERVER_TO_CLIENT) {
          if (flow->openvpn_counter == 0) {
            flow->openvpn_counter = 1;
            flow->openvpn_session_id = get_packet_id(ovpn_payload, check_pkid_and_detect_hmac_size(ovpn_payload));
          } else if (flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
            flow->openvpn_counter++;
            if (flow->openvpn_session_id == get_packet_id(ovpn_payload, check_pkid_and_detect_hmac_size(ovpn_payload))) {
              ndpi_set_detection_bitmask(ndpi_struct, flow, detection_bitmask, *id);
            } else {
              failed = 1;
            }
          }
        }
      } else if (operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
        if (packet->packet_direction == NDPI_DIRECTION_CLIENT_TO_SERVER) {
          if (flow->openvpn_counter > 0 && flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
            flow->openvpn_counter++;
            if (flow->openvpn_session_id == get_packet_id(ovpn_payload, check_pkid_and_detect_hmac_size(ovpn_payload))) {
              ndpi_set_detection_bitmask(ndpi_struct, flow, detection_bitmask, *id);
            } else {
              failed = 1;
            }
          }
        }
      }
    } else {
      if (operationcode == 0x00) {
        if (flow->openvpn_counter == 0) {
          ndpi_set_detection_bitmask(ndpi_struct, flow, detection_bitmask, *id);
        }
      }
    }
  }
  if (failed) {
    ndpi_remove_detection_bitmask(ndpi_struct, flow, detection_bitmask, *id);
  }
  flow->openvpn_counter++;