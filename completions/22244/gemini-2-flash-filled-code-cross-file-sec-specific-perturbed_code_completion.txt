if (packet->payload_len < 1)
    return;

  if (packet->tcp_retransmission)
    return;

  if (packet->ip_proto == IPPROTO_TCP) {
    /* Skip TLS handshake */
    if (packet->payload_len > 16 && ovpn_payload[0] == 0x16)
      return;

    ovpn_payload += 5; /* Skip TCP options */
  }

  operationcode = ovpn_payload[0];

  if (packet->ip_proto == IPPROTO_UDP) {
    if ((flow->packet.raw_packet[flow->packet.offset.payload_offset] == 0x80) &&
        (packet->payload_len == 60 || packet->payload_len == 64)) {
      NDPI_LOG_INFO(ndpi_struct, "OpenVPN Detection Successful\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    } else if (flow->openvpn_count < 5 && operationcode == 0x41) { /* client reset */
      if (packet->payload_len > 20) {
        session_remote = &ovpn_payload[16];
        if (flow->openvpn_session_id == NULL) {
          flow->openvpn_session_id = ndpi_malloc(17);
          if (flow->openvpn_session_id != NULL) {
            memcpy(flow->openvpn_session_id, session_remote, 16);
            flow->openvpn_session_id[16] = '\0';
          } else {
            NDPI_LOG_ERROR(ndpi_struct, "Memory allocation failed for openvpn_session_id\n");
            failed = 1;
          }
        }
      }
    } else if ((flow->openvpn_count >= 5) && (flow->openvpn_count <= 10) &&
               (operationcode == 0x51)) { /* server reset */
      if (packet->payload_len > 20) {
        session_remote = &ovpn_payload[16];
        if (flow->openvpn_session_id != NULL) {
          if (memcmp(flow->openvpn_session_id, session_remote, 16) == 0) {
            NDPI_LOG_INFO(ndpi_struct, "OpenVPN Detection Successful\n");
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
            return;
          } else {
            failed = 1;
          }
        } else {
          failed = 1;
        }
      }
    }
  }

  flow->openvpn_count++;

  if (failed)
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);