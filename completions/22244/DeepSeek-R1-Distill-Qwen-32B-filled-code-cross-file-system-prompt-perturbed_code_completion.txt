/* skip marked packets */
  if(packet->detected_protocol_stack[0] != NDPI_PROTOCOL_OPENVPN) {
    if (packet->payload_len < 5) {
      return;
    }

    operationcode = *ovpn_payload;
    
    if (packet->udp != NULL) {
      /* Check for OpenVPN specific patterns */
      if (flow->packet.packet_id == 0) {
        if (packet->payload_len == 5 && operationcode == 0x03) {
          NDPI_LOG_DBG(ndpi_struct, "Detected OpenVPN\n");
          ndpi_set_protocolDetection_result(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_DETECTION_TYPE_PROTOCOL);
          return;
        }
      } else {
        if (flow->openvpn_counter < 3) {
          if (operationcode == 0x04) { /* Client reset */
            session_remote = ovpn_payload + 3;
            memcpy(flow->session_remote, session_remote, 8);
          }
        } else if (flow->openvpn_counter >=1 && flow->openvpn_counter <=3) {
          if (operationcode == 0x05) { /* Server reset */
            session_remote = ovpn_payload + 3;
            if (memcmp(flow->session_remote, session_remote, 8) == 0) {
              NDPI_LOG_DBG(ndpi_struct, "Detected OpenVPN\n");
              ndpi_set_protocolDetection_result(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_DETECTION_TYPE_PROTOCOL);
              return;
            } else {
              failed = 1;
            }
          }
        }
      }
    }
    
    flow->openvpn_counter++;
    
    if (failed) {
      ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
    }
  }