NDPI_LOG_DBG(ndpi_struct, "search openvpn\n");

  /* Skip marked packets */
  if (packet->detected_protocol_stack[0] != NDPI_PROTOCOL_OPENVPN) {
    if (packet->payload_packet_len > 0) {
      if (packet->udp != NULL) {
        /* UDP specific processing */
        if (packet->payload_packet_len >= 8) {
          operationcode = ovpn_payload[0];
          if (operationcode == 0x38 || operationcode == 0x40) {
            /* Check for specific OpenVPN operation codes */
            if (flow->openvpn_stage == 0) {
              flow->openvpn_stage++;
              flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
              NDPI_LOG_INFO(ndpi_struct, "OpenVPN detected over UDP\n");
            }
          }
        }
      } else if (packet->tcp != NULL) {
        /* TCP specific processing */
        if (packet->payload_packet_len >= 2) {
          operationcode = ovpn_payload[0];
          alen = ovpn_payload[1];
          if (operationcode == 0x38 && alen == 0x01) {
            flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
            NDPI_LOG_INFO(ndpi_struct, "OpenVPN detected over TCP\n");
          }
        }
      }
    }
  }

  /* Increment OpenVPN counter */
  flow->openvpn_stage++;

  /* If detection failed, exclude OpenVPN from possible protocols */
  if (flow->detected_protocol != NDPI_PROTOCOL_OPENVPN) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }