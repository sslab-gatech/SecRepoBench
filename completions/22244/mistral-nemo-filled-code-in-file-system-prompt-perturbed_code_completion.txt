if (packet->payload_length >= 10) {
    ovpn_payload = (packet->tcp_payload) ? packet->tcp_payload : packet->payload;
    operationcode = ovpn_payload[0];
    if (packet->tcp) {
      alen = ovpn_payload[1];
      ovpn_payload += 2;
    } else {
      alen = 0;
    }

    if (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
      if (flow->openvpn_counter == 0 && packet->payload_length == 10 + alen) {
        ndpi_set_detection_bitmask(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
        return;
      } else if (flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT && operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) {
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
        if (hmac_size >= 0) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
          flow->openvpn_session_remote = session_remote;
          flow->openvpn_counter++;
        }
      }
    } else if (operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
      if (flow->openvpn_counter > 0 && flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
        if (hmac_size >= 0) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
          if (flow->openvpn_session_remote && memcmp(flow->openvpn_session_remote, session_remote, 16) == 0) {
            ndpi_set_detection_bitmask(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
            return;
          } else {
            failed = 1;
          }
        }
      }
    }
  }

  if (failed) {
    ndpi_remove_protocol_from_detection_bitmask(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }

  flow->openvpn_counter++;