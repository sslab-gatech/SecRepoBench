if (packet->payload_packet_len < 4) {
    failed = 1;
  } else {
    if (packet->tcp) {
      ovpn_payload += 2; // Skip the 2-byte OpenVPN record length field in TCP
    }
    operationcode = ovpn_payload[0];
    if (packet->udp && flow->packet_counter == 1) {
      if ((packet->payload_packet_len == 1300 || packet->payload_packet_len == 1500) && operationcode == 3) {
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
        return;
      }
    }
    if (flow->l4.openvpn_counter < 10) {
      if (operationcode == 1) { // Client reset
        session_remote = ovpn_payload + 1;
        memcpy(flow->l4.openvpn_session_id, session_remote, 8);
        flow->l4.openvpn_counter++;
      } else if (operationcode == 2 && flow->l4.openvpn_counter > 0 && flow->l4.openvpn_counter < 10) { // Server reset
        session_remote = ovpn_payload + 1;
        if (memcmp(flow->l4.openvpn_session_id, session_remote, 8) == 0) {
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
          return;
        } else {
          failed = 1;
        }
      }
    } else {
      failed = 1;
    }
  }
  flow->l4.openvpn_counter++;
  if (failed) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
  }