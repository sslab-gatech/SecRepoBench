if(packet->payload_packet_len < 1) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  if(packet->tcp != NULL) {
    ovpn_payload += 2;
    if(packet->payload_packet_len < 3) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
  }

  operationcode = *ovpn_payload;
  if(packet->udp != NULL) {
    if(flow->packet_counter == 1 && packet->payload_packet_len >= 14 && (operationcode == 1 || operationcode == 2)) {
      NDPI_LOG_INFO(ndpi_struct, "found OpenVPN\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    }

    if(flow->ovpn_counter < 3 && operationcode == 3) {
      alen = *(ovpn_payload + 1);
      if(alen >= 8 && alen <= 64) {
        session_remote = ovpn_payload + 2;
        memcpy(flow->ovpn_session_id, session_remote, alen);
        flow->ovpn_session_id_len = alen;
      }
    } else if(flow->ovpn_counter >= 3 && flow->ovpn_counter < 12 && operationcode == 4) {
      alen = *(ovpn_payload + 1);
      if(alen == flow->ovpn_session_id_len && alen != 0) {
        session_remote = ovpn_payload + 2;
        if(memcmp(flow->ovpn_session_id, session_remote, alen) == 0) {
          NDPI_LOG_INFO(ndpi_struct, "found OpenVPN\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        } else {
          failed = 1;
        }
      }
    }
  }

  flow->ovpn_counter++;
  if(failed) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
  }