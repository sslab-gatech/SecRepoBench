if(packet->payload_packet_len < 8) return;

  if(packet->tcp != NULL) {
    if(packet->payload_packet_len < 20) return;
    ovpn_payload += 2;
  }

  operationcode = ovpn_payload[0];

  if(packet->udp != NULL) {
    if(flow->packet_counter == 0) {
      if(packet->payload_packet_len == 14 && operationcode == 0x38) {
        NDPI_LOG_INFO(ndpi_struct, "OpenVPN detected\n");
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    } else {
      if(flow->openvpn_counter < 3 && operationcode == 0x38) {
        alen = ovpn_payload[1];
        if(alen == 8) {
          session_remote = &ovpn_payload[2];
          memcpy(flow->openvpn_session_id, session_remote, alen);
          flow->openvpn_counter++;
          return;
        }
      } else if(flow->openvpn_counter >= 3 && flow->openvpn_counter < 10 && operationcode == 0x40) {
        alen = ovpn_payload[1];
        if(alen == 8) {
          session_remote = &ovpn_payload[2];
          if(memcmp(flow->openvpn_session_id, session_remote, alen) == 0) {
            NDPI_LOG_INFO(ndpi_struct, "OpenVPN detected\n");
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
            return;
          } else {
            failed = 1;
          }
        }
      }
    }
  }

  flow->openvpn_counter++;

  if(failed) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }