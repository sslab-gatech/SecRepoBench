if (packet->payload_packet_len >= 14) {
  if (packet->tcp != NULL)
    ovpn_payload = &packet->payload[1];

  operationcode = ovpn_payload[0] >> 3;

  if (packet->udp != NULL) {
    if ((packet->payload_packet_len == 14) && (operationcode == 7) && (flow->packet_counter == 1)) {
      NDPI_LOG_INFO(ndpi_struct, "found openvpn\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    }

    if ((flow->openvpn_counter < 3) && (operationcode == 1)) {
      alen = ovpn_payload[1];
      if ((alen > 0) && (packet->payload_packet_len >= (2 + alen))) {
        session_remote = &ovpn_payload[2];
        memcpy(flow->openvpn_session_id, session_remote, alen);
        flow->openvpn_session_id_len = alen;
      }
    } else if ((flow->openvpn_counter >= 3) && (flow->openvpn_counter <= 6) && (operationcode == 2)) {
      alen = ovpn_payload[1];
      if ((alen == flow->openvpn_session_id_len) && (packet->payload_packet_len >= (2 + alen))) {
        if (memcmp(&ovpn_payload[2], flow->openvpn_session_id, flow->openvpn_session_id_len) == 0) {
          NDPI_LOG_INFO(ndpi_struct, "found openvpn\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        }
      }
      failed = 1;
    }
  }

  flow->openvpn_counter++;
}

if (failed)
  NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);