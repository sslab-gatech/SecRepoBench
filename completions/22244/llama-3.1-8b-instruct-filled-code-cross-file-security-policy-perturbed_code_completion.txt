// <MASK>
  if (packet->payload_len >= 5) {
    if (packet->ip->protocol == IPPROTO_TCP) {
      ovpn_payload += 5;
    } else {
      ovpn_payload = packet->payload;
    }
    operationcode = ovpn_payload[0];
    alen = ovpn_payload[1];
    hmac_size = ovpn_payload[2];
    if (operationcode == 0x01 && alen == 0x00 && hmac_size == 0x00) {
      if (flow->openvpn_counter == 0) {
        flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
        flow->detected_protocol_stack[1] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[2] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[3] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[4] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[5] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[6] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[7] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[8] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[9] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[10] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[11] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[12] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[13] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[14] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[15] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[16] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[17] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[18] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[19] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[20] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[21] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[22] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[23] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[24] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[25] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[26] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[27] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[28] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[29] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[30] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[31] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[32] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[33] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[34] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[35] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[36] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[37] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[38] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[39] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[40] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[41] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[42] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[43] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[44] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[45] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[46] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[47] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[48] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[49] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[50] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[51] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[52] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[53] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[54] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[55] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[56] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[57] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[58] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[59] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[60] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[61] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[62] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->detected_protocol_stack[63] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
        flow->openvpn_counter++;
      } else if (flow->openvpn_counter < 10 && operationcode == 0x02) {
        session_remote = ovpn_payload + 5;
        if (memcmp(session_remote, flow->openvpn_session_id, 4) == 0) {
          flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
          flow->detected_protocol_stack[1] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[2] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[3] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[4] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[5] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[6] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[7] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[8] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[9] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[10] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[11] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[12] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[13] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[14] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[15] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[16] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[17] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[18] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[19] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[20] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[21] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[22] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[23] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[24] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[25] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[26] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[27] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[28] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[29] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[30] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[31] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[32] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[33] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[34] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[35] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[36] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[37] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[38] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[39] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[40] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[41] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[42] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[43] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[44] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[45] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[46] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[47] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[48] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[49] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[50] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[51] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[52] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[53] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[54] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[55] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[56] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[57] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[58] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[59] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[60] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[61] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[62] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[63] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->openvpn_counter++;
        } else {
          failed = 1;
        }
      } else if (flow->openvpn_counter >= 10 && operationcode == 0x02) {
        session_remote = ovpn_payload + 5;
        if (memcmp(session_remote, flow->openvpn_session_id, 4) == 0) {
          flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
          flow->detected_protocol_stack[1] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[2] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[3] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[4] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[5] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[6] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[7] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[8] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[9] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[10] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[11] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[12] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[13] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[14] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[15] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[16] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[17] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[18] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[19] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[20] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[21] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[22] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[23] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[24] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[25] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[26] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow->detected_protocol_stack[27] = NDPI_PROTOCOL_BITMASK_UNKNOWN;
          flow-