if (packet->payload_len >= 4) {
    if (packet->tcp) {
      ovpn_payload += 20;
    }
    operationcode = ovpn_payload[0];
    if (packet->udp) {
      if (flow->openvpn_counter == 0 && packet->payload_len == 24 && operationcode == 0x01) {
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
      } else if (flow->openvpn_counter < 10 && operationcode == 0x02) {
        if (packet->payload_len >= 16) {
          session_remote = ovpn_payload + 12;
          memcpy(flow->openvpn_session_id, session_remote, 4);
        }
      } else if (flow->openvpn_counter >= 10 && flow->openvpn_counter <= 20 && operationcode == 0x03) {
        if (packet->payload_len >= 16) {
          session_remote = ovpn_payload + 12;
          if (memcmp(flow->openvpn_session_id, session_remote, 4) == 0) {
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
          } else {
            failed = 1;
          }
        }
      }
    }
    flow->openvpn_counter++;
  } else {
    failed = 1;
  }
  if (failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }
}