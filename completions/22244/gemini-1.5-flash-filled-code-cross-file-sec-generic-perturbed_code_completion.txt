if (packet->payload_len >= 4) {
    operationcode = ovpn_payload[0];
    if (packet->udp) {
      if (flow->openvpn_counter == 0 && packet->payload_len == 24 && operationcode == 0x01) {
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
      } else if (flow->openvpn_counter < 10 && operationcode == 0x03) {
        alen = ovpn_payload[1];
        if (packet->payload_len >= 4 + alen) {
          session_remote = &ovpn_payload[2];
          flow->openvpn_session_id = (u_int32_t)ntohl(*((u_int32_t*)session_remote));
        }
      } else if (flow->openvpn_counter >= 10 && flow->openvpn_counter < 20 && operationcode == 0x04) {
        alen = ovpn_payload[1];
        if (packet->payload_len >= 4 + alen) {
          session_remote = &ovpn_payload[2];
          if (flow->openvpn_session_id == (u_int32_t)ntohl(*((u_int32_t*)session_remote))) {
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
          } else {
            failed = 1;
          }
        }
      }
    }
    flow->openvpn_counter++;
  }
  if (failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }