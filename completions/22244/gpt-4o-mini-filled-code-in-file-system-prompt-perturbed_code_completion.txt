if (packet->payload_length < 9) {
    return;
  }

  if (packet->protocol == NDPI_PROTOCOL_TCP) {
    ovpn_payload += 5; // Adjust for TCP header
  }

  operationcode = ovpn_payload[0] & P_OPCODE_MASK;
  hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);

  if (hmac_size == -1) {
    return;
  }

  if (flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
    if (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || 
        operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
      session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
      // Store session ID logic here
      flow->openvpn_counter++;
      return;
    }
  } else if (flow->openvpn_counter < (P_HARD_RESET_CLIENT_MAX_COUNT * 2)) {
    if (operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || 
        operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
      // Check session ID logic here
      if (/* session ID matches */) {
        flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
        return;
      }
    }
  }

  failed = 1; // Mark as failed if no conditions matched
  if (failed) {
    flow->possible_protocols &= ~NDPI_PROTOCOL_OPENVPN;
  }

  flow->openvpn_counter++;