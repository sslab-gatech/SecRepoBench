// <MASK>
  if (packet->payload_packet_len >= 4) {
    operationcode = ovpn_payload[2];
    if (packet->udp != NULL) {
      if (packet->payload_packet_len >= 12 && operationcode == 1) { // Client Hello
        // Check if it's the first packet in the flow and matches the criteria
        if (flow->ndpi_flow.openvpn_counter == 0) {
          // Extract session ID if available
          if (packet->payload_packet_len >= 30) {
            session_remote = ovpn_payload + 30;
            alen = session_remote[0];
            if (alen > 0 && alen <= 32) { // Session ID length should be reasonable
              memcpy(flow->session_id, session_remote + 1, alen);
              flow->session_id_len = alen;
              flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
            } else {
              failed = 1;
            }
          } else {
            failed = 1;
          }
        } else {
          failed = 1;
        }
      } else if (operationcode == 2) { // Server Hello
        // Check if the session ID matches
        if (flow->session_id_len > 0 && flow->session_id_len <= 32) {
          if (packet->payload_packet_len >= 30) {
            session_remote = ovpn_payload + 30;
            alen = session_remote[0];
            if (alen > 0 && alen <= 32 && memcmp(flow->session_id, session_remote + 1, alen) == 0) {
              flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
            } else {
              failed = 1;
            }
          } else {
            failed = 1;
          }
        } else {
          failed = 1;
        }
      } else if (operationcode == 3) { // Client Reset
        if (flow->ndpi_flow.openvpn_counter < 5) {
          // Extract session ID if available
          if (packet->payload_packet_len >= 30) {
            session_remote = ovpn_payload + 30;
            alen = session_remote[0];
            if (alen > 0 && alen <= 32) { // Session ID length should be reasonable
              memcpy(flow->session_id, session_remote + 1, alen);
              flow->session_id_len = alen;
              flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
            } else {
              failed = 1;
            }
          } else {
            failed = 1;
          }
        } else {
          failed = 1;
        }
      } else if (operationcode == 4) { // Server Reset
        if (flow->ndpi_flow.openvpn_counter < 5) {
          // Check if the session ID matches
          if (flow->session_id_len > 0 && flow->session_id_len <= 32) {
            if (packet->payload_packet_len >= 30) {
              session_remote = ovpn_payload + 30;
              alen = session_remote[0];
              if (alen > 0 && alen <= 32 && memcmp(flow->session_id, session_remote + 1, alen) == 0) {
                flow->detected_protocol = NDPI_PROTOCOL_OPENVPN;
              } else {
                failed = 1;
              }
            } else {
              failed = 1;
            }
          } else {
            failed = 1;
          }
        } else {
          failed = 1;
        }
      }
    } else if (packet->tcp != NULL) {
      // Additional checks for TCP if needed
    }
  } else {
    failed = 1;
  }

  if (failed) {
    flow->detected_protocol = NDPI_PROTOCOL_UNKNOWN;
  } else {
    flow->ndpi_flow.openvpn_counter++;
  }