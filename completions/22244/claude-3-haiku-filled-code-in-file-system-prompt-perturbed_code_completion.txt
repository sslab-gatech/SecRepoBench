// <MASK>
  if(packet->payload_packet_len < 12) {
    NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Insufficient payload length.\n");
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
    return;
  }

  operationcode = (ovpn_payload[0] & P_OPCODE_MASK);
  hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
  if(hmac_size < 0) {
    NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Could not detect HMAC size.\n");
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
    return;
  }

  if(packet->tcp_retransmission == 0) {
    if((operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) || (operationcode == P_CONTROL_HARD_RESET_CLIENT_V2)) {
      // First packet from client
      session_remote = ovpn_payload + P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size);
      alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];
      if(alen == 8) {
        memcpy(flow->l4.udp.openvpn_session_id, session_remote, alen);
        flow->l4.udp.openvpn_session_id_len = alen;
        flow->l4.udp.openvpn_counter = 1;
        NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Storing session ID.\n");
      } else {
        NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Invalid session ID length.\n");
        failed = 1;
      }
    } else if((operationcode == P_CONTROL_HARD_RESET_SERVER_V1) || (operationcode == P_CONTROL_HARD_RESET_SERVER_V2)) {
      // Second packet from server
      if(flow->l4.udp.openvpn_counter > 0 && flow->l4.udp.openvpn_counter <= P_HARD_RESET_CLIENT_MAX_COUNT) {
        session_remote = ovpn_payload + P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size);
        alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];
        if(alen == flow->l4.udp.openvpn_session_id_len && memcmp(flow->l4.udp.openvpn_session_id, session_remote, alen) == 0) {
          NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Session ID match.\n");
          ndpi_int_openvpn_add_connection(ndpi_struct, flow);
        } else {
          NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Session ID mismatch.\n");
          failed = 1;
        }
      } else {
        NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Unexpected server packet.\n");
        failed = 1;
      }
    } else {
      NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: Unexpected opcode.\n");
      failed = 1;
    }
  } else {
    NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "OpenVPN: TCP retransmission.\n");
    failed = 1;
  }

  flow->l4.udp.openvpn_counter++;

  if(failed) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
  }
// </MASK>