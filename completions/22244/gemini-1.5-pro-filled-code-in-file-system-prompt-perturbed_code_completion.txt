if (packet->payload_len < 12 /* minimum packet len */)
    return;

  if (packet->tcp != NULL)
    ovpn_payload += packet->tcp->header_len;

  operationcode = ovpn_payload[0] & P_OPCODE_MASK;

  if (packet->udp != NULL) {
    if (flow->l4.udp.seen_first_packet == 1 /* first packet */
        && packet->payload_len >= 41 && packet->payload_len <= 45
        && operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) {
      NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG,
               "found openvpn over udp, first pkt [c-reset-v1]\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    } else if (flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT
               && operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) {
      hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
      if(hmac_size == -1)
        return;

      alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];
      if(alen == 0)
        return;

      session_remote = ovpn_payload + P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size) + 1;
      NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG,
               "saving session id, hmac_size: %u\n", hmac_size);
      memcpy(flow->openvpn_session_id, session_remote, alen);
      flow->openvpn_session_id_len = alen;
    } else if (flow->openvpn_counter >= P_HARD_RESET_CLIENT_MAX_COUNT
               && flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT * 2
               && operationcode == P_CONTROL_HARD_RESET_SERVER_V1) {
      hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
      if(hmac_size == -1) {
        failed = 1;
        goto out;
      }

      alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];
      if(alen == 0) {
        failed = 1;
        goto out;
      }

      session_remote = ovpn_payload + P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size) + 1;
      NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG,
               "checking session id, hmac_size: %u\n", hmac_size);
      if (alen == flow->openvpn_session_id_len
          && !memcmp(flow->openvpn_session_id, session_remote, alen)) {
        NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "found openvpn over udp [s-reset-v1]\n");
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        return;
      } else {
        failed = 1;
        goto out;
      }
    }
  }

out:
  flow->openvpn_counter++;
  if (failed) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
  }