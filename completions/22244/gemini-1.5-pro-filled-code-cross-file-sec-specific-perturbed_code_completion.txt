if (packet->payload_len >= 4 + 1 + 2) {
    if (packet->tcp != NULL) {
      ovpn_payload += packet->l4_offset;
    }

    operationcode = ovpn_payload[4];

    if (packet->udp != NULL) {
      if (flow->ovpn_counter == 0 && packet->payload_len == 264 && operationcode == 1) {
        NDPI_LOG_DBG(ndpi_struct, "OpenVPN detected (client hello UDP)\n");
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      } else if (flow->ovpn_counter < 10 && operationcode == 3) {
        session_remote = ovpn_payload + 5;
        alen = session_remote[0];

        if (alen < 16) {
          memcpy(flow->ovpn_session_remote, session_remote + 1, alen);
          flow->ovpn_session_remote_len = alen;
        }
      } else if (flow->ovpn_counter >= 10 && flow->ovpn_counter < 20 && operationcode == 2) {
        session_remote = ovpn_payload + 5;
        alen = session_remote[0];

        if (alen == flow->ovpn_session_remote_len && memcmp(session_remote + 1, flow->ovpn_session_remote, alen) == 0) {
          NDPI_LOG_DBG(ndpi_struct, "OpenVPN detected (server hello UDP)\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        } else {
          failed = 1;
        }
      }
    }
    flow->ovpn_counter++;
  }

  if (failed) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }