// <MASK>
if (packet->detected_protocol_stack[0]!= NDPI_PROTOCOL_OPENVPN) {
  if (packet->tcp!= NULL) {
    if (packet->payload_len >= 5) {
      ovpn_payload += 5;
      operationcode = ovpn_payload[0];
      alen = ovpn_payload[1];
      hmac_size = ovpn_payload[2];
      session_remote = ovpn_payload + 3;
      if (operationcode == 0x01 && alen == 0x01 && hmac_size == 0x00) {
        flow->openvpn_counter++;
        if (flow->openvpn_counter == 1) {
          flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
        } else if (flow->openvpn_counter < 3) {
          if (operationcode == 0x02) {
            if (memcmp(session_remote, flow->openvpn_session_id, 4) == 0) {
              flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
            } else {
              failed = 1;
            }
          }
        }
      }
    }
  } else if (packet->udp!= NULL) {
    if (packet->payload_len >= 5) {
      ovpn_payload += 5;
      operationcode = ovpn_payload[0];
      alen = ovpn_payload[1];
      hmac_size = ovpn_payload[2];
      session_remote = ovpn_payload + 3;
      if (operationcode == 0x01 && alen == 0x01 && hmac_size == 0x00) {
        flow->openvpn_counter++;
        if (flow->openvpn_counter == 1) {
          flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
        } else if (flow->openvpn_counter < 3) {
          if (operationcode == 0x02) {
            if (memcmp(session_remote, flow->openvpn_session_id, 4) == 0) {
              flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
            } else {
              failed = 1;
            }
          }
        }
      }
    }
  }
  if (failed) {
    flow->possible_protocols &= ~(1 << NDPI_PROTOCOL_OPENVPN);
  }
}
flow->openvpn_counter++;