if (packet->payload_len < 1)
    return;

  if (packet->tcp != NULL) {
    /* TCP */
    ovpn_payload += 0;
  } else {
    /* UDP */
    if (packet->payload_len >= 28 && flow->packet_counter == 0 && ovpn_payload[0] == 0x23) {
      NDPI_LOG_INFO(ndpi_struct, "found openvpn over udp [1/2]\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    } else if (flow->ovpn_count < 5 && ovpn_payload[0] == 0x41) {
      /* Client reset */
      if (packet->payload_len >= 20) {
        session_remote = &ovpn_payload[4];
        memcpy(flow->ovpn_session_id, session_remote, 16);
        flow->ovpn_session_id_len = 16;
      }
    } else if ((flow->ovpn_count >= 5) && (flow->ovpn_count < 10) && (ovpn_payload[0] == 0x51)) {
      /* Server reset */
      if (packet->payload_len >= 20) {
        session_remote = &ovpn_payload[4];
        if (memcmp(flow->ovpn_session_id, session_remote, flow->ovpn_session_id_len) == 0) {
          NDPI_LOG_INFO(ndpi_struct, "found openvpn over udp [2/2]\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        } else {
          failed = 1;
        }
      }
    }
  }

  flow->ovpn_count++;

  if (failed)
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
}