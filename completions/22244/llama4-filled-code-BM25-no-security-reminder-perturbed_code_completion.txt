if (packet->payload_length >= 20) {
  if (packet->tcp != NULL) {
    ovpn_payload = packet->payload + packet->tcp->offset;
  }

  operationcode = ovpn_payload[0];
  alen = (ovpn_payload[1] >> 3) & 0x07;
  hmac_size = (int8_t)ovpn_payload[2 + alen];

  if (flow->packet_counter == 1) {
    if ((packet->payload_length >= 20) && (operationcode == 0x01 || operationcode == 0x07 || operationcode == 0x08)) {
      NDPI_LOG_INFO(ndpi_struct, "found OpenVPN\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
    }
  } else {
    if (flow->openvpn_counter < 3) {
      if (operationcode == 0x06) {
        session_remote = &ovpn_payload[3];
        flow->openvpn_session_id = ntohl(get_u32(session_remote));
        NDPI_LOG_DBG(ndpi_struct, "openvpn session id: 0x%08x\n", flow->openvpn_session_id);
      }
    } else if (flow->openvpn_counter < 10) {
      if (operationcode == 0x07) {
        session_remote = &ovpn_payload[3];
        if (flow->openvpn_session_id == ntohl(get_u32(session_remote))) {
          NDPI_LOG_INFO(ndpi_struct, "found OpenVPN\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        } else {
          failed = 1;
        }
      }
    }
  }

  flow->openvpn_counter++;
  if (failed) {
    NDPI_LOG_DBG(ndpi_struct, "exclude OpenVPN\n");
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_EXCLUDE_PROTO_NO_ADD);
  }
}