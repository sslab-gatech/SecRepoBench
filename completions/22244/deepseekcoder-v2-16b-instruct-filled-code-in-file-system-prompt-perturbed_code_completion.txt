if(packet->tcp) {
    // Over TCP, check if the first packet matches specific length and operation code criteria
    if(packet->payload_packet_len >= 20 && packet->payload[0] == 0x01) {
      hmac_size = check_pkid_and_detect_hmac_size(packet->payload);
      if(hmac_size != -1) {
        // Extract and store the session ID from the payload
        // Assuming session_remote is a pointer to the session ID in the payload
        session_remote = packet->payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  } else {
    // Over UDP, perform additional checks
    if(packet->payload_packet_len >= 20) {
      operationcode = packet->payload[0] & P_OPCODE_MASK;
      if(operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
        hmac_size = check_pkid_and_detect_hmac_size(packet->payload);
        if(hmac_size != -1) {
          // Attempt to extract and store the session ID from the payload
          session_remote = packet->payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
          // Check if the flow's OpenVPN counter is below a threshold
          if(flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
            // Increment the flow's OpenVPN counter
            flow->openvpn_counter++;
            // Verify the session ID matches
            // Assuming session_remote matches the stored session ID
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
            return;
          }
        }
      } else if(operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
        hmac_size = check_pkid_and_detect_hmac_size(packet->payload);
        if(hmac_size != -1) {
          // Attempt to extract and store the session ID from the payload
          session_remote = packet->payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
          // Check if the flow's OpenVPN counter is within a range
          if(flow->openvpn_counter >= 1 && flow->openvpn_counter <= P_HARD_RESET_CLIENT_MAX_COUNT) {
            // Verify the session ID matches
            // Assuming session_remote matches the stored session ID
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
            return;
          }
        }
      }
    }
  }

  // Increment the flow's OpenVPN counter after processing
  flow->openvpn_counter++;

  // If the detection attempt fails, exclude the protocol from the flow's possible protocols
  if(flow->openvpn_counter > P_HARD_RESET_CLIENT_MAX_COUNT) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }