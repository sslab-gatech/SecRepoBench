if(packet->payload_packet_len < 20) {
    return;
  }

  if(flow->detected_protocol_stack[0] != NDPI_PROTOCOL_UNKNOWN) {
    return;
  }

  if(packet->detected_protocol != NDPI_PROTOCOL_UNKNOWN) {
    return;
  }

  if(packet->tcp != NULL) {
    if(packet->payload_packet_len < 40) {
      return;
    }
    ovpn_payload += 2;
  }

  operationcode = ovpn_payload[0] & P_OPCODE_MASK;

  if(packet->udp != NULL) {
    if(flow->openvpn_stage == 0) {
      if(packet->payload_packet_len == 58 && 
         (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || 
          operationcode == P_CONTROL_HARD_RESET_CLIENT_V2)) {
        session_remote = ovpn_payload + 12;
        flow->openvpn_stage++;
        memcpy(flow->openvpn_session_id, session_remote, 8);
        return;
      }
    } else if(flow->openvpn_stage < P_HARD_RESET_CLIENT_MAX_COUNT) {
      if(operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || 
         operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
        session_remote = ovpn_payload + 12;
        if(memcmp(flow->openvpn_session_id, session_remote, 8) == 0) {
          flow->openvpn_stage++;
          return;
        }
      } else if(operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || 
                operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
        session_remote = ovpn_payload + 12;
        if(memcmp(flow->openvpn_session_id, session_remote, 8) == 0) {
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        } else {
          failed = 1;
        }
      }
    }
  }

  if(failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }
  flow->openvpn_stage++;