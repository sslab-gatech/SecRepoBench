if(packet->payload_packet_len >= 8) {
    if(packet->tcp != NULL && packet->payload_packet_len > 8) {
      ovpn_payload++;
    }
    operationcode = ovpn_payload[0];
    if(packet->udp != NULL) {
      if(flow->openvpn_stage == 0 && packet->payload_packet_len == 14 && operationcode == 0x38) {
        ndpi_int_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_REAL_PROTOCOL);
        return;
      } else if(flow->openvpn_stage < 2 && operationcode == 0x40) {
        session_remote = &ovpn_payload[1];
        memcpy(flow->openvpn_session_id, session_remote, 8);
        flow->openvpn_stage++;
      } else if(flow->openvpn_stage >= 1 && flow->openvpn_stage < 3 && operationcode == 0x41) {
        session_remote = &ovpn_payload[1];
        if(memcmp(flow->openvpn_session_id, session_remote, 8) == 0) {
          ndpi_int_add_connection(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_REAL_PROTOCOL);
          return;
        } else {
          failed = 1;
        }
      }
      flow->openvpn_stage++;
    }
  }
  if(failed) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }