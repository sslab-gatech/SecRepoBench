if (packet->payload_len >= 14 /* minimum packet len */) {
    if (packet->tcp != NULL)
      ovpn_payload += packet->tcp->header_len;

    operationcode = ovpn_payload[0] & P_OPCODE_MASK;

    if (packet->udp != NULL) {
      if (flow->l4.udp.seen_first_packet == 0) {
        if ((packet->payload_len >= 54 && packet->payload_len <= 60) &&
            ((operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) || (operationcode == P_CONTROL_HARD_RESET_CLIENT_V2))) {
          NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "seen first openvpn packet (client v%d)\n",
                   (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) ? 1 : 2);

          NDPI_BITMASK_SET(flow->detected_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
          return;
        }
      } else if (flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT &&
                 ((operationcode == P_CONTROL_HARD_RESET_CLIENT_V1) || (operationcode == P_CONTROL_HARD_RESET_CLIENT_V2))) {
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);

        if (hmac_size > 0) {
          alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];

          if (alen > 0 && alen <= 255) {
            session_remote = (u_int8_t *)malloc(alen);
            if (session_remote != NULL) {
              memcpy(session_remote, ovpn_payload + P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size) + 1, alen);
              flow->openvpn_session_remote_len = alen;
              flow->openvpn_session_remote = session_remote;
            } else {
              flow->openvpn_session_remote_len = 0;
              flow->openvpn_session_remote = NULL;
            }
          }
        }
      } else if (flow->openvpn_counter >= P_HARD_RESET_CLIENT_MAX_COUNT && flow->openvpn_counter < (P_HARD_RESET_CLIENT_MAX_COUNT * 2) &&
                 ((operationcode == P_CONTROL_HARD_RESET_SERVER_V1) || (operationcode == P_CONTROL_HARD_RESET_SERVER_V2))) {
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);

        if (hmac_size > 0) {
          alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];

          if (alen > 0 && alen <= 255 && flow->openvpn_session_remote_len == alen) {
            if (memcmp(flow->openvpn_session_remote, ovpn_payload + P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size) + 1, alen) == 0) {
              NDPI_LOG(NDPI_PROTOCOL_OPENVPN, ndpi_struct, NDPI_LOG_DEBUG, "found openvpn connection (server v%d)\n",
                       (operationcode == P_CONTROL_HARD_RESET_SERVER_V1) ? 1 : 2);

              NDPI_BITMASK_SET(flow->detected_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
              return;
            } else
              failed = 1;
          }
        }
      }
    }
  }

  flow->openvpn_counter++;

  if (failed) {
    NDPI_BITMASK_CLEAR(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
  }