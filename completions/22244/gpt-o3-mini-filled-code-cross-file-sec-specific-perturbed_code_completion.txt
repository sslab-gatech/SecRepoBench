#define MIN_OVPN_PAYLOAD 5
#define SESSION_ID_LENGTH 8
#define OVPN_FIRST_PACKET_OPCODE 0x01
#define OVPN_CLIENT_RESET_OPCODE 0x02
#define OVPN_SERVER_RESET_OPCODE 0x03

if(packet->payload_packet_len < MIN_OVPN_PAYLOAD) {
  /* Not enough data for OpenVPN detection; increment counter and exclude protocol */
  flow->openvpn_counter++;
  packet->detected_protocol_stack[0] = NDPI_PROTOCOL_UNKNOWN;
  return;
}

/* If the packet is over TCP, adjust the payload pointer by the TCP header length if available */
if(packet->tcp != NULL && packet->tcp_header_length > 0 &&
   packet->payload_packet_len > packet->tcp_header_length) {
  ovpn_payload += packet->tcp_header_length;
}

/* Extract the operation code from the payload */
operationcode = ovpn_payload[0];

/* For UDP packets, perform additional OpenVPN-specific checks */
if(packet->udp != NULL) {
  /* Check if this is the first packet in the flow matching specific criteria */
  if(flow->packet_counter == 0 &&
     packet->payload_packet_len == 60 &&  /* Example fixed length criteria */
     operationcode == OVPN_FIRST_PACKET_OPCODE) {
    packet->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
    return;
  }

  if(flow->openvpn_counter < 5) {  /* Example threshold for additional checks */
    if(operationcode == OVPN_CLIENT_RESET_OPCODE) {
      /* Ensure sufficient payload length before extracting session ID */
      if(packet->payload_packet_len < (1 + SESSION_ID_LENGTH)) {
        failed = 1;
      } else {
        /* Safely extract the session ID from the payload */
        memcpy(flow->openvpn_session_id, ovpn_payload + 1, SESSION_ID_LENGTH);
      }
    } else if(operationcode == OVPN_SERVER_RESET_OPCODE) {
      /* Verify the session ID if enough payload is available */
      if(packet->payload_packet_len < (1 + SESSION_ID_LENGTH)) {
        failed = 1;
      } else if(memcmp(flow->openvpn_session_id, ovpn_payload + 1, SESSION_ID_LENGTH) == 0) {
        packet->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
        return;
      } else {
        failed = 1;
      }
    }
  }
}

/* Increment the OpenVPN counter after processing */
flow->openvpn_counter++;

/* If any detection step failed, mark OpenVPN as not present */
if(failed) {
  packet->detected_protocol_stack[0] = NDPI_PROTOCOL_UNKNOWN;
}