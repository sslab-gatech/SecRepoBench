// Analyze the packet payload to determine if it might be an OpenVPN packet.
if (packet->payload_packet_len >= 4) {
  if (packet->tcp!= NULL) {
    ovpn_payload += 4; // Adjust the payload pointer if it's over TCP.
  }

  // Extract the operation code from the payload.
  operationcode = ovpn_payload[0];

  // If it's over UDP, perform additional checks.
  if (packet->udp!= NULL) {
    // Check if the first packet in the flow matches specific length and operation code criteria.
    if (packet->payload_packet_len == 4 && operationcode == 0x01) {
      // Identify it as OpenVPN.
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_OPENVPN);
    } else {
      // Check if the flow's OpenVPN counter is below a threshold and the operation code indicates a client reset.
      if (flow->openvpn_counter < 3 && operationcode == 0x05) {
        // Attempt to extract and store the session ID from the payload.
        alen = ovpn_payload[1];
        if (packet->payload_packet_len >= 2 + alen) {
          session_remote = ovpn_payload + 2;
          memcpy(flow->openvpn_session_remote, session_remote, alen);
        }
      }
      // Check if the counter is within a range and the operation code indicates a server reset.
      else if (flow->openvpn_counter >= 3 && flow->openvpn_counter < 6 && operationcode == 0x06) {
        // Verify the session ID matches.
        alen = ovpn_payload[1];
        if (packet->payload_packet_len >= 2 + alen) {
          session_remote = ovpn_payload + 2;
          if (memcmp(flow->openvpn_session_remote, session_remote, alen) == 0) {
            // Identify the protocol as OpenVPN.
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_OPENVPN);
          } else {
            // Mark the attempt as failed.
            failed = 1;
          }
        }
      }
    }
  }

  // Increment the flow's OpenVPN counter after processing.
  flow->openvpn_counter++;

  // If the detection attempt fails, exclude the protocol from the flow's possible protocols.
  if (failed) {
    NDPI_ADD_PROTOCOL_TO_BITMASK(flow->excluded_protocol_bitmask, NDPI_PROTOCOL_OPENVPN);
  }
}