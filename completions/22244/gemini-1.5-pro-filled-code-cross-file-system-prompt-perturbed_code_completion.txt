if (packet->payload_len >= 4) {
    if (packet->tcp != NULL) {
      ovpn_payload += packet->l4_packet_len;
    }

    operationcode = ovpn_payload[0];

    if (packet->udp != NULL) {
      if (flow->ovpn_counter == 0 && packet->payload_len == 53 && operationcode == 1) {
        NDPI_LOG_DBG(ndpi_struct, "found openvpn\n");
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        return;
      } else if (flow->ovpn_counter < 5 && operationcode == 3) {
        session_remote = ovpn_payload + 1;
        alen = session_remote[16];
        hmac_size = session_remote[17 + alen];
        if (hmac_size >= 0 && hmac_size <= 20) {
          memcpy(flow->ovpn_session_remote, session_remote, 18 + alen + hmac_size);
          flow->ovpn_session_remote_len = 18 + alen + hmac_size;
        }
      } else if (flow->ovpn_counter >= 5 && flow->ovpn_counter < 10 && operationcode == 2) {
        session_remote = ovpn_payload + 1;
        alen = session_remote[16];
        hmac_size = session_remote[17 + alen];
        if (hmac_size >= 0 && hmac_size <= 20 && flow->ovpn_session_remote_len == (u_int16_t)(18 + alen + hmac_size) && !memcmp(flow->ovpn_session_remote, session_remote, 18 + alen + hmac_size)) {
          NDPI_LOG_DBG(ndpi_struct, "found openvpn\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        } else {
          failed = 1;
        }
      }
    }
    flow->ovpn_counter++;
  }

  if (failed) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }