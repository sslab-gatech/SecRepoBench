if (packet->payload_len < 1)
    return;

  if (packet->tcp_retransmission)
    return;

  if (packet->ip_proto == IPPROTO_TCP) {
    if (packet->payload_len < 3)
      return;

    ovpn_payload += 2;
  }

  operationcode = ovpn_payload[0];

  if (packet->ip_proto == IPPROTO_UDP) {
    if ((flow->packet.num == 0) && (packet->payload_len == 64) &&
        (operationcode == 0x48)) {
      NDPI_LOG_INFO(ndpi_struct, "OpenVPN detected\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    } else if ((flow->ovpn_count < 5) && (operationcode == 0x41)) {
      /* Client reset */
      if (packet->payload_len > 17) {
        session_remote = &ovpn_payload[13];
        memcpy(flow->ovpn_session_id, session_remote, 4);
      }
    } else if ((flow->ovpn_count >= 5) && (flow->ovpn_count < 10) &&
               (operationcode == 0x52)) {
      /* Server reset */
      if (packet->payload_len > 17) {
        session_remote = &ovpn_payload[13];
        if (memcmp(flow->ovpn_session_id, session_remote, 4) == 0) {
          NDPI_LOG_INFO(ndpi_struct, "OpenVPN detected\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        } else {
          failed = 1;
        }
      }
    }
  }

  flow->ovpn_count++;

  if (failed) {
    NDPI_LOG_INFO(ndpi_struct, "exclude OpenVPN\n");
    ndpi_int_remove_protocol(ndpi_struct, flow);
  }