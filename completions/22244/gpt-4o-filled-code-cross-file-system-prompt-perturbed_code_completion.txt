if(packet->payload_packet_len < 8) return;

  if(packet->tcp != NULL) {
    ovpn_payload += 2;
  }

  operationcode = ovpn_payload[0];

  if(packet->udp != NULL) {
    if(flow->packet_counter == 0) {
      if(packet->payload_packet_len == 14 && operationcode == 0x38) {
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    } else {
      if(flow->openvpn_stage < 3 && operationcode == 0x38) {
        session_remote = &ovpn_payload[6];
        alen = ovpn_payload[5];
        if(alen == 8) {
          memcpy(flow->openvpn_session_id, session_remote, alen);
          flow->openvpn_stage = 1;
        }
      } else if(flow->openvpn_stage == 1 && operationcode == 0x40) {
        session_remote = &ovpn_payload[6];
        alen = ovpn_payload[5];
        if(alen == 8 && memcmp(flow->openvpn_session_id, session_remote, alen) == 0) {
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
          return;
        } else {
          failed = 1;
        }
      }
    }
  }

  flow->openvpn_stage++;

  if(failed) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }