if (packet->payload_length < 1) {
    return;
  }

  if (packet->tcp != NULL) {
    ovpn_payload += 5; // Adjust for TCP header
  }

  operationcode = ovpn_payload[0];
  if (packet->udp != NULL) {
    if (flow->openvpn_counter == 0 && operationcode == 0x01) { // Client Hello
      flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
      flow->openvpn_counter++;
      return;
    } else if (flow->openvpn_counter < 5 && operationcode == 0x02) { // Client Reset
      // Extract session ID logic here
      flow->openvpn_counter++;
      return;
    } else if (flow->openvpn_counter >= 5 && operationcode == 0x03) { // Server Reset
      // Verify session ID logic here
      if (/* session ID matches */) {
        flow->detected_protocol_stack[0] = NDPI_PROTOCOL_OPENVPN;
        return;
      } else {
        failed = 1;
      }
    }
  }

  flow->openvpn_counter++;
  if (failed) {
    flow->detected_protocol_stack[0] = NDPI_PROTOCOL_UNKNOWN;
  }