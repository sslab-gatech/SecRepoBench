if (packet->payload_len >= 16) {
    if (packet->tcp) {
      ovpn_payload += 20;
    }
    operationcode = ovpn_payload[0];
    if (packet->udp) {
      if (flow->openvpn_counter == 0 && packet->payload_len == 16 && operationcode == 0x01) {
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
      } else if (flow->openvpn_counter < 10 && operationcode == 0x02) {
        session_remote = ovpn_payload + 1;
        alen = ovpn_payload[1];
        if (alen > 0 && alen <= 16) {
          memcpy(flow->openvpn_session_id, session_remote, alen);
          flow->openvpn_session_id_len = alen;
        }
      } else if (flow->openvpn_counter >= 10 && flow->openvpn_counter < 20 && operationcode == 0x03) {
        session_remote = ovpn_payload + 1;
        alen = ovpn_payload[1];
        if (alen > 0 && alen <= 16 && alen == flow->openvpn_session_id_len && memcmp(flow->openvpn_session_id, session_remote, alen) == 0) {
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
        } else {
          failed = 1;
        }
      }
    }
    flow->openvpn_counter++;
  } else {
    failed = 1;
  }
  if (failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }
}