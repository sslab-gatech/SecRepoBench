if (packet->payload_packet_len >= 14) {
  if (packet->tcp != NULL)
    ovpn_payload = &packet->payload[1];

  operationcode = ovpn_payload[0] & 0x0F;

  if (packet->udp != NULL) {
    if ((packet->payload_packet_len == 14) && (flow->packet_counter == 1) && (operationcode == 0x07)) {
      NDPI_LOG_INFO(ndpi_struct, "found openvpn\n");
      ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
      return;
    }

    if ((flow->openvpn_counter < 3) && (operationcode == 0x08)) {
      alen = ovpn_payload[1];
      if ((alen > 0) && ((alen * 4) <= (packet->payload_packet_len - 2))) {
        session_remote = &ovpn_payload[2 + (alen * 4)];
        memcpy(flow->openvpn_session_id, session_remote, 8);
      }
    }

    if ((flow->openvpn_counter > 2) && (flow->openvpn_counter < 5) && (operationcode == 0x07)) {
      if (memcmp(flow->openvpn_session_id, &ovpn_payload[2], 8) == 0) {
        NDPI_LOG_INFO(ndpi_struct, "found openvpn\n");
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        return;
      } else {
        failed = 1;
      }
    }
  }

  flow->openvpn_counter++;
}

if (failed) {
  NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
}