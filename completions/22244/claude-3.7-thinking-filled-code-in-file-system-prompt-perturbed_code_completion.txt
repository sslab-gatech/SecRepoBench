if (packet->payload_packet_len < 16) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  /* In case it's TCP, the openvpn packet starts after a 2 byte length field */
  if (packet->tcp) {
    if (packet->payload_packet_len < 14) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    ovpn_payload = packet->payload + 2;
  }

  /* Get the operation code from the first byte */
  operationcode = ovpn_payload[0] & P_OPCODE_MASK;

  /* If it's UDP, perform more specific checks */
  if (packet->udp) {
    /* Check if it's the first packet in the flow */
    if (flow->l4.udp.openvpn_counter == 0) {
      /* Check if the packet length is appropriate for a first packet */
      if (packet->payload_packet_len > 40) {
        /* Check if operation code is a client reset */
        if (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || 
            operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
          NDPI_LOG_INFO(ndpi_struct, "found openvpn\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        }
      }
    } 
    /* Check if we're still within a reasonable number of packets for detection */
    else if (flow->l4.udp.openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
      /* If it's a client reset packet, attempt to extract session ID */
      if (operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || 
          operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
        
        /* Try to determine HMAC size and get packet ID */
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
        
        if (hmac_size != -1) {
          /* Check if array len field is present and valid */
          alen = ovpn_payload[P_PACKET_ID_ARRAY_LEN_OFFSET(hmac_size)];
          
          if (alen == 0) {
            /* Store session ID from client packet */
            memcpy(flow->protos.openvpn.session_id, ovpn_payload + 1, 8);
            flow->protos.openvpn.hmac_size = hmac_size;
          }
        }
      } 
      /* If it's a server reset packet, verify session ID */
      else if ((flow->l4.udp.openvpn_counter > 0) && 
               (flow->l4.udp.openvpn_counter < 3) && 
               (operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || 
                operationcode == P_CONTROL_HARD_RESET_SERVER_V2)) {
        
        /* Get session ID from this packet */
        session_remote = ovpn_payload + 1;
        
        /* Compare with stored session ID */
        if (memcmp(flow->protos.openvpn.session_id, session_remote, 8) == 0) {
          NDPI_LOG_INFO(ndpi_struct, "found openvpn\n");
          ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
        } else {
          failed = 1;
        }
      }
    }
    
    /* Increment the counter for this flow */
    flow->l4.udp.openvpn_counter++;
    
    /* If detection failed, exclude this protocol */
    if (failed) {
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    }
  }