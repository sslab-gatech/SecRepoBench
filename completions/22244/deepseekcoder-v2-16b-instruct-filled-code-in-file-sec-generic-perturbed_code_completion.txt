if(packet->payload_packet_len < 16) {
    failed = 1;
    goto done;
  }

  operationcode = ovpn_payload[0] & P_OPCODE_MASK;

  if(packet->tcp) {
    if(packet->payload_packet_len < 20) {
      failed = 1;
      goto done;
    }

    if(operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 ||
       operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
      if(flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
        session_remote = ovpn_payload + 12;
        ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN, NULL);
        flow->openvpn_counter++;
        goto done;
      }
    } else if(operationcode == P_CONTROL_HARD_RESET_SERVER_V1 ||
              operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
      if(flow->openvpn_counter > 0) {
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
        if(hmac_size > 0) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
          if(memcmp(session_remote, flow->session_id, hmac_size) == 0) {
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN, NULL);
            flow->openvpn_counter++;
            goto done;
          }
        }
      }
    }
  } else {
    if(operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 ||
       operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
      if(flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
        session_remote = ovpn_payload + 12;
        memcpy(flow->session_id, session_remote, P_SHA1_HMAC_SIZE);
        flow->openvpn_counter++;
        goto done;
      }
    } else if(operationcode == P_CONTROL_HARD_RESET_SERVER_V1 ||
              operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
      if(flow->openvpn_counter > 0) {
        hmac_size = check_pkid_and_detect_hmac_size(ovpn_payload);
        if(hmac_size > 0) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(hmac_size);
          if(memcmp(session_remote, flow->session_id, hmac_size) == 0) {
            ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN, NULL);
            flow->openvpn_counter++;
            goto done;
          }
        }
      }
    }
  }

  failed = 1;

done:
  if(failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }