if(packet->udp != NULL) {
    if(packet->payload_packet_len >= 20) {
      operationcode = ovpn_payload[0] & P_OPCODE_MASK;
      if(operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
        if(flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(P_HMAC_160);
          if(session_remote[0] == 0 && session_remote[1] == 0 && session_remote[2] == 0 && session_remote[3] == 0) {
            flow->session_id = get_packet_id(ovpn_payload, P_HMAC_160);
            flow->openvpn_counter++;
            return;
          }
        }
        failed = 1;
      } else if(operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
        if(flow->openvpn_counter > 0) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(P_HMAC_160);
          if(session_remote[0] == 0 && session_remote[1] == 0 && session_remote[2] == 0 && session_remote[3] == 0) {
            if(flow->session_id == get_packet_id(ovpn_payload, P_HMAC_160)) {
              ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
              return;
            }
          }
        }
        failed = 1;
      }
    }
  } else if(packet->tcp != NULL) {
    if(packet->payload_packet_len >= 20) {
      operationcode = ovpn_payload[0] & P_OPCODE_MASK;
      if(operationcode == P_CONTROL_HARD_RESET_CLIENT_V1 || operationcode == P_CONTROL_HARD_RESET_CLIENT_V2) {
        if(flow->openvpn_counter < P_HARD_RESET_CLIENT_MAX_COUNT) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(P_HMAC_160);
          if(session_remote[0] == 0 && session_remote[1] == 0 && session_remote[2] == 0 && session_remote[3] == 0) {
            flow->session_id = get_packet_id(ovpn_payload, P_HMAC_160);
            flow->openvpn_counter++;
            return;
          }
        }
        failed = 1;
      } else if(operationcode == P_CONTROL_HARD_RESET_SERVER_V1 || operationcode == P_CONTROL_HARD_RESET_SERVER_V2) {
        if(flow->openvpn_counter > 0) {
          session_remote = ovpn_payload + P_HARD_RESET_PACKET_ID_OFFSET(P_HMAC_160);
          if(session_remote[0] == 0 && session_remote[1] == 0 && session_remote[2] == 0 && session_remote[3] == 0) {
            if(flow->session_id == get_packet_id(ovpn_payload, P_HMAC_160)) {
              ndpi_set_detected_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN, NDPI_PROTOCOL_UNKNOWN);
              return;
            }
          }
        }
        failed = 1;
      }
    }
  }

  if(failed) {
    ndpi_exclude_protocol(ndpi_struct, flow, NDPI_PROTOCOL_OPENVPN);
  }