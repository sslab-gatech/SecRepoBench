#define SIMH_TAPEMARKS 3

static unsigned int
getlen(const unsigned char *uc)
{
	// SIMH uses 4-byte little-endian length fields
	return (unsigned int)uc[0] | ((unsigned int)uc[1] << 8) |
	       ((unsigned int)uc[2] << 16) | ((unsigned int)uc[3] << 24);
}

	const unsigned char *p = uc;
	int tapemarks = 0, records = 0;

	while (p + 4 <= end_pointer) {
		unsigned int len = getlen(p);

		// End of Medium marker
		if (len == 0xFFFFFFFF)
			break;

		p += 4;
		if (p > end_pointer)
			return 0;

		// Tapemark (zero-length record)
		if (len == 0) {
			tapemarks++;
			if (tapemarks >= SIMH_TAPEMARKS)
				break;
			continue;
		}

		// Check if record fits
		if (p + len + 4 > end_pointer)
			return 0;

		// Check trailing length matches
		if (getlen(p + len) != len)
			return 0;

		p += len + 4;
		records++;
	}

	// Must have at least one record and at least one tapemark
	return (records > 0 && tapemarks > 0) ? 1 : 0;