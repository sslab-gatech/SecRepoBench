const unsigned char *p = uc;
int records = 0, tapemarks = 0;
uint32_t len, clen;

#ifndef SIMH_TAPEMARKS
#define SIMH_TAPEMARKS 3
#endif

if (!uc || !end_pointer || uc >= end_pointer)
    return 0;

while (p + 4 <= end_pointer) {
    // Extract a 32-bit length from the buffer
    len = ((uint32_t)p[0] << 24) | 
          ((uint32_t)p[1] << 16) | 
          ((uint32_t)p[2] << 8) | 
          (uint32_t)p[3];
    p += 4;
    
    // Check for EOM marker
    if (len == 0xFFFFFFFF)
        break;
    
    // Check for tapemark
    if (len == 0) {
        tapemarks++;
        if (tapemarks >= SIMH_TAPEMARKS)
            break;
        continue;
    }

    // Ensure we can read the entire record plus trailing length
    if (p + len + 4 > end_pointer)
        return 0;

    // Skip over the record data
    p += len;
    
    // Read the complementary length
    clen = ((uint32_t)p[0] << 24) | 
           ((uint32_t)p[1] << 16) | 
           ((uint32_t)p[2] << 8) | 
           (uint32_t)p[3];
    p += 4;
    
    // Validate that the complementary length matches
    if (len != clen)
        return 0;
    
    records++;
}

// Valid SIMH data if we found at least one record or tapemark
return (records > 0 || tapemarks > 0) ? 1 : 0;