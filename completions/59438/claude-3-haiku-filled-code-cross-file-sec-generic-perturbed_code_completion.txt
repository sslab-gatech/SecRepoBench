int getlen(const unsigned char *uc, const unsigned char *end_pointer) {
    int len = 0;
    while (uc < end_pointer && *uc != 0) {
        len = (len << 8) | *uc++;
    }
    if (uc < end_pointer && *uc == 0) {
        uc++;
    }
    return len;
}

static int
simh_parse(const unsigned char *uc, const unsigned char *end_pointer)
{
    int records = 0;
    int tapemarks = 0;
    while (uc < end_pointer) {
        int len = getlen(uc, end_pointer);
        if (len == 0xFFFFFFFF) {
            // End of Medium (EOM) marker
            return 1;
        }
        uc += 4;
        int comp_len = getlen(uc, end_pointer);
        uc += 4;
        if (len != comp_len) {
            // Length mismatch, invalid data
            return 0;
        }
        if (len == 0) {
            // Tapemark
            tapemarks++;
            if (tapemarks >= SIMH_TAPEMARKS) {
                // Reached the tapemark limit, stop processing
                return 1;
            }
        } else {
            // Data record
            records++;
        }
        uc += len;
    }
    return 0;
}