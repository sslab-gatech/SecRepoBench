#define SIMH_TAPEMARKS 2

static int
getlen(const unsigned char **ucp, const unsigned char *ue)
{
    const unsigned char *uc = *ucp;
    unsigned int len;

    if (uc + 4 > ue)
        return -1;

    len = (uc[0] << 24) | (uc[1] << 16) | (uc[2] << 8) | uc[3];
    *ucp = uc + 4;
    return len;
}

static int
simh_parse(const unsigned char *uc, const unsigned char *end_pointer)
{
    int tapemarks = 0;
    while (uc < end_pointer) {
        int len = getlen(&uc, end_pointer);
        if (len == -1)
            return 0;

        if (len == 0xFFFFFFFF) {
            // End of Medium marker
            return 1;
        }

        if (len == 0) {
            // Tapemark
            tapemarks++;
            if (tapemarks >= SIMH_TAPEMARKS)
                return 1;
            continue;
        }

        if (uc + len > end_pointer)
            return 0;

        uc += len;

        int complen = getlen(&uc, end_pointer);
        if (complen == -1 || complen != len)
            return 0;
    }
    return 0;
}