int records = 0, tapemarks = 0;

while (uc < end_pointer) {
    uint32_t len = getlen(&uc);
    if (len == 0xffffffff) {
        DPRINTF("EOM at %td\n", uc - (const unsigned char *)b->fbuf);
        return 1;  // End of Medium reached
    }
    
    if (uc + len + sizeof(uint32_t) > end_pointer) {
        DPRINTF("Incomplete record at %td\n", uc - (const unsigned char *)b->fbuf);
        return 0;  // Incomplete record
    }
    
    if (len == 0) {
        tapemarks++;
        DPRINTF("Tapemark %d at %td\n", tapemarks, uc - (const unsigned char *)b->fbuf);
        if (SIMH_TAPEMARKS && tapemarks >= SIMH_TAPEMARKS)
            return 1;  // Reached tapemark limit
    } else {
        records++;
        DPRINTF("Record %d len %u at %td\n", records, len, uc - (const unsigned char *)b->fbuf);
        uc += len;
    }
    
    uint32_t complement_len = getlen(&uc);
    if (complement_len != len) {
        DPRINTF("Length mismatch %u != %u at %td\n", len, complement_len, uc - (const unsigned char *)b->fbuf);
        return 0;  // Length mismatch
    }
}

return 1;  // Valid SIMH data