#define SIMH_TAPEMARKS 2

static int
getlen(const unsigned char **ucp, const unsigned char *ue, uint32_t *len)
{
    if (ue - *ucp < 4)
        return 0;
    *len = (*ucp)[0] | ((*ucp)[1] << 8) | ((*ucp)[2] << 16) | ((*ucp)[3] << 24);
    *ucp += 4;
    return 1;
}

static int
simh_parse(const unsigned char *uc, const unsigned char *end_pointer)
{
    uint32_t len, comp_len;
    int tapemarks = 0;

    while (uc < end_pointer) {
        if (!getlen(&uc, end_pointer, &len))
            return 0;

        if (len == 0xFFFFFFFF) {
            tapemarks++;
            if (tapemarks >= SIMH_TAPEMARKS)
                return 1;
            continue;
        }

        if (uc + len > end_pointer)
            return 0;

        uc += len;

        if (!getlen(&uc, end_pointer, &comp_len))
            return 0;

        if (len != comp_len)
            return 0;
    }

    return 0;
}