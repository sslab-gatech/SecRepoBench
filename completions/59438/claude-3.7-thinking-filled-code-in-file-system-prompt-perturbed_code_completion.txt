uint32_t len, len2;
int tapemarks = 0;
int records = 0;

// Initialize byte-order detection
simh_bo.s[0] = 1;
simh_bo.s[1] = 2;
simh_bo.s[2] = 3;
simh_bo.s[3] = 4;

while (uc + 4 <= end_pointer) {
    len = getlen(&uc);
    
    // Check for End of Medium
    if (len == 0xffffffff) {
        DPRINTF("End of Medium after %d records, %d tapemarks\n", 
               records, tapemarks);
        return 1;  // Valid SIMH file
    }

    // Check for tapemark (length 0)
    if (len == 0) {
        tapemarks++;
        DPRINTF("Got tapemark %d\n", tapemarks);
        
        // If we've seen enough tapemarks, stop processing
        if (SIMH_TAPEMARKS && tapemarks >= SIMH_TAPEMARKS)
            return 1;
            
        continue;
    }

    // Regular data record
    records++;
    DPRINTF("Got record %d, len=%u\n", records, len);
    
    // Skip over the data
    if (uc + len > end_pointer)
        return 0;  // Not enough data
    uc += len;
    
    // Check for the complementary length
    if (uc + 4 > end_pointer)
        return 0;  // Not enough data for complementary length
        
    len2 = getlen(&uc);
    
    // Verify complementary length
    if (len != len2) {
        DPRINTF("Record length mismatch %u != %u\n", len, len2);
        return 0;  // Invalid data
    }
}

// If we get here, we didn't find an EOM marker
return 0;