static int
simh_parse(const unsigned char *uc, const unsigned char *end_pointer)
{
	int tapemarks = 0;
	size_t len, comp_len;
	const unsigned char *ptr = uc;

	while (ptr < end_pointer) {
		if (end_pointer - ptr < sizeof(uint32_t)) {
			// Not enough data for a valid length field; invalid.
			return 0;
		}

		len = getlen(ptr);
		ptr += sizeof(uint32_t);

		if (len == 0xFFFFFFFF) {
			// End Of Medium (EOM) marker found.
			break;
		}

		if ((size_t)(end_pointer - ptr) < len) {
			// Not enough data for the claimed record length; invalid.
			return 0;
		}

		comp_len = getlen(ptr + len);

		if (len != comp_len) {
			// Complementary length mismatch; invalid.
			return 0;
		}

		ptr += len + sizeof(uint32_t);

		if (len == 0x00000000) {
			// Tapemark detected.
			tapemarks++;
			if (tapemarks > SIMH_TAPEMARKS) {
				// Exceeded predefined tapemark limit; stop processing.
				break;
			}
		}
	}

	return (ptr <= end_pointer && tapemarks <= SIMH_TAPEMARKS) ? 1 : 0;
}