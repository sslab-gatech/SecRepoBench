#define SIMH_TAPEMARKS 3
#define SIMH_EOM 0xFFFFFFFF

static uint32_t
getlen(const unsigned char *p)
{
    return (p[0] << 24) | (p[1] << 16) | (p[2] << 8) | p[3];
}

/* Check for null pointers or insufficient data */
if (!uc || !end_pointer || uc >= end_pointer)
    return 0;

int records = 0;
int tapemarks = 0;
const unsigned char *p = uc;

while (p + 4 <= end_pointer) {
    uint32_t len = getlen(p);
    p += 4;
    
    /* Check for EOM */
    if (len == SIMH_EOM)
        return 1;
    
    /* Check for tapemark */
    if (len == 0) {
        tapemarks++;
        if (tapemarks >= SIMH_TAPEMARKS)
            return 1;
        continue;
    }
    
    /* Ensure we have enough bytes for data + trailing length */
    if (p + len + 4 > end_pointer)
        return 0;
    
    /* Skip data */
    p += len;
    
    /* Check complementary length */
    uint32_t comp_len = getlen(p);
    p += 4;
    
    if (len != comp_len)
        return 0;
    
    records++;
}

return (records > 0 || tapemarks > 0) ? 1 : 0;