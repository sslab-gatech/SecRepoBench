static int
simh_parse(const unsigned char *uc, const unsigned char *end_pointer)
{
	size_t record_count = 0;
	size_t tapemark_count = 0;
	const unsigned char *ptr = uc;
	const unsigned char *eom = end_pointer - 4;  // For EOM marker check

	while (ptr < end_pointer) {
		size_t len = getlen(ptr, end_pointer);
		if (len == 0)
			return 0;  // Invalid length

		ptr += 2;  // Skip length bytes

		// Check for tapemark (all zeros)
		if (len == 0) {
			tapemark_count++;
			if (tapemark_count >= SIMH_TAPEMARKS)
				break;
		} else {
			record_count++;
			// Verify data record length matches complementary length
			if (ptr + len + 2 > end_pointer)  // +2 for checksum
				return 0;
			ptr += len + 2;  // Skip data and checksum
		}
	}

	// Check for EOM marker at end of file
	if (ptr <= eom && memcmp(ptr, "\xff\xff\xff\xff", 4) == 0)
		return 1;

	return 0;
}