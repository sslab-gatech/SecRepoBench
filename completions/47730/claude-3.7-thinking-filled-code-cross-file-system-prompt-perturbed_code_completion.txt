comma_or_nul = strchr(alpn_start, ',');
if(comma_or_nul == NULL) {
  comma_or_nul = alpn_start + strlen(alpn_start);
}

// Check if there's valid ALPN data between alpn_start and comma_or_nul
if(comma_or_nul > alpn_start) {
  // Extract the current ALPN identifier
  size_t alpn_len = comma_or_nul - alpn_start;
  char alpn[256]; // Buffer for the ALPN string
  
  if(alpn_len < sizeof(alpn)) {
    memcpy(alpn, alpn_start, alpn_len);
    alpn[alpn_len] = '\0';
    
    // Check if the ALPN is not common
    int is_uncommon = 1; // Default: ALPN is uncommon
    
    // List of common ALPNs
    const char* common_alpns[] = {
      "h2", "http/1.1", "h3", "spdy/3", "stun.turn", "webrtc", "c-webrtc",
      "ftp", "imap", "pop3", "smtp", NULL
    };
    
    for(int i = 0; common_alpns[i] != NULL; i++) {
      if(strcmp(alpn, common_alpns[i]) == 0) {
        is_uncommon = 0; // It's a common ALPN
        break;
      }
    }
    
    if(is_uncommon) {
      char risk_str[300];
      
      snprintf(risk_str, sizeof(risk_str), "Uncommon ALPN: %s", alpn);
      NDPI_LOG_DBG(ndpi_struct, "Found uncommon ALPN: %s", alpn);
      
      ndpi_set_risk(ndpi_struct, connectionflow, NDPI_UNCOMMON_ALPN, risk_str);
    }
  }
}