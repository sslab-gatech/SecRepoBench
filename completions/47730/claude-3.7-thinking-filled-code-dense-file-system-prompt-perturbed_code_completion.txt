// Find the end of the current ALPN (next comma or end of string)
comma_or_nul = strchr(alpn_start, ',');
if (comma_or_nul == NULL)
  comma_or_nul = alpn_start + strlen(alpn_start);

// If we have a non-empty ALPN
if (comma_or_nul > alpn_start) {
  size_t alpn_len = comma_or_nul - alpn_start;
  
  if (alpn_len < 256) { // Reasonable max length for an ALPN
    char alpn[256]; // Temporary buffer for the ALPN
    AC_PATTERN_t ac_pattern;
    
    // Copy the ALPN to our temporary buffer
    strncpy(alpn, alpn_start, alpn_len);
    alpn[alpn_len] = '\0';
    
    memset(&ac_pattern, 0, sizeof(ac_pattern));
    ac_pattern.astring = alpn;
    ac_pattern.length = alpn_len;
    
    // Check if the ALPN is not common
    if (ac_automata_match(ndpi_struct->common_alpns_automa.ac_automa, &ac_pattern) == 0) {
      // This is an uncommon ALPN
      char buf[256];
      
      snprintf(buf, sizeof(buf), "Uncommon ALPN: %s", alpn);
      
      #ifdef DEBUG_TLS
      printf("[TLS] %s\n", buf);
      #endif
      
      // Set risk
      ndpi_set_risk(ndpi_struct, connectionflow, NDPI_TLS_UNCOMMON_ALPN, buf);
    }
  }
}