if (NULL == (ref_list = xmlHashLookup(table, value))) {
    int res;

    if (NULL == (ref_list = xmlListCreate(xmlFreeRef, xmlDummyCompare))) {
        xmlVErrMemory(ctxt);
        goto failed;
    }
    res = xmlHashAdd(table, value, ref_list);
    if (res <= 0) {
        xmlListDelete(ref_list);
        goto failed;
    }
} else {
    xmlIDPtr id = xmlHashLookup(table, value);
    if (id!= NULL) {
        if (id->attr!= NULL) {
            id->attr->id = NULL;
        }
        xmlHashRemoveEntry(table, value, xmlFreeIDTableEntry);
        xmlFreeID(id);
    }
    if (xmlHashAdd(table, value, ref_list) <= 0) {
        xmlListDelete(ref_list);
        goto failed;
    }
}