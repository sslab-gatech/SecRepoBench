// Initialize variables for processing and flags for hostname and FQDN detection.
int hostname_detected = 0, fqdn_detected = 0;
char hostname[NDPI_FLOW_HOSTNAME_LEN] = {0};
char fqdn[NDPI_FLOW_HOSTNAME_LEN] = {0};

// Check if the payload length is sufficient and retrieve the tuple count from the payload.
if (payload_len < 4)
    return 1;
tuple_count = ntohl(get_u_int32_t(payload, 0));
payload += 4;
payload_len -= 4;

// Validate the tuple count and adjust the payload and its length accordingly.
if (tuple_count > (payload_len / 8))
    return 1;

// Extract the first value from the payload to determine if it contains a "host_name" identifier.
struct softether_value first_value, second_value;
size_t value_size = dissect_softether_tuples(payload, payload_len, &first_value, &second_value);
if (value_size == 0)
    return 1;

// Iterate over each tuple in the payload, extracting values and checking their types and identifiers.
while (tuple_count > 0) {
    if (first_value.type == VALUE_STR && second_value.type == VALUE_STR) {
        if (strcmp(first_value.value.ptr.value_str, "host_name") == 0) {
            strncpy(hostname, second_value.value.ptr.value_str, sizeof(hostname) - 1);
            hostname_detected = 1;
        } else if (strcmp(first_value.value.ptr.value_str, "ddns_fqdn") == 0) {
            strncpy(fqdn, second_value.value.ptr.value_str, sizeof(fqdn) - 1);
            fqdn_detected = 1;
        }
    }

    payload += value_size;
    payload_len -= value_size;
    tuple_count--;

    value_size = dissect_softether_tuples(payload, payload_len, &first_value, &second_value);
    if (value_size == 0)
        return 1;
}

// If any unprocessed data remains or tuple count is not exhausted, return an error code.
if (payload_len > 0 || tuple_count > 0)
    return 1;

// If a "host_name" is detected, prepare to store its value in the flow structure's hostname field.
if (hostname_detected) {
    strncpy(ndpiflow->protos.softether.hostname, hostname, sizeof(ndpiflow->protos.softether.hostname) - 1);
}

// If a "ddns_fqdn" identifier is detected, prepare to store its value in the flow structure's fqdn field.
if (fqdn_detected) {
    strncpy(ndpiflow->protos.softether.fqdn, fqdn, sizeof(ndpiflow->protos.softether.fqdn) - 1);
}

return 0;