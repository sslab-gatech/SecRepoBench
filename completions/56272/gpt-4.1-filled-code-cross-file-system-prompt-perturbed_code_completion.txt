if(payload_len < 8)
    return -1;

tuple_count = ntohl(*(u_int32_t *)payload);
if(tuple_count == 0 || tuple_count > 16)
    return -1;

payload += 4;
payload_len -= 4;

u_int32_t i;
int found_hostname = 0, found_fqdn = 0;

for(i = 0; i < tuple_count && payload_len >= 8; i++) {
    u_int32_t type = ntohl(*(u_int32_t *)payload);
    u_int32_t id   = ntohl(*(u_int32_t *)(payload + 4));
    payload += 8;
    payload_len -= 8;

    if(payload_len < 4)
        return -1;

    u_int32_t value_len = ntohl(*(u_int32_t *)payload);
    payload += 4;
    payload_len -= 4;

    if(payload_len < value_len)
        return -1;

    if(type == 3 && id == 0) { // host_name
        if(value_len < sizeof(ndpiflow->protos.softether.hostname)) {
            memcpy(ndpiflow->protos.softether.hostname, payload, value_len);
            ndpiflow->protos.softether.hostname[value_len] = '\0';
            found_hostname = 1;
        }
    } else if(type == 3 && id == 1) { // ddns_fqdn
        if(value_len < sizeof(ndpiflow->protos.softether.fqdn)) {
            memcpy(ndpiflow->protos.softether.fqdn, payload, value_len);
            ndpiflow->protos.softether.fqdn[value_len] = '\0';
            found_fqdn = 1;
        }
    }

    payload += value_len;
    payload_len -= value_len;
}

if(i != tuple_count)
    return -1;

return (found_hostname && found_fqdn) ? 0 : -1;