// Initialize variables for processing and flags for hostname and FQDN detection.
u_int8_t *payload_ptr = (u_int8_t *)payload;
u_int16_t remaining_len = payload_len;
u_int32_t tuple_count = ntohl(get_u_int32_t(payload, 0));
u_int8_t host_name_detected = 0;
u_int8_t ddns_fqdn_detected = 0;
struct softether_value first_value;
struct softether_value second_value;

// Check if the payload length is sufficient and retrieve the tuple count from the payload.
if (payload_len < 4) {
  return 1;
}

payload_ptr += 4;
remaining_len -= 4;

// Validate the tuple count and adjust the payload and its length accordingly.
if (tuple_count > remaining_len / 12) {
  return 1;
}

// Extract the first value from the payload to determine if it contains a "host_name" identifier.
while (tuple_count > 0) {
  size_t value_size = dissect_softether_tuples(payload_ptr, remaining_len, &first_value, &second_value);
  if (value_size == 0) {
    return 1;
  }

  // If a "host_name" is detected, prepare to store its value in the flow structure's hostname field.
  if (first_value.type == SOFTETHER_VALUE_TYPE_STRING && 
      strncmp((char const *)first_value.value.string_val, "host_name", 9) == 0) {
    host_name_detected = 1;
    ndpi_hostname_sni_set(ndpiflow, (u_int8_t const *)second_value.value.string_val, second_value.value.string_len);
  }

  // If a "ddns_fqdn" identifier is detected, prepare to store its value in the flow structure's fqdn field.
  if (first_value.type == SOFTETHER_VALUE_TYPE_STRING && 
      strncmp((char const *)first_value.value.string_val, "ddns_fqdn", 9) == 0) {
    ddns_fqdn_detected = 1;
    ndpi_fqdn_sni_set(ndpiflow, (u_int8_t const *)second_value.value.string_val, second_value.value.string_len);
  }

  payload_ptr += value_size;
  remaining_len -= value_size;
  tuple_count--;
}

// If any unprocessed data remains or tuple count is not exhausted, return an error code.
if (remaining_len > 0 || tuple_count > 0) {
  return 1;
}

// If both hostname and FQDN are detected, return success.
if (host_name_detected && ddns_fqdn_detected) {
  return 0;
}

return 1;