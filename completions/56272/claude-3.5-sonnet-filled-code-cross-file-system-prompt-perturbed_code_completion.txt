if (payload_len < 4) {
  return -1;
}

tuple_count = ntohl(*((u_int32_t *)payload));
payload += 4;
payload_len -= 4;

if (tuple_count == 0 || tuple_count > payload_len / 4) {
  return -1;
}

u_int32_t value;
u_int8_t host_name_found = 0, ddns_fqdn_found = 0;

for (u_int32_t i = 0; i < tuple_count; i++) {
  if (payload_len < 4) {
    return -1;
  }

  value = ntohl(*((u_int32_t *)payload));
  payload += 4;
  payload_len -= 4;

  if ((value & 0xFF000000) == 0x01000000) {
    if (value == 0x01000001) {
      host_name_found = 1;
    } else if (value == 0x01000002) {
      ddns_fqdn_found = 1;
    }

    if (payload_len < 4) {
      return -1;
    }

    u_int32_t str_len = ntohl(*((u_int32_t *)payload));
    payload += 4;
    payload_len -= 4;

    if (str_len > payload_len) {
      return -1;
    }

    if (host_name_found) {
      if (str_len < sizeof(ndpiflow->protos.softether.hostname)) {
        memcpy(ndpiflow->protos.softether.hostname, payload, str_len);
        ndpiflow->protos.softether.hostname[str_len] = '\0';
      }
      host_name_found = 0;
    } else if (ddns_fqdn_found) {
      if (str_len < sizeof(ndpiflow->protos.softether.fqdn)) {
        memcpy(ndpiflow->protos.softether.fqdn, payload, str_len);
        ndpiflow->protos.softether.fqdn[str_len] = '\0';
      }
      ddns_fqdn_found = 0;
    }

    payload += str_len;
    payload_len -= str_len;
  }
}

if (payload_len > 0 || i < tuple_count) {
  return -1;
}