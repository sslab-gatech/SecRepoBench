// <MASK>
  /* Ensure we have enough data to read the tuple count */
  if(payload_len < 4) {
    return -1;
  }

  /* Read the tuple count (assuming big-endian) */
  tuple_count = ((u_int32_t)payload[0] << 24) | ((u_int32_t)payload[1] << 16) |
                ((u_int32_t)payload[2] << 8)  |  (u_int32_t)payload[3];
  payload += 4;
  payload_len -= 4;

  /* Basic sanity check on tuple_count */
  if(tuple_count == 0) {
    return -1;
  }

  for(u_int32_t i = 0; i < tuple_count; i++) {
    /* Each tuple might start with some kind of identifier or tag (2 bytes) */
    if(payload_len < 2) {
      return -1;
    }
    u_int16_t field_tag = ((u_int16_t)payload[0] << 8) | (u_int16_t)payload[1];
    payload += 2;
    payload_len -= 2;

    /* Next 2 bytes could be the size of this field */
    if(payload_len < 2) {
      return -1;
    }
    u_int16_t field_len = ((u_int16_t)payload[0] << 8) | (u_int16_t)payload[1];
    payload += 2;
    payload_len -= 2;

    /* Check if we have enough data for this field */
    if(payload_len < field_len) {
      return -1;
    }

    /* Copy the field data safely */
    {
      char temp_buf[256];
      u_int16_t copy_len = (field_len < (sizeof(temp_buf) - 1)) ? field_len : (sizeof(temp_buf) - 1);
      memcpy(temp_buf, payload, copy_len);
      temp_buf[copy_len] = '\0';

      /* Based on the field_tag, store into hostname or fqdn */
      if(field_tag == 0x1001) { /* hypothetical tag for "host_name" */
        strncpy(ndpiflow->protos.softether.hostname, temp_buf,
                sizeof(ndpiflow->protos.softether.hostname) - 1);
        ndpiflow->protos.softether.hostname[sizeof(ndpiflow->protos.softether.hostname) - 1] = '\0';
      } else if(field_tag == 0x1002) { /* hypothetical tag for "ddns_fqdn" */
        strncpy(ndpiflow->protos.softether.fqdn, temp_buf,
                sizeof(ndpiflow->protos.softether.fqdn) - 1);
        ndpiflow->protos.softether.fqdn[sizeof(ndpiflow->protos.softether.fqdn) - 1] = '\0';
      }
    }

    /* Advance payload pointer */
    payload += field_len;
    payload_len -= field_len;
  }

  /* If there's leftover data or didn't process all tuples, return error */
  if(payload_len != 0) {
    return -1;
  }
// <MASK>