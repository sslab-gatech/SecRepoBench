if (payload_len < 4 || (tuple_count = ntohl(*((u_int32_t *)payload))) == 0) {
    return -1;
}

payload += 4;
payload_len -= 4;

u_int8_t host_name_found = 0, ddns_fqdn_found = 0;

for (u_int32_t i = 0; i < tuple_count; i++) {
    if (payload_len < 4) {
        return -1;
    }

    u_int32_t value_type = ntohl(*((u_int32_t *)payload));
    payload += 4;
    payload_len -= 4;

    if (payload_len < 4) {
        return -1;
    }

    u_int32_t value_len = ntohl(*((u_int32_t *)payload));
    payload += 4;
    payload_len -= 4;

    if (payload_len < value_len) {
        return -1;
    }

    if (value_type == 0x01 && value_len == 9 && memcmp(payload, "host_name", 9) == 0) {
        host_name_found = 1;
    } else if (value_type == 0x01 && value_len == 9 && memcmp(payload, "ddns_fqdn", 9) == 0) {
        ddns_fqdn_found = 1;
    } else if (host_name_found && value_type == 0x02) {
        if (value_len < sizeof(ndpiflow->protos.softether.hostname)) {
            memcpy(ndpiflow->protos.softether.hostname, payload, value_len);
            ndpiflow->protos.softether.hostname[value_len] = '\0';
            host_name_found = 0;
        }
    } else if (ddns_fqdn_found && value_type == 0x02) {
        if (value_len < sizeof(ndpiflow->protos.softether.fqdn)) {
            memcpy(ndpiflow->protos.softether.fqdn, payload, value_len);
            ndpiflow->protos.softether.fqdn[value_len] = '\0';
            ddns_fqdn_found = 0;
        }
    }

    payload += value_len;
    payload_len -= value_len;
}

if (payload_len > 0 || tuple_count > 0) {
    return -1;
}