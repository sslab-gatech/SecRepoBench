size_t i;
for (i = 0; i < 128 && i < *length; ++i) {
    suffix[i] = curin[i];
    if (curin[i] == 0) {
        ++i;  // include the null terminator in the count
        break;
    }
}

// If we didn't find a null terminator, add one to our buffer
if (i == 128 || i == *length) {
    suffix[i < 128 ? i : 128] = 0;
    
    // Continue parsing from the next byte, looking for a null terminator
    while (i < *length && curin[i] != 0) {
        ++i;
    }
    
    // If we found a null terminator, consume it
    if (i < *length) {
        ++i;
    }
}

len = i;  // This is the number of bytes consumed from the input data

// Allocate memory for the string, including null terminator
mem = (char*) alloc_fn(strlen(suffix) + 1);
if (!mem) return EXR_ERR_OUT_OF_MEMORY;

// Copy the string to the allocated memory
strcpy(mem, suffix);

// Store the pointer in the output structure
out->_suffix = mem;

// Mark the string as dynamically allocated
out->_allocated = 1;