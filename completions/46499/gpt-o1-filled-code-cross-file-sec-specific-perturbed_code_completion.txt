{
  /* Validate the presence of 4 numeric sequences, each followed by a space */
  while(numbers_left > 0 && i < payload_len) {
    if(!isdigit(packet_payload[i])) {
      return;
    }
    while(i < payload_len && isdigit(packet_payload[i])) {
      i++;
    }
    if(i >= payload_len || packet_payload[i] != ' ') {
      return;
    }
    i++; /* Skip the space */
    numbers_left--;
  }

  /* If we didn't consume all required numeric sequences, abort */
  if(numbers_left != 0) {
    return;
  }

  /* Continue scanning until a newline, ensuring only alphanumeric or space chars */
  while(i < payload_len && packet_payload[i] != '\n') {
    if(!isalnum(packet_payload[i]) && packet_payload[i] != ' ') {
      return;
    }
    i++;
  }

  /* If we never found a newline or we reached payload end, abort */
  if(i >= payload_len || packet_payload[i] != '\n') {
    return;
  }

  /* The format is correct, update the state */
  connection_flow->tinc_state++;

  /* If the state crosses the threshold, record the flow in the cache and log detection */
  if(connection_flow->tinc_state > 3) {
    if(ndpi_struct->tinc_cache) {
      cache_add(ndpi_struct->tinc_cache, &connection_flow->tinc_cache_entry, sizeof(connection_flow->tinc_cache_entry));
    }
    NDPI_LOG_INFO(ndpi_struct, "found tinc tcp connection\n");
    ndpi_set_detected_protocol(ndpi_struct, connection_flow, NDPI_PROTOCOL_TINC, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
  }
  return;
}