{
  /* We expect "1 " followed by four numeric sequences, each ending with a space,
   * then a series of alphanumeric or allowed punctuation characters (if any),
   * and finally a newline character.
   */
  u_int16_t index = i;
  while(numbers_left > 0 && index < payload_len) {
    /* Ensure the current sequence starts with a digit */
    if(!isdigit(packet_payload[index])) {
      return;
    }
    /* Consume all digits in the sequence */
    while(index < payload_len && isdigit(packet_payload[index])) {
      index++;
    }
    /* Check bounds and expect a space after the sequence */
    if(index >= payload_len || packet_payload[index] != ' ') {
      return;
    }
    index++;
    numbers_left--;
  }

  /* If we did not find all four numeric sequences, stop */
  if(numbers_left != 0) {
    return;
  }

  /* Consume remaining characters until newline, allowing alphanumeric and select punctuation */
  while(index < payload_len && packet_payload[index] != '\n') {
    if(!isalnum(packet_payload[index]) &&
       packet_payload[index] != ' '  &&
       packet_payload[index] != '.'  &&
       packet_payload[index] != '-'  &&
       packet_payload[index] != '_') {
      return;
    }
    index++;
  }

  /* Check if a newline is present */
  if(index == payload_len || packet_payload[index] != '\n') {
    return;
  }

  /* The format is correct, increment state */
  connection_flow->tinc_state++;
  if(connection_flow->tinc_state > 3) {
    /* If the tinc cache is not initialized, create it */
    if(ndpi_struct->tinc_cache == NULL) {
      ndpi_struct->tinc_cache = cache_alloc("tinc", 1024, sizeof(struct tinc_cache_entry));
    }
    /* Add a cache entry for the connection */
    cache_add(ndpi_struct->tinc_cache, &connection_flow->tinc_cache_entry,
              sizeof(connection_flow->tinc_cache_entry), time(NULL));

    NDPI_LOG_INFO(ndpi_struct, "found tinc tcp connection\n");
    ndpi_set_detected_protocol(ndpi_struct, connection_flow,
                               NDPI_PROTOCOL_TINC, NDPI_PROTOCOL_UNKNOWN,
                               NDPI_CONFIDENCE_DPI_CACHE);
  }
  return;
}