offset += session_id_len + 1;
    ja3.num_cipher = (packet->payload[offset+1] << 8) + packet->payload[offset];
    offset += 2;

    if(ja3.num_cipher > MAX_NUM_JA3) {
      jainvalid = 1;
    } else {
      for(j=0; j<ja3.num_cipher; j++) {
	ja3.cipher[j] = (packet->payload[offset+1] << 8) + packet->payload[offset];
	offset += 2;
      }
    }

    extension_len = (packet->payload[offset+1] << 8) + packet->payload[offset];
    offset += 2;

    if(extension_len > 0) {
      while(offset < (base_offset + extension_len)) {
	u_int16_t extension_type = (packet->payload[offset+1] << 8) + packet->payload[offset];
	u_int16_t extension_data_len = (packet->payload[offset+3] << 8) + packet->payload[offset+2];

	offset += 4;

	if(extension_type == 0x000a) { /* Supported Versions */
	  if(extension_data_len >= 2) {
	    ja3.tls_handshake_version = (packet->payload[offset+1] << 8) + packet->payload[offset];
	  }
	} else if(extension_type == 0x0000) { /* Server Name Indication */
	  ;
	} else if(extension_type == 0x000d) { /* Signature Algorithms */
	  ;
	} else if(extension_type == 0x000b) { /* Supported Groups */
	  ja3.num_elliptic_curve = extension_data_len / 2;
	  for(j=0; j<ja3.num_elliptic_curve; j++) {
	    ja3.elliptic_curve[j] = (packet->payload[offset+1] << 8) + packet->payload[offset];
	    offset += 2;
	  }
	} else if(extension_type == 0x000c) { /* Elliptic Curves Point Formats */
	  ja3.num_elliptic_curve_point_format = extension_data_len;
	  for(j=0; j<ja3.num_elliptic_curve_point_format; j++) {
	    ja3.elliptic_curve_point_format[j] = packet->payload[offset];
	    offset++;
	  }
	} else if(extension_type == 0x0010) { /* Extended Master Secret */
	  ;
	} else if(extension_type == 0x0017) { /* Renegotiation Info */
	  ;
	} else if(extension_type == 0x001d) { /* Session Ticket */
	  ;
	} else if(extension_type == 0x0023) { /* P-256 */
	  ;
	} else if(extension_type == 0x002b) { /* P-384 */
	  ;
	} else if(extension_type == 0x0035) { /* P-521 */
	  ;
	} else if(extension_type == 0x0033) { /* X25519 */
	  ;
	} else if(extension_type == 0x0039) { /* X448 */
	  ;
	} else if(extension_type == 0x002f) { /* Ed25519 */
	  ;
	} else if(extension_type == 0x003b) { /* Ed448 */
	  ;
	} else {
	  ja3.num_tls_extension++;
	  ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	}

	offset += extension_data_len;
      }
    }

    ja3_str_len = snprintf(ja3_str, JA3_STR_LEN, "%u", ja3.tls_handshake_version);
    for(i=0; i<ja3.num_cipher; i++) {
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.cipher[i]);
    }
    for(i=0; i<ja3.num_tls_extension; i++) {
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.tls_extension[i]);
    }
    for(i=0; i<ja3.num_elliptic_curve; i++) {
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.elliptic_curve[i]);
    }
    for(i=0; i<ja3.num_elliptic_curve_point_format; i++) {
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.elliptic_curve_point_format[i]);
    }

    NDPI_MD5Init(&ctx);
    NDPI_MD5Update(&ctx, ja3_str, ja3_str_len);
    NDPI_MD5Final(md5_hash, &ctx);

    for(i=0; i<16; i++) {
      snprintf(&buffer[i*2], 3, "%02X", md5_hash[i]);
    }

    snprintf(flow->protos.stun_ssl.ssl.ja3_fingerprint, sizeof(flow->protos.stun_ssl.ssl.ja3_fingerprint), "%s", buffer);
  }