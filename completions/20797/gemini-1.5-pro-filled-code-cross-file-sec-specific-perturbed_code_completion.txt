{
      u_int16_t cipher_suite = (packet->payload[offset + 38] << 8) + packet->payload[offset + 39];
      offset += 40; // Session ID Length + Session ID + Cipher Suite + Compression Method

      ja3.cipher = cipher_suite;

      snprintf(ja3_str, JA3_STR_LEN, "%u,%u,%u", ja3.tls_handshake_version, ja3.cipher, 0);

      ja3_str_len = strlen(ja3_str);

      ndpi_MD5Init(&ctx);
      ndpi_MD5Update(&ctx, (unsigned char *)ja3_str, ja3_str_len);
      ndpi_MD5Final(md5_hash, &ctx);

      for(i=0; i<16; i++) {
        snprintf(buffer+(i*2), sizeof(buffer)-(i*2), "%02x", md5_hash[i]);
      }
#ifdef DEBUG_TLS
      printf("JA3 Server: %s\n", buffer);
#endif

      if(flow->protos.stun_ssl.ssl.server_ja3_hash[0] == '\0') {
        strncpy(flow->protos.stun_ssl.ssl.server_ja3_hash, buffer, JA3_SERVER_HASH_LEN);
        flow->protos.stun_ssl.ssl.server_ja3_hash[JA3_SERVER_HASH_LEN-1] = '\0';
      }

      return(2);
    } else if(handshake_type == 0x01 /* Client Hello */) {
      u_int16_t cipher_suites_len, cipher_suites_offset, extensions_len, extensions_offset, k;

      offset += 38 + session_id_len + 2; // Session ID Length + Session ID + Cipher Suites Length
      cipher_suites_len = (packet->payload[offset] << 8) + packet->payload[offset + 1];

      if (offset + 2 + cipher_suites_len + 2 > total_len) {
        jainvalid = 1;
      }

      if(!jainvalid) {
        cipher_suites_offset = offset + 2;
        extensions_len = (packet->payload[offset + 2 + cipher_suites_len] << 8) + packet->payload[offset + 2 + cipher_suites_len + 1];
        extensions_offset = offset + 2 + cipher_suites_len + 2;

        if (extensions_offset + extensions_len > total_len) {
          jainvalid = 1;
        }

        if(!jainvalid) {
          snprintf(ja3_str, JA3_STR_LEN, "%u", tls_version);

          for (j = 0; j < cipher_suites_len; j += 2) {
            u_int16_t cipher_suite = (packet->payload[cipher_suites_offset + j] << 8) + packet->payload[cipher_suites_offset + j + 1];
            char cipher_str[8];

            snprintf(cipher_str, sizeof(cipher_str), ",%u", cipher_suite);
            strncat(ja3_str, cipher_str, JA3_STR_LEN - strlen(ja3_str) - 1);
          }
          strncat(ja3_str, ",", JA3_STR_LEN - strlen(ja3_str) -1);
        }
      }
    }