// <MASK>
if(handshake_type == 0x02 /* Server Hello */) {
  offset += session_id_len;
  ja3.server_cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  while(offset < total_len) {
    u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;
    u_int16_t extension_len_2 = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;

    switch(extension_type) {
    case 0x0000: /* server_name */
      break;
    case 0x000a: /* supported_groups */
      ja3.server_supported_groups_len = extension_len_2;
      ja3.server_supported_groups = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x000b: /* ec_point_formats */
      ja3.server_ec_point_formats_len = extension_len_2;
      ja3.server_ec_point_formats = &packet->payload[offset];
      break;
    case 0x000d: /* signature_algorithms */
      ja3.server_signature_algorithms_len = extension_len_2;
      ja3.server_signature_algorithms = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x0010: /* application_layer_protocol_negotiation */
      ja3.server_alpn_len = extension_len_2;
      ja3.server_alpn = &packet->payload[offset];
      break;
    case 0x0023: /* session_ticket */
      break;
    case 0x0033: /* supported_versions */
      ja3.server_tls_version_len = extension_len_2;
      ja3.server_tls_version = (u_int16_t*)&packet->payload[offset];
      break;
    default:
      break;
    }

    offset += extension_len_2;
  }

  ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u,%04x,%u,", tls_version, ja3.server_cipher_suite, ja3.server_supported_groups_len);

  for(i = 0; i < ja3.server_supported_groups_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ja3.server_supported_groups[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.server_ec_point_formats_len);

  for(i = 0; i < ja3.server_ec_point_formats_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%02x,", ja3.server_ec_point_formats[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.server_signature_algorithms_len);

  for(i = 0; i < ja3.server_signature_algorithms_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ja3.server_signature_algorithms[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.server_alpn_len);

  for(i = 0; i < ja3.server_alpn_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%02x", ja3.server_alpn[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, ",%u,", ja3.server_tls_version_len);

  for(i = 0; i < ja3.server_tls_version_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ja3.server_tls_version[i]);

  ja3_str[ja3_str_len-1] = '\0'; /* Remove last comma */

  ndpi_MD5Init(&ctx);
  ndpi_MD5Update(&ctx, (unsigned char*)ja3_str, ja3_str_len);
  ndpi_MD5Final(md5_hash, &ctx);

  for(i = 0; i < 16; i++)
    snprintf(buffer + (i*2), 3, "%02x", md5_hash[i]);

  flow->protos.stun_ssl.ssl.ja3_server = ndpi_strdup(buffer);

  return(2); /* Server Hello */
} else if(handshake_type == 0x01 /* Client Hello */) {
  u_int16_t cipher_suites_len, i;

  offset += session_id_len;
  cipher_suites_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  ja3.client_cipher_suites_len = cipher_suites_len;
  ja3.client_cipher_suites = (u_int16_t*)&packet->payload[offset];
  offset += cipher_suites_len;

  extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  while(offset < total_len) {
    u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;
    u_int16_t extension_len_2 = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;

    switch(extension_type) {
    case 0x0000: /* server_name */
      break;
    case 0x000a: /* supported_groups */
      ja3.client_supported_groups_len = extension_len_2;
      ja3.client_supported_groups = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x000b: /* ec_point_formats */
      ja3.client_ec_point_formats_len = extension_len_2;
      ja3.client_ec_point_formats = &packet->payload[offset];
      break;
    case 0x000d: /* signature_algorithms */
      ja3.client_signature_algorithms_len = extension_len_2;
      ja3.client_signature_algorithms = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x0010: /* application_layer_protocol_negotiation */
      ja3.client_alpn_len = extension_len_2;
      ja3.client_alpn = &packet->payload[offset];
      break;
    case 0x0023: /* session_ticket */
      break;
    case 0x0033: /* supported_versions */
      ja3.client_tls_version_len = extension_len_2;
      ja3.client_tls_version = (u_int16_t*)&packet->payload[offset];
      break;
    default:
      break;
    }

    offset += extension_len_2;
  }

  ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u,", tls_version);

  for(i = 0; i < ja3.client_cipher_suites_len; i += 2)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ntohs(*((u_int16_t*)&packet->payload[base_offset+i])));

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.client_supported_groups_len);

  for(i = 0; i < ja3.client_supported_groups_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ja3.client_supported_groups[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.client_ec_point_formats_len);

  for(i = 0; i < ja3.client_ec_point_formats_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%02x,", ja3.client_ec_point_formats[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.client_signature_algorithms_len);

  for(i = 0; i < ja3.client_signature_algorithms_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ja3.client_signature_algorithms[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%u,", ja3.client_alpn_len);

  for(i = 0; i < ja3.client_alpn_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%02x", ja3.client_alpn[i]);

  ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, ",%u,", ja3.client_tls_version_len);

  for(i = 0; i < ja3.client_tls_version_len; i++)
    ja3_str_len += snprintf(ja3_str + ja3_str_len, sizeof(ja3_str) - ja3_str_len, "%04x,", ja3.client_tls_version[i]);

  ja3_str[ja3_str_len-1] = '\0'; /* Remove last comma */

  ndpi_MD5Init(&ctx);
  ndpi_MD5Update(&ctx, (unsigned char*)ja3_str, ja3_str_len);
  ndpi_MD5Final(md5_hash, &ctx);

  for(i = 0; i < 16; i++)
    snprintf(buffer + (i*2), 3, "%02x", md5_hash[i]);

  flow->protos.stun_ssl.ssl.ja3 = ndpi_strdup(buffer);

  return(1); /* Client Hello */
}

return(0); /* Not found */