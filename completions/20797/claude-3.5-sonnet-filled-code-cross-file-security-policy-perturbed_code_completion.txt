{
    offset += session_id_len + 1;

    if(handshake_type == 0x02) { /* Server Hello */
      u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));
      
      ja3.server_cipher = cipher_suite;
      offset += 2 + 1; /* Skip cipher suite and compression method */
      
      snprintf(ja3_str, JA3_STR_LEN, "%u,", ja3.tls_handshake_version);
      ja3_str_len = strlen(ja3_str);

      if((ja3_str_len + 8) < JA3_STR_LEN) {
        snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "%u", cipher_suite);
      } else {
        return(2); /* Invalid length */
      }
    } else if(handshake_type == 0x01) { /* Client Hello */
      u_int16_t cipher_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
      
      offset += 2 + cipher_len + 1; /* Skip cipher suites and compression methods */
      
      ja3.num_ciphers = cipher_len / 2;
      ja3.ciphers = (u_int16_t*)ndpi_malloc(ja3.num_ciphers * sizeof(u_int16_t));
      
      if(ja3.ciphers) {
        for(i = 0; i < ja3.num_ciphers; i++)
          ja3.ciphers[i] = ntohs(*((u_int16_t*)&packet->payload[base_offset + 2 + i * 2]));
      }

      snprintf(ja3_str, JA3_STR_LEN, "%u,", ja3.tls_handshake_version);
      ja3_str_len = strlen(ja3_str);

      for(i = 0; i < ja3.num_ciphers; i++) {
        int rc = snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "%s%u", (i > 0) ? "-" : "", ja3.ciphers[i]);
        
        if(rc <= 0 || (ja3_str_len + rc) >= JA3_STR_LEN) break;
        ja3_str_len += rc;
      }

      if(ja3_str_len < JA3_STR_LEN - 1) ja3_str[ja3_str_len++] = ',';
      else jainvalid = 1;
    }

    /* Process extensions */
    if(total_len > offset + 2) {
      u_int16_t extensions_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
      offset += 2;

      if(offset + extensions_len > total_len) {
        ndpi_free(ja3.ciphers);
        return(3); /* Invalid length */
      }

      while(offset < total_len) {
        u_int16_t extension_id, extension_len;

        if(offset + 4 > total_len) break;

        extension_id = ntohs(*((u_int16_t*)&packet->payload[offset]));
        offset += 2;

        extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
        offset += 2;

        if(offset + extension_len > total_len) break;

        if(handshake_type == 0x01) { /* Client Hello */
          if(ja3_str_len < JA3_STR_LEN - 1) {
            int rc = snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "%s%u", (ja3.num_extensions > 0) ? "-" : "", extension_id);
            if(rc <= 0 || (ja3_str_len + rc) >= JA3_STR_LEN) jainvalid = 1;
            else ja3_str_len += rc;
          } else {
            jainvalid = 1;
          }
          ja3.num_extensions++;
        }

        offset += extension_len;
      }
    }

    if(!jainvalid) {
      ndpi_MD5Init(&ctx);
      ndpi_MD5Update(&ctx, (const unsigned char *)ja3_str, strlen(ja3_str));
      ndpi_MD5Final(md5_hash, &ctx);

      for(i = 0; i < 16; i++) {
        int rc = snprintf(&flow->protos.stun_ssl.ssl.ja3_client[i*2], 3, "%02x", md5_hash[i]);
        if(rc != 2) {
          flow->protos.stun_ssl.ssl.ja3_client[0] = '\0';
          break;
        }
      }
    }

    ndpi_free(ja3.ciphers);
    return(1); /* Client Hello processed */
  }