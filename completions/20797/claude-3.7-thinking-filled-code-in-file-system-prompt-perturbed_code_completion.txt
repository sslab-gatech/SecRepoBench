{
      if(session_id_len > 32) {
	/* Looks like a malformed packet */
	session_id_len = 0;
      }

      /* Skip session ID */
      offset = base_offset + 1 + session_id_len;

      if((offset+2) > total_len) {
	return(0); /* Not found */
      }

      if(handshake_type == 0x02) {
	u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));

	flow->protos.stun_ssl.ssl.server_unsafe_cipher = ndpi_is_safe_ssl_cipher(cipher_suite) ? 0 : 1;
      
	offset += 2 + 1; /* Skip compression */
	
	if(offset >= total_len) {
	  return(2); /* Server Hello */
	}
	
	extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
	offset += 2;
        
	if((extension_len+offset) > total_len)
	  return(2);

	extension_len += offset;

	while(offset < extension_len) {
	  u_int16_t extension_id, extension_sublen;
	  
	  if((offset+4) >= total_len)
	    break;
	  
	  extension_id = ntohs(*((u_int16_t*)&packet->payload[offset]));
	  offset += 2;

	  extension_sublen = ntohs(*((u_int16_t*)&packet->payload[offset]));
	  offset += 2;

	  if((offset+extension_sublen) > total_len)
	    break;

	  /* Skip GREASE */
	  if((extension_id & 0x0F0F) != 0x0A0A) {
	    if(ja3.num_tls_extension < MAX_NUM_JA3)
	      ja3.tls_extension[ja3.num_tls_extension++] = extension_id;
	  }
	  
	  offset += extension_sublen;
	}

	ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u,%u,", ja3.tls_handshake_version, cipher_suite);

	/* No extensions */
	for(i=0; i<ja3.num_tls_extension; i++) {
	  if(i+1 == ja3.num_tls_extension)
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u", ja3.tls_extension[i]);
	  else
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u-", ja3.tls_extension[i]);
	}

	if(ja3.num_tls_extension == 0)
	  ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "");

	if(ja3_str_len && (ja3_str_len < JA3_STR_LEN)) {
	  ndpi_MD5Init(&ctx);
	  ndpi_MD5Update(&ctx, (const unsigned char *)ja3_str, ja3_str_len);
	  ndpi_MD5Final(md5_hash, &ctx);

	  for(i=0, j=0; i<16; i++) {
	    int rc = snprintf(&flow->protos.stun_ssl.ssl.ja3_server[j],
			      sizeof(flow->protos.stun_ssl.ssl.ja3_server)-j, "%02x",
			      md5_hash[i]);
	    if(rc <= 0) break;
	    j += rc;
	  }
	  flow->protos.stun_ssl.ssl.ja3_server[j] = '\0';
	}
	
	return(2); /* Server Hello */
      } else if(handshake_type == 0x01) {
	u_int16_t cipher_len, cipher_offset;
	
	if((offset+2) > total_len) {
	  return(0); /* Not found */
	}
	cipher_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
	cipher_offset = offset+2;

	offset = cipher_offset + cipher_len + 1;
	if(offset > total_len) {
	  return(0); /* Not found */
	}
	
	if(flow->protos.stun_ssl.ssl.client_certificate[0] == '\0') {
	  int rc;
	  
	  /* SNI */
	  extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
	  offset += 2;
	  
	  if((extension_len+offset) > total_len) {
	    return(0); /* Not found */
	  }
	  
	  extension_len += offset;
	  
	  while(offset < extension_len) {
	    u_int16_t extension_id, extension_sublen;
	    
	    if((offset+4) >= total_len) break;
	    
	    extension_id = ntohs(*((u_int16_t*)&packet->payload[offset]));
	    offset += 2;
	    
	    extension_sublen = ntohs(*((u_int16_t*)&packet->payload[offset]));
	    offset += 2;
	    
	    if((offset+extension_sublen) > total_len)
	      break;
	    
	    if(extension_id == 0) {
	      u_int16_t name_len = ntohs(*((u_int16_t*)&packet->payload[offset+3]));
	      
	      if((offset+5+name_len) <= total_len && name_len > 0 && name_len <= sizeof(buffer)-1) {
		strncpy(buffer, (char*)&packet->payload[offset+5], name_len);
		buffer[name_len] = '\0';
		
		cleanupServerName(buffer, name_len);
		rc = ndpi_snprintf(flow->protos.stun_ssl.ssl.client_certificate,
				   sizeof(flow->protos.stun_ssl.ssl.client_certificate),
				   "%s", buffer);
		
		if(rc <= 0) flow->protos.stun_ssl.ssl.client_certificate[0] = '\0';
	      }
	    } else if((extension_id == 0x000a) || (extension_id == 0x000b)) {
	      u_int offset_in = offset;
	      
	      /* Supported Groups (RFC 7919) */
	      if(extension_id == 0x000a) {
		if(extension_sublen >= 2) {
		  u_int16_t s_offset;
		  u_int16_t s_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
		  
		  if((s_len+2) <= extension_sublen) {
		    s_offset = 2;
		    
		    while(s_offset < s_len) {
		      u_int16_t s_group = ntohs(*((u_int16_t*)&packet->payload[offset+s_offset]));
		      
		      /* Skip GREASE */
		      if((s_group & 0x0F0F) != 0x0A0A) {
			if(ja3.num_elliptic_curve < MAX_NUM_JA3)
			  ja3.elliptic_curve[ja3.num_elliptic_curve++] = s_group;
		      }
		      
		      s_offset += 2;
		    }
		  }
		}
	      } else if(extension_id == 0x000b) {
		/* EC Point Formats (RFC 4492) */
		if(extension_sublen >= 1) {
		  u_int8_t s_offset;
		  u_int8_t s_len = packet->payload[offset];
		  
		  if((s_len+1) <= extension_sublen) {
		    s_offset = 1;
		    
		    while(s_offset < s_len) {
		      u_int8_t s_format = packet->payload[offset+s_offset];
		      
		      if(ja3.num_elliptic_curve_point_format < MAX_NUM_JA3)
			ja3.elliptic_curve_point_format[ja3.num_elliptic_curve_point_format++] = s_format;
		      
		      s_offset++;
		    }
		  }
		}
	      }
	      
	      offset = offset_in;
	    }
	    
	    /* Skip GREASE */
	    if((extension_id & 0x0F0F) != 0x0A0A) {
	      if(ja3.num_tls_extension < MAX_NUM_JA3) {
		if(extension_id == 0x0010) {
		  if(extension_sublen >= 4) {
		    u_int16_t version = ntohs(*((u_int16_t*)&packet->payload[offset + 1]));
		    
		    switch(version) {
		    case 0x0304:
		      flow->protos.stun_ssl.ssl.tls_supported_versions = NDPI_TLS_VERSION_1_3;
		      break;
		    case 0x0303:
		      flow->protos.stun_ssl.ssl.tls_supported_versions = NDPI_TLS_VERSION_1_2;
		      break;
		    case 0x0302:
		      flow->protos.stun_ssl.ssl.tls_supported_versions = NDPI_TLS_VERSION_1_1;
		      break;
		    case 0x0301:
		      flow->protos.stun_ssl.ssl.tls_supported_versions = NDPI_TLS_VERSION_1_0;
		      break;
		    }
		  }
		}
		
		ja3.tls_extension[ja3.num_tls_extension++] = extension_id;
	      }
	    }
	    
	    offset += extension_sublen;
	  }
	}
	
	/* Cipher suites */
	for(i=0; i<cipher_len; i+=2) {
	  u_int16_t cipher = ntohs(*((u_int16_t*)&packet->payload[cipher_offset+i]));
	  
	  if(ndpi_is_safe_ssl_cipher(cipher) == NDPI_CIPHER_UNSAFE)
	    flow->protos.stun_ssl.ssl.client_unsafe_cipher = 1;
	  
	  /* Skip GREASE */
	  if((cipher & 0x0F0F) != 0x0A0A) {
	    if(ja3.num_cipher < MAX_NUM_JA3)
	      ja3.cipher[ja3.num_cipher++] = cipher;
	  }
	}
	
	ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u,", ja3.tls_handshake_version);
	
	for(i=0; i<ja3.num_cipher; i++) {
	  if(i+1 == ja3.num_cipher)
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u", ja3.cipher[i]);
	  else
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u-", ja3.cipher[i]);
	}
	
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, ",");
	
	for(i=0; i<ja3.num_tls_extension; i++) {
	  if(i+1 == ja3.num_tls_extension)
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u", ja3.tls_extension[i]);
	  else
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u-", ja3.tls_extension[i]);
	}
	
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, ",");
	
	for(i=0; i<ja3.num_elliptic_curve; i++) {
	  if(i+1 == ja3.num_elliptic_curve)
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u", ja3.elliptic_curve[i]);
	  else
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u-", ja3.elliptic_curve[i]);
	}
	
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, ",");
	
	for(i=0; i<ja3.num_elliptic_curve_point_format; i++) {
	  if(i+1 == ja3.num_elliptic_curve_point_format)
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u", ja3.elliptic_curve_point_format[i]);
	  else
	    ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str)-ja3_str_len, "%u-", ja3.elliptic_curve_point_format[i]);
	}
	
	if(ja3_str_len && (ja3_str_len < JA3_STR_LEN) && (flow->protos.stun_ssl.ssl.ja3_client[0] == '\0')) {
	  ndpi_MD5Init(&ctx);
	  ndpi_MD5Update(&ctx, (const unsigned char *)ja3_str, ja3_str_len);
	  ndpi_MD5Final(md5_hash, &ctx);
	  
	  for(i=0, j=0; i<16; i++) {
	    int rc = snprintf(&flow->protos.stun_ssl.ssl.ja3_client[j],
			      sizeof(flow->protos.stun_ssl.ssl.ja3_client)-j, "%02x",
			      md5_hash[i]);
	    if(rc <= 0) break;
	    j += rc;
	  }
	  flow->protos.stun_ssl.ssl.ja3_client[j] = '\0';
	}
	
	if(!ndpi_struct->skip_metadata_export && ja3_str_len && (ja3_str_len < JA3_STR_LEN)) {
	  if(flow->protos.stun_ssl.ssl.ja3_client_string == NULL)
	    flow->protos.stun_ssl.ssl.ja3_client_string = ndpi_strdup(ja3_str);
	}
	
	return(1); /* Client Hello */
      }
    }
}