offset += session_id_len + 4;
    ja3_str_len = 0;

    /* Extract cipher suites */
    ja3.cipher_suites_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;
    for(j=0; j < ja3.cipher_suites_len; j+=2) {
      ja3.cipher_suites[ja3.cipher_suites_count++] = ntohs(*((u_int16_t*)&packet->payload[offset]));
      offset += 2;
    }

    /* Extract extensions */
    while(offset < total_len) {
      extension_len = ntohs(*((u_int16_t*)&packet->payload[offset+2]));
      if(extension_len > 0) {
	ja3.extensions[ja3.extensions_count++] = ntohs(*((u_int16_t*)&packet->payload[offset]));
	offset += 4 + extension_len;
      } else {
	break;
      }
    }

    ja3_str_len = snprintf(ja3_str, JA3_STR_LEN, "%u", ja3.tls_handshake_version);
    for(i=0; i < ja3.cipher_suites_count; i++) {
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.cipher_suites[i]);
    }
    for(i=0; i < ja3.extensions_count; i++) {
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.extensions[i]);
    }

    ndpi_MD5Init(&ctx);
    ndpi_MD5Update(&ctx, ja3_str, ja3_str_len);
    ndpi_MD5Final(md5_hash, &ctx);

    flow->l4.tcp.tls.ja3_fingerprint[0] = md5_hash[0];
    flow->l4.tcp.tls.ja3_fingerprint[1] = md5_hash[1];
    flow->l4.tcp.tls.ja3_fingerprint[2] = md5_hash[2];
    flow->l4.tcp.tls.ja3_fingerprint[3] = md5_hash[3];
    flow->l4.tcp.tls.ja3_fingerprint[4] = md5_hash[4];
    flow->l4.tcp.tls.ja3_fingerprint[5] = md5_hash[5];
    flow->l4.tcp.tls.ja3_fingerprint[6] = md5_hash[6];
    flow->l4.tcp.tls.ja3_fingerprint[7] = md5_hash[7];
    flow->l4.tcp.tls.ja3_fingerprint[8] = md5_hash[8];
    flow->l4.tcp.tls.ja3_fingerprint[9] = md5_hash[9];
    flow->l4.tcp.tls.ja3_fingerprint[10] = md5_hash[10];
    flow->l4.tcp.tls.ja3_fingerprint[11] = md5_hash[11];
    flow->l4.tcp.tls.ja3_fingerprint[12] = md5_hash[12];
    flow->l4.tcp.tls.ja3_fingerprint[13] = md5_hash[13];
    flow->l4.tcp.tls.ja3_fingerprint[14] = md5_hash[14];
    flow->l4.tcp.tls.ja3_fingerprint[15] = md5_hash[15];

    flow->l4.tcp.tls.ja3_fingerprint_set = 1;

    return(1);