// <MASK>
if(handshake_type == 0x02 /* Server Hello */) {
  offset += session_id_len;
  ja3.server_cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  while(offset < total_len) {
    u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;
    u_int16_t extension_len_2 = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;

    switch(extension_type) {
    case 0x0000: /* server_name */
      break;
    case 0x000a: /* supported_groups */
      ja3.server_supported_groups_len = extension_len_2;
      ja3.server_supported_groups = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x000b: /* ec_point_formats */
      ja3.server_ec_point_formats_len = extension_len_2;
      ja3.server_ec_point_formats = (u_int8_t*)&packet->payload[offset];
      break;
    case 0x000d: /* signature_algorithms */
      ja3.server_signature_algorithms_len = extension_len_2;
      ja3.server_signature_algorithms = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x0010: /* supported_versions */
      ja3.server_supported_versions_len = extension_len_2;
      ja3.server_supported_versions = (u_int16_t*)&packet->payload[offset];
      break;
    default:
      break;
    }

    offset += extension_len_2;
  }

  ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u,%s,%s,%s,%s",
                        ja3.tls_handshake_version,
                        ndpi_SSL_version2str(tls_version),
                        ndpi_SSL_cipher2str(ja3.server_cipher_suite),
                        ndpi_SSL_supported_groups2str(ja3.server_supported_groups, ja3.server_supported_groups_len),
                        ndpi_SSL_ec_point_formats2str(ja3.server_ec_point_formats, ja3.server_ec_point_formats_len));
}
else if(handshake_type == 0x01 /* Client Hello */) {
  u_int16_t cipher_suites_len = ntohs(*((u_int16_t*)&packet->payload[base_offset]));
  offset = base_offset + 2;

  ja3.client_cipher_suites_len = cipher_suites_len;
  ja3.client_cipher_suites = (u_int16_t*)&packet->payload[offset];
  offset += cipher_suites_len;

  ja3.client_extensions_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
  offset += 2;

  while(offset < total_len) {
    u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;
    u_int16_t extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
    offset += 2;

    switch(extension_type) {
    case 0x000a: /* supported_groups */
      ja3.client_supported_groups_len = extension_len;
      ja3.client_supported_groups = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x000b: /* ec_point_formats */
      ja3.client_ec_point_formats_len = extension_len;
      ja3.client_ec_point_formats = (u_int8_t*)&packet->payload[offset];
      break;
    case 0x000d: /* signature_algorithms */
      ja3.client_signature_algorithms_len = extension_len;
      ja3.client_signature_algorithms = (u_int16_t*)&packet->payload[offset];
      break;
    case 0x0010: /* supported_versions */
      ja3.client_supported_versions_len = extension_len;
      ja3.client_supported_versions = (u_int16_t*)&packet->payload[offset];
      break;
    default:
      /* Ignore GREASE values */
      if((extension_type & 0x0f0f) != 0x0a0a)
        jainvalid = 1;
      break;
    }

    offset += extension_len;
  }

  ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u,%s,%s,%s,%s",
                        ja3.tls_handshake_version,
                        ndpi_SSL_version2str(tls_version),
                        ndpi_SSL_ciphers2str(ja3.client_cipher_suites, ja3.client_cipher_suites_len),
                        ndpi_SSL_supported_groups2str(ja3.client_supported_groups, ja3.client_supported_groups_len),
                        ndpi_SSL_ec_point_formats2str(ja3.client_ec_point_formats, ja3.client_ec_point_formats_len));
}

if(!jainvalid) {
  ndpi_MD5Init(&ctx);
  ndpi_MD5Update(&ctx, (const unsigned char*)ja3_str, ja3_str_len);
  ndpi_MD5Final(md5_hash, &ctx);

  for(i=0; i<16; i++)
    snprintf(&buffer[i*2], 3, "%02X", md5_hash[i]);

  flow->protos.stun_ssl.ssl.ja3_client = ndpi_strdup(buffer);
  flow->protos.stun_ssl.ssl.ja3_server = ndpi_strdup(buffer);
}

return(handshake_type);
// </MASK>