{
      u_int16_t offset = base_offset;

      if (offset >= total_len) return 0;
      u_int8_t session_id_len = packet->payload[offset];
      offset += 1 + session_id_len;

      if (offset + 2 > total_len) return 0;
      u_int16_t cipher_suite = (packet->payload[offset] << 8) | packet->payload[offset + 1];
      offset += 2;

      snprintf(ja3_str, sizeof(ja3_str), "%u,", tls_version);
      snprintf(buffer, sizeof(buffer), "%u", cipher_suite);
      strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);

      if (offset >= total_len) return 0;
      u_int8_t compression_methods_len = packet->payload[offset];
      offset += 1 + compression_methods_len;

      if (offset + 2 > total_len) return 0;
      u_int16_t extensions_len = (packet->payload[offset] << 8) | packet->payload[offset + 1];
      offset += 2;

      strncat(ja3_str, ",", sizeof(ja3_str) - strlen(ja3_str) - 1);
      u_int16_t extensions_end = offset + extensions_len;
      if (extensions_end > total_len) return 0;

      while (offset < extensions_end) {
        if (offset + 4 > extensions_end) break;
        u_int16_t ext_type = (packet->payload[offset] << 8) | packet->payload[offset + 1];
        u_int16_t ext_len = (packet->payload[offset + 2] << 8) | packet->payload[offset + 3];
        offset += 4;

        if ((ext_type & 0x0F0F) == 0x0A0A) { /* Skip GREASE */
          offset += ext_len;
          continue;
        }

        snprintf(buffer, sizeof(buffer), "-%u", ext_type);
        strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);

        if (ext_type == 0x002b && ext_len >= 2) { /* supported_versions */
          u_int16_t version = (packet->payload[offset] << 8) | packet->payload[offset + 1];
          snprintf(buffer, sizeof(buffer), "-%u", version);
          strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);
        }

        offset += ext_len;
      }

      ja3_str_len = strlen(ja3_str);
      ndpi_MD5Init(&ctx);
      ndpi_MD5Update(&ctx, (u_char*)ja3_str, ja3_str_len);
      ndpi_MD5Final(md5_hash, &ctx);

      memcpy(flow->protos.stun_ssl.ssl.ja3_hash, md5_hash, sizeof(md5_hash));
      return 1;
    }
    else if (handshake_type == 0x01) { /* Client Hello */
      u_int16_t offset = base_offset;

      if (offset >= total_len) return 0;
      u_int8_t session_id_len = packet->payload[offset];
      offset += 1 + session_id_len;

      if (offset + 2 > total_len) return 0;
      u_int16_t cipher_suites_len = (packet->payload[offset] << 8) | packet->payload[offset + 1];
      offset += 2;

      snprintf(ja3_str, sizeof(ja3_str), "%u,", tls_version);
      u_int16_t cipher_end = offset + cipher_suites_len;
      if (cipher_end > total_len) return 0;

      for (i = offset; i < cipher_end; i += 2) {
        if (i + 2 > cipher_end) break;
        u_int16_t cipher = (packet->payload[i] << 8) | packet->payload[i + 1];
        if ((cipher & 0x0F0F) == 0x0A0A) continue; /* Skip GREASE */
        snprintf(buffer, sizeof(buffer), "%s%u", (i == offset) ? "" : "-", cipher);
        strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);
      }

      if (cipher_end >= total_len) return 0;
      u_int8_t compression_methods_len = packet->payload[cipher_end];
      offset = cipher_end + 1 + compression_methods_len;

      if (offset + 2 > total_len) return 0;
      u_int16_t extensions_len = (packet->payload[offset] << 8) | packet->payload[offset + 1];
      offset += 2;

      strncat(ja3_str, ",", sizeof(ja3_str) - strlen(ja3_str) - 1);
      u_int16_t extensions_end = offset + extensions_len;
      if (extensions_end > total_len) return 0;

      while (offset < extensions_end) {
        if (offset + 4 > extensions_end) break;
        u_int16_t ext_type = (packet->payload[offset] << 8) | packet->payload[offset + 1];
        u_int16_t ext_len = (packet->payload[offset + 2] << 8) | packet->payload[offset + 3];
        offset += 4;

        if ((ext_type & 0x0F0F) == 0x0A0A) { /* Skip GREASE */
          offset += ext_len;
          continue;
        }

        snprintf(buffer, sizeof(buffer), "%s%u", (ja3.extensions_count++ == 0) ? "" : "-", ext_type);
        strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);

        offset += ext_len;
      }

      ja3_str_len = strlen(ja3_str);
      ndpi_MD5Init(&ctx);
      ndpi_MD5Update(&ctx, (u_char*)ja3_str, ja3_str_len);
      ndpi_MD5Final(md5_hash, &ctx);

      memcpy(flow->protos.stun_ssl.ssl.ja3_hash, md5_hash, sizeof(md5_hash));
      return 1;
    }