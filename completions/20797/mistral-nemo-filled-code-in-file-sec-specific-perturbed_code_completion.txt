// <MASK>
if(handshake_type == 0x02 /* Server Hello */) {
  offset += session_id_len + 1; /* Skip session ID */

  if((offset + 2) < total_len) {
    u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));
    ja3.num_cipher = 1, ja3.cipher[0] = cipher_suite;
  }

  if((offset + 4) < total_len) {
    u_int16_t tls_extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
    extension_len = tls_extension_len;

    if((offset + tls_extension_len + 4) < total_len) {
      offset += 4; /* Skip extension type and length */

      while(extension_len > 0) {
	if((offset + 2) < total_len) {
	  u_int16_t extension_id = ntohs(*((u_int16_t*)&packet->payload[offset]));
	  ja3.num_tls_extension++;
	  ja3.tls_extension[ja3.num_tls_extension - 1] = extension_id;
	}

	if((offset + 3) < total_len) {
	  u_int8_t extension_data_len = packet->payload[offset + 2];
	  offset += 3; /* Skip extension id and length */

	  if((offset + extension_data_len) < total_len) {
	    offset += extension_data_len;
	  } else {
	    jainvalid = 1;
	    break;
	  }
	} else {
	  jainvalid = 1;
	  break;
	}

	extension_len -= 3 + extension_data_len;
      }
    } else {
      jainvalid = 1;
    }
  }

  if(!jainvalid) {
    ja3_str_len = snprintf(ja3_str, sizeof(ja3_str), "%u", ja3.tls_handshake_version);

    for(i=0; i<ja3.num_cipher; i++)
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str) - ja3_str_len, ":%u", ja3.cipher[i]);

    for(i=0; i<ja3.num_tls_extension; i++)
      ja3_str_len += snprintf(&ja3_str[ja3_str_len], sizeof(ja3_str) - ja3_str_len, ":%u", ja3.tls_extension[i]);

    ndpi_MD5Init(&ctx);
    ndpi_MD5Update(&ctx, (u_int8_t*)ja3_str, ja3_str_len);
    ndpi_MD5Final(md5_hash, &ctx);

    flow->protos.stun_ssl.ssl.ja3_hash = ndpi_strdup((char*)md5_hash);
  }
}
// </MASK>