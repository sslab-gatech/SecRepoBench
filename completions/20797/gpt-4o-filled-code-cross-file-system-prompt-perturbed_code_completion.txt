{
      u_int16_t cipher_suite_len, compression_methods_len, extensions_len;
      u_int16_t cipher_suite_offset, compression_methods_offset, extensions_offset;
      u_int8_t  *cipher_suites, *extensions;
      char *ja3_str_ptr = ja3_str;

      /* Adjust offset for Server Hello */
      offset += 1 + session_id_len;

      /* Extract cipher suite */
      cipher_suite_offset = offset;
      cipher_suite_len = 2; /* Server Hello has a single cipher suite */
      cipher_suites = &packet->payload[cipher_suite_offset];
      offset += cipher_suite_len;

      /* Extract compression methods */
      compression_methods_offset = offset;
      compression_methods_len = packet->payload[offset];
      offset += 1 + compression_methods_len;

      /* Extract extensions */
      if(offset < total_len) {
        extensions_offset = offset + 2;
        extensions_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
        extensions = &packet->payload[extensions_offset];
      } else {
        extensions_len = 0;
        extensions = NULL;
      }

      /* Construct JA3 string */
      ja3_str_ptr += snprintf(ja3_str_ptr, sizeof(ja3_str) - (ja3_str_ptr - ja3_str), "%u,", tls_version);
      for(i = 0; i < cipher_suite_len; i += 2) {
        ja3_str_ptr += snprintf(ja3_str_ptr, sizeof(ja3_str) - (ja3_str_ptr - ja3_str), "%u-", ntohs(*((u_int16_t*)&cipher_suites[i])));
      }
      if(ja3_str_ptr > ja3_str) ja3_str_ptr--; /* Remove last '-' */
      ja3_str_ptr += snprintf(ja3_str_ptr, sizeof(ja3_str) - (ja3_str_ptr - ja3_str), ",");

      /* Skip compression methods as they are not part of JA3 */

      /* Process extensions */
      for(i = 0; i < extensions_len; i += 4 + ntohs(*((u_int16_t*)&extensions[i+2]))) {
        u_int16_t ext_type = ntohs(*((u_int16_t*)&extensions[i]));
        if(ext_type == 0x0a || ext_type == 0x0b || ext_type == 0x23 || ext_type == 0x3374 || ext_type == 0x3375 || ext_type == 0x39 || ext_type == 0x3a || ext_type == 0x3b || ext_type == 0x3c || ext_type == 0x3d || ext_type == 0x3e || ext_type == 0x3f || ext_type == 0x40 || ext_type == 0x41 || ext_type == 0x42 || ext_type == 0x43 || ext_type == 0x44 || ext_type == 0x45 || ext_type == 0x46 || ext_type == 0x47 || ext_type == 0x48 || ext_type == 0x49 || ext_type == 0x4a || ext_type == 0x4b || ext_type == 0x4c || ext_type == 0x4d || ext_type == 0x4e || ext_type == 0x4f || ext_type == 0x50 || ext_type == 0x51 || ext_type == 0x52 || ext_type == 0x53 || ext_type == 0x54 || ext_type == 0x55 || ext_type == 0x56 || ext_type == 0x57 || ext_type == 0x58 || ext_type == 0x59 || ext_type == 0x5a || ext_type == 0x5b || ext_type == 0x5c || ext_type == 0x5d || ext_type == 0x5e || ext_type == 0x5f || ext_type == 0x60 || ext_type == 0x61 || ext_type == 0x62 || ext_type == 0x63 || ext_type == 0x64 || ext_type == 0x65 || ext_type == 0x66 || ext_type == 0x67 || ext_type == 0x68 || ext_type == 0x69 || ext_type == 0x6a || ext_type == 0x6b || ext_type == 0x6c || ext_type == 0x6d || ext_type == 0x6e || ext_type == 0x6f || ext_type == 0x70 || ext_type == 0x71 || ext_type == 0x72 || ext_type == 0x73 || ext_type == 0x74 || ext_type == 0x75 || ext_type == 0x76 || ext_type == 0x77 || ext_type == 0x78 || ext_type == 0x79 || ext_type == 0x7a || ext_type == 0x7b || ext_type == 0x7c || ext_type == 0x7d || ext_type == 0x7e || ext_type == 0x7f || ext_type == 0x80 || ext_type == 0x81 || ext_type == 0x82 || ext_type == 0x83 || ext_type == 0x84 || ext_type == 0x85 || ext_type == 0x86 || ext_type == 0x87 || ext_type == 0x88 || ext_type == 0x89 || ext_type == 0x8a || ext_type == 0x8b || ext_type == 0x8c || ext_type == 0x8d || ext_type == 0x8e || ext_type == 0x8f || ext_type == 0x90 || ext_type == 0x91 || ext_type == 0x92 || ext_type == 0x93 || ext_type == 0x94 || ext_type == 0x95 || ext_type == 0x96 || ext_type == 0x97 || ext_type == 0x98 || ext_type == 0x99 || ext_type == 0x9a || ext_type == 0x9b || ext_type == 0x9c || ext_type == 0x9d || ext_type == 0x9e || ext_type == 0x9f || ext_type == 0xa0 || ext_type == 0xa1 || ext_type == 0xa2 || ext_type == 0xa3 || ext_type == 0xa4 || ext_type == 0xa5 || ext_type == 0xa6 || ext_type == 0xa7 || ext_type == 0xa8 || ext_type == 0xa9 || ext_type == 0xaa || ext_type == 0xab || ext_type == 0xac || ext_type == 0xad || ext_type == 0xae || ext_type == 0xaf || ext_type == 0xb0 || ext_type == 0xb1 || ext_type == 0xb2 || ext_type == 0xb3 || ext_type == 0xb4 || ext_type == 0xb5 || ext_type == 0xb6 || ext_type == 0xb7 || ext_type == 0xb8 || ext_type == 0xb9 || ext_type == 0xba || ext_type == 0xbb || ext_type == 0xbc || ext_type == 0xbd || ext_type == 0xbe || ext_type == 0xbf || ext_type == 0xc0 || ext_type == 0xc1 || ext_type == 0xc2 || ext_type == 0xc3 || ext_type == 0xc4 || ext_type == 0xc5 || ext_type == 0xc6 || ext_type == 0xc7 || ext_type == 0xc8 || ext_type == 0xc9 || ext_type == 0xca || ext_type == 0xcb || ext_type == 0xcc || ext_type == 0xcd || ext_type == 0xce || ext_type == 0xcf || ext_type == 0xd0 || ext_type == 0xd1 || ext_type == 0xd2 || ext_type == 0xd3 || ext_type == 0xd4 || ext_type == 0xd5 || ext_type == 0xd6 || ext_type == 0xd7 || ext_type == 0xd8 || ext_type == 0xd9 || ext_type == 0xda || ext_type == 0xdb || ext_type == 0xdc || ext_type == 0xdd || ext_type == 0xde || ext_type == 0xdf || ext_type == 0xe0 || ext_type == 0xe1 || ext_type == 0xe2 || ext_type == 0xe3 || ext_type == 0xe4 || ext_type == 0xe5 || ext_type == 0xe6 || ext_type == 0xe7 || ext_type == 0xe8 || ext_type == 0xe9 || ext_type == 0xea || ext_type == 0xeb || ext_type == 0xec || ext_type == 0xed || ext_type == 0xee || ext_type == 0xef || ext_type == 0xf0 || ext_type == 0xf1 || ext_type == 0xf2 || ext_type == 0xf3 || ext_type == 0xf4 || ext_type == 0xf5 || ext_type == 0xf6 || ext_type == 0xf7 || ext_type == 0xf8 || ext_type == 0xf9 || ext_type == 0xfa || ext_type == 0xfb || ext_type == 0xfc || ext_type == 0xfd || ext_type == 0xfe || ext_type == 0xff) {
          ja3_str_ptr += snprintf(ja3_str_ptr, sizeof(ja3_str) - (ja3_str_ptr - ja3_str), "%u-", ext_type);
        }
      }
      if(ja3_str_ptr > ja3_str) ja3_str_ptr--; /* Remove last '-' */

      /* Compute MD5 hash of JA3 string */
      ndpi_MD5_Init(&ctx);
      ndpi_MD5_Update(&ctx, (unsigned char*)ja3_str, strlen(ja3_str));
      ndpi_MD5_Final(md5_hash, &ctx);

      /* Store JA3 hash in flow */
      memcpy(flow->protos.stun_ssl.ssl.ja3_hash, md5_hash, sizeof(md5_hash));

      return(1); /* Server Hello processed */
    }