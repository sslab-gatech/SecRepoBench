if(handshake_type == 0x02 /* Server Hello */) {
  u_int16_t base_offset    = packet->tcp? 38 : 46;
  u_int16_t version_offset = packet->tcp? 4 : 12;
  u_int16_t offset = 38, extension_len, j;
  u_int8_t  session_id_len =  packet->tcp? packet->payload[offset] : packet->payload[46];

#ifdef DEBUG_TLS
  printf("SSL [len: %u][handshake_type: %02X]\n", packet->payload_packet_len, handshake_type);
#endif

  tls_version = ntohs(*((u_int16_t*)&packet->payload[version_offset]));
  flow->protos.stun_ssl.ssl.ssl_version = ja3.tls_handshake_version = tls_version;

  if(packet->payload_packet_len >= 34) {
    extension_len = (packet->payload[33] << 8) + packet->payload[34];
    offset += 2;

    if(extension_len > 0) {
      for(j = 0; j < extension_len; j++) {
        u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[offset]));
        u_int16_t extension_length = ntohs(*((u_int16_t*)&packet->payload[offset + 2]));

        if(extension_type == 0x00 || extension_type == 0x01 || extension_type == 0x10 || extension_type == 0x35) {
          offset += 4;
        } else if(extension_type == 0x33) {
          u_int16_t session_id_length = ntohs(*((u_int16_t*)&packet->payload[offset]));
          offset += 2;

          if(session_id_length > 0) {
            for(i = 0; i < session_id_length; i++) {
              ja3_str[i] = packet->payload[offset + i];
            }

            ja3_str_len = session_id_length;
          }
        } else {
          offset += 2 + extension_length;
        }
      }
    }
  }

  if(packet->payload_packet_len >= 34 + extension_len) {
    u_int16_t cipher_suite_count = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len]));
    offset += 2;

    if(cipher_suite_count > 0) {
      for(j = 0; j < cipher_suite_count; j++) {
        u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));
        offset += 2;

        if(cipher_suite!= 0x0000) {
          ja3_str[ja3_str_len++] = ',';
          sprintf(buffer, "%04X", cipher_suite);
          strcat(ja3_str, buffer);
        }
      }
    }
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2) {
    u_int16_t extension_count = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2]));
    offset += 2;

    if(extension_count > 0) {
      for(j = 0; j < extension_count; j++) {
        u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[offset]));
        u_int16_t extension_length = ntohs(*((u_int16_t*)&packet->payload[offset + 2]));

        if(extension_type == 0x00 || extension_type == 0x01 || extension_type == 0x10 || extension_type == 0x35) {
          offset += 4;
        } else if(extension_type == 0x33) {
          u_int16_t session_id_length = ntohs(*((u_int16_t*)&packet->payload[offset]));
          offset += 2;

          if(session_id_length > 0) {
            for(i = 0; i < session_id_length; i++) {
              ja3_str[i + ja3_str_len] = packet->payload[offset + i];
            }

            ja3_str_len += session_id_length;
          }
        } else {
          offset += 2 + extension_length;
        }
      }
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4) {
    u_int16_t master_secret_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4]));
    offset += 2;

    if(master_secret_length > 0) {
      for(i = 0; i < master_secret_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += master_secret_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length) {
    u_int16_t client_random_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length]));
    offset += 2;

    if(client_random_length > 0) {
      for(i = 0; i < client_random_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += client_random_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length) {
    u_int16_t server_random_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length]));
    offset += 2;

    if(server_random_length > 0) {
      for(i = 0; i < server_random_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += server_random_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length) {
    u_int16_t key_exchange_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length]));
    offset += 2;

    if(key_exchange_length > 0) {
      for(i = 0; i < key_exchange_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += key_exchange_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length) {
    u_int16_t change_cipher_spec_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length]));
    offset += 2;

    if(change_cipher_spec_length > 0) {
      for(i = 0; i < change_cipher_spec_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += change_cipher_spec_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length) {
    u_int16_t finished_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length]));
    offset += 2;

    if(finished_length > 0) {
      for(i = 0; i < finished_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += finished_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length) {
    u_int16_t master_secret_hash_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length]));
    offset += 2;

    if(master_secret_hash_length > 0) {
      for(i = 0; i < master_secret_hash_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += master_secret_hash_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length + master_secret_hash_length) {
    u_int16_t client_key_exchange_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length + master_secret_hash_length]));
    offset += 2;

    if(client_key_exchange_length > 0) {
      for(i = 0; i < client_key_exchange_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += client_key_exchange_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length + master_secret_hash_length + client_key_exchange_length) {
    u_int16_t server_key_exchange_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length + master_secret_hash_length + client_key_exchange_length]));
    offset += 2;

    if(server_key_exchange_length > 0) {
      for(i = 0; i < server_key_exchange_length; i++) {
        ja3_str[i + ja3_str_len] = packet->payload[offset + i];
      }

      ja3_str_len += server_key_exchange_length;
    }
  }

  if(ja3_str_len > 0) {
    ja3_str[ja3_str_len] = '\0';
    ja3.tls_handshake_string = strdup(ja3_str);
  }

  if(packet->payload_packet_len >= 34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length + master_secret_hash_length + client_key_exchange_length + server_key_exchange_length) {
    u_int16_t certificate_request_length = ntohs(*((u_int16_t*)&packet->payload[34 + extension_len + 2 + cipher_suite_count * 2 + extension_count * 4 + master_secret_length + client_random_length + server_random_length + key_exchange_length + change_cipher_spec_length + finished_length + master_secret_hash_length + client_key_exchange_length + server_key_exchange_length]));
    offset += 2;

    if(certificate_request_length > 0) {
      for(i = 0; i < certificate_request_length;