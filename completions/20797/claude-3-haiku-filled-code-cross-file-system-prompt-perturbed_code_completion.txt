// <MASK>
    {
      u_int16_t cipher_suites_len = (packet->payload[offset + session_id_len + 2] << 8) +
                                   packet->payload[offset + session_id_len + 3];
      u_int16_t cipher_suites_offset = offset + session_id_len + 4;
      u_int16_t extensions_len;
      u_int16_t extensions_offset;

      if(handshake_type == 0x02 /* Server Hello */) {
        u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[cipher_suites_offset]));
        flow->protos.stun_ssl.ssl.server_cipher_suite = cipher_suite;

        extensions_len = (packet->payload[cipher_suites_offset + cipher_suites_len + 2] << 8) +
                         packet->payload[cipher_suites_offset + cipher_suites_len + 3];
        extensions_offset = cipher_suites_offset + cipher_suites_len + 4;
      } else {
        extensions_len = (packet->payload[cipher_suites_offset + cipher_suites_len + 2] << 8) +
                         packet->payload[cipher_suites_offset + cipher_suites_len + 3];
        extensions_offset = cipher_suites_offset + cipher_suites_len + 4;
      }

      ja3_str_len = 0;
      ja3.tls_handshake_version = tls_version;

      for(i = 0; i < cipher_suites_len; i += 2) {
        u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[cipher_suites_offset + i]));

        if(cipher_suite != 0x00a8 /* GREASE */) {
          ja3.tls_cipher_suites[ja3.num_tls_cipher_suites++] = cipher_suite;
          snprintf(buffer, sizeof(buffer), "%04x", cipher_suite);
          strcat(ja3_str, buffer);
        }
      }

      while(extensions_offset < (cipher_suites_offset + cipher_suites_len + extensions_len)) {
        u_int16_t extension_type = ntohs(*((u_int16_t*)&packet->payload[extensions_offset]));
        extension_len = ntohs(*((u_int16_t*)&packet->payload[extensions_offset + 2]));

        if(extension_type != 0x0a0a /* GREASE */) {
          ja3.tls_extensions[ja3.num_tls_extensions++] = extension_type;
          snprintf(buffer, sizeof(buffer), "_%04x", extension_type);
          strcat(ja3_str, buffer);
        }

        extensions_offset += 4 + extension_len;
      }

      ndpi_MD5_Init(&ctx);
      ndpi_MD5_Update(&ctx, ja3_str, strlen(ja3_str));
      ndpi_MD5_Final(md5_hash, &ctx);

      if(handshake_type == 0x01 /* Client Hello */) {
        memcpy(flow->protos.stun_ssl.ssl.ja3_client, md5_hash, sizeof(md5_hash));
      } else {
        memcpy(flow->protos.stun_ssl.ssl.ja3_server, md5_hash, sizeof(md5_hash));
      }

      return(handshake_type);
    }
// </MASK>