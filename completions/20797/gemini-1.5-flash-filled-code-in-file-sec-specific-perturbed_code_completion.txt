offset += session_id_len + 1;

    ja3.num_cipher = (packet->payload[offset] << 8) + packet->payload[offset+1];
    offset += 2;

    if(ja3.num_cipher > MAX_NUM_JA3) jainvalid = 1;
    else for(j=0; j<ja3.num_cipher; j++) {
      ja3.cipher[j] = (packet->payload[offset] << 8) + packet->payload[offset+1];
      offset += 2;
    }

    if(packet->tcp) {
      extension_len = (packet->payload[offset] << 8) + packet->payload[offset+1];
      offset += 2;

      if(extension_len > 0) {
	while(offset < (base_offset + extension_len)) {
	  u_int16_t extension_type = (packet->payload[offset] << 8) + packet->payload[offset+1];
	  u_int16_t extension_len = (packet->payload[offset+2] << 8) + packet->payload[offset+3];

	  if(extension_type == 0x000a) { /* Supported Versions */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x000b) { /* Signature Algorithms */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x000c) { /* Elliptic Curves */
	    ja3.num_elliptic_curve = (packet->payload[offset+4] << 8) + packet->payload[offset+5];
	    offset += 6;

	    if(ja3.num_elliptic_curve > MAX_NUM_JA3) jainvalid = 1;
	    else for(j=0; j<ja3.num_elliptic_curve; j++) {
	      ja3.elliptic_curve[j] = (packet->payload[offset] << 8) + packet->payload[offset+1];
	      offset += 2;
	    }
	  } else if(extension_type == 0x000d) { /* Elliptic Curve Point Formats */
	    ja3.num_elliptic_curve_point_format = packet->payload[offset+4];
	    offset += 5;

	    if(ja3.num_elliptic_curve_point_format > MAX_NUM_JA3) jainvalid = 1;
	    else for(j=0; j<ja3.num_elliptic_curve_point_format; j++) {
	      ja3.elliptic_curve_point_format[j] = packet->payload[offset+j];
	    }
	  } else {
	    offset += extension_len + 4;
	  }
	}
      }
    }

    if(jainvalid == 0) {
      ja3_str_len = snprintf(ja3_str, JA3_STR_LEN, "%u", ja3.tls_handshake_version);
      for(i=0; i<ja3.num_cipher; i++) ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN-ja3_str_len, "-%u", ja3.cipher[i]);
      for(i=0; i<ja3.num_tls_extension; i++) ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN-ja3_str_len, "-%u", ja3.tls_extension[i]);
      for(i=0; i<ja3.num_elliptic_curve; i++) ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN-ja3_str_len, "-%u", ja3.elliptic_curve[i]);
      for(i=0; i<ja3.num_elliptic_curve_point_format; i++) ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN-ja3_str_len, "-%u", ja3.elliptic_curve_point_format[i]);

      ndpi_MD5Init(&ctx);
      ndpi_MD5Update(&ctx, ja3_str, ja3_str_len);
      ndpi_MD5Final(md5_hash, &ctx);

      for(i=0; i<16; i++)
	snprintf(&buffer[i*2], 3, "%02X", md5_hash[i]);

      snprintf(flow->protos.stun_ssl.ssl.ja3_fingerprint, sizeof(flow->protos.stun_ssl.ssl.ja3_fingerprint), "%s", buffer);
    }
  }