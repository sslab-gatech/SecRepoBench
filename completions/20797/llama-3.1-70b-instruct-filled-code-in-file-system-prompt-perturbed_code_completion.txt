if(handshake_type == 0x02 /* Server Hello */) {
  offset += 2 + session_id_len;
  extension_len = (packet->payload[offset] << 8) + packet->payload[offset+1];
  offset += 2;

  if(extension_len > 0) {
    while(extension_len > 0) {
      u_int16_t extension_type = (packet->payload[offset] << 8) + packet->payload[offset+1];
      u_int16_t extension_len2 = (packet->payload[offset+2] << 8) + packet->payload[offset+3];
      offset += 4;

      if(extension_len2 > 0) {
	if(extension_type == 0x0000) { /* server_name */
	  u_int8_t list_len = packet->payload[offset+2];
	  offset += 3;

	  if(list_len > 0) {
	    u_int8_t type = packet->payload[offset+1];
	    u_int16_t len = (packet->payload[offset+2] << 8) + packet->payload[offset+3];
	    offset += 4;

	    if(type == 0x00) { /* host_name */
	      u_int len2 = (u_int)ndpi_min(len, sizeof(buffer)-1);
	      strncpy(buffer, (const char*)&packet->payload[offset], len2);
	      buffer[len2] = '\0';

	      cleanupServerName(buffer, len2);

	      if(flow->protos.stun_ssl.ssl.server_names == NULL)
		flow->protos.stun_ssl.ssl.server_names = ndpi_strdup(buffer),
		  flow->protos.stun_ssl.ssl.server_names_len = strlen(buffer);
	      else {
		u_int16_t newstr_len = flow->protos.stun_ssl.ssl.server_names_len + len2 + 1;
		char *newstr = (char*)ndpi_realloc(flow->protos.stun_ssl.ssl.server_names,
						   flow->protos.stun_ssl.ssl.server_names_len+1, newstr_len+1);

		if(newstr) {
		  flow->protos.stun_ssl.ssl.server_names = newstr;
		  flow->protos.stun_ssl.ssl.server_names[flow->protos.stun_ssl.ssl.server_names_len] = ',';
		  strncpy(&flow->protos.stun_ssl.ssl.server_names[flow->protos.stun_ssl.ssl.server_names_len+1],
			  buffer, len2+1);
		  flow->protos.stun_ssl.ssl.server_names[newstr_len] = '\0';
		  flow->protos.stun_ssl.ssl.server_names_len = newstr_len;
		}
	      }

	      if(!flow->l4.tcp.tls.subprotocol_detected)
		if(ndpi_match_hostname_protocol(ndpi_struct, flow, NDPI_PROTOCOL_TLS, buffer, len2))
		  flow->l4.tcp.tls.subprotocol_detected = 1;
	    }
	  }
	} else if(extension_type == 0x000d) { /* signature_algorithms */
	  u_int16_t len2 = (packet->payload[offset+1] << 8) + packet->payload[offset+2];
	  offset += 3;

	  if(len2 > 0) {
	    for(j=0; j<len2; j+=2) {
	      if(j+1 < len2) {
		u_int16_t alg = (packet->payload[offset+j] << 8) + packet->payload[offset+j+1];

		if(ja3.num_tls_extension < MAX_NUM_JA3)
		  ja3.tls_extension[ja3.num_tls_extension++] = alg;
	      }
	    }
	  }
	} else if(extension_type == 0x0017) { /* extended_master_secret */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0005) { /* status_request */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x002b) { /* supported_versions */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x000f) { /* heartbeat */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x002a) { /* supported_groups */
	  u_int16_t len2 = (packet->payload[offset+1] << 8) + packet->payload[offset+2];
	  offset += 3;

	  if(len2 > 0) {
	    for(j=0; j<len2; j+=2) {
	      if(j+1 < len2) {
		u_int16_t alg = (packet->payload[offset+j] << 8) + packet->payload[offset+j+1];

		if(ja3.num_elliptic_curve < MAX_NUM_JA3)
		  ja3.elliptic_curve[ja3.num_elliptic_curve++] = alg;
	      }
	    }
	  }
	} else if(extension_type == 0x001d) { /* application_layer_protocol_negotiation */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0018) { /* signed_certificate_timestamp */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0033) { /* key_share */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x002f) { /* renegotiation_info */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x000b) { /* ec_point_formats */
	  if(ja3.num_elliptic_curve_point_format < MAX_NUM_JA3)
	    ja3.elliptic_curve_point_format[ja3.num_elliptic_curve_point_format++] = extension_type;
	} else if(extension_type == 0x0023) { /* session_ticket */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x000a) { /* status_request_v2 */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0014) { /* next_protocol_negotiation */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0015) { /* channel_id */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0016) { /* ticket_pinning */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0019) { /* application_layer_protocol_settings */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0022) { /* padding */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0010) { /* alpn */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0012) { /* extended_master_secret */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0013) { /* session_ticket */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0024) { /* supported_versions */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0025) { /* cookie */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0026) { /* psk_key_exchange_modes */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0028) { /* certificate_authorities */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0029) { /* oid_filters */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0030) { /* post_handshake_auth */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0031) { /* signature_algorithms_cert */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0032) { /* key_share */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0034) { /* renegotiation_info */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0035) { /* compress_certificate */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0036) { /* record_size_limit */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0037) { /* pwd_protect */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0038) { /* password_salt */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0039) { /* ticket_pinning */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x003a) { /* tls_cert_with_extern_psk */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x003b) { /* delegated_credentials */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x003c) { /* application_layer_protocol_settings */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x003d) { /* cookie */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x003e) { /* psk_key_exchange_modes */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x003f) { /* certificate_authorities */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0040) { /* oid_filters */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0041) { /* post_handshake_auth */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;
	} else if(extension_type == 0x0042) { /* signature_algorithms_cert */
	  if(ja3.num_tls_extension < MAX_NUM_JA3)
	    ja3.tls_extension[ja3.num_tls_extension++] = extension_type;