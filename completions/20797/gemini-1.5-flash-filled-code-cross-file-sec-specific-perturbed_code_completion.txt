offset += session_id_len + 4;
    ja3_str_len = 0;

    for (j = 0; j < 32; j++) {
      if (offset + 2 > total_len) break;
      u_int16_t cipher_suite = ntohs(*((u_int16_t*)&packet->payload[offset]));
      if (cipher_suite == 0) break;
      ja3_str[ja3_str_len++] = (cipher_suite >> 8) & 0xFF;
      ja3_str[ja3_str_len++] = cipher_suite & 0xFF;
      offset += 2;
    }

    ja3_str[ja3_str_len] = '\0';
    ja3.cipher_suites = ja3_str;
    ja3.cipher_suites_len = ja3_str_len;

    ndpi_MD5Init(&ctx);
    ndpi_MD5Update(&ctx, &ja3.tls_handshake_version, sizeof(ja3.tls_handshake_version));
    ndpi_MD5Update(&ctx, ja3.cipher_suites, ja3.cipher_suites_len);
    ndpi_MD5Final(md5_hash, &ctx);

    for (i = 0; i < 16; i++) {
      sprintf(&buffer[i * 2], "%02X", md5_hash[i]);
    }
    buffer[32] = '\0';
    flow->l4.tcp.tls.ja3_hash = buffer;
    return (1);