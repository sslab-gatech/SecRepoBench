{
      /* Server Hello */
      offset += 1 + session_id_len; /* Skip session ID length and session ID */
      ja3.cipher = ntohs(*((u_int16_t*)&packet->payload[offset]));
      offset += 2; /* Skip cipher suite */
      offset += 1; /* Skip compression method */

      extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
      offset += 2;

      for(j = 0; j < extension_len;) {
        u_int16_t ext_type = ntohs(*((u_int16_t*)&packet->payload[offset + j]));
        u_int16_t ext_len = ntohs(*((u_int16_t*)&packet->payload[offset + j + 2]));

        if((ext_type == 0x0) || (ext_len == 0)) {
          jainvalid = 1;
          break;
        }

        if(ext_type != 0x0a /* Supported Groups */
           && ext_type != 0x0b /* EC Point Formats */
           && ext_type != 0x23 /* Session Ticket */
           && ext_type != 0x33 /* Key Share */
           && ext_type != 0x2b /* Supported Versions */
           && ext_type != 0x2d /* PSK Key Exchange Modes */
           && ext_type != 0x39 /* Post-Handshake Auth */
           && ext_type != 0x3a /* Signature Algorithms Cert */
           && ext_type != 0x3b /* Key Share Old */) {
          ja3.extensions[ja3.extensions_count++] = ext_type;
        }

        j += 4 + ext_len;
      }
    } else if(handshake_type == 0x01 /* Client Hello */) {
      /* Client Hello */
      offset += 2; /* Skip version */
      offset += 32; /* Skip random */
      offset += 1 + session_id_len; /* Skip session ID length and session ID */

      u_int16_t cipher_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
      offset += 2;

      for(i = 0; i < cipher_len; i += 2) {
        u_int16_t cipher = ntohs(*((u_int16_t*)&packet->payload[offset + i]));

        if((cipher & 0x0f0f) != 0x0a0a) /* Skip GREASE values */
          ja3.ciphers[ja3.ciphers_count++] = cipher;
      }

      offset += cipher_len;
      offset += 1; /* Skip compression methods length */

      extension_len = ntohs(*((u_int16_t*)&packet->payload[offset]));
      offset += 2;

      for(j = 0; j < extension_len;) {
        u_int16_t ext_type = ntohs(*((u_int16_t*)&packet->payload[offset + j]));
        u_int16_t ext_len = ntohs(*((u_int16_t*)&packet->payload[offset + j + 2]));

        if((ext_type == 0x0) || (ext_len == 0)) {
          jainvalid = 1;
          break;
        }

        if(ext_type != 0x0a /* Supported Groups */
           && ext_type != 0x0b /* EC Point Formats */
           && ext_type != 0x23 /* Session Ticket */
           && ext_type != 0x33 /* Key Share */
           && ext_type != 0x2b /* Supported Versions */
           && ext_type != 0x2d /* PSK Key Exchange Modes */
           && ext_type != 0x39 /* Post-Handshake Auth */
           && ext_type != 0x3a /* Signature Algorithms Cert */
           && ext_type != 0x3b /* Key Share Old */) {
          ja3.extensions[ja3.extensions_count++] = ext_type;
        }

        j += 4 + ext_len;
      }
    }

    if(jainvalid == 0) {
      /* Construct JA3 string */
      snprintf(ja3_str, sizeof(ja3_str), "%u,", ja3.tls_handshake_version);

      for(i = 0; i < ja3.ciphers_count; i++) {
        snprintf(buffer, sizeof(buffer), "%s%u", (i > 0) ? "-" : "", ja3.ciphers[i]);
        strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);
      }

      strncat(ja3_str, ",", sizeof(ja3_str) - strlen(ja3_str) - 1);

      for(i = 0; i < ja3.extensions_count; i++) {
        snprintf(buffer, sizeof(buffer), "%s%u", (i > 0) ? "-" : "", ja3.extensions[i]);
        strncat(ja3_str, buffer, sizeof(ja3_str) - strlen(ja3_str) - 1);
      }

      /* Compute MD5 hash */
      ndpi_MD5_Init(&ctx);
      ndpi_MD5_Update(&ctx, ja3_str, strlen(ja3_str));
      ndpi_MD5_Final(md5_hash, &ctx);

      memcpy(flow->protos.stun_ssl.ssl.ja3_hash, md5_hash, sizeof(md5_hash));
      flow->protos.stun_ssl.ssl.ja3_hash_set = 1;

#ifdef DEBUG_TLS
      printf("JA3 String: %s\n", ja3_str);
      printf("JA3 Hash: ");
      for(i = 0; i < sizeof(md5_hash); i++)
        printf("%02x", md5_hash[i]);
      printf("\n");
#endif

      return(handshake_type == 0x01 ? 1 : 2); /* 1 for Client Hello, 2 for Server Hello */
    }