offset += session_id_len + 1;

    ja3.num_cipher = (packet->payload[offset] << 8) + packet->payload[offset+1];
    offset += 2;

    if(ja3.num_cipher > MAX_NUM_JA3) {
      jainvalid = 1;
    } else {
      for(j=0; j<ja3.num_cipher; j++) {
	ja3.cipher[j] = (packet->payload[offset] << 8) + packet->payload[offset+1];
	offset += 2;
      }
    }

    if(packet->tcp) {
      extension_len = (packet->payload[offset] << 8) + packet->payload[offset+1];
      offset += 2;

      if(extension_len > 0) {
	while(offset < (base_offset + extension_len)) {
	  u_int16_t extension_type = (packet->payload[offset] << 8) + packet->payload[offset+1];
	  u_int16_t extension_len2 = (packet->payload[offset+2] << 8) + packet->payload[offset+3];

	  if(extension_type == 0x000a) { /* Supported Versions */
	    if(extension_len2 >= 2) {
	      ja3.num_tls_extension++;
	      ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	    }
	  } else if(extension_type == 0x000b) { /* Signature Algorithms */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x000c) { /* Use SRP */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x000d) { /* Use ECDSA */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x0010) /* Supported Groups */
	    ja3.num_tls_extension++;
	  else if(extension_type == 0x0017) { /* Renegotiation Info */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x001d) { /* Session Ticket */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x0023) { /* Extended Master Secret */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x002b) { /* Signed Certificate Timestamp */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x0033) { /* Certificate Status Request */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x0035) { /* Certificate Transparency */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x0067) { /* Application Layer Protocol Negotiation */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x006a) { /* Status Request */
	    ja3.num_tls_extension++;
	    ja3.tls_extension[ja3.num_tls_extension-1] = extension_type;
	  } else if(extension_type == 0x0080) { /* Supported Elliptic Curves */
	    ja3.num_elliptic_curve = extension_len2 / 2;
	    for(i = 0; i < ja3.num_elliptic_curve; i++) {
	      ja3.elliptic_curve[i] = (packet->payload[offset+4+i*2] << 8) + packet->payload[offset+5+i*2];
	    }
	  } else if(extension_type == 0x0081) { /* Elliptic Curve Point Formats */
	    ja3.num_elliptic_curve_point_format = extension_len2;
	    for(i = 0; i < ja3.num_elliptic_curve_point_format; i++) {
	      ja3.elliptic_curve_point_format[i] = packet->payload[offset+4+i];
	    }
	  }

	  offset += extension_len2 + 4;
	}
      }
    }

    if(jainvalid == 0) {
      ja3_str_len = snprintf(ja3_str, JA3_STR_LEN, "%u", ja3.tls_handshake_version);
      for(i=0; i<ja3.num_cipher; i++) {
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.cipher[i]);
      }
      for(i=0; i<ja3.num_tls_extension; i++) {
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.tls_extension[i]);
      }
      for(i=0; i<ja3.num_elliptic_curve; i++) {
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.elliptic_curve[i]);
      }
      for(i=0; i<ja3.num_elliptic_curve_point_format; i++) {
	ja3_str_len += snprintf(&ja3_str[ja3_str_len], JA3_STR_LEN - ja3_str_len, "-%u", ja3.elliptic_curve_point_format[i]);
      }

      ndpi_MD5Init(&ctx);
      ndpi_MD5Update(&ctx, ja3_str, ja3_str_len);
      ndpi_MD5Final(md5_hash, &ctx);

      for(i=0; i<16; i++) {
	snprintf(&buffer[i*2], 3, "%02X", md5_hash[i]);
      }

      snprintf(flow->protos.stun_ssl.ssl.ja3_fingerprint, sizeof(flow->protos.stun_ssl.ssl.ja3_fingerprint), "%s", buffer);
    }
  }