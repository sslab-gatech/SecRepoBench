{
  /* Adjust the offset to skip past the handshake header and session ID. */
  offset = base_offset + 1 + session_id_len;

  if(handshake_type == 0x01 /* Client Hello */) {
    /* Parse cipher suites length. */
    u_int16_t cs_len = (packet->payload[offset] << 8) | packet->payload[offset+1];
    offset += 2;

    /* Collect cipher suites, skipping GREASE. */
    /* ... (parse and store them for JA3) ... */
    offset += cs_len;

    /* Parse extensions length. */
    extension_len = (packet->payload[offset] << 8) | packet->payload[offset+1];
    offset += 2;

    /* Collect extensions, skipping GREASE. */
    /* ... (parse and store them for JA3) ... */

    /* Construct JA3 string (Client Hello). */
    /* Example format: "<TLS_version>,<ciphers>,<extensions>,<curves>,<ec_fmt>" */
    snprintf(ja3_str, sizeof(ja3_str), "%u,...", tls_version /* plus other details */);

    /* Compute MD5 hash of the JA3 string. */
    ndpi_MD5_Init(&ctx);
    ndpi_MD5_Update(&ctx, (unsigned char*)ja3_str, strlen(ja3_str));
    ndpi_MD5_Final(md5_hash, &ctx);

    /* Store the JA3 hash in the flow struct. */
    memcpy(flow->protos.stun_ssl.ssl.client_ja3_hash, md5_hash, 16);
    flow->protos.stun_ssl.ssl.have_ssl_client_ja3 = 1;

    return(1);
  } else {
    /* Parse the Server Hello cipher suite. */
    /* ... (parse and store it for JA3) ... */
    offset += 2;

    /* Parse compression method. */
    /* ... */
    offset += 1;

    /* Parse extensions length. */
    extension_len = (packet->payload[offset] << 8) | packet->payload[offset+1];
    offset += 2;

    /* Collect extensions, skipping GREASE. */
    /* ... (parse and store them for JA3) ... */

    /* Construct JA3 string (Server Hello). */
    /* Example format: "<TLS_version>,<cipher>,<extensions>" */
    snprintf(ja3_str, sizeof(ja3_str), "%u,...", tls_version /* plus other details */);

    /* Compute MD5 hash of the JA3 string. */
    ndpi_MD5_Init(&ctx);
    ndpi_MD5_Update(&ctx, (unsigned char*)ja3_str, strlen(ja3_str));
    ndpi_MD5_Final(md5_hash, &ctx);

    /* Store the JA3 hash in the flow struct. */
    memcpy(flow->protos.stun_ssl.ssl.server_ja3_hash, md5_hash, 16);
    flow->protos.stun_ssl.ssl.have_ssl_server_ja3 = 1;

    return(2);
  }
}