if (*InputFmt == 0 && *OutputFormat == 0) {
        p->FromInput = _cmsGetFormatter(ContextID, *InputFmt, cmsFormatterInput, CMS_PACK_FLAGS_16BITS).Fmt16;
        p->ToOutput = _cmsGetFormatter(ContextID, *OutputFormat, cmsFormatterOutput, CMS_PACK_FLAGS_16BITS).Fmt16;
        *dwFlags |= cmsFLAGS_CAN_CHANGE_FORMATTER;

        if (p->FromInput == NULL || p->ToOutput == NULL) {
            cmsSignalError(ContextID, cmsERROR_UNKNOWN_EXTENSION, "Unsupported raster format");
            cmsDeleteTransform(p);
            return NULL;
        }

        if (*dwFlags & cmsFLAGS_NULLTRANSFORM) {
            p->xform = NullXFORM;
        } else {
            if (*dwFlags & cmsFLAGS_NOCACHE) {
                if (*dwFlags & cmsFLAGS_GAMUTCHECK)
                    p->xform = PrecalculatedXFORMGamutCheck;  // Gamut check, no cache
                else
                    p->xform = PrecalculatedXFORM;  // No cache, no gamut check
            } else {
                if (*dwFlags & cmsFLAGS_GAMUTCHECK)
                    p->xform = CachedXFORMGamutCheck;    // Gamut check, cache
                else
                    p->xform = CachedXFORM;  // No gamut check, cache
            }
        }
    } else {
        p->FromInput = _cmsGetFormatter(ContextID, *InputFmt, cmsFormatterInput, CMS_PACK_FLAGS_16BITS).Fmt16;
        p->ToOutput = _cmsGetFormatter(ContextID, *OutputFormat, cmsFormatterOutput, CMS_PACK_FLAGS_16BITS).Fmt16;
        *dwFlags |= cmsFLAGS_CAN_CHANGE_FORMATTER;

        if (p->FromInput == NULL || p->ToOutput == NULL) {
            cmsSignalError(ContextID, cmsERROR_UNKNOWN_EXTENSION, "Unsupported raster format");
            cmsDeleteTransform(p);
            return NULL;
        }

        if (*dwFlags & cmsFLAGS_NULLTRANSFORM) {
            p->xform = NullXFORM;
        } else {
            if (*dwFlags & cmsFLAGS_NOCACHE) {
                if (*dwFlags & cmsFLAGS_GAMUTCHECK)
                    p->xform = PrecalculatedXFORMGamutCheck;  // Gamut check, no cache
                else
                    p->xform = PrecalculatedXFORM;  // No cache, no gamut check
            } else {
                if (*dwFlags & cmsFLAGS_GAMUTCHECK)
                    p->xform = CachedXFORMGamutCheck;    // Gamut check, cache
                else
                    p->xform = CachedXFORM;  // No gamut check, cache
            }
        }
    }