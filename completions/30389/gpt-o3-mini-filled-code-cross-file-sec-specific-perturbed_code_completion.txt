if (prev_offset + len > crypto_data_len) {
  NDPI_LOG_DBG(detectionmodule, "Tag data goes past crypto_data_len, aborting tag processing\n");
  break;
}

if (tag[0] == 'S' && tag[1] == 'N' && tag[2] == 'I' && tag[3] == '\0') {
  /* Process SNI tag */
  size_t sni_buf_size = sizeof(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name);
  size_t copy_len = (len < sni_buf_size - 1) ? len : sni_buf_size - 1;

  memcpy(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name,
         crypto_data + prev_offset,
         copy_len);
  flow->protos.tls_quic_stun.tls_quic.client_requested_server_name[copy_len] = '\0';

  NDPI_LOG_DBG(detectionmodule, "CHLO SNI: %s\n",
               flow->protos.tls_quic_stun.tls_quic.client_requested_server_name);

  /* Place for subprotocol matching and DGA check if applicable */
  sni_found = 1;
} else if (tag[0] == 'U' && tag[1] == 'A' && tag[2] == 'I' && tag[3] == 'D') {
  /* Process UAID tag */
  NDPI_LOG_DBG(detectionmodule, "CHLO UAID: %.*s\n", len, crypto_data + prev_offset);

  /* Call HTTP user agent handling function */
  process_http_user_agent(detectionmodule, flow, crypto_data + prev_offset, len);
  ua_found = 1;
}

if (sni_found && ua_found) {
  break;
}