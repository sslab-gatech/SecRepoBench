if(tag_offset_start + prev_offset > crypto_data_len ||
   tag_offset_start + offset > crypto_data_len) {
  break; /* Avoid buffer overruns */
}

if(memcmp(tag, "SNI\0", 4) == 0 && !sni_found) {
  if(tag_offset_start + prev_offset + len <= crypto_data_len) {
    sni_found = 1;
    sni_len = len < sizeof(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name) - 1 ?
              len : sizeof(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name) - 1;
    memcpy(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name,
           &crypto_data[tag_offset_start + prev_offset], sni_len);
    flow->protos.tls_quic_stun.tls_quic.client_requested_server_name[sni_len] = '\0';
    
    NDPI_LOG_DBG2(detectionmodule, "SNI: [%s]\n", 
                  flow->protos.tls_quic_stun.tls_quic.client_requested_server_name);
    
    /* Protocol matching based on SNI */
    ndpi_match_host_subprotocol(detectionmodule, flow,
                                flow->protos.tls_quic_stun.tls_quic.client_requested_server_name,
                                strlen(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name),
                                &ret_match,
                                NDPI_PROTOCOL_QUIC);
    
    /* Check for DGA */
    ndpi_check_dga_name(detectionmodule, flow,
                       flow->protos.tls_quic_stun.tls_quic.client_requested_server_name,
                       1, 1);
    
    flow->protos.tls_quic_stun.tls_quic.hello_processed = 1;
  }
} else if(memcmp(tag, "UAID", 4) == 0 && !ua_found) {
  if(tag_offset_start + prev_offset + len <= crypto_data_len) {
    ua_found = 1;
    char ua[256];
    int ua_len = ndpi_min(len, sizeof(ua) - 1);
    
    memcpy(ua, &crypto_data[tag_offset_start + prev_offset], ua_len);
    ua[ua_len] = '\0';
    
    NDPI_LOG_DBG2(detectionmodule, "UA: [%s]\n", ua);
    
    /* Process user agent string */
    http_process_user_agent(detectionmodule, flow, (const u_int8_t *)ua, ua_len);
  }
}

/* If we've found both SNI and UA, we can stop */
if(sni_found && ua_found)
  break;