if(memcmp(tag, "SNI\0", 4) == 0 && !sni_found) {
  if(tag_offset_start + prev_offset + len <= crypto_data_len) {
    sni_len = ndpi_min(len, sizeof(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name) - 1);
    if(sni_len > 0) {
      memcpy(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name,
             &crypto_data[tag_offset_start + prev_offset], sni_len);
      flow->protos.tls_quic_stun.tls_quic.client_requested_server_name[sni_len] = '\0';
      
      NDPI_LOG_DBG2(detectionmodule, "SNI: %s\n", 
                    flow->protos.tls_quic_stun.tls_quic.client_requested_server_name);

      ndpi_match_host_subprotocol(detectionmodule, flow,
                                  (char *)flow->protos.tls_quic_stun.tls_quic.client_requested_server_name,
                                  NDPI_PROTOCOL_QUIC, &ret_match);

      if(ndpi_match_string_subprotocol(detectionmodule, flow,
                                      (char *)flow->protos.tls_quic_stun.tls_quic.client_requested_server_name, 
                                      NDPI_PROTOCOL_QUIC) != NDPI_PROTOCOL_UNKNOWN) {
        /* Subprotocol match successful */
      }

      if(detectionmodule->check_dga_name && 
         detectionmodule->check_dga_name(detectionmodule, 
                     flow, flow->protos.tls_quic_stun.tls_quic.client_requested_server_name) == 1) {
        ndpi_set_risk(detectionmodule, flow, NDPI_SUSPICIOUS_DGA_DOMAIN);
      }

      flow->protos.tls_quic_stun.tls_quic.hello_processed = 1;
      sni_found = 1;
    }
  }
} else if(memcmp(tag, "UAID", 4) == 0 && !ua_found) {
  if(tag_offset_start + prev_offset + len <= crypto_data_len) {
    uint32_t ua_len = ndpi_min(len, sizeof(flow->http.user_agent) - 1);
    if(ua_len > 0) {
      memcpy(flow->http.user_agent, &crypto_data[tag_offset_start + prev_offset], ua_len);
      flow->http.user_agent[ua_len] = '\0';
      
      NDPI_LOG_DBG2(detectionmodule, "UA: %s\n", flow->http.user_agent);
      
      ndpi_match_user_agent(detectionmodule, flow);
      ua_found = 1;
    }
  }
}

if(sni_found && ua_found) {
  return; /* Both found, no need to parse further */
}