if(memcmp(tag, "SNI\0", 4) == 0) {
  if(offset + len > crypto_data_len)
    break;
  sni_len = len - 4; // Subtract the length of "SNI\0"
  if(sni_len > sizeof(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name) - 1)
    sni_len = sizeof(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name) - 1;
  memcpy(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name, &crypto_data[offset], sni_len);
  flow->protos.tls_quic_stun.tls_quic.client_requested_server_name[sni_len] = '\0';
#ifdef QUIC_DEBUG
  NDPI_LOG_DBG(detectionmodule, "Found SNI: %s\n", flow->protos.tls_quic_stun.tls_quic.client_requested_server_name);
#endif
  ret_match = ndpi_match_host_subprotocol_only(detectionmodule, flow->protos.tls_quic_stun.tls_quic.client_requested_server_name, strlen(flow->protos.tls_quic_stun.tls_quic.client_requested_server_name));
  if(ret_match.match) {
    ndpi_set_detected_protocol(detectionmodule, flow, ret_match.protocol.app_protocol, ret_match.protocol.master_protocol, NDPI_CONFIDENCE_DPI);
  }
  ndpi_check_dga(detectionmodule, flow);
  sni_found = 1;
} else if(memcmp(tag, "UAID", 4) == 0) {
  if(offset + len > crypto_data_len)
    break;
  // Assuming the user agent string is null-terminated within the len
  const char *user_agent = (const char *)&crypto_data[offset];
  size_t user_agent_len = strnlen(user_agent, len - 4); // Subtract the length of "UAID"
#ifdef QUIC_DEBUG
  NDPI_LOG_DBG(detectionmodule, "Found User Agent: %s\n", user_agent);
#endif
  ndpi_http_handle_user_agent(detectionmodule, flow, user_agent, user_agent_len);
  ua_found = 1;
}

if(sni_found && ua_found)
  return;