if (token == 0) {
        // Invalid token, return error
        return BLOSC2_ERROR_DATA;
      }
      int run_length = token & 0x7F;  // Extract run length from token
      uint8_t run_value = (token & 0x80) ? 0xFF : 0x00;  // Determine run value based on token

      if (run_length > neblock) {
        // Run length exceeds block size, return error
        return BLOSC2_ERROR_DATA;
      }

      memset(comp_buffer, run_value, run_length);
      nbytes = run_length;
      ctbytes += 1;  // Account for the token byte
    }