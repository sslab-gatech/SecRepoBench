uint8_t token;
    uint8_t run_length = 1;
    uint8_t run_value = 0;

    if (token == 0) {
        // A run of 0's
        memset(comp_buffer, 0, (unsigned int)neblock);
        nbytes = neblock;
    } else if (token < 0) {
        // A negative number means some encoding depending on the token that comes next
        run_value = -token;
        if (run_value > neblock) {
            run_value = neblock;
        }
        memset(comp_buffer, run_value, run_value);
        nbytes = run_value;
        cbytes -= sizeof(uint8_t); // Adjust the compressed bytes counter
    } else {
        // A positive number means a direct copy
        if (token > neblock) {
            token = neblock;
        }
        memcpy(comp_buffer, src, token);
        nbytes = token;
    }
    src += sizeof(uint8_t);
    ctbytes += sizeof(uint8_t);