//
// Update code lengths and symbol processing for Huffman decoding.
// - For each symbol, determine its code length.
// - If the code length is non-zero and less than a predefined threshold,
//   update minimum and maximum code lengths and increment the count for that length.
// - If the code length indicates a short zero-code run, adjust the symbol index accordingly.
// - If it indicates a long zero-code run, read additional bits for the run length,
//   then adjust the symbol index by this computed length.
//

uint64_t codeLength =
    fasthuf_read_bits (6, &currBits, &currBitCount, &currByte);

if (codeLength < 0)
{
    if (pctxt)
        pctxt->print_error (
            pctxt,
            EXR_ERR_CORRUPT_CHUNK,
            "Error decoding Huffman table (Invalid code length).");
    return EXR_ERR_CORRUPT_CHUNK;
}

if (codeLength == 0)
{
    // do nothing
}
else if (codeLength < 6)
{
    if (codeLength < fhd->_minCodeLength)
        fhd->_minCodeLength = codeLength;

    if (codeLength > fhd->_maxCodeLength)
        fhd->_maxCodeLength = codeLength;

    codeCount[codeLength]++;
}
else if (codeLength == 59)
{
    // short zero-code run
    symbol++;
}
else if (codeLength == 60)
{
    // short zero-code run
    symbol += 2;
}
else if (codeLength == 61)
{
    // short zero-code run
    symbol += 3;
}
else if (codeLength == 62)
{
    // short zero-code run
    symbol += 4;
}
else if (codeLength == 63)
{
    // long zero-code run
    uint64_t runLength =
        fasthuf_read_bits (8, &currBits, &currBitCount, &currByte);

    if (runLength > (uint64_t) (MAX_CODE_LEN - codeLength + 1))
    {
        if (pctxt)
            pctxt->print_error (
                pctxt,
                EXR_ERR_CORRUPT_CHUNK,
                "Error decoding Huffman table (Invalid run length).");
        return EXR_ERR_CORRUPT_CHUNK;
    }

    symbol += runLength;
}
else
{
    if (symbol > (uint64_t) maxSymbol)
    {
        if (pctxt)
            pctxt->print_error (
                pctxt,
                EXR_ERR_CORRUPT_CHUNK,
                "Error decoding Huffman table (Run beyond end of table).");
        return EXR_ERR_CORRUPT_CHUNK;
    }

    if (codeLength < (uint64_t) SHORT_ZEROCODE_RUN)
    {
        if (codeLength == 0) continue;

        if (mapping[codeLength] >= (uint64_t) fhd->_numSymbols)
        {
            if (pctxt)
                pctxt->print_error (
                    pctxt,
                    EXR_ERR_CORRUPT_CHUNK,
                    "Huffman decode error (Invalid symbol in header)");
            return EXR_ERR_CORRUPT_CHUNK;
        }
        fhd->_idToSymbol[mapping[codeLength]] = symbol;
        mapping[codeLength]++;
    }
    else if (codeLength == (uint64_t) LONG_ZEROCODE_RUN)
        symbol +=
            fasthuf_read_bits (8, &currBits, &currBitCount, &currByte) +
            SHORTEST_LONG_RUN - 1;
    else
        symbol += codeLength - SHORT_ZEROCODE_RUN + 1;
}