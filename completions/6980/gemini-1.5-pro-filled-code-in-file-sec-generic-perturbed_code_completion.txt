q=subexpression;
length=0;
for (p++; *p != '\0'; )
{
  if (*p == '[')
    level++;
  else
    if (*p == ']')
      {
        level--;
        if (level == 0)
          break;
      }
  *q++=(*p++);
  length++;
}
*q='\0';
if (*subexpression == '\0')
  imageindex=0;
else
  {
    alpha=FxEvaluateSubexpression(fx_info,channel,x,y,subexpression,
      &depth,&beta,exception);
    imageindex=(ssize_t) (alpha+0.5);
  }
p++;