q=subexpression;
size_t len = 0;
for (p++; *p != '\0'; )
{
  if (*p == '[')
    level++;
  else
    if (*p == ']')
    {
      level--;
      if (level == 0)
        break;
    }
  *q++=(*p++);
  len++;
}
if (len >= MagickPathExtent)
  {
    (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
      "ExpressionTooLong","`%s'",subexpression);
    subexpression=DestroyString(subexpression);
    return(0.0);
  }

*q='\0';
alpha=FxEvaluateSubexpression(fx_info,channel,x,y,subexpression,
  &depth,&beta,exception);
imageindex=(ssize_t) (alpha+0.5);
if (*p != '\0')
  p++;