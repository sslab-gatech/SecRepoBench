{
  ssize_t sub_level = 1;
  q = subexpression;
  p++;  /* Skip the initial '[' */
  while (*p != '\0') {
    if (*p == '[')
      sub_level++;
    else if (*p == ']') {
      sub_level--;
      if (sub_level == 0) {
        p++;  /* Skip the closing ']' */
        break;
      }
    }
    if ((q - subexpression) < (MagickPathExtent - 1))
      *q++ = *p++;
    else
      p++;  /* Prevent buffer overflow: discard extra characters */
  }
  *q = '\0';
  alpha = FxEvaluateSubexpression(fx_info, channel, x, y, subexpression, &depth, &beta, exception);
  imageindex = (ssize_t) alpha;
}