/*
  FxEvaluateChannelExpression() evaluates an expression and returns the
  results.

  The format of the FxEvaluateExpression method is:

      double FxEvaluateChannelExpression(FxInfo *fx_info,
        const PixelChannel channel,const ssize_t x,const ssize_t y,
        double *alpha,Exceptioninfo *exception)
      double FxEvaluateExpression(FxInfo *fx_info,
        double *alpha,Exceptioninfo *exception)

  A description of each parameter follows:

    o fx_info: the fx info.

    o channel: the channel.

    o x, y: the pixel position.

    o alpha: the result.

    o exception: return any errors or warnings in this structure.

*/

static double FxEvaluateChannelExpression(FxInfo *fx_info,
  const PixelChannel channel,const ssize_t x,const ssize_t y,
  double *alpha,ExceptionInfo *exception)
{
  char
    fx_op[2];

  const Image
    *next;

  FxInfo
    *fx_info;

  register ssize_t
    i;

  fx_info = AcquireFxInfo(images, expression, exception);
  if (fx_info == (FxInfo *) NULL)
    return 0.0;

  fx_info->images = images;
  fx_info->expression = expression;
  fx_info->file = stderr;

  // Compact string
  (void) SubstituteString(&fx_info->expression, " ", "");

  // Force right-to-left associativity for unary negation.
  (void) SubstituteString(&fx_info->expression, "-", "-1.0*");
  (void) SubstituteString(&fx_info->expression, "^-1.0*", "^-");
  (void) SubstituteString(&fx_info->expression, "E-1.0*", "E-");
  (void) SubstituteString(&fx_info->expression, "e-1.0*", "e-");

  // Convert compound to simple operators.
  fx_op[1] = '\0';
  *fx_op = (char) LeftShiftOperator;
  (void) SubstituteString(&fx_info->expression, "<<", fx_op);
  *fx_op = (char) RightShiftOperator;
  (void) SubstituteString(&fx_info->expression, ">>", fx_op);
  *fx_op = (char) LessThanEqualOperator;
  (void) SubstituteString(&fx_info->expression, "<=", fx_op);
  *fx_op = (char) GreaterThanEqualOperator;
  (void) SubstituteString(&fx_info->expression, ">=", fx_op);
  *fx_op = (char) EqualOperator;
  (void) SubstituteString(&fx_info->expression, "==", fx_op);
  *fx_op = (char) NotEqualOperator;
  (void) SubstituteString(&fx_info->expression, "!=", fx_op);
  *fx_op = (char) LogicalAndOperator;
  (void) SubstituteString(&fx_info->expression, "&&", fx_op);
  *fx_op = (char) LogicalOrOperator;
  (void) SubstituteString(&fx_info->expression, "||", fx_op);
  *fx_op = (char) ExponentialNotation;
  (void) SubstituteString(&fx_info->expression, "**", fx_op);

  return fx_info;
}