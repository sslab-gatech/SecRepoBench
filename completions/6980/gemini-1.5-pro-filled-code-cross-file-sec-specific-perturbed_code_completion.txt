level++;
q=subexpression;
for (p++; *p != '\0'; )
{
  if (*p == '[')
    level++;
  else
    if (*p == ']')
      {
        level--;
        if (level == 0)
          break;
      }
  if (q - subexpression < MagickPathExtent - 1)  // Check for buffer overflow
    *q++ = *p++;
  else {
    (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
        "SubexpressionTooLong","`%s'",expression);
    return(0.0);
  }
}
*q='\0';
if (*p != '\0')  // Ensure there's a closing bracket
  p++;
else {
  (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
      "UnbalancedBracket","`%s'",expression);
  return(0.0);
}

alpha=FxEvaluateSubexpression(fx_info,channel,x,y,subexpression,
  &depth,&beta,exception);
imageindex=(ssize_t) alpha;