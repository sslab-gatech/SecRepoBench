cmsUInt32Number n;

// Search for given tag in ICC profile directory
n = _cmsSearchTag(Icc, sig, TRUE);
if (n < 0) goto Error;                 // Not found, 

// It is already read?
if (Icc -> TagPtrs[n] == NULL) {

    // Not yet, get original position
    Offset   = Icc ->TagOffsets[n];
    TagSize  = Icc ->TagSizes[n];

    // read the data directly, don't keep copy
    if (data!= NULL) {

        if (BufferSize < TagSize)
            TagSize = BufferSize;

        if (!Icc ->IOhandler ->Seek(Icc ->IOhandler, Offset)) goto Error;
        if (!Icc ->IOhandler ->Read(Icc ->IOhandler, data, 1, TagSize)) goto Error;

        _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
        return TagSize;
    }

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return Icc ->TagSizes[n];
}

// The data has been already read, or written. But wait!, maybe the user chose to save as
// raw data. In this case, return the raw data directly
if (Icc ->TagSaveAsRaw[n]) {

    if (data!= NULL)  {

        TagSize  = Icc ->TagSizes[n];
        if (BufferSize < TagSize)
            TagSize = BufferSize;

        memmove(data, Icc ->TagPtrs[n], TagSize);

        _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
        return TagSize;
    }

    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return Icc ->TagSizes[n];
}

// Already read, or previously set by cmsWriteTag(). We need to serialize that
// data to raw in order to maintain consistency.

_cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
Object = cmsReadTag(hProfile, sig);
if (!_cmsLockMutex(Icc->ContextID, Icc ->UsrMutex)) return 0;

if (Object == NULL) goto Error;

// Now we need to serialize to a memory block: just use a memory iohandler

if (data == NULL) {
    MemIO = cmsOpenIOhandlerFromNULL(cmsGetProfileContextID(hProfile));
} else{
    MemIO = cmsOpenIOhandlerFromMem(cmsGetProfileContextID(hProfile), data, BufferSize, "w");
}
if (MemIO == NULL) goto Error;

// Obtain type handling for the tag
TypeHandler = Icc ->TagTypeHandlers[n];
TagDescriptor = _cmsGetTagDescriptor(Icc-> ContextID, sig);
if (TagDescriptor == NULL) {
    cmsCloseIOhandler(MemIO);
    goto Error;
}
    
if (TypeHandler == NULL) goto Error;

// Serialize
LocalTypeHandler = *TypeHandler;
LocalTypeHandler.ContextID  = Icc ->ContextID;
LocalTypeHandler.ICCVersion = Icc ->Version;

if (!_cmsWriteTypeBase(MemIO, TypeHandler ->Signature)) {
    cmsCloseIOhandler(MemIO);
    goto Error;
}

if (!LocalTypeHandler.WritePtr(&LocalTypeHandler, MemIO, Object, TagDescriptor ->ElemCount)) {
    cmsCloseIOhandler(MemIO);
    goto Error;
}

// Get Size and close
rc = MemIO ->Tell(MemIO);
cmsCloseIOhandler(MemIO);      // Ignore return code this time

_cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
return rc;

Error:
_cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
return 0;