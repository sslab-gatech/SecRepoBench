{
  register const unsigned char
    *p;

  if (length != 0)
    {
      /*
        Check if the XMP profile contains the string "dc:format=\"image/dng\"".
      */
      p=profile;
      if ((length > 28) && (LocaleNCompare((const char *) p,"<?xpacket begin=",15) == 0))
        {
          p+=15;
          length-=15;
        }
      if ((length > 28) && (LocaleNCompare((const char *) p,
          "<?xpacket begin=\"",15) == 0))
        {
          p+=15;
          length-=15;
          while ((*p != '\"') && (length > 0))
          {
            p++;
            length--;
          }
          if (length != 0)
            {
              p++;
              length--;
            }
        }
      if ((length > 28) && (LocaleNCompare((const char *) p,
          "<x:xmpmeta xmlns:x=\"adobe:ns:meta/\"",34) == 0))
        (void) CopyMagickString(image->magick,"DNG",MagickPathExtent);
      else
        {
          char
            *xml_packet;

          xml_packet=(char *) NULL;
          if (~length >= MagickPathExtent)
            xml_packet=(char *) AcquireQuantumMemory(length+MagickPathExtent,
              sizeof(*xml_packet));
          if (xml_packet != (char *) NULL)
            {
              (void) CopyMagickString(xml_packet,(char *) profile,
                MagickPathExtent);
              (void) ConcatenateMagickString(xml_packet,(char *) profile+length,
                length+1);
              if (strstr(xml_packet,"dc:format=\"image/dng\"") != (char *) NULL)
                (void) CopyMagickString(image->magick,"DNG",MagickPathExtent);
              xml_packet=(char *) RelinquishMagickMemory(xml_packet);
            }
        }
    }
  (void) ReadProfile(img,"xmp",profile,(ssize_t) length,exception);
}