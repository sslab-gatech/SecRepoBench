rank - dim] = offset;
            mspace_id = H5Screate_simple(rank, size_offset_dims, NULL);
            if ( NULL != mspace_id ) {
                err = Mat_H5WriteData(dset_id, h5_type, mspace_id, space_id, isComplex, data);
                H5Sclose(mspace_id);
            } else {
                err = MATIO_E_OUT_OF_MEMORY;
            }
            free(size_offset_dims);
        } else {
            err = MATIO_E_OUT_OF_MEMORY;
        }
    } else {
        err = MATIO_E_BAD_ARGUMENT;
    }
    H5Sclose(space_id);
    H5Dclose(dset_id);

    return err;
}

static int
Mat_VarWriteEmpty(hid_t id, matvar_t *matvar, const char *name, const char *class_name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t dims[1];

    dims[0] = 0;
    type_id = H5Tcopy(H5T_C_S1);
    H5Tset_size(type_id, H5Tget_size(H5T_C_S1));
    space_id = H5Screate_simple(1, dims, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Tclose(type_id);
    H5Sclose(space_id);

    matvar->class_type = ClassStr2ClassType(class_name);
    matvar->data_type = MAT_T_UNKNOWN;
    matvar->rank = 1;
    matvar->dims = dims;
    matvar->nbytes = 0;
    matvar->data = NULL;

    return err;
}

static int
Mat_VarWriteCell73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t i, nelems;

    nelems = 1;
    for ( i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    type_id = H5Tarray_create(H5T_STD_REF_OBJ, 1, 0);
    space_id = H5Screate_simple(1, &nelems, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteChar73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    type_id = H5Tcopy(H5T_C_S1);
    H5Tset_size(type_id, H5Tget_size(H5T_C_S1));
    space_id = H5Screate_simple(1, dims, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    return err;
}

static int
Mat_WriteEmptyVariable73(hid_t id, const char *name, hsize_t rank, size_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = H5Tarray_create(H5T_STD_I32LE, 1, 0);
    space_id = H5Screate_simple(rank, dims, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    return err;
}

static int
Mat_VarWriteLogical73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    type_id = H5Tcopy(H5T_NATIVE_INT8);
    space_id = H5Screate_simple(1, dims, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    return err;
}

static int
Mat_VarWriteNumeric73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims, hsize_t *max_dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = DataType2H5T(matvar->data_type);
    space_id = H5Screate_simple(matvar->rank, dims, max_dims);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    return err;
}

static int
Mat_VarWriteAppendNumeric73(hid_t id, matvar_t *matvar, const char *name, hsize_t *dims, int dim)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = DataType2H5T(matvar->data_type);
    space_id = H5Screate_simple(matvar->rank, dims, NULL);
    dset_id = H5Dset_extent(id, dims);
    H5Sclose(space_id);
    H5Tclose(type_id);

    return err;
}

static int
Mat_VarWriteSparse73(hid_t id, matvar_t *matvar, const char *name)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t dims[2];

    dims[0] = matvar->dims[0];
    dims[1] = matvar->dims[1];

    type_id = H5Tarray_create(H5T_STD_I32LE, 1, 0);
    space_id = H5Screate_simple(2, dims, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    return err;
}

static int
Mat_VarWriteStruct73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, hsize_t *dims,
                     hsize_t *max_dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= dims[i];
    }

    type_id = H5Tcreate(H5T_COMPOUND, 0);
    space_id = H5Screate_simple(matvar->rank, dims, max_dims);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteAppendStruct73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, hsize_t *dims,
                           int dim)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = H5Tcreate(H5T_COMPOUND, 0);
    space_id = H5Screate_simple(matvar->rank, dims, NULL);
    dset_id = H5Dset_extent(id, dims);
    H5Sclose(space_id);
    H5Tclose(type_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteNext73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= matvar->dims[i];
    }

    type_id = H5Tarray_create(H5T_STD_REF_OBJ, 1, 0);
    space_id = H5Screate_simple(1, &nelems, NULL);
    dset_id = H5Dcreate(id, name, type_id, space_id, H5P_DEFAULT);
    H5Sclose(space_id);
    H5Tclose(type_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteAppendNext73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, int dim)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;
    hsize_t nelems;

    nelems = 1;
    for ( int i = 0; i < matvar->rank; i++ ) {
        nelems *= matvar->dims[i];
    }

    type_id = H5Tarray_create(H5T_STD_REF_OBJ, 1, 0);
    space_id = H5Screate_simple(1, &nelems, NULL);
    dset_id = H5Dset_extent(id, matvar->dims);
    H5Sclose(space_id);
    H5Tclose(type_id);

    *refs_id = dset_id;

    return err;
}

static int
Mat_VarWriteNextType73(hid_t id, matvar_t *matvar, const char *name, hid_t *refs_id, hsize_t *dims)
{
    int err = MATIO_E_NO_ERROR;
    hid_t dset_id, space_id, type_id;

    type_id = H5Tarray_create(ClassType2H5T(matvar->class_type), 1, 0