static int
Mat_H5ReadFieldNames(matvar_t *matvar, hid_t dsethandle, hsize_t *nfields)
{
    hsize_t i;
    hid_t field_id, attr_id, space_id;
    hvl_t *fieldnames_vl;
    herr_t herr;
    // Open the attribute "MATLAB_fields" from the dataset to retrieve its dataspace.
    // Get the dataspace associated with the attribute to determine the number of fields.
    // Check for any errors when retrieving the number of fields, and handle errors by
    // closing open resources and returning an error code if necessary.
    // Allocate memory to store the field names as variable-length structures.
    if ( H5Aexists_by_name(dsethandle, ".", "MATLAB_fields", H5P_DEFAULT) ) {
        herr = H5Aopen_by_name(dsethandle, ".", "MATLAB_fields", H5P_DEFAULT, H5P_DEFAULT, &attr_id);
        if ( herr >= 0 ) {
            herr = H5Aget_space(attr_id, &space_id);
            if ( herr >= 0 ) {
                herr = H5Sget_select_npoints(space_id, nfields);
                if ( herr >= 0 ) {
                    herr = H5Aread(attr_id, H5T_VLEN, &fieldnames_vl);
                    if ( herr >= 0 ) {
                        matvar->internal->num_fields = (unsigned int)*nfields;
                        matvar->internal->fieldnames =
                            (char **)calloc((size_t)(*nfields), sizeof(*matvar->internal->fieldnames));
                        if ( matvar->internal->fieldnames!= NULL ) {
                            for ( i = 0; i < *nfields; i++ ) {
                                matvar->internal->fieldnames[i] = (char *)calloc(fieldnames_vl[i].len + 1, 1);
                                if ( matvar->internal->fieldnames[i]!= NULL ) {
                                    if ( fieldnames_vl[i].p!= NULL ) {
                                        memcpy(matvar->internal->fieldnames[i], fieldnames_vl[i].p,
                                               fieldnames_vl[i].len);
                                    }
                                } else {
                                    err = MATIO_E_OUT_OF_MEMORY;
                                    break;
                                }
                            }
                        } else {
                            err = MATIO_E_OUT_OF_MEMORY;
                        }
                        H5Tclose(H5T_VLEN);
                        H5Sclose(space_id);
                        H5Aclose(attr_id);
                        free(fieldnames_vl);
                    } else {
                        err = MATIO_E_GENERIC_READ_ERROR;
                    }
                } else {
                    err = MATIO_E_GENERIC_READ_ERROR;
                }
                H5Sclose(space_id);
            } else {
                err = MATIO_E_GENERIC_READ_ERROR;
            }
        } else {
            err = MATIO_E_GENERIC_READ_ERROR;
        }
    } else {
        err = MATIO_E_GENERIC_READ_ERROR;
    }

    return err;
}