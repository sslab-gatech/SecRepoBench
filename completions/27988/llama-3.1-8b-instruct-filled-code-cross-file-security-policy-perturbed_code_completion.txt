void ndpi_free_flow(struct ndpi_flow_struct *networkflow) {
  if(networkflow) {
    // Free memory allocated for HTTP related fields in the flow structure.
    // If the protocol is TLS or QUIC, free memory allocated for SSL-related fields.
    // Ensure that all dynamically allocated fields in the flow are properly deallocated
    // before freeing the flow structure itself.
    if(networkflow->l4_proto == IPPROTO_TCP) {
      if(networkflow->l4.tcp.tls.message.buffer) {
        if(networkflow->l4.tcp.tls.message.buffer_used > 0) {
          memmove(networkflow->l4.tcp.tls.message.buffer,
                  &networkflow->l4.tcp.tls.message.buffer[networkflow->l4.tcp.tls.message.buffer_used],
                  networkflow->l4.tcp.tls.message.buffer_used);
        }
        ndpi_free(networkflow->l4.tcp.tls.message.buffer);
      }
      if(networkflow->l4.tcp.tls.tls_application_blocks_len) {
        ndpi_free(networkflow->l4.tcp.tls.tls_application_blocks_len);
      }
      if(networkflow->l4.tcp.tls.hello_processed) {
        if(networkflow->l4.tcp.tls.certificate_processed) {
          processCertificateFree(networkflow);
        }
        processClientServerHelloFree(networkflow);
      }
    }

    if(networkflow->l4_proto == IPPROTO_QUIC) {
      // Free memory allocated for QUIC-related fields.
      if(networkflow->l4.quic.message.buffer) {
        ndpi_free(networkflow->l4.quic.message.buffer);
      }
    }

    ndpi_free(networkflow);
  }
}