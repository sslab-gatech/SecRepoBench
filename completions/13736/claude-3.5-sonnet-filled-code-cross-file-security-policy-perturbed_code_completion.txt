unsigned int *offsets = c->allocate_size<unsigned int> ((fdCount + 1) * offsetSize);
if (unlikely (!offsets)) return_trace (false);

unsigned int offset = 0;
for (unsigned int i = 0; i < fdCount + 1; i++)
{
  if (unlikely (i >= c->length)) return_trace (false);
  switch (offsetSize) {
    case 1: c->set_offset_varint (offsets, i, offset, 1); break;
    case 2: c->set_offset_varint (offsets, i, offset, 2); break;
    case 3: c->set_offset_varint (offsets, i, offset, 3); break;
    case 4: c->set_offset_varint (offsets, i, offset, 4); break;
    default: return_trace (false);
  }
  if (i < fdCount)
  {
    unsigned int j = 0;
    for (; j < fontDicts.length; j++)
      if (fdmap.includes (j) && fdmap[j] == i)
        break;
    if (j < fontDicts.length)
      offset += FontDict::calculate_serialized_size (fontDicts[j], opszr, privateInfos[i]);
  }
}