unsigned int lastOffset = 0;
unsigned int offsetIndexSize = CFFIndex<FontDict>::calculate_serialized_size (offsetSize, fdCount, calculate_serialized_size (offsetSize, fontDicts, fdCount, fdmap, opszr));
if (unlikely (!c->allocate_size (offsetIndexSize))) return_trace (false);

for (unsigned int i = 0; i < fdCount; i++)
{
  if (fdmap.includes (i))
  {
    unsigned int dictSize = FontDict::calculate_serialized_size (fontDicts[fdmap[i]], opszr, privateInfos[fdmap[i]]);
    unsigned int currentOffset = lastOffset;
    lastOffset += dictSize;

    // Set the offset for the current font dictionary
    if (unlikely (!c->set_offset (currentOffset, i))) return_trace (false);
  }
  else
  {
    // If not included, set offset to zero or handle as appropriate
    if (unlikely (!c->set_offset (0, i))) return_trace (false);
  }
}