HBUINT8 *offsets = this->offsets.arrayZ;
    unsigned int current_offset = 1;
    char *data_start = c->head;

    for (unsigned int i = 0; i < fontDicts.length; i++) {
        if (fdmap.includes(i)) {
            unsigned int j = fdmap[i];
            for (unsigned int k = 0; k < offsetSize; k++)
                offsets[j * offsetSize + k] = (current_offset >> (8 * (offsetSize - k - 1))) & 0xFF;

            FontDict *dict = c->start_embed<FontDict>();
            if (unlikely(!dict->serialize(c, fontDicts[i], opszr, privateInfos[j])))
                return_trace(false);

            unsigned int dict_size = c->head - (data_start + current_offset - 1);
            current_offset += dict_size;
        }
    }

    for (unsigned int k = 0; k < offsetSize; k++)
        offsets[fdCount * offsetSize + k] = (current_offset >> (8 * (offsetSize - k - 1))) & 0xFF;