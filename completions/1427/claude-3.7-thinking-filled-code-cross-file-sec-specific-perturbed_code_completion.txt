// Check if video size is sufficient
if (aligned_width <= 0 || c->avctx->height <= 0 || c->bpp <= 0)
    return AVERROR_INVALIDDATA;

int64_t req_size_bits = (int64_t)aligned_width * c->avctx->height * c->bpp;
// Check for overflow
if (req_size_bits <= 0)
    return AVERROR_INVALIDDATA;

// Convert to bytes, rounding up
int64_t req_size = (req_size_bits + 7) / 8;
if (req_size <= 0 || req_size > INT_MAX || c->video_size < req_size)
    return AVERROR_INVALIDDATA;

// Determine pixel format
if (compressiontype == 0 && c->palette_size && c->bpp <= 8) {
    avctx->pix_fmt = AV_PIX_FMT_PAL8;
} else if (compressiontype && (c->bpp == 6 || c->bpp == 8) && 
           c->palette_size == (1 << c->bpp) * 3) {
    avctx->pix_fmt = AV_PIX_FMT_BGR24;
} else if (compressiontype == 0 && c->bpp == 24 && c->format == CHUNKY && !c->palette_size) {
    avctx->pix_fmt = AV_PIX_FMT_RGB24;
} else {
    avpriv_request_sample(avctx, "Compression type %d, bpp %d, format 0x%0x, palette size %d",
                        compressiontype, c->bpp, c->format, c->palette_size);
    return AVERROR_PATCHWELCOME;
}