(packet->udp != 0) {
  // Check for UDP packet to known Spotify port
  if (((packet->udp->source == 57621) || (packet->udp->dest == 57621)) && 
      (payload_len >= 4) && packet->payload) {
    
    // Verify the Spotify identifier in the payload
    if (memcmp(packet->payload, "\x01\x57\x1E\x00", 4) == 0) {
      NDPI_LOG_DBG(ndpi_struct, "Found Spotify UDP traffic\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
  }
} else if (packet->tcp != 0 && packet->tcp_retransmission == 0) {
  // Check for TCP packet with Spotify patterns
  if ((payload_len >= 8) && packet->payload) {
    // Look for Spotify specific patterns in TCP payload
    if ((packet->tcp->source == 4070 || packet->tcp->dest == 4070) ||
        (memcmp(packet->payload, "\x00\x04\x00\x00", 4) == 0)) {
      
      NDPI_LOG_DBG(ndpi_struct, "Found Spotify TCP traffic\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
  }
} else if (packet->iph != 0) {
  // Check for Spotify IP ranges
  u_int32_t src_ip = ntohl(packet->iph->saddr);
  u_int32_t dst_ip = ntohl(packet->iph->daddr);
  
  // Example Spotify IP ranges
  if ((src_ip >= 0x5B900000 && src_ip <= 0x5B9FFFFF) || // 91.144.0.0/16
      (dst_ip >= 0x5B900000 && dst_ip <= 0x5B9FFFFF)) {
    
    NDPI_LOG_DBG(ndpi_struct, "Found Spotify traffic by IP range\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
}