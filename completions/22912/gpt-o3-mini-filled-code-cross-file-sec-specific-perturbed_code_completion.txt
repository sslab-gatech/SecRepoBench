if(packet->ip_proto == IPPROTO_UDP) {
    /* Check if UDP packet is targeting known Spotify port (e.g., 4070) */
    if(packet->udp != NULL && (ntohs(packet->udp->dest_port) == 4070 || ntohs(packet->udp->src_port) == 4070)) {
        /* Ensure payload is long enough before checking for Spotify identifier */
        if(payload_len >= 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
            NDPI_LOG_DBG(ndpi_struct, "detected Spotify (UDP) traffic");
            packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
            return;
        }
    }
} else if(packet->ip_proto == IPPROTO_TCP) {
    /* TCP packet: check for specific byte pattern indicative of Spotify */
    if(packet->tcp != NULL) {
        if(payload_len >= 7 && memcmp(packet->payload, "Spotify", 7) == 0) {
            NDPI_LOG_DBG(ndpi_struct, "detected Spotify (TCP) traffic");
            packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
            return;
        }
    }
}

/* Check IP addresses against known Spotify IP ranges, e.g., 91.108.4.0/24 */
{
    u_int32_t spotify_ip_prefix = ntohl(inet_addr("91.108.4.0"));
    u_int32_t mask = 0xFFFFFF00; /* /24 mask */
    u_int32_t ip_src = ntohl(packet->ip_src);
    u_int32_t ip_dst = ntohl(packet->ip_dst);

    if ((ip_src & mask) == (spotify_ip_prefix & mask) ||
        (ip_dst & mask) == (spotify_ip_prefix & mask)) {
        NDPI_LOG_DBG(ndpi_struct, "detected Spotify (IP range) traffic");
        packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
        return;
    }
}