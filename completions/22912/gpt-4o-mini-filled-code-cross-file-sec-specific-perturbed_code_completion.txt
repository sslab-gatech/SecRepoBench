if (packet->protocol == NDPI_PROTOCOL_UDP && (packet->dst_port == 4070 || packet->src_port == 4070)) {
    // Check for Spotify identifier in the payload
    if (payload_len > 0 && payload_len <= MAX_PAYLOAD_LENGTH) {
      const u_int8_t *packet_payload = packet->payload;
      if (memcmp(packet_payload, SPOTIFY_IDENTIFIER, sizeof(SPOTIFY_IDENTIFIER)) == 0) {
        NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic\n");
        ndpi_struct->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
        return;
      }
    }
  } else if (packet->protocol == NDPI_PROTOCOL_TCP) {
    // Analyze TCP payload for Spotify patterns
    if (payload_len > 0 && payload_len <= MAX_PAYLOAD_LENGTH) {
      const u_int8_t *packet_payload = packet->payload;
      if (memcmp(packet_payload, SPOTIFY_IDENTIFIER, sizeof(SPOTIFY_IDENTIFIER)) == 0) {
        NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic\n");
        ndpi_struct->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
        return;
      }
    }
  } else {
    // Check IP addresses for known Spotify ranges
    if (is_spotify_ip(packet->src_ip) || is_spotify_ip(packet->dst_ip)) {
      NDPI_LOG_DBG(ndpi_struct, "Detected Spotify IP traffic\n");
      ndpi_struct->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  }