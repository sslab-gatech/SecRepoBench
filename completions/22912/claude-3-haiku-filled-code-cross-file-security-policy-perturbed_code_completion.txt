(void)ndpi_struct;

if (packet->udp != NULL) {
  if (payload_len >= 7 && memcmp(packet->payload, "spotify", 7) == 0) {
    NDPI_LOG_INFO(ndpi_struct, "Found Spotify UDP traffic");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
} else if (packet->tcp != NULL) {
  if (payload_len >= 7 && memcmp(packet->payload, "spotify", 7) == 0) {
    NDPI_LOG_INFO(ndpi_struct, "Found Spotify TCP traffic");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
} else {
  if (ndpi_struct->host_ip_to_name != NULL) {
    char *spotify_ip = ndpi_struct->host_ip_to_name(ndpi_struct, packet->iph->saddr);
    if (spotify_ip != NULL && strstr(spotify_ip, "spotify") != NULL) {
      NDPI_LOG_INFO(ndpi_struct, "Found Spotify IP traffic");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
    spotify_ip = ndpi_struct->host_ip_to_name(ndpi_struct, packet->iph->daddr);
    if (spotify_ip != NULL && strstr(spotify_ip, "spotify") != NULL) {
      NDPI_LOG_INFO(ndpi_struct, "Found Spotify IP traffic");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
  }
}

NDPI_EXCLUDE_PROTO(ndpi_struct, stream);