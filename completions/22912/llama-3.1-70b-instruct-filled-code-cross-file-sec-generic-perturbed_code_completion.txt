// Check if the packet is a UDP packet, specifically targeting a known Spotify port.
if (packet->udp!= NULL && packet->udp->dest == htons(4070) && payload_len >= 4) {
  const u_int8_t *packet_payload = packet->payload;
  // Verify the payload for a specific Spotify identifier to recognize Spotify traffic.
  if (packet_payload[0] == 0x01 && packet_payload[1] == 0x00 && packet_payload[2] == 0x00 && packet_payload[3] == 0x07) {
    NDPI_LOG_INFO(ndpi_struct, "Spotify detected\n");
    ndpi_int_add_protocol_to_bitmask(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
    return;
  }
}

// If the packet is not a UDP packet, check if it is a TCP packet and analyze the payload for specific byte patterns
// indicative of Spotify.
if (packet->tcp!= NULL && payload_len >= 4) {
  const u_int8_t *packet_payload = packet->payload;
  // Analyze the payload for specific byte patterns indicative of Spotify.
  if (packet_payload[0] == 0x01 && packet_payload[1] == 0x00 && packet_payload[2] == 0x00 && packet_payload[3] == 0x07) {
    NDPI_LOG_INFO(ndpi_struct, "Spotify detected\n");
    ndpi_int_add_protocol_to_bitmask(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
    return;
  }
}

// Further, analyze IP packets by checking if the source or destination IP addresses fall within specific known Spotify
// IP ranges.
if ((packet->src_ip == htonl(0x0A0A0A0A) || packet->dst_ip == htonl(0x0A0A0A0A)) ||
    (packet->src_ip == htonl(0x0B0B0B0B) || packet->dst_ip == htonl(0x0B0B0B0B))) {
  NDPI_LOG_INFO(ndpi_struct, "Spotify detected\n");
  ndpi_int_add_protocol_to_bitmask(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
  return;
}