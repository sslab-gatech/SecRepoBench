(packet->detected_protocol_stack[0] != NDPI_PROTOCOL_SPOTIFY) {
  if (packet->udp != NULL && packet->payload_packet_len > 8) { // Check for UDP packet
    u_int16_t dest_port = ntohs(packet->udp->dest);
    
    if (dest_port == SPOTIFY_PORT || dest_port == SPOTIFY_SECURE_PORT) { // Known Spotify ports
      if (packet->payload_packet_len >= 4 && 
          memcmp(packet->payload, SPOTIFY_IDENTIFIER, 4) == 0) { // Check for Spotify identifier
        NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via UDP\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, 
                                   NDPI_CONFIDENCE_DPI);
        return;
      }
    }
  } else if (packet->tcp != NULL) { // Check for TCP packet
    if (packet->payload_packet_len >= 12 && 
        memcmp(packet->payload, SPOTIFY_TCP_PATTERN, 12) == 0) { // Check for specific TCP byte pattern
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via TCP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, 
                                 NDPI_CONFIDENCE_DPI);
      return;
    }
  }

  // Analyze IP addresses for known Spotify ranges
  if (ndpi_is_ip_in_spotify_range(packet->iph->saddr) || 
      ndpi_is_ip_in_spotify_range(packet->iph->daddr)) {
    NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via IP range\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, 
                               NDPI_CONFIDENCE_HIGH);
    return;
  }
}