(packet->udp != NULL) {
  // Check for UDP packets on specific Spotify ports
  if ((packet->udp->source == 57621 || packet->udp->source == 4070 ||
       packet->udp->dest == 57621 || packet->udp->dest == 4070)) {
    
    // Make sure we have enough payload to check signature
    if (payload_len >= 4) {
      // Check for specific Spotify identifiers in UDP payload
      if (packet->payload[0] == 0x00 && packet->payload[1] == 0x01 && 
          packet->payload[2] == 0x73 && packet->payload[3] == 0x70) {
        
        NDPI_LOG_INFO(ndpi_struct, "Found spotify\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  }
} else if (packet->tcp != NULL) {
  // Check for TCP packets and minimum payload length
  if (payload_len >= 4) {
    // Checking for specific Spotify TCP signatures
    if (packet->payload[0] == 0x00 && packet->payload[1] == 0x04 && 
        packet->payload[2] == 0x73 && packet->payload[3] == 0x70) {
      
      NDPI_LOG_INFO(ndpi_struct, "Found spotify over TCP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
    
    // Look for Spotify domain in the payload
    if (payload_len > 11) { // Minimum length to contain "spotify.com"
      if (ndpi_strnstr((const char *)packet->payload, "spotify.com", payload_len) != NULL) {
        NDPI_LOG_INFO(ndpi_struct, "Found spotify domain\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  }
} else if (packet->iph != NULL) {
  // Check if source or destination IP is in Spotify's known IP ranges
  u_int32_t src_ip = ntohl(packet->iph->saddr);
  u_int32_t dst_ip = ntohl(packet->iph->daddr);
  
  // Example Spotify IP ranges (replace with actual ranges)
  // 35.186.224.0/19 -> 0x23BAE000-0x23BAFFFF
  if ((src_ip >= 0x23BAE000 && src_ip <= 0x23BAFFFF) || 
      (dst_ip >= 0x23BAE000 && dst_ip <= 0x23BAFFFF)) {
      
    NDPI_LOG_INFO(ndpi_struct, "Found spotify based on IP\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
}