if (packet->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN) {
    if (packet->udp_dport == 80 || packet->udp_dport == 443 || packet->udp_sport == 80 || packet->udp_sport == 443) {
      // Check for Spotify payload
      const u_int8_t *packet_payload = packet->payload;
      u_int32_t payload_len = packet->payload_packet_len;
      if (payload_len >= 4 && memcmp(packet_payload, "\x08spotify", 8) == 0) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify traffic detected.\n");
        NDPI_PROTOCOL_BITMASK detected_protocols;
        ndpi_fill_default_protocol_bitmask(&detected_protocols);
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, &detected_protocols);
        NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
        return;
      }
    } else if (packet->tcp_flags == 0x02) { // SYN flag set
      // Check for Spotify specific byte patterns in TCP payload
      const u_int8_t *packet_payload = packet->payload;
      u_int32_t payload_len = packet->payload_packet_len;
      if (payload_len >= 4 && (memcmp(packet_payload, "\x08spotify", 8) == 0 || memcmp(packet_payload, "\x1fspotify", 8) == 0)) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify traffic detected.\n");
        NDPI_PROTOCOL_BITMASK detected_protocols;
        ndpi_fill_default_protocol_bitmask(&detected_protocols);
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, &detected_protocols);
        NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
        return;
      }
    } else if (packet->detected_protocol_stack[0] == NDPI_PROTOCOL_IP) {
      // Check for Spotify IP ranges
      struct ndpi_ipv4_address src_ip = packet->iph->saddr;
      struct ndpi_ipv4_address dst_ip = packet->iph->daddr;
      if ((src_ip.u_addr.ip4 == 0x08080808 || dst_ip.u_addr.ip4 == 0x08080808) ||
          (src_ip.u_addr.ip4 == 0x08080808 || dst_ip.u_addr.ip4 == 0x08080808)) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify traffic detected.\n");
        NDPI_PROTOCOL_BITMASK detected_protocols;
        ndpi_fill_default_protocol_bitmask(&detected_protocols);
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, &detected_protocols);
        NDPI_EXCLUDE_PROTO(ndpi_struct, stream);
        return;
      }
    }
  }