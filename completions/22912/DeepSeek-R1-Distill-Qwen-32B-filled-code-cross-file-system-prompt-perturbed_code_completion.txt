if (packet->udp != NULL) {
  // Check for known Spotify UDP ports
  if (packet->udp->dest_port == 4070 || packet->udp->dest_port == 4071) {
    if (payload_len >= 10 && memcmp(packet->payload, "Spotify", 7) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via UDP port\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_CONFIDENCE_HIGH);
      return;
    }
  }
} else if (packet->tcp != NULL) {
  // Check for Spotify-specific TCP payload patterns
  if (payload_len >= 10 && (packet->payload[0] == 0x16 || packet->payload[0] == 0x17)) {
    NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via TCP pattern\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_CONFIDENCE_HIGH);
    return;
  }
}

// Check IP addresses against known Spotify ranges
struct ndpi_ip_addr *src = &stream->packet.ip.src;
struct ndpi_ip_addr *dst = &stream->packet.ip.dst;

if (ndpi_is_ip_in_range(src, spotify_ip_ranges) || ndpi_is_ip_in_range(dst, spotify_ip_ranges)) {
  NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via IP range\n");
  ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_CONFIDENCE_HIGH);
  return;
}