if (packet->udp && ntohs(packet->udp->dest) == 4353) { // Spotify's known UDP port
    if (ndpi_verify_spotify_identifier(ndpi_struct, packet->payload, payload_len)) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected");
      ndpi_set_detection_bitmask(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  } else if (packet->tcp) {
    if (ndpi_check_spotify_tcp_payload(ndpi_struct, packet->payload, payload_len)) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected (TCP)");
      ndpi_set_detection_bitmask(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  } else if (packet->ip) {
    if (ndpi_check_spotify_ip_ranges(ndpi_struct, packet->ip->saddr, packet->ip->daddr)) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected (IP range)");
      ndpi_set_detection_bitmask(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }