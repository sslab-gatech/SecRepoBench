if (packet->protocol == NDPI_PROTOCOL_UDP && 
      (packet->src_port == 4070 || packet->dst_port == 4070)) {
    // Check for Spotify-specific payload patterns
    if (payload_len > 0 && memcmp(packet->payload, "Spotify", 7) == 0) {
      NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic (UDP)\n");
      ndpi_struct->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  } else if (packet->protocol == NDPI_PROTOCOL_TCP) {
    // Check for TCP payload patterns indicative of Spotify
    if (payload_len > 0 && memcmp(packet->payload, "Spotify", 7) == 0) {
      NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic (TCP)\n");
      ndpi_struct->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  }

  // Check IP addresses against known Spotify IP ranges
  if (is_spotify_ip(packet->src_ip) || is_spotify_ip(packet->dst_ip)) {
    NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic (IP range)\n");
    ndpi_struct->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
    return;
  }