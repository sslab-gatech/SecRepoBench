if(packet->l4_protocol == NDPI_PROTOCOL_UDP) {
  /* Check if UDP packet is using the known Spotify port (e.g., 4070) and if its payload contains the Spotify identifier */
  if(packet->src_port == 4070 || packet->dst_port == 4070) {
    if(payload_len >= 7 && memcmp(packet->payload, "Spotify", 7) == 0) {
      NDPI_LOG_INFO(ndpi_struct, stream, "Detected Spotify via UDP (port and payload match)");
      packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  }
}
if(packet->l4_protocol == NDPI_PROTOCOL_TCP) {
  /* For TCP packets, check if the payload contains a Spotify specific byte pattern.
     Here we simply look for the "Spotify" string as an example. */
  if(payload_len >= 7 && memcmp(packet->payload, "Spotify", 7) == 0) {
    NDPI_LOG_INFO(ndpi_struct, stream, "Detected Spotify via TCP payload pattern");
    packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
    return;
  }
}

/* As a fallback, check if the source or destination IP address is within a known Spotify IP range.
   For instance, we consider the range 203.0.113.0/24 as a placeholder for Spotify IP addresses.
   Adjust the range as necessary for your environment. */
{
  struct in_addr ip_range_start;
  u_int32_t start_ip, end_ip, src_ip, dst_ip;

  if(inet_aton("203.0.113.0", &ip_range_start)) {
    start_ip = ntohl(ip_range_start.s_addr);
    end_ip = start_ip + 0xFF; // 203.0.113.0 - 203.0.113.255

    src_ip = ntohl(packet->iph->ip_src.s_addr);
    dst_ip = ntohl(packet->iph->ip_dst.s_addr);

    if((src_ip >= start_ip && src_ip <= end_ip) ||
       (dst_ip >= start_ip && dst_ip <= end_ip)) {
      NDPI_LOG_INFO(ndpi_struct, stream, "Detected Spotify via IP range");
      packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  }
}