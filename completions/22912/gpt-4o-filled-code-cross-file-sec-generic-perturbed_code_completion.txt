if(packet->udp != NULL) {
    // Check if the UDP packet is targeting a known Spotify port
    if(packet->udp->dest == htons(4070) || packet->udp->dest == htons(4071)) {
      // Check for a specific Spotify identifier in the payload
      if(payload_len > 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
        NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic over UDP\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
        return;
      }
    }
  } else if(packet->tcp != NULL) {
    // Analyze TCP payload for specific byte patterns indicative of Spotify
    if(payload_len > 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic over TCP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }

  // Analyze IP packets for known Spotify IP ranges
  if((packet->iph->saddr >= htonl(78 << 24 | 31 << 16 | 8 << 8 | 0) &&
      packet->iph->saddr <= htonl(78 << 24 | 31 << 16 | 15 << 8 | 255)) ||
     (packet->iph->daddr >= htonl(78 << 24 | 31 << 16 | 8 << 8 | 0) &&
      packet->iph->daddr <= htonl(78 << 24 | 31 << 16 | 15 << 8 | 255))) {
    NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic based on IP range\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
    return;
  }