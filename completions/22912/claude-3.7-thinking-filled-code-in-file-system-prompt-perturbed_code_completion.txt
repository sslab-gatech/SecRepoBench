if(packet->udp != 0) {
  /* Check for Spotify UDP traffic */
  if(packet->udp->source == htons(57621) || packet->udp->dest == htons(57621)) {
    if(payload_len > 0) {
      NDPI_LOG_INFO(ndpi_struct, "found spotify over UDP\n");
      ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
      return;
    }
  }
} else if(packet->tcp != 0) {
  /* Check for Spotify TCP traffic */
  if(packet->tcp->source == htons(4070) || packet->tcp->dest == htons(4070)) {
    if(payload_len > 0) {
      NDPI_LOG_INFO(ndpi_struct, "found spotify over TCP\n");
      ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
      return;
    }
  }
}

/* Check for known Spotify server IPs */
if(packet->iph) {
  u_int32_t src_ip = ntohl(packet->iph->saddr);
  u_int32_t dst_ip = ntohl(packet->iph->daddr);
  
  /* These IP ranges should be replaced with actual Spotify IP ranges */
  if((src_ip >= 0x5F8A0000 && src_ip <= 0x5F8AFFFF) || /* 95.138.0.0/16 (example) */
     (dst_ip >= 0x5F8A0000 && dst_ip <= 0x5F8AFFFF)) {
    NDPI_LOG_INFO(ndpi_struct, "found spotify by IP\n");
    ndpi_int_spotify_add_connection(ndpi_struct, stream, 1);
    return;
  }
}