{
  const u_int8_t *packet_payload = packet->payload;

  if (packet->udp != NULL && payload_len > sizeof(uint16_t)) {
    /* Check for Spotify's UDP port and specific identifier */
    if (packet->udp->dest == htons(3478) || packet->udp->source == htons(3478)) {
      if (payload_len >= 8 && !memcmp(packet_payload, "Spotify", 8)) {
        NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via UDP\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, 
                                   NDPI_CONFIDENCE_DPI);
        return;
      }
    }
  }

  if (packet->tcp != NULL && payload_len > 0) {
    /* Analyze TCP payload for Spotify patterns */
    if (payload_len >= 4 && !memcmp(packet_payload, "GET ", 4) &&
        memmem(packet_payload, payload_len, "Spotify", 8)) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via TCP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, 
                                 NDPI_CONFIDENCE_DPI);
      return;
    }
  }

  /* Check IP addresses against known Spotify ranges */
  if (packet->iph != NULL) {
    struct ndpi_ip_addr src, dst;
    ndpi_convert_and_copy_ip(&src, packet->iph->saddr, packet->iph->version);
    ndpi_convert_and_copy_ip(&dst, packet->iph->daddr, packet->iph->version);

    if (ndpi_is_ip_in_network(ndpi_struct, &src, "3.120.0.0/15") ||
        ndpi_is_ip_in_network(ndpi_struct, &dst, "3.120.0.0/15")) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via IP range\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, 
                                 NDPI_CONFIDENCE_LEVEL_3);
      return;
    }
  }
}