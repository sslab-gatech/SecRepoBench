if(packet->udp != NULL && (packet->udp->source == 4070 || packet->udp->dest == 4070)) {
    // Check for Spotify-specific payload pattern in UDP
    if(payload_len > 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic on UDP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  } else if(packet->tcp != NULL) {
    // Check for Spotify-specific payload pattern in TCP
    if(payload_len > 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic on TCP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  } else if(packet->iph != NULL) {
    // Check for known Spotify IP ranges
    if((packet->iph->saddr >= htonl(1038614528) && packet->iph->saddr <= htonl(1038614783)) || // 62.96.0.0/19
       (packet->iph->daddr >= htonl(1038614528) && packet->iph->daddr <= htonl(1038614783))) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic based on IP range\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }