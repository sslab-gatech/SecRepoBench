(void)ndpi_struct;
(void)stream;

if (packet->udp != NULL) {
    if (packet->udp->source == htons(4070) || packet->udp->dest == htons(4070)) {
        if (payload_len >= 4 && memcmp(packet->payload, "SPFY", 4) == 0) {
            ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
            return;
        }
    }
} else if (packet->tcp != NULL) {
    if (payload_len >= 4 && memcmp(packet->payload, "SPFY", 4) == 0) {
        ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
        return;
    }
} else {
    if (ndpi_struct->ip_version == 4) {
        if (ndpi_is_ip_address_in_network(ndpi_struct, (struct in_addr *)&packet->iphv4->saddr, "178.249.0.0", "255.255.0.0") ||
            ndpi_is_ip_address_in_network(ndpi_struct, (struct in_addr *)&packet->iphv4->daddr, "178.249.0.0", "255.255.0.0")) {
            ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
            return;
        }
    } else if (ndpi_struct->ip_version == 6) {
        if (ndpi_is_ip_address_in_network6(ndpi_struct, (struct in6_addr *)&packet->iphv6->saddr, "2a01:4f8::", "ffff:ffff:ffff:ffff::") ||
            ndpi_is_ip_address_in_network6(ndpi_struct, (struct in6_addr *)&packet->iphv6->daddr, "2a01:4f8::", "ffff:ffff:ffff:ffff::")) {
            ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
            return;
        }
    }
}

NDPI_EXCLUDE_PROTO(ndpi_struct, stream);