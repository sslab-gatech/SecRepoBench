// <MASK>
if (packet->udp != NULL) {
  /* Check if known Spotify UDP port */
  if (ntohs(packet->udp->source) == 4070 || ntohs(packet->udp->dest) == 4070) {
    /* Safely verify payload pattern for "SPOT" (as an example) */
    if (payload_len >= 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
      NDPI_LOG_Info(ndpi_struct, "Spotify detected over UDP port 4070\n");
      NDPI_SET_PROTOCOL(stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }
} else if (packet->tcp != NULL) {
  /* Check payload for "SPOT" pattern as a placeholder for Spotify signature */
  if (payload_len >= 4 && memcmp(packet->payload, "SPOT", 4) == 0) {
    NDPI_LOG_Info(ndpi_struct, "Spotify detected over TCP\n");
    NDPI_SET_PROTOCOL(stream, NDPI_PROTOCOL_SPOTIFY);
    return;
  }
}

/* Check known Spotify IP range as an additional heuristic (example: 78.31.8.0/21) */
if (packet->iph != NULL) {
  u_int32_t src_ip = ntohl(packet->iph->saddr);
  u_int32_t dst_ip = ntohl(packet->iph->daddr);
  u_int32_t spotify_start = (78 << 24) | (31 << 16) | (8 << 8) | 0;
  u_int32_t spotify_end   = (78 << 24) | (31 << 16) | (15 << 8) | 255;

  if ((src_ip >= spotify_start && src_ip <= spotify_end) ||
      (dst_ip >= spotify_start && dst_ip <= spotify_end)) {
    NDPI_LOG_Info(ndpi_struct, "Spotify detected by known IP range\n");
    NDPI_SET_PROTOCOL(stream, NDPI_PROTOCOL_SPOTIFY);
    return;
  }
}
// <MASK>