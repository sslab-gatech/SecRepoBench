// <MASK>
(void)ndpi_struct;

if (packet->udp != NULL) {
    // Check if the packet is a UDP packet, specifically targeting a known Spotify port.
    if (ntohs(packet->udp->dest) == 4070 || ntohs(packet->udp->dest) == 4071) {
        // Verify the payload for a specific Spotify identifier to recognize Spotify traffic.
        if (payload_len >= 8 && memcmp(packet->payload, "\x53\x70\x6f\x74\x69\x66\x79\x00", 8) == 0) {
            NDPI_LOG_INFO(ndpi_struct, "Found Spotify (UDP)\n");
            ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
            return;
        }
    }
} else if (packet->tcp != NULL) {
    // Check if the packet is a TCP packet and analyze the payload for specific byte patterns
    // indicative of Spotify, logging and marking the protocol as Spotify if detected.
    if (payload_len >= 8 && memcmp(packet->payload, "\x53\x70\x6f\x74\x69\x66\x79\x00", 8) == 0) {
        NDPI_LOG_INFO(ndpi_struct, "Found Spotify (TCP)\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
    }
} else {
    // Further, analyze IP packets by checking if the source or destination IP addresses fall within specific known Spotify
    // IP ranges. If they do, log the detection and set the detected protocol as Spotify, then return from the function.
    if (ndpi_is_spotify_flow(ndpi_struct, stream)) {
        NDPI_LOG_INFO(ndpi_struct, "Found Spotify (IP)\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
    }
}

NDPI_EXCLUDE_PROTO(ndpi_struct, stream);