if (packet->protocol == NDPI_PROTOCOL_UDP && 
      (packet->src_port == 4070 || packet->dst_port == 4070)) {
    if (payload_len > 0 && packet->payload[0] == 0x53 && packet->payload[1] == 0x70) { // Check for 'Sp' in payload
      NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic (UDP)\n");
      stream->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  } else if (packet->protocol == NDPI_PROTOCOL_TCP) {
    if (payload_len > 0 && packet->payload[0] == 0x53 && packet->payload[1] == 0x70) { // Check for 'Sp' in payload
      NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic (TCP)\n");
      stream->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
      return;
    }
  }

  // Check IP ranges for known Spotify IPs
  if ((packet->src_ip == SOME_SPOTIFY_IP_RANGE) || (packet->dst_ip == SOME_SPOTIFY_IP_RANGE)) {
    NDPI_LOG_DBG(ndpi_struct, "Detected Spotify traffic (IP range)\n");
    stream->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
    return;
  }