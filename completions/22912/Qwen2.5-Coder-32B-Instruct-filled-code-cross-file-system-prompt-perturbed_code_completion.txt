if (packet->udp != NULL && (packet->udp->dest == htons(5353) || packet->udp->source == htons(5353))) {
    // Check for mDNS packets which might be used by Spotify
    if (payload_len > 0 && packet->payload[0] == 0 && packet->payload[1] == 0) { // Example condition for Spotify mDNS
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected via mDNS\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
      return;
    }
  } else if (packet->tcp != NULL) {
    // Check for specific byte patterns in TCP payload
    if (payload_len > 4 && memcmp(packet->payload, "SPOT", 4) == 0) { // Example condition for Spotify TCP
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected via TCP payload\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
      return;
    }
  }

  // Check if the source or destination IP is within known Spotify IP ranges
  if (is_ip_in_spotify_range(&packet->iph->saddr) || is_ip_in_spotify_range(&packet->iph->daddr)) {
    NDPI_LOG_INFO(ndpi_struct, "Spotify detected via IP range\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN, NDPI_CONFIDENCE_DPI);
    return;
  }