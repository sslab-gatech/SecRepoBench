(packet->udp != NULL) {
    // Check for Spotify UDP packet
    if(payload_len > 0) {
      // Look for Spotify identifiers in payload
      if(payload_len >= 7 && (memcmp(packet->payload, "Spotify", 7) == 0 || 
                             memcmp(packet->payload, "spotify", 7) == 0)) {
        NDPI_LOG_INFO(ndpi_struct, "found spotify UDP pattern\n");
        ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
        return;
      }
      
      // Check for common Spotify ports
      if((packet->udp->source == htons(57621) || packet->udp->dest == htons(57621)) ||
         (packet->udp->source == htons(57622) || packet->udp->dest == htons(57622)) ||
         (packet->udp->source == htons(4070) || packet->udp->dest == htons(4070))) {
        NDPI_LOG_INFO(ndpi_struct, "found spotify UDP port\n");
        ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
        return;
      }
    }
  } else if(packet->tcp != NULL) {
    // Check for Spotify TCP traffic
    if(payload_len > 0) {
      // Look for Spotify identifiers in payload
      if(payload_len >= 7 && (memcmp(packet->payload, "Spotify", 7) == 0 || 
                             memcmp(packet->payload, "spotify", 7) == 0)) {
        NDPI_LOG_INFO(ndpi_struct, "found spotify TCP pattern\n");
        ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
        return;
      }
      
      // Check for common Spotify ports
      if((packet->tcp->source == htons(4070) || packet->tcp->dest == htons(4070))) {
        NDPI_LOG_INFO(ndpi_struct, "found spotify TCP port\n");
        ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
        return;
      }
    }
  }
  
  // Check for known Spotify IP ranges
  if(packet->iph != NULL) {
    uint32_t src_ip = ntohl(packet->iph->saddr);
    uint32_t dst_ip = ntohl(packet->iph->daddr);
    
    // Example Spotify CDN IP ranges
    if(
       // Example range 1: 35.186.224.0/19
       ((src_ip & 0xFFFFE000) == 0x23BAE000) || 
       ((dst_ip & 0xFFFFE000) == 0x23BAE000) ||
       // Example range 2: 104.154.0.0/15
       ((src_ip & 0xFFFE0000) == 0x689A0000) || 
       ((dst_ip & 0xFFFE0000) == 0x689A0000)
      ) {
      NDPI_LOG_INFO(ndpi_struct, "found spotify IP range\n");
      ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
      return;
    }
  }