(packet->udp != NULL) {
    if((packet->udp->source == htons(4070) || packet->udp->dest == htons(4070)) &&
       payload_len > 4 && memcmp(packet->payload, "Spot", 4) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected (UDP)\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  } else if(packet->tcp != NULL) {
    if(payload_len > 4 && memcmp(packet->payload, "Spot", 4) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify detected (TCP)\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }

  // Check IP ranges for Spotify
  if((packet->iph->saddr >= htonl(78 << 24 | 31 << 16 | 8 << 8 | 0) &&
      packet->iph->saddr <= htonl(78 << 24 | 31 << 16 | 15 << 8 | 255)) ||
     (packet->iph->daddr >= htonl(78 << 24 | 31 << 16 | 8 << 8 | 0) &&
      packet->iph->daddr <= htonl(78 << 24 | 31 << 16 | 15 << 8 | 255))) {
    NDPI_LOG_INFO(ndpi_struct, "Spotify detected (IP range)\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
    return;
  }