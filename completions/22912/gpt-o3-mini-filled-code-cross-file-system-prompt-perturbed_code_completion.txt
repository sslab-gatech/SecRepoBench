if(packet->ip_protocol == IPPROTO_UDP) {
    u_int16_t src_port = ntohs(packet->src_port);
    u_int16_t dst_port = ntohs(packet->dst_port);
    if(src_port == 4070 || dst_port == 4070) {
        if(payload_len > 7 && memcmp(packet->payload, "Spotify", 7) == 0) {
            NDPI_LOG_DBG(ndpi_struct, "detected spotify (UDP)\n");
            packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
            return;
        }
    }
} else if(packet->ip_protocol == IPPROTO_TCP) {
    if(payload_len > 7 && memmem(packet->payload, payload_len, "Spotify", 7) != NULL) {
        NDPI_LOG_DBG(ndpi_struct, "detected spotify (TCP)\n");
        packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
        return;
    }
} else {
    if(is_spotify_ip(packet->src_ip) || is_spotify_ip(packet->dst_ip)) {
        NDPI_LOG_DBG(ndpi_struct, "detected spotify (IP range)\n");
        packet->detected_protocol_stack[0] = NDPI_PROTOCOL_SPOTIFY;
        return;
    }
}