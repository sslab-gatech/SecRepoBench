(packet->udp) {
    if (packet->dport == 1143 || packet->dport == 5353 || packet->dport == 6251) {
      if (payload_len > 4 && memcmp(packet->payload, "\x00\x04\x00\x00", 4) == 0) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify detection successful by UDP payload.\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  } else if (packet->tcp) {
    if (payload_len > 10) {
      /* Check for specific byte patterns indicative of Spotify */
      if (memcmp(packet->payload, "\x47\x45\x54\x20\x2f\x73\x70\x6f\x2f\x31", 10) == 0 || /* GET /spo/1 */
          memcmp(packet->payload, "\x47\x45\x54\x20\x2f\x73\x70\x6f\x2f\x32", 10) == 0)   /* GET /spo/2 */
      {
        NDPI_LOG_INFO(ndpi_struct, "Spotify detection successful by TCP payload (GET /spo).\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  } else if (packet->ip_src.s_addr == inet_addr("78.31.8.0") ||
             packet->ip_src.s_addr == inet_addr("78.31.9.0") ||
             packet->ip_src.s_addr == inet_addr("78.31.10.0") ||
             packet->ip_src.s_addr == inet_addr("78.31.11.0") ||
             packet->ip_dst.s_addr == inet_addr("78.31.8.0") ||
             packet->ip_dst.s_addr == inet_addr("78.31.9.0") ||
             packet->ip_dst.s_addr == inet_addr("78.31.10.0") ||
             packet->ip_dst.s_addr == inet_addr("78.31.11.0")) {
    NDPI_LOG_INFO(ndpi_struct, "Spotify detection successful by IP address.\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
    return;
  }