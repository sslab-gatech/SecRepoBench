NDPI_LOG_DBG(ndpi_struct, "checking for spotify\n");

  /* Skip if already marked as Spotify */
  if (packet->detected_protocol_stack[0] == NDPI_PROTOCOL_SPOTIFY)
    return;

  /* Check if UDP on known Spotify port (e.g. 4070) */
  if (packet->udp != 0 && (packet->src_port == 4070 || packet->dst_port == 4070)) {
    /* Check payload for a simple Spotify indicator */
    if (payload_len >= 4 && memcmp(packet->payload, "Spot", 4) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify UDP traffic detected\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }

  /* Check if TCP packet */
  if (packet->tcp != 0) {
    /* Check payload for a simple Spotify indicator */
    if (payload_len >= 7 && memcmp(packet->payload, "Spotify", 7) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify TCP traffic detected\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }

  /* Check known Spotify IP range: for example 78.31.8.0/21 => 78.31.15.255 */
  if (packet->ip_version == 4) {
    u_int32_t ip_src = ntohl(packet->iph.u.v4.src);
    u_int32_t ip_dst = ntohl(packet->iph.u.v4.dst);
    u_int32_t start  = (78 << 24) | (31 << 16) | (8 << 8)  | (0);
    u_int32_t end    = (78 << 24) | (31 << 16) | (15 << 8) | (255);

    if ((ip_src >= start && ip_src <= end) ||
        (ip_dst >= start && ip_dst <= end)) {
      NDPI_LOG_INFO(ndpi_struct, "Spotify traffic detected by IP range\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY);
      return;
    }
  }