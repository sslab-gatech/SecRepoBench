if(packet->udp != NULL) {
    // Check if the packet is UDP and matches known Spotify ports
    if((packet->udp->source == htons(4070) || packet->udp->dest == htons(4070)) && payload_len > 4) {
      // Check for a specific Spotify identifier in the payload
      if(memcmp(packet->payload, "SPOT", 4) == 0) {
        NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic on UDP port 4070\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  } else if(packet->tcp != NULL) {
    // Check if the packet is TCP and analyze payload for Spotify patterns
    if(payload_len > 4 && memcmp(packet->payload, "SPOTIFY", 7) == 0) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic on TCP\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
  } else if(packet->iph != NULL) {
    // Check if the IP addresses match known Spotify IP ranges
    if((ntohl(packet->iph->saddr) >= 0xAC1F0000 && ntohl(packet->iph->saddr) <= 0xAC1FFFFF) || // 172.31.0.0/16
       (ntohl(packet->iph->daddr) >= 0xAC1F0000 && ntohl(packet->iph->daddr) <= 0xAC1FFFFF)) {
      NDPI_LOG_INFO(ndpi_struct, "Detected Spotify traffic based on IP range\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
  }