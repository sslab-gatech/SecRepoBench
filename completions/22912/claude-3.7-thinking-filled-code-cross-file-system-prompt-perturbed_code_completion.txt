if(packet->udp != NULL) {
  // Check if the packet is a UDP packet
  NDPI_LOG_DBG(ndpi_struct, "Checking for Spotify UDP packets\n");
  
  // Check if it's targeting a known Spotify port
  // For simplicity, let's say port 4070 is a known Spotify port
  if(packet->udp->source == 4070 || packet->udp->dest == 4070) {
    if(payload_len >= 4) { // Ensure there's enough payload to check
      // Verify payload for Spotify identifier
      if(packet->payload[0] == 0x83 && packet->payload[1] == 0x70 && packet->payload[2] == 0x6F && packet->payload[3] == 0x74) {
        NDPI_LOG_INFO(ndpi_struct, "Found Spotify UDP traffic\n");
        ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
        return;
      }
    }
  }
} else if(packet->tcp != NULL) {
  // Check if it's a TCP packet
  NDPI_LOG_DBG(ndpi_struct, "Checking for Spotify TCP packets\n");
  
  // Check for specific byte patterns in payload
  if(payload_len >= 4) {
    if(packet->payload[0] == 0x53 && packet->payload[1] == 0x70 && packet->payload[2] == 0x6F && packet->payload[3] == 0x74) {
      NDPI_LOG_INFO(ndpi_struct, "Found Spotify TCP traffic\n");
      ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
      return;
    }
  }
}

// Check if the IP addresses fall within known Spotify IP ranges
if(packet->iph) {
  // Example Spotify IP range (193.182.8.0/24)
  if((ntohl(packet->iph->saddr) & 0xFFFFFF00) == 0xC1B60800 || 
     (ntohl(packet->iph->daddr) & 0xFFFFFF00) == 0xC1B60800) {
    NDPI_LOG_INFO(ndpi_struct, "IP in Spotify range\n");
    ndpi_set_detected_protocol(ndpi_struct, stream, NDPI_PROTOCOL_SPOTIFY, NDPI_PROTOCOL_UNKNOWN);
    return;
  }
}