(packet->udp != NULL) {
    /* Check known Spotify UDP ports, e.g., 4070 */
    if (htons(packet->udp->source) == 4070 || htons(packet->udp->dest) == 4070) {
        /* Check for a simple Spotify signature in payload */
        if (payload_len > 7 && memcmp(packet->payload, "SPOTIFY", 7) == 0) {
            NDPI_LOG_INFO(ndpi_struct, "Detected Spotify over UDP\n");
            ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
            return;
        }
    }
} else if (packet->tcp != NULL) {
    /* Check known Spotify TCP ports, e.g., 4070 */
    if (htons(packet->tcp->source) == 4070 || htons(packet->tcp->dest) == 4070) {
        /* Check for a simple Spotify signature in payload */
        if (payload_len > 7 && memcmp(packet->payload, "SPOTIFY", 7) == 0) {
            NDPI_LOG_INFO(ndpi_struct, "Detected Spotify over TCP\n");
            ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
            return;
        }
    }
}

/* Check if the source or destination IP falls within a known Spotify range */
{
    uint32_t src_ip = ntohl(packet->iph->saddr);
    uint32_t dst_ip = ntohl(packet->iph->daddr);

    /* Example range check (78.31.8.0/21) */
    if ((src_ip >= 0x4E1F0800 && src_ip <= 0x4E1F0FFF) ||
        (dst_ip >= 0x4E1F0800 && dst_ip <= 0x4E1F0FFF)) {
        NDPI_LOG_INFO(ndpi_struct, "Detected Spotify via known IP range\n");
        ndpi_int_spotify_add_connection(ndpi_struct, stream, 0);
        return;
    }
}