for (++iterator; *iterator; ++iterator)
{
  hb_codepoint_t gid = (*iterator).first;
  unsigned klass = (*iterator).second;

  if (klass == prev_klass && gid == prev_gid + 1)
  {
    range_rec.last = gid;
    c->modify (record, range_rec);
  }
  else
  {
    rangeRecord.len = num_ranges;
    RangeRecord<Types> new_range_rec;
    new_range_rec.first = gid;
    new_range_rec.last = gid;
    new_range_rec.value = klass;

    auto *new_record = c->copy (new_range_rec);
    if (unlikely (!new_record)) return_trace (false);

    record = new_record;
    num_ranges++;
    prev_gid = gid;
    prev_klass = klass;
  }
}

range_rec.last = prev_gid;
c->modify (record, range_rec);
rangeRecord.len = num_ranges;
std::sort (rangeRecord.arrayZ, rangeRecord.arrayZ + num_ranges, [](const RangeRecord<Types> &a, const RangeRecord<Types> &b) { return a.first < b.first; });

return_trace (true);