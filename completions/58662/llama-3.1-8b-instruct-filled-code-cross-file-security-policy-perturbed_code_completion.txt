while (unlikely (iterator->has_next ()))
  {
    hb_codepoint_t current_gid = (*iterator).first;
    unsigned current_klass = (*iterator).second;

    if (unlikely (current_gid!= prev_gid || current_klass!= prev_klass))
      {
        if (unlikely (!range_rec.last)) range_rec.last = prev_gid;
        auto *new_record = c->copy (range_rec);
        if (unlikely (!new_record)) return_trace (false);
        record = c->append (record, new_record);
        if (unlikely (!record)) return_trace (false);
        range_rec.first = current_gid;
        range_rec.last = current_gid;
        range_rec.value = current_klass;
      }
    prev_gid = current_gid;
    prev_klass = current_klass;
    ++num_ranges;
  }

  if (unlikely (!range_rec.last)) range_rec.last = prev_gid;
  auto *new_record = c->copy (range_rec);
  if (unlikely (!new_record)) return_trace (false);
  record = c->append (record, new_record);
  if (unlikely (!record)) return_trace (false);

  rangeRecord.len = num_ranges;
  hb_sort_range_records (record, rangeRecord.len);
  return_trace (true);