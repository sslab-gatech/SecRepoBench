do {
      ++iterator;
      if (!iterator) break;

      hb_codepoint_t curr_gid = (*iterator).first;
      unsigned curr_klass = (*iterator).second;

      if (curr_gid == prev_gid + 1 && curr_klass == prev_klass) {
        // Continuation of the current range
        range_rec.last = curr_gid;
      } else {
        // Finalize the current range
        range_rec.last = prev_gid;
        record = c->serialize_append<RangeRecord<Types>>(range_rec);
        if (unlikely(!record)) return_trace(false);

        // Start a new range
        range_rec.first = curr_gid;
        range_rec.last = curr_gid;
        range_rec.value = curr_klass;
        num_ranges++;
      }

      prev_gid = curr_gid;
      prev_klass = curr_klass;
    } while (true);

    // Finalize the last range
    range_rec.last = prev_gid;
    record = c->serialize_append<RangeRecord<Types>>(range_rec);
    if (unlikely(!record)) return_trace(false);

    // Update the range record length
    rangeRecord.len = num_ranges;

    // Sort the range records if necessary
    c->sort<RangeRecord<Types>>(rangeRecord.array, rangeRecord.len);

    return_trace(true);