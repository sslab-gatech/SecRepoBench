for (Iterator it = ++iterator; it; ++it)
    {
      hb_codepoint_t gid = (*it).first;
      unsigned klass = (*it).second;

      if (gid == prev_gid + 1 && klass == prev_klass)
      {
        record->last = gid;
      }
      else
      {
        range_rec.first = gid;
        range_rec.last = gid;
        range_rec.value = klass;
        record = c->copy (range_rec);
        if (unlikely (!record)) return_trace (false);
        num_ranges++;
      }
      prev_gid = gid;
      prev_klass = klass;
    }

    rangeRecord.len = num_ranges;

    /* We sort the ranges to handle unsorted glyph order.
     * This is important for complex shapers that may not
     * provide glyphs in a sorted order. */
    hb_serialize_context_t::sort (c, this);

    return_trace (true);