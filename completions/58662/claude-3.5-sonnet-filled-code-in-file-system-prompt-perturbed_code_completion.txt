for (const auto& pair : iterator)
    {
      hb_codepoint_t gid = pair.first;
      unsigned klass = pair.second;

      if (gid != prev_gid + 1 || klass != prev_klass)
      {
        // Finalize the current range
        record->last = prev_gid;
        record = c->copy (range_rec);
        if (unlikely (!record)) return_trace (false);
        num_ranges++;

        // Start a new range
        range_rec.first = gid;
        range_rec.value = klass;
      }

      prev_gid = gid;
      prev_klass = klass;
    }

    // Finalize the last range
    record->last = prev_gid;

    // Update the range record length
    rangeRecord.len = num_ranges;

    // Sort the range records
    rangeRecord.as_array ().qsort ();