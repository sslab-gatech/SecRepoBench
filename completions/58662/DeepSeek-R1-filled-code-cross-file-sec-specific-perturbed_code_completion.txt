for (++iterator; iterator; ++iterator)
{
    hb_codepoint_t gid = (*iterator).first;
    unsigned klass = (*iterator).second;

    if (gid == prev_gid + 1 && klass == prev_klass)
    {
        record->last = gid;
        prev_gid = gid;
    }
    else
    {
        RangeRecord<Types> new_range;
        new_range.first = gid;
        new_range.last = gid;
        new_range.value = klass;

        record = c->copy(new_range);
        if (unlikely (!record)) return_trace(false);
        num_ranges++;
        prev_gid = gid;
        prev_klass = klass;
    }
}

rangeRecord.len = num_ranges;

if (unlikely (num_ranges && !rangeRecord.sanitize(c)))
    return_trace(false);

if (num_ranges > 1)
    hb_sort(rangeRecord.arrayZ, num_ranges, RangeRecord<Types>::cmp);

return_trace(true);