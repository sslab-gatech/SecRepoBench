++iterator;
    for (; iterator ; ++iterator)
    {
      hb_codepoint_t gid = (*iterator).first;
      unsigned klass = (*iterator).second;

      if (gid == prev_gid + 1 && klass == prev_klass)
      {
	record->last = gid;
      }
      else
      {
	num_ranges++;
	range_rec.first = gid;
	range_rec.last = gid;
	range_rec.value = klass;

	record = c->copy (range_rec);
	if (unlikely (!record)) return_trace (false);
      }

      prev_gid = gid;
      prev_klass = klass;
    }

    if (num_ranges > 1)
      c->sort (c->length () - num_ranges, num_ranges, compare_range_records<Types>);

    rangeRecord.len = num_ranges;
    classFormat = 2;

    return_trace (true);