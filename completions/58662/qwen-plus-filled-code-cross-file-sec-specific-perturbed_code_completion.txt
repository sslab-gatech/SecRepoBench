for (++iterator; *iterator; ++iterator)
{
  hb_codepoint_t gid = (*iterator).first;
  unsigned klass = (*iterator).second;

  if (klass == prev_klass && gid == prev_gid + 1)
  {
    range_rec.last = gid;
  }
  else
  {
    record->last = range_rec.last;
    num_ranges++;

    range_rec.first = gid;
    range_rec.last = gid;
    range_rec.value = klass;

    auto *new_record = c->serialize_append<RangeRecord<Types>>();
    if (unlikely (!new_record)) return_trace (false);
    *new_record = range_rec;

    record = new_record;
  }

  prev_gid = gid;
  prev_klass = klass;
}

record->last = range_rec.last;
rangeRecord.len = num_ranges;

if (unlikely (!c->sort (rangeRecord.arrayZ, rangeRecord.len, &RangeRecord<Types>::cmp))) return_trace (false);

return_trace (true);