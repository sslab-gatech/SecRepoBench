for (++iterator; iterator; ++iterator)
  {
    hb_codepoint_t curr_gid = (*iterator).first;
    unsigned curr_klass = (*iterator).second;

    if (unlikely (curr_gid == range_rec.last + 1 && curr_klass == range_rec.value))
    {
      // Continuation of the current range.
      range_rec.last = curr_gid;
    }
    else
    {
      // Finalize the previous range.
      record->last = range_rec.last;

      // Increment range count and start a new range.
      num_ranges++;
      range_rec.first = curr_gid;
      range_rec.last = curr_gid;
      range_rec.value = curr_klass;

      auto *new_record = c->copy (range_rec);
      if (unlikely (!new_record)) return_trace (false);

      record = new_record;
    }
  }

  // Finalize the last range.
  record->last = range_rec.last;

  // Update the total number of ranges and format.
  rangeRecord.len = num_ranges;
  classFormat = 2;

  // Sort the range records if glyphs are not guaranteed to be in ascending order.
  // (Assuming the serialization context provides a way to sort the embedded data,
  //  otherwise a sorting routine would be called here.)

  return_trace (true);