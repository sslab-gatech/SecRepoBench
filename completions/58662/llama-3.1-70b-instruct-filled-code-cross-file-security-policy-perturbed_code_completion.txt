for (++iterator; iterator; ++iterator)
{
  hb_codepoint_t gid = (*iterator).first;
  unsigned klass = (*iterator).second;

  if (gid == prev_gid + 1 && klass == prev_klass)
  {
    range_rec.last = gid;
  }
  else
  {
    range_rec.last = prev_gid;
    if (unlikely (!c->copy (range_rec))) return_trace (false);
    range_rec.first = gid;
    range_rec.last = gid;
    range_rec.value = klass;
    num_ranges++;
  }

  prev_gid = gid;
  prev_klass = klass;
}

range_rec.last = prev_gid;
if (unlikely (!c->copy (range_rec))) return_trace (false);

rangeRecord.len = num_ranges;
if (unlikely (!c->sort_and_unique (rangeRecord))) return_trace (false);

return_trace (true);