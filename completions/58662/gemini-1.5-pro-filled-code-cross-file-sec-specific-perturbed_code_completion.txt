++iterator;
    while (iterator)
    {
      hb_codepoint_t gid = (*iterator).first;
      unsigned klass = (*iterator).second;

      if (gid != prev_gid + 1 || klass != prev_klass)
      {
        record->last = prev_gid;

        range_rec.first = gid;
        range_rec.last = gid;
        range_rec.value = klass;

        record = c->copy (range_rec);
        if (unlikely (!record)) return_trace (false);

        num_ranges++;
      }

      prev_gid = gid;
      prev_klass = klass;
      ++iterator;
    }

    record->last = prev_gid;

    rangeRecord.len = num_ranges;
    if (num_ranges > 1)
      c->sort (c->start (), rangeRecord.len, sizeof (RangeRecord<Types>));

    return_trace (true);