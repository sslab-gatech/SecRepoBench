for (++iterator; iterator; ++iterator)
{
  hb_codepoint_t gid = (*iterator).first;
  unsigned klass = (*iterator).second;

  if (gid != prev_gid + 1 || klass != prev_klass)
  {
    record->last = prev_gid;
    record = c->copy (range_rec);
    if (unlikely (!record)) return_trace (false);
    num_ranges++;
    range_rec.first = gid;
    range_rec.value = klass;
  }

  prev_gid = gid;
  prev_klass = klass;
}

record->last = prev_gid;

classFormat = 2;
rangeRecord.len = num_ranges;

if (unlikely (!c->check_assign (rangeRecord.len, num_ranges))) return_trace (false);

if (num_ranges > 1)
{
  auto *records = c->start_embed<RangeRecord<Types>> ();
  if (unlikely (!records)) return_trace (false);
  if (unlikely (!c->check_range (records, num_ranges))) return_trace (false);
  
  qsort (records, num_ranges, sizeof (RangeRecord<Types>),
         RangeRecord<Types>::cmp_range);
}

return_trace (true);