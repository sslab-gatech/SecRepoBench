for (++iterator; iterator; ++iterator)
{
  hb_codepoint_t cur_gid = (*iterator).first;
  unsigned cur_klass = (*iterator).second;

  if (cur_gid != prev_gid + 1 || cur_klass != prev_klass)
  {
    /* Finalize the current range. */
    record->last = prev_gid;

    /* Add the existing range to the array. */
    auto *added = rangeRecord.serialize_append(c, *record);
    if (unlikely(!added)) return_trace(false);

    /* Prepare a new range record. */
    range_rec.first = cur_gid;
    range_rec.last = cur_gid;
    range_rec.value = cur_klass;
    record = c->copy(range_rec);
    if (unlikely(!record)) return_trace(false);

    num_ranges++;
  }
  else
  {
    /* Continue the existing range. */
  }

  prev_gid = cur_gid;
  prev_klass = cur_klass;
}

/* Finalize the last range after the loop. */
record->last = prev_gid;
auto *added = rangeRecord.serialize_append(c, *record);
if (unlikely(!added)) return_trace(false);

/* Update the total number of ranges. */
rangeRecord.len = num_ranges;

/* Sort the range records in case of any unsorted input. */
+ rangeRecord.as_array() | hb_sort([](auto &a, auto &b) {
  return (a.first < b.first) ? -1 : (a.first > b.first);
});

/* Finished building the rangeRecord list. */
classFormat = 2;
return_trace(true);