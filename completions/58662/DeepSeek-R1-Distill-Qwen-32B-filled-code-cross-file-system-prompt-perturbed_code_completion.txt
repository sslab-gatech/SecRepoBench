while (iterator++)
    {
      hb_codepoint_t gid = iterator->first;
      unsigned klass = iterator->second;

      if (gid == prev_gid + 1 && klass == prev_klass)
      {
        prev_gid = gid;
      }
      else
      {
        range_rec.last = prev_gid;
        if (unlikely (!c->copy (range_rec))) return_trace (false);
        num_ranges++;

        range_rec.first = gid;
        range_rec.last = gid;
        range_rec.value = klass;
        prev_gid = gid;
        prev_klass = klass;
      }
    }

    range_rec.last = prev_gid;
    if (unlikely (!c->copy (range_rec))) return_trace (false);
    num_ranges++;

    rangeRecord.len = num_ranges;
    hb_sort (rangeRecord.arrayZ, num_ranges, sizeof (RangeRecord<Types>), [](const void *a, const void *b) {
      return ((const RangeRecord<Types> *)a)->first - ((const RangeRecord<Types> *)b)->first;
    });

    return_trace (true);