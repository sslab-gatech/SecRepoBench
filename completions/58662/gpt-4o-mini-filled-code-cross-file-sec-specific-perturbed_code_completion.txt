while (iterator.next())
    {
        hb_codepoint_t current_gid = (*iterator).first;
        unsigned current_klass = (*iterator).second;

        if (current_gid != prev_gid + 1 || current_klass != prev_klass)
        {
            // Finalize the current range
            range_rec.last = prev_gid;
            range_rec.len = range_rec.last - range_rec.first + 1;

            // Copy the finalized range record into the serialization context
            auto *new_record = c->copy(range_rec);
            if (unlikely(!new_record)) return_trace(false);

            // Start a new range record
            range_rec.first = current_gid;
            range_rec.last = current_gid;
            range_rec.value = current_klass;
        }
        else
        {
            // Continue the current range
            range_rec.last = current_gid;
        }

        // Update previous values for the next iteration
        prev_gid = current_gid;
        prev_klass = current_klass;
    }

    // Finalize the last range record
    range_rec.last = prev_gid;
    range_rec.len = range_rec.last - range_rec.first + 1;
    auto *final_record = c->copy(range_rec);
    if (unlikely(!final_record)) return_trace(false);

    // Update the range record length to reflect the number of ranges processed
    // Assuming a method to update the count of ranges in the context
    c->update_range_count();

    // Sort the range records if necessary
    c->sort_range_records();

    return_trace(true);