iterator++;
while (unlikely (iterator))
{
  hb_codepoint_t gid = (*iterator).first;
  unsigned klass = (*iterator).second;

  if (gid != prev_gid + 1 || klass != prev_klass)
  {
    range_rec.last = prev_gid;
    auto *record = c->copy (range_rec);
    if (unlikely (!record)) return_trace (false);

    range_rec.first = gid;
    range_rec.last = gid;
    range_rec.value = klass;
  }
  else
  {
    range_rec.last = gid;
  }

  prev_gid = gid;
  prev_klass = klass;

  iterator++;
}

range_rec.last = prev_gid;
auto *record = c->copy (range_rec);
if (unlikely (!record)) return_trace (false);

rangeRecord.len = c->get_length ();
if (unlikely (rangeRecord.len == 0)) return_trace (false);

// Sort the range records to handle any unsorted glyph order.
std::sort (reinterpret_cast<RangeRecord<Types>*>(c->get_buffer ()),
           reinterpret_cast<RangeRecord<Types>*>(c->get_buffer () + rangeRecord.len));

return_trace (true);