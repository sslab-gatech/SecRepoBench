for (; iterator->hasNext(); ++iterator) {
      hb_codepoint_t curr_gid = (*iterator).first;
      unsigned curr_klass = (*iterator).second;

      if (curr_gid != prev_gid + 1 || curr_klass != prev_klass) {
        range_rec.last = prev_gid;
        record->last = prev_gid;
        if (unlikely (!c->append (record))) return_trace (false);
        ++num_ranges;
        range_rec.first = curr_gid;
        range_rec.last = curr_gid;
        range_rec.value = curr_klass;
        record = c->copy (range_rec);
        if (unlikely (!record)) return_trace (false);
      } else {
        range_rec.last = curr_gid;
        record->last = curr_gid;
      }
      prev_gid = curr_gid;
      prev_klass = curr_klass;
    }
    range_rec.last = prev_gid;
    record->last = prev_gid;
    if (unlikely (!c->append (record))) return_trace (false);
    rangeRecord.len = num_ranges;
    c->sort (rangeRecord);
    return_trace (true);