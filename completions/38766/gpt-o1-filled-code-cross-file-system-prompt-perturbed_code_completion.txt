{
	const uint8_t *p;
	ssize_t bytes_avail;

	/* Read 9 bytes from the archive to extract the magic numbers
	 * and LZMA parameters. */
	p = __archive_read_ahead(a, 9, &bytes_avail);
	if (p == NULL || bytes_avail < 9) {
		archive_set_error(&a->archive, ARCHIVE_ERRNO_FILE_FORMAT,
		    "Truncated lzma file body");
		return (ARCHIVE_FATAL);
	}

	/* Validate the 2-byte magic signature. */
	if (p[0] != 0x09 || p[1] != 0x14) {
		archive_set_error(&a->archive, ARCHIVE_ERRNO_FILE_FORMAT,
		    "Invalid lzma file signature in zipx (0x%02x, 0x%02x)",
		    p[0], p[1]);
		return (ARCHIVE_FAILED);
	}

	/* Validate the next 2 bytes, which should be 0x05, 0x00
	 * in this version of the zipx-lzma format. */
	if (p[2] != 0x05 || p[3] != 0x00) {
		archive_set_error(&a->archive, ARCHIVE_ERRNO_FILE_FORMAT,
		    "Invalid lzma stream flags in zipx (0x%02x, 0x%02x)",
		    p[2], p[3]);
		return (ARCHIVE_FAILED);
	}

	/* If everything is valid, use this pointer to build the
	 * "lzma alone" header that the library expects. */
	lzma_stream_pointer = p;
}