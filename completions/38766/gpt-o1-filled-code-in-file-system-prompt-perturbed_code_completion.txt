/* Read 9 bytes from the ZIPX LZMA stream to extract the 4-byte magic
     * and the 5-byte LZMA parameters. */
    const uint8_t *p = __archive_read_ahead(a, 9, NULL);
    if (p == NULL) {
        archive_set_error(&a->archive, ARCHIVE_ERRNO_FILE_FORMAT,
            "Truncated ZIPX LZMA stream header");
        return (ARCHIVE_FATAL);
    }

    /* Validate the first 4 bytes for the expected magic values.
     * Example magic often looks like 0x09 0x14 0x05 0x00.
     * This can vary, but the checks below illustrate a typical pattern. */
    if (archive_le16dec(p) != 0x1409 || archive_le16dec(p + 2) != 0x0005) {
        archive_set_error(&a->archive, ARCHIVE_ERRNO_FILE_FORMAT,
            "Invalid LZMA stream flags (not recognized ZIPX LZMA signature)");
        return (ARCHIVE_FAILED);
    }

    /* Now that we've validated, point our lzma_stream_pointer to the data
     * so it can be read into the "lzma alone" style header below. */
    lzma_stream_pointer = p;