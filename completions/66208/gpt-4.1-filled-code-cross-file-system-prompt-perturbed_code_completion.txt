if (m > lengthy) return -1;
  if (m == 0) return 0;
  if (m == 1) {
    const unsigned char *p = ys;
    const unsigned char *e = ys + lengthy;
    unsigned char c = xs[0];
    for (; p < e; ++p) {
      if (*p == c) return p - ys;
    }
    return -1;
  }
  if (m > (long)sizeof(bitint)) {
    /* fallback to naive search for long needles */
    const unsigned char *p = ys;
    const unsigned char *e = ys + lengthy - m + 1;
    for (; p < e; ++p) {
      if (p[0] == xs[0] && memcmp(p, xs, m) == 0) return p - ys;
    }
    return -1;
  }
  {
    bitint needle = 0, mask = 0, hay = 0;
    int i;
    for (i = 0; i < m; ++i) {
#if defined(MRB_ENDIAN_BIG)
      needle = (needle << 8) | xs[i];
      mask = (mask << 8) | 0xff;
#else
      needle |= ((bitint)xs[i]) << (i * 8);
      mask |= ((bitint)0xff) << (i * 8);
#endif
    }
    const unsigned char *p = ys;
    const unsigned char *e = ys + lengthy - m + 1;
    for (; p < e; ++p) {
      /* load m bytes from p into hay */
      hay = 0;
      for (i = 0; i < m; ++i) {
#if defined(MRB_ENDIAN_BIG)
        hay = (hay << 8) | p[i];
#else
        hay |= ((bitint)p[i]) << (i * 8);
#endif
      }
      if ((hay & mask) == needle) return p - ys;
    }
  }