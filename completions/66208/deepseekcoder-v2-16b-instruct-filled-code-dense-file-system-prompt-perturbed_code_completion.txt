bitint x_mask = MASK1 * (bitint)m;
  bitint y_mask = MASK1 * (bitint)lengthy;
  bitint x_mask2 = MASK2 * (bitint)m;
  bitint y_mask2 = MASK2 * (bitint)lengthy;
  bitint x_mask3 = MASK3 * (bitint)m;
  bitint y_mask3 = MASK3 * (bitint)lengthy;

  if (m > lengthy) return -1;

  if (m == 1) {
    const unsigned char *p = (const unsigned char*)memchr(ys, *xs, lengthy);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  if (m == 0) return 0;

  if (m == lengthy) {
    if (memcmp(xs, ys, m) == 0) return 0;
    return -1;
  }

  bitint x_hash = 0;
  bitint y_hash = 0;

  for (long i = 0; i < m; i++) {
    x_hash = (x_hash << 8) | xs[i];
    y_hash = (y_hash << 8) | ys[i];
  }

  if (x_hash == y_hash && memcmp(xs, ys, m) == 0) return 0;

  for (long i = m; i < lengthy; i++) {
    y_hash = ((y_hash << 8) | ys[i]) & y_mask;
    if (y_hash == x_hash && memcmp(xs, &ys[i - m + 1], m) == 0) return (mrb_int)(i - m + 1);
  }

  return -1;
}