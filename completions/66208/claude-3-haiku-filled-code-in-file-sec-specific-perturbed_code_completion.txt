static inline mrb_int
mrb_memsearch_ss(const unsigned char *xs, long m, const unsigned char *ys, long lengthy)
{
#ifdef MRB_64BIT
#define bitint uint64_t
#define MASK1 0x0101010101010101ull
#define MASK2 0x7f7f7f7f7f7f7f7full
#define MASK3 0x8080808080808080ull
#else
#define bitint uint32_t
#define MASK1 0x01010101ul
#define MASK2 0x7f7f7f7ful
#define MASK3 0x80808080ul
#endif
#if defined(MRB_ENDIAN_BIG)
#ifdef MRB_64BIT
#define MASK4 0x8000000000000000ull
#else
#define MASK4 0x80000000ul
#endif
#else
#define MASK4 0x80
#endif

  bitint a, b, c;
  const unsigned char *x = xs, *y = ys;
  long i;

  if (m > lengthy) return -1;
  if (m == 0) return 0;

  a = MASK1 * x[0];

  for (i = 0; i <= lengthy - m; i++) {
    b = *(bitint *)(y + i);
    c = (b ^ a) - MASK1 * 0x01010101;
    if ((c & ~b & MASK3) != 0) {
      while (y[i] != x[0]) {
        i++;
        if (i > lengthy - m) return -1;
      }
      if (memcmp(x, y + i, m) == 0) return i;
    }
  }

  return -1;
}