bitint hx, hy;
  int i;
  const unsigned char *x = xs, *y = ys;
  unsigned char first = *xs;
  
  // Handle edge cases
  if (m <= 0) return 0;  // Empty pattern matches at position 0
  if (lengthy <= 0 || lengthy < m) return -1;  // Empty haystack or haystack is shorter than pattern
  
  // For single byte pattern, use simple loop
  if (m == 1) {
    for (i = 0; i < lengthy; i++) {
      if (ys[i] == first) {
        return i;
      }
    }
    return -1;
  }
  
  // Main search loop with bounds checking
  const unsigned char *yend = ys + lengthy - m + 1;
  while (y < yend) {
    if (*y == first) {  // First character matches
      for (i = 1; i < m; i++) {
        if (y[i] != xs[i]) {
          break;
        }
      }
      if (i == m) {  // Full match found
        return (mrb_int)(y - ys);
      }
    }
    y++;
  }