bitint h = 0, g;
  const unsigned char *end = xs + m;
  const unsigned char *p = ys + lengthy - m;

  for (; p < ys + lengthy; p++) {
    h = (h << 8) | *p;
    if (p >= end) h ^= MASK4;
  }

  for (; p > ys; p--) {
    if ((h & MASK1) == (*xs & MASK1) &&
        ((h & MASK2) >> 7) == ((*xs & MASK2) >> 7) &&
        ((h & MASK3) >> 8) == ((*xs & MASK3) >> 8)) {
      return p - ys;
    }
    h = (h << 8) | *p;
    if (p >= end) h ^= MASK4;
    h ^= (*xs++ << 8);
  }

  return -1;