if (!quic_hp_cipher_init(&ciphers.hp_cipher, GCRY_MD_SHA256, 16, client_secret, version)) {
  NDPI_LOG_DBG(ndpi_struct, "Failed to initialize header protection cipher\n");
  return NULL;
}

/* 
   Compute the header length before the encrypted packet number.
   QUIC Long Header (Initial Packet) format expected:
   [1-byte flags] [4-byte version] 
   [1-byte DCID length] [DCID (dest_conn_id_len bytes)]
   [1-byte SCID length] [SCID (src_conn_id_len bytes)]
*/
offset = 1 + 4 + 1 + dest_conn_id_len + 1 + src_conn_id_len;

/* 
   Next comes a variable-length Token field.
   For simplicity, assume the token length is encoded in a single byte.
*/
token_length = packet->payload[offset];
offset += 1; /* move past token length field */

/* Skip the token itself */
offset += token_length;

/*
   After the token, a variable-length length field indicates the length of the rest
   of the packet (encrypted payload + packet number and auth tag). Again, assume a one-byte length.
*/
payload_length = packet->payload[offset];
offset += 1;

/*
   The Packet Number immediately follows the length field.
   Save its offset for later processing.
*/
pn_offset = offset;

NDPI_LOG_DBG2(ndpi_struct, "Initial packet: token_length=%llu, payload_length=%llu, pn_offset=%u\n",
              token_length, payload_length, pn_offset);