/* Initialize header protection cipher */
  if (!quic_hp_cipher_init(&ciphers.hp_cipher, GCRY_MD_SHA256, 16, client_secret, version)) {
    NDPI_LOG_DBG(ndpi_struct, "Error initializing header protection cipher\n");
    return NULL;
  }

  /* Initialize payload protection cipher */
  if (!quic_pp_cipher_init(&ciphers.pp_cipher, GCRY_MD_SHA256, 16, client_secret, version)) {
    NDPI_LOG_DBG(ndpi_struct, "Error initializing payload protection cipher\n");
    quic_ciphers_reset(&ciphers);
    return NULL;
  }

  /* Calculate packet number offset */
  pn_offset = 5 + src_conn_id_len + dest_conn_id_len;
  if (packet->payload_packet_len < pn_offset) {
    NDPI_LOG_DBG(ndpi_struct, "Packet too short for pn_offset calculation\n");
    quic_ciphers_reset(&ciphers);
    return NULL;
  }

  /* Determine token length and add to offset */
  token_length = ndpi_read_varlen(packet->payload + pn_offset, 1);
  pn_offset += 1 + token_length;

  /* Retrieve payload length */
  payload_length = ndpi_read_varlen(packet->payload + pn_offset, 2);
  pn_offset += 2;

  NDPI_LOG_DBG2(ndpi_struct, "pn_offset: %u, token_length: %lu, payload_length: %lu\n",
                pn_offset, token_length, payload_length);