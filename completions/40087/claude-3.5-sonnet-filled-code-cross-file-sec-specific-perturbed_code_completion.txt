if (quic_hp_cipher_init(&ciphers.hp_cipher, GCRY_MD_SHA256, 16, client_secret, version) != 1) {
  NDPI_LOG_DBG(ndpi_struct, "Error initializing HP cipher\n");
  return NULL;
}

pn_offset = 6 + dest_conn_id_len + src_conn_id_len;

if (pn_offset + 6 > packet->payload_packet_len) {
  NDPI_LOG_DBG(ndpi_struct, "Packet too short for token length\n");
  quic_ciphers_reset(&ciphers);
  return NULL;
}

token_length = quic_len(&packet->payload[pn_offset], &offset);
pn_offset += offset;

if (pn_offset + token_length + 6 > packet->payload_packet_len) {
  NDPI_LOG_DBG(ndpi_struct, "Packet too short for payload length\n");
  quic_ciphers_reset(&ciphers);
  return NULL;
}

pn_offset += token_length;
payload_length = quic_len(&packet->payload[pn_offset], &offset);
pn_offset += offset;

NDPI_LOG_DBG2(ndpi_struct, "PN offset: %u, payload length: %lu\n", pn_offset, payload_length);