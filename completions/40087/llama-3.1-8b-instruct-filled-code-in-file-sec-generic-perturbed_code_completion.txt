if (pn_offset + payload_length > packet->payload_packet_len) {
    NDPI_LOG_DBG(ndpi_struct, "Too short %d %d\n", pn_offset + payload_length,
                 packet->payload_packet_len);
    quic_ciphers_reset(&ciphers);
    return NULL;
}

if (is_version_with_ietf_long_header(version)) {
    dest_conn_id_len = packet->payload[5];
    source_conn_id_len = packet->payload[5 + 1 + dest_conn_id_len];
    if (dest_conn_id_len > QUIC_MAX_CID_LENGTH ||
        source_conn_id_len > QUIC_MAX_CID_LENGTH) {
      NDPI_LOG_DBG2(ndpi_struct, "Version 0x%x invalid CIDs length %u %u",
                     version, dest_conn_id_len, source_conn_id_len);
      return 0;
    }
}

if (is_version_with_tls(version)) {
    process_tls(ndpi_struct, flow, crypto_data, crypto_data_len, version);
} else {
    process_chlo(ndpi_struct, flow, crypto_data, crypto_data_len);
}

if (is_ch_reassembler_pending(flow)) {
    ndpi_search_quic(ndpi_struct, flow);
    if (is_ch_reassembler_pending(flow))
        return 1;
    flow->extra_packets_func = NULL;
    return 0;
}

if (is_version_with_var_int_transport_params(version)) {
    flow->check_extra_packets = 1;
    flow->max_extra_packets_to_check = 24; /* TODO */
    flow->extra_packets_func = ndpi_search_quic_extra;
} else if (!crypto_data) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
}