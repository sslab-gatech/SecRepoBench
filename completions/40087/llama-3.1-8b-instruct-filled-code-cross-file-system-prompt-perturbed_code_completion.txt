// Prepare the cipher context with the provided client secret and version.
ciphers.hp_cipher = malloc(sizeof(struct gcry_cipher));
if (!quic_hp_cipher_init(ciphers.hp_cipher, GCRY_MD_SHA256, HASH_SHA2_256_LENGTH, client_secret, version)) {
  NDPI_LOG_DBG(ndpi_struct, "Failed to initialize HP cipher\n");
  return NULL;
}

// Calculate the packet number offset.
pn_offset = 0;

// Determine the length of the tokens and add it to the offset.
token_length = 0;
payload_length = packet->payload_packet_len;
while (payload_length >= 4) {
  uint32_t token = pntoh32(packet->payload + pn_offset);
  if (token == 0) {
    break;
  }
  token_length += 4;
  payload_length -= 4;
  pn_offset += 4;
}

// Retrieve the payload length from the packet, updating the packet number offset.
if (payload_length < 4) {
  NDPI_LOG_DBG(ndpi_struct, "Invalid payload length\n");
  return NULL;
}
payload_length = pntoh32(packet->payload + pn_offset);
pn_offset += 4;

// Log the calculated offsets and lengths for debugging purposes.
NDPI_LOG_DBG(ndpi_struct, "pn_offset: %u, token_length: %u, payload_length: %u\n", pn_offset, token_length, payload_length);