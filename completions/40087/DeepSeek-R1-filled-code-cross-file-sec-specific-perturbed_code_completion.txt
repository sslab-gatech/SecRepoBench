offset = 1 + dest_conn_id_len + 1 + src_conn_id_len;

  if(offset >= packet->payload_packet_len) {
    NDPI_LOG_DBG(ndpi_struct, "Invalid initial offset\n");
    quic_ciphers_reset(&ciphers);
    return NULL;
  }

  /* Parse token length (varint) */
  uint8_t token_byte = packet->payload[offset];
  if((token_byte & 0xC0) == 0xC0) {
    if(offset + 8 > packet->payload_packet_len) {
      quic_ciphers_reset(&ciphers);
      return NULL;
    }
    token_length = ((uint64_t)(token_byte & 0x3F) << 56) | ((uint64_t)packet->payload[offset+1] << 48) |
                   ((uint64_t)packet->payload[offset+2] << 40) | ((uint64_t)packet->payload[offset+3] << 32) |
                   ((uint64_t)packet->payload[offset+4] << 24) | ((uint64_t)packet->payload[offset+5] << 16) |
                   ((uint64_t)packet->payload[offset+6] << 8) | (uint64_t)packet->payload[offset+7];
    offset += 8;
  } else if((token_byte & 0x80) == 0x80) {
    if(offset + 4 > packet->payload_packet_len) {
      quic_ciphers_reset(&ciphers);
      return NULL;
    }
    token_length = ((uint32_t)(token_byte & 0x3F) << 24) | ((uint32_t)packet->payload[offset+1] << 16) |
                   ((uint32_t)packet->payload[offset+2] << 8) | (uint32_t)packet->payload[offset+3];
    offset += 4;
  } else if((token_byte & 0x40) == 0x40) {
    if(offset + 2 > packet->payload_packet_len) {
      quic_ciphers_reset(&ciphers);
      return NULL;
    }
    token_length = ((uint16_t)(token_byte & 0x3F) << 8) | (uint16_t)packet->payload[offset+1];
    offset += 2;
  } else {
    token_length = token_byte & 0x3F;
    offset += 1;
  }

  if(offset + token_length > packet->payload_packet_len) {
    NDPI_LOG_DBG(ndpi_struct, "Token exceeds packet length\n");
    quic_ciphers_reset(&ciphers);
    return NULL;
  }
  offset += token_length;

  /* Parse payload length (varint) */
  if(offset >= packet->payload_packet_len) {
    quic_ciphers_reset(&ciphers);
    return NULL;
  }
  uint8_t len_byte = packet->payload[offset];
  if((len_byte & 0xC0) == 0xC0) {
    if(offset + 8 > packet->payload_packet_len) {
      quic_ciphers_reset(&ciphers);
      return NULL;
    }
    payload_length = ((uint64_t)(len_byte & 0x3F) << 56) | ((uint64_t)packet->payload[offset+1] << 48) |
                     ((uint64_t)packet->payload[offset+2] << 40) | ((uint64_t)packet->payload[offset+3] << 32) |
                     ((uint64_t)packet->payload[offset+4] << 24) | ((uint64_t)packet->payload[offset+5] << 16) |
                     ((uint64_t)packet->payload[offset+6] << 8) | (uint64_t)packet->payload[offset+7];
    offset +