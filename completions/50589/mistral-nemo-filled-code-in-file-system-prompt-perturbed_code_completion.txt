if (m_cachePos >= m_cacheSize) {
    if (!readNextBlock()) {
        return false;
    }
    m_cachePos = 0;
}

size_t i = 0;
for (;;) {
    if (IsLineEnd(m_cache[m_cachePos])) {
        break;
    }

    line[i] = m_cache[m_cachePos];
    ++m_cachePos;
    ++i;

    if (i == line.size()) {
        line.resize(line.size() * 2);
    }

    if (isEndOfCache(m_cachePos, m_cacheSize)) {
        break;
    }
}

line[i] = '\0';
return true;