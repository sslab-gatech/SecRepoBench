line.clear();

    while (true) {
        if (m_cachePos >= m_cache.size()) {
            if (!readNextBlock()) {
                return !line.empty();
            }
            m_cachePos = 0;
        }

        size_t lineEnd = m_cachePos;
        while (lineEnd < m_cache.size() && m_cache[lineEnd] != '\n') {
            ++lineEnd;
        }

        if (lineEnd < m_cache.size()) {
            if (lineEnd > m_cachePos && m_cache[lineEnd - 1] == '\r') {
                line.insert(line.end(), m_cache.begin() + m_cachePos, m_cache.begin() + lineEnd - 1);
            } else {
                line.insert(line.end(), m_cache.begin() + m_cachePos, m_cache.begin() + lineEnd);
            }
            m_cachePos = lineEnd + 1;
            return true;
        } else {
            line.insert(line.end(), m_cache.begin() + m_cachePos, m_cache.end());
            m_cachePos = m_cache.size();
        }
    }