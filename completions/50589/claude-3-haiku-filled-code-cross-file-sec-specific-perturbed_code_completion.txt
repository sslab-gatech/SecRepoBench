// <MASK>
    size_t lineStart = m_cachePos;
    size_t lineEnd = m_cachePos;

    // Find the end of the line
    while (lineEnd < m_cache.size() && m_cache[lineEnd] != '\n' && m_cache[lineEnd] != '\r') {
        ++lineEnd;
    }

    // If we reached the end of the cache, refill it
    if (lineEnd == m_cache.size()) {
        if (!readNextBlock()) {
            return false;
        }
        lineStart = 0;
        lineEnd = 0;
        while (lineEnd < m_cache.size() && m_cache[lineEnd] != '\n' && m_cache[lineEnd] != '\r') {
            ++lineEnd;
        }
    }

    // Copy the line to the output buffer
    line.resize(lineEnd - lineStart);
    std::copy(m_cache.begin() + lineStart, m_cache.begin() + lineEnd, line.begin());

    // Skip over the end-of-line characters
    while (lineEnd < m_cache.size() && (m_cache[lineEnd] == '\n' || m_cache[lineEnd] == '\r')) {
        ++lineEnd;
    }
    m_cachePos = lineEnd;

    return true;