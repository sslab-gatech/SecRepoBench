const uint8_t* compressedUnknownBuf;
    const uint8_t* compressedAcBuf;
    const uint8_t* compressedDcBuf;
    const uint8_t* compressedRleBuf;

    if (iSize < headerSize) return EXR_ERR_CORRUPT_CHUNK;

    memset (uncompressed_data, 0, uncompressed_size);

    memcpy (counters, inPtr, headerSize);
    priv_to_native64 (counters, NUM_SIZES_SINGLE);

    version                 = counters[VERSION];
    unknownUncompressedSize = counters[UNKNOWN_UNCOMPRESSED_SIZE];
    unknownCompressedSize   = counters[UNKNOWN_COMPRESSED_SIZE];
    acCompressedSize        = counters[AC_COMPRESSED_SIZE];
    dcCompressedBytes       = counters[DC_COMPRESSED_SIZE];
    rleCompressedSize       = counters[RLE_COMPRESSED_SIZE];
    rleUncompressedSize     = counters[RLE_UNCOMPRESSED_SIZE];
    rleRawSize              = counters[RLE_RAW_SIZE];

    totalAcUncompressedCount = counters[AC_UNCOMPRESSED_COUNT];
    totalDcUncompressedCount = counters[DC_UNCOMPRESSED_COUNT];

    acCompression = counters[AC_COMPRESSION];

    compressedSize = unknownCompressedSize + acCompressedSize +
                     dcCompressedBytes + rleCompressedSize;

    dataPtr  = inPtr + headerSize;
    dataLeft = iSize - headerSize;

    if (compressedSize > dataLeft) { return EXR_ERR_CORRUPT_CHUNK; }

    if (version >= 2)
    {
        rv = DwaCompressor_readChannelRules (
            me, &dataPtr, &dataLeft, &headerSize);
        if (rv != EXR_ERR_SUCCESS) return rv;
    }
    else
    {
        me->_channelRules = sLegacyChannelRules;
        me->_channelRuleCount =
            sizeof (sLegacyChannelRules) / sizeof (Classifier);
    }

    rv = DwaCompressor_initializeBuffers (me, &outBufferSize);
    if (rv != EXR_ERR_SUCCESS) return rv;

    if (uncompressed_size > outBufferSize) { return EXR_ERR_OUT_OF_MEMORY; }

    outBufferEnd = (uint8_t*) uncompressed_data;

    packedAcBufferEnd = me->_packedAcBuffer;
    packedDcBufferEnd = me->_packedDcBuffer;

    compressedUnknownBuf = dataPtr;
    dataPtr += unknownCompressedSize;

    compressedAcBuf = dataPtr;
    dataPtr += acCompressedSize;

    compressedDcBuf = dataPtr;
    dataPtr += dcCompressedBytes;

    compressedRleBuf = dataPtr;
    dataPtr += rleCompressedSize;