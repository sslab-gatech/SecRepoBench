if (iSize < headerSize) return EXR_ERR_CORRUPT_CHUNK;

    memset (uncompressed_data, 0, uncompressed_size);

    //
    // Copy header information into an array and convert it from XDR format to native format
    //

    const uint8_t* ptr = inPtr;
    for (int i = 0; i < NUM_SIZES_SINGLE; ++i)
    {
        counters[i] = eight_from_xdr (ptr);
        ptr += sizeof (uint64_t);
    }

    version                  = counters[VERSION];
    unknownUncompressedSize = counters[UNKNOWN_UNCOMPRESSED_BYTE_COUNT];
    unknownCompressedSize   = counters[UNKNOWN_COMPRESSED_BYTE_COUNT];
    acCompressedSize        = counters[AC_COMPRESSED_BYTE_COUNT];
    dcCompressedBytes       = counters[DC_COMPRESSED_BYTE_COUNT];
    rleCompressedSize       = counters[RLE_COMPRESSED_BYTE_COUNT];
    rleUncompressedSize     = counters[RLE_UNCOMPRESSED_BYTE_COUNT];
    rleRawSize              = counters[RLE_RAW_BYTE_COUNT];
    totalAcUncompressedCount = counters[TOTAL_AC_UNCOMPRESSED_COUNT];
    totalDcUncompressedCount = counters[TOTAL_DC_UNCOMPRESSED_COUNT];
    acCompression           = counters[AC_COMPRESSION];

    compressedSize = unknownCompressedSize + acCompressedSize +
                     dcCompressedBytes + rleCompressedSize;

    dataPtr  = ptr;
    dataLeft = iSize - headerSize;

    if (dataLeft < compressedSize) return EXR_ERR_CORRUPT_CHUNK;

    // check version information to determine channel rules
    if (version >= 2)
    {
        uint64_t nWritten = 0;
        rv = DwaCompressor_readRelevantChannelRules (
            me, (const uint8_t**) &dataPtr, dataLeft, &nWritten);
        if (rv != EXR_ERR_SUCCESS) return rv;

        dataPtr += nWritten;
        dataLeft -= nWritten;
        compressedSize -= nWritten; // since channel rules are part of compressedSize
    }

    outBufferSize = uncompressed_size;
    outBufferEnd = (uint8_t*) uncompressed_data + outBufferSize;

    if (me->_packedAcBuffer)
    {
        packedAcBufferEnd = me->_packedAcBuffer;
    }
    else
    {
        packedAcBufferEnd = NULL;
    }

    if (me->_packedDcBuffer)
    {
        packedDcBufferEnd = me->_packedDcBuffer;
    }
    else
    {
        packedDcBufferEnd = NULL;
    }


    const uint8_t* compressedUnknownBuf = dataPtr;
    dataPtr += unknownCompressedSize;

    const uint8_t* compressedAcBuf = dataPtr;
    dataPtr += acCompressedSize;

    const uint8_t* compressedDcBuf = dataPtr;
    dataPtr += dcCompressedBytes;

    const uint8_t* compressedRleBuf = dataPtr;
    dataPtr += rleCompressedSize;