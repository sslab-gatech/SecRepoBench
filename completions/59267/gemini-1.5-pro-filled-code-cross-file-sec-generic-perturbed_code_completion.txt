memset (uncompressed_data, 0, uncompressed_size);

    if (iSize < headerSize) return EXR_ERR_CORRUPT_CHUNK;

    const uint8_t* ptr = inPtr;
    for (int i = 0; i < NUM_SIZES_SINGLE; ++i)
    {
        counters[i] = eight_from_xdr (ptr);
        ptr += sizeof (uint64_t);
    }

    version                  = counters[VERSION];
    unknownUncompressedSize = counters[UNKNOWN_UNCOMPRESSED_SIZE];
    unknownCompressedSize   = counters[UNKNOWN_COMPRESSED_SIZE];
    acCompressedSize        = counters[AC_COMPRESSED_SIZE];
    dcCompressedBytes       = counters[DC_COMPRESSED_BYTES];
    rleCompressedSize       = counters[RLE_COMPRESSED_SIZE];
    rleUncompressedSize     = counters[RLE_UNCOMPRESSED_SIZE];
    rleRawSize              = counters[RLE_RAW_SIZE];
    totalAcUncompressedCount = counters[TOTAL_AC_UNCOMPRESSED_COUNT];
    totalDcUncompressedCount = counters[TOTAL_DC_UNCOMPRESSED_COUNT];
    acCompression           = counters[AC_COMPRESSION];

    compressedSize = unknownCompressedSize + acCompressedSize +
                     dcCompressedBytes + rleCompressedSize;

    dataPtr  = ptr;
    dataLeft = iSize - headerSize;

    // Check for potential overflow issues
    if (unknownCompressedSize > dataLeft ||
        acCompressedSize > dataLeft - unknownCompressedSize ||
        dcCompressedBytes > dataLeft - unknownCompressedSize - acCompressedSize ||
        rleCompressedSize > dataLeft - unknownCompressedSize - acCompressedSize - dcCompressedBytes)
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }


    if (version >= 2)
    {
        uint64_t nWritten = 0;
        rv = DwaCompressor_readChannelRules (
            me, &dataPtr, dataLeft, &nWritten);
        if (rv != EXR_ERR_SUCCESS) return rv;
        dataLeft -= nWritten;
    }
    else
    {
        rv = DwaCompressor_applyLegacyChannelRules (me, version);
        if (rv != EXR_ERR_SUCCESS) return rv;
    }

    outBufferSize = uncompressed_size;
    outBufferEnd = (uint8_t*) uncompressed_data + outBufferSize;

    if (me->_packedAcBuffer)
    {
        packedAcBufferEnd = me->_packedAcBuffer;
    }
    else
    {
        packedAcBufferEnd = NULL;
    }

    if (me->_packedDcBuffer)
    {
        packedDcBufferEnd = me->_packedDcBuffer;
    }
    else
    {
        packedDcBufferEnd = NULL;
    }

    const uint8_t* compressedUnknownBuf = dataPtr;
    dataPtr += unknownCompressedSize;

    const uint8_t* compressedAcBuf = dataPtr;
    dataPtr += acCompressedSize;

    const uint8_t* compressedDcBuf = dataPtr;
    dataPtr += dcCompressedBytes;

    const uint8_t* compressedRleBuf = dataPtr;
    dataPtr += rleCompressedSize;