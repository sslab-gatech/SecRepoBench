rv = exr_decode_xdr (
        inPtr,
        iSize,
        counters,
        NUM_SIZES_SINGLE,
        &headerSize,
        me->_decode->context);

    if (rv != EXR_ERR_SUCCESS) { return rv; }

    version               = counters[IDX_VERSION];
    unknownUncompressedSize = counters[IDX_UNKNOWN_UNCOMPRESSED_SIZE];
    unknownCompressedSize   = counters[IDX_UNKNOWN_COMPRESSED_SIZE];
    acCompressedSize      = counters[IDX_AC_COMPRESSED_SIZE];
    dcCompressedBytes     = counters[IDX_DC_COMPRESSED_SIZE];
    rleCompressedSize     = counters[IDX_RLE_COMPRESSED_SIZE];
    rleUncompressedSize   = counters[IDX_RLE_UNCOMPRESSED_SIZE];
    rleRawSize            = counters[IDX_RLE_RAW_SIZE];
    acCompression         = counters[IDX_AC_COMPRESSION];

    totalAcUncompressedCount = counters[IDX_AC_UNCOMPRESSED_COUNT];
    totalDcUncompressedCount = counters[IDX_DC_UNCOMPRESSED_COUNT];

    compressedSize = unknownCompressedSize + acCompressedSize +
                     dcCompressedBytes + rleCompressedSize;

    dataPtr  = inPtr + headerSize;
    dataLeft = iSize - headerSize;

    if (unknownCompressedSize > iSize || acCompressedSize > iSize ||
        dcCompressedBytes > iSize || rleCompressedSize > iSize)
    {
        return EXR_ERR_CORRUPT_CHUNK;
    }

    if (version > 0)
    {
        if (me->_channelRuleCount == 0)
        {
            me->_channelRules    = sDefaultChannelRules;
            me->_channelRuleCount = sizeof (sDefaultChannelRules) /
                                     sizeof (exr_attribute_chlist_rule_t);
        }
    }

    outBufferSize = (size_t) (me->_max[0] - me->_min[0] + 1) *
                    (size_t) (me->_max[1] - me->_min[1] + 1) *
                    4 * 4; // max bytes per pixel

    if (uncompressed_size < outBufferSize) { return EXR_ERR_INVALID_ARGUMENT; }

    memset (uncompressed_data, 0, uncompressed_size);

    outBufferEnd = (uint8_t*) uncompressed_data;

    const uint8_t* compressedUnknownBuf = dataPtr;
    const uint8_t* compressedAcBuf      = compressedUnknownBuf + unknownCompressedSize;
    const uint8_t* compressedDcBuf      = compressedAcBuf + acCompressedSize;
    const uint8_t* compressedRleBuf     = compressedDcBuf + dcCompressedBytes;

    uint8_t* packedAcBufferEnd = (uint8_t*) me->_packedAcBuffer;
    uint8_t* packedDcBufferEnd = (uint8_t*) me->_packedDcBuffer;