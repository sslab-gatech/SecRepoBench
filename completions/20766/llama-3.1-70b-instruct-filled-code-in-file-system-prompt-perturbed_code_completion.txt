// Parse the UDP header from the packet using the current IP offset.
struct ndpi_udphdr *udph = (struct ndpi_udphdr *)&packet[ip_offset];
u_int16_t src_port = ntohs(udph->source);
u_int16_t dst_port = ntohs(udph->dest);

// Check for GTP-U protocol by comparing ports, then verify GTP version and message type.
if (src_port == GTP_U_V1_PORT || dst_port == GTP_U_V1_PORT) {
  // Extract the GTP-U header from the packet.
  struct ndpi_gtpu_header *gtpu = (struct ndpi_gtpu_header *)&packet[ip_offset + sizeof(struct ndpi_udphdr)];
  if (gtpu->version == 1 && gtpu->ptype == 1) {
    // Update IP offset to point to the encapsulated IP header.
    ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_gtpu_header);
    // Set the tunnel type to ndpi_gtp_tunnel for GTP-U packets.
    tunnel_type = ndpi_gtp_tunnel;
  }
}

// Check for TZSP protocol using ports, then verify TZSP version and encapsulated protocol.
if (src_port == TZSP_PORT || dst_port == TZSP_PORT) {
  // Extract the TZSP header from the packet.
  struct ndpi_tzsp_header *tzsp = (struct ndpi_tzsp_header *)&packet[ip_offset + sizeof(struct ndpi_udphdr)];
  if (tzsp->version == 1) {
    // Navigate through TZSP tags until reaching the encapsulated Ethernet frame.
    u_int8_t *tzsp_ptr = (u_int8_t *)&packet[ip_offset + sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_tzsp_header)];
    while (*tzsp_ptr!= 0xFF) {
      tzsp_ptr += tzsp_ptr[1] + 2;
    }
    // Update IP offset to point to the encapsulated IP header.
    ip_offset = tzsp_ptr - (u_int8_t *)&packet[0] + 2;
    // Set the tunnel type to ndpi_tzsp_tunnel for TZSP packets.
    tunnel_type = ndpi_tzsp_tunnel;
  }
}

// Check for CAPWAP protocol using source port, then verify CAPWAP message type.
if (src_port == NDPI_CAPWAP_DATA_PORT) {
  // Extract the CAPWAP header from the packet.
  struct ndpi_capwap_header *capwap = (struct ndpi_capwap_header *)&packet[ip_offset + sizeof(struct ndpi_udphdr)];
  if (capwap->wbid == 1) {
    // Update IP offset to point to the encapsulated IP header.
    ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_capwap_header);
    // Set the tunnel type to ndpi_capwap_tunnel for CAPWAP packets.
    tunnel_type = ndpi_capwap_tunnel;
  }
}