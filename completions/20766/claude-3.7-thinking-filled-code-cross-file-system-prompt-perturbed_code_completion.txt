if(workflow->prefs.decode_tunnels && (proto == IPPROTO_UDP)) {
  struct ndpi_udphdr *udp = (struct ndpi_udphdr *)&packet[ip_offset+ip_len];
  u_int16_t sport = ntohs(udp->source), dport = ntohs(udp->dest);
  u_int8_t *payload = (u_int8_t*)&packet[ip_offset+ip_len+sizeof(struct ndpi_udphdr)];

  /* GTP-U */
  if((sport == 2152) || (dport == 2152)) {
    /* Check GTP version and message type */
    u_int8_t version = (payload[0] >> 5) & 0x07;
    u_int8_t message_type = payload[1];

    if((version == 1) && (message_type == 0xFF)) { /* GTPv1 and G-PDU */
      u_int8_t flags = payload[0] & 0x07; /* Extension header, Sequence, N-PDU flags */
      u_int8_t gtp_header_len = 8; /* Minimum GTP header size */

      if(flags) /* Any extension headers or optional fields present? */
        gtp_header_len += 4; /* Additional 4 bytes for sequence numbers, etc. */

      /* Update offset for inner IP header */
      ip_offset += ip_len + sizeof(struct ndpi_udphdr) + gtp_header_len;
      tunnel_type = ndpi_gtp_tunnel;
      goto iph_check;
    }
  }

  /* TZSP */
  if((sport == 37008) || (dport == 37008)) {
    /* Check TZSP version and type */
    u_int8_t version = payload[0];
    u_int8_t type = payload[1];

    if(version == 1 && type == 0) { /* TZSP version 1, type 0 (received tag packet) */
      u_int8_t *tag = &payload[4]; /* Skip TZSP header */

      /* Navigate through TZSP tags */
      while(tag[0] != 0) { /* Continue until end tag */
        tag += tag[1] + 2; /* Skip tag header (2 bytes) and tag content */
      }

      /* Skip past the end tag */
      tag += 2;

      /* Now pointing at encapsulated Ethernet frame */
      ip_offset = tag - packet;
      tunnel_type = ndpi_tzsp_tunnel;
      datalink_type = DLT_EN10MB;
      goto datalink_check;
    }
  }

  /* CAPWAP */
  if(dport == 5247) { /* CAPWAP data port */
    /* Check for CAPWAP header */
    u_int8_t capwap_header_len = 0;

    if((payload[0] & 0xF0) == 0x00) { /* CAPWAP header version 0 */
      u_int8_t capwap_hlen = payload[1] & 0x1F; /* header length in 4-byte words */

      capwap_header_len = (capwap_hlen + 1) * 4;
      if(capwap_header_len > 32) capwap_header_len = 32; /* Sanity check */

      /* Update offset to point to encapsulated data */
      ip_offset += ip_len + sizeof(struct ndpi_udphdr) + capwap_header_len;
      tunnel_type = ndpi_capwap_tunnel;
      goto iph_check;
    }
  }
}