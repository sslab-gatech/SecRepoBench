struct ndpi_udphdr *udp = (struct ndpi_udphdr *)&packet[ip_offset + ip_len];
    u_int16_t sport = ntohs(udp->source), dport = ntohs(udp->dest);

    if(header->caplen >= ip_offset + ip_len + sizeof(struct ndpi_udphdr)) {
        /* GTP-U */
        if(dport == 2152 && header->caplen >= ip_offset + ip_len + sizeof(struct ndpi_udphdr) + 8) {
            u_int8_t *gtp = (u_int8_t*)(udp + 1);
            if((gtp[0] >> 5) == 1 && gtp[1] == 0xFF) { /* GTPv1-U, G-PDU */
                ip_offset += ip_len + sizeof(struct ndpi_udphdr) + 8;
                tunnel_type = ndpi_gtp_tunnel;
                goto skip_tunnel_processing;
            }
        }

        /* TZSP */
        if((sport == 6188 || dport == 6188) && header->caplen >= (ip_offset + ip_len + sizeof(struct ndpi_udphdr) + 2)) {
            u_int8_t *tzsp = (u_int8_t*)(udp + 1);
            if(tzsp[0] == 1 && tzsp[1] == 0) { /* Version 1, Data message */
                u_int8_t *ptr = tzsp + 2;
                while(ptr < packet + header->caplen) {
                    if(ptr[0] == 0) { /* End of tags */
                        ptr += 1;
                        break;
                    }
                    if(ptr + 2 + ptr[1] > packet + header->caplen) break;
                    ptr += 2 + ptr[1];
                }
                if(ptr <= packet + header->caplen) {
                    eth_offset = ip_offset;
                    ip_offset = ptr - packet;
                    datalink_type = DLT_EN10MB;
                    tunnel_type = ndpi_tzsp_tunnel;
                    goto datalink_check;
                }
            }
        }

        /* CAPWAP */
        if((sport == 5246 || sport == 5247) && header->caplen >= (ip_offset + ip_len + sizeof(struct ndpi_udphdr) + 8)) {
            u_int8_t *capwap = (u_int8_t*)(udp + 1);
            if((capwap[0] & 0x7f) == 0) { /* Data message */
                ip_offset += ip_len + sizeof(struct ndpi_udphdr) + 8;
                tunnel_type = ndpi_capwap_tunnel;
                goto skip_tunnel_processing;
            }
        }
    }
skip_tunnel_processing:;