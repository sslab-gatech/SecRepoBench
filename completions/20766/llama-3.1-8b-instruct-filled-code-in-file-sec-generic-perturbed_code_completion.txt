if(workflow->prefs.decode_tunnels && (proto == IPPROTO_UDP)) {
  // Parse the UDP header from the packet using the current IP offset.
  // Extract source and destination ports to identify potential tunnel protocols.
  // Check for GTP-U protocol by comparing ports, then verify GTP version and message type.
  // If GTP-U is detected, update IP offset to point to the encapsulated IP header.
  // Set the tunnel type to ndpi_gtp_tunnel for GTP-U packets.
  // Check for TZSP protocol using ports, then verify TZSP version and encapsulated protocol.
  // If TZSP is detected, navigate through its tags until reaching the encapsulated Ethernet frame.
  // Set the tunnel type to ndpi_tzsp_tunnel for TZSP packets.
  // Check for CAPWAP protocol using source port, then verify CAPWAP message type.
  // If CAPWAP is detected, update IP offset to point to the encapsulated IP header.
  // Set the tunnel type to ndpi_capwap_tunnel for CAPWAP packets.
  // The tunnel type and updated IP offset are used for further packet processing.
  if(ntohs(iph->source) == GTP_U_V1_PORT) {
    // GTP-U protocol detected
    if(ntohs(iph->dest) == GTP_U_V1_PORT) {
      // GTP-U message type is 0x01 (Start-Control-Message)
      tunnel_type = ndpi_gtp_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_gtp_hdr);
    } else {
      // GTP-U message type is 0x02 (Start-Control-Message)
      tunnel_type = ndpi_gtp_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_gtp_hdr);
    }
  } else if(ntohs(iph->source) == NDPI_CAPWAP_DATA_PORT) {
    // CAPWAP protocol detected
    if(ntohs(iph->dest) == NDPI_CAPWAP_DATA_PORT) {
      // CAPWAP message type is 0x01 (Start-Control-Message)
      tunnel_type = ndpi_capwap_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_capwap_hdr);
    } else {
      // CAPWAP message type is 0x02 (Start-Control-Message)
      tunnel_type = ndpi_capwap_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_capwap_hdr);
    }
  } else if(ntohs(iph->source) == TZSP_PORT) {
    // TZSP protocol detected
    if(ntohs(iph->dest) == TZSP_PORT) {
      // TZSP message type is 0x01 (Start-Control-Message)
      tunnel_type = ndpi_tzsp_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_tzsp_hdr);
    } else {
      // TZSP message type is 0x02 (Start-Control-Message)
      tunnel_type = ndpi_tzsp_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr) + sizeof(struct ndpi_tzsp_hdr);
    }
  }
}