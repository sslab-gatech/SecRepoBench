(ndpi_flow->detection_completed) {
      process_ndpi_collected_info(workflow, flow);
    } else {
      ndpi_flow->detection_completed = 1;
      ndpi_flow->src_id = src;
      ndpi_flow->dst_id = dst;
      ndpi_flow->src_ip = flow->src_ip, ndpi_flow->dst_ip = flow->dst_ip;
      ndpi_flow->src_port = flow->src_port, ndpi_flow->dst_port = flow->dst_port;
      ndpi_flow->protocol = proto;
      ndpi_flow->tunnel_type = tunnel_type;
      ndpi_flow->vlan_id = vlan_id;
      ndpi_flow->detection_start = time;
      ndpi_flow->detection_end = time;
      ndpi_flow->detection_duration = 0;
      ndpi_flow->entropy.src2dst_start = when;
      ndpi_flow->entropy.dst2src_start = when;

      if(src_to_dst_direction) {
	ndpi_flow->entropy.src2dst_pkt_count++;
	ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      } else {
	ndpi_flow->entropy.dst2src_pkt_count++;
	ndpi_flow->entropy.dst2src_l4_bytes += payload_len;
      }

      if(payload_len != 0XFEEDFACE && payload_len != 0) {
	if(src_to_dst_direction) {
	  ndpi_flow->entropy.src2dst_opackets++;
	} else {
	  ndpi_flow->entropy.dst2src_opackets++;
	}
      }

      if(tcph != NULL) {
	ndpi_flow->l4.tcp.flags = tcph->flags;
	ndpi_flow->l4.tcp.window_size = tcph->window;
	ndpi_flow->l4.tcp.seq_num = tcph->seq;
	ndpi_flow->l4.tcp.ack_num = tcph->ack_seq;
	ndpi_flow->l4.tcp.data_offset = tcph->doff;
	ndpi_flow->l4.tcp.urg_ptr = tcph->urg_ptr;
	ndpi_flow->l4.tcp.checksum = tcph->check;
	ndpi_flow->l4.tcp.options = tcph->options;
      } else if(udph != NULL) {
	ndpi_flow->l4.udp.checksum = udph->check;
      }

      ndpi_flow->entropy.src2dst_pkt_len[ndpi_flow->entropy.src2dst_pkt_count-1] = payload_len;
      ndpi_flow->entropy.dst2src_pkt_len[ndpi_flow->entropy.dst2src_pkt_count-1] = payload_len;

      ndpi_flow->entropy.src2dst_pkt_time[ndpi_flow->entropy.src2dst_pkt_count-1] = when;
      ndpi_flow->entropy.dst2src_pkt_time[ndpi_flow->entropy.dst2src_pkt_count-1] = when;

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) / ndpi_flow->entropy.src2dst_num_bytes;
      ndpi_flow->entropy.dst2src_bd_mean += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) / ndpi_flow->entropy.dst2src_num_bytes;

      ndpi_flow->entropy.src2dst_bd_variance += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) * ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean);
      ndpi_flow->entropy.dst2src_bd_variance += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) * ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean);

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) / ndpi_flow->entropy.src2dst_num_bytes;
      ndpi_flow->entropy.dst2src_bd_mean += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) / ndpi_flow->entropy.dst2src_num_bytes;

      ndpi_flow->entropy.src2dst_bd_variance += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) * ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean);
      ndpi_flow->entropy.dst2src_bd_variance += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) * ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean);

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) / ndpi_flow->entropy.src2dst_num_bytes;
      ndpi_flow->entropy.dst2src_bd_mean += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) / ndpi_flow->entropy.dst2src_num_bytes;

      ndpi_flow->entropy.src2dst_bd_variance += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) * ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean);
      ndpi_flow->entropy.dst2src_bd_variance += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) * ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean);

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) / ndpi_flow->entropy.src2dst_num_bytes;
      ndpi_flow->entropy.dst2src_bd_mean += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) / ndpi_flow->entropy.dst2src_num_bytes;

      ndpi_flow->entropy.src2dst_bd_variance += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) * ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean);
      ndpi_flow->entropy.dst2src_bd_variance += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) * ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean);

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) / ndpi_flow->entropy.src2dst_num_bytes;
      ndpi_flow->entropy.dst2src_bd_mean += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) / ndpi_flow->entropy.dst2src_num_bytes;

      ndpi_flow->entropy.src2dst_bd_variance += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) * ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean);
      ndpi_flow->entropy.dst2src_bd_variance += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) * ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean);

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) / ndpi_flow->entropy.src2dst_num_bytes;
      ndpi_flow->entropy.dst2src_bd_mean += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) / ndpi_flow->entropy.dst2src_num_bytes;

      ndpi_flow->entropy.src2dst_bd_variance += ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean) * ((double)payload_len - ndpi_flow->entropy.src2dst_bd_mean);
      ndpi_flow->entropy.dst2src_bd_variance += ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean) * ((double)payload_len - ndpi_flow->entropy.dst2src_bd_mean);

      ndpi_flow->entropy.src2dst_pkt_count++;
      ndpi_flow->entropy.dst2src_pkt_count++;

      ndpi_flow->entropy.src2dst_l4_bytes += payload_len;
      ndpi_flow->entropy.dst2src_l4_bytes += payload_len;

      ndpi_flow->entropy.src2dst_num_bytes++;
      ndpi_flow->entropy.dst2src_num_bytes++;

      ndpi_flow->entropy.src2dst_bd_mean += ((double)payload_len - ndpi_flow->entropy.