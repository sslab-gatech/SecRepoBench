if(workflow->prefs.decode_tunnels && (proto == IPPROTO_UDP)) {
    u_int16_t sport, dport;
    struct ndpi_udphdr *udph = (struct ndpi_udphdr *)&packet[ip_offset];

    sport = ntohs(udph->src_port);
    dport = ntohs(udph->dst_port);

    if((sport == 2152 || dport == 2152) /* GTP-U */
       && ( ntohs(udph->check) == 0x0000 || ntohs(udph->check) == 0xFFFF)) {
      u_int8_t gtp_ver = packet[ip_offset + 8];

      if(gtp_ver == 0x01 /* GTPv1 */) {
	u_int8_t gtp_msg_type = packet[ip_offset + 9];

	if(gtp_msg_type == 0xFF /* GTPv1, message type 0xFF: GTP-U */) {
	  ip_offset += 12; /* skip GTP header */
	  tunnel_type = ndpi_gtp_tunnel;
	}
      }
    } else if((sport == 37008 || dport == 37008) /* TZSP */) {
      u_int8_t tzsp_ver = packet[ip_offset + 8];

      if(tzsp_ver == 0x01 /* TOGS */) {
	ip_offset += 8; /* skip TZSP header */

	while(packet[ip_offset] != 0) {
	  u_int8_t tag_type = packet[ip_offset];
	  u_int8_t tag_len   = packet[ip_offset + 1];

	  ip_offset += tag_len + 2;

	  if(tag_type == 0) /* end of tag list */
	    break;
	}

	ip_offset += 2; /* skip 0x0000 */
	tunnel_type = ndpi_tzsp_tunnel;
      }
    } else if(dport == 5246 /* CAPWAP */) {
      u_int8_t capwap_msg_type = packet[ip_offset + 8];

      if(capwap_msg_type == 0x01 /* CAPWAP */) {
	ip_offset += 16; /* skip CAPWAP header */
	tunnel_type = ndpi_capwap_tunnel;
      }
    }
  }