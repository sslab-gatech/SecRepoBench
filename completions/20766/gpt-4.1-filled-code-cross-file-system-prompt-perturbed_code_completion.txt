/* Tunnel protocol detection */
    struct ndpi_udphdr *udph;
    u_int16_t udp_offset = ip_offset + (iph ? iph->ihl * 4 : (iph6 ? sizeof(struct ndpi_ipv6hdr) : 0));
    if(header->caplen >= udp_offset + sizeof(struct ndpi_udphdr)) {
      udph = (struct ndpi_udphdr *)&packet[udp_offset];
      u_int16_t sport = ntohs(udph->source), dport = ntohs(udph->dest);

      /* GTP-U detection (GPRS Tunneling Protocol User plane) */
      if((dport == 2152 || sport == 2152) && header->caplen >= udp_offset + 8 + 8) {
        /* GTP header is after UDP header (8 bytes) */
        const u_char *gtp = &packet[udp_offset + 8];
        u_int8_t gtp_flags = gtp[0];
        u_int8_t gtp_msgtype = gtp[1];
        /* GTPv1, message type 0xFF is reserved, 0xFF is not GTP-U */
        if((gtp_flags >> 5) == 1 && gtp_msgtype == 0xFF) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && gtp_msgtype == 0xFF) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && gtp_msgtype == 0xFF) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && gtp_msgtype == 0xFF) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0xFF)) {
          /* Not GTP-U */
        } else if((gtp_flags >> 5) == 1 && (gtp_msgtype == 0