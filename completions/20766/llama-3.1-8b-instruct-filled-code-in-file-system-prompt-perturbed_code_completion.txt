if(workflow->prefs.decode_tunnels && (proto == IPPROTO_UDP)) {
    // Parse the UDP header from the packet using the current IP offset.
    // Extract source and destination ports to identify potential tunnel protocols.
    // Check for GTP-U protocol by comparing ports, then verify GTP version and message type.
    // If GTP-U is detected, update IP offset to point to the encapsulated IP header.
    // Set the tunnel type to ndpi_gtp_tunnel for GTP-U packets.
    // Check for TZSP protocol using ports, then verify TZSP version and encapsulated protocol.
    // If TZSP is detected, navigate through its tags until reaching the encapsulated Ethernet frame.
    // Set the tunnel type to ndpi_tzsp_tunnel for TZSP packets.
    // Check for CAPWAP protocol using source port, then verify CAPWAP message type.
    // If CAPWAP is detected, update IP offset to point to the encapsulated IP header.
    // Set the tunnel type to ndpi_capwap_tunnel for CAPWAP packets.
    // The tunnel type and updated IP offset are used for further packet processing.
    if(ntohs(iph->source) == GTP_U_V1_PORT) {
      // GTP-U protocol detected
      tunnel_type = ndpi_gtp_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr);
      // Verify GTP version and message type
      if(ntohs(iph->source) == GTP_U_V1_PORT) {
        // GTP-U version 1 detected
        if(ntohs(iph->destination) == 2123) {
          // GTP-U message type 2123 detected
          tunnel_type = ndpi_gtp_tunnel;
        } else {
          // GTP-U message type other than 2123 detected
          tunnel_type = ndpi_gtp_tunnel;
        }
      } else {
        // GTP-U version other than 1 detected
        tunnel_type = ndpi_gtp_tunnel;
      }
    } else if(ntohs(iph->source) == NDPI_CAPWAP_DATA_PORT) {
      // CAPWAP protocol detected
      tunnel_type = ndpi_capwap_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr);
      // Verify CAPWAP message type
      if(ntohs(iph->destination) == 5247) {
        // CAPWAP message type 5247 detected
        tunnel_type = ndpi_capwap_tunnel;
      } else {
        // CAPWAP message type other than 5247 detected
        tunnel_type = ndpi_capwap_tunnel;
      }
    } else if(ntohs(iph->source) == TZSP_PORT) {
      // TZSP protocol detected
      tunnel_type = ndpi_tzsp_tunnel;
      ip_offset += sizeof(struct ndpi_udphdr);
      // Navigate through TZSP tags
      while(ntohs(iph->destination) == 37008) {
        // TZSP tag detected
        ip_offset += sizeof(struct ndpi_udphdr);
        // Verify TZSP version and encapsulated protocol
        if(ntohs(iph->destination) == 37008) {
          // TZSP version and encapsulated protocol detected
          tunnel_type = ndpi_tzsp_tunnel;
        } else {
          // TZSP version and encapsulated protocol other than 37008 detected
          tunnel_type = ndpi_tzsp_tunnel;
        }
      }
    }
  }