struct ndpi_ipv4hdr iph;
  memset(&iph, 0, sizeof(iph));
  iph.version = 4;
  iph.ihl = 5;
  iph.tos = ipv6_header->priority;
  iph.tot_len = htons(ipsize);
  iph.id = 0;
  iph.frag_off = 0;
  iph.ttl = ipv6_header->hop_limit;
  iph.protocol = ipv6_header->nexthdr;
  iph.saddr = ipv6_header->saddr.in4.s_addr;
  iph.daddr = ipv6_header->daddr.in4.s_addr;
  iph.check = 0; // will be recalculated later

  u_int8_t *l4ptr = (u_int8_t *)ipv6_header + ip_offset;
  u_int8_t l4proto = ipv6_header->nexthdr;
  u_int16_t ip_len = ipsize;

  // Handle IPv6 extension headers
  while(l4proto == IPPROTO_HOPOPTS || l4proto == IPPROTO_ROUTING ||
	l4proto == IPPROTO_FRAGMENT || l4proto == IPPROTO_AH ||
	l4proto == IPPROTO_ESP) {
    struct ndpi_ipv6_ext_hdr *ext_hdr = (struct ndpi_ipv6_ext_hdr *)l4ptr;
    u_int8_t next_hdr = ext_hdr->nexthdr;
    u_int8_t hdr_len = (ext_hdr->hdrlen + 1) * 8;
    l4ptr += hdr_len;
    ip_len -= hdr_len;
    l4proto = next_hdr;
  }