struct ndpi_ipv4hdr iph;
  memset(&iph, 0, sizeof(iph));
  iph.version = 4;
  iph.ihl = 5;
  memcpy(&iph.saddr, &ipv6_header->saddr, 4);
  memcpy(&iph.daddr, &ipv6_header->daddr, 4);
  u_int16_t ip_len = ntohs(ipv6_header->payload_len) + sizeof(struct ndpi_ipv6hdr);
  u_int8_t l4proto = ipv6_header->nexthdr;
  const u_int8_t *l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);

  // Handle IPv6 extension headers
  while(l4proto == IPPROTO_HOPOPTS || l4proto == IPPROTO_ROUTING ||
	l4proto == IPPROTO_FRAGMENT || l4proto == IPPROTO_AH ||
	l4proto == IPPROTO_ESP) {
    struct ndpi_ipv6_ext_hdr *ext_hdr = (struct ndpi_ipv6_ext_hdr *)l4ptr;
    u_int8_t next_hdr = ext_hdr->nexthdr;
    l4ptr += ext_hdr->hdrlen * 8;
    l4proto = next_hdr;
  }