struct ndpi_iphdr iph;

  memset(&iph, 0, sizeof(iph));

  iph.version = 4;
  iph.saddr = ipv6_header->ip6_src.s6_addr32[3];
  iph.daddr = ipv6_header->ip6_dst.s6_addr32[3];
  u_int8_t l4proto = ipv6_header->ip6_nxt;
  u_int16_t ip_len = ipsize - sizeof(struct ndpi_ipv6hdr);
  const u_int8_t *l4ptr = (((const u_int8_t *) ipv6_header) + sizeof(struct ndpi_ipv6hdr));

  if(l4proto == IPPROTO_HOPOPTS
     || l4proto == IPPROTO_ROUTING
     || l4proto == IPPROTO_FRAGMENT
     || l4proto == IPPROTO_DSTOPTS
     || l4proto == IPPROTO_AH
     || l4proto == IPPROTO_ESP) {
    if(ipsize > (sizeof(struct ndpi_ipv6hdr) + 2)) {
      /* For the moment we skip extension headers */
      u_int8_t ext_len = 8 + ((packet[ip_offset+sizeof(struct ndpi_ipv6hdr)+1]) * 8);

      l4ptr += ext_len;
      ip_len -= ext_len;

      if(l4ptr > (packet + header->caplen))
	return NULL;
    }
  }

  if(ip_len == 0)
    return NULL;