u_int16_t ip_len = ntohs(ipv6_header->payload_len) + sizeof(struct ndpi_ipv6hdr);
const u_int8_t *l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);

if (ip_len > MAX_BUFFER_SIZE) {
    // Handle error: packet too large
    return NULL;
}

u_int8_t l4proto = ipv6_header->nexthdr;
*payload = (u_int8_t *)l4ptr;
*payload_len = ip_len - (l4ptr - (const u_int8_t *)ipv6_header);