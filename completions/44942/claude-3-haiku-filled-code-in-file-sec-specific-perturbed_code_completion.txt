if(iph6->ip6_hdr.ip6_vfc >> 4 == 6) {
  l4proto = iph6->ip6_hdr.ip6_un1_nxt;
  ip_len = ntohs(iph6->ip6_hdr.ip6_un1_plen);
  iph = NULL;

  const u_int8_t *l4ptr = (((const u_int8_t *) iph6) + sizeof(struct ndpi_ipv6hdr));
  u_int16_t ipsize = header->caplen - ip_offset;

  if(ndpi_handle_ipv6_extension_headers(ipsize - sizeof(struct ndpi_ipv6hdr), &l4ptr, &ip_len, &l4proto) != 0) {
    return(nproto);
  }

  if(l4proto == IPPROTO_IPV6
#ifdef IPPROTO_IPIP
     || l4proto == IPPROTO_IPIP
#endif
     ) {
    if(l4ptr > packet) { /* Better safe than sorry */
      ip_offset = (l4ptr - packet);
      goto iph_check;
    }
  }
}