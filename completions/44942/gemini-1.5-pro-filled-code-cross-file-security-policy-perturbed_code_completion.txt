struct ndpi_ipv4hdr iph;
  const u_int8_t *l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);
  u_int8_t l4proto = ipv6_header->nexthdr;
  u_int16_t ip_len = ipsize;

  memset(&iph, 0, sizeof(struct ndpi_ipv4hdr));
  iph.version = 4;
  iph.ihl = 5;
  memcpy(&iph.saddr, &ipv6_header->saddr, 16);
  memcpy(&iph.daddr, &ipv6_header->daddr, 16);
  iph.tot_len = htons(ipsize);

  while ((ip_len > 0) && (l4proto != IPPROTO_TCP) && (l4proto != IPPROTO_UDP) && (l4proto != IPPROTO_SCTP)) {
      if (ip_len < 8) {
          return NULL;
      }
      u_int8_t nxt = l4ptr[0];
      u_int8_t len = l4ptr[1];

      l4ptr += 8 + (len*8);
      ip_len -= 8 + (len*8);

      l4proto = nxt;

      if (ip_len < 0) {
          return NULL;
      }
  }

  if (ip_len < 0) {
      return NULL;
  }