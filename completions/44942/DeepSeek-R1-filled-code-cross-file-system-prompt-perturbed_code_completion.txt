struct ndpi_iphdr iph;
memset(&iph, 0, sizeof(iph));
iph.saddr = crc32(ipv6_header->saddr.s6_addr, 16);
iph.daddr = crc32(ipv6_header->daddr.s6_addr, 16);

u_int8_t l4proto = ipv6_header->nexthdr;
const u_int8_t *l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);
u_int16_t ip_len = ntohs(ipv6_header->payload_len);

while(1) {
    switch(l4proto) {
    case IPPROTO_HOPOPTS:
    case IPPROTO_ROUTING:
    case IPPROTO_FRAGMENT:
    case IPPROTO_ESP:
    case IPPROTO_AH:
    case IPPROTO_DSTOPTS:
    case IPPROTO_MH: {
        struct ndpi_ipv6_ext_hdr *ext = (struct ndpi_ipv6_ext_hdr *)l4ptr;
        u_int8_t ext_len = (ext->len + 1) * 8;
        if((ext_len < sizeof(*ext)) || (l4ptr + ext_len > (const u_int8_t *)ipv6_header + ipsize))
            goto done_processing;
        l4proto = ext->nexthdr;
        l4ptr += ext_len;
        ip_len -= ext_len;
        break;
    }
    default:
        goto done_processing;
    }
}
done_processing: