struct ndpi_iphdr iph;
u_int8_t l4proto;
u_int16_t ip_len;
const u_int8_t *l4ptr;

memset(&iph, 0, sizeof(iph));

/* Extract src and dst addresses from IPv6 header */
/* Use IPv6 src/dst in "mapped" IPv4 space */
iph.saddr = ipv6_header->ip6_src.u6_addr.u6_addr32[3];
iph.daddr = ipv6_header->ip6_dst.u6_addr.u6_addr32[3];

/* Protocol type from the next header field */
l4proto = ipv6_header->ip6_hdr.ip6_un1_nxt;

/* Payload length from the IPv6 header */
ip_len = ntohs(ipv6_header->ip6_hdr.ip6_un1_plen);

/* Pointer to the layer 4 protocol data */
l4ptr = (((const u_int8_t *) ipv6_header) + sizeof(struct ndpi_ipv6hdr));

/* Handle IPv6 extension headers */
if(ndpi_handle_ipv6_extension_headers(ipsize - sizeof(struct ndpi_ipv6hdr), &l4ptr, &ip_len, &l4proto) != 0) {
    return(NULL);
}