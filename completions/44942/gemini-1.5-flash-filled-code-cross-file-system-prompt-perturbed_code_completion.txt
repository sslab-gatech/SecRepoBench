u_int8_t l4proto;
  const u_int8_t *l4ptr;
  struct ndpi_iphdr iph;
  memset(&iph, 0, sizeof(iph));

  iph.saddr = ipv6_header->saddr.in6_u.u6_addr32[3];
  iph.daddr = ipv6_header->daddr.in6_u.u6_addr32[3];

  l4proto = ipv6_header->nexthdr;
  l4ptr = (const u_int8_t *)ipv6_header + ip_offset;
  u_int16_t ip_len = ipsize;

  // Handle IPv6 extension headers
  while(l4proto == IPPROTO_HOPOPTS || l4proto == IPPROTO_ROUTING ||
	l4proto == IPPROTO_FRAGMENT || l4proto == IPPROTO_AH ||
	l4proto == IPPROTO_ESP) {
    struct ndpi_ipv6_ext_hdr *ext_hdr = (struct ndpi_ipv6_ext_hdr *)l4ptr;
    u_int8_t next_hdr = ext_hdr->nexthdr;
    u_int8_t hdr_len = (ext_hdr->hdrlen + 1) * 8;
    l4ptr += hdr_len;
    ip_len -= hdr_len;
    l4proto = next_hdr;
  }