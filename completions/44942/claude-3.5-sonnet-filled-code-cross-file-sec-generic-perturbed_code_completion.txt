struct ndpi_iphdr iph;
u_int8_t l4proto;
const u_int8_t *l4ptr;

memset(&iph, 0, sizeof(iph));
iph.version = 4;
iph.saddr = ipv6_header->saddr.s6_addr32[3];
iph.daddr = ipv6_header->daddr.s6_addr32[3];

l4proto = ipv6_header->nexthdr;
l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);

while (l4proto == IPPROTO_HOPOPTS || l4proto == IPPROTO_ROUTING || l4proto == IPPROTO_DSTOPTS) {
  struct ndpi_ip6_ext *ext = (struct ndpi_ip6_ext *)l4ptr;
  u_int16_t ext_len = (ext->ip6e_len + 1) << 3;

  l4proto = ext->ip6e_nxt;
  l4ptr += ext_len;

  if (l4ptr - (const u_int8_t *)ipv6_header >= ipsize)
    return NULL;
}

*proto = l4proto;