struct ndpi_ipv4hdr iph;
memset(&iph, 0, sizeof(struct ndpi_ipv4hdr));

// Extract source and destination addresses from the IPv6 header
iph.src = ipv6_header->src;
iph.dst = ipv6_header->dst;

// Retrieve the protocol type and payload length from the IPv6 header
iph.protocol = ipv6_header->nexthdr;
iph.tot_len = htons(ipsize);

// Determine the pointer to the layer 4 protocol data
const u_int8_t *l4ptr = (const u_int8_t *)ipv6_header + ip_offset;

// Handle IPv6 extension headers
while (iph.protocol == NDPI_IPV6_HOP_BY_HOP || iph.protocol == NDPI_IPV6_DESTINATION || 
       iph.protocol == NDPI_IPV6_ROUTING || iph.protocol == NDPI_IPV6_FRAGMENT) {
    // Adjust the protocol data pointer and update the protocol and payload length
    struct ndpi_ipv6_ext_hdr *ext_hdr = (struct ndpi_ipv6_ext_hdr *)l4ptr;
    u_int8_t ext_len = (ext_hdr->hdr_len + 1) * 8; // Length in bytes
    l4ptr += ext_len;
    iph.tot_len -= ext_len;
    iph.protocol = ext_hdr->nexthdr;
}