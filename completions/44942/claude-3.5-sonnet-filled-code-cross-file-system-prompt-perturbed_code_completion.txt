struct ndpi_iphdr iph;
u_int8_t l4proto;
u_int16_t ip_len;
const u_int8_t *l4ptr;

memset(&iph, 0, sizeof(iph));
iph.version = 4;
iph.saddr = ipv6_header->saddr.s6_addr32[3];
iph.daddr = ipv6_header->daddr.s6_addr32[3];

l4proto = ipv6_header->nexthdr;
ip_len = ntohs(ipv6_header->payload_len);
l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);

while (l4proto == IPPROTO_HOPOPTS || l4proto == IPPROTO_ROUTING || l4proto == IPPROTO_DSTOPTS) {
  struct ndpi_ip6_ext_hdr *ext_hdr = (struct ndpi_ip6_ext_hdr *)l4ptr;
  u_int16_t ext_hdr_len = (ext_hdr->hdr_len + 1) << 3;

  l4proto = ext_hdr->next_hdr;
  l4ptr += ext_hdr_len;
  ip_len -= ext_hdr_len;
}