struct ndpi_iphdr iph;
memset(&iph, 0, sizeof(iph));

memcpy(&iph.saddr, &ipv6_header->saddr, sizeof(iph.saddr));
memcpy(&iph.daddr, &ipv6_header->daddr, sizeof(iph.daddr));

u_int8_t l4proto = ipv6_header->ip6_ctlun.ip6_un1.ip6_un1_nxt;
const u_int8_t *l4ptr = (const u_int8_t *)ipv6_header + sizeof(struct ndpi_ipv6hdr);
u_int16_t ip_len = ntohs(ipv6_header->ip6_ctlun.ip6_un1.ip6_un1_plen);

while(l4proto != NDPI_IPPROTO_TCP && l4proto != NDPI_IPPROTO_UDP) {
  struct ndpi_ipv6_ext_hdr *ext_hdr = (struct ndpi_ipv6_ext_hdr *)l4ptr;
  u_int8_t ext_len = ext_hdr->ip6r_len;
  
  l4proto = ext_hdr->ip6r_nxt;
  l4ptr += (ext_len + 1) << 3;
  ip_len -= (ext_len + 1) << 3;
}