struct ndpi_iphdr iph;
  const u_int8_t *l4ptr = (((const u_int8_t *) ipv6_header) + sizeof(struct ndpi_ipv6hdr));
  u_int16_t ipsize = header->caplen - ip_offset;

  if(ndpi_handle_ipv6_extension_headers(ipsize - sizeof(struct ndpi_ipv6hdr), &l4ptr, &ip_len, &proto) != 0) {
    return NULL;
  }

  if(proto == IPPROTO_IPV6 || proto == IPPROTO_IPIP) {
    if(l4ptr > packet) { /* Better safe than sorry */
      ip_offset = (l4ptr - packet);
      goto iph_check;
    }
  }