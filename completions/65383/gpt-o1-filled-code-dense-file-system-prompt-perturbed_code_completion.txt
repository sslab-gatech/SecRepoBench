case 'Z':
        case 'H': {
            if (!tm->blk) {
                if (!(tm->blk = cram_new_block(EXTERNAL, key)))
                    goto err;
                codec->u.e_byte_array_len.val_codec->out = tm->blk;
            }
            aux += 3;
            // Copy until we hit a null terminator or run out of data
            while (aux < aux_limit && *aux) {
                BLOCK_APPEND_CHAR(tm->blk, *aux++);
            }
            if (aux >= aux_limit) {
                // No trailing '\0' found
                goto err;
            }
            // Append the trailing null
            BLOCK_APPEND_CHAR(tm->blk, *aux++);
            break;
        }

        case 'B': {
            if (!tm->blk) {
                if (!(tm->blk = cram_new_block(EXTERNAL, key)))
                    goto err;
                codec->u.e_byte_array_len.val_codec->out = tm->blk;
            }
            aux += 3;
            // sub-type + 4-byte length must be present
            if (aux_limit - aux < 5)
                goto err;

            // Append the sub-type character
            BLOCK_APPEND_CHAR(tm->blk, *aux);
            // Append the 4-byte length
            BLOCK_APPEND(tm->blk, aux + 1, 4);

            // Compute the number of elements
            uint32_t count = ((unsigned char)aux[1]) |
                             ((unsigned char)aux[2] << 8) |
                             ((unsigned char)aux[3] << 16) |
                             ((unsigned char)aux[4] << 24);
            // Advance past sub-type + length
            char sub_type = *aux;
            aux += 5;

            // Figure out element size
            int item_size;
            switch (sub_type) {
            case 'c': case 'C': case 'A':
                item_size = 1; break;
            case 's': case 'S':
                item_size = 2; break;
            case 'i': case 'I': case 'f':
                item_size = 4; break;
            case 'd':
                item_size = 8; break;
            default:
                hts_log_error("Unhandled sub-type '%c' in 'B' tag", sub_type);
                goto err;
            }

            // Ensure we have enough data left for count * item_size
            size_t needed = (size_t)count * item_size;
            if (aux_limit - aux < (ptrdiff_t)needed)
                goto err;

            // Append the array data
            BLOCK_APPEND(tm->blk, aux, needed);
            aux += needed;
            break;
        }

        default:
            hts_log_error("Unknown aux type '%c'", aux_limit - aux < 2 ? '?' : aux[2]);
            goto err;