int32_t coffsets_cbytes;
uint8_t *coffsets = get_coffsets(frame, headerlength, cbytes, &coffsets_cbytes);
if (coffsets == NULL) {
    BLOSC_TRACE_ERROR("Failed to retrieve chunk offsets.");
    return BLOSC2_ERROR_DATA;
}

size_t offsets_nbytes, cbytes_, blocksize;
blosc2_cbuffer_sizes(coffsets, &offsets_nbytes, &cbytes_, &blocksize);
if (offsets_nbytes % sizeof(int64_t) != 0) {
    BLOSC_TRACE_ERROR("Invalid chunk offsets structure");
    return BLOSC2_ERROR_DATA;
}

int32_t num_offsets = (int32_t)(offsets_nbytes / sizeof(int64_t));
if (nchunk < 0 || nchunk >= num_offsets) {
    BLOSC_TRACE_ERROR("Chunk index %d out of bounds [0, %d)", nchunk, num_offsets);
    return BLOSC2_ERROR_INVALID_PARAM;
}

int64_t* offsets = malloc(offsets_nbytes);
if (offsets == NULL) {
    BLOSC_TRACE_ERROR("Memory allocation failed for offsets");
    return BLOSC2_ERROR_MEMORY_ALLOC;
}

blosc2_dparams dparams = BLOSC2_DPARAMS_DEFAULTS;
blosc2_context* dctx = blosc2_create_dctx(dparams);
int32_t rc = blosc2_decompress_ctx(dctx, coffsets, coffsets_cbytes, offsets, (int32_t)offsets_nbytes);
blosc2_free_ctx(dctx);

if (rc < 0) {
    BLOSC_TRACE_ERROR("Failed to decompress chunk offsets");
    free(offsets);
    return rc;
}

*offset = offsets[nchunk];
free(offsets);
return BLOSC2_SUCCESS;