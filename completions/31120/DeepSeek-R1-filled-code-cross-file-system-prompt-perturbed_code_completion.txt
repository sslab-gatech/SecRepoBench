int32_t nchunks;
int ret = get_header_info(frame, NULL, NULL, NULL, NULL, NULL, &nchunks, NULL, NULL, NULL, NULL, NULL);
if (ret < 0) {
    BLOSC_TRACE_ERROR("Unable to get nchunks from frame header.");
    return ret;
}

if (nchunk >= nchunks) {
    BLOSC_TRACE_ERROR("nchunk '%d' exceeds the number of chunks '%d' in frame.", nchunk, nchunks);
    return BLOSC2_ERROR_INVALID_PARAM;
}

int32_t coffsets_cbytes;
uint8_t* coffsets = get_coffsets(frame, headerlength, cbytes, &coffsets_cbytes);
if (coffsets == NULL) {
    BLOSC_TRACE_ERROR("Failed to retrieve compressed chunk offsets.");
    return BLOSC2_ERROR_DATA;
}

int64_t* offsets = (int64_t*)malloc(nchunks * sizeof(int64_t));
if (offsets == NULL) {
    BLOSC_TRACE_ERROR("Memory allocation failed for decompressed offsets.");
    return BLOSC2_ERROR_MEMORY_ALLOC;
}

blosc2_dparams dparams = BLOSC2_DPARAMS_DEFAULTS;
blosc2_context* dctx = blosc2_create_dctx(dparams);
int32_t decompressed_size = blosc2_decompress_ctx(dctx, coffsets, coffsets_cbytes, offsets, nchunks * sizeof(int64_t));
blosc2_free_ctx(dctx);

if (decompressed_size < 0) {
    BLOSC_TRACE_ERROR("Decompression of chunk offsets failed.");
    free(offsets);
    return decompressed_size;
}

if (decompressed_size != nchunks * sizeof(int64_t)) {
    BLOSC_TRACE_ERROR("Decompressed size %d does not match expected size %d.",
                      decompressed_size, nchunks * (int32_t)sizeof(int64_t));
    free(offsets);
    return BLOSC2_ERROR_DATA;
}

*offset = offsets[nchunk];
free(offsets);

return 0;