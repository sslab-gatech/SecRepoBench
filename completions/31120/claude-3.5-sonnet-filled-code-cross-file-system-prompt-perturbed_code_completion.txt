int32_t coffsets_cbytes;
uint8_t *coffsets = get_coffsets(frame, headerlength, cbytes, &coffsets_cbytes);
if (coffsets == NULL) {
    BLOSC_TRACE_ERROR("Cannot get the offsets for the frame.");
    return BLOSC2_ERROR_DATA;
}

// Decompress offsets
blosc2_dparams off_dparams = BLOSC2_DPARAMS_DEFAULTS;
blosc2_context *dctx = blosc2_create_dctx(off_dparams);
int32_t off_nbytes = blosc2_decompress_ctx(dctx, coffsets, coffsets_cbytes, NULL, 0);
if (off_nbytes < 0) {
    blosc2_free_ctx(dctx);
    BLOSC_TRACE_ERROR("Cannot decompress the offsets chunk.");
    return off_nbytes;
}

int64_t* offsets = malloc((size_t)off_nbytes);
int32_t decomp_size = blosc2_decompress_ctx(dctx, coffsets, coffsets_cbytes, offsets, off_nbytes);
blosc2_free_ctx(dctx);

if (decomp_size < 0) {
    free(offsets);
    BLOSC_TRACE_ERROR("Cannot decompress the offsets chunk.");
    return decomp_size;
}

if (nchunk >= decomp_size / sizeof(int64_t)) {
    free(offsets);
    BLOSC_TRACE_ERROR("nchunk is out of bounds");
    return BLOSC2_ERROR_INVALID_PARAM;
}

*offset = offsets[nchunk];
free(offsets);

return 0;