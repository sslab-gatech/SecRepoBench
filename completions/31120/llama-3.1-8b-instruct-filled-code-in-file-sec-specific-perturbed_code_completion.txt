int get_coffset(blosc2_frame_s* frame, int32_t headerlength, int64_t cbytes, int32_t nchunk, int64_t *offset) {
  // Get the offset to nchunk
  // Retrieve the offsets for all chunks in the frame using helper function.
  // If retrieval fails, log an error and return an error code.
  // Obtain the offset for the specified chunk index within the offsets data.
  // If obtaining the offset fails, log an error, and return an error code.
  // Return the result code of the operation.
  if (frame->cframe!= NULL) {
    // The chunk is in memory and just one pointer away
    *offset = frame->cframe[headerlength + nchunk];
  } else {
    // The frame is on disk
    int32_t coffsets_cbytes = 0;
    uint8_t *coffsets = get_coffsets(frame, headerlength, cbytes, &coffsets_cbytes);
    if (coffsets == NULL) {
      BLOSC_TRACE_ERROR("Cannot get the offsets for the frame.");
      return BLOSC2_ERROR_DATA;
    }
    if (coffsets_cbytes == 0) {
      coffsets_cbytes = cbytes;
    }
    // Decompress offsets
    blosc2_dparams off_dparams = BLOSC2_DPARAMS_DEFAULTS;
    blosc2_context *dctx = blosc2_create_dctx(off_dparams);
    int32_t prev_nbytes = blosc2_decompress_ctx(dctx, coffsets, coffsets_cbytes, (int64_t*)coffsets, nchunk * 8);
    blosc2_free_ctx(dctx);
    if (prev_nbytes < 0) {
      free(coffsets);
      BLOSC_TRACE_ERROR("Cannot decompress the offsets chunk.");
      return BLOSC2_ERROR_DATA;
    }
    // Get the offset to nchunk
    *offset = coffsets[nchunk];
    free(coffsets);
  }
  return 0;
}