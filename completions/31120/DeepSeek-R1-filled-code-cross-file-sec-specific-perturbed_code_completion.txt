int get_coffset(blosc2_frame_s* frame, int32_t headerlength, int64_t cbytes, int32_t nchunk, int64_t *offset) {
  int32_t coffsets_cbytes;
  uint8_t *coffsets = get_coffsets(frame, headerlength, cbytes, &coffsets_cbytes);
  if (coffsets == NULL) {
    BLOSC_TRACE_ERROR("Cannot get chunk offsets");
    return BLOSC2_ERROR_DATA;
  }

  int64_t nbytes, cbytes_, blocksize;
  blosc_cbuffer_sizes(coffsets, &nbytes, &cbytes_, &blocksize);
  if (nbytes % sizeof(int64_t) != 0) {
    BLOSC_TRACE_ERROR("Invalid chunk offsets format");
    return BLOSC2_ERROR_DATA;
  }

  int64_t *offsets = malloc((size_t)nbytes);
  if (offsets == NULL) {
    BLOSC_TRACE_ERROR("Memory allocation failed");
    return BLOSC2_ERROR_MEMORY_ALLOC;
  }

  blosc2_dparams dparams = BLOSC2_DPARAMS_DEFAULTS;
  blosc2_context *dctx = blosc2_create_dctx(dparams);
  int32_t rc = blosc2_decompress_ctx(dctx, coffsets, coffsets_cbytes, offsets, (int32_t)nbytes);
  blosc2_free_ctx(dctx);
  if (rc < 0) {
    free(offsets);
    BLOSC_TRACE_ERROR("Cannot decompress chunk offsets");
    return rc;
  }

  int64_t num_chunks = nbytes / sizeof(int64_t);
  if (nchunk >= num_chunks) {
    free(offsets);
    BLOSC_TRACE_ERROR("nchunk exceeds available chunks");
    return BLOSC2_ERROR_INVALID_PARAM;
  }

  *offset = offsets[nchunk];
  free(offsets);
  return 0;
}