if (LocaleCompare(graphic_context[graphiccontextindex]->id, token) == 0)
  break;
mvg_class = (const char *)GetValueFromSplayTree(macros, token);
if (mvg_class != (const char *)NULL)
{
  char *elements = AcquireString(mvg_class);
  size_t len = strlen(elements);
  if (len > 0)
  {

    size_t primitive_len = strlen(primitive);
    size_t q_offset = q - primitive;

    size_t new_primitive_len = len + primitive_len + 1; // +1 for null terminator

    char *new_primitive = (char *)AcquireQuantumMemory(new_primitive_len, sizeof(char));

    if (new_primitive == (char *)NULL)
    {
      elements = DestroyString(elements);
      primitive = DestroyString(primitive);
      for (; graphiccontextindex >= 0; graphiccontextindex--)
        graphic_context[graphiccontextindex] = DestroyDrawInfo(graphic_context[graphiccontextindex]);
      graphic_context = (DrawInfo **)RelinquishMagickMemory(graphic_context);
      ThrowBinaryException(ResourceLimitError, "MemoryAllocationFailed", image->filename);
    }

    strcpy(new_primitive, elements);
    strcpy(new_primitive + len, primitive + q_offset);

    primitive = DestroyString(primitive);
    primitive = new_primitive;

    q = primitive + len;

  }
  elements=DestroyString(elements);
}