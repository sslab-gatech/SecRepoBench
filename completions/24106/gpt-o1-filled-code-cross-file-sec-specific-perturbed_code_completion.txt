if ((graphic_context[graphiccontextindex]->id != (char *) NULL) &&
    (LocaleCompare(graphic_context[graphiccontextindex]->id, token) == 0))
  break;

mvg_class=(const char *) GetValueFromSplayTree(macros,token);
if (mvg_class != (const char *) NULL)
{
  size_t prefix_len=(size_t) (q-primitive);
  size_t class_len=strlen(mvg_class);
  size_t suffix_len=strlen(q);

  /* Check for potential size overflow before allocation */
  if ((prefix_len > SIZE_MAX-class_len) ||
      ((prefix_len+class_len) > (SIZE_MAX-suffix_len-1)))
    {
      status=MagickFalse;
      break;
    }

  {
    char *new_primitive=(char *) AcquireQuantumMemory(prefix_len + class_len + suffix_len + 1,
      sizeof(*new_primitive));
    if (new_primitive == (char *) NULL)
      {
        status=MagickFalse;
        break;
      }

    (void) memcpy(new_primitive,primitive,prefix_len);
    (void) memcpy(new_primitive+prefix_len,mvg_class,class_len);
    (void) memcpy(new_primitive+prefix_len+class_len,q,suffix_len+1);

    primitive=DestroyString(primitive);
    primitive=new_primitive;
    q=primitive+prefix_len+class_len;
  }
}