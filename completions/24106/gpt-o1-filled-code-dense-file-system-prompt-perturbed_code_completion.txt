{
  const char
    *mvg_class;

  (void) GetNextToken(q,&q,extent,token);
  if (*token == '\0')
    {
      /* No class name present, abort. */
      status=MagickFalse;
      break;
    }

  /* If the token matches the current graphic context ID, do nothing further. */
  if ((graphic_context[graphiccontextindex]->id != (char *) NULL) &&
      (LocaleCompare(token,graphic_context[graphiccontextindex]->id) == 0))
    break;

  /* Retrieve the MVG class definition from the macros using the token. */
  mvg_class=(const char *) GetValueFromSplayTree(macros,token);
  if (mvg_class != (const char *) NULL)
    {
      /* Inject the class definition into the 'primitive' stream. */
      size_t
        offset=(size_t) (q-primitive),
        needed=strlen(primitive)+strlen(mvg_class)+8;

      char
        *injected;

      injected=(char *) AcquireQuantumMemory(needed,sizeof(*injected));
      if (injected == (char *) NULL)
        {
          status=MagickFalse;
          break;
        }

      /* Copy the content before the current parse position. */
      (void) CopyMagickString(injected,primitive,offset+1);

      /* Concatenate the MVG class definition. */
      (void) ConcatenateMagickString(injected,mvg_class,needed);

      /* Then concatenate the remainder of the primitive. */
      (void) ConcatenateMagickString(injected,primitive+offset,needed);

      /* Replace the old primitive with the new one. */
      primitive=DestroyString(primitive);
      primitive=injected;

      /* Adjust 'q' to point to the correct position in the newly modified string. */
      q=primitive+offset+strlen(mvg_class);
    }
}