{
  const char *mvg_class = (const char *) GetValueFromSplayTree(macros, token);
  if (mvg_class != (const char *) NULL)
  {
    /* Determine the prefix (already processed) and suffix lengths */
    size_t prefix_length = (size_t)(q - primitive);
    size_t class_length = strlen(mvg_class);
    size_t suffix_length = strlen(q);
    /* Prevent integer overflow in the size calculation */
    if (prefix_length > SIZE_MAX - class_length - suffix_length - 1)
    {
      status = MagickFalse;
      break;
    }
    size_t new_size = prefix_length + class_length + suffix_length + 1;
    char *new_primitive = (char *) AcquireMagickMemory(new_size);
    if (new_primitive == (char *) NULL)
    {
      primitive = DestroyString(primitive);
      ThrowBinaryException(ResourceLimitError, "MemoryAllocationFailed", image->filename);
      break;
    }
    /* Copy the already processed part */
    if (prefix_length > 0)
      (void) memcpy(new_primitive, primitive, prefix_length);
    /* Inject the MVG class definition */
    (void) memcpy(new_primitive + prefix_length, mvg_class, class_length);
    /* Append the remaining content */
    if (suffix_length > 0)
      (void) memcpy(new_primitive + prefix_length + class_length, q, suffix_length);
    new_primitive[new_size - 1] = '\0';
    /* Free the old primitive string and update it with the new string */
    primitive = DestroyString(primitive);
    primitive = new_primitive;
    /* Adjust q to point immediately after the injected class definition */
    q = primitive + prefix_length + class_length;
  }
}