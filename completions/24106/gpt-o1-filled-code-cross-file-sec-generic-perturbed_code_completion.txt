{
  /* Check if the current token matches the current graphic context's ID. */
  if (graphic_context[graphiccontextindex]->id != (char *) NULL)
    {
      if (LocaleCompare(graphic_context[graphiccontextindex]->id, token) == 0)
        break;
    }

  /* Fetch the class definition from the stored macros. */
  {
    const char *class_definition = (const char *) GetValueFromSplayTree(macros, token);
    if (class_definition != (const char *) NULL)
      {
        /* Prepare to insert the class definition into the main 'primitive' string. */
        size_t offset = (size_t) (q - primitive);
        size_t length_primitive = strlen(primitive);
        size_t length_class_def = strlen(class_definition);

        /* Check for any size overflow before allocating. */
        if (length_class_def > (SIZE_MAX - length_primitive - 1))
          {
            status = MagickFalse;
            break;
          }

        size_t new_length = length_primitive + length_class_def + 1;
        char *new_primitive = (char *) AcquireQuantumMemory(new_length, sizeof(*new_primitive));
        if (new_primitive == (char *) NULL)
          {
            status = MagickFalse;
            break;
          }

        /*
          Copy everything up to the insert point, then the class definition,
          and then the remainder of the old string.
        */
        (void) memcpy(new_primitive, primitive, offset);
        (void) memcpy(new_primitive + offset, class_definition, length_class_def);
        (void) strcpy(new_primitive + offset + length_class_def,
          primitive + offset);

        /* Replace the old 'primitive' string with the new one. */
        primitive = DestroyString(primitive);
        primitive = new_primitive;

        /* Reacquire macros to ensure they reflect the newly updated 'primitive'. */
        macros = DestroySplayTree(macros);
        macros = GetMVGMacros(primitive);

        /*
          Adjust 'q' so that it points into the updated 'primitive'.
          From here, the injected class contents will be processed on
          subsequent iterations.
        */
        q = primitive + offset;
      }
  }
  break;
}