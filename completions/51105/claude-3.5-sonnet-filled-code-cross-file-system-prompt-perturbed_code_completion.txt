phone = new phonetable();
if (!phone)
  return false;

int num_rules = 0;
std::string::const_iterator iter = line.begin();
std::string::const_iterator start_piece = mystrsep(line, iter);
int i = 0;
while (start_piece != line.end()) {
  switch (i) {
    case 1:
      num_rules = atoi(std::string(start_piece, iter).c_str());
      if (num_rules < 1) {
        HUNSPELL_WARNING(stderr, "error: line %d: bad entry number\n", fileMgr->getlinenum());
        return false;
      }
      break;
    case 2:
      phone->num = atoi(std::string(start_piece, iter).c_str());
      break;
    case 3:
      phone->utf8 = atoi(std::string(start_piece, iter).c_str());
      break;
    default:
      break;
  }
  ++i;
  start_piece = mystrsep(line, iter);
}

if (i != 4) {
  HUNSPELL_WARNING(stderr, "error: line %d: missing data\n", fileMgr->getlinenum());
  return false;
}

phone->rules.reserve(std::min(num_rules, 16384));

for (int j = 0; j < num_rules; ++j) {
  std::string nl;
  if (!fileMgr->getline(nl))
    return false;
  mychomp(nl);
  
  if (nl.compare(0, 5, "PHONE", 5) != 0) {
    HUNSPELL_WARNING(stderr, "error: line %d: table is corrupt\n", fileMgr->getlinenum());
    return false;
  }

  std::string rule, pattern;
  iter = nl.begin() + 6;  // Skip "PHONE "
  start_piece = mystrsep(nl, iter);
  if (start_piece != nl.end())
    rule.assign(start_piece, iter);
  start_piece = mystrsep(nl, iter);
  if (start_piece != nl.end())
    pattern.assign(start_piece, iter);

  if (rule.empty() || pattern.empty()) {
    HUNSPELL_WARNING(stderr, "error: line %d: invalid rule\n", fileMgr->getlinenum());
    return false;
  }

  // Strip underscores
  rule.erase(std::remove(rule.begin(), rule.end(), '_'), rule.end());
  pattern.erase(std::remove(pattern.begin(), pattern.end(), '_'), pattern.end());

  phone->rules.push_back(std::make_pair(rule, pattern));
}

if (phone->rules.size() != static_cast<size_t>(num_rules)) {
  HUNSPELL_WARNING(stderr, "error: line %d: table is corrupt\n", fileMgr->getlinenum());
  return false;
}

// Add two empty strings
phone->rules.push_back(std::make_pair("", ""));
phone->rules.push_back(std::make_pair("", ""));

// Initialize hash
phone->hash.reset(new HashMgr(1, phone));