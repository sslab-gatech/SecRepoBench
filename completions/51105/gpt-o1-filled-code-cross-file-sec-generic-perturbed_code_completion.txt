int i = 0;
int np = 0;
int numphone = -1;
std::string::const_iterator iter = line.begin();
std::string::const_iterator start_piece = mystrsep(line, iter);

// Extract number of phone rules
while (start_piece != line.end()) {
  switch (i) {
    case 0: {
      // first piece is presumably a keyword like "PHONE" or similar
      np++;
      break;
    }
    case 1: {
      // second piece should be the number of phonetic rules
      numphone = atoi(std::string(start_piece, iter).c_str());
      if (numphone < 1) {
        HUNSPELL_WARNING(stderr, "error: line %d: invalid phonetable size\n",
                         fileMgr->getlinenum());
        return false;
      }
      // allocate new phonetable structure
      phone = new PhonTable();
      phone->rules.reserve(std::min(numphone, 16384));
      np++;
      break;
    }
    default:
      break;
  }
  ++i;
  start_piece = mystrsep(line, iter);
}

// validate the extracted parameters
if (np < 2) {
  HUNSPELL_WARNING(stderr, "error: line %d: missing phonetable information\n",
                   fileMgr->getlinenum());
  return false;
}

// read the specified number of phonetic rules
for (int j = 0; j < numphone; ++j) {
  std::string nl;
  if (!fileMgr->getline(nl)) {
    HUNSPELL_WARNING(stderr, "error: line %d: phonetable incomplete\n",
                     fileMgr->getlinenum());
    return false;
  }
  mychomp(nl);

  // ensure each rule starts with the "PHONE" keyword
  if (nl.size() < 5 || nl.compare(0, 5, "PHONE") != 0) {
    HUNSPELL_WARNING(stderr, "error: line %d: invalid phonetable rule\n",
                     fileMgr->getlinenum());
    return false;
  }

  // extract and strip underscores from the rule details
  std::string rule = nl.substr(5);
  rule.erase(std::remove(rule.begin(), rule.end(), '_'), rule.end());

  // store the processed rule
  phone->rules.push_back(rule);
}

// verify integrity of the rules
if (static_cast<int>(phone->rules.size()) != numphone) {
  HUNSPELL_WARNING(stderr, "error: line %d: phonetable size mismatch\n",
                   fileMgr->getlinenum());
  return false;
}

// finalize the phonetable
phone->rules.push_back(std::string());
phone->initHash();