if (k != NULL && v != NULL) {
    if (v->type == MSGPACK_OBJECT_STR) {
        /* Ensure the string isn't too long for our buffer */
        if (v->via.str.size >= sizeof(tmp)) {
            flb_warn("[parser] Time string too long, truncating");
            len = sizeof(tmp) - 1;
        }
        else {
            len = v->via.str.size;
        }
        
        /* Create a safe, null-terminated copy */
        memcpy(tmp, v->via.str.ptr, len);
        tmp[len] = '\0';
        
        /* Parse time string */
        ret = flb_parser_time_lookup(tmp, len,
                                    &time_lookup, &tmfrac,
                                    parser->time_fmt, parser->time_fmt_len,
                                    parser->time_frac_secs, parser->time_fuzzy,
                                    parser->ctx->config);
        if (ret == -1) {
            flb_warn("[parser] Invalid time format, setting time to zero");
            time_lookup = 0;
            tmfrac = 0;
        }
    }
    else {
        flb_warn("[parser] Time key is not a string");
        time_lookup = 0;
        tmfrac = 0;
    }
}
else {
    time_lookup = 0;
    tmfrac = 0;
}