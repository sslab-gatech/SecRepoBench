if (k != NULL && v != NULL) {
        if (parser->time_key_format == FLB_PARSER_TIME_FORMAT_NUMBER) {
            if (v->type == MSGPACK_OBJECT_FLOAT) {
                tmfrac = v->via.f64 - (time_t)v->via.f64;
                time_lookup = (time_t)v->via.f64;
            }
            else if (v->type == MSGPACK_OBJECT_POSITIVE_INTEGER) {
                time_lookup = (time_t)v->via.u64;
            }
            else if (v->type == MSGPACK_OBJECT_NEGATIVE_INTEGER) {
                time_lookup = (time_t)v->via.i64;
            }
        }
        else {
            /* String format */
            if (v->type != MSGPACK_OBJECT_STR) {
                flb_plg_warn(parser->p,
                             "invalid time format, key=%s want=string got=%i",
                             time_key, v->type);
                time_lookup = 0;
            }
            else {
                len = v->via.str.size;

                if (len >= sizeof(tmp)) {
                    len = sizeof(tmp) - 1;
                }

                memcpy(tmp, v->via.str.ptr, len);
                tmp[len] = '\0';

                if (parser->time_fmt) {
                    strptime(tmp, parser->time_fmt, &tm);
                    time_lookup = mktime(&tm);
                    if (time_lookup == -1) {
                        flb_plg_warn(parser->p,
                                     "invalid time format %s, key=%s value=%s",
                                     parser->time_fmt, time_key, tmp);
                        time_lookup = 0;
                    }
                }
                else {
                    time_lookup = 0;
                }
            }
        }
    }
    else {
        time_lookup = time(NULL);
    }