if (ret == NULL) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
            "exsltCryptoRc4DecryptFunction: Failed to allocate return buffer\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString(parsercontext);
        goto done;
    }

    // Perform RC4 decryption
    RC4_KEY rc4_key;
    RC4_set_key(&rc4_key, RC4_KEY_LENGTH, padkey);
    RC4(&rc4_key, ret_len, bin, ret);

    // Null-terminate the decrypted string
    ret[ret_len] = '\0';

    // Return the decrypted string
    xmlXPathReturnString(parsercontext, ret);

done:
    if (key != NULL)
        xmlFree(key);
    if (ret != NULL)
        xmlFree(ret);