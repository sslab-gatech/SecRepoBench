if (ret == NULL) {
    xsltTransformError(tctxt, NULL, tctxt->inst,
        "exsltCryptoRc4DecryptFunction: Failed to allocate result\n");
    tctxt->state = XSLT_STATE_STOPPED;
    xmlXPathReturnEmptyString (parsercontext);
    goto done;
}

/* RC4 decryption */
{
    unsigned char rc4_state[256];
    unsigned char temp;
    int i, j, k;
    unsigned char t;

    /* RC4 key setup */
    for (i = 0; i < 256; i++)
        rc4_state[i] = i;
    
    j = 0;
    for (i = 0; i < 256; i++) {
        j = (j + rc4_state[i] + padkey[i % RC4_KEY_LENGTH]) % 256;
        temp = rc4_state[i];
        rc4_state[i] = rc4_state[j];
        rc4_state[j] = temp;
    }

    /* RC4 decrypt */
    i = j = 0;
    for (k = 0; k < ret_len; k++) {
        i = (i + 1) % 256;
        j = (j + rc4_state[i]) % 256;
        
        temp = rc4_state[i];
        rc4_state[i] = rc4_state[j];
        rc4_state[j] = temp;
        
        t = (rc4_state[i] + rc4_state[j]) % 256;
        ret[k] = bin[k] ^ rc4_state[t];
    }
}

ret[ret_len] = 0;  /* null terminate */

xmlXPathReturnString (parsercontext, ret);