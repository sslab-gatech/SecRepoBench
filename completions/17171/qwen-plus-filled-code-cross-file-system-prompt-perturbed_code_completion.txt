if (ret == NULL) {
        ret = xmlMallocAtomic (ret_len + 1);
        if (ret == NULL) {
            xsltTransformError(tctxt, NULL, tctxt->inst,
                "exsltCryptoRc4DecryptFunction: Failed to allocate memory for decrypted result\n");
            tctxt->state = XSLT_STATE_STOPPED;
            xmlXPathReturnEmptyString (parsercontext);
            goto done;
        }
    }

    /* Perform the RC4 decryption */
    exsltCryptoRc4(bin, ret_len, padkey, ret);

    /* Null-terminate the decrypted string */
    ret[ret_len] = '\0';

    /* Validate the decrypted result */
    if (xmlUTF8Strlen(ret) < 0) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
            "exsltCryptoRc4DecryptFunction: Decrypted result contains invalid UTF-8\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString (parsercontext);
        goto done;
    }

    /* Return the decrypted string to the caller */
    xmlXPathReturnString (parsercontext, ret);

done:
    if (str != NULL)
        xmlFree (str);
    if (padkey != NULL)
        xmlFree (padkey);
    if (bin != NULL)
        xmlFree (bin);