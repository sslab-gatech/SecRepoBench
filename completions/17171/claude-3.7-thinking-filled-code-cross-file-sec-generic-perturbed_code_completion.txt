if (ret == NULL) {
    xsltTransformError(tctxt, NULL, tctxt->inst,
        "exsltCryptoRc4DecryptFunction: Failed to allocate result\n");
    tctxt->state = XSLT_STATE_STOPPED;
    xmlXPathReturnEmptyString (parsercontext);
    goto done;
}

/* Perform RC4 decryption */
{
    unsigned char S[256];
    unsigned char K[256];
    unsigned int i, j, k;
    unsigned char temp;
    
    /* Initialize S and K */
    for (i = 0; i < 256; i++) {
        S[i] = i;
        K[i] = padkey[i % RC4_KEY_LENGTH];
    }
    
    /* Initial permutation of S */
    j = 0;
    for (i = 0; i < 256; i++) {
        j = (j + S[i] + K[i]) % 256;
        temp = S[i];
        S[i] = S[j];
        S[j] = temp;
    }
    
    /* Decrypt the data */
    i = j = 0;
    for (k = 0; k < ret_len; k++) {
        i = (i + 1) % 256;
        j = (j + S[i]) % 256;
        temp = S[i];
        S[i] = S[j];
        S[j] = temp;
        ret[k] = bin[k] ^ S[(S[i] + S[j]) % 256];
    }
}

ret[ret_len] = 0;  /* Null-terminate the result string */

xmlXPathReturnString(parsercontext, ret);

done:
if (key != NULL)
    xmlFree(key);