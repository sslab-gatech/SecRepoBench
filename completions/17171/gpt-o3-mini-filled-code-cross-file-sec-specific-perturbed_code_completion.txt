if (ret == NULL) {
    xsltTransformError(tctxt, NULL, tctxt->inst,
        "exsltCryptoRc4DecryptFunction: Failed to allocate decrypted result\n");
    tctxt->state = XSLT_STATE_STOPPED;
    xmlXPathReturnEmptyString(parsercontext);
    goto done;
}

{
    unsigned char S[256];
    int i, j = 0, k, t;

    /* Key Scheduling Algorithm (KSA) */
    for (i = 0; i < 256; i++) {
        S[i] = (unsigned char)i;
    }
    for (i = 0; i < 256; i++) {
        j = (j + S[i] + padkey[i % RC4_KEY_LENGTH]) & 0xff;
        t = S[i];
        S[i] = S[j];
        S[j] = t;
    }

    /* Pseudo-Random Generation Algorithm (PRGA) for decryption */
    i = 0;
    j = 0;
    for (k = 0; k < ret_len; k++) {
        i = (i + 1) & 0xff;
        j = (j + S[i]) & 0xff;
        t = S[i];
        S[i] = S[j];
        S[j] = t;
        ret[k] = bin[k] ^ S[(S[i] + S[j]) & 0xff];
    }
    ret[ret_len] = '\0';  /* Null-terminate the decrypted string */
}

xmlXPathReturnString(parsercontext, ret);
goto done;