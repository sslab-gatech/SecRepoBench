if (ret == NULL) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
            "exsltCryptoRc4DecryptFunction: Failed to allocate decrypted string\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString(parsercontext);
        goto done;
    }

    // Perform the decryption using the RC4 algorithm
    RC4(&rc4_key, bin_len, bin, ret);

    // Null-terminate the decrypted string
    ret[ret_len] = '\0';

    // Validate UTF-8 encoding
    if (xmlUTF8Strlen(ret) < 0) {
        xsltGenericError(xsltGenericErrorContext,
            "exsltCryptoRc4DecryptFunction: invalid UTF-8\n");
        xmlXPathReturnEmptyString(parsercontext);
        xmlFree(ret);
        goto done;
    }

    xmlXPathReturnString(parsercontext, ret);