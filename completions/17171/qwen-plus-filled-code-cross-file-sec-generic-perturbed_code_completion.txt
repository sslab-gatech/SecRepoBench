if (ret == NULL) {
    ret = xmlMallocAtomic (ret_len + 1);
    if (ret == NULL) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
            "exsltCryptoRc4DecryptFunction: Failed to allocate memory for decrypted result\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString (parsercontext);
        goto done;
    }
    memset(ret, 0, ret_len + 1);
}

/* Perform RC4 decryption */
RC4((unsigned char *)padkey, RC4_KEY_LENGTH, (unsigned char *)bin, ret_len, (unsigned char *)ret);

/* Null-terminate the decrypted string */
ret[ret_len] = '\0';

/* Validate and return the decrypted result */
xmlXPathReturnString(parsercontext, ret);

done:
    if (str != NULL)
        xmlFree(str);
    if (padkey != NULL)
        xmlFree(padkey);
    if (bin != NULL)
        xmlFree(bin);