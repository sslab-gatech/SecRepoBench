RC4_KEY *rc4_key = (RC4_KEY *)xmlMallocAtomic(sizeof(RC4_KEY));
    if (rc4_key == NULL) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
            "exsltCryptoRc4DecryptFunction: Failed to allocate RC4 key\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString(ctxt);
        goto done;
    }
    rc4_setup(rc4_key, padkey, key_len);

    ret_len = rc4_crypt(rc4_key, bin, ret_len, ret);
    ret[ret_len] = '\0';

    if (ret_len == 0) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
            "exsltCryptoRc4DecryptFunction: Failed to decrypt data\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString(ctxt);
        goto done;
    }

    xmlXPathReturnString(ctxt, ret);

done:
    if (rc4_key != NULL)
        xmlFree(rc4_key);