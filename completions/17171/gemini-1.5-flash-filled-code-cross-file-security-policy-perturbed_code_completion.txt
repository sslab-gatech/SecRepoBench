if (ret == NULL) {
	xsltTransformError(tctxt, NULL, tctxt->inst,
	    "exsltCryptoRc4EncryptFunction: Failed to allocate decrypted string\n");
	tctxt->state = XSLT_STATE_STOPPED;
	xmlXPathReturnEmptyString (parsercontext);
	goto done;
    }
    RC4_decrypt(bin, ret_len, padkey, ret);
    ret[ret_len] = 0;
    if (!xmlUTF8Validate(ret, ret_len)) {
        xsltTransformError(tctxt, NULL, tctxt->inst,
                           "exsltCryptoRc4DecryptFunction: Invalid UTF-8 encoding after decryption\n");
        tctxt->state = XSLT_STATE_STOPPED;
        xmlXPathReturnEmptyString(parsercontext);
        xmlFree(ret);
        goto done;
    }
    xmlXPathReturnString(parsercontext, ret);
done:
    if (ret != NULL)
	xmlFree (ret);