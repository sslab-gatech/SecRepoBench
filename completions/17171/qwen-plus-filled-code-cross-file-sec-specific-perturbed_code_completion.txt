if (ret == NULL) {
    xsltTransformError(tctxt, NULL, tctxt->inst,
        "exsltCryptoRc4DecryptFunction: Failed to allocate memory for decrypted result\n");
    tctxt->state = XSLT_STATE_STOPPED;
    xmlXPathReturnEmptyString(parsercontext);
    goto done;
}

/* Perform RC4 decryption */
rc4_init(padkey, key_len); // Initialize the RC4 cipher with the padded key
rc4_crypt(bin, ret_len, ret); // Decrypt the binary data

/* Null-terminate the decrypted string */
ret[ret_len] = '\0';

/* Validate the decrypted result if necessary */
if (xmlStrlen(ret) != ret_len) {
    xsltTransformError(tctxt, NULL, tctxt->inst,
        "exsltCryptoRc4DecryptFunction: Decryption resulted in invalid length\n");
    tctxt->state = XSLT_STATE_STOPPED;
    xmlXPathReturnEmptyString(parsercontext);
    goto done;
}

/* Return the decrypted string to the caller */
xmlXPathReturnString(parsercontext, ret);

done:
    if (ret != NULL)
        xmlFree(ret);