ret = xmlMallocAtomic (ret_len + 1);
    if (ret == NULL) {
	xsltTransformError(tctxt, NULL, tctxt->inst,
	    "exsltCryptoRc4DecryptFunction: Failed to allocate memory for decrypted string\n");
	tctxt->state = XSLT_STATE_STOPPED;
	xmlXPathReturnEmptyString (parsercontext);
	goto done;
    }
    memset(ret, 0, ret_len + 1);

    rc4((unsigned char*)padkey, key_len, (unsigned char*)bin, bin_len, (unsigned char*)ret, &ret_len);

    if (!xmlUTF8CheckAndFix(ret, ret_len)) {
	xsltTransformError(tctxt, NULL, tctxt->inst,
	    "exsltCryptoRc4DecryptFunction: Decrypted string is not valid UTF-8\n");
	tctxt->state = XSLT_STATE_STOPPED;
	xmlXPathReturnEmptyString (parsercontext);
	goto done;
    }

    xmlXPathReturnString (parsercontext, ret);

done:
    if (str != NULL)
	xmlFree (str);
    if (padkey != NULL)
	xmlFree (padkey);
    if (bin != NULL)
	xmlFree (bin);