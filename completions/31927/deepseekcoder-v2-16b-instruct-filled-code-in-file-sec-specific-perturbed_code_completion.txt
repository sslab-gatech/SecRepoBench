gf_bs_write_data(bs, ptr->reserved, 6);
	gf_bs_write_u16(bs, ptr->dataReferenceIndex);
	gf_bs_write_data(bs,  ptr->data, ptr->data_size);
	gf_bs_write_u16(bs, ptr->width);
	gf_bs_write_u16(bs, ptr->height);
	gf_bs_write_u16(bs, ptr->horizresolution);
	gf_bs_write_u16(bs, ptr->vertresolution);
	gf_bs_write_u16(bs, ptr->frame_count);
	gf_bs_write_u16(bs, ptr->compressorname_len);
	if (ptr->compressorname_len) {
		gf_bs_write_data(bs, ptr->compressorname, ptr->compressorname_len);
	}
	return GF_OK;
}

GF_Err gnrv_box_size(GF_Box *s)
{
	GF_GenericVisualSampleEntryBox *ptr = (GF_GenericVisualSampleEntryBox *)s;
	s->type = GF_ISOM_BOX_TYPE_GNRV;
	ptr->size += 8+ptr->data_size+18+ptr->compressorname_len;
	return GF_OK;
}

#endif /*GPAC_DISABLE_ISOM_WRITE*/

void hdlr_box_del(GF_Box *s)
{
	GF_HandlerBox *ptr = (GF_HandlerBox *) s;
	if (ptr->name) gf_free(ptr->name);
	gf_free(ptr);
}

GF_Box *hdlr_box_new()
{
	ISOM_DECL_BOX_ALLOC(GF_HandlerBox, GF_ISOM_BOX_TYPE_HDLR);
	return (GF_Box *)tmp;
}

GF_Err hdlr_box_read(GF_Box *s, GF_BitStream *bs)
{
	GF_HandlerBox *ptr = (GF_HandlerBox *)s;

	ISOM_DECREASE_SIZE(ptr, 24);
	ptr->pre_defined = gf_bs_read_u32(bs);
	ptr->handler_type = gf_bs_read_u32(bs);
	ptr->reserved = gf_bs_read_u32(bs);
	if (ptr->size) {
		u32 bytesToRead = (u32) ptr->size;
		ptr->name = (char*)gf_malloc(bytesToRead * sizeof(char));
		if (!ptr->name) return GF_OUT_OF_MEM;
		gf_bs_read_data(bs, ptr->name, bytesToRead);
		ptr->name[bytesToRead-1] = 0;
	}
	return GF_OK;
}

#ifndef GPAC_DISABLE_ISOM_WRITE

GF_Err hdlr_box_write(GF_Box *s, GF_BitStream *bs)
{
	GF_Err e;
	GF_HandlerBox *ptr = (GF_HandlerBox *)s;

	e = gf_isom_full_box_write(s, bs);
	if (e) return e;
	gf_bs_write_u32(bs, ptr->pre_defined);
	gf_bs_write_u32(bs, ptr->handler_type);
	gf_bs_write_u32(bs, ptr->reserved);
	if (ptr->name) {
		gf_bs_write_data(bs, ptr->name, (u32)strlen(ptr->name) + 1);
	}
	return GF_OK;
}

GF_Err hdlr_box_size(GF_Box *s)
{
	GF_HandlerBox *ptr = (GF_HandlerBox *)s;

	ptr->size += 12;
	if (ptr->name) {
		ptr->size += strlen(ptr->name) + 1;
	}
	return GF_OK;
}

#endif /*GPAC_DISABLE_ISOM_WRITE*/

void hinf_box_del(GF_Box *s)
{
	GF_HintInformationBox *ptr = (GF_HintInformationBox *)s;
	if (ptr->hint_data) gf_free(ptr->hint_data);
	gf_free(ptr);
}

GF_Box *hinf_box_new()
{
	ISOM_DECL_BOX_ALLOC(GF_HintInformationBox, GF_ISOM_BOX_TYPE_HINF);
	return (GF_Box *)tmp;
}

GF_Err hinf_box_read(GF_Box *s, GF_BitStream *bs)
{
	GF_HintInformationBox *ptr = (GF_HintInformationBox *)s;

	ISOM_DECREASE_SIZE(ptr, 4);
	ptr->hint_count = gf_bs_read_u32(bs);
	if (ptr->hint_count > 0) {
		ISOM_DECREASE_SIZE(ptr, 4);
		ptr->hint_data = (char*)gf_malloc(ptr->hint_count);
		if (!ptr->hint_data) return GF_OUT_OF_MEM;
		gf_bs_read_data(bs, ptr->hint_data, ptr->hint_count);
	}
	return GF_OK;
}

#ifndef GPAC_DISABLE_ISOM_WRITE

GF_Err hinf_box_write(GF_Box *s, GF_BitStream *bs)
{
	GF_Err e;
	GF_HintInformationBox *ptr = (GF_HintInformationBox *)s;

	e = gf_isom_full_box_write(s, bs);
	if (e) return e;
	gf_bs_write_u32(bs, ptr->hint_count);
	if (ptr->hint_count > 0) {
		gf_bs_write_data(bs, ptr->hint_data, ptr->hint_count);
	}
	return GF_OK;
}

GF_Err hinf_box_size(GF_Box *s)
{
	GF_HintInformationBox *ptr = (GF_HintInformationBox *)s;

	ptr->size += 4 + ptr->hint_count;
	return GF_OK;
}

#endif /*GPAC_DISABLE_ISOM_WRITE*/

void iinf_box_del(GF_Box *s)
{
	GF_ItemInformationBox *ptr = (GF_ItemInformationBox *)s;
	if (ptr->item_infos) gf_free(ptr->item_infos);
	gf_free(ptr);
}

GF_Box *iinf_box_new()
{
	ISOM_DECL_BOX_ALLOC(GF_ItemInformationBox, GF_ISOM_BOX_TYPE_IINF);
	return (GF_Box *)tmp;
}

GF_Err iinf_box_read(GF_Box *s, GF_BitStream *bs)
{
	u32 i;
	GF_ItemInformationBox *ptr = (GF_ItemInformationBox *)s;

	ISOM_DECREASE_SIZE(ptr, 4);
	ptr->item_count = gf_bs_read_u32(bs);
	if (ptr->item_count > 0) {
		ISOM_DECREASE_SIZE(ptr, 4);
		ptr->item_infos = (GF_ItemInfoEntry *)gf_malloc(sizeof(GF_ItemInfoEntry) * ptr->item_count);
		if (!ptr->item_infos) return GF_OUT_OF_MEM;
		for (i = 0; i < ptr->item_count; i++) {
			ISOM_DECREASE_SIZE(ptr, 8);
			ptr->item_infos[i].item_ID = gf_bs_read_u32(bs);
			ptr->item_infos[i].item_protection_index = gf_bs_read_u32(bs);
		}
	}
	return GF_OK;
}

#ifndef GPAC_DISABLE_ISOM_WRITE

GF_Err iinf_box_write(GF_Box *s, GF_BitStream *bs)
{
	GF_Err e;
	u32 i;
	GF_ItemInformationBox *ptr = (GF_ItemInformationBox *)s;

	e = gf_isom_full_box_write(s, bs);
	if (e) return e;
	gf_bs_write_u32(bs, ptr->item_count);
	if (ptr->item_count > 0) {
		for (i = 0; i < ptr->item_count; i++) {
			gf_bs_write_u32(bs, ptr->item_infos[i].item_ID);
			gf_bs_write_u32(bs, ptr->item_infos[i].item_protection_index);
		}
	}
	return GF_OK;
}

GF_Err iinf_box_size(GF_Box *s)
{
	GF_ItemInformationBox *ptr = (GF_ItemInformationBox *)s;

	ptr->size += 4 + 8 * ptr->item_count;
	return GF_OK;
}

#endif /*GPAC_DISABLE_ISOM_WRITE*/

void iloc_box_del(GF_Box *s)
{
	GF_ItemLocationBox *ptr = (GF_ItemLocationBox *)s;
	if (ptr->item_locations) gf_free(ptr->item_locations);
	gf_free(ptr);
}

GF_Box *iloc_box_new()
{
	ISOM_DECL_BOX_ALLOC(GF_ItemLocationBox, GF_ISOM_BOX_TYPE_ILOC);
	return (GF_Box *)tmp;
}

GF_Err iloc_box_read(GF_Box *s, GF_BitStream *bs)
{
	u32 i;
	GF_ItemLocationBox *ptr = (GF_ItemLocationBox *)s;

	ISOM_DECREASE_SIZE(ptr, 4);
	ptr->item_count = gf_bs_read_u32(bs);
	if (ptr->item_count > 0) {
		ISOM_DECREASE_SIZE(ptr, 4);
		ptr->item_locations = (GF_ItemLocationEntry *)gf_malloc(sizeof(GF_ItemLocationEntry) * ptr->item_count);
		if (!ptr->item_locations) return GF_OUT_OF_MEM;
		for (i = 0; i < ptr->item_count; i++) {
			ISOM_DECREASE_SIZE(ptr, 16);
			ptr->item_locations[i].item_ID = gf_bs_read_u32(bs);
			ptr->item_locations[i].construction_method = gf_bs_read_u32(bs);
			ptr->item_locations[i].data_reference_index = gf_bs_read_u32(bs);
			ptr->item_locations[i].base_offset = gf_bs_read_u64(bs);
		}
	}
	return GF_OK;
}

#ifndef GPAC_DISABLE_ISOM_WRITE

GF_Err iloc_box_write(GF_Box *s, GF_BitStream *bs)
{
	GF_Err e;
	u32 i;
	GF_ItemLocationBox *ptr = (GF_ItemLocationBox *)s;

	e = gf_isom_full_box_write(s, bs);
	if (e) return e;
	gf_bs_write_u32(bs, ptr->item_count);
	if (ptr->item_count > 0) {
		for (i = 0; i < ptr->item_count; i++) {
			gf_bs_write_u32(bs, ptr->item_locations[i].item_ID);
			gf_bs_write_u32(bs, ptr->item_locations[i].construction_method);
			gf_bs_write_u32(bs, ptr->item_locations[i].data_reference_index);
			gf_bs_write_u64(bs, ptr->item_locations[i].base_offset);
		}
	}
	return GF_OK;
}

GF_Err iloc_box_size(GF_Box *s)
{
	GF_ItemLocationBox *ptr = (GF_ItemLocationBox *)s;

	ptr->size += 4 + 16 * ptr->item_count;
	return GF_OK;
}

#endif /*GPAC_DISABLE_ISOM_WRITE*/