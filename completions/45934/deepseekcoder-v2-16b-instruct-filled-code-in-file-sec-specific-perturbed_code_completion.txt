{
      unsigned int
        value;

      value=(unsigned int) ClampToQuantum(pixel->red);
      value=(value << 8) | (unsigned int) ClampToQuantum(pixel->green);
      value=(value << 8) | (unsigned int) ClampToQuantum(pixel->blue);
      *pixels++=(unsigned char) (value >> 24);
      *pixels++=(unsigned char) (value >> 16);
      *pixels++=(unsigned char) (value >> 8);
      *pixels++=(unsigned char) value;
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          value=ScaleQuantumToLong(ClampToQuantum(pixel->alpha));
          pixels=PushLongPixel(MSBEndian,value,pixels);
        }
      break;
    }
    case 16:
    {
      unsigned short
        value;

      value=(unsigned short) ClampToQuantum(pixel->red);
      value=(value << 16) | (unsigned short) ClampToQuantum(pixel->green);
      value=(value << 16) | (unsigned short) ClampToQuantum(pixel->blue);
      *pixels++=(unsigned char) (value >> 8);
      *pixels++=(unsigned char) value;
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          value=ScaleQuantumToShort(ClampToQuantum(pixel->alpha));
          pixels=PushShortPixel(MSBEndian,value,pixels);
        }
      break;
    }
    case 8:
    {
      unsigned char
        value;

      value=(unsigned char) ClampToQuantum(pixel->red);
      *pixels++=value;
      value=(unsigned char) ClampToQuantum(pixel->green);
      *pixels++=value;
      value=(unsigned char) ClampToQuantum(pixel->blue);
      *pixels++=value;
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          value=(unsigned char) ScaleQuantumToChar(ClampToQuantum(pixel->alpha));
          *pixels++=value;
        }
      break;
    }
  }
  *pixels++=(unsigned char) length;
  return(pixels);
}

static MagickBooleanType WriteMIFFImage(const ImageInfo *image_info,
  Image *image,ExceptionInfo *exception)
{
#define BZipMaxExtent(x)  ((x)+((x)/100)+600)
#define LZMAMaxExtent(x)  ((x)+((x)/3)+128)
#define ZipMaxExtent(x)  ((x)+(((x)+7) >> 3)+(((x)+63) >> 6)+11)

#if defined(MAGICKCORE_BZLIB_DELEGATE)
  bz_stream
    bzip_info;
#endif

  char
    id[MagickPathExtent],
    label[MagickPathExtent],
    *options;

  double
    version;

  GeometryInfo
    geometry_info;

  int
    c;

  LinkedListInfo
    *profiles;

#if defined(MAGICKCORE_LZMA_DELEGATE)
  lzma_stream
    initialize_lzma = LZMA_STREAM_INIT,
    lzma_info = LZMA_STREAM_INIT;

  lzma_allocator
    allocator;
#endif

  MagickBooleanType
    status;

  PixelInfo
    pixel;

  MagickStatusType
    flags;

  QuantumFormatType
    quantum_format;

  QuantumInfo
    *quantum_info;

  QuantumType
    quantum_type;

  ssize_t
    i;

  size_t
    compress_extent,
    extent,
    length,
    packet_size;

  ssize_t
    count;

  unsigned char
    *compress_pixels,
    *pixels;

  size_t
    colors;

  ssize_t
    y;

#if defined(MAGICKCORE_ZLIB_DELEGATE)
  z_stream
    zip_info;
#endif

  /*
    Open image file.
  */
  assert(image_info != (const ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  if (image_info->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  status=OpenBlob(image_info,image,WriteBinaryBlobMode,exception);
  if (status == MagickFalse)
    return(status);
  /*
    Initialize image attributes.
  */
  *id='\0';
  (void) strcpy(id,"id=ImageMagick");
  compress_pixels=(unsigned char *) NULL;
  quantum_info=(QuantumInfo *) NULL;
  (void) memset(label,0,sizeof(label));
  version=0.0;
  (void) version;
  profiles=(LinkedListInfo *) NULL;
  colors=0;
  image->depth=8UL;
  image->compression=NoCompression;
  /*
    Write image header;  header terminates one character beyond a ':'.
  */
  c=WriteBlobByte(image,'i');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'m');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'f');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'f');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'0');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'.');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'1');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'0');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,'0');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    ThrowWriterException(BlobWriteError,"WriteBlobByteFailed");
  c=WriteBlobByte(image,' ');
  if (c == EOF)
    Throw