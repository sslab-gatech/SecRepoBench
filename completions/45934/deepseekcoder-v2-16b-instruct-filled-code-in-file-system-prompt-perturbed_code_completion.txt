value,pixels);
        }
      if (image->colorspace == CMYKColorspace)
        {
          value=ScaleQuantumToLong(ClampToQuantum(pixel->black));
          pixels=PopLongPixel(MSBEndian,value,pixels);
        }
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          value=ScaleQuantumToLong(ClampToQuantum(pixel->alpha));
          pixels=PopLongPixel(MSBEndian,value,pixels);
        }
      break;
    }
    case 16:
    {
      unsigned short
        value;

      value=ScaleQuantumToShort(ClampToQuantum(pixel->red));
      pixels=PopShortPixel(MSBEndian,value,pixels);
      if (IsGrayColorspace(image->colorspace) == MagickFalse)
        {
          value=ScaleQuantumToShort(ClampToQuantum(pixel->green));
          pixels=PopShortPixel(MSBEndian,value,pixels);
          value=ScaleQuantumToShort(ClampToQuantum(pixel->blue));
          pixels=PopShortPixel(MSBEndian,value,pixels);
        }
      if (image->colorspace == CMYKColorspace)
        {
          value=ScaleQuantumToShort(ClampToQuantum(pixel->black));
          pixels=PopShortPixel(MSBEndian,value,pixels);
        }
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          value=ScaleQuantumToShort(ClampToQuantum(pixel->alpha));
          pixels=PopShortPixel(MSBEndian,value,pixels);
        }
      break;
    }
    case 8:
    {
      unsigned char
        value;

      value=ScaleQuantumToChar(ClampToQuantum(pixel->red));
      pixels=PopCharPixel(value,pixels);
      if (IsGrayColorspace(image->colorspace) == MagickFalse)
        {
          value=ScaleQuantumToChar(ClampToQuantum(pixel->green));
          pixels=PopCharPixel(value,pixels);
          value=ScaleQuantumToChar(ClampToQuantum(pixel->blue));
          pixels=PopCharPixel(value,pixels);
        }
      if (image->colorspace == CMYKColorspace)
        {
          value=ScaleQuantumToChar(ClampToQuantum(pixel->black));
          pixels=PopCharPixel(value,pixels);
        }
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          value=ScaleQuantumToChar(ClampToQuantum(pixel->alpha));
          pixels=PopCharPixel(value,pixels);
        }
      break;
    }
  }
  *pixels++=(unsigned char) length;
  return(pixels);
}

static MagickBooleanType WriteMIFFImage(const ImageInfo *image_info,
  Image *image,ExceptionInfo *exception)
{
#define BZipMaxExtent(x)  ((x)+((x)/100)+600)
#define LZMAMaxExtent(x)  ((x)+((x)/3)+128)
#define ZipMaxExtent(x)  ((x)+(((x)+7) >> 3)+(((x)+63) >> 6)+11)

#if defined(MAGICKCORE_BZLIB_DELEGATE)
  bz_stream
    bzip_info;
#endif

  char
    *options;

  double
    version;

  size_t
    compress_extent,
    extent,
    length,
    packet_size;

  ssize_t
    count;

  unsigned char
    *compress_pixels,
    *pixels;

#if defined(MAGICKCORE_ZLIB_DELEGATE)
  z_stream
    zip_info;
#endif

  /*
    Open image file.
  */
  assert(image_info != (const ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  if (image_info->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
  /*
    Initialize bzip2 stream.
  */
#if defined(MAGICKCORE_BZLIB_DELEGATE)
  (void) memset(&bzip_info,0,sizeof(bzip_info));
  bzip_info.bzalloc=AcquireBZIPMemory;
  bzip_info.bzfree=RelinquishBZIPMemory;
  bzip_info.opaque=(void *) image;
#endif
  /*
    Initialize lzma stream.
  */
#if defined(MAGICKCORE_LZMA_DELEGATE)
  (void) memset(&bzip_info,0,sizeof(bzip_info));
  allocator.alloc=AcquireLZMAMemory;
  allocator.free=RelinquishLZMAMemory;
  allocator.opaque=(void *) image;
  lzma_info=initialize_lzma;
  lzma_info.allocator=(&allocator);
#endif
  /*
    Initialize zip stream.
  */
#if defined(MAGICKCORE_ZLIB_DELEGATE)
  (void) memset(&zip_info,0,sizeof(zip_info));
  zip_info.zalloc=AcquireZIPMemory;
  zip_info.zfree=RelinquishZIPMemory;
  zip_info.opaque=(voidpf) image;
#endif
  /*
    Write image header.
  */
  options=AcquireString((char *) NULL);
  (void) FormatLocaleString(options,MagickPathExtent,"id=ImageMagick version=%s",
    image_info->version);
  if (LocaleCompare(image_info->magick,"MIFF") != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s format=MIFF",
      options);
  if (image->delay != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s delay=%u",
      options,image->delay);
  if (image->ticks_per_second != 100)
    (void) FormatLocaleString(options,MagickPathExtent,"%s ticks-per-second=%d",
      options,image->ticks_per_second);
  if (image->scene != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s scene=%u",
      options,image->scene);
  if (image->iterations != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s iterations=%u",
      options,image->iterations);
  if (image->dispose != UndefinedDispose)
    (void) FormatLocaleString(options,MagickPathExtent,"%s dispose=%s",
      options,GetDisposeString(image->dispose));
  if (image->page.width != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s page=%lux%lu+%lu+%lu",
      options,image->page.width,image->page.height,image->page.x,image->page.y);
  if (image->units != UndefinedResolution)
    (void) FormatLocaleString(options,MagickPathExtent,"%s units=%s",
      options,GetResolutionType(image->units));
  if (image->gamma != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s gamma=%f",
      options,image->gamma);
  if (image->colorspace != sRGBColorspace)
    (void) FormatLocaleString(options,MagickPathExtent,"%s colorspace=%s",
      options,GetColorspace(image->colorspace));
  if (image->chromaticity.red_primary.x != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s red-primary=%f,%f",
      options,image->chromaticity.red_primary.x,image->chromaticity.red_primary.y);
  if (image->chromaticity.green_primary.x != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s green-primary=%f,%f",
      options,image->chromaticity.green_primary.x,image->chromaticity.green_primary.y);
  if (image->chromaticity.blue_primary.x != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s blue-primary=%f,%f",
      options,image->chromaticity.blue_primary.x,image->chromaticity.blue_primary.y);
  if (image->chromaticity.white_point.x != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s white-point=%f,%f",
      options,image->chromaticity.white_point.x,image->chromaticity.white_point.y);
  if (image->orientation != UndefinedOrientation)
    (void) FormatLocaleString(options,MagickPathExtent,"%s orientation=%s",
      options,GetOrientation(image->orientation));
  if (image->rendering_intent != UndefinedIntent)
    (void) FormatLocaleString(options,MagickPathExtent,"%s rendering-intent=%s",
      options,GetRenderingIntent(image->rendering_intent));
  if (image->matte_color.red != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s mattecolor=%f,%f,%f",
      options,image->matte_color.red,image->matte_color.green,image->matte_color.blue);
  if (image->background_color.red != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s background-color=%f,%f,%f",
      options,image->background_color.red,image->background_color.green,
      image->background_color.blue);
  if (image->border_color.red != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s border-color=%f,%f,%f",
      options,image->border_color.red,image->border_color.green,image->border_color.blue);
  if (image->matte_color.red != 0.0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s mattecolor=%f,%f,%f",
      options,image->matte_color.red,image->matte_color.green,image->matte_color.blue);
  if (image->montage != (char *) NULL)
    (void) FormatLocaleString(options,MagickPathExtent,"%s montage=%s",
      options,image->montage);
  if (image->quality != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s quality=%u",
      options,image->quality);
  if (image->compression != NoCompression)
    (void) FormatLocaleString(options,MagickPathExtent,"%s compression=%s",
      options,GetCompressionType(image->compression));
  if (image->depth != 8)
    (void) FormatLocaleString(options,MagickPathExtent,"%s depth=%u",
      options,image->depth);
  if (image->alpha_trait != UndefinedPixelTrait)
    (void) FormatLocaleString(options,MagickPathExtent,"%s alpha-trait=%s",
      options,GetPixelTrait(image->alpha_trait));
  if (image->intensity != UndefinedIntensity)
    (void) FormatLocaleString(options,MagickPathExtent,"%s pixel-intensity=%s",
      options,GetPixelIntensity(image->intensity));
  if (image->endian != UndefinedEndian)
    (void) FormatLocaleString(options,MagickPathExtent,"%s endian=%s",
      options,GetEndianType(image->endian));
  if (image->colors != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s colors=%u",
      options,image->colors);
  if (image->columns != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s columns=%lu",
      options,image->columns);
  if (image->rows != 0)
    (void) FormatLocaleString(options,MagickPathExtent,"%s rows=%lu",
      options,image->rows);
  if (image->gravity != UndefinedGravity)
    (void) FormatLocaleString(options,MagickPathExtent,"%s gravity=%s",
      options,GetGravity(image->gravity));
  if