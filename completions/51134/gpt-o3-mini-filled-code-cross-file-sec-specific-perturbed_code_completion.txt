{
  if (st >= str.size())
    return 0;
  if (opts & aeUTF8) {
    unsigned char uc = str[st];
    int in_len = 1;
    if (uc & 0x80) {
      if ((uc & 0xE0) == 0xC0)
        in_len = 2;
      else if ((uc & 0xF0) == 0xE0)
        in_len = 3;
      else if ((uc & 0xF8) == 0xF0)
        in_len = 4;
    }
    unsigned char cp = static_cast<unsigned char>(*p);
    int cond_len = 1;
    if (cp & 0x80) {
      if ((cp & 0xE0) == 0xC0)
        cond_len = 2;
      else if ((cp & 0xF0) == 0xE0)
        cond_len = 3;
      else if ((cp & 0xF8) == 0xF0)
        cond_len = 4;
    }
    if (st + cond_len > str.size())
      return 0;
    bool matched = (cond_len == in_len && memcmp(&str[st], p, cond_len) == 0);
    if (matched) {
      if (pos != std::string::npos)
        ingroup = true;
      else
        st += in_len;
    } else {
      if (pos == std::string::npos)
        return 0;
    }
    p = nextchar(p);
  } else {
    bool matched = (str[st] == *p);
    if (matched) {
      if (pos != std::string::npos)
        ingroup = true;
      else
        ++st;
    } else {
      if (pos == std::string::npos)
        return 0;
    }
    p = nextchar(p);
  }
}