if (pos != std::string::npos) {
    if (st >= str.size()) {
        return 0;  // End of input string reached
    }
    unsigned char ch = str[st];
    if ((opts & aeUTF8) && (ch & 0xc0) == 0xc0) {
        // Handle multi-byte UTF-8 character
        size_t char_len = 1;
        while (char_len < 4 && st + char_len < str.size() && (str[st + char_len] & 0xc0) == 0x80) {
            ++char_len;
        }
        if (strncmp(p, &str[st], char_len) == 0) {
            ingroup = true;
            st += char_len;
        }
    } else if (*p == ch) {
        ingroup = true;
        ++st;
    }
} else {
    if (*p != str[st]) {
        return 0;  // Character doesn't match outside of group
    }
    ++st;
}
p = nextchar(p);