{
  if (st >= str.size())
    return 0;
  const char* cp = p;
  size_t cond_len = 1;
  if (opts & aeUTF8) {
    unsigned char lead = static_cast<unsigned char>(*cp);
    if (lead < 0x80)
      cond_len = 1;
    else if ((lead >> 5) == 0x6)
      cond_len = 2;
    else if ((lead >> 4) == 0xe)
      cond_len = 3;
    else if ((lead >> 3) == 0x1e)
      cond_len = 4;
  }
  const char* sp = str.data() + st;
  size_t inp_len = 1;
  if (opts & aeUTF8) {
    unsigned char lead = static_cast<unsigned char>(*sp);
    if (lead < 0x80)
      inp_len = 1;
    else if ((lead >> 5) == 0x6)
      inp_len = 2;
    else if ((lead >> 4) == 0xe)
      inp_len = 3;
    else if ((lead >> 3) == 0x1e)
      inp_len = 4;
  }
  if (cond_len == inp_len && memcmp(cp, sp, cond_len) == 0) {
    if (pos != std::string::npos)
      ingroup = true;
    p = nextchar(p);
    st += inp_len;
    if (opts & aeUTF8) {
      while (st < str.size() && ((static_cast<unsigned char>(str[st]) & 0xc0) == 0x80))
        ++st;
    }
  } else {
    if (pos == std::string::npos)
      return 0;
    p = nextchar(p);
  }
  break;
}