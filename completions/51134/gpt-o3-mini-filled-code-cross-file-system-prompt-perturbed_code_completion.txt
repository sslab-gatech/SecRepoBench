{
  if (st >= str.size())
    return 0;

  int condCharLen = 1, inputCharLen = 1;
  if (opts & aeUTF8) {
    unsigned char cu = static_cast<unsigned char>(*p);
    if (cu & 0x80) {
      if ((cu & 0xE0) == 0xC0)
        condCharLen = 2;
      else if ((cu & 0xF0) == 0xE0)
        condCharLen = 3;
      else if ((cu & 0xF8) == 0xF0)
        condCharLen = 4;
    }
    unsigned char iu = static_cast<unsigned char>(str[st]);
    if (iu & 0x80) {
      if ((iu & 0xE0) == 0xC0)
        inputCharLen = 2;
      else if ((iu & 0xF0) == 0xE0)
        inputCharLen = 3;
      else if ((iu & 0xF8) == 0xF0)
        inputCharLen = 4;
    }
  }

  bool match = false;
  if ((opts & aeUTF8) && condCharLen != inputCharLen) {
    match = false;
  } else if (opts & aeUTF8) {
    match = (strncmp(p, &str[st], condCharLen) == 0);
  } else {
    match = (*p == str[st]);
  }

  if (match) {
    ingroup = true;
    st += (opts & aeUTF8) ? condCharLen : 1;
  } else {
    if (!ingroup)
      return 0;
  }
  p = nextchar(p);
}