if (pos != std::string::npos) {  // We're inside a character group/class
  if (st < str.size() && *p == str[st]) {  // Match in the group
    ingroup = true;  // Note that we found a match in the group
  }
  p = nextchar(p);  // Move to the next character in the condition
} else if (st < str.size() && *p == str[st]) {  // Character match outside a group
  p = nextchar(p);
  ++st;  // Move to the next character in the string
  
  // Skip any continuation bytes
  while ((opts & aeUTF8) && st < str.size() && (str[st] & 0xc0) == 0x80)
    ++st;
  
  if (st == str.size() && p && *p != ']')
    return 0;  // If we've reached the end of the string but not the end of the condition
} else {  // No match outside a group
  return 0;
}