{
    // if there's no more input, condition fails unless we're at the end of the conditions
    if (st >= str.size()) {
        return 0;
    }

    // if we're inside a group
    if (pos != std::string::npos) {
        // check if current condition character matches the current input character
        if (*p == str[st]) {
            ingroup = true;
        }
        // move to the next condition character
        p = nextchar(p);
    } else {
        // outside a group, we require an exact match
        if (*p != str[st]) {
            return 0;
        }
        // move to the next condition character
        p = nextchar(p);
        // skip the matched input character
        ++st;
        // handle possible UTF-8 continuation bytes
        while ((opts & aeUTF8) && (st < str.size()) && ((str[st] & 0xc0) == 0x80)) {
            ++st;
        }
        // if there's still more condition to check but no more input, fail
        if ((st == str.size()) && p) {
            return 0;
        }
    }
}