if (pos != std::string::npos && st < str.size()) {
    unsigned char uc = str[st];
    if ((opts & aeUTF8) && (uc & 0xc0) == 0xc0) {
        size_t charlen = 1;
        for (size_t i = 1; i < 6 && st + i < str.size(); ++i) {
            if ((str[st + i] & 0xc0) != 0x80) break;
            ++charlen;
        }
        if (charlen > 1) {
            if (pos + charlen <= str.size() && strncmp(p, &str[pos], charlen) == 0) {
                ingroup = true;
                st += charlen;
                p += charlen;
            } else {
                p = nextchar(p);
            }
        } else {
            if (*p == uc) {
                ingroup = true;
                ++st;
                p = nextchar(p);
            } else {
                p = nextchar(p);
            }
        }
    } else {
        if (*p == uc) {
            ingroup = true;
            ++st;
            p = nextchar(p);
        } else {
            p = nextchar(p);
        }
    }
} else {
    if (pos == std::string::npos && st >= str.size()) {
        return 0;
    }
    p = nextchar(p);
}