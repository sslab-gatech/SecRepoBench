if (st < str.size() && str[st] == *p) {
    p = nextchar(p);
    if ((opts & aeUTF8) && (str[st] & 0x80)) {
        st++;
        while (p && (st < str.size())) {
            if (*p != str[st]) {
                if (!pos)
                    return 0;
                st = pos;
                break;
            }
            // not a UTF-8 continuation byte
            if ((*p & 0xc0) != 0x80)
                break;
            p = nextchar(p);
            st++;
        }
        if (pos && st != pos) {
            if (neg)
                return 0;
            else if (st == str.size())
                return 1;
            ingroup = true;
            while (p && *p != ']' && ((p = nextchar(p)) != NULL)) {
            }
            st++;
        }
        if (p && *p != ']')
            p = nextchar(p);
    } else if (pos) {
        if (neg)
            return 0;
        else if (st == str.size() - 1)
            return 1;
        ingroup = true;
        while (p && *p != ']' && ((p = nextchar(p)) != NULL)) {
        }
        st++;
    }
    if (!pos) {
        st++;
    }
    if (st >= str.size() && p && *p != ']')
        return 0;  // word <= condition
} else if (pos) {  // group
    p = nextchar(p);
} else
    return 0;