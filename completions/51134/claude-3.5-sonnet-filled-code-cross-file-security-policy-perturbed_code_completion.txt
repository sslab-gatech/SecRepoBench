if (pos != std::string::npos && st < str.size()) {
    unsigned char ch = str[st];
    if ((opts & aeUTF8) && (ch & 0xc0) == 0xc0) {
        // Handle multi-byte UTF-8 character
        size_t char_len = 1;
        while (char_len < 4 && st + char_len < str.size() && (str[st + char_len] & 0xc0) == 0x80) {
            ++char_len;
        }
        if (strncmp(p, str.c_str() + st, char_len) == 0) {
            ingroup = true;
            st += char_len;
            p += char_len;
        } else {
            p = nextchar(p);
        }
    } else {
        // Handle single-byte character
        if (*p == ch) {
            ingroup = true;
            ++st;
            p = nextchar(p);
        } else {
            p = nextchar(p);
        }
    }
} else if (pos == std::string::npos) {
    return 0;
} else {
    p = nextchar(p);
}