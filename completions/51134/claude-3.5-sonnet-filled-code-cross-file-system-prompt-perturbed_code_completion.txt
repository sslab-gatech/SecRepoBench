if (pos != std::string::npos) {
    if (st < str.size()) {
        unsigned char ch = str[st];
        if ((opts & aeUTF8) && (ch & 0xc0) == 0xc0) {
            size_t i = st;
            do {
                if (str[i] == *p) {
                    ingroup = true;
                    break;
                }
                i++;
            } while ((str[i] & 0xc0) == 0x80);
        } else if (str[st] == *p) {
            ingroup = true;
        }
    }
} else {
    if (st < str.size()) {
        unsigned char ch = str[st];
        if ((opts & aeUTF8) && (ch & 0xc0) == 0xc0) {
            size_t i = st;
            do {
                if (str[i] != *p) {
                    return 0;
                }
                i++;
                p = nextchar(p);
            } while ((str[i] & 0xc0) == 0x80 && *p);
            st = i;
        } else if (str[st] != *p) {
            return 0;
        } else {
            st++;
            p = nextchar(p);
        }
    } else {
        return 0;
    }
}