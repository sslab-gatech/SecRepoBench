if (indexlookup >= done_lookups_glyph_count->length)
  return false;

unsigned int glyph_count = done_lookups_glyph_count->get (indexlookup);
hb_set_t *glyph_set = done_lookups_glyph_set->get (indexlookup);

if (!glyph_set || !glyph_set->in_error ())
{
  if (!glyph_set->is_empty ())
  {
    hb_set_t *parent_glyphs = parent_active_glyphs ();
    if (parent_glyphs && hb_set_is_subset (parent_glyphs, glyph_set))
      return true;
  }
}

// If the lookup is not done, update the count and clear the set if necessary.
if (!glyph_set || glyph_set->in_error ())
{
  glyph_set = hb_set_create ();
  if (!glyph_set)
    return false;

  if (!done_lookups_glyph_set->resize (indexlookup + 1))
  {
    hb_set_destroy (glyph_set);
    return false;
  }

  done_lookups_glyph_set->set (indexlookup, glyph_set);
}

if (!done_lookups_glyph_count->resize (indexlookup + 1))
{
  hb_set_destroy (glyph_set);
  return false;
}

done_lookups_glyph_count->set (indexlookup, glyph_count + 1);
hb_set_clear (glyph_set);

return false;