if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN)
  http_flow->detected_protocol_stack[0] = http_flow->guessed_protocol_id;
else
  http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];

if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
  /* No subprotocol has been detected yet.
     If the guessed protocol is not plain HTTP, assume it is a subprotocol,
     so set the base layer to HTTP and the subprotocol to the guessed protocol. */
  if(http_flow->guessed_protocol_id != NDPI_PROTOCOL_HTTP) {
    http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
    http_flow->detected_protocol_stack[0] = NDPI_PROTOCOL_HTTP;
  }
} else {
  /* A subprotocol has already been detected.
     Ensure that the guessed protocol conforms to the detected subprotocol. */
  if(http_flow->guessed_protocol_id != http_flow->detected_protocol_stack[1])
    http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
}