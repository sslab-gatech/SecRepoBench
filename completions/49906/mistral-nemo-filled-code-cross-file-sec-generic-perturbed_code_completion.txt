if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN
   && http_flow->http_detected
   && packet->http_origin.len > 0) {
  ndpi_protocol_match_result ret_match;

  ndpi_match_host_subprotocol(ndpi_struct, http_flow,
                              (char *)packet->http_origin.ptr,
                              packet->http_origin.len,
                              &ret_match,
                              NDPI_PROTOCOL_HTTP);

  if(ret_match.guessed_protocol != NDPI_PROTOCOL_UNKNOWN) {
    if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
      http_flow->detected_protocol_stack[1] = ret_match.guessed_protocol;
    } else if(http_flow->detected_protocol_stack[1] != ret_match.guessed_protocol) {
      NDPI_LOG_WARN(ndpi_struct, "Mismatch in guessed protocol: %s vs %s\n",
                    ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[1]),
                    ndpi_get_proto_name(ndpi_struct, ret_match.guessed_protocol));
    }
  }

  if(ret_match.guessed_host_protocol != NDPI_PROTOCOL_UNKNOWN) {
    if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN) {
      http_flow->detected_protocol_stack[0] = ret_match.guessed_host_protocol;
    } else if(http_flow->detected_protocol_stack[0] != ret_match.guessed_host_protocol) {
      NDPI_LOG_WARN(ndpi_struct, "Mismatch in guessed host protocol: %s vs %s\n",
                    ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[0]),
                    ndpi_get_proto_name(ndpi_struct, ret_match.guessed_host_protocol));
    }
  }
}