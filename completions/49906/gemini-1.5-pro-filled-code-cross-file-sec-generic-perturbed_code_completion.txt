(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
      if(http_flow->host_protocol_guess.id == NDPI_PROTOCOL_UNKNOWN) {
        if(http_flow->protocol_guess.id != NDPI_PROTOCOL_UNKNOWN && http_flow->protocol_guess.sub_id == NDPI_PROTOCOL_UNKNOWN) {
          http_flow->detected_protocol_stack[0] = http_flow->protocol_guess.id;
          http_flow->detected_protocol_stack[1] = http_flow->protocol_guess.id;
        }
      } else {
        http_flow->detected_protocol_stack[0] = http_flow->host_protocol_guess.id;
        http_flow->detected_protocol_stack[1] = http_flow->protocol_guess.id;
      }
    } else {
      if (http_flow->host_protocol_guess.id != NDPI_PROTOCOL_UNKNOWN && http_flow->protocol_guess.id != NDPI_PROTOCOL_UNKNOWN) {
        if (http_flow->detected_protocol_stack[0] != http_flow->host_protocol_guess.id ||
          http_flow->detected_protocol_stack[1] != http_flow->protocol_guess.id) {
          NDPI_LOG_ERR(ndpi_struct, "Protocol mismatch: detected_protocol_stack[0]=%u, "
            "host_protocol_guess.id=%u, detected_protocol_stack[1]=%u, protocol_guess.id=%u\n",
            http_flow->detected_protocol_stack[0], http_flow->host_protocol_guess.id,
            http_flow->detected_protocol_stack[1], http_flow->protocol_guess.id);
          // Handle the mismatch as appropriate, e.g., log an error or reset the detected protocols.
        }
      }
    }