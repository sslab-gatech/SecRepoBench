if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN) {
  /* If nothing is detected yet, set the first protocol to our guess */
  if(http_flow->guessed_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
    http_flow->detected_protocol_stack[0] = http_flow->guessed_protocol_id;
  }
} else {
  /* Otherwise, if we haven't guessed yet, take the already-detected one */
  if(http_flow->guessed_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
    http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];
  }
}

/* If the second protocol slot is empty and we have a valid guess, fill it. */
if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN &&
   http_flow->guessed_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
  http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
} else if(http_flow->detected_protocol_stack[1] != NDPI_PROTOCOL_UNKNOWN) {
  /*
    If the second slot is already occupied and we're missing a guess,
    adjust our guess to what's detected so guess and detected align.
  */
  if(http_flow->guessed_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
    http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
  }
}