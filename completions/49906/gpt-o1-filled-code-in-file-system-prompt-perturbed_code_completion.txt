if ((flow->guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN) &&
    (flow->guessed_protocol_id      != NDPI_PROTOCOL_UNKNOWN)) {
  if (flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
    /* No second protocol set: adopt the guessed ones */
    flow->detected_protocol_stack[0] = flow->guessed_host_protocol_id;
    flow->detected_protocol_stack[1] = flow->guessed_protocol_id;
  } else {
    /* Second protocol is already detected: keep stack consistent with guesses */
    flow->guessed_host_protocol_id = flow->detected_protocol_stack[0];
    flow->guessed_protocol_id      = flow->detected_protocol_stack[1];
  }
}