if((http_flow->guessed_host_protocol_id >= NDPI_PROTOCOL_UNKNOWN)
   && (http_flow->guessed_protocol_id >= NDPI_PROTOCOL_UNKNOWN)) {
  if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
    ndpi_protocol ret = ndpi_detection_giveup(ndpi_struct, http_flow, 1 /* force */, &http_flow->risk);

    if(ret.app_protocol != NDPI_PROTOCOL_UNKNOWN) {
      http_flow->detected_protocol_stack[1] = http_flow->detected_protocol_stack[0];
      http_flow->detected_protocol_stack[0] = ret.app_protocol;
    }
  } else {
    if((http_flow->guessed_protocol_id != http_flow->detected_protocol_stack[1])
       || (http_flow->guessed_host_protocol_id != http_flow->detected_protocol_stack[0])) {
      NDPI_LOG_DBG(ndpi_struct, "[HTTP] [guessed: %u/%u] != [detected: %u/%u]\n",
		   http_flow->guessed_host_protocol_id, http_flow->guessed_protocol_id,
		   http_flow->detected_protocol_stack[0], http_flow->detected_protocol_stack[1]);
      http_flow->detected_protocol_stack[0] = NDPI_PROTOCOL_UNKNOWN;
      http_flow->detected_protocol_stack[1] = NDPI_PROTOCOL_UNKNOWN;
    }
  }
}