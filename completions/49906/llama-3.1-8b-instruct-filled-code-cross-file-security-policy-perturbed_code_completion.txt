if((http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN)
   && (http_flow->http_detected)
   && (packet->http_origin.len > 0)) {
  ndpi_protocol_match_result ret_match;

  if(guessed_host_protocol_id!= NDPI_PROTOCOL_UNKNOWN) {
    if(ndpi_is_valid_protocol_id(guessed_host_protocol_id) == 0) {
      if(ndpi_is_ntop_protocol(&ndpi_struct->protocol[guessed_host_protocol_id]) == 0) {
        if(ndpi_is_valid_protocol_id(http_flow->detected_protocol_stack[0]) == 0) {
          if(ndpi_is_valid_protocol_id(http_flow->detected_protocol_stack[1]) == 0) {
            if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_HTTP) {
              http_flow->detected_protocol_stack[0] = guessed_host_protocol_id;
              http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
            } else {
              http_flow->detected_protocol_stack[0] = http_flow->guessed_protocol_id;
              http_flow->detected_protocol_stack[1] = guessed_host_protocol_id;
            }
          }
        }
      }
    }
  }

  ndpi_match_host_subprotocol(ndpi_struct, http_flow,
                              (char *)packet->http_origin.ptr,
                              packet->http_origin.len,
                              &ret_match,
                              NDPI_PROTOCOL_HTTP);
}