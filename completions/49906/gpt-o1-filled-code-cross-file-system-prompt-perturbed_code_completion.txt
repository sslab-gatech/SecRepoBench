if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN) {
      /* If "detected" in flow == 0 then "detected" = "guess" */
      if(http_flow->guessed_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
        http_flow->detected_protocol_stack[0] = http_flow->guessed_protocol_id;
      }
    } else {
      /* Else "guess" = "detected" */
      if(http_flow->guessed_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
        http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];
      }
    }

    /*
      If the second protocol in the stack is unknown, and the current guessed protocol
      has no subprotocols, set the second to the guessed protocol. If the second protocol
      is already detected, ensure that the guessed protocol matches the detected one.
    */
    if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
      if(http_flow->guessed_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
        http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
      }
    } else {
      if(http_flow->guessed_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
        http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
      }
    }