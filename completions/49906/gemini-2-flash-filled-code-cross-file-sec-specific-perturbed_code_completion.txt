(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
      if(http_flow->guessed_host_protocol_id != NDPI_PROTOCOL_NO_SUB_PROTOCOL) {
        ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_host_protocol_id, http_flow->guessed_protocol_id, NDPI_CONFIDENCE_DPI);
      } else {
        ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_protocol_id, NDPI_PROTOCOL_HTTP, NDPI_CONFIDENCE_DPI);
      }
    } else {
      if((http_flow->guessed_protocol_id != http_flow->detected_protocol_stack[0]) &&
         (http_flow->guessed_protocol_id != http_flow->detected_protocol_stack[1])) {
        /* This is bad */
        NDPI_LOG_ERROR(ndpi_struct, "Guessed protocol %s does not match detected protocols %s/%s\n",
                       ndpi_get_proto_name(ndpi_struct, http_flow->guessed_protocol_id),
                       ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[0]),
                       ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[1]));
      }

      if((http_flow->guessed_host_protocol_id != NDPI_PROTOCOL_NO_SUB_PROTOCOL) &&
         (http_flow->guessed_host_protocol_id != http_flow->detected_protocol_stack[0]) &&
         (http_flow->guessed_host_protocol_id != http_flow->detected_protocol_stack[1])) {
        /* This is bad */
        NDPI_LOG_ERROR(ndpi_struct, "Guessed host protocol %s does not match detected protocols %s/%s\n",
                       ndpi_get_proto_name(ndpi_struct, http_flow->guessed_host_protocol_id),
                       ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[0]),
                       ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[1]));
      }
    }