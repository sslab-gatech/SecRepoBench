((http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN)
       && (http_flow->guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN)
       && (ndpi_proto_defaults[http_flow->guessed_host_protocol_id].num_subprotocols == 0)) {
      ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_host_protocol_id, http_flow->guessed_protocol_id, NDPI_CONFIDENCE_DPI);
    } else if((http_flow->detected_protocol_stack[1] != NDPI_PROTOCOL_UNKNOWN)
	      && ((http_flow->guessed_protocol_id != http_flow->detected_protocol_stack[1])
		  || (http_flow->guessed_host_protocol_id != http_flow->detected_protocol_stack[0]))) {
      /*
	This happens when we have already detected a protocol (e.g. SSL) and then we
	detect HTTP on top of it. In this case we want to keep the original protocol
	and not overwrite it with HTTP.
      */
      NDPI_LOG_INFO(ndpi_struct, "Mismatching protocols: detected %s/%s, guessed %s/%s\n",
		    ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[0]),
		    ndpi_get_proto_name(ndpi_struct, http_flow->detected_protocol_stack[1]),
		    ndpi_get_proto_name(ndpi_struct, http_flow->guessed_host_protocol_id),
		    ndpi_get_proto_name(ndpi_struct, http_flow->guessed_protocol_id));
    }