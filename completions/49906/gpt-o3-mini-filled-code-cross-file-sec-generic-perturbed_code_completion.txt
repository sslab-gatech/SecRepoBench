if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_UNKNOWN) {
    // No host protocol was detected, so adopt the guessed protocol as the host protocol.
    http_flow->detected_protocol_stack[0] = http_flow->guessed_protocol_id;
} else {
    // A host protocol was already detected, so make sure the guessed protocol matches it.
    http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];
}

if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
    // If no subprotocol has been set and the current guessed protocol has no subprotocols,
    // then we set the second slot to the guessed protocol.
    http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
} else {
    // If a subprotocol was already detected in the second slot, ensure consistency.
    if(http_flow->detected_protocol_stack[1] != http_flow->guessed_protocol_id) {
        ndpi_set_risk(ndpi_struct, http_flow, NDPI_PROTOCOL_INCONSISTENCY,
                      "Mismatch between guessed and detected subprotocols");
    }
}