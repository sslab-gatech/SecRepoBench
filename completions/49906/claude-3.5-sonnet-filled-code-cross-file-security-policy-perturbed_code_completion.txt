(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
  u_int16_t guessed_host_protocol_id = ndpi_guess_host_protocol_id(ndpi_struct, http_flow);

  if(guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN &&
     ndpi_get_proto_category(ndpi_struct, guessed_host_protocol_id) != NDPI_PROTOCOL_CATEGORY_UNSPECIFIED) {
    http_flow->detected_protocol_stack[1] = http_flow->detected_protocol_stack[0];
    http_flow->detected_protocol_stack[0] = guessed_host_protocol_id;
  } else {
    http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
    http_flow->detected_protocol_stack[0] = guessed_host_protocol_id;
  }
} else {
  if(http_flow->detected_protocol_stack[1] != http_flow->guessed_protocol_id) {
    if(ndpi_is_ntop_protocol(&http_flow->detected_protocol)) {
      http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
    } else {
      u_int16_t guessed_host_protocol_id = ndpi_guess_host_protocol_id(ndpi_struct, http_flow);
      if(guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN &&
         guessed_host_protocol_id == http_flow->detected_protocol_stack[0]) {
        http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
      }
    }
  }
}