((http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) &&
 (ndpi_struct->proto_defaults[http_flow->guessed_host_protocol_id].subprotocol_count == 0)) {
  http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
  http_flow->detected_protocol_stack[0] = http_flow->guessed_host_protocol_id;
} else {
  if(http_flow->detected_protocol_stack[1] == http_flow->guessed_protocol_id &&
     http_flow->detected_protocol_stack[0] == http_flow->guessed_host_protocol_id) {
    // Do nothing, the detection is correct
  } else {
    // Make sure the guessed protocol matches the detected one
    http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
    http_flow->guessed_host_protocol_id = http_flow->detected_protocol_stack[0];
  }
}