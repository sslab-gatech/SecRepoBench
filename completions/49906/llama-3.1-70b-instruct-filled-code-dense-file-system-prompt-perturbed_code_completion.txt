if(flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
  if(ndpi_is_host_subprotocol_detected(ndpi_struct, flow) == 0) {
    if(ndpi_is_host_subprotocol_guessable(ndpi_struct, flow) == 0) {
      if(ndpi_is_protocol_guessable(ndpi_struct, flow) == 0) {
        ndpi_set_detected_protocol(ndpi_struct, flow, flow->guessed_host_protocol, flow->guessed_protocol_id, NDPI_CONFIDENCE_GUESS);
      } else {
        ndpi_set_detected_protocol(ndpi_struct, flow, flow->guessed_protocol_id, flow->guessed_host_protocol, NDPI_CONFIDENCE_GUESS);
      }
    }
  }
} else {
  if(ndpi_is_host_subprotocol_detected(ndpi_struct, flow) == 0) {
    if(ndpi_is_host_subprotocol_guessable(ndpi_struct, flow) == 0) {
      if(ndpi_is_protocol_guessable(ndpi_struct, flow) == 0) {
        if(flow->detected_protocol_stack[1] == flow->guessed_host_protocol) {
          ndpi_set_detected_protocol(ndpi_struct, flow, flow->detected_protocol_stack[0], flow->guessed_protocol_id, NDPI_CONFIDENCE_GUESS);
        } else {
          ndpi_set_detected_protocol(ndpi_struct, flow, flow->guessed_protocol_id, flow->guessed_host_protocol, NDPI_CONFIDENCE_GUESS);
        }
      } else {
        if(flow->detected_protocol_stack[1] == flow->guessed_protocol_id) {
          ndpi_set_detected_protocol(ndpi_struct, flow, flow->detected_protocol_stack[0], flow->guessed_host_protocol, NDPI_CONFIDENCE_GUESS);
        } else {
          ndpi_set_detected_protocol(ndpi_struct, flow, flow->guessed_host_protocol, flow->guessed_protocol_id, NDPI_CONFIDENCE_GUESS);
        }
      }
    }
  }
}