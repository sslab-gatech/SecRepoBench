if((flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN)
   && (ndpi_struct->proto_defaults[flow->guessed_protocol_id].can_have_a_subprotocol == 0)) {
  ndpi_set_detected_protocol(ndpi_struct, flow, flow->guessed_host_protocol_id, flow->guessed_protocol_id, NDPI_CONFIDENCE_DPI);
} else if((flow->detected_protocol_stack[1] != NDPI_PROTOCOL_UNKNOWN)
         && (flow->guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN)) {
  if(flow->guessed_host_protocol_id != flow->detected_protocol_stack[0] ||
     flow->guessed_protocol_id != flow->detected_protocol_stack[1]) {
    flow->guessed_host_protocol_id = flow->detected_protocol_stack[0];
    flow->guessed_protocol_id = flow->detected_protocol_stack[1];
  }
}