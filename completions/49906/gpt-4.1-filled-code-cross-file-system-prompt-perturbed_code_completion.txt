((http_flow->guessed_protocol_id != NDPI_PROTOCOL_UNKNOWN) &&
     (http_flow->guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN)) {
      if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
        /* If no subprotocol detected yet, set stack[0] to host protocol, stack[1] to guessed protocol */
        http_flow->detected_protocol_stack[0] = http_flow->guessed_host_protocol_id;
        http_flow->detected_protocol_stack[1] = http_flow->guessed_protocol_id;
      } else {
        /* If already detected, ensure guessed matches detected */
        http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
        http_flow->guessed_host_protocol_id = http_flow->detected_protocol_stack[0];
      }
    }