if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
  if(ndpi_is_valid_host_subprotocol(ndpi_struct, http_flow->host_server_name, strlen(http_flow->host_server_name)) == 0) {
    ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_host_protocol, NDPI_PROTOCOL_HTTP, NDPI_CONFIDENCE_DPI);
  } else {
    ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_protocol_id, NDPI_PROTOCOL_HTTP, NDPI_CONFIDENCE_DPI);
  }
} else {
  if(ndpi_is_valid_host_subprotocol(ndpi_struct, http_flow->host_server_name, strlen(http_flow->host_server_name)) == 0) {
    if(http_flow->guessed_host_protocol!= http_flow->detected_protocol_stack[1]) {
      ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_host_protocol, http_flow->detected_protocol_stack[0], NDPI_CONFIDENCE_DPI);
    }
  } else {
    if(http_flow->guessed_protocol_id!= http_flow->detected_protocol_stack[1]) {
      ndpi_set_detected_protocol(ndpi_struct, http_flow, http_flow->guessed_protocol_id, http_flow->detected_protocol_stack[0], NDPI_CONFIDENCE_DPI);
    }
  }
}