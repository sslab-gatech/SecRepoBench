if (flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
  if (ndpi_struct->subprotocol_conf[flow->guessed_host_protocol_id].func != NULL) {
    flow->detected_protocol_stack[1] = flow->guessed_host_protocol_id;
    flow->detected_protocol_stack[0] = flow->guessed_protocol_id;
  } else {
    flow->detected_protocol_stack[1] = flow->guessed_protocol_id;
    flow->detected_protocol_stack[0] = flow->guessed_host_protocol_id;
  }
} else {
  if (flow->guessed_host_protocol_id != NDPI_PROTOCOL_UNKNOWN) {
    flow->detected_protocol_stack[1] = flow->guessed_host_protocol_id;
    flow->detected_protocol_stack[0] = flow->guessed_protocol_id;
  }
}