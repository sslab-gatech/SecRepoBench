if((http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN)
   && (http_flow->http_detected)
   && (packet->http_origin.len > 0)) {
  ndpi_protocol_match_result ret_match;

  ndpi_match_host_subprotocol(ndpi_struct, http_flow,
                              (char *)packet->http_origin.ptr,
                              packet->http_origin.len,
                              &ret_match,
                              NDPI_PROTOCOL_HTTP);

  if(ret_match == NDPI_PROTOCOL_MATCH_FOUND) {
    if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
      if(http_flow->detected_protocol_stack[0] == NDPI_PROTOCOL_HTTP) {
        http_flow->guessed_protocol_id = NDPI_PROTOCOL_HTTP;
      } else {
        http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];
      }
    } else {
      if(http_flow->detected_protocol_stack[1] != NDPI_PROTOCOL_HTTP) {
        http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
      } else {
        http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];
      }
    }
  } else if(ret_match == NDPI_PROTOCOL_MATCH_GUESS) {
    if(http_flow->detected_protocol_stack[1] == NDPI_PROTOCOL_UNKNOWN) {
      http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[0];
    } else {
      http_flow->guessed_protocol_id = http_flow->detected_protocol_stack[1];
    }
  }
}