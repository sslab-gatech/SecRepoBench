if(body_offset < packet->payload_packet_len) {
  /* Attempt to parse realm similarly to the AS-REQ branch */
  u_int16_t name_offset = body_offset + 13;
  u_int16_t i;

  /* Move name_offset forward until we find the ASN.1 tag 0x1b or we reach a limit */
  for(i = 0; (i < 20) && (name_offset < packet->payload_packet_len); i++) {
    if(packet->payload[name_offset] != 0x1b)
      name_offset++;
    else
      break;
  }

#ifdef KERBEROS_DEBUG
  printf("[Kerberos][TGS-REQ] name_offset=%u [%02X %02X] [byte 0 must be 0x1b]\n",
         name_offset,
         packet->payload[name_offset],
         packet->payload[name_offset+1]);
#endif

  /* If we've found a valid offset within the payload, attempt to extract the realm */
  if(name_offset < packet->payload_packet_len) {
    u_int16_t realm_offset = name_offset + 3;

    /* Advance realm_offset until we find another 0x1b or we reach a small limit */
    for(i = 0; (i < 14) && (realm_offset < packet->payload_packet_len); i++) {
      if(packet->payload[realm_offset] != 0x1b)
        realm_offset++;
      else
        break;
    }

#ifdef KERBEROS_DEBUG
    printf("[Kerberos][TGS-REQ] realm_offset=%u [%02X %02X] [byte 0 must be 0x1b]\n",
           realm_offset,
           packet->payload[realm_offset],
           packet->payload[realm_offset+1]);
#endif

    /* Now retrieve the realm string if possible */
    realm_offset += 1;
    if(realm_offset < packet->payload_packet_len) {
      u_int16_t realm_len = packet->payload[realm_offset];

      if((realm_offset + realm_len) < packet->payload_packet_len) {
        char realm_str[48];
        if(realm_len > sizeof(realm_str) - 1)
          realm_len = sizeof(realm_str) - 1;

        realm_offset += 1;
        strncpy(realm_str, (char*)&packet->payload[realm_offset], realm_len);
        realm_str[realm_len] = '\0';

        /* Convert to lowercase */
        for(i = 0; i < realm_len; i++)
          realm_str[i] = tolower((unsigned char)realm_str[i]);

#ifdef KERBEROS_DEBUG
        printf("[TGS-REQ][Kerberos Realm][len: %u][%s]\n", realm_len, realm_str);
#endif
        snprintf(flow->protos.kerberos.domain, sizeof(flow->protos.kerberos.domain), "%s", realm_str);
      }
    }
  }
}