if (endp == str_end || (*endp != '.' && *endp != 'e' && *endp != 'E')) {
    // It's an integer
    if (intpart >= 0) {
        primitivevalue = plist_new_uint((uint64_t)intpart);
    } else {
        primitivevalue = plist_new_real((double)intpart);
    }
} else {
    // It's a floating point number
    // Parse decimal part if it exists
    double fracpart = 0.0;
    if (*endp == '.') {
        endp++;
        if (endp == str_end || !isdigit(*endp)) {
            PLIST_JSON_ERR("%s: invalid decimal part in '%.*s'\n", __func__, (int)str_len, str_val);
            return NULL;
        }
        double factor = 0.1;
        while (endp < str_end && isdigit(*endp)) {
            fracpart += (*endp - '0') * factor;
            factor *= 0.1;
            endp++;
        }
    }
    
    // Parse exponent part if it exists
    int exponent = 0;
    if (endp < str_end && (*endp == 'e' || *endp == 'E')) {
        endp++;
        if (endp == str_end) {
            PLIST_JSON_ERR("%s: unexpected end of input after exponent marker in '%.*s'\n", __func__, (int)str_len, str_val);
            return NULL;
        }
        
        int exp_sign = 1;
        if (*endp == '+') {
            endp++;
        } else if (*endp == '-') {
            exp_sign = -1;
            endp++;
        }
        
        if (endp == str_end || !isdigit(*endp)) {
            PLIST_JSON_ERR("%s: invalid exponent in '%.*s'\n", __func__, (int)str_len, str_val);
            return NULL;
        }
        
        while (endp < str_end && isdigit(*endp)) {
            exponent = exponent * 10 + (*endp - '0');
            endp++;
        }
        exponent *= exp_sign;
    }
    
    // Check for invalid characters
    if (endp != str_end) {
        PLIST_JSON_ERR("%s: invalid characters in number '%.*s'\n", __func__, (int)str_len, str_val);
        return NULL;
    }
    
    // Calculate the final value
    double value = (double)intpart + fracpart;
    if (exponent != 0) {
        value *= pow(10, exponent);
    }
    
    primitivevalue = plist_new_real(value);
}