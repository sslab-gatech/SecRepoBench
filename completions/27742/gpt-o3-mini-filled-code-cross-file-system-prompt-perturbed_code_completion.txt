if (result.data.type != MSGPACK_OBJECT_ARRAY ||
    result.data.via.array.size != 2) {
    continue;
}

obj = result.data.via.array.ptr;

/* Extract timestamp from the first element;
   if it fails, skip the record */
if (flb_time_pop_from_msgpack(&tms, &obj[0]) != 0) {
    continue;
}

/* Ensure the second element is a map */
if (obj[1].type != MSGPACK_OBJECT_MAP) {
    continue;
}
map = obj[1];

/* Prepare to repack the record's map.
   Save the original number of key/value pairs */
size_t orig_map_size = map.via.map.size;
if (date_key != NULL) {
    /* If a date key is provided, the repacked map must contain
       one extra field for the date */
    msgpack_pack_map(&tmp_pck, orig_map_size + 1);
}
else {
    msgpack_pack_map(&tmp_pck, orig_map_size);
}
/* Set map_size to the number of original keys so that the following
   loop iterates only over the original map fields */
map_size = orig_map_size;