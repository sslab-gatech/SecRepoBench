for (a = 0; a < end; a++) {
    if(packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len = (u_int16_t)(
							   ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));

      if(a > 0 && packet->payload[a - 1] == 0x0d)
	packet->line[packet->parsed_lines].len--;

      if(packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
	break;

      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;

      if((a + 1) >= packet->payload_packet_len)
	break;

      //a++;
    }
  }

  if(packet->parsed_lines >= 1) {
    packet->line[packet->parsed_lines].len =
      (u_int16_t)(((unsigned long) &packet->payload[packet->payload_packet_len]) -
		  ((unsigned long) packet->line[packet->parsed_lines].ptr));
    packet->parsed_lines++;
  }

  if(packet->parsed_lines > 0) {
    u_int16_t i;
    u_int16_t len = packet->line[0].len;
    u_int8_t *ptr = packet->line[0].ptr;

    if(len >= 10) {
      if(ptr[0] == 'H' && ptr[1] == 'T' && ptr[2] == 'T' && ptr[3] == 'P' && ptr[4] == '/') {
	u_int16_t bytes_read = 0;
	u_int32_t code = ndpi_bytestream_to_number(&ptr[5], len - 5, &bytes_read);

	if(bytes_read > 0) {
	  packet->http_response.ptr = &ptr[5];
	  packet->http_response.len = bytes_read;
	  packet->http_response_status_code = code;
	}
      }
    }

    for (i = 0; i < packet->parsed_lines; i++) {
      u_int16_t len = packet->line[i].len;
      u_int8_t *ptr = packet->line[i].ptr;

      if(len > 7) {
	if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Host:", 5)) {
	  packet->host_line.ptr = &ptr[5], packet->host_line.len = len - 5;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Content-Type:", 13)) {
	  packet->content_line.ptr = &ptr[13], packet->content_line.len = len - 13;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Referer:", 8)) {
	  packet->referer_line.ptr = &ptr[8], packet->referer_line.len = len - 8;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "User-Agent:", 11)) {
	  packet->user_agent_line.ptr = &ptr[11], packet->user_agent_line.len = len - 11;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Accept:", 7)) {
	  packet->accept_line.ptr = &ptr[7], packet->accept_line.len = len - 7;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Server:", 7)) {
	  packet->server_line.ptr = &ptr[7], packet->server_line.len = len - 7;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Cookie:", 7)) {
	  packet->http_cookie.ptr = &ptr[7], packet->http_cookie.len = len - 7;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Origin:", 7)) {
	  packet->http_origin.ptr = &ptr[7], packet->http_origin.len = len - 7;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "X-Session-Type:", 15)) {
	  packet->http_x_session_type.ptr = &ptr[15], packet->http_x_session_type.len = len - 15;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Content-Length:", 15)) {
	  packet->http_contentlen.ptr = &ptr[15], packet->http_contentlen.len = len - 15;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Transfer-Encoding:", 18)) {
	  packet->http_transfer_encoding.ptr = &ptr[18], packet->http_transfer_encoding.len = len - 18;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Content-Encoding:", 17)) {
	  packet->http_encoding.ptr = &ptr[17], packet->http_encoding.len = len - 17;
	} else if(ndpi_match_prefix(ptr, len, (const u_int8_t *) "Method:", 7)) {
	  packet->http_method.ptr = &ptr[7], packet->http_method.len = len - 7;
	}
	packet->http_num_headers++;
      }
    }
  }