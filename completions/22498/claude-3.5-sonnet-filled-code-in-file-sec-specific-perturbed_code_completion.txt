for (a = 0; a < end; a++) {
  if(packet->payload[a] == 0x0a) {
    packet->line[packet->parsed_lines].len = (u_int16_t)(
      ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));

    if(a > 0 && packet->payload[a - 1] == 0x0d)
      packet->line[packet->parsed_lines].len--;

    if(packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
      break;

    packet->parsed_lines++;
    packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
    packet->line[packet->parsed_lines].len = 0;

    if((a + 1) >= packet->payload_packet_len)
      break;

    if(packet->parsed_lines == 1) {
      // Check for HTTP response status code
      if(packet->line[0].len >= 12 && memcmp(packet->line[0].ptr, "HTTP/1.", 7) == 0) {
        packet->http_response.ptr = &packet->line[0].ptr[9];
        packet->http_response.len = packet->line[0].len - 9;
      }
    }

    // Check for empty line (end of headers)
    if(packet->line[packet->parsed_lines - 1].len == 0) {
      packet->empty_line_position_set = 1;
      packet->empty_line_position = a;
      
      // Extract body
      if(packet->payload_packet_len > a + 2) {
        packet->http_url_name.ptr = &packet->payload[a + 2];
        packet->http_url_name.len = packet->payload_packet_len - (a + 2);
      }
      
      break;
    }

    // Check for specific headers
    if(packet->line[packet->parsed_lines - 1].len > 6) {
      if(strncasecmp((const char *)packet->line[packet->parsed_lines - 1].ptr, "Host:", 5) == 0) {
        packet->host_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[6];
        packet->host_line.len = packet->line[packet->parsed_lines - 1].len - 6;
      }
      else if(strncasecmp((const char *)packet->line[packet->parsed_lines - 1].ptr, "Content-Type:", 13) == 0) {
        packet->content_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[14];
        packet->content_line.len = packet->line[packet->parsed_lines - 1].len - 14;
      }
      // Add checks for other headers like User-Agent, Referer, etc.
    }
  }
}

packet->http_num_headers = packet->parsed_lines;