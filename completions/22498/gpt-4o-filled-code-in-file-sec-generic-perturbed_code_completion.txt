for (a = 0; a < packet->payload_packet_len; a++) {
    if (packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len =
        (u_int16_t)(((unsigned long)&packet->payload[a]) -
                    ((unsigned long)packet->line[packet->parsed_lines].ptr));

      if (a > 0 && packet->payload[a - 1] == 0x0d)
        packet->line[packet->parsed_lines].len--;

      if (packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
        break;

      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;

      if ((a + 1) >= packet->payload_packet_len)
        break;

      if (packet->empty_line_position_set == 0 && a > 0 &&
          packet->payload[a - 1] == 0x0d && a > 1 &&
          packet->payload[a - 2] == 0x0a && a > 2 &&
          packet->payload[a - 3] == 0x0d) {
        packet->empty_line_position_set = 1;
        if (packet->payload_packet_len - a - 1 > 0) {
          flow->initial_binary_bytes_len =
            (u_int16_t)(packet->payload_packet_len - a - 1);
          memcpy(flow->initial_binary_bytes, &packet->payload[a + 1],
                 flow->initial_binary_bytes_len);
        }
      }
    }
  }

  if (packet->parsed_lines >= 1) {
    packet->line[packet->parsed_lines].len =
      (u_int16_t)(((unsigned long)&packet->payload[packet->payload_packet_len]) -
                  ((unsigned long)packet->line[packet->parsed_lines].ptr));
    packet->parsed_lines++;
  }

  if (packet->parsed_lines > 0) {
    if (packet->line[0].len >= 8 && memcmp(packet->line[0].ptr, "HTTP/1.", 7) == 0) {
      packet->http_response.ptr = packet->line[0].ptr;
      packet->http_response.len = packet->line[0].len;
    } else {
      packet->http_method.ptr = packet->line[0].ptr;
      packet->http_method.len = packet->line[0].len;
    }
  }

  for (a = 1; a < packet->parsed_lines; a++) {
    if (packet->line[a].len >= 7 && memcmp(packet->line[a].ptr, "Server:", 7) == 0) {
      packet->server_line.ptr = packet->line[a].ptr;
      packet->server_line.len = packet->line[a].len;
    } else if (packet->line[a].len >= 6 && memcmp(packet->line[a].ptr, "Host:", 5) == 0) {
      packet->host_line.ptr = packet->line[a].ptr;
      packet->host_line.len = packet->line[a].len;
    } else if (packet->line[a].len >= 14 && memcmp(packet->line[a].ptr, "Content-Type:", 13) == 0) {
      packet->content_line.ptr = packet->line[a].ptr;
      packet->content_line.len = packet->line[a].len;
    } else if (packet->line[a].len >= 8 && memcmp(packet->line[a].ptr, "Referer:", 8) == 0) {
      packet->referer_line.ptr = packet->line[a].ptr;
      packet->referer_line.len = packet->line[a].len;
    } else if (packet->line[a].len >= 12 && memcmp(packet->line[a].ptr, "User-Agent:", 11) == 0) {
      packet->user_agent_line.ptr = packet->line[a].ptr;
      packet->user_agent_line.len = packet->line[a].len;
    } else if (packet->line[a].len >= 8 && memcmp(packet->line[a].ptr, "Accept:", 7) == 0) {
      packet->accept_line.ptr = packet->line[a].ptr;
      packet->accept_line.len = packet->line[a].len;
    } else if (packet->line[a].len >= 5 && memcmp(packet->line[a].ptr, "GET ", 4) == 0) {
      packet->http_url_name.ptr = packet->line[a].ptr;
      packet->http_url_name.len = packet->line[a].len;
    } else if (packet->line[a].len >= 17 && memcmp(packet->line[a].ptr, "Content-Length:", 15) == 0) {
      packet->http_contentlen.ptr = packet->line[a].ptr;
      packet->http_contentlen.len = packet->line[a].len;
    } else if (packet->line[a].len >= 8 && memcmp(packet->line[a].ptr, "Cookie:", 7) == 0) {
      packet->http_cookie.ptr = packet->line[a].ptr;
      packet->http_cookie.len = packet->line[a].len;
    } else if (packet->line[a].len >= 7 && memcmp(packet->line[a].ptr, "Origin:", 7) == 0) {
      packet->http_origin.ptr = packet->line[a].ptr;
      packet->http_origin.len = packet->line[a].len;
    } else if (packet->line[a].len >= 19 && memcmp(packet->line[a].ptr, "X-Session-Type:", 15) == 0) {
      packet->http_x_session_type.ptr = packet->line[a].ptr;
      packet->http_x_session_type.len = packet->line[a].len;
    } else if (packet->line[a].len >= 18 && memcmp(packet->line[a].ptr, "Transfer-Encoding:", 17) == 0) {
      packet->http_transfer_encoding.ptr = packet->line[a].ptr;
      packet->http_transfer_encoding.len = packet->line[a].len;
    } else if (packet->line[a].len >= 9 && memcmp(packet->line[a].ptr, "Encoding:", 9) == 0) {
      packet->http_encoding.ptr = packet->line[a].ptr;
      packet->http_encoding.len = packet->line[a].len;
    }

    if (packet->line[a].len > 0)
      packet->http_num_headers++;
  }