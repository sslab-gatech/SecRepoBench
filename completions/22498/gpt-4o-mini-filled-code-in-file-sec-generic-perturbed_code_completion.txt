while (a < end) {
    if(packet->payload[a] == 0x0d) {
      if(a + 1 < end && packet->payload[a + 1] == 0x0a) {
        packet->line[packet->parsed_lines].len = (u_int16_t)(a - packet->line[packet->parsed_lines].ptr);
        packet->parsed_lines++;
        a += 2; // Skip the \r\n
        if(packet->parsed_lines >= NDPI_MAX_PARSE_LINES_PER_PACKET)
          break;
        packet->line[packet->parsed_lines].ptr = &packet->payload[a];
        packet->line[packet->parsed_lines].len = 0;
      } else {
        a++; // Just skip the \r
      }
    } else if(packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len = (u_int16_t)(a - packet->line[packet->parsed_lines].ptr);
      packet->parsed_lines++;
      a++; // Skip the \n
      if(packet->parsed_lines >= NDPI_MAX_PARSE_LINES_PER_PACKET)
        break;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a];
      packet->line[packet->parsed_lines].len = 0;
    } else {
      a++;
    }
  }