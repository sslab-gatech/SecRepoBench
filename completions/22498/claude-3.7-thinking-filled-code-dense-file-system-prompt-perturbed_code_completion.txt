for(a = 0; a < packet->payload_packet_len; a++) {
  if(packet->payload[a] == 0x0D && a + 1 < packet->payload_packet_len && packet->payload[a + 1] == 0x0A) {
    // Found a line ending "\r\n"
    packet->line[packet->parsed_lines].len = (u_int16_t)(
      ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));
    
    // Check for empty line (i.e., headers ending)
    if(packet->line[packet->parsed_lines].len == 0) {
      packet->empty_line_position_set = 1;
      
      // If we have data after the headers, store it in the data flow's initial binary bytes
      if(a + 2 < packet->payload_packet_len) {
        u_int8_t binary_bytes_to_extract = packet->payload_packet_len - a - 2;
        if(binary_bytes_to_extract > 8) binary_bytes_to_extract = 8;
        memcpy(dataflow->initial_binary_bytes, &packet->payload[a + 2], binary_bytes_to_extract);
        dataflow->initial_binary_bytes_len = binary_bytes_to_extract;
      }
    }
    
    // If this is the first line, check for HTTP response status code
    if(packet->parsed_lines == 0) {
      if(packet->line[0].len >= 12 &&
         memcmp(packet->line[0].ptr, "HTTP/1.", 7) == 0 &&
         packet->line[0].ptr[8] == ' ' &&
         packet->line[0].ptr[9] >= '0' && packet->line[0].ptr[9] <= '9' &&
         packet->line[0].ptr[10] >= '0' && packet->line[0].ptr[10] <= '9' &&
         packet->line[0].ptr[11] >= '0' && packet->line[0].ptr[11] <= '9') {
        packet->http_response.ptr = &packet->line[0].ptr[9];
        packet->http_response.len = 3;
      } else {
        // Check for HTTP method
        char *space_ptr = memchr(packet->line[0].ptr, ' ', packet->line[0].len);
        if(space_ptr != NULL) {
          packet->http_method.ptr = packet->line[0].ptr;
          packet->http_method.len = (u_int16_t)(space_ptr - packet->line[0].ptr);
          
          // Try to parse URL
          if(packet->http_method.len + 1 < packet->line[0].len) {
            char *url_start = &packet->line[0].ptr[packet->http_method.len + 1];
            char *url_end = memchr(url_start, ' ', packet->line[0].len - packet->http_method.len - 1);
            if(url_end != NULL) {
              packet->http_url_name.ptr = url_start;
              packet->http_url_name.len = (u_int16_t)(url_end - url_start);
            }
          }
        }
      }
    }
    
    // Check for specific HTTP headers
    if(packet->parsed_lines > 0 && packet->line[packet->parsed_lines].len > 0) {
      packet->http_num_headers++;
      
      // Server header
      if(packet->line[packet->parsed_lines].len > 8 &&
         memcmp(packet->line[packet->parsed_lines].ptr, "Server:", 7) == 0) {
        packet->server_line.ptr = &packet->line[packet->parsed_lines].ptr[8];
        packet->server_line.len = packet->line[packet->parsed_lines].len - 8;
        while(packet->server_line.len > 0 && 
              (packet->server_line.ptr[0] == ' ' || packet->server_line.ptr[0] == '\t')) {
          packet->server_line.ptr++;
          packet->server_line.len--;
        }
      }
      // Host header
      else if(packet->line[packet->parsed_lines].len > 6 &&
              memcmp(packet->line[packet->parsed_lines].ptr, "Host:", 5) == 0) {
        packet->host_line.ptr = &packet->line[packet->parsed_lines].ptr[6];
        packet->host_line.len = packet->line[packet->parsed_lines].len - 6;
        while(packet->host_line.len > 0 && 
              (packet->host_line.ptr[0] == ' ' || packet->host_line.ptr[0] == '\t')) {
          packet->host_line.ptr++;
          packet->host_line.len--;
        }
      }
      // Content-Type header
      else if(packet->line[packet->parsed_lines].len > 14 &&
              memcmp(packet->line[packet->parsed_lines].ptr, "Content-Type:", 13) == 0) {
        packet->content_line.ptr = &packet->line[packet->parsed_lines].ptr[14];
        packet->content_line.len = packet->line[packet->parsed_lines].len - 14;
        while(packet->content_line.len > 0 && 
              (packet->content_line.ptr[0] == ' ' || packet->content_line.ptr[0] == '\t')) {
          packet->content_line.ptr++;
          packet->content_line.len--;
        }
      }
      // Content-Length header
      else if(packet->line[packet->parsed_lines].len > 16 &&
              memcmp(packet->line[packet->parsed_lines].ptr, "Content-Length:", 15) == 0) {
        packet->http_contentlen.ptr = &packet->line[packet->parsed_lines].ptr[16];
        packet->http_contentlen.len = packet->line[packet->parsed_lines].len - 16;
        while(packet->http_contentlen.len > 0 && 
              (packet->http_contentlen.ptr[0] == ' ' || packet->http_contentlen.ptr[0] == '\t')) {
          packet->http_contentlen.ptr++;
          packet->http_contentlen.len--;
        }
      }
      // User-Agent header
      else if(packet->line[packet->parsed_lines].len > 12 &&
              memcmp(packet->line[packet->parsed_lines].ptr, "User-Agent:", 11) == 0) {
        packet->user_agent_line.ptr = &packet->line[packet->parsed_lines].ptr[12];
        packet->user_agent_line.len = packet->line[packet->parsed_lines].len - 12;
        while(packet->user_agent_line.len > 0 && 
              (packet->user_agent_line.ptr[0] == ' ' || packe