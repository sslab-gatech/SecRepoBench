u_int8_t *ptr = packet->payload;
  u_int8_t *end = packet->payload + packet->payload_packet_len;
  u_int16_t i;

  while(ptr < end) {
    u_int8_t *line_start = ptr;
    u_int8_t *line_end = memchr(ptr, '\r', end - ptr);

    if(line_end == NULL) {
      line_end = end;
    } else {
      line_end++; // Move past '\r'
      if(line_end < end && *line_end == '\n') {
	line_end++; // Move past '\n'
      }
    }

    packet->line[packet->parsed_lines].len = (u_int16_t)(line_end - line_start);
    ptr = line_end;

    if(packet->parsed_lines >= NDPI_MAX_PACKET_LINES - 1) {
      break;
    }

    packet->parsed_lines++;
  }