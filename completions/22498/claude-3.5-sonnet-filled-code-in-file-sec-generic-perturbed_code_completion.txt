for (a = 0; a < end; a++) {
    if(packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len = (u_int16_t)(
        ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));

      if(a > 0 && packet->payload[a - 1] == 0x0d)
        packet->line[packet->parsed_lines].len--;

      if(packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
        break;

      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;

      if((a + 1) >= packet->payload_packet_len)
        break;

      if(packet->parsed_lines == 1 && packet->line[0].len > 6) {
        if(memcmp(packet->line[0].ptr, "HTTP/1.", 7) == 0) {
          packet->http_response.ptr = &packet->line[0].ptr[8];
          packet->http_response.len = packet->line[0].len - 8;
          packet->http_num_headers++;
        }
      }

      if(packet->line[packet->parsed_lines - 1].len == 0) {
        packet->empty_line_position_set = 1;
        packet->empty_line_position = a;
      }

      if(packet->parsed_lines >= 2) {
        if(packet->line[packet->parsed_lines - 1].len > 6 &&
           memcmp(packet->line[packet->parsed_lines - 1].ptr, "Server:", 7) == 0) {
          packet->server_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[8];
          packet->server_line.len = packet->line[packet->parsed_lines - 1].len - 8;
          packet->http_num_headers++;
        } else if(packet->line[packet->parsed_lines - 1].len > 14 &&
                  memcmp(packet->line[packet->parsed_lines - 1].ptr, "Content-Type:", 13) == 0) {
          packet->content_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[14];
          packet->content_line.len = packet->line[packet->parsed_lines - 1].len - 14;
          packet->http_num_headers++;
        } else if(packet->line[packet->parsed_lines - 1].len > 13 &&
                  memcmp(packet->line[packet->parsed_lines - 1].ptr, "Content-type:", 13) == 0) {
          packet->content_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[14];
          packet->content_line.len = packet->line[packet->parsed_lines - 1].len - 14;
          packet->http_num_headers++;
        } else if(packet->line[packet->parsed_lines - 1].len > 5 &&
                  memcmp(packet->line[packet->parsed_lines - 1].ptr, "Host:", 5) == 0) {
          packet->host_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[6];
          packet->host_line.len = packet->line[packet->parsed_lines - 1].len - 6;
          packet->http_num_headers++;
        } else if(packet->line[packet->parsed_lines - 1].len > 7 &&
                  memcmp(packet->line[packet->parsed_lines - 1].ptr, "Accept:", 7) == 0) {
          packet->accept_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[8];
          packet->accept_line.len = packet->line[packet->parsed_lines - 1].len - 8;
          packet->http_num_headers++;
        } else if(packet->line[packet->parsed_lines - 1].len > 11 &&
                  memcmp(packet->line[packet->parsed_lines - 1].ptr, "User-Agent:", 11) == 0) {
          packet->user_agent_line.ptr = &packet->line[packet->parsed_lines - 1].ptr[12];
          packet->user_agent_line.len = packet->line[packet->parsed_lines - 1].len - 12;
          packet->http_num_headers++;
        }
      }
    }
  }