while (a < end) {
    if(packet->payload[a] == 0x0d) {
      if(a + 1 < end && packet->payload[a + 1] == 0x0a) {
	packet->line[packet->parsed_lines].len = (u_int16_t)(a - packet->line[packet->parsed_lines].ptr);
	packet->parsed_lines++;
	packet->line[packet->parsed_lines].ptr = &packet->payload[a + 2];
	packet->line[packet->parsed_lines].len = 0;
	a += 2;
      } else {
	packet->line[packet->parsed_lines].len = (u_int16_t)(a - packet->line[packet->parsed_lines].ptr);
	packet->parsed_lines++;
	packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
	packet->line[packet->parsed_lines].len = 0;
	a++;
      }
    } else if(packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len = (u_int16_t)(a - packet->line[packet->parsed_lines].ptr);
      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;
      a++;
    } else {
      a++;
    }
  }