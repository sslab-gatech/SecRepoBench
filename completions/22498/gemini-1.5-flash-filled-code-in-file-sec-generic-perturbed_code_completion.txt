for (a = 0; a < end; a++) {
    if(packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len = (u_int16_t)(
							   ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));

      if(a > 0 && packet->payload[a - 1] == 0x0d)
	packet->line[packet->parsed_lines].len--;

      if(packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
	break;

      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;

      if((a + 1) >= packet->payload_packet_len)
	break;

      //a++;
    }
  }

  if(packet->parsed_lines >= 1) {
    packet->line[packet->parsed_lines].len =
      (u_int16_t)(((unsigned long) &packet->payload[packet->payload_packet_len]) -
		  ((unsigned long) packet->line[packet->parsed_lines].ptr));
    packet->parsed_lines++;
  }

  if(packet->parsed_lines > 0) {
    u_int16_t i;
    u_int16_t len = packet->line[0].len;
    u_int8_t *ptr = packet->line[0].ptr;

    if(len >= 10) {
      if(strncmp((char *) ptr, "HTTP/", 5) == 0) {
	u_int16_t bytes_read = 0;
	u_int32_t code = ndpi_bytestream_to_number(ptr + 5, len - 5, &bytes_read);

	if(bytes_read > 0) {
	  packet->http_response.ptr = ptr + 5, packet->http_response.len = bytes_read;
	  packet->http_response_status_code = code;
	}
      }
    }

    for (i = 0; i < packet->parsed_lines; i++) {
      u_int16_t line_len = packet->line[i].len;
      u_int8_t *line_ptr = packet->line[i].ptr;

      if(line_len > 7) {
	if(ndpi_match_prefix(line_ptr, line_len, "Server:", 7)) {
	  packet->server_line.ptr = line_ptr + 7, packet->server_line.len = line_len - 7;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "Host:", 5)) {
	  packet->host_line.ptr = line_ptr + 5, packet->host_line.len = line_len - 5;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "Content-Type:", 13)) {
	  packet->content_line.ptr = line_ptr + 13, packet->content_line.len = line_len - 13;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "Referer:", 8)) {
	  packet->referer_line.ptr = line_ptr + 8, packet->referer_line.len = line_len - 8;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "Accept:", 7)) {
	  packet->accept_line.ptr = line_ptr + 7, packet->accept_line.len = line_len - 7;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "User-Agent:", 11)) {
	  packet->user_agent_line.ptr = line_ptr + 11, packet->user_agent_line.len = line_len - 11;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "Cookie:", 7)) {
	  packet->http_cookie.ptr = line_ptr + 7, packet->http_cookie.len = line_len - 7;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "Origin:", 7)) {
	  packet->http_origin.ptr = line_ptr + 7, packet->http_origin.len = line_len - 7;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "X-Session-Type:", 15)) {
	  packet->http_x_session_type.ptr = line_ptr + 15, packet->http_x_session_type.len = line_len - 15;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "HTTP_METHOD:", 12)) {
	  packet->http_method.ptr = line_ptr + 12, packet->http_method.len = line_len - 12;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "HTTP_URL_NAME:", 14)) {
	  packet->http_url_name.ptr = line_ptr + 14, packet->http_url_name.len = line_len - 14;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "HTTP_ENCODING:", 14)) {
	  packet->http_encoding.ptr = line_ptr + 14, packet->http_encoding.len = line_len - 14;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "HTTP_TRANSFER_ENCODING:", 23)) {
	  packet->http_transfer_encoding.ptr = line_ptr + 23,
	    packet->http_transfer_encoding.len = line_len - 23;
	  packet->http_num_headers++;
	} else if(ndpi_match_prefix(line_ptr, line_len, "HTTP_CONTENTLEN:", 16)) {
	  packet->http_contentlen.ptr = line_ptr + 16, packet->http_contentlen.len = line_len - 16;
	  packet->http_num_headers++;
	}
      }
    }
  }