u_int16_t counter = 0;
u_int16_t line_len = 0;
u_int16_t line_pos = 0;
u_int16_t line_count = 0;
u_int16_t empty_line_pos = 0;
u_int16_t http_status_code_pos = 0;
u_int16_t http_status_code_len = 0;
u_int16_t http_server_pos = 0;
u_int16_t http_server_len = 0;
u_int16_t http_host_pos = 0;
u_int16_t http_host_len = 0;
u_int16_t http_content_type_pos = 0;
u_int16_t http_content_type_len = 0;

while (counter < packet->payload_packet_len) {
  if (packet->payload[counter] == '\r' && packet->payload[counter + 1] == '\n') {
    line_len = counter - line_pos;
    packet->line[packet->parsed_lines].len = line_len;
    packet->parsed_lines++;

    if (line_count == 0) {
      // Analyze the first line to detect and process HTTP response status codes
      http_status_code_pos = ndpi_search_http_status_code(packet->payload + line_pos, line_len);
      if (http_status_code_pos!= 0) {
        http_status_code_len = ndpi_get_http_status_code_length(packet->payload + line_pos, line_len);
        packet->http_status_code_pos = http_status_code_pos;
        packet->http_status_code_len = http_status_code_len;
      }
    } else {
      // Identify and extract specific HTTP headers
      http_server_pos = ndpi_search_http_header(packet->payload + line_pos, line_len, "Server:");
      if (http_server_pos!= 0) {
        http_server_len = ndpi_get_http_header_length(packet->payload + line_pos, line_len, "Server:");
        packet->http_server_pos = http_server_pos;
        packet->http_server_len = http_server_len;
      }

      http_host_pos = ndpi_search_http_header(packet->payload + line_pos, line_len, "Host:");
      if (http_host_pos!= 0) {
        http_host_len = ndpi_get_http_header_length(packet->payload + line_pos, line_len, "Host:");
        packet->http_host_pos = http_host_pos;
        packet->http_host_len = http_host_len;
      }

      http_content_type_pos = ndpi_search_http_header(packet->payload + line_pos, line_len, "Content-Type:");
      if (http_content_type_pos!= 0) {
        http_content_type_len = ndpi_get_http_header_length(packet->payload + line_pos, line_len, "Content-Type:");
        packet->http_content_type_pos = http_content_type_pos;
        packet->http_content_type_len = http_content_type_len;
      }
    }

    if (line_len == 0) {
      empty_line_pos = packet->parsed_lines - 1;
      packet->empty_line_pos = empty_line_pos;
    }

    line_pos = counter + 2;
    line_count++;
  }

  counter++;
}

if (packet->parsed_lines >= 1) {
  packet->line[packet->parsed_lines].len =
    (u_int16_t)(((unsigned long) &packet->payload[packet->payload_packet_len]) -
		((unsigned long) packet->line[packet->parsed_lines].ptr));
  packet->parsed_lines++;
}