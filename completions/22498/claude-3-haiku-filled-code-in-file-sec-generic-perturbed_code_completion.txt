while ((elem = strsep(&rule, ",")) != NULL) {
  char *attr = elem, *value = NULL;
  ndpi_port_range range;
  int is_tcp = 0, is_udp = 0, is_ip = 0;

  if(strncmp(attr, "tcp:", 4) == 0)
    is_tcp = 1, value = &attr[4];
  else if(strncmp(attr, "udp:", 4) == 0)
    is_udp = 1, value = &attr[4];
  else if(strncmp(attr, "ip:", 3) == 0)
    is_ip = 1, value = &attr[3];
  else if(strncmp(attr, "host:", 5) == 0) {
    value = &attr[5];
    if(value[0] == '"')
      value++; /* remove leading " */
    if(value[strlen(value) - 1] == '"')
      value[strlen(value) - 1] = '\0'; /* remove trailing " */
  }

  if(is_tcp || is_udp) {
    u_int p_low, p_high;

    if(sscanf(value, "%u-%u", &p_low, &p_high) == 2)
      range.port_low = p_low, range.port_high = p_high;
    else
      range.port_low = range.port_high = atoi(&elem[4]);

    if(do_add)
      addDefaultPort(ndpi_str, &range, def, 1 /* Custom user proto */,
                     is_tcp ? &ndpi_str->tcpRoot : &ndpi_str->udpRoot, __FUNCTION__, __LINE__);
    else
      removeDefaultPort(&range, def, is_tcp ? &ndpi_str->tcpRoot : &ndpi_str->udpRoot);
  } else if(is_ip) {
    ndpi_add_host_ip_subprotocol(ndpi_str, value, subprotocol_id);
  } else {
    if(do_add)
      ndpi_add_host_url_subprotocol(ndpi_str, value, subprotocol_id, NDPI_PROTOCOL_CATEGORY_UNSPECIFIED,
                                    NDPI_PROTOCOL_ACCEPTABLE);
    else
      ndpi_remove_host_url_subprotocol(ndpi_str, value, subprotocol_id);
  }
}