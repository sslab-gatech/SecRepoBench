for (a = 0; a < packet->payload_packet_len; a++) {
    if(packet->payload[a] == '\n') {
      packet->line[packet->parsed_lines].len =
	(u_int16_t)(
		    ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));

      if(a > 0 && packet->payload[a - 1] == '\r')
	packet->line[packet->parsed_lines].len--;

      if(packet->parsed_lines == 0) {
	u_int32_t c, i;

	for (c = 0; c < packet->line[packet->parsed_lines].len; c++) {
	  if(packet->payload[c] == ' ') {
	    packet->http_method.ptr = packet->line[packet->parsed_lines].ptr;
	    packet->http_method.len = c;

	    for (i = c + 1; i < packet->line[packet->parsed_lines].len; i++) {
	      if(packet->payload[i] == ' ') {
		packet->http_url_name.ptr = &packet->payload[c + 1];
		packet->http_url_name.len = i - c - 1;
		break;
	      }
	    }
	    break;
	  }
	}

	if(packet->http_url_name.ptr && packet->http_url_name.len) {
	  if(strncmp((char *) packet->http_url_name.ptr, "HTTP/", 5) == 0) {
	    u_int16_t readbytes = 0;
	    packet->http_response.ptr = &packet->payload[9];
	    packet->http_response.len = 3;
	    dataflow->http.response_status_code =
	      ndpi_bytestream_to_number(packet->http_response.ptr, packet->http_response.len, &readbytes);
	  }
	}
      } else {
	if(packet->line[packet->parsed_lines].len > 5 &&
	   strncmp((char *) packet->line[packet->parsed_lines].ptr, "Host:", 5) == 0) {
	  packet->host_line.ptr = &packet->payload[5];
	  packet->host_line.len = packet->line[packet->parsed_lines].len - 5;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 8 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Referer:", 8) == 0) {
	  packet->referer_line.ptr = &packet->payload[8];
	  packet->referer_line.len = packet->line[packet->parsed_lines].len - 8;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 12 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Content-Type:", 13) == 0) {
	  packet->content_line.ptr = &packet->payload[13];
	  packet->content_line.len = packet->line[packet->parsed_lines].len - 13;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 7 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Accept:", 7) == 0) {
	  packet->accept_line.ptr = &packet->payload[7];
	  packet->accept_line.len = packet->line[packet->parsed_lines].len - 7;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 11 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "User-Agent:", 12) == 0) {
	  packet->user_agent_line.ptr = &packet->payload[12];
	  packet->user_agent_line.len = packet->line[packet->parsed_lines].len - 12;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 14 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Content-Length:", 15) == 0) {
	  packet->http_contentlen.ptr = &packet->payload[15];
	  packet->http_contentlen.len = packet->line[packet->parsed_lines].len - 15;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 15 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Transfer-Encoding:", 18) == 0) {
	  packet->http_transfer_encoding.ptr = &packet->payload[18];
	  packet->http_transfer_encoding.len = packet->line[packet->parsed_lines].len - 18;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 10 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Content-Encoding:", 17) == 0) {
	  packet->http_encoding.ptr = &packet->payload[17];
	  packet->http_encoding.len = packet->line[packet->parsed_lines].len - 17;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 7 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Cookie:", 7) == 0) {
	  packet->http_cookie.ptr = &packet->payload[7];
	  packet->http_cookie.len = packet->line[packet->parsed_lines].len - 7;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 7 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Origin:", 7) == 0) {
	  packet->http_origin.ptr = &packet->payload[7];
	  packet->http_origin.len = packet->line[packet->parsed_lines].len - 7;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 16 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "X-Session-Type:", 16) == 0) {
	  packet->http_x_session_type.ptr = &packet->payload[16];
	  packet->http_x_session_type.len = packet->line[packet->parsed_lines].len - 16;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 7 &&
		  strncmp((char *) packet->line[packet->parsed_lines].ptr, "Server:", 7) == 0) {
	  packet->server_line.ptr = &packet->payload[7];
	  packet->server_line.len = packet->line[packet->parsed_lines].len - 7;
	  packet->http_num_headers++;
	}
      }

      if(packet->line[packet->parsed_lines].len == 0) {
	if(packet->empty_line_position_set == 0) {
	  packet->empty_line_position = a + 1;
	  packet->empty_line_position_set = 1;
	}

	if(packet->payload_packet_len > packet->empty_line_position + 4 &&
	   packet->payload[packet->empty_line_position] == '\r' &&
	   packet->payload[packet->empty_line_position + 1] == '\n' &&
	   packet->payload[packet->empty_line_position + 2] == '\r' &&
	   packet->payload[packet->empty_line_position + 3] == '\n') {
	  if(dataflow->initial_data_len < sizeof(dataflow->initial_data)) {
	    u_int16_t len_to_copy =
	      ndpi_min((u_int16_t)(packet->payload_packet_len - (packet->empty_line_position + 4)),
		       (u_int16_t)(sizeof(dataflow->initial_data) - dataflow->initial_data_len));

	    memcpy(dataflow->initial_data + dataflow->initial_data_len,
		   packet->payload + packet->empty_line_position + 4, len_to_copy);
	    dataflow->initial_data_len += len_to_copy;
	  }
	  break;
	}
      }

      if(packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
	break;

      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;

      if((a + 1) >= packet->payload_packet_len)
	break;

      //a++;
    }
  }