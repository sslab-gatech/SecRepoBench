for (a = 0; a < packet->payload_packet_len; a++) {
    if(packet->payload[a] == 0x0a) {
      packet->line[packet->parsed_lines].len = (u_int16_t)(
							   ((unsigned long) &packet->payload[a]) - ((unsigned long) packet->line[packet->parsed_lines].ptr));

      if(a > 0 && packet->payload[a - 1] == 0x0d)
	packet->line[packet->parsed_lines].len--;

      if(packet->parsed_lines == 0) {
	if(packet->line[packet->parsed_lines].len > 5 &&
	   strncmp((char *) packet->line[packet->parsed_lines].ptr, "HTTP/", 5) == 0) {
	  u_int16_t counter = 0;
	  packet->http_response.ptr = &packet->payload[5];
	  packet->http_response.len = 0;
	  while (packet->payload_packet_len > (5 + counter) && packet->payload[5 + counter] != 0x20 &&
		 packet->payload[5 + counter] != 0x0d && packet->payload[5 + counter] != 0x0a && counter < 16) {
	    counter++;
	    packet->http_response.len++;
	  }
	} else if(packet->line[packet->parsed_lines].len > 4 &&
		  (strncmp((char *) packet->line[packet->parsed_lines].ptr, "GET ", 4) == 0 ||
		   strncmp((char *) packet->line[packet->parsed_lines].ptr, "POST", 4) == 0 ||
		   strncmp((char *) packet->line[packet->parsed_lines].ptr, "HEAD", 4) == 0 ||
		   strncmp((char *) packet->line[packet->parsed_lines].ptr, "PUT ", 4) == 0 ||
		   strncmp((char *) packet->line[packet->parsed_lines].ptr, "OPTIONS", 7) == 0 ||
                   strncmp((char *) packet->line[packet->parsed_lines].ptr, "TRACE", 5) == 0 ||
                   strncmp((char *) packet->line[packet->parsed_lines].ptr, "PATCH", 5) == 0 ||
		   strncmp((char *) packet->line[packet->parsed_lines].ptr, "DELETE", 6) == 0 ||
		   strncmp((char *) packet->line[packet->parsed_lines].ptr, "CONNECT", 7) == 0)) {
	  packet->http_method.ptr = packet->line[packet->parsed_lines].ptr;
	  packet->http_method.len = packet->line[packet->parsed_lines].len;
	}
      } else {
	if(packet->line[packet->parsed_lines].len > 6 &&
	   strncasecmp((char *) packet->line[packet->parsed_lines].ptr, "Host:", 5) == 0) {
	  packet->host_line.ptr = &packet->payload[a + 1 + 5 /* skip Host: */];
	  packet->host_line.len = 0;
	  while (packet->payload_packet_len > a + 1 + 5 + packet->host_line.len &&
		 packet->payload[a + 1 + 5 + packet->host_line.len] != 0x0d &&
		 packet->payload[a + 1 + 5 + packet->host_line.len] != 0x0a)
	    packet->host_line.len++;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 8 &&
		  strncasecmp((char *) packet->line[packet->parsed_lines].ptr, "Server:", 7) == 0) {
	  packet->server_line.ptr = &packet->payload[a + 1 + 7 /* skip Server: */];
	  packet->server_line.len = 0;
	  while (packet->payload_packet_len > a + 1 + 7 + packet->server_line.len &&
		 packet->payload[a + 1 + 7 + packet->server_line.len] != 0x0d &&
		 packet->payload[a + 1 + 7 + packet->server_line.len] != 0x0a)
	    packet->server_line.len++;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 12 &&
		  strncasecmp((char *) packet->line[packet->parsed_lines].ptr, "User-Agent:", 11) == 0) {
	  packet->user_agent_line.ptr = &packet->payload[a + 1 + 11 /* skip User-Agent: */];
	  packet->user_agent_line.len = 0;
	  while (packet->payload_packet_len > a + 1 + 11 + packet->user_agent_line.len &&
		 packet->payload[a + 1 + 11 + packet->user_agent_line.len] != 0x0d &&
		 packet->payload[a + 1 + 11 + packet->user_agent_line.len] != 0x0a)
	    packet->user_agent_line.len++;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 14 &&
		  strncasecmp((char *) packet->line[packet->parsed_lines].ptr, "Content-Type:", 13) == 0) {
	  packet->content_line.ptr = &packet->payload[a + 1 + 13 /* skip Content-Type: */];
	  packet->content_line.len = 0;
	  while (packet->payload_packet_len > a + 1 + 13 + packet->content_line.len &&
		 packet->payload[a + 1 + 13 + packet->content_line.len] != 0x0d &&
		 packet->payload[a + 1 + 13 + packet->content_line.len] != 0x0a)
	    packet->content_line.len++;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 9 &&
		  strncasecmp((char *) packet->line[packet->parsed_lines].ptr, "Referer:", 8) == 0) {
	  packet->referer_line.ptr = &packet->payload[a + 1 + 8 /* skip Referer: */];
	  packet->referer_line.len = 0;
	  while (packet->payload_packet_len > a + 1 + 8 + packet->referer_line.len &&
		 packet->payload[a + 1 + 8 + packet->referer_line.len] != 0x0d &&
		 packet->payload[a + 1 + 8 + packet->referer_line.len] != 0x0a)
	    packet->referer_line.len++;
	  packet->http_num_headers++;
	} else if(packet->line[packet->parsed_lines].len > 8 &&
		  strncasecmp((char *) packet->line[packet->parsed_lines].ptr, "Accept:", 7) == 0) {
	  packet->accept_line.ptr = &packet->payload[a + 1 + 7 /* skip Accept: */];
	  packet->accept_line.len = 0;
	  while (packet->payload_packet_len > a + 1 + 7 + packet->accept_line.len &&
		 packet->payload[a + 1 + 7 + packet->accept_line.len] != 0x0d &&
		 packet->payload[a + 1 + 7 + packet->accept_line.len] != 0x0a)
	    packet->accept_line.len++;
	  packet->http_num_headers++;
	}
      }

      if(packet->parsed_lines >= 1) {
	if(packet->line[packet->parsed_lines - 1].len == 0) {
	  if(packet->empty_line_position_set == 0) {
	    packet->empty_line_position_set = 1;
	    packet->empty_line_position = a + 1;

	    if(packet->payload_packet_len > packet->empty_line_position + 4) {
	      if(dataflow->initial_data_len < sizeof(dataflow->initial_data)) {
		u_int to_copy = ndpi_min((u_int)packet->payload_packet_len - packet->empty_line_position,
				       (u_int)sizeof(dataflow->initial_data) - dataflow->initial_data_len);
                if (to_copy > 0 && dataflow->initial_data_len + to_copy <= sizeof(dataflow->initial_data)) {
                  memcpy(dataflow->initial_data + dataflow->initial_data_len,
                         packet->payload + packet->empty_line_position, to_copy);
                  dataflow->initial_data_len += to_copy;
                }
	      }
	    }
	  }
	}
      }

      if(packet->parsed_lines >= (NDPI_MAX_PARSE_LINES_PER_PACKET - 1))
	break;

      packet->parsed_lines++;
      packet->line[packet->parsed_lines].ptr = &packet->payload[a + 1];
      packet->line[packet->parsed_lines].len = 0;

      if((a + 1) >= packet->payload_packet_len)
	break;

      //a++;
    }
  }