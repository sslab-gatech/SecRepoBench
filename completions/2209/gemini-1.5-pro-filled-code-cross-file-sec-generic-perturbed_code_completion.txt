HEVCFrame *ref;

    if (list->nb_refs >= MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference overflow\n");
        return AVERROR_INVALIDDATA;
    }

    ref = find_ref_idx(s, pictureordercount);
    if (!ref) {
        ref = generate_missing_ref(s, pictureordercount); // Generate missing reference if not found
        if (!ref)
            return AVERROR(ENOMEM);
    }

    if (ref->poc == pictureordercount) {
         for (int i = 0; i < list->nb_refs; i++) {
             if (list->list[i] == pictureordercount) {
                 av_log(s->avctx, AV_LOG_WARNING, "Duplicate POC in reference list, ignoring.\n");
                 return AVERROR_INVALIDDATA; // Or different error code as appropriate
             }
         }
    }