HEVCFrame *ref = find_ref_idx(s, pictureordercount);
if (!ref) {
    if (s->nal_unit_type != HEVC_NAL_CRA_NUT && !IS_BLA(s)) {
        // Attempt to generate a missing reference frame
        ref = generate_missing_ref(s, pictureordercount);
        if (!ref) {
            av_log(s->avctx, AV_LOG_ERROR, "Failed to generate missing reference frame with POC %d\n", pictureordercount);
            return AVERROR_INVALIDDATA;
        }
    } else {
        return AVERROR(ENOENT);
    }
}

if (list->nb_refs >= MAX_REFS) {
    av_log(s->avctx, AV_LOG_ERROR, "Too many references in the list\n");
    return AVERROR(EINVAL);
}

for (int i = 0; i < list->nb_refs; i++) {
    if (list->list[i] == ref->poc) {
        av_log(s->avctx, AV_LOG_WARNING, "Duplicate reference frame with POC %d\n", ref->poc);
        return AVERROR(EINVAL);
    }
}