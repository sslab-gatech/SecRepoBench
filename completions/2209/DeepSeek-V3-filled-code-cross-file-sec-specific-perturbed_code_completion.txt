HEVCFrame *ref = find_ref_idx(s, pictureordercount);
    if (!ref) {
        if (s->nal_unit_type != HEVC_NAL_CRA_NUT && !IS_BLA(s)) {
            av_log(s->avctx, AV_LOG_ERROR, "Could not find ref with POC %d\n", pictureordercount);
            return AVERROR_INVALIDDATA;
        }
        return 0;
    }

    if (list->nb_refs >= HEVC_MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference list overflow\n");
        return AVERROR_INVALIDDATA;
    }

    for (int i = 0; i < list->nb_refs; i++) {
        if (list->list[i] == ref->poc) {
            av_log(s->avctx, AV_LOG_WARNING, "Duplicate reference POC %d\n", ref->poc);
            return AVERROR_INVALIDDATA;
        }
    }