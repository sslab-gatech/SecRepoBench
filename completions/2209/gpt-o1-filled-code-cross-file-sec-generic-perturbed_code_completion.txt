int i;
    HEVCFrame *ref = find_ref_idx(s, pictureordercount);
    if (ref) {
        // Check for duplicate reference
        for (i = 0; i < list->nb_refs; i++) {
            if (list->ref[i] == ref) {
                av_log(s->avctx, AV_LOG_ERROR,
                       "Attempted to add a duplicate reference with POC %d\n",
                       pictureordercount);
                return AVERROR_INVALIDDATA;
            }
        }
    } else {
        // Attempt to create a missing reference for the POC
        ref = ff_hevc_get_missing_ref(s, pictureordercount);
        if (!ref) {
            av_log(s->avctx, AV_LOG_ERROR,
                   "Failed to create missing reference with POC %d\n",
                   pictureordercount);
            return AVERROR_INVALIDDATA;
        }
    }

    // Prevent overflow in the reference list
    if (list->nb_refs >= FF_ARRAY_ELEMS(list->ref)) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference list overflow\n");
        return AVERROR_INVALIDDATA;
    }