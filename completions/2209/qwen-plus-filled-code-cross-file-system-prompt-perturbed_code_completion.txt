HEVCFrame *ref = find_ref_idx(s, pictureordercount);

if (!ref) {
    if (s->nal_unit_type != HEVC_NAL_CRA_NUT && !IS_BLA(s)) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference picture missing during decoding\n");
        return AVERROR_INVALIDDATA;
    }
    // Generate missing reference frame if necessary
    ref = generate_missing_ref(s, pictureordercount);
    if (!ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Failed to generate missing reference frame\n");
        return AVERROR_INVALIDDATA;
    }
}

// Check for duplicate or overflow condition
for (int i = 0; i < list->nb_refs; i++) {
    if (list->ref[i] == ref) {
        av_log(s->avctx, AV_LOG_WARNING, "Duplicate reference found; skipping addition\n");
        return AVERROR(EINVAL); // Return an error code for duplicate reference
    }
}