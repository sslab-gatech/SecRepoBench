int ref_idx = -1;
HEVCFrame *ref = find_ref_idx(s, pictureordercount);
if (ref) {
    // Check if the reference frame is already in the list
    for (int i = 0; i < list->nb_refs; i++) {
        if (list->ref[i] == ref) {
            return AVERROR(EINVAL);
        }
    }
    ref_idx = list->nb_refs;
} else {
    // Generate a missing reference frame
    ref = generate_missing_reference(s, pictureordercount);
    if (!ref) {
        return AVERROR_INVALIDDATA;
    }
    ref_idx = list->nb_refs;
}