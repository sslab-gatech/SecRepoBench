HEVCFrame *ref;

    if (list->nb_refs >= MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference overflow (nb_refs >= MAX_REFS)\n");
        return AVERROR_INVALIDDATA;
    }

    ref = find_ref_idx(s, pictureordercount);

    if (!ref) {
        ref = generate_missing_ref(s, pictureordercount);
        if (!ref)
            return -1;
    }

    if (ref->poc == pictureordercount) {
        for (int i = 0; i < list->nb_refs; i++) {
            if (list->list[i] == pictureordercount) {
                av_log(s->avctx, AV_LOG_WARNING, "duplicate POC in reference list\n");
                return AVERROR_INVALIDDATA;
            }
        }
    }