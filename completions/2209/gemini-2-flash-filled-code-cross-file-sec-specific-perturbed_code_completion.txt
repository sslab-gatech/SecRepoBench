HEVCFrame *ref = find_ref_idx(s, pictureordercount);

    if (!ref) {
        ref = ff_hevc_get_unused_frame(s);
        if (!ref) {
            av_log(s->avctx, AV_LOG_ERROR, "No free frame to add ref\n");
            return AVERROR(ENOMEM);
        }
        ref->poc      = pictureordercount;
        ref->long_term = 1;
        ref->used_for_reference = 1;
        ref->frame->reference = 3;
        ref->sequence = s->seq_decode;
    } else if (list->nb_refs > 0 && list->ref[list->nb_refs - 1] == ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Trying to add a duplicate ref\n");
        return -1;
    }

    if (list->nb_refs >= MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Too many refs %d\n", list->nb_refs);
        return -1;
    }