HEVCFrame *ref = find_ref_idx(s, pictureordercount);

    if (!ref) {
        ref = ff_hevc_get_unused_frame(s);
        if (!ref) {
            av_log(s->avctx, AV_LOG_ERROR, "No free frame to generate missing reference %d.\n", pictureordercount);
            return AVERROR(ENOMEM);
        }
        ref->poc      = pictureordercount;
        ref->long_term= 0;
        ref->used_for_reference = 1;
        ref->frame->reference = 3;
        ref->sequence = s->seq_decode;
        av_frame_unref(ref->frame);
        av_frame_ref(ref->frame, s->cur_pic.f);
    } else if (list->nb_refs > 0 && list->ref[list->nb_refs - 1] == ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Trying to add a duplicate ref %d.\n", pictureordercount);
        return -1;
    } else if (list->nb_refs >= MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Too many refs %d.\n", pictureordercount);
        return -1;
    }