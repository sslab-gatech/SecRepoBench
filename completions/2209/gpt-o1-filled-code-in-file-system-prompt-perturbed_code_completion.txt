HEVCFrame *ref = find_ref_idx(s, pictureordercount);
    if (!ref) {
        ref = generate_missing_ref(s, pictureordercount);
        if (!ref) {
            av_log(s->avctx, AV_LOG_ERROR, "Missing reference generation for POC %d failed.\n", pictureordercount);
            return AVERROR(ENOMEM);
        }
    }

    if (ref == s->ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Attempting to reference the current frame (POC %d).\n", pictureordercount);
        return AVERROR_INVALIDDATA;
    }

    if (list->nb_refs >= HEVC_MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference list overflow.\n");
        return AVERROR_INVALIDDATA;
    }