HEVCFrame *ref = find_ref_idx(s, pictureordercount);
    if (ref == s->ref) // Don't add the current frame to the reference list
        return AVERROR_INVALIDDATA;

    if (!ref) {
        if (s->nal_unit_type != HEVC_NAL_IDR_W_RADL &&
            s->nal_unit_type != HEVC_NAL_IDR_N_LP   &&
            s->nal_unit_type != HEVC_NAL_CRA_NUT) {
            av_log(s->avctx, AV_LOG_WARNING, "Missing reference picture, POC %d\n",
                   pictureordercount);

            ref = generate_missing_ref(s, pictureordercount);
            if (!ref)
                return AVERROR(ENOMEM);
        } else
            return AVERROR_INVALIDDATA;
    }