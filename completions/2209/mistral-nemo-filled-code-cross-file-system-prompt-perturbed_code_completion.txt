HEVCFrame *ref = find_ref_idx(s, pictureordercount);
if (ref && ref->poc == list->list[list->nb_refs - 1]) {
    av_log(s->avctx, AV_LOG_ERROR, "Duplicate reference frame found\n");
    return AVERROR_INVALIDDATA;
}

if (!ref) {
    ref = generate_missing_ref(s, pictureordercount);
    if (!ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Failed to generate missing reference frame\n");
        return AVERROR(ENOMEM);
    }
}

list->list[list->nb_refs] = ref->poc;
list->ref[list->nb_refs]  = ref;
list->nb_refs++;