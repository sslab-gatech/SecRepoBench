if (chromaticity != (float *) NULL)
          {
            image->chromaticity.red_primary.x=chromaticity[0];
            image->chromaticity.red_primary.y=chromaticity[1];
            image->chromaticity.green_primary.x=chromaticity[2];
            image->chromaticity.green_primary.y=chromaticity[3];
            image->chromaticity.blue_primary.x=chromaticity[4];
            image->chromaticity.blue_primary.y=chromaticity[5];
          }
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_YRESOLUTION,&y_resolution) == 1)
      image->resolution.y=y_resolution;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_XRESOLUTION,&hor_res) == 1)
      image->resolution.x=hor_res;
    // </MASK>
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SAMPLESPERPIXEL,&samples_per_pixel) != 1)
      samples_per_pixel=1;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PLANARCONFIG,&interlace) != 1)
      interlace=PLANARCONFIG_CONTIG;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_COMPRESSION,&compress_tag) != 1)
      compress_tag=COMPRESSION_NONE;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_ORIENTATION,&orientation) != 1)
      orientation=ORIENTATION_UNDEFINED;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_RESOLUTIONUNIT,&units) != 1)
      units=RESUNIT_INCH;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_XRESOLUTION,&hor_res) != 1)
      hor_res=72.0;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_YRESOLUTION,&y_resolution) != 1)
      y_resolution=72.0;
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SOFTWARE,&text) == 1)
      (void) SetImageProperty(image,"tiff:software",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_ARTIST,&text) == 1)
      (void) SetImageProperty(image,"tiff:artist",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_COPYRIGHT,&text) == 1)
      (void) SetImageProperty(image,"tiff:copyright",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_DATETIME,&text) == 1)
      (void) SetImageProperty(image,"tiff:timestamp",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_DOCUMENTNAME,&text) == 1)
      (void) SetImageProperty(image,"tiff:document",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_HOSTCOMPUTER,&text) == 1)
      (void) SetImageProperty(image,"tiff:hostcomputer",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_IMAGEDESCRIPTION,&text) == 1)
      (void) SetImageProperty(image,"comment",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_MAKE,&text) == 1)
      (void) SetImageProperty(image,"tiff:make",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_MODEL,&text) == 1)
      (void) SetImageProperty(image,"tiff:model",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_OPIIMAGEID,&count,&text) == 1)
      {
        if (count >= MagickPathExtent)
          count=MagickPathExtent-1;
        (void) CopyMagickString(message,text,count+1);
        (void) SetImageProperty(image,"tiff:image-id",message,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PAGENAME,&text) == 1)
      (void) SetImageProperty(image,"label",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SOFTWARE,&text) == 1)
      (void) SetImageProperty(image,"tiff:software",text,exception);
    if (TIFFGetFieldDefaulted(tiff,33423,&count,&text) == 1)
      {
        if (count >= MagickPathExtent)
          count=MagickPathExtent-1;
        (void) CopyMagickString(message,text,count+1);
        (void) SetImageProperty(image,"tiff:kodak-33423",message,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,36867,&count,&text) == 1)
      {
        if (count >= MagickPathExtent)
          count=MagickPathExtent-1;
        (void) CopyMagickString(message,text,count+1);
        (void) SetImageProperty(image,"tiff:kodak-36867",message,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&type) == 1)
      switch (type)
      {
        case 0x01:
        {
          (void) SetImageProperty(image,"tiff:subfiletype","REDUCEDIMAGE",
            exception);
          break;
        }
        case 0x02:
        {
          (void) SetImageProperty(image,"tiff:subfiletype","PAGE",exception);
          break;
        }
        case 0x04:
        {
          (void) SetImageProperty(image,"tiff:subfiletype","MASK",exception);
          break;
        }
        default:
          break;
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBIFD,&value) == 1)
      {
        for (i=0; i < (ssize_t) value; i++)
        {
          if (TIFFReadDirectory(tiff) == 0)
            {
              TIFFClose(tiff);
              ThrowReaderException(CorruptImageError,"ImproperImageHeader");
            }
          AcquireNextImage(image_info,image,exception);
          if (GetNextImageInList(image) == (Image *) NULL)
            {
              TIFFClose(tiff);
              ThrowReaderException(CorruptImageError,"ImproperImageHeader");
            }
          image=SyncNextImageInList(image);
        }
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_EXIFIFD,&offset) == 1)
      TIFFGetEXIFProperties(tiff,image,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_RICHTIFFIPTC,&offset) == 1)
      {
        if (TIFFIsByteSwapped(tiff) != 0)
          TIFFSwabArrayOfLong((uint32 *) profile,(size_t) length);
        (void) ReadProfile(image,"iptc",profile,(ssize_t) length,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_XMLPACKET,&length,&profile) == 1)
      {
        StringInfo
          *dng;

        (void) ReadProfile(image,"xmp",profile,(ssize_t) length,exception);
        dng=BlobToStringInfo(profile,length);
        if (dng != (StringInfo *) NULL)
        {
          const char
            *target = "dc:format=\"image/dng\"";

          if (strstr((char *) GetStringInfoDatum(dng),target) != (char *) NULL)
            (void) CopyMagickString(image->magick,"DNG",MagickPathExtent);
          dng=DestroyStringInfo(dng);
        }
      }
    if (TIFFGetFieldDefaulted(tiff,34118,&length,&profile) == 1)
      (void) ReadProfile(image,"tiff:34118",profile,(ssize_t) length,exception);
    if (TIFFGetFieldDefaulted(tiff,37724,&length,&profile) == 1)
      (void) ReadProfile(image,"tiff:37724",profile,(ssize_t) length,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PHOTOSHOP,&length,&profile) == 1)
      (void) ReadProfile(image,"8bim",profile,(ssize_t) length,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_ICCPROFILE,&length,&profile) == 1)
      (void) ReadProfile(image,"icc",profile,(ssize_t) length,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_TRANSFERFUNCTION,&length,&profile) == 1)
      (void) ReadProfile(image,"tiff:34851",profile,(ssize_t) length,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SOFTWARE,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:software",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_ARTIST,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:artist",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_COPYRIGHT,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:copyright",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_DATETIME,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:timestamp",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_DOCUMENTNAME,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:document",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_HOSTCOMPUTER,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:hostcomputer",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_IMAGEDESCRIPTION,NULL,&text) == 1)
      (void) SetImageProperty(image,"comment",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_MAKE,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:make",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_MODEL,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:model",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_OPIIMAGEID,NULL,&text) == 1)
      {
        if (count >= MagickPathExtent)
          count=MagickPathExtent-1;
        (void) CopyMagickString(message,text,count+1);
        (void) SetImageProperty(image,"tiff:image-id",message,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_PAGENAME,NULL,&text) == 1)
      (void) SetImageProperty(image,"label",text,exception);
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SOFTWARE,NULL,&text) == 1)
      (void) SetImageProperty(image,"tiff:software",text,exception);
    if (TIFFGetFieldDefaulted(tiff,33423,NULL,&text) == 1)
      {
        if (count >= MagickPathExtent)
          count=MagickPathExtent-1;
        (void) CopyMagickString(message,text,count+1);
        (void) SetImageProperty(image,"tiff:kodak-33423",message,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,36867,NULL,&text) == 1)
      {
        if (count >= MagickPathExtent)
          count=MagickPathExtent-1;
        (void) CopyMagickString(message,text,count+1);
        (void) SetImageProperty(image,"tiff:kodak-36867",message,exception);
      }
    if (TIFFGetFieldDefaulted(tiff,TIFFTAG_SUBFILETYPE,&type) == 1)
      switch (type)
      {
        case 0x01:
        {
          (void) SetImageProperty(image,"tiff:subfiletype","REDUCEDIMAGE",
            exception);
          break;
        }
        case 0x02:
        {
          (void) SetImageProperty(image,"tiff:subfiletype