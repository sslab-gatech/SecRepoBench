{
  /* Ensure there's enough data to safely read the length field at offset 4. */
  if(flow_packet->payload_packet_len >= 6) {
    u_int16_t msg_len;
    /* Safely read the 2-byte length field in network byte order. */
    msg_len = ntohs(*(u_int16_t *)&flow_packet->payload[4]);

    /*
      Add an offset depending on the first byte of the payload:
      - If the first byte is 0x00, use one offset.
      - If the first byte is 0x01, use a different offset.
      Compare the resulting total length to the actual payload size.
    */
    {
      u_int16_t total_len = (flow_packet->payload[0] == 0x0) ? (msg_len + 8) : (msg_len + 6);
      if(total_len == flow_packet->payload_packet_len) {
        goto capwap_found;
      }
    }
  }
}