{
  u_int16_t msg_len;
  
  // Ensure payload length is sufficient to avoid buffer overflows
  if (flow_packet->payload_packet_len < 8) {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  // Calculate message length based on the first byte of the payload
  if (flow_packet->payload[0] == 0x0) {
    if (flow_packet->payload_packet_len < 10) { // Ensure enough bytes for msg_len
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[8]) + 8;
  } else if (flow_packet->payload[0] == 0x1) {
    if (flow_packet->payload_packet_len < 12) { // Ensure enough bytes for msg_len
      NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
      return;
    }
    msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[10]) + 12;
  } else {
    NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
    return;
  }

  // Check if the calculated message length matches the actual payload length
  if (msg_len == flow_packet->payload_packet_len) {
    goto capwap_found;
  }
}