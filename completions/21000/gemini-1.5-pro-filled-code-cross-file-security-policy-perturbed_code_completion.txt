{
      u_int16_t msg_len = 0;

      if (flow_packet->payload_packet_len < 2) {
        NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
        return;
      }

      if(flow_packet->payload[0] == 0x0) {
        if (flow_packet->payload_packet_len < 4) {
          NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
          return;
        }
        msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[2]);
      } else if (flow_packet->payload[0] == 0x1) {
        if (flow_packet->payload_packet_len < 8) {
          NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
          return;
        }
        msg_len = ntohl(*(u_int32_t*)&flow_packet->payload[4]);
      }

      if (flow_packet->payload[0] == 0x0) {
          if((msg_len + 4) == flow_packet->payload_packet_len)
              goto capwap_found;
      } else if (flow_packet->payload[0] == 0x1) {
          if((msg_len + 8) == flow_packet->payload_packet_len)
              goto capwap_found;
      }
}