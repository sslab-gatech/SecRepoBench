u_int16_t msg_len = 0;
    u_int16_t total_len = 0;
    u_int16_t offset = 0;

    if (flow_packet->payload[0] == 0x0) {
        offset = 16;
        if (flow_packet->payload[8] == 1) {
            msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[13]);
            total_len = msg_len + 15;
        } else if (flow_packet->payload[8] == 6) {
            msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[13]);
            total_len = msg_len + 15;
        } else if (flow_packet->payload[8] == 4) {
            msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[13]);
            total_len = msg_len + 15;
        }
    } else if (flow_packet->payload[0] == 0x1) {
        offset = 16;
        if (flow_packet->payload[8] == 1) {
            msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[13]);
            total_len = msg_len + 15;
        } else if (flow_packet->payload[8] == 6) {
            msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[13]);
            total_len = msg_len + 15;
        } else if (flow_packet->payload[8] == 4) {
            msg_len = ntohs(*(u_int16_t*)&flow_packet->payload[13]);
            total_len = msg_len + 15;
        }
    }

    if (total_len == flow_packet->payload_packet_len) {
        ndpi_int_capwap_add_connection(ndpi_struct, flow);
    }