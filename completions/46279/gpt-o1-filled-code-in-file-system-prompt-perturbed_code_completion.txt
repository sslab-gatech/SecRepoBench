static int
run_filters(struct archive_read *archivereadptr)
{
  struct rar *rar = (struct rar *)(archivereadptr->format->data);
  struct rar_filters *filters = &rar->filters;
  struct rar_filter *filter = filters->stack;
  int64_t start, tend;
  size_t end, lastfilteraddress, lastfilterlength;
  int ret;

  /* If there are no filters in the stack, there's nothing to do. */
  if (!filter)
    return 1;

  /* The filter should start after current LZSS position. */
  start = lzss_position(&rar->lzss);
  tend = (int64_t)filter->blockstartpos;
  if (tend < 0)
    return 0;

  end = (size_t)tend;
  if (end != (size_t)(start + filter->blocklength))
    return 0;

  /* Invalidate further usage of filterstart until we process new filters. */
  filters->filterstart = INT64_MAX;

  /*
   * Expand the data up to this filter's start. We only need to ensure the LZSS
   * position is at least 'end'.
   */
  ret = expand(archivereadptr, &tend);
  if (ret != ARCHIVE_OK)
    return 0;

  /* Ensure VM is allocated. */
  if (!filters->vm) {
    filters->vm = calloc(1, sizeof(*filters->vm));
    if (!filters->vm)
      return 0;
  }

  /* Copy filter-block data from LZSS window into VM memory. */
  ret = copy_from_lzss_window(archivereadptr, filters->vm->memory, start,
                              filter->blocklength);
  if (ret != ARCHIVE_OK)
    return 0;

  /* Execute filter. */
  if (!execute_filter(archivereadptr, filter, filters->vm, rar->offset))
    return 0;

  /* Remember the transformed data region. */
  lastfilteraddress = filter->filteredblockaddress;
  lastfilterlength = filter->filteredblocklength;

  /* Remove this filter from the stack. */
  filters->stack = filter->next;
  filter->next = NULL;
  delete_filter(filter);

  /*
   * Some filters may immediately follow if they transform the same block.
   * For each subsequent filter with the same start and length, re-apply
   * VM at the already-transformed region.
   */
  while ((filter = filters->stack) != NULL &&
         (int64_t)filter->blockstartpos == (int64_t)end &&
         filter->blocklength == lastfilterlength) {
    memmove(&filters->vm->memory[0],
            &filters->vm->memory[lastfilteraddress],
            lastfilterlength);
    if (!execute_filter(archivereadptr, filter, filters->vm, rar->offset))
      return 0;
    lastfilteraddress = filter->filteredblockaddress;
    lastfilterlength = filter->filteredblocklength;
    filters->stack = filter->next;
    filter->next = NULL;
    delete_filter(filter);
  }

  /*
   * If there are still pending filters in the stack, record their start
   * position for further use.
   */
  if (filters->stack) {
    /* If the next filter starts before our just-finished region, it's invalid. */
    if ((int64_t)filters->stack->blockstartpos < (int64_t)end)
      return 0;
    filters->filterstart = (int64_t)filters->stack->blockstartpos;
  }

  /* Provide the newly filtered bytes. */
  filters->lastend = (int64_t)end;
  filters->bytes = &filters->vm->memory[lastfilteraddress];
  filters->bytes_ready = lastfilterlength;

  return 1;
}