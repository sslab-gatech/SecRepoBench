OperatorE topOpr;

if (pfx->usedOprStack <= 0) {
  (void) ThrowMagickException (
    pfx->exception, GetMagickModule(), OptionError,
    "Unexpected ternary operator", "at '%s'",
    SetShortExp(pfx));
  return MagickFalse;
}

topOpr = pfx->OperatorStack[pfx->usedOprStack - 1];

if (topOpr == oQuery) {
  if (ternary.addrQuery != NULL_ADDRESS || ternary.addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException (
      pfx->exception, GetMagickModule(), OptionError,
      "Nested or inconsistent query in ternary expression", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  pfx->usedOprStack--;
  ternary.addrQuery = pfx->usedElements;
  (void) AddAddressingElement(pfx, rCondExec, NULL_ADDRESS);
} else if (topOpr == oColon) {
  if (ternary.addrQuery == NULL_ADDRESS || ternary.addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException (
      pfx->exception, GetMagickModule(), OptionError,
      "Missing query or nested colon in ternary expression", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  pfx->usedOprStack--;
  ternary.addrColon = pfx->usedElements;
  ElementT * pel = &pfx->Elements[pfx->usedElements-1];
  pel->DoPush = MagickTrue;
  (void) AddAddressingElement(pfx, rCtrlFlow, NULL_ADDRESS);
} else {
  (void) ThrowMagickException (
    pfx->exception, GetMagickModule(), OptionError,
    "Invalid operator for ternary operation", "at '%s'",
    SetShortExp(pfx));
  return MagickFalse;
}