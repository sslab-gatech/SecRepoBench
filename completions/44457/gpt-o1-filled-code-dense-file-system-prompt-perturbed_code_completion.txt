OperatorE op;
  if (fxinfo->usedOprStack < 1)
  {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "ProcessTernaryOpr", "Operator stack underflow");
    return MagickFalse;
  }

  op = fxinfo->OperatorStack[fxinfo->usedOprStack - 1];

  if (op == oQMark)
  {
    if ((ptern->queryAddr >= 0) || (ptern->colonAddr >= 0))
    {
      (void) ThrowMagickException(
        fxinfo->exception, GetMagickModule(), OptionError,
        "ProcessTernaryOpr", "Inconsistent ternary: '?' or ':' already set");
      return MagickFalse;
    }

    /* Pop the '?' operator */
    fxinfo->usedOprStack--;

    /* Record position for the query part of the ternary */
    ptern->queryAddr = fxinfo->usedElements;

    /* Add the addressing element for the query */
    if ((fxinfo->usedElements + 1) > fxinfo->numElements)
      if (!ExtendRPN(fxinfo))
        return MagickFalse;

    fxinfo->Elements[fxinfo->usedElements].opcode = eTernaryQuestion;
    fxinfo->Elements[fxinfo->usedElements].value.valueu = 0UL;
    fxinfo->usedElements++;
  }
  else if (op == oColon)
  {
    if ((ptern->queryAddr < 0) || (ptern->colonAddr >= 0))
    {
      (void) ThrowMagickException(
        fxinfo->exception, GetMagickModule(), OptionError,
        "ProcessTernaryOpr", "Inconsistent ternary: missing '?' or ':' already set");
      return MagickFalse;
    }

    /* Pop the ':' operator */
    fxinfo->usedOprStack--;

    /* Record position for the colon part of the ternary */
    ptern->colonAddr = fxinfo->usedElements;

    /* Mark this position and add addressing element for control flow */
    if ((fxinfo->usedElements + 1) > fxinfo->numElements)
      if (!ExtendRPN(fxinfo))
        return MagickFalse;

    fxinfo->Elements[fxinfo->usedElements].opcode = eTernaryColon;
    fxinfo->Elements[fxinfo->usedElements].value.valueu = 0UL;
    fxinfo->usedElements++;
  }
  else
  {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "ProcessTernaryOpr", "Invalid operator for ternary");
    return MagickFalse;
  }