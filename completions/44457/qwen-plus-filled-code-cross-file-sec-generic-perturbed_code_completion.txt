OperatorE topOpr;

if (pfx->usedOprStack <= 0) {
  (void) ThrowMagickException (
    fxinfo->exception, GetMagickModule(), OptionError,
    "Unexpected ternary operator", "at '%s'",
    SetShortExp(fxinfo));
  return MagickFalse;
}

topOpr = fxinfo->OperatorStack[pfx->usedOprStack - 1];

if (topOpr == oQuery) {
  if (ptern->addrQuery != NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException (
      fxinfo->exception, GetMagickModule(), OptionError,
      "Invalid ternary structure: Unexpected query operator", "at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }
  pfx->usedOprStack--;
  ptern->addrQuery = pfx->usedElements;
  (void) AddAddressingElement(pfx, rCondJump, NULL_ADDRESS);
} else if (topOpr == oColon) {
  if (ptern->addrQuery == NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException (
      fxinfo->exception, GetMagickModule(), OptionError,
      "Invalid ternary structure: Missing preceding query operator", "at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }
  pfx->usedOprStack--;
  ptern->addrColon = pfx->usedElements;
  (void) AddAddressingElement(pfx, rPushResult, NULL_ADDRESS);
  (void) AddAddressingElement(pfx, rJump, NULL_ADDRESS);
  if (ptern->addrQuery != NULL_ADDRESS) {
    pfx->Elements[ptern->addrQuery].EleNdx = pfx->usedElements;
  }
} else {
  (void) ThrowMagickException (
    fxinfo->exception, GetMagickModule(), OptionError,
    "Unexpected operator in ternary processing", "at '%s'",
    SetShortExp(fxinfo));
  return MagickFalse;
}