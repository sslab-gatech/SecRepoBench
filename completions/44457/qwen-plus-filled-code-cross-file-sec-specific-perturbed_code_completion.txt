if (fxinfo->usedOprStack <= 0)
{
  (void) ThrowMagickException (
    fxinfo->exception, GetMagickModule(), OptionError,
    "Operator stack underflow", "at '%s'",
    SetShortExp(fxinfo));
  return MagickFalse;
}

OperatorE topOperator = fxinfo->OperatorStack[fxinfo->usedOprStack - 1];

if (topOperator == oQuery)
{
  if (ptern->addrQuery != NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS)
  {
    (void) ThrowMagickException (
      fxinfo->exception, GetMagickModule(), OptionError,
      "Invalid ternary structure", "Multiple queries at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }

  fxinfo->usedOprStack--;
  ptern->addrQuery = fxinfo->usedElements;
  (void) AddAddressingElement(fxinfo, rCondExec, NULL_ADDRESS);
}
else if (topOperator == oColon)
{
  if (ptern->addrQuery == NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS)
  {
    (void) ThrowMagickException (
      fxinfo->exception, GetMagickModule(), OptionError,
      "Invalid ternary structure", "Missing query or multiple colons at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }

  fxinfo->usedOprStack--;
  ptern->addrColon = fxinfo->usedElements;
  (void) AddAddressingElement(fxinfo, rPushResult, NULL_ADDRESS);
  (void) AddAddressingElement(fxinfo, rCtrlFlow, NULL_ADDRESS);
}
else
{
  // Not a ternary operator, no action needed.
}