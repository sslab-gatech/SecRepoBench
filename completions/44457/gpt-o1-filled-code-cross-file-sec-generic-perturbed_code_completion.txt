if (fxinfo->usedOprStack > 0)
  {
    OperatorE op = fxinfo->OperatorStack[fxinfo->usedOprStack - 1];
    if (op == oQuery)
    {
      /* If the operator is '?', ensure we haven't already set a query or colon. */
      if ((ptern->addrQuery != NULL_ADDRESS) || (ptern->addrColon != NULL_ADDRESS))
      {
        (void) ThrowMagickException(
          fxinfo->exception, GetMagickModule(), OptionError,
          "Ternary operator error",
          "Unexpected '?' encountered.",
          "%s", ""
        );
        return MagickFalse;
      }
      fxinfo->usedOprStack--;
      ptern->addrQuery = fxinfo->usedElements;
      /* Add an addressing element for conditional jump if query expression is false. */
      (void) AddAddressingElement(fxinfo, rGotoIfFalse, NULL_ADDRESS);
    }
    else if (op == oColon)
    {
      /* If the operator is ':', ensure we have a preceding '?' and no existing colon. */
      if (ptern->addrQuery == NULL_ADDRESS)
      {
        (void) ThrowMagickException(
          fxinfo->exception, GetMagickModule(), OptionError,
          "Ternary operator error",
          "':' without matching '?'.",
          "%s", ""
        );
        return MagickFalse;
      }
      if (ptern->addrColon != NULL_ADDRESS)
      {
        (void) ThrowMagickException(
          fxinfo->exception, GetMagickModule(), OptionError,
          "Ternary operator error",
          "Multiple ':' encountered for a single '?'.",
          "%s", ""
        );
        return MagickFalse;
      }
      fxinfo->usedOprStack--;
      ptern->addrColon = fxinfo->usedElements;
      /* Mark this element to push a result and add an unconditional jump past the else-branch. */
      if (fxinfo->usedElements > 0)
        fxinfo->Elements[fxinfo->usedElements - 1].DoPush = MagickTrue;
      (void) AddAddressingElement(fxinfo, rGoto, NULL_ADDRESS);
    }
  }