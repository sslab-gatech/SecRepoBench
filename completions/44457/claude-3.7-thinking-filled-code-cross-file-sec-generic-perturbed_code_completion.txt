OperatorE topOpr;

/* If the operator stack is empty, there's nothing to process */
if (fxinfo->usedOprStack == 0) 
  return MagickTrue;
  
/* Get the top operator from the stack */
topOpr = fxinfo->OperatorStack[fxinfo->usedOprStack - 1];

if (topOpr == oQuery) {
  /* Process query operator '?' */
  if (ptern->addrQuery != NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "Nested ternary operator", "at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }
  
  fxinfo->usedOprStack--;  /* Pop the operator stack */
  ptern->addrQuery = fxinfo->usedElements;
  (void) AddAddressingElement(fxinfo, rIfZeroGoto, NULL_ADDRESS);
  
} else if (topOpr == oColon) {
  /* Process colon operator ':' */
  if (ptern->addrQuery == NULL_ADDRESS) {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "Colon without preceding query", "at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }
  
  if (ptern->addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "Multiple colons in ternary operator", "at '%s'",
      SetShortExp(fxinfo));
    return MagickFalse;
  }
  
  fxinfo->usedOprStack--;  /* Pop the operator stack */
  ptern->addrColon = fxinfo->usedElements;
  
  /* Mark the previous element to push a result */
  ElementT *pel = &fxinfo->Elements[fxinfo->usedElements - 1];
  pel->DoPush = MagickTrue;
  
  (void) AddAddressingElement(fxinfo, rGoto, NULL_ADDRESS);
}