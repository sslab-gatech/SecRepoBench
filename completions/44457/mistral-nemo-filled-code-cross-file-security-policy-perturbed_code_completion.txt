if (pfx->usedOprStack == 0) {
    (void) ThrowMagickException(
      pfx->exception, GetMagickModule(), OptionError,
      "Operator stack is empty", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }

  OperatorE topOperator = pfx->OperatorStack[pfx->usedOprStack - 1];
  if (topOperator == oQuery) {
    if (ternary.addrQuery != NULL_ADDRESS) {
      (void) ThrowMagickException(
        pfx->exception, GetMagickModule(), OptionError,
        "Query already set", "at '%s'",
        SetShortExp(pfx));
      return MagickFalse;
    }
    if (ternary.addrColon != NULL_ADDRESS) {
      (void) ThrowMagickException(
        pfx->exception, GetMagickModule(), OptionError,
        "Colon set without query", "at '%s'",
        SetShortExp(pfx));
      return MagickFalse;
    }
    pfx->usedOprStack--;
    ternary.addrQuery = pfx->usedElements - 1;
    (void) AddAddressingElement(pfx, rCondExec, ternary.addrQuery);
  } else if (topOperator == oColon) {
    if (ternary.addrQuery == NULL_ADDRESS) {
      (void) ThrowMagickException(
        pfx->exception, GetMagickModule(), OptionError,
        "Colon without query", "at '%s'",
        SetShortExp(pfx));
      return MagickFalse;
    }
    if (ternary.addrColon != NULL_ADDRESS) {
      (void) ThrowMagickException(
        pfx->exception, GetMagickModule(), OptionError,
        "Colon already set", "at '%s'",
        SetShortExp(pfx));
      return MagickFalse;
    }
    pfx->usedOprStack--;
    ternary.addrColon = pfx->usedElements - 1;
    (void) AddAddressingElement(pfx, rPushResult, ternary.addrColon);
    (void) AddAddressingElement(pfx, rControlFlow, ternary.addrColon);
  } else {
    (void) ThrowMagickException(
      pfx->exception, GetMagickModule(), OptionError,
      "Invalid operator for ternary expression", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }

  return MagickTrue;
}