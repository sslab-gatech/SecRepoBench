if (pfx->usedOprStack && (pfx->OperatorStack[pfx->usedOprStack-1] == oQuery ||
    pfx->OperatorStack[pfx->usedOprStack-1] == oColon)) {
  OperatorE op = pfx->OperatorStack[pfx->usedOprStack-1];

  if (op == oQuery) {
    if (ptern->addrQuery != NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
      (void) ThrowMagickException (
        pfx->exception, GetMagickModule(), OptionError,
        "Nested ternary operators not permitted", "'%s' at '%s'",
        pfx->token, SetShortExp(pfx));
      return MagickFalse;
    }
    pfx->usedOprStack--;
    ptern->addrQuery = pfx->usedElements;
    (void) AddAddressingElement (pfx, rIfZeroGoto, NULL_ADDRESS); /* address will be addrColon+1 */
    pfx->Elements[pfx->usedElements-1].DoPush = MagickTrue; /* we may need return from if() */
  } else if (op == oColon) {
    if (ptern->addrQuery == NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
      (void) ThrowMagickException (
        pfx->exception, GetMagickModule(), OptionError,
        "Ternary operator mis-match", "'%s' at '%s'",
        pfx->token, SetShortExp(pfx));
      return MagickFalse;
    }
    pfx->usedOprStack--;
    ptern->addrColon = pfx->usedElements;
    pfx->Elements[pfx->usedElements-1].DoPush = MagickTrue; /* we may need return from if() */
    (void) AddAddressingElement (pfx, rGoto, NULL_ADDRESS); /* address will be usedElements */
  }
}