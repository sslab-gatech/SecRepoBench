if (fxinfo->OperatorStack[fxinfo->usedOprStack-1] == oQuery) {
  // Ensure there is no existing query or colon set in the ternary structure
  if (ptern->query >= 0 || ptern->colon >= 0) {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "Nested ternary operators not supported", "%s", "");
    return MagickFalse;
  }
  
  // Pop the operator stack and set the query address to the current element index
  fxinfo->usedOprStack--;
  ptern->query = fxinfo->usedElements;
  
  // Add an addressing element for conditional execution based on the query result
  if (fxinfo->usedElements >= fxinfo->numElements) {
    if (!ExtendRPN(fxinfo)) return MagickFalse;
  }
  
  fxinfo->Elements[fxinfo->usedElements].element = eJumpZero;
  fxinfo->Elements[fxinfo->usedElements].j = -1; // Will be updated when we see the colon
  fxinfo->usedElements++;
} 
else if (fxinfo->OperatorStack[fxinfo->usedOprStack-1] == oColon) {
  // Ensure there is a preceding query in the ternary structure and no existing colon set
  if (ptern->query < 0 || ptern->colon >= 0) {
    (void) ThrowMagickException(
      fxinfo->exception, GetMagickModule(), OptionError,
      "Unmatched ':' in ternary operator", "%s", "");
    return MagickFalse;
  }
  
  // Pop the operator stack and set the colon address to the current element index
  fxinfo->usedOprStack--;
  ptern->colon = fxinfo->usedElements;
  
  // Update the query's jump address to point to the next element after the true branch
  fxinfo->Elements[ptern->query].j = fxinfo->usedElements + 1;
  
  // Add an addressing element for control flow
  if (fxinfo->usedElements >= fxinfo->numElements) {
    if (!ExtendRPN(fxinfo)) return MagickFalse;
  }
  
  fxinfo->Elements[fxinfo->usedElements].element = eJump;
  fxinfo->Elements[fxinfo->usedElements].j = -1; // Will be updated later
  fxinfo->usedElements++;
} else {
  // If the operator is neither '?' nor ':', we have an unexpected operator
  (void) ThrowMagickException(
    fxinfo->exception, GetMagickModule(), OptionError,
    "Unexpected operator in ternary processing", "%s", "");
  return MagickFalse;
}