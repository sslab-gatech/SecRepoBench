if (pfx->usedOprStack <= 0) {
    (void) ThrowMagickException(
        pfx->exception, GetMagickModule(), OptionError,
        "Operator stack is empty", "Cannot process ternary operator");
    return MagickFalse;
}

OperatorE topOperator = pfx->OperatorStack[pfx->usedOprStack - 1];

if (topOperator == oQuery) {
    if (ptern->addrQuery != NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
        (void) ThrowMagickException(
            pfx->exception, GetMagickModule(), OptionError,
            "Inconsistent ternary structure: multiple queries or colons", 
            "at '%s'", SetShortExp(pfx));
        return MagickFalse;
    }
    ptern->addrQuery = pfx->usedElements; // Set the query address
    pfx->usedOprStack--; // Pop the operator stack
    (void) AddAddressingElement(pfx, rConditional, ptern->addrQuery);
} else if (topOperator == oColon) {
    if (ptern->addrQuery == NULL_ADDRESS || ptern->addrColon != NULL_ADDRESS) {
        (void) ThrowMagickException(
            pfx->exception, GetMagickModule(), OptionError,
            "Inconsistent ternary structure: missing query or multiple colons", 
            "at '%s'", SetShortExp(pfx));
        return MagickFalse;
    }
    ptern->addrColon = pfx->usedElements; // Set the colon address
    pfx->usedOprStack--; // Pop the operator stack
    (void) AddAddressingElement(pfx, rResult, ptern->addrColon);
} else {
    (void) ThrowMagickException(
        pfx->exception, GetMagickModule(), OptionError,
        "Expected '?' or ':' operator", "at '%s'", SetShortExp(pfx));
    return MagickFalse;
}