if (!pfx->usedOprStack) {
  if (!ExtendOperatorStack(pfx)) {
    return MagickFalse;
  }
}

OperatorE op = pfx->OperatorStack[pfx->usedOprStack-1];
if (op == oQuestion) {
  if (ternary.addrQuery != NULL_ADDRESS) {
    (void) ThrowMagickException(
      pfx->exception, GetMagickModule(), OptionError,
      "Ternary operator already has a query", "'%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  pfx->usedOprStack--;
  ternary.addrQuery = pfx->usedElements;
  (void) AddAddressingElement(pfx, rConditional, NULL_ADDRESS);
} else if (op == oColon) {
  if (ternary.addrQuery == NULL_ADDRESS) {
    (void) ThrowMagickException(
      pfx->exception, GetMagickModule(), OptionError,
      "Ternary operator has no preceding query", "'%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  if (ternary.addrColon != NULL_ADDRESS) {
    (void) ThrowMagickException(
      pfx->exception, GetMagickModule(), OptionError,
      "Ternary operator already has a colon", "'%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  pfx->usedOprStack--;
  ternary.addrColon = pfx->usedElements;
  (void) AddAddressingElement(pfx, rJump, NULL_ADDRESS);
  pfx->Elements[ternary.addrQuery].EleNdx = pfx->usedElements - 1;
} else {
  (void) ThrowMagickException(
    pfx->exception, GetMagickModule(), OptionError,
    "Expected '?' or ':' in ternary operator", "'%s'",
    SetShortExp(pfx));
  return MagickFalse;
}