if (pfx->usedOprStack) {
    OperatorE op = pfx->OperatorStack[pfx->usedOprStack-1];
    if (op == oQuery) {
      if (ptern->addrQuery != NULL_ADDRESS) {
        (void) ThrowMagickException (
          fxinfo->exception, GetMagickModule(), OptionError,
          "Two '?' in ternary expression", "'%s' at '%s'",
          fxinfo->token, SetShortExp(fxinfo));
        return MagickFalse;
      }
      if (ptern->addrColon != NULL_ADDRESS) {
        (void) ThrowMagickException (
          fxinfo->exception, GetMagickModule(), OptionError,
          "':' before '?' in ternary expression", "'%s' at '%s'",
          fxinfo->token, SetShortExp(fxinfo));
        return MagickFalse;
      }
      fxinfo->usedOprStack--;
      ptern->addrQuery = fxinfo->usedElements;
      (void) AddAddressingElement (fxinfo, rIfZeroGoto, NULL_ADDRESS); /* address will be addrColon + 1 */
      fxinfo->Elements[fxinfo->usedElements-1].DoPush = MagickTrue; /* we may need return from if() */

    } else if (op == oColon) {
      if (ptern->addrQuery == NULL_ADDRESS) {
        (void) ThrowMagickException (
          fxinfo->exception, GetMagickModule(), OptionError,
          "':' with no '?' in ternary expression", "'%s' at '%s'",
          fxinfo->token, SetShortExp(fxinfo));
        return MagickFalse;
      }
      if (ptern->addrColon != NULL_ADDRESS) {
        (void) ThrowMagickException (
          fxinfo->exception, GetMagickModule(), OptionError,
          "Two ':' in ternary expression", "'%s' at '%s'",
          fxinfo->token, SetShortExp(fxinfo));
        return MagickFalse;
      }
      fxinfo->usedOprStack--;
      ptern->addrColon = fxinfo->usedElements;
      fxinfo->Elements[fxinfo->usedElements-1].DoPush = MagickTrue; /* we may need return from if() */
      (void) AddAddressingElement (fxinfo, rGoto, NULL_ADDRESS); /* address will be usedElements */
    }
  }