if (pfx->usedOprStack == 0) {
  (void) ThrowMagickException (
    pfx->exception, GetMagickModule(), OptionError,
    "Empty operator stack", "at '%s'",
    SetShortExp(pfx));
  return MagickFalse;
}

OperatorE op = pfx->OperatorStack[pfx->usedOprStack-1];

if (op == oQuery) {
  if (ptern->addrQuery!= NULL_ADDRESS) {
    (void) ThrowMagickException (
      pfx->exception, GetMagickModule(), OptionError,
      "Duplicate ternary query operator", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  if (ptern->addrColon!= NULL_ADDRESS) {
    (void) ThrowMagickException (
      pfx->exception, GetMagickModule(), OptionError,
      "Ternary colon operator before query operator", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  ptern->addrQuery = pfx->usedElements;
  pfx->usedOprStack--;
  (void) AddAddressingElement (pfx, rCondJmp, NULL_ADDRESS);
} else if (op == oColon) {
  if (ptern->addrQuery == NULL_ADDRESS) {
    (void) ThrowMagickException (
      pfx->exception, GetMagickModule(), OptionError,
      "Ternary colon operator without query operator", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  if (ptern->addrColon!= NULL_ADDRESS) {
    (void) ThrowMagickException (
      pfx->exception, GetMagickModule(), OptionError,
      "Duplicate ternary colon operator", "at '%s'",
      SetShortExp(pfx));
    return MagickFalse;
  }
  ptern->addrColon = pfx->usedElements;
  pfx->usedOprStack--;
  (void) AddAddressingElement (pfx, rJmp, NULL_ADDRESS);
  pfx->Elements[pfx->usedElements-1].DoPush = MagickTrue;
} else {
  (void) ThrowMagickException (
    pfx->exception, GetMagickModule(), OptionError,
    "Invalid ternary operator", "at '%s'",
    SetShortExp(pfx));
  return MagickFalse;
}