face = faceptr;

const hb_face_t::table_info_t *head_info = face->table.head;
if (unlikely (!head_info || !head_info->data))
{
  num_glyphs = 0;
  return;
}

const OT::head &head = *reinterpret_cast<const OT::head *> (head_info->data);
if (unlikely (head.indexToLocFormat > 1 || head.glyphDataFormat != 0))
{
  num_glyphs = 0;
  return;
}

short_offset = 0 == head.indexToLocFormat;

hb_sanitize_context_t sanitizer;
sanitizer.set_num_glyphs (face->get_num_glyphs ());
sanitizer.set_max_ops (HB_SANITIZE_MAX_OPS_DEFAULT);

loca_table = sanitizer.reference_table<OT::loca> (face, HB_OT_TAG_loca);
glyf_table = sanitizer.reference_table<OT::glyf> (face, HB_OT_TAG_glyf);

num_glyphs = loca_table.get_length () / (short_offset ? 2 : 4) - 1;