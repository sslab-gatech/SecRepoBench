face = faceptr;
hb_blob_t *head_blob = hb_face_reference_table(face, HB_TAG('h','e','a','d'));
const HeadTable *head_table = (const HeadTable *) hb_blob_get_data(head_blob, nullptr);

if (head_table->version_major != 1 || head_table->version_minor != 0) {
    hb_blob_destroy(head_blob);
    return;
}

short_offset = head_table->index_to_loc_format ? 0 : 1;
hb_blob_destroy(head_blob);

hb_sanitize_context_t sanitizer;
sanitizer.set_num_glyphs(hb_face_get_glyph_count(face));
sanitizer.set_max_ops(HB_SANITIZE_MAX_OPS_DEFAULT);

loca_table = sanitizer.reference_table<LocaTable>(face, HB_TAG('l','o','c','a'));
glyf_table = sanitizer.reference_table<GlyfTable>(face, HB_TAG('g','l','y','f'));

num_glyphs = (loca_table->get_length() / (short_offset ? 2 : 4)) - 1;