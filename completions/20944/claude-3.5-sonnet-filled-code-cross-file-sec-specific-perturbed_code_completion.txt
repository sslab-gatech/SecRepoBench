face = faceptr;
short_offset = 0;
num_glyphs = 0;
loca_table = nullptr;
glyf_table = nullptr;

const OT::head &head = *face->table.head;
if (head.indexToLocFormat > 1 || head.glyphDataFormat != 0)
  return;

short_offset = 2 - head.indexToLocFormat;

hb_blob_t *loca_blob = face->reference_table (HB_OT_TAG_loca);
loca_table = hb_sanitize_context_t ().reference_table<OT::loca> (face, HB_OT_TAG_loca);
hb_blob_destroy (loca_blob);

if (unlikely (!loca_table))
  return;

num_glyphs = (loca_table->get_length () >> short_offset) - 1;

hb_blob_t *glyf_blob = face->reference_table (HB_OT_TAG_glyf);
glyf_table = hb_sanitize_context_t ().reference_table<OT::glyf> (face, HB_OT_TAG_glyf);
hb_blob_destroy (glyf_blob);

if (unlikely (!glyf_table))
{
  loca_table.destroy ();
  loca_table = nullptr;
  return;
}