// Calculate num_glyphs using the length of the loca_table, adjusting for offset format.
      hb_face_t *face = faceptr;
      hb_blob_t *head_blob = hb_face_reference_table(face, HB_TAG('h', 'e', 'a', 'd'));
      if (!head_blob) {
        hb_face_destroy(face);
        return;
      }

      hb_ot_head_table_t head_table;
      if (hb_blob_get_length(head_blob) < sizeof(head_table)) {
        hb_blob_destroy(head_blob);
        hb_face_destroy(face);
        return;
      }

      hb_blob_get_data(head_blob, &head_table, sizeof(head_table));
      hb_blob_destroy(head_blob);

      if (head_table.indexToLocFormat != 0 && head_table.indexToLocFormat != 1) {
        hb_face_destroy(face);
        return;
      }

      hb_blob_t *loca_blob = hb_face_reference_table(face, HB_TAG('l', 'o', 'c', 'a'));
      if (!loca_blob) {
        hb_face_destroy(face);
        return;
      }

      hb_ot_index_map_t loca_table;
      if (hb_blob_get_length(loca_blob) < sizeof(loca_table)) {
        hb_blob_destroy(loca_blob);
        hb_face_destroy(face);
        return;
      }

      hb_blob_get_data(loca_blob, &loca_table, sizeof(loca_table));
      hb_blob_destroy(loca_blob);

      hb_blob_t *glyf_blob = hb_face_reference_table(face, HB_TAG('g', 'l', 'y', 'f'));
      if (!glyf_blob) {
        hb_face_destroy(face);
        return;
      }

      num_glyphs = (head_table.indexToLocFormat == 0) ? (loca_table.length - sizeof(loca_table)) / 2 : (loca_table.length - sizeof(loca_table)) / 4;

      short_offset = head_table.shortOffset;
      this->face = face;
      this->loca_table = &loca_table;
      this->glyf_table = glyf_blob;