face = faceptr;

      short_offset = face->table.head->indexToLocFormat;

      hb_sanitize_context_t c (face);
      loca_table = c.reference_table<loca> ();
      glyf_table = c.reference_table<glyf> ();

      if (unlikely (!loca_table->dataZ.arrayZ || !glyf_table->dataZ.arrayZ))
        return;

      unsigned int loca_len = loca_table->dataZ.length;
      unsigned int glyf_len = glyf_table->dataZ.length;

      if (unlikely (!loca_len || loca_len > glyf_len * 2 + 2)) // + 2 is to allow for short loca last entry.
        return;

      num_glyphs = loca_len / (short_offset ? 2 : 4) - 1;
      if (unlikely (!num_glyphs || num_glyphs >= 0xFFFFu))
        return;

      /* Check the last loca entry. */
      if (short_offset)
      {
        const HBUINT16 *offsets = (const HBUINT16 *) loca_table->dataZ.arrayZ;
        if (unlikely (offsets[num_glyphs] > glyf_len))
          return;
      }
      else
      {
        const HBUINT32 *offsets = (const HBUINT32 *) loca_table->dataZ.arrayZ;
        if (unlikely (offsets[num_glyphs] > glyf_len))
          return;
      }