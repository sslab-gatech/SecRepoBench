face = faceptr;

      unsigned int upem = hb_face_get_upem (face);
      scale_factor = (double) upem / (double) hb_face_get_upem (face);

      hb_blob_t *hb_blob = hb_face_reference_table (face, HB_TAG ('head'));
      const hb_head_table_t *head = hb_head_table_parse (hb_blob);
      hb_blob_destroy (hb_blob);

      if (unlikely (!head))
        return;

      indexToLocFormat = head->indexToLocFormat;

      if (unlikely (head->indexToLocFormat > 1))
      {
        hb_blob_destroy (hb_blob);
        return;
      }

      short_offset = head->indexToLocFormat == 0;

      hb_blob = hb_sanitize_context_t ().reference_table<loca_table_t> (face);
      loca_table = hb_blob_get_data (hb_blob, nullptr);
      hb_blob_destroy (hb_blob);

      hb_blob = hb_sanitize_context_t ().reference_table<glyf_table_t> (face);
      glyf_table = hb_blob_get_data (hb_blob, nullptr);
      hb_blob_destroy (hb_blob);


      num_glyphs = hb_face_get_glyph_count (faceptr);
      if (unlikely (!loca_table || !glyf_table || !num_glyphs))
        return;

      if (short_offset)
        num_glyphs = (be16_t*)loca_table)[num_glyphs] / 2;