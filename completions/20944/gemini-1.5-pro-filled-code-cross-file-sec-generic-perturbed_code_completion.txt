face = faceptr;

      unsigned int upem = hb_face_get_upem (face);
      if (!upem)
        return;

      hb_blob_t *hb_blob = hb_face_reference_blob (face);
      const char *hb_data = hb_blob_get_data (hb_blob, NULL);

      hb_tag_t head_tag = HB_TAG('h','e','a','d');
      hb_table_t *head_table = hb_sanitize_context_t().reference_table<hb_table_t>(hb_blob, head_tag);

      const tt_head_table_t *head = (const tt_head_table_t *) hb_table_get_data (head_table, &hb_sanitize_context_t());

      if (head->version.major != 1 || (head->version.minor != 0 && head->version.minor != 1) ||
          head->magicNumber != 0x5F0F3CF5 || head->checkSumAdjustment == 0)
      {
        head_table->destroy ();
        hb_blob_destroy (hb_blob);
        return;
      }

      short_offset = head->indexToLocFormat == 0;

      hb_tag_t loca_tag = HB_TAG('l','o','c','a');
      loca_table = hb_sanitize_context_t().reference_table<loca_table_t>(hb_blob, loca_tag);

      hb_tag_t glyf_tag = HB_TAG('g','l','y','f');
      glyf_table = hb_sanitize_context_t().reference_table<glyf_table_t>(hb_blob, glyf_tag);

      unsigned int loca_len;
      hb_blob_get_data (loca_table, &loca_len);
      num_glyphs = loca_len / (short_offset ? 2 : 4) - 1;

      head_table->destroy ();
      hb_blob_destroy (hb_blob);