unsigned int loca_entry_size = short_offset ? 2 : 4;
unsigned int loca_length = hb_blob_get_length(loca_table);
num_glyphs = (loca_length / loca_entry_size) - 1;

unsigned int last_glyph_offset = 0;
hb_bool_t success = HB_FALSE;
if (short_offset)
{
  last_glyph_offset = hb_blob_get_uint16(loca_table, num_glyphs * 2, &success);
  if (!success)
    return;
  /* In short format, offsets are stored divided by 2 */
  last_glyph_offset *= 2;
}
else
{
  last_glyph_offset = hb_blob_get_uint32(loca_table, num_glyphs * 4, &success);
  if (!success)
    return;
}

if (hb_blob_get_length(glyf_table) < last_glyph_offset)
{
  /* The glyf table is too short compared to the loca offsets.
     Invalidate it so that no further processing takes place. */
  glyf_table.destroy();
}