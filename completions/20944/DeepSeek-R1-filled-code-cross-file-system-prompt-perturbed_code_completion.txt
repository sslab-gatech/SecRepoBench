face = hb_face_reference (faceptr);

hb_blob_t *head_blob = face->reference_table (HB_OT_TAG_head);
const Head *head_table = head_blob->as<Head> ();
if (head_table->indexToLocFormat > 1)
{
    head_blob->destroy ();
    return;
}
short_offset = head_table->indexToLocFormat == 0;
head_blob->destroy ();

hb_sanitize_context_t c = face->get_sanitize_context ();
loca_table = c.reference_table<loca> (face);
glyf_table = c.reference_table<glyf> (face);

num_glyphs = loca_table.get_length () / (short_offset ? 2 : 4) - 1;
if (num_glyphs == 0)
{
    loca_table.destroy ();
    glyf_table.destroy ();
    hb_face_destroy (face);
    return;
}