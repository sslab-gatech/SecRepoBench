// Process auxiliary tags
while (aux_end - aux >= 3) {
    char tag[4];
    int type, size, r;

    memcpy(tag, aux, 3);
    tag[3] = '\0';

    type = aux[2];
    size = cram_aux_type_size(type);

    if (size < 0)
        goto err;

    // Check we have enough room for the tag and its data
    if (aux + size + 3 > aux_end)
        goto err;

    // Lookup tag in global tag map
    k = kh_get(m_s2i, c->comp_hdr->TD_hash, tag);
    if (k == kh_end(c->comp_hdr->TD_hash)) {
        // Tag not found. Add it to the hash.
        key = string_ndup(c->comp_hdr->TD_keys, tag, 3);
        if (!key)
            goto block_err;

        k = kh_put(m_s2i, c->comp_hdr->TD_hash, key, &new);
        if (new < 0)
            goto err;
        else if (new == 0) {
            BLOCK_SIZE(td_b) = TD_blk_size;
        } else {
            kh_val(c->comp_hdr->TD_hash, k) = c->comp_hdr->nTL;
            c->comp_hdr->nTL++;
        }
    }

    cr->TL = kh_val(c->comp_hdr->TD_hash, k);
    if (cram_stats_add(c->stats[DS_TL], cr->TL) < 0)
        goto block_err;

    // Append tag to TD block
    BLOCK_APPEND_CHAR(td_b, tag[0]);
    BLOCK_APPEND_CHAR(td_b, tag[1]);
    BLOCK_APPEND_CHAR(td_b, tag[2]);

    // Encode value into slice-level blocks
    r = cram_encode_aux_value(filedescriptor, c, s, cr, tag, type, aux+3, size, no_ref);
    if (r < 0)
        goto err;

    aux += 3 + size;
}