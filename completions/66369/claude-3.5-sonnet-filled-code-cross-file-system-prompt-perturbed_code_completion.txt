if (aux[0] == 'R' && aux[1] == 'G') {
    brg = sam_hrecs_find_rg(filedescriptor->header->hrecs, aux + 3);
    if (!brg) {
        hts_log_warning("RG:Z:%s header line is missing", aux + 3);
    }
}

if (aux[0] == 'M' && aux[1] == 'D' && aux[2] == 'Z') {
    if (verbatim_MD) {
        if (MD) {
            kputs((char *)aux + 3, MD);
        }
    } else {
        // Auto-generate MD
        if (cf_tag & 1)
            cf_tag &= ~1;
        else
            verbatim_MD = 1;
    }
    aux += 3 + strlen((char *)aux + 3) + 1;
    continue;
}

if (aux[0] == 'N' && aux[1] == 'M') {
    if (verbatim_NM) {
        NM = bam_aux2i(aux);
    } else {
        // Auto-generate NM
        if (cf_tag & 2)
            cf_tag &= ~2;
        else
            verbatim_NM = 1;
    }
    aux += 3 + 1;
    continue;
}

key = (aux[0]<<16)|(aux[1]<<8)|aux[2];
if (key == ('M'<<16)|('C'<<8)|'Z') {
    // MC:Z
    int mc_len = strlen((char *)aux+3)+1;
    BLOCK_APPEND(s->aux_blk, aux, 3 + mc_len);
    aux += 3 + mc_len;
    continue;
}

// Encode aux key
BLOCK_APPEND(td_b, aux, 3);

// Add to tag map
tm = kh_put(m_tagmap, c->tags_used, key, &new);
if (new < 0) goto block_err;
if (new) {
    khint_t k;
    k = kh_put(m_metrics, filedescriptor->tags_used, key, &new);
    if (new < 0) goto block_err;
    if (new)
        kh_val(filedescriptor->tags_used, k) = 1;
    else
        kh_val(filedescriptor->tags_used, k)++;
}

// Encode aux value
if (!(tm = cram_encoder_init(filedescriptor, c, E_BYTE_ARRAY_STOP, aux[2], key, td_b)))
    goto block_err;

r |= tm->encode(s, tm, key, aux+3, NULL);
if (r) goto err;

aux = (char *)aux_end;