// Copy aux keys to td_b and aux values to slice aux blocks
while (aux_end - aux >= 1 && aux[0] != 0) {
    int r;

    // Room for code + type + at least 1 byte of data
    if (aux - orig >= aux_size - 3)
        goto err;

    // RG:Z
    if (aux[0] == 'R' && aux[1] == 'G' && aux[2] == 'Z') {
        int rg_len = 0;
        const char *rg_val = aux + 3;

        // Find the end of the RG:Z value
        while (rg_val[rg_len] != '\0' && rg_val[rg_len] != '\n') {
            rg_len++;
        }

        // Add the RG:Z tag to the slice aux blocks
        BLOCK_APPEND(s->aux_blk, (char *)aux, 3 + rg_len + 1);
        cr->aux_size += 3 + rg_len + 1;

        // Update the record's RG index
        cr->rg = -1; // prevents auto-add later

        // Move to the next tag
        aux += 3 + rg_len + 1;
        continue;
    }

    // Process other tags similarly
    // ...

    // Move to the next tag
    aux += 3;
}