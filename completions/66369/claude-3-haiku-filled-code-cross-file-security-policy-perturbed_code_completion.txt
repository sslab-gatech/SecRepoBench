while (aux_end - aux >= 1 && aux[0] != 0) {
    int r;

    // Room for code + type + at least 1 byte of data
    if (aux - orig >= aux_size - 3)
        goto err;

    // RG:Z
    if (aux[0] == 'R' && aux[1] == 'G' && aux[2] == 'Z') {
        aux += 3;
        brg = sam_hdr_find_rg(filedescriptor->header, aux);
        if (!brg) {
            hts_log_warning("Missing RG header for tag '%s'", aux);
            cr->rg = -1;
        } else {
            cr->rg = brg->id;
        }
        while (*aux++);
    }
    // MD:Z
    else if (aux[0] == 'M' && aux[1] == 'D' && aux[2] == 'Z') {
        aux += 3;
        if (verbatim_MD) {
            cr->aux_MD = BLOCK_SIZE(s->aux_blk);
            cr->aux_MD_len = 0;
            while (*aux) {
                BLOCK_APPEND_CHAR(s->aux_blk, *aux);
                cr->aux_MD_len++;
                aux++;
            }
            BLOCK_APPEND_CHAR(s->aux_blk, 0);
            cr->aux_MD_len++;
        } else {
            MD->l = 0;
            while (*aux) {
                kputc(*aux, MD);
                aux++;
            }
            cr->aux_MD = BLOCK_SIZE(s->aux_blk);
            cr->aux_MD_len = MD->l;
            BLOCK_APPEND(s->aux_blk, MD->s, MD->l);
            BLOCK_APPEND_CHAR(s->aux_blk, 0);
            cr->aux_MD_len++;
        }
    }
    // NM:i
    else if (aux[0] == 'N' && aux[1] == 'M' && aux[2] == 'i') {
        aux += 3;
        if (verbatim_NM) {
            cr->aux_NM = BLOCK_SIZE(s->aux_blk);
            cr->aux_NM_len = 0;
            while (*aux) {
                BLOCK_APPEND_CHAR(s->aux_blk, *aux);
                cr->aux_NM_len++;
                aux++;
            }
            BLOCK_APPEND_CHAR(s->aux_blk, 0);
            cr->aux_NM_len++;
        } else {
            int32_t nm;
            r = safe_parseInt32(aux, &nm, &aux);
            if (r < 0)
                goto err;
            cr->aux_NM = BLOCK_SIZE(s->aux_blk);
            cr->aux_NM_len = 5;
            BLOCK_APPEND_CHAR(s->aux_blk, 'N');
            BLOCK_APPEND_CHAR(s->aux_blk, 'M');
            BLOCK_APPEND_CHAR(s->aux_blk, 'i');
            BLOCK_APPEND_INT32(s->aux_blk, nm);
        }
    }
    // Other tags
    else {
        int type = aux[2];
        aux += 3;
        r = cram_encode_aux_type(c, s, cr, &aux, aux_end, type, tm);
        if (r < 0)
            goto err;
    }
}