if (aux[0] == 'R' && aux[1] == 'G' && aux[2] == 'Z') {
            const char *rg = (const char *)(aux + 3);
            brg = sam_hrecs_find_rg(filedescriptor->header->hrecs, rg);
            if (!brg)
                hts_log_warning("RG tag '%s' not found in header", rg);
            
            BLOCK_APPEND(td_b, aux, 3);
            aux += 3 + strlen(rg) + 1;
            continue;
        }

        if ((aux[0] == 'M' && aux[1] == 'D' && verbatim_MD) ||
            (aux[0] == 'N' && aux[1] == 'M' && verbatim_NM)) {
            char tmp[3] = {aux[0], aux[1], '*'};
            BLOCK_APPEND(td_b, tmp, 3);
            aux += 3 + strlen(aux+3) + 1;
            continue;
        }

        BLOCK_APPEND(td_b, aux, 3);
        char type = aux[2];
        size_t data_len = bam_aux_type2size(type, aux+3);
        if (data_len == 0 || aux + 3 + data_len > aux_end)
            goto err;

        cram_map *m = map_find(c->comp_hdr->tag_encoding_map, aux, 
                              (aux[0]<<16)|(aux[1]<<8)|aux[2]);
        if (!m || !m->codec)
            goto err;

        int out_len = data_len;
        if (m->codec->encode(s, m->codec, m->blk, aux+3, &out_len) < 0)
            goto err;

        BLOCK_APPEND(s->aux_blk, aux+3, out_len);
        cr->aux_size += out_len;
        aux += 3 + data_len;