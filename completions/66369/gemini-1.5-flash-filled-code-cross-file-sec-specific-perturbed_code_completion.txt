key = aux;
        k = kh_get(m_s2i, c->comp_hdr->TD_hash, key);
        if (k == kh_end(c->comp_hdr->TD_hash)) {
            int new;
            k = kh_put(m_s2i, c->comp_hdr->TD_hash, key, &new);
            if (new < 0)
                goto err;
            else if (new == 0) {
                // Key already exists.
                // This should not happen, but if it does, we'll just skip
                // this tag.
                aux += 3 + bam_aux2i(aux + 3);
                continue;
            }
            c->comp_hdr->nTL++;
        }
        int len = bam_aux2i(aux + 3);
        cram_tag_map *tm = &c->comp_hdr->tag_map[kh_val(c->comp_hdr->TD_hash, k)];
        if (!tm->codec) {
            tm->codec = cram_codec_create(aux[2], len);
            if (!tm->codec)
                goto err;
            tm->blk = cram_block_create(len);
            if (!tm->blk)
                goto err;
        }
        if (tm->codec->encode(s, tm->codec, aux + 3, len, tm->blk) < 0)
            goto err;
        aux += 3 + len;
        if (cram_stats_add(c->stats[DS_TL], kh_val(c->comp_hdr->TD_hash, k)) < 0)
            goto block_err;
        cr->TL = kh_val(c->comp_hdr->TD_hash, k);
        if (cram_stats_add(c->stats[DS_TL], cr->TL) < 0)
            goto block_err;

        // Update the tag map
        tm->m++;
        if (tm->m > tm->blk->m)