// Process each auxiliary tag
        while (aux < aux_end) {
            uint8_t type = aux[2];
            int aux_len = 0;

            // Determine the length of the auxiliary data based on its type
            switch (type) {
                case 'A': case 'c': case 'C':
                    aux_len = 4; // key(2) + type(1) + value(1)
                    break;
                case 's': case 'S':
                    aux_len = 5; // key(2) + type(1) + value(2)
                    break;
                case 'i': case 'I': case 'f':
                    aux_len = 7; // key(2) + type(1) + value(4)
                    break;
                case 'Z': case 'H':
                    aux_len = 3; // key(2) + type(1) + value(n) + '\0'
                    while (aux[aux_len] != '\0' && aux + aux_len < aux_end)
                        aux_len++;
                    aux_len++; // include the null terminator
                    break;
                case 'B':
                    {
                        int32_t count;
                        memcpy(&count, aux + 3, 4);
                        aux_len = 8 + count * (aux[3] == 'c' || aux[3] == 'C' ? 1 :
                                               aux[3] == 's' || aux[3] == 'S' ? 2 : 4);
                    }
                    break;
                default:
                    goto err; // Unknown type
            }

            if (aux + aux_len > aux_end)
                goto err;

            // Handle RG tag separately
            if (aux[0] == 'R' && aux[1] == 'G' && type == 'Z') {
                char *rg_val = aux + 3;
                brg = sam_hrecs_find_rg(filedescriptor->header->hrecs, rg_val);
                if (!brg) {
                    hts_log_warning("RG tag refers to unknown read group '%s'", rg_val);
                }
            }

            // Append the tag to the slice's auxiliary block
            if (BLOCK_APPEND(s->aux_blk, aux, aux_len) < 0)
                goto err;

            aux += aux_len;
        }