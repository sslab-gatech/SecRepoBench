if (kh_val(names, k) == -1) {
            cr->cram_flags |= CRAM_FLAG_LOSSY_NAME;
            cr->name = -1;
        } else {
            cr->name = r1;
        }
    }

    ret = 0;

fail:
    kh_destroy(m_s2u64, names);
    return ret;
}

/*
 * Encodes a single read.
 *
 * Returns 0 on success
 *        -1 on failure
 */
static int process_one_read(cram_fd *fd, cram_container *c,
                            cram_slice *s, cram_record *cr,
                            bam_seq_t *b, int rnum, kstring_t *MD,
                            int embed_ref, int no_ref) {
    int r = 0;
    int i, j;
    int64_t last_pos = 0;
    int64_t pos = bam_pos(b);
    int64_t ref_id = bam_ref(b);
    int64_t ref_start = bam_pos(b);
    int64_t ref_span = 0;
    int64_t num_records = 0;
    int64_t num_landmarks = 0;
    int64_t num_content_ids = 0;
    int64_t record_counter = 0;
    int64_t num_blocks = 0;
    int64_t content_id = 0;
    int64_t ref_base_id = -1;
    int64_t num_content_ids_used = 0;
    int64_t num_blocks_used = 0;
    int64_t num_records_used = 0;
    int64_t num_landmarks_used = 0;
    int64_t ref_seq_id = -1;
    int64_t ref_seq_start = -1;
    int64_t ref_seq_span = -1;
    int64_t ref_seq_start_used = -1;
    int64_t ref_seq_span_used = -1;
    int64_t ref_seq_id_used = -1;
    int64_t ref_seq_start_used_used = -1;
    int64_t ref_seq_span_used_used = -1;
    int64_t ref_seq_id_used_used = -1;
    int64_t ref_seq_start_used_used_used = -1;
    int64_t ref_seq_span_used_used_used = -1;
    int64_t ref_seq_id_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_start_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_span_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used_used = -1;
    int64_t ref_seq_id_used_used_used_used_used_used_used_used_used_used_used_used_used_used