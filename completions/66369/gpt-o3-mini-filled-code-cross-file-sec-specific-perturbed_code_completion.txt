{
    if (aux_end - aux < 4)
        goto err;
    char tag[4];
    memcpy(tag, aux, 3);
    tag[3] = '\0';
    char tag_type = aux[3];

    int tag_length = 4; // key (3) + type (1)
    if (tag_type == 'A') {
        if (aux_end - aux < 5)
            goto err;
        tag_length += 1;
    } else if (tag_type == 'i' || tag_type == 'f') {
        if (aux_end - aux < 8)
            goto err;
        tag_length += 4;
    } else if (tag_type == 'Z' || tag_type == 'H') {
        char *p = aux + 4;
        while (p < aux_end && *p)
            p++;
        if (p >= aux_end)
            goto err;
        tag_length += (p - (aux + 4)) + 1;
    } else {
        goto err;
    }

    /* Append the auxiliary tag key (3-bytes) to the TD block.
       This builds a list of tag keys at container level. */
    BLOCK_APPEND(c->comp_hdr->TD_blk, aux, 3);

    /* Append the complete auxiliary tag (key, type and value)
       to the slice-level auxiliary block. */
    BLOCK_APPEND(s->aux_blk, aux, tag_length);

    /* If the tag is MD:Z and verbatim_MD is requested, override
       the tag’s value with the provided MD string. */
    if (tag[0]=='M' && tag[1]=='D' && verbatim_MD && MD && MD->l) {
        /* Remove previously appended MD tag */
        BLOCK_SIZE(s->aux_blk) -= tag_length;
        /* Re-append key and type */
        BLOCK_APPEND(s->aux_blk, aux, 3);    // key "MD\0"
        BLOCK_APPEND_CHAR(s->aux_blk, 'Z');    // type: 'Z'
        /* Append MD string, ensuring null termination */
        BLOCK_APPEND(s->aux_blk, MD->s, MD->l);
        BLOCK_APPEND_CHAR(s->aux_blk, '\0');
        tag_length = 3 + 1 + MD->l + 1;
    }
    /* Similarly, if the tag is NM:i and verbatim_NM is requested,
       override the tag’s value with the provided integer NM. */
    else if (tag[0]=='N' && tag[1]=='M' && verbatim_NM) {
        BLOCK_SIZE(s->aux_blk) -= tag_length;
        BLOCK_APPEND(s->aux_blk, aux, 3);    // key "NM\0"
        BLOCK_APPEND_CHAR(s->aux_blk, 'i');    // type: 'i'
        int32_t nm_val = NM;
        BLOCK_APPEND(s->aux_blk, (char *)&nm_val, 4);
        tag_length = 3 + 1 + 4;
    }

    cr->aux_size += tag_length;
    aux += tag_length;
}