if (strncmp(aux, "RG", 2) == 0) {
    brg = sam_hdr_find_rg(filedescriptor->header, aux + 3);
    if (!brg) {
        hts_log_warning("Missing RG header record for RG:Z:%s", aux + 3);
    }
    aux += 3 + strlen(aux + 3) + 1;
} else {
    int32_t id, out_sz = 1;
    unsigned char tag_data[3];
    cram_map *m;

    tag_data[0] = aux[0];
    tag_data[1] = aux[1];
    tag_data[2] = aux[2];
    id = (tag_data[0]<<16) | (tag_data[1]<<8) | tag_data[2];

    m = map_find(c->comp_hdr->tag_encoding_map, tag_data, id);
    if (!m) {
        hts_log_warning("Unknown tag encoding for tag %c%c%c", tag_data[0], tag_data[1], tag_data[2]);
        aux += 3 + 1; // Skip unknown tag
        continue;
    }

    if (!m->codec) {
        hts_log_warning("No codec for tag %c%c%c", tag_data[0], tag_data[1], tag_data[2]);
        aux += 3 + 1; // Skip unknown tag
        continue;
    }

    r = m->codec->encode(s, m->codec, (char *)aux+3, BLOCK_SIZE(tm->blk), &out_sz);
    if (r) {
        hts_log_error("Error encoding tag %c%c%c", tag_data[0], tag_data[1], tag_data[2]);
        goto err;
    }

    BLOCK_APPEND(tm->blk, (char *)tag_data, 3);
    BLOCK_APPEND(tm->blk, (char *)aux+3, out_sz);
    aux += 3 + out_sz;
}