char *q_ptr = p;
char *r_ptr = p;
int previous_space = 1;

while (*r_ptr != '\0') {
    if (isspace((unsigned char)*r_ptr)) {
        if (!previous_space) {
            *q_ptr++ = ' ';
            previous_space = 1;
        }
        r_ptr++;
    } else {
        *q_ptr++ = *r_ptr++;
        previous_space = 0;
    }
}

if (q_ptr > p && *(q_ptr - 1) == ' ') {
    q_ptr--;
}

*q_ptr = '\0';