{
  char *read_ptr = p;
  char *write_ptr = p;

  /* Skip leading spaces */
  while (isspace((unsigned char)*read_ptr))
    read_ptr++;

  while (*read_ptr != '\0')
  {
    /* If current character is space, write a single space and
       skip consecutive spaces. */
    if (isspace((unsigned char)*read_ptr))
    {
      *write_ptr++ = ' ';
      while (isspace((unsigned char)*(++read_ptr)))
        ;
      continue;
    }
    /* Copy character. */
    *write_ptr++ = *read_ptr++;
  }

  /* Remove any trailing space. */
  if ((write_ptr > p) && isspace((unsigned char)write_ptr[-1]))
    write_ptr--;

  /* Null-terminate the string. */
  *write_ptr = '\0';
}