if (timeparser->time_fmt_year) {
    /* If no year is in the string, we need to lookup the current date */
    time_now = now;
    if (time_now == 0) {
        time_now = time(NULL);
    }

    /* This means there is no year encoded in the string */
    gmtime_r(&time_now, &tmy);
    
    /* Format the current date according to the expected format with year */
    strftime(tmp, sizeof(tmp) - 1, timeparser->time_fmt_year, &tmy);
    
    /* Parse the time string using the format with year */
    fmt = tmp;
}
else {
    /* We have the time string and the expected format */    
    /* Safe copy of the time string to ensure null-termination */
    memcpy(tmp, time_str, time_len);
    tmp[time_len] = '\0';
    
    /* Parse the time string using the parser's format */
    fmt = timeparser->time_fmt;
}

p = flb_strptime(time_str, fmt, tm);