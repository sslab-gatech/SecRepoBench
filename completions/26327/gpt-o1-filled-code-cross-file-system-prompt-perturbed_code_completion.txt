/* Determine if the time string already includes a year by looking for
     * four consecutive digits. If it doesn't, prepend the current year using
     * time_fmt_year. Otherwise, parse the string as is. */
    {
        int i;
        int has_year_digits = 0;

        for (i = 0; i < time_len - 3; i++) {
            if (isdigit(time_ptr[i]) && isdigit(time_ptr[i+1]) &&
                isdigit(time_ptr[i+2]) && isdigit(time_ptr[i+3])) {
                has_year_digits = 1;
                break;
            }
        }

        if (timeparser->time_fmt_year && has_year_digits == 0) {
            time_now = now;
            if (time_now == 0) {
                time_now = time(NULL);
            }
            gmtime_r(&time_now, &tmy);

            snprintf(tmp, sizeof(tmp), "%04d %.*s",
                     tmy.tm_year + 1900, time_len, time_ptr);
            tmp[sizeof(tmp) - 1] = '\0';

            p = flb_strptime(tmp, timeparser->time_fmt_year, tm);
        }
        else {
            memcpy(tmp, time_ptr, time_len);
            tmp[time_len] = '\0';

            p = flb_strptime(tmp, timeparser->time_fmt, tm);
        }
    }