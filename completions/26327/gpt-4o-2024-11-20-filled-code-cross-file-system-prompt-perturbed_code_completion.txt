gmtime_r(&now, &tmy);

    if (timeparser->time_with_year == FLB_FALSE) {
        /* Format: "current_year time_str" */
        snprintf(tmp, sizeof(tmp) - 1, "%d %.*s",
                 tmy.tm_year + 1900, (int) tsize, time_str);
        tmp[sizeof(tmp) - 1] = '\0';

        fmt = timeparser->time_fmt_year;
        time_ptr = tmp;
        time_len = strlen(tmp);
    }
    else {
        /* Copy the time string to a temporary buffer */
        memcpy(tmp, time_str, tsize);
        tmp[tsize] = '\0';

        fmt = timeparser->time_fmt;
    }

    /* Parse the time string */
    p = flb_strptime(time_ptr, fmt, tm);