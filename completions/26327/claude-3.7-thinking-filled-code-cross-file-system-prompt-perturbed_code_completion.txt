fmt = NULL;
p = NULL;

if (timeparser->time_fmt_year) {
    /* Get current time to fill in missing year */
    if (now == 0) {
        time_now = time(NULL);
    } else {
        time_now = now;
    }
    
    /* Use gmtime_r to get current date */
    gmtime_r(&time_now, &tmy);
    
    /* Create temporary buffer with the time string */
    memcpy(tmp, time_str, tsize);
    tmp[tsize] = '\0';
    
    /* Parse using format for time strings without year */
    p = flb_strptime(tmp, timeparser->time_fmt_year, tm);
    
    /* If successful, fill in the year from current time */
    if (p != NULL) {
        tm->tm_year = tmy.tm_year;
    }
}

/* If parsing with time_fmt_year failed or wasn't available, try regular format */
if (p == NULL) {
    if (timeparser->time_fmt == NULL) {
        flb_error("[parser] time format is not defined");
        return -1;
    }
    
    /* Copy to temporary buffer with null termination */
    memcpy(tmp, time_str, tsize);
    tmp[tsize] = '\0';
    
    /* Parse with regular time format */
    p = flb_strptime(tmp, timeparser->time_fmt, tm);
}