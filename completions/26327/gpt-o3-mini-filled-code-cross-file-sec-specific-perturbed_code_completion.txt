if (timeparser->time_fmt_year) {
    /* The time string is missing the year */
    struct tm current_tm;
    time_t now_time = (now != 0) ? now : time(NULL);
    char year_str[6]; /* "YYYY" plus null */
    int n;

    gmtime_r(&now_time, &current_tm);
    n = snprintf(year_str, sizeof(year_str), "%04d", current_tm.tm_year + 1900);
    if (n < 0 || n >= sizeof(year_str)) {
        flb_error("[parser] failed to format year");
        return -1;
    }

    /* Build a temporary string: "<year> <original time_str>" */
    n = snprintf(tmp, sizeof(tmp), "%s %.*s", year_str, (int)tsize, time_str);
    if (n < 0 || (unsigned int)n >= sizeof(tmp)) {
        flb_error("[parser] combined time string length is too long");
        return -1;
    }

    fmt = timeparser->time_fmt_year;
    p = flb_strptime(tmp, fmt, &tmy);
    if (p == NULL) {
        flb_error("[parser] cannot parse modified time string '%s'", tmp);
    }
    else {
        *tm = tmy;
    }
}
else {
    /* The time string includes the year */
    /* Ensure null termination */
    memcpy(tmp, time_str, tsize);
    tmp[tsize] = '\0';

    fmt = timeparser->time_fmt;
    p = flb_strptime(tmp, fmt, &tmy);
    if (p == NULL) {
        flb_error("[parser] cannot parse time string '%s'", tmp);
    }
    else {
        *tm = tmy;
    }
}