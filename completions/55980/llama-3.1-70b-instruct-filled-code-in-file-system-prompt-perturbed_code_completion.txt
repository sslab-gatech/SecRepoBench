xmlSwitchEncoding(xmlParserCtxtPtr ctxt, xmlCharEncoding enc) {
    if (ctxt->encoding!= NULL)
        xmlFree((xmlChar *) ctxt->encoding);
    ctxt->encoding = xmlStrdup((const xmlChar *) enc);
    if (ctxt->input!= NULL) {
        if (ctxt->input->encoding!= NULL)
            xmlFree((xmlChar *) ctxt->input->encoding);
        ctxt->input->encoding = xmlStrdup((const xmlChar *) enc);
    }
    if (ctxt->input!= NULL && ctxt->input->buf!= NULL) {
        if (ctxt->input->buf->encoder!= NULL) {
            xmlCharEncodingHandlerPtr handler = xmlFindCharEncodingHandler((const char *) enc);
            if (handler!= NULL) {
                if (xmlSwitchToEncoding(ctxt, handler) < 0) {
                    /* failed to convert */
                    ctxt->errNo = XML_ERR_UNSUPPORTED_ENCODING;
                    return;
                }
            } else {
                xmlFatalErrMsg(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                               "Unsupported encoding %s\n", enc);
                return;
            }
        }
    }
}