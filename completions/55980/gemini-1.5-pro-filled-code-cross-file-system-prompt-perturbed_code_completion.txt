encoding_error:
    if ((parserContext->input->end - parserContext->input->cur) > 0) {
        xmlChar *utf = CUR_PTR;
        xmlChar *utf1 = NEXT_PTR;
        const char *cur = (const char *) utf;
        const char *cur1 = (const char *) utf1;

        if (parserContext->charset == XML_CHAR_ENCODING_UTF8) {
            /*
             * If we are in UTF-8, the encoding error must be that the
             * char is not a valid UTF-8 char.
             */
            xmlFatalErrMsgInt(parserContext, XML_ERR_INVALID_CHAR,
                             "Char 0x%X out of allowed range\n",
                             *utf);
        } else {
            xmlFatalErrMsg(parserContext, XML_ERR_INVALID_ENCODING,
                           "Input is not proper UTF-8, indicate encoding !\n",
                           NULL);
        }
        if (parserContext->input->buf != NULL) {
            /* We are parsing from a stream, encoding was guessed */
            parserContext->input->buf->encoder = xmlGetUTF8Encoder();
            if (parserContext->input->buf->encoder == NULL) {
                xmlHaltParser(parserContext);
                return (0);
            }
            parserContext->charset = XML_CHAR_ENCODING_UTF8;
        }
        parserContext->input->cur = utf1;
    } else {
        xmlHaltParser(parserContext);
    }
    return(ret);