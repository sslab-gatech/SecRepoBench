{
    #define MAX_SNIPPET 64
    int avail = 0;
    char snippet[MAX_SNIPPET + 1] = {0};

    if (ctxt->input != NULL && ctxt->input->cur != NULL && ctxt->input->end != NULL) {
        avail = ctxt->input->end - ctxt->input->cur;
        if (avail > MAX_SNIPPET)
            avail = MAX_SNIPPET;
        memcpy(snippet, ctxt->input->cur, avail);
        snippet[avail] = '\0';
    } else {
        strncpy(snippet, "N/A", MAX_SNIPPET);
        snippet[MAX_SNIPPET] = '\0';
    }
    xmlFatalErrMsgStr(ctxt, XML_ERR_INVALID_ENCODING,
                      "Encoding error: input does not conform to UTF-8 near: ",
                      BAD_CAST snippet);
    xmlHaltParser(ctxt);
    return(ret);
}