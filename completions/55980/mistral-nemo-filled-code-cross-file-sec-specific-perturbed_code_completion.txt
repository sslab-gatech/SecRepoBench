// Handle encoding errors encountered during XML parsing.
// Check if the input does not conform to UTF-8 encoding.
// Report an encoding error with details about the problematic bytes.
// Terminate the parsing process upon encountering this error.
// <MASK>
if (ctxt->input->buf->encoder != NULL) {
    int err;
    int len = 4096;
    const char *str = (const char *) ctxt->input->cur;
    const char *end = str + ctxt->input->end - ctxt->input->base;

    while (str < end) {
        err = xmlCharEncCheck(ctxt->input->buf->encoder, str, end - str);
        if (err < 0) {
            xmlFatalErr(ctxt, XML_ERR_INVALID_ENCODING,
                        "encoding error: malformed byte sequence");
            xmlHaltParser(ctxt);
            return (XML_PARSER_EOF);
        }
        str += err;
    }
}