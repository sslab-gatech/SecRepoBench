if (parserContext->charset != XML_CHAR_ENCODING_UTF8) {
        int len = parserContext->input->cur - parserContext->input->base;
        const xmlChar *cur = parserContext->input->base;
        int i;
        unsigned char c;
        int codepoint;

        for (i = 0; i < len; i++) {
            c = cur[i];
            if ((c & 0x80) == 0x00) { /* 1-byte code, starts with 10 */
                continue;
            } else if ((c & 0xe0) == 0xc0) { /* 2-byte code, starts with 110 */
                if ((cur[i + 1] & 0xc0) != 0x80)
                    goto encoding_error;
                codepoint = (cur[i] & 0x1f) << 6;
                codepoint |= cur[i + 1] & 0x3f;
                if (!xmlIsCharQ(codepoint))
                    goto encoding_error;
                i++;
            } else if ((c & 0xf0) == 0xe0) { /* 3-byte code, starts with 1110 */
                if (((cur[i + 1] & 0xc0) != 0x80) ||
                    ((cur[i + 2] & 0xc0) != 0x80))
                    goto encoding_error;
                codepoint = (cur[i] & 0xf) << 12;
                codepoint |= (cur[i + 1] & 0x3f) << 6;
                codepoint |= cur[i + 2] & 0x3f;
                if (!xmlIsCharQ(codepoint))
                    goto encoding_error;
                i += 2;
            } else if ((c & 0xf8) == 0xf0) { /* 4-byte code, starts with 11110 */
                if (((cur[i + 1] & 0xc0) != 0x80) ||
                    ((cur[i + 2] & 0xc0) != 0x80) ||
                    ((cur[i + 3] & 0xc0) != 0x80))
                    goto encoding_error;
                codepoint = (cur[i] & 0x7) << 18;
                codepoint |= (cur[i + 1] & 0x3f) << 12;
                codepoint |= (cur[i + 2] & 0x3f) << 6;
                codepoint |= cur[i + 3] & 0x3f;
                if (!xmlIsCharQ(codepoint))
                    goto encoding_error;
                i += 3;
            } else
                goto encoding_error;
        }
    }
    return(1);

encoding_error:
    xmlFatalErrMsgInt(parserContext, XML_ERR_INVALID_ENCODING,
                      "Input is not proper UTF-8, byte %d\n", i);
    xmlHaltParser(parserContext);
    return(0);