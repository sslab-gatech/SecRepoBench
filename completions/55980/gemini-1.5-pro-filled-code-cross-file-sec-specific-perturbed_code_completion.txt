encoding_error:
    if (parserContext->input->end - parserContext->input->cur < 4) {
        /*
         * We are close to the end of the stream, don't try to
         * do more encoding checks
         */
        goto done;
    }
    if (parserContext->charset == XML_CHAR_ENCODING_UTF8) {
        /*
         * If we are in UTF-8, detect if there is a valid UTF-8
         * sequence, if not, switch to ISO-Latin-1 or try to
         * autodetect.
         */
        if (!xmlCheckUTF8(parserContext->input->cur)) {
            xmlCharEncoding enc;
            enc = xmlDetectCharEncoding(parserContext->input->cur,
                                        parserContext->input->end -
                                        parserContext->input->cur);
            if ((enc == XML_CHAR_ENCODING_UTF8) ||
                (enc == XML_CHAR_ENCODING_NONE)) {
                xmlFatalErrMsgInt(parserContext, XML_ERR_INVALID_CHAR,
                                 "Input is not proper UTF-8, indicate encoding !\n"
                                 "Bytes: 0x%02X 0x%02X 0x%02X 0x%02X\n",
                                 parserContext->input->cur[0],
                                 parserContext->input->cur[1],
                                 parserContext->input->cur[2],
                                 parserContext->input->cur[3]);
            } else {
                xmlSwitchEncoding(parserContext, enc);
                goto done; /* done will re-enter the parser */
            }
        } else {
            xmlFatalErrMsgInt(parserContext, XML_ERR_INVALID_CHAR,
                             "Invalid UTF-8 sequence !\n"
                             "Bytes: 0x%02X 0x%02X 0x%02X 0x%02X\n",
                             parserContext->input->cur[0],
                             parserContext->input->cur[1],
                             parserContext->input->cur[2],
                             parserContext->input->cur[3]);
        }
        parserContext->input->cur++;
    } else {
        xmlFatalErr(parserContext, XML_ERR_INVALID_CHAR, NULL);
        parserContext->input->cur++;
    }