encoding_error:
    if (ctxt->input->end - ctxt->input->cur < 4) {
        /*
         * We are at the end of the input buffer, hence there is no more
         * chance to find a correct encoding. We must signal an error
         * here because 'tryOrFinish' is called with 'terminate' set
         * to 1, meaning that the input was consumed.
         */
        xmlHaltParser(ctxt);
        if (ctxt->sax != NULL && ctxt->sax->endDocument != NULL)
            ctxt->sax->endDocument(ctxt->userData);
        return 0;
    }
    xmlCharEncClose(ctxt->input->buf->encoder);
    ctxt->input->buf->encoder = NULL;
    xmlFatalErr(ctxt, XML_ERR_INVALID_ENCODING, NULL);
    goto done;