encoding_error:
    if (xmlCheckUTF8(parserContext->input->cur, tmp) == 0) {
        int avail = parserContext->input->end - parserContext->input->cur;
        int bytes_to_log = avail > 4 ? 4 : avail;
        char msg[64];
        char *ptr = msg;
        
        ptr += snprintf(ptr, sizeof(msg), "Invalid UTF-8 bytes: ");
        for (int i = 0; i < bytes_to_log; i++) {
            if (ptr + 3 <= msg + sizeof(msg)) {
                ptr += snprintf(ptr, msg + sizeof(msg) - ptr, "%02X ", parserContext->input->cur[i]);
            }
        }
        xmlFatalErrMsgStr(parserContext, XML_ERR_INVALID_ENCODING, "%s", BAD_CAST msg);
    } else {
        xmlFatalErr(parserContext, XML_ERR_INVALID_ENCODING, NULL);
    }
    xmlHaltParser(parserContext);
    return 0;