encoding_error:
    // Report the encoding error
    xmlChar *errmsg = NULL;
    int errlen = 0;
    int i;
    for (i = 0; i < 10 && ctxt->input->cur + i < ctxt->input->end; i++) {
        if (!IS_CHAR(ctxt->input->cur[i])) {
            errlen += 4; // 4 bytes per invalid character
        } else {
            errlen += 1; // 1 byte per valid character
        }
    }
    errmsg = (xmlChar *)xmlMalloc(errlen + 1);
    if (errmsg == NULL) {
        xmlErrMemory(ctxt, "encoding error: out of memory\n");
        return;
    }
    errmsg[0] = '\0';
    for (i = 0; i < 10 && ctxt->input->cur + i < ctxt->input->end; i++) {
        if (!IS_CHAR(ctxt->input->cur[i])) {
            sprintf((char *)errmsg + strlen((char *)errmsg), "\\x%02X", ctxt->input->cur[i]);
        } else {
            sprintf((char *)errmsg + strlen((char *)errmsg), "%c", ctxt->input->cur[i]);
        }
    }
    xmlFatalErrMsgStr(ctxt, XML_ERR_INVALID_CHAR,
                     "Encoding error : '%s'\n", errmsg);
    xmlFree(errmsg);
    xmlHaltParser(ctxt);