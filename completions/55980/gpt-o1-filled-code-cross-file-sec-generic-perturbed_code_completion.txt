encoding_error: {
    /*
     * We have encountered an invalid or incomplete encoding sequence.
     * Capture a small window of bytes for reporting. This helps in
     * diagnosing the problematic area but avoids accessing out of bounds.
     */
    char badBytes[16];
    int i = 0;
    int maxCheck = (ctxt->input->end - ctxt->input->cur < (ptrdiff_t)sizeof(badBytes) - 1) ?
                   (int)(ctxt->input->end - ctxt->input->cur) :
                   (int)(sizeof(badBytes) - 1);
    for (i = 0; i < maxCheck; ++i) {
        badBytes[i] = (char)ctxt->input->cur[i];
    }
    badBytes[i] = '\0';

    /*
     * Report the error via libxml2's error mechanism for consistency.
     */
    xmlGenericError(xmlGenericErrorContext,
                    "Encoding error: invalid bytes near '%.15s'\n",
                    badBytes);
    xmlFatalErr(ctxt, XML_ERR_INVALID_ENCODING,
                "Invalid or incomplete UTF-8 sequence encountered");
    /*
     * Halt the parser to prevent further processing.
     */
    xmlHaltParser(ctxt);
    ret = 0;
    goto done;
}