// Iterate through the payload to process STUN message attributes.
  for(u_int offset = 20; offset < payload_length; ) {
    u_int16_t attr_type, attr_length;
    attr_type = ntohs(*((u_int16_t*) &payload[offset]));
    attr_length = ntohs(*((u_int16_t*) &payload[offset + 2]));

    // Align attribute length to 4-byte boundaries.
    if((attr_length & 0x03) != 0)
      attr_length += 4 - (attr_length & 0x03);

    switch(attr_type) {
      case 0x0001: // MAPPED-ADDRESS
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0002: // CHANGE-REQUEST
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0003: // SOURCE-ADDRESS
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0004: // CHANGED-ADDRESS
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0005: // USERNAME
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0006: // PASSWORD
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0007: // MESSAGE-INTEGRITY
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0008: // FINGERPRINT
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x0009: // RESPONSE-ADDRESS
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x000A: // ERROR-CODE
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x000B: // UNKNOWN-ATTRIBUTES
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_STUN) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
          goto udp_stun_found;
        }
        break;
      case 0x8020: // FINGERPRINT
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_WHATSAPP_CALL) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
          goto udp_stun_found;
        }
        break;
      case 0x8028: // ICE-CONTROLLED
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_WHATSAPP_CALL) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
          goto udp_stun_found;
        }
        break;
      case 0x8029: // ICE-LIGHTWEIGHT
        if(flow->guessed_protocol_id != NDPI_PROTOCOL_WHATSAPP_CALL) {
          flow->guessed_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
          goto udp_stun_found;
        }
        break;
      default:
        if(attr_length > (payload_length - offset)) {
          NDPI_LOG_INFO(ndpi_struct, "Invalid STUN attribute length\n");
          return(NDPI_IS_NOT_STUN);
        }
        break;
    }

    offset += attr_length;
  }

udp_stun_found:
  /* ... rest of the function ... */