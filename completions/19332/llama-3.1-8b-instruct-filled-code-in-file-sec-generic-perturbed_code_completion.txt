// Iterate through the payload to process STUN message attributes.
// For each attribute, determine its type and length and align the length to 4-byte boundaries.
// Depending on the attribute type, deduce the application protocol and set the guessed host protocol.
// If specific attributes associated with known protocols are found (like WhatsApp, Skype, Zoom, etc.),
// update the guessed protocol accordingly and return the result indicating the presence of STUN.
// <MASK>

// Iterate over the payload attributes
for (u_int offset = 20; offset < payload_length; offset += 4) {
  // Extract the attribute type and length
  u_int16_t attr_type = get_u_int16_t(payload, offset);
  u_int16_t attr_length = get_u_int16_t(payload, offset + 2);

  // Check if the attribute is a known protocol attribute
  switch (attr_type) {
    case 0x8021: // WhatsApp attribute
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
      break;
    case 0x8022: // Skype attribute
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
      break;
    case 0x8023: // Zoom attribute
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
      break;
    // Add more known protocol attributes as needed
    default:
      break;
  }

  // Check if the attribute length is valid
  if (attr_length > (payload_length - offset)) {
    break;
  }

  // Align the attribute length to 4-byte boundaries
  u_int aligned_length = (attr_length + 3) & ~3;

  // Process the attribute
  // For example, if the attribute is a WhatsApp attribute, update the guessed host protocol accordingly
  if (attr_type == 0x8021) {
    // Update the guessed host protocol
    flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
  }

  // Move to the next attribute
  offset += aligned_length;
}

// If a known protocol attribute is found, return the result indicating the presence of STUN
if (flow->guessed_host_protocol_id!= NDPI_PROTOCOL_UNKNOWN) {
  return NDPI_IS_STUN;
}

// If no known protocol attribute is found, return the result indicating the absence of STUN
return NDPI_IS_NOT_STUN;