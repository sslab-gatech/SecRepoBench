u_int16_t attribute_type, attribute_length;
const u_int8_t *attribute_value = &payload[offset];

while (offset + 4 <= payload_length) {
  attribute_type = ntohs(*((u_int16_t *)attribute_value));
  attribute_length = ntohs(*((u_int16_t *)(attribute_value + 2)));
  
  /* Align the attribute length to 4-byte boundaries */
  attribute_length = (attribute_length + 3) & ~0x3;

  if(attribute_type == STUN_ATTRIBUTE_XOR_MAPPED_ADDRESS) {
    flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
    return(NDPI_IS_STUN);
  } else if(attribute_type == STUN_ATTRIBUTE_SOFTWARE) {
    const char *software = (const char *)(attribute_value + 4); // Skip past type and length fields
    if(strstr(software, "WhatsApp") != NULL) {
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
      return(NDPI_IS_STUN);
    } else if(strstr(software, "Zoom") != NULL) {
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
      return(NDPI_IS_STUN);
    }
  }

  offset += 4 + attribute_length;
  attribute_value += 4 + attribute_length;
}