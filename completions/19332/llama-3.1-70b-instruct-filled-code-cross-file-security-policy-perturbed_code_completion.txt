u_int offset = 20;
u_int16_t attr_type, attr_len;

while (offset + 4 <= payload_length) {
  attr_type = ntohs(*((u_int16_t*) &payload[offset]));
  attr_len = ntohs(*((u_int16_t*) &payload[offset + 2]));

  // Align the length to 4-byte boundaries
  attr_len = (attr_len + 3) & ~3;

  if (offset + 4 + attr_len > payload_length) {
    // Buffer overflow, exit the loop
    break;
  }

  switch (attr_type) {
    case 0x0001: // MAPPED-ADDRESS
      // Handle MAPPED-ADDRESS attribute
      break;
    case 0x0002: // RESPONSE-ADDRESS
      // Handle RESPONSE-ADDRESS attribute
      break;
    case 0x0003: // CHANGE-REQUEST
      // Handle CHANGE-REQUEST attribute
      break;
    case 0x0004: // SOURCE-ADDRESS
      // Handle SOURCE-ADDRESS attribute
      break;
    case 0x0005: // CHANGED-ADDRESS
      // Handle CHANGED-ADDRESS attribute
      break;
    case 0x0006: // USERNAME
      // Handle USERNAME attribute
      break;
    case 0x0007: // PASSWORD
      // Handle PASSWORD attribute
      break;
    case 0x0008: // MESSAGE-INTEGRITY
      // Handle MESSAGE-INTEGRITY attribute
      break;
    case 0x0009: // ERROR-CODE
      // Handle ERROR-CODE attribute
      break;
    case 0x000A: // UNKNOWN-ATTRIBUTES
      // Handle UNKNOWN-ATTRIBUTES attribute
      break;
    case 0x0020: // SOFTWARE
      // Handle SOFTWARE attribute
      break;
    case 0x8028: // FINGERPRINT
      // Handle FINGERPRINT attribute
      break;
    default:
      // Handle unknown attribute
      break;
  }

  offset += 4 + attr_len;
}

if (flow->guessed_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
  flow->guessed_protocol_id = NDPI_PROTOCOL_STUN;
}

if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_WHATSAPP_CALL) {
  return NDPI_IS_STUN;
} else if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_MESSENGER) {
  return NDPI_IS_STUN;
} else if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_HANGOUT_DUO) {
  return NDPI_IS_STUN;
} else {
  return NDPI_IS_NOT_STUN;
}