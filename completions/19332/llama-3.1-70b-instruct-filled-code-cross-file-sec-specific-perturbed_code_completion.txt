// Iterate through the payload to process STUN message attributes.
u_int offset = 20;
while (offset < payload_length) {
  u_int16_t attr_type = ntohs(*((u_int16_t*) &payload[offset]));
  u_int16_t attr_len = ntohs(*((u_int16_t*) &payload[offset + 2]));

  // Align the length to 4-byte boundaries.
  attr_len = (attr_len + 3) & ~3;

  // Check for specific attributes associated with known protocols.
  switch (attr_type) {
    case 0x0001: // MAPPED-ADDRESS
      // WhatsApp
      if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
      }
      break;
    case 0x0002: // RESPONSE-ADDRESS
      // Skype
      if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
      }
      break;
    case 0x0003: // CHANGE-REQUEST
      // Zoom
      if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
      }
      break;
    case 0x0020: // UNKNOWN-ATTRIBUTES
      // Generic STUN
      if (flow->guessed_host_protocol_id == NDPI_PROTOCOL_UNKNOWN) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_STUN;
      }
      break;
    default:
      // Unknown attribute, skip it.
      break;
  }

  // Move to the next attribute.
  offset += 4 + attr_len;
}

// Return the result indicating the presence of STUN.
return NDPI_IS_STUN;