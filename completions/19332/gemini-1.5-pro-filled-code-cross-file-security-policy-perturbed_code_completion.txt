while (offset + 4 <= payload_length) {
        u_int16_t attr_type = ntohs(*(u_int16_t *)(payload + offset));
        u_int16_t attr_len = ntohs(*(u_int16_t *)(payload + offset + 2));

        offset += 4;

#ifdef DEBUG_STUN
        NDPI_LOG_INFO(ndpi_struct, "stun_offset = %u, attr_type = %04x, attr_len = %u\n", offset, attr_type, attr_len);
#endif

        if (offset + attr_len > payload_length) {
          return NDPI_IS_NOT_STUN;
        }


        switch (attr_type) {
          case 0x0006: /* USERNAME */
            if (attr_len == 4 && !strncmp((const char *)&payload[offset], "u=", 2)) {
              flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
              return NDPI_IS_STUN;
            }
            break;

          case 0x0008: /* MESSAGE-INTEGRITY */
            if (attr_len == 20) {
              flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
              return NDPI_IS_STUN;
            }
            break;

          case 0x0009: /* ERROR-CODE */
          case 0x000A: /* UNKNOWN-ATTRIBUTES */
          case 0x0014: /* REALM */
          case 0x0015: /* NONCE */
          case 0x0020: /* XOR-MAPPED-ADDRESS */
            break;

          case 0x8022: /* SOFTWARE */
            if (attr_len >= 12 && !strncmp((const char *)&payload[offset], "WhatsApp", 8)) {
              flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
              return NDPI_IS_STUN;
            }
            break;

          case 0x802A:
            if (attr_len == 4 && memcmp(&payload[offset], "\x00\x01\x00\x0A", 4) == 0) {
              flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
              return NDPI_IS_STUN;
            }
            break;

          case 0x802B:
            if (attr_len == 4 && memcmp(&payload[offset], "\x00\x02\x00\x04", 4) == 0) {
              flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
              return NDPI_IS_STUN;
            }
            break;

          case 0x802C:
            if (attr_len == 4 && memcmp(&payload[offset], "\x00\x03\x00\x04", 4) == 0) {
              flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
              return NDPI_IS_STUN;
            }
            break;

          default:
            break;
        }

        /* Align the length to a 4-byte boundary */
        offset += ((attr_len + 3) & ~3);
      }