while((offset + 4) < payload_length) {
  u_int16_t attr_type = ntohs(*((u_int16_t*)&payload[offset]));
  u_int16_t attr_len = ntohs(*((u_int16_t*)&payload[offset+2]));
  u_int16_t aligned_len = (attr_len + 3) & ~0x3; /* Align to 4 byte boundary */
  
#ifdef DEBUG_STUN
  printf("[STUN] Attribute 0x%04X len %u offset %u/%u\n", 
         attr_type, attr_len, offset, payload_length);
#endif

  offset += 4; /* Skip attribute header */
  
  /* Check if we have enough bytes for the attribute value */
  if((offset + aligned_len) > payload_length)
    break;
  
  /* Check for known attribute types and values */
  if(attr_type == 0x8054) { /* CANDIDATE-IDENTIFIER */
    /* This could be WhatsApp Call */
    if(attr_len == 4) {
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
      return(NDPI_IS_STUN);
    }
  } else if(attr_type == 0x8055 /* MS-SERVICE-QUALITY */ ||
            attr_type == 0x8056 /* MS-ALTERNATE-SERVER */ ||
            attr_type == 0x8070 /* MS-IMPLEMENTATION-VERSION */) {
    /* This is Skype or Teams (MS Lync) */
    flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE_TEAMS_CALL;
    return(NDPI_IS_STUN);
  } else if(attr_type == 0x4000 && attr_len >= 14) { /* UNKNOWN, possibly ZOOM */
    if(payload[offset] == 'z' && payload[offset+1] == 'o' && 
       payload[offset+2] == 'o' && payload[offset+3] == 'm' && 
       payload[offset+4] == '.') {
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
      return(NDPI_IS_STUN);
    }
  } else if(attr_type == 0x8028) { /* SOFTWARE */
    /* Check for specific software identifiers */
    if(attr_len >= 5) {
      if(strncasecmp((const char*)&payload[offset], "SIP", 3) == 0) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_SIP;
        return(NDPI_IS_STUN);
      } else if(strncasecmp((const char*)&payload[offset], "Messenger", 9) == 0) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_MESSENGER;
        return(NDPI_IS_STUN);
      } else if(strncasecmp((const char*)&payload[offset], "Google", 6) == 0) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_HANGOUT_DUO;
        return(NDPI_IS_STUN);
      } else if(strncasecmp((const char*)&payload[offset], "WhatsApp", 8) == 0) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
        return(NDPI_IS_STUN);
      }
    }
  }
  
  offset += aligned_len; /* Move to the next attribute */
}