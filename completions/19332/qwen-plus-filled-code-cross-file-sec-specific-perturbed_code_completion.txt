u_int remaining_length = payload_length - offset;

while (remaining_length > 0) {
  u_int16_t attr_type, attr_length;

  if (offset + sizeof(u_int16_t) * 2 > payload_length) {
    return NDPI_IS_NOT_STUN; // Incomplete attribute header, not a valid STUN packet
  }

  attr_type = ntohs(*((u_int16_t*)&payload[offset]));
  attr_length = ntohs(*((u_int16_t*)&payload[offset + sizeof(u_int16_t)]));
  offset += sizeof(u_int16_t) * 2;
  remaining_length -= sizeof(u_int16_t) * 2;

  if (attr_length % 4 != 0) {
    attr_length += 4 - (attr_length % 4); // Align to 4-byte boundary
  }

  if (attr_length > remaining_length) {
    return NDPI_IS_NOT_STUN; // Attribute length exceeds remaining payload, invalid STUN packet
  }

  switch (attr_type) {
    case STUN_ATTRIBUTE_XOR_MAPPED_ADDRESS: // Example attribute for demonstration
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE; // Update guessed protocol based on attribute
      break;
    // Add cases for other attributes as needed
    default:
      break;
  }

  offset += attr_length;
  remaining_length -= attr_length;
}