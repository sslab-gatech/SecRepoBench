while (offset + 4 <= payload_length) {
        u_int16_t attr_type = ntohs(*((u_int16_t*)&payload[offset]));
        u_int16_t attr_length = ntohs(*((u_int16_t*)&payload[offset + 2]));

        if (offset + 4 + attr_length > payload_length) {
          // Malformed attribute, break to avoid overflow
          break;
        }

        // Align attribute length to 4-byte boundary
        u_int16_t aligned_length = (attr_length + 3) & ~3;

        switch (attr_type) {
          case 0x0001: // MAPPED-ADDRESS
          case 0x0002: // RESPONSE-ADDRESS
          case 0x0003: // CHANGE-REQUEST
          case 0x0004: // SOURCE-ADDRESS
          case 0x0005: // CHANGED-ADDRESS
          case 0x0006: // USERNAME
          case 0x0007: // PASSWORD
          case 0x0008: // MESSAGE-INTEGRITY
          case 0x0009: // ERROR-CODE
          case 0x000A: // UNKNOWN-ATTRIBUTES
          case 0x000B: // REFLECTED-FROM
            // These are standard STUN attributes, continue processing
            break;

          case 0x8022: // SOFTWARE
            if (attr_length > 0 && attr_length < 256) {
              char software[256];
              memset(software, 0, sizeof(software));
              memcpy(software, &payload[offset + 4], attr_length);

              if (strstr(software, "WhatsApp") != NULL) {
                flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
                return (NDPI_IS_STUN);
              } else if (strstr(software, "Skype") != NULL) {
                flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
                return (NDPI_IS_STUN);
              } else if (strstr(software, "Zoom") != NULL) {
                flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
                return (NDPI_IS_STUN);
              }
            }
            break;

          default:
            // Unknown attribute, continue processing
            break;
        }

        offset += 4 + aligned_length;
      }