while (offset < payload_length) {
    u_int16_t attr_type, attr_length;
    
    if ((offset + 4) > payload_length)
        break; // Not enough data for attribute header

    attr_type = ntohs(*((u_int16_t*)&payload[offset]));
    attr_length = ntohs(*((u_int16_t*)&payload[offset + 2]));

    // Align attribute length to 4-byte boundaries
    attr_length = (attr_length + 3) & ~0x3;

    if ((offset + 4 + attr_length) > payload_length)
        break; // Invalid attribute length

    switch (attr_type) {
        case 0x0001: // MAPPED-ADDRESS
            flow->guessed_host_protocol_id = NDPI_PROTOCOL_STUN;
            return(NDPI_IS_STUN);
        case 0x0005: // SOFTWARE
            if (memcmp(&payload[offset + 4], "WhatsApp", 8) == 0) {
                flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
                return(NDPI_IS_STUN);
            }
            break;
        case 0x8022: // ICE-CONTROLLED
        case 0x8023: // ICE-CONTROLLING
            flow->guessed_host_protocol_id = NDPI_PROTOCOL_HANGOUT_DUO;
            return(NDPI_IS_STUN);
        default:
            break;
    }

    offset += 4 + attr_length;
}