while(offset < payload_length) {
  u_int16_t attr_type, attr_len;
  
  if(offset + 4 > payload_length) {
    /* Not enough space for attribute header */
    break;
  }
  
  attr_type = ntohs(*((u_int16_t*)&payload[offset]));
  attr_len = ntohs(*((u_int16_t*)&payload[offset+2]));
  
  /* STUN attributes are aligned to 4 byte boundaries, add padding if necessary */
  u_int16_t padded_len = (attr_len + 3) & ~0x3;
  
  if(offset + 4 + padded_len > payload_length) {
    /* Invalid length or not enough space */
    break;
  }
  
  /* Skip header */
  offset += 4;
  
  /* Check for known STUN attribute types */
  switch(attr_type) {
    case 0x8054: /* Candidate Identifier - MS-ICE */
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE_TEAMS;
      return(NDPI_IS_STUN);
      
    case 0x8055: /* MS-TURN Software Attribute */
      if(attr_len >= 2 && offset + 2 <= payload_length) {
        if(memcmp(&payload[offset], "OC", 2) == 0) {
          flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE_TEAMS;
          return(NDPI_IS_STUN);
        }
      }
      break;
      
    case 0x8070: /* Implementation Version attribute */
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE_TEAMS;
      return(NDPI_IS_STUN);
      
    case 0x0014: /* Realm attribute */
      if(attr_len >= 7 && offset + 7 <= payload_length) {
        if(memcmp(&payload[offset], "zoom.us", 7) == 0) {
          flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
          return(NDPI_IS_STUN);
        }
      }
      break;
      
    case 0x0020: /* XOR-MAPPED-ADDRESS */
      /* WhatsApp/Facebook commonly use this */
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
      break;
      
    case 0x8031: /* GOOG-PING-INTERVAL-MS */
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_HANGOUT_DUO;
      return(NDPI_IS_STUN);
      
    case 0x4F4E: /* Facebook/Signal */
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_FACEBOOK;
      return(NDPI_IS_STUN);
      
    case 0xC057: /* Used by WhatsApp */
      flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
      return(NDPI_IS_STUN);
      
    case 0x0015: /* Nonce: sometimes helps identify services */
      if(attr_len > 0 && offset + attr_len <= payload_length) {
        if(attr_len >= 10 && memcmp(&payload[offset], "signal.org", 10) == 0) {
          flow->guessed_host_protocol_id = NDPI_PROTOCOL_SIGNAL;
          return(NDPI_IS_STUN);
        }
      }
      break;
  }
  
  /* Move to next attribute */
  offset += padded_len;
}