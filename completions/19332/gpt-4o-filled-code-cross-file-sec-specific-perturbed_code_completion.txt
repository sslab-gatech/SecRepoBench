while(offset < payload_length) {
        if((offset + 4) > payload_length) break;

        u_int16_t attr_type = ntohs(*((u_int16_t*)&payload[offset]));
        u_int16_t attr_length = ntohs(*((u_int16_t*)&payload[offset + 2]));

        if((offset + 4 + attr_length) > payload_length) break;

        switch(attr_type) {
          case 0x0001: /* MAPPED-ADDRESS */
          case 0x0002: /* RESPONSE-ADDRESS */
          case 0x0003: /* CHANGE-REQUEST */
          case 0x0004: /* SOURCE-ADDRESS */
          case 0x0005: /* CHANGED-ADDRESS */
          case 0x0006: /* USERNAME */
          case 0x0007: /* PASSWORD */
          case 0x0008: /* MESSAGE-INTEGRITY */
          case 0x0009: /* ERROR-CODE */
          case 0x000A: /* UNKNOWN-ATTRIBUTES */
          case 0x000B: /* REFLECTED-FROM */
            /* Known STUN attributes, continue processing */
            break;
          default:
            /* Unknown attribute, stop processing */
            offset = payload_length;
            break;
        }

        /* Align to 4-byte boundary */
        attr_length = (attr_length + 3) & ~3;
        offset += 4 + attr_length;
      }