/* Parse STUN attributes to identify sub-protocols */
u_int32_t message_end = offset + messagelength;
while((offset + 4) <= message_end) {
  /* Each STUN attribute has a 2-byte type + 2-byte length followed by the value */
  u_int16_t attr_type = ntohs(*((u_int16_t*)&payload[offset]));
  u_int16_t attr_len  = ntohs(*((u_int16_t*)&payload[offset + 2]));

  offset += 4;
  if(attr_len > 0 && (offset + attr_len) <= message_end) {
    /* Check specific attribute types to detect known subprotocols */
    if(attr_type == 0x8022) { /* SOFTWARE attribute */
      const u_int8_t *software_str = &payload[offset];
      /* Look for known strings within the SOFTWARE attribute */
      if(memmem(software_str, attr_len, "Skype", 5) != NULL) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE;
        break;
      } else if(memmem(software_str, attr_len, "Zoom", 4) != NULL) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
        break;
      } else if(memmem(software_str, attr_len, "WhatsApp", 8) != NULL) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
        break;
      } else if(memmem(software_str, attr_len, "MBFB", 4) != NULL) {
        flow->guessed_host_protocol_id = NDPI_PROTOCOL_MESSENGER;
        break;
      }
    }

    /* STUN attribute lengths must be padded to 32-bit alignment */
    attr_len = ((attr_len + 3) / 4) * 4;
    offset += attr_len;
  } else {
    /* Malformed attribute, stop parsing */
    break;
  }
}