while(offset + 4 <= payload_length) {
  u_int16_t attr_type, attr_len;

  attr_type = ntohs(*((u_int16_t*)&payload[offset]));
  attr_len = ntohs(*((u_int16_t*)&payload[offset+2]));

  /* Padding: attribute length must be a multiple of 4 bytes */
  u_int16_t padded_len = (attr_len + 3) & ~0x3;

  if((offset + 4 + attr_len) > payload_length) {
    /* Malformed attribute (length would go beyond packet boundary) */
    break;
  }

  /* Look for specific attribute types to identify protocols */
  if(attr_type == 0x8054 || attr_type == 0x8055) {
    /* These are found in MS Lync/Skype */
    flow->guessed_host_protocol_id = NDPI_PROTOCOL_SKYPE_TEAMS;
    return(NDPI_IS_STUN);
  } 
  else if(attr_type == 0x8070) {
    /* This is typically found in WhatsApp calls */
    flow->guessed_host_protocol_id = NDPI_PROTOCOL_WHATSAPP_CALL;
    return(NDPI_IS_STUN);
  }
  else if(attr_type == 0x0020) { /* XOR-MAPPED-ADDRESS */
    /* Generic STUN attribute, continue processing */
  }
  else if(attr_type == 0x8031) {
    /* Zoom uses this */
    flow->guessed_host_protocol_id = NDPI_PROTOCOL_ZOOM;
    return(NDPI_IS_STUN);
  }
  
  /* Move to the next attribute */
  offset += 4 + padded_len;
  
  /* Make sure we don't exceed the packet boundary */
  if(offset >= payload_length)
    break;
}