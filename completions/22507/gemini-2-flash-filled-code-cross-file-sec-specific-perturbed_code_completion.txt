mrb_float fval = mrb_float(GETARG());
        char fbuf[128];
        int need;

        if (isinf(fval)) {
          const char *infstr = "Inf";
          char sign = 0;
          int len = (int)strlen(infstr);

          if (fval < 0) {
            sign = '-';
          }
          else if (flags & FPLUS) {
            sign = '+';
          }
          else if (flags & FSPACE) {
            sign = ' ';
          }

          if (sign) {
            len++;
            width--;
          }

          if (!(flags & FMINUS) && width > len) {
            FILL(' ', width - len);
          }

          if (sign) {
            PUSH(&sign, 1);
          }

          PUSH(infstr, strlen(infstr));

          if ((flags & FMINUS) && width > len) {
            FILL(' ', width - len);
          }
        }
        else if (isnan(fval)) {
          const char *nanstr = "NaN";
          int len = (int)strlen(nanstr);

          if (!(flags & FMINUS) && width > len) {
            FILL(' ', width - len);
          }

          PUSH(nanstr, strlen(nanstr));

          if ((flags & FMINUS) && width > len) {
            FILL(' ', width - len);
          }
        }
        else {