mrb_value val = GETARG();
        mrb_float fval;
        char fbuf[32];
        int need;

        if (mrb_float_p(val)) {
          fval = mrb_float(val);
        }
        else if (mrb_fixnum_p(val)) {
          fval = (mrb_float)mrb_fixnum(val);
        }
        else {
          val = mrb_to_float(mrb, val);
          fval = mrb_float(val);
        }

        if (isnan(fval)) {
          const char *nan_str = "NaN";
          if (fval < 0) {
            PUSH("-", 1);
          }
          else if (flags & FPLUS) {
            PUSH("+", 1);
          }
          else if (flags & FSPACE) {
            PUSH(" ", 1);
          }
          PUSH(nan_str, 3);
          break;
        }

        if (isinf(fval)) {
          const char *inf_str = "Inf";
          if (fval < 0) {
            PUSH("-", 1);
          }
          else if (flags & FPLUS) {
            PUSH("+", 1);
          }
          else if (flags & FSPACE) {
            PUSH(" ", 1);
          }
          PUSH(inf_str, 3);
          break;
        }