{
  mrb_value val = GETARG();
  mrb_float fval = mrb_to_flo(mrb, val);
  char sc = 0;

  /* handle sign if needed */
  if (fval < 0) {
    sc = '-';
    fval = -fval;
    width--;
  }
  else if (flags & FPLUS) {
    sc = '+';
    width--;
  }
  else if (flags & FSPACE) {
    sc = ' ';
    width--;
  }

  /* check for NaN or Infinity */
  if (isnan(fval)) {
    mrb_int len = 3 + (sc ? 1 : 0);
    if (!(flags & FMINUS) && width > 0 && width > len) FILL(' ', width - len);
    if (sc) PUSH(&sc, 1);
    PUSH("NaN", 3);
    if ((flags & FMINUS) && width > 0 && width > len) FILL(' ', width - len);
    break;
  }
  else if (isinf(fval)) {
    mrb_int len = 3 + (sc ? 1 : 0);
    if (!(flags & FMINUS) && width > 0 && width > len) FILL(' ', width - len);
    if (sc) PUSH(&sc, 1);
    PUSH("Inf", 3);
    if ((flags & FMINUS) && width > 0 && width > len) FILL(' ', width - len);
    break;
  }
}