mrb_value val = GETARG();
        mrb_float fval;
        char fbuf[32];
        mrb_int need;
        char sign = 0;

        if (mrb_float_p(val)) {
          fval = mrb_float(val);
        }
        else {
          val = mrb_to_float(mrb, val);
          fval = mrb_float(val);
        }

        if (isnan(fval)) {
          if (fval < 0) {
            sign = '-';
          }
          else if (flags & FPLUS) {
            sign = '+';
          }
          else if (flags & FSPACE) {
            sign = ' ';
          }
          if (sign) {
            PUSH(&sign, 1);
          }
          PUSH("NaN", 3);
          break;
        }
        if (isinf(fval)) {
          if (fval < 0) {
            sign = '-';
          }
          else if (flags & FPLUS) {
            sign = '+';
          }
          else if (flags & FSPACE) {
            sign = ' ';
          }
          if (sign) {
            PUSH(&sign, 1);
          }
          PUSH("Inf", 3);
          break;
        }