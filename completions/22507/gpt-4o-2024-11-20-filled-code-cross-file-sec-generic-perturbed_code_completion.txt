mrb_float fval = mrb_to_flo(mrb, GETARG());
        char fbuf[32];
        int need;

        if (!isfinite(fval)) {
          const char *special = NULL;
          char sign = 0;

          if (isnan(fval)) {
            special = "NaN";
          } else if (isinf(fval)) {
            special = "Inf";
          }

          if (fval < 0) {
            sign = '-';
          } else if (flags & FPLUS) {
            sign = '+';
          } else if (flags & FSPACE) {
            sign = ' ';
          }

          if (sign) {
            PUSH(&sign, 1);
          }
          if (special) {
            PUSH(special, strlen(special));
          }
          break;
        }

        fmt_setup(fbuf, sizeof(fbuf), *p, flags, width, prec);
        need = snprintf(NULL, 0, fbuf, fval);
        if (need < 0 || need > MRB_INT_MAX) {
          mrb_raise(mrb, E_ARGUMENT_ERROR, "formatted string too long");
        }

        CHECK(need);
        n = snprintf(&buf[blen], need + 1, fbuf, fval);
        if (n < 0 || n != need) {
          mrb_raise(mrb, E_RUNTIME_ERROR, "formatting error");
        }
        blen += n;