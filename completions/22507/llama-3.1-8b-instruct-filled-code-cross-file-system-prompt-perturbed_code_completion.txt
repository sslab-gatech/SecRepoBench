#ifndef MRB_WITHOUT_FLOAT
      case 'f':
      case 'g':
      case 'G':
      case 'e':
      case 'E':
      case 'a':
      case 'A': {
        // Check if the next argument is finite. If the value is NaN (Not a Number) or
        // Infinity, prepare to format it as "NaN" or "Inf" respectively, 
        // including potential sign handling ('+' or'' for positive numbers if specified).
        // Calculate the number of characters needed for representation. 
        // Handle padding and alignment (left or right) based on flags before storing the result
        // in the buffer.
        mrb_float fval = mrb_float_value(mrb, GETARG());
        mrb_value str = mrb_undef_value();
        int need = 0;
        int i;
        int sign = 0;
        char *fbuf = mrb_malloc(mrb, sizeof(fbuf));
        fmt_setup(fbuf, sizeof(fbuf), *p, flags, width, prec);
        if (*p!= 'e' && *p!= 'E') {
          frexp(fval, &i);
          if (i > 0)
            need = BIT_DIGITS(i);
        }
        if (need > MRB_INT_MAX - ((flags&FPREC)? prec : 6)) {
        too_big_width:
          mrb_raise(mrb, E_ARGUMENT_ERROR,
                    (width > prec? "width too big" : "prec too big"));
        }
        need += (flags&FPREC)? prec : 6;
        if ((flags&FWIDTH) && need < width)
          need = width;
        if (need > MRB_INT_MAX - 20) {
          goto too_big_width;
        }
        need += 20;

        CHECK(need);
        if (fval == mrb_nan_value(mrb)) {
          mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "NaN"), mrb_str_new_cstr(mrb, "NaN"), mrb_str_new_cstr(mrb, "NaN"), mrb_str_new_cstr(mrb, "NaN"));
        } else if (fval == mrb_posinf_value(mrb)) {
          mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "Inf"), mrb_str_new_cstr(mrb, "Inf"), mrb_str_new_cstr(mrb, "Inf"), mrb_str_new_cstr(mrb, "Inf"));
        } else if (fval == mrb_neginf_value(mrb)) {
          mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "-Inf"), mrb_str_new_cstr(mrb, "-Inf"), mrb_str_new_cstr(mrb, "-Inf"), mrb_str_new_cstr(mrb, "-Inf"));
        } else {
          mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        }
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"));
        mrb_str_aset(mrb, str, mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mrb_str_new_cstr(mrb, "0"), mr