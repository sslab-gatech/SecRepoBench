double fval = mrb_float(val);
        char fbuf[32];
        int need;

        if (isnan(fval)) {
          const char *nan_str = "NaN";
          int len = strlen(nan_str);
          CHECK(len);
          PUSH(nan_str, len);
          if (width > len) {
            FILL(' ', width - len);
          }
          break;
        } else if (isinf(fval)) {
          const char *inf_str = (fval > 0) ? "Inf" : "-Inf";
          int len = strlen(inf_str);
          CHECK(len);
          PUSH(inf_str, len);
          if (width > len) {
            FILL(' ', width - len);
          }
          break;
        }

        fmt_setup(fbuf, sizeof(fbuf), *p, flags, width, prec);
        need = 0;
        if (*p != 'e' && *p != 'E') {
          int i;
          frexp(fval, &i);
          if (i > 0)
            need = BIT_DIGITS(i);
        }
        if (need > MRB_INT_MAX - ((flags&FPREC) ? prec : 6)) {
          goto too_big_width;
        }
        need += (flags&FPREC) ? prec : 6;
        if ((flags&FWIDTH) && need < width)
          need = width;
        if (need > MRB_INT_MAX - 20) {
          goto too_big_width;
        }
        need += 20;

        CHECK(need);
        n = mrb_float_to_cstr(mrb, &buf[blen], need, fbuf, fval);
        if (n < 0 || n >= need) {
          mrb_raise(mrb, E_RUNTIME_ERROR, "formatting error");
        }
        blen += n;