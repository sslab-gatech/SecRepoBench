mrb_value val = GETARG();
mrb_float fval;

if (!mrb_float_p(val)) {
  val = mrb_to_flo(mrb, val);
}
fval = mrb_float(val);

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  char sign = '\0';

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }

  need = (int)strlen(expr);
  if (!isnan(fval) && fval < 0.0)
    sign = '-';
  else if (flags & (FPLUS|FSPACE))
    sign = (flags & FPLUS) ? '+' : ' ';

  if (sign)
    need++;

  if ((flags & FWIDTH) && need < width)
    need = width;

  CHECK(need + 1);

  if ((flags & FMINUS) == 0) {
    FILL(' ', need - ((sign ? 1 : 0) + (int)strlen(expr)));
  }

  if (sign)
    PUSH(&sign, 1);
  PUSH(expr, (int)strlen(expr));

  if (flags & FMINUS) {
    FILL(' ', need - ((sign ? 1 : 0) + (int)strlen(expr)));
  }
  break;
}

#ifndef MRB_WITHOUT_FLOAT
char fbuf[32];
int need;
#endif