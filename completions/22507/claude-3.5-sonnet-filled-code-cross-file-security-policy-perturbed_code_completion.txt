mrb_value val = GETARG();
mrb_float fval;

fval = mrb_to_flo(mrb, val);
if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  int sign = 0;

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  need = (int)strlen(expr);
  if (!isnan(fval) && fval < 0.0)
    sign = 1;
  else if (flags & (FPLUS|FSPACE))
    sign = (flags & FPLUS) ? '+' : ' ';
  if (sign)
    need++;
  if ((flags & FWIDTH) && need < width)
    need = width;

  CHECK(need + 1);
  snprintf(&buf[blen], need + 1, "%*s%s", 
           (flags & FMINUS) ? -width : width, "", expr);
  if (sign) {
    if (flags & FMINUS)
      buf[blen] = sign;
    else
      buf[blen + ((flags & FWIDTH) ? (width - need + 1) : 0)] = sign;
  }
  blen += strlen(&buf[blen]);
}
else {
  char fbuf[32];