mrb_value val = GETARG();
mrb_float fval;

if (mrb_float_p(val)) {
  fval = mrb_float(val);
} else {
  fval = mrb_to_flo(mrb, val);
}

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need = 3;

  if (isnan(fval)) {
    expr = "NaN";
  } else {
    expr = "Inf";
  }

  if (flags & FPLUS) {
    need++;
  } else if (flags & FSPACE) {
    need++;
  }

  if (flags & FWIDTH) {
    need = (width > need) ? width : need;
  }

  CHECK(need);

  if (flags & FMINUS) {
    if (flags & FPLUS) {
      PUSH("+", 1);
    } else if (flags & FSPACE) {
      PUSH(" ", 1);
    }
    PUSH(expr, 3);
    if (need > 3) {
      FILL(' ', need - 3);
    }
  } else {
    if (need > 3) {
      FILL(' ', need - 3);
    }
    if (flags & FPLUS) {
      PUSH("+", 1);
    } else if (flags & FSPACE) {
      PUSH(" ", 1);
    }
    PUSH(expr, 3);
  }
  break;
}

if ((flags & FWIDTH) && width > MRB_INT_MAX) {
  mrb_raise(mrb, E_ARGUMENT_ERROR, "width too big");
}
if ((flags & FPREC) && prec > MRB_INT_MAX) {
  mrb_raise(mrb, E_ARGUMENT_ERROR, "prec too big");
}

char fbuf[32];