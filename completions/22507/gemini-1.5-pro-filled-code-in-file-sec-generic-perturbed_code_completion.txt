mrb_value val = GETARG();
        double fval;
        char fbuf[32];
        int need;

        fval = mrb_float(mrb, val);
        if (isnan(fval)) {
          const char *expr = "NaN";
          int expr_len = 3;
          if(flags & FPLUS) {
            CHECK(expr_len + 1);
            *buf++ = '+'; blen++;
          } else if (flags & FSPACE) {
            CHECK(expr_len + 1);
            *buf++ = ' '; blen++;
          }
          CHECK(expr_len);
          memcpy(buf, expr, expr_len);
          blen += expr_len;
          break;
        }
        else if (isinf(fval)) {
          const char *expr = (fval > 0 ? "Inf" : "-Inf");
          int expr_len = (fval > 0 ? 3 : 4);
          if(fval > 0 && (flags & FPLUS)) {
            CHECK(expr_len + 1);
            *buf++ = '+'; blen++;
          } else if (fval > 0 && (flags & FSPACE)) {
            CHECK(expr_len + 1);
            *buf++ = ' '; blen++;
          }
          CHECK(expr_len);
          memcpy(buf, expr, expr_len);
          blen += expr_len;
          break;
        }