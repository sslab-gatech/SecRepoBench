#ifndef MRB_WITHOUT_FLOAT
static void
fmt_setup(char *buf, size_t size, int c, int flags, mrb_int width, mrb_int prec)
{
  char *end = buf + size;
  int n;

  *buf++ = '%';
  if (flags & FSHARP) *buf++ = '#';
  if (flags & FPLUS)  *buf++ = '+';
  if (flags & FMINUS) *buf++ = '-';
  if (flags & FZERO)  *buf++ = '0';
  if (flags & FSPACE) *buf++ ='';

  if (flags & FWIDTH) {
    n = mrb_int2str(buf, end - buf, width);
    buf += n;
  }

  if (flags & FPREC) {
    *buf ++ = '.';
    n = mrb_int2str(buf, end - buf, prec);
    buf += n;
  }

  *buf++ = c;
  *buf = '\0';

  if (c == 'f' || c == 'g' || c == 'G' || c == 'e' || c == 'E' || c == 'a' || c == 'A') {
    mrb_float fval;
    int need;
    char fbuf[66];

    fval = mrb_to_f(mrb, GETARG());
    if (mrb_float_is_nan(fval)) {
      if (c == 'f' || c == 'g' || c == 'G') {
        mrb_str_buf_cat(mrb, buf, 3);
        mrb_str_buf_cat(mrb, buf, "nan");
      }
      else if (c == 'e' || c == 'E') {
        mrb_str_buf_cat(mrb, buf, 3);
        mrb_str_buf_cat(mrb, buf, "nan");
        mrb_str_buf_cat(mrb, buf, "e");
      }
      else if (c == 'a' || c == 'A') {
        mrb_str_buf_cat(mrb, buf, 3);
        mrb_str_buf_cat(mrb, buf, "nan");
        mrb_str_buf_cat(mrb, buf, "a");
      }
    }
    else if (mrb_float_is_infinity(fval)) {
      if (c == 'f' || c == 'g' || c == 'G') {
        mrb_str_buf_cat(mrb, buf, 3);
        mrb_str_buf_cat(mrb, buf, "inf");
      }
      else if (c == 'e' || c == 'E') {
        mrb_str_buf_cat(mrb, buf, 3);
        mrb_str_buf_cat(mrb, buf, "inf");
        mrb_str_buf_cat(mrb, buf, "e");
      }
      else if (c == 'a' || c == 'A') {
        mrb_str_buf_cat(mrb, buf, 3);
        mrb_str_buf_cat(mrb, buf, "inf");
        mrb_str_buf_cat(mrb, buf, "a");
      }
    }
    else {
      int i;
      frexp(fval, &i);
      if (i > 0)
        need = BIT_DIGITS(i);
      if (need > MRB_INT_MAX - ((flags&FPREC)? prec : 6)) {
        too_big_width:
          mrb_raise(mrb, E_ARGUMENT_ERROR,
                    (width > prec? "width too big" : "prec too big"));
      }
      need += (flags&FPREC)? prec : 6;
      if ((flags&FWIDTH) && need < width)
        need = width;
      if (need > MRB_INT_MAX - 20) {
        goto too_big_width;
      }
      need += 20;

      CHECK(need);
      n = mrb_float_to_cstr(mrb, &buf[blen], need, fbuf, fval);
      if (n < 0 || n >= need) {
        mrb_raise(mrb, E_RUNTIME_ERROR, "formatting error");
      }
      blen += n;
    }
  }
}
#endif