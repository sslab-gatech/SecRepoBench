{
  mrb_value fvalv = GETARG();
  mrb_float fval;
  char fbuf[32];
  int need;
  char sign = 0;
  int is_nan = 0, is_inf = 0;

  fval = mrb_to_flo(mrb, fvalv);

  /* Check for NaN and Infinity */
  if (isnan(fval)) {
    is_nan = 1;
  }
  else if (isinf(fval)) {
    is_inf = 1;
    if (fval < 0) sign = '-';
    else if (flags & FPLUS) sign = '+';
    else if (flags & FSPACE) sign = ' ';
  }
  else if (fval < 0) {
    sign = '-';
  }
  else if (flags & FPLUS) {
    sign = '+';
  }
  else if (flags & FSPACE) {
    sign = ' ';
  }

  if (is_nan || is_inf) {
    const char *str;
    int slen;
    if (is_nan) {
      str = "NaN";
      slen = 3;
    }
    else {
      str = "Inf";
      slen = 3;
    }
    need = slen + (sign ? 1 : 0);
    if ((flags & FWIDTH) && width > need) {
      int pad = width - need;
      if (!(flags & FMINUS)) {
        FILL(' ', pad);
      }
      if (sign) PUSH(&sign, 1);
      PUSH(str, slen);
      if (flags & FMINUS) {
        FILL(' ', pad);
      }
    }
    else {
      if (sign) PUSH(&sign, 1);
      PUSH(str, slen);
    }
    break;
  }
}