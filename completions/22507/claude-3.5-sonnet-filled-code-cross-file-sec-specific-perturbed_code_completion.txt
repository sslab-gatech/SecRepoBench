mrb_value val = GETARG();
mrb_float fval;

if (mrb_float_p(val)) {
  fval = mrb_float(val);
} else {
  fval = mrb_to_flo(mrb, val);
}

char fbuf[32];
int need;

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int sign = 0;
  
  if (isnan(fval)) {
    expr = "NaN";
  } else {
    expr = "Inf";
    if (fval < 0) sign = 1;
  }
  
  need = (int)strlen(expr) + sign;
  if (flags & FPLUS || flags & FSPACE) need++;
  
  if (width > need) {
    need = width;
  }
  
  CHECK(need);
  
  if (!(flags & FMINUS)) {
    FILL(' ', width - need + sign);
  }
  
  if (flags & FPLUS && !sign) {
    PUSH("+", 1);
  } else if (flags & FSPACE && !sign) {
    PUSH(" ", 1);
  }
  
  if (sign) {
    PUSH("-", 1);
  }
  
  PUSH(expr, strlen(expr));
  
  if (flags & FMINUS) {
    FILL(' ', width - need + sign);
  }
  
  break;
}