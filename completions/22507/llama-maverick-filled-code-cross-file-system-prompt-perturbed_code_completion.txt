mrb_value val = GETARG();
mrb_float fval;
char fbuf[64];
int need;

fval = mrb_to_flo(mrb, val);
if (isnan(fval)) {
  const char *str = "NaN";
  int n = (flags&FMINUS) ? -3 : 3;
  if (flags&FPLUS) n++;
  else if (flags&FSPACE) n++;
  need = (n > width) ? n : width;
  CHECK(need);
  if ((flags&(FZERO|FMINUS)) == FZERO) {
    FILL('0', need - n);
  }
  else {
    FILL(' ', need - n);
  }
  if (flags&FPLUS) {
    PUSH("+", 1);
  }
  else if (flags&FSPACE) {
    PUSH(" ", 1);
  }
  PUSH(str, 3);
  if (flags&FMINUS) {
    FILL(' ', need - n);
  }
  break;
}
if (isinf(fval)) {
  const char *str = (fval > 0) ? "Inf" : "-Inf";
  int n = (fval > 0) ? 3 : 4;
  int sign = (fval > 0) ? 1 : -1;
  if (flags&FPLUS) n++;
  else if (flags&FSPACE) n++;
  need = (n > width) ? n : width;
  CHECK(need);
  if ((flags&(FZERO|FMINUS)) == FZERO) {
    FILL('0', need - n);
  }
  else {
    FILL(' ', need - n);
  }
  if (sign > 0 && (flags&FPLUS)) {
    PUSH("+", 1);
  }
  else if (sign > 0 && (flags&FSPACE)) {
    PUSH(" ", 1);
  }
  PUSH(str, n);
  if (flags&FMINUS) {
    FILL(' ', need - n);
  }
  break;
}