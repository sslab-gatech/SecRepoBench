mrb_value val = GETARG();
char fbuf[32];
mrb_float fval;
int need;

fval = mrb_Float(mrb, val);

if (isnan(fval)) {
  const char *expr = "NaN";
  int len = 3;
  int pad = 0;
  
  if ((flags & FWIDTH) && (width > len)) {
    pad = width - len;
  }
  
  CHECK(pad + len);
  if (!(flags & FMINUS)) {
    FILL(' ', pad);
  }
  PUSH(expr, len);
  if (flags & FMINUS) {
    FILL(' ', pad);
  }
  break;
}
if (isinf(fval)) {
  const char *expr = "Inf";
  int len = 3;
  int sign_len = 0;
  int pad = 0;
  
  if (fval < 0) {
    sign_len = 1;  // for '-'
  }
  else if (flags & FPLUS) {
    sign_len = 1;  // for '+'
  }
  else if (flags & FSPACE) {
    sign_len = 1;  // for ' '
  }
  
  if ((flags & FWIDTH) && (width > len + sign_len)) {
    pad = width - len - sign_len;
  }
  
  CHECK(pad + len + sign_len);
  
  if (!(flags & FMINUS)) {
    FILL(' ', pad);
  }
  
  if (fval < 0) {
    char sign = '-';
    PUSH(&sign, 1);
  }
  else if (flags & FPLUS) {
    char sign = '+';
    PUSH(&sign, 1);
  }
  else if (flags & FSPACE) {
    char sign = ' ';
    PUSH(&sign, 1);
  }
  
  PUSH(expr, len);
  
  if (flags & FMINUS) {
    FILL(' ', pad);
  }
  break;
}