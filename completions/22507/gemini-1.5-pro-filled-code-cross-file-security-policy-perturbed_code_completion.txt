mrb_float fval;
        char fbuf[24];
        int need;
        int n;

        fval = mrb_float(GETARG());
        if (isnan(fval)) {
          need = snprintf(NULL, 0, "NaN");
          CHECK(need);
          n = snprintf(&buf[blen], need + 1, "NaN");
          blen += n;
          break;
        }
        if (isinf(fval)) {
          if (fval > 0.0) {
            if (flags & FPLUS) {
              need = snprintf(NULL, 0, "+Inf");
              CHECK(need);
              n = snprintf(&buf[blen], need + 1, "+Inf");
            }
            else if (flags & FSPACE) {
              need = snprintf(NULL, 0, " Inf");
              CHECK(need);
              n = snprintf(&buf[blen], need + 1, " Inf");
            }
            else {
              need = snprintf(NULL, 0, "Inf");
              CHECK(need);
              n = snprintf(&buf[blen], need + 1, "Inf");
            }
          }
          else {
            need = snprintf(NULL, 0, "-Inf");
            CHECK(need);
            n = snprintf(&buf[blen], need + 1, "-Inf");
          }
          blen += n;
          break;
        }