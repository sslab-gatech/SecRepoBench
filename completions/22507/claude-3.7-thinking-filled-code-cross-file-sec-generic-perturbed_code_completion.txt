mrb_value val = GETARG();
char fbuf[32];
mrb_float fval;
mrb_int need;

fval = mrb_to_flo(mrb, val);
if (isnan(fval) || isinf(fval)) {
  const char *expr;
  mrb_int size;
  mrb_int sign_width = 0;
  char sign = '\0';

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
    if (fval < 0) {
      sign = '-';
      sign_width = 1;
    }
    else if (flags & FPLUS) {
      sign = '+';
      sign_width = 1;
    }
    else if (flags & FSPACE) {
      sign = ' ';
      sign_width = 1;
    }
  }
  
  size = strlen(expr) + sign_width;
  need = (width > size) ? width : size;
  
  CHECK(need);
  
  if (width > size) {
    if (flags & FMINUS) { /* left alignment */
      if (sign) PUSH(&sign, 1);
      PUSH(expr, strlen(expr));
      FILL(' ', width - size);
    }
    else {
      if ((flags & FZERO) && !isnan(fval)) {
        if (sign) PUSH(&sign, 1);
        FILL('0', width - size);
        PUSH(expr, strlen(expr));
      }
      else {
        FILL(' ', width - size);
        if (sign) PUSH(&sign, 1);
        PUSH(expr, strlen(expr));
      }
    }
  }
  else {
    if (sign) PUSH(&sign, 1);
    PUSH(expr, strlen(expr));
  }
  
  break;
}