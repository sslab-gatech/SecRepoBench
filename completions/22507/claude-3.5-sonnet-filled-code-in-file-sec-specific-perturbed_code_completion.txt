mrb_value val = GETARG();
mrb_float fval;

if (mrb_float_p(val)) {
  fval = mrb_float(val);
} else {
  fval = mrb_to_flo(mrb, val);
}

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  int sign = 0;

  if (isnan(fval)) {
    expr = "NaN";
  } else {
    expr = "Inf";
  }

  need = (int)strlen(expr);
  if (!isnan(fval) && fval < 0.0)
    sign = 1;
  else if (flags & (FPLUS|FSPACE))
    sign = (flags & FPLUS) ? '+' : ' ';
  if (sign)
    need++;
  if ((flags & FWIDTH) && need < width)
    need = width;

  CHECK(need);
  if ((flags & FMINUS) == 0) {
    FILL(' ', need - sign - (int)strlen(expr));
  }
  if (sign) {
    buf[blen++] = sign;
  }
  memcpy(&buf[blen], expr, strlen(expr));
  blen += strlen(expr);
  if (flags & FMINUS) {
    FILL(' ', need - sign - (int)strlen(expr));
  }
  break;
}

char fbuf[32];
int need;