mrb_float fval;
mrb_value val = GETARG();
char fbuf[32];
int need;

/* convert to float */
switch (mrb_type(val)) {
case MRB_TT_FLOAT:
  fval = mrb_float(val);
  break;
case MRB_TT_FIXNUM:
  fval = (mrb_float)mrb_fixnum(val);
  break;
default:
  val = mrb_Float(mrb, val);
  fval = mrb_float(val);
  break;
}

/* check for infinity and NaN */
if (isinf(fval) || isnan(fval)) {
  const char *expr;
  size_t len;
  
  if (isinf(fval)) {
    if (fval < 0) {
      expr = "-Inf";
    }
    else if (flags & FPLUS) {
      expr = "+Inf";
    }
    else if (flags & FSPACE) {
      expr = " Inf";
    }
    else {
      expr = "Inf";
    }
  }
  else {  /* NaN */
    if (flags & FPLUS) {
      expr = "+NaN";
    }
    else if (flags & FSPACE) {
      expr = " NaN";
    }
    else {
      expr = "NaN";
    }
  }
  
  len = strlen(expr);
  
  if (!(flags & FMINUS) && (flags & FWIDTH) && width > len) {
    FILL(' ', width - len);
  }
  
  PUSH(expr, len);
  
  if ((flags & FMINUS) && (flags & FWIDTH) && width > len) {
    FILL(' ', width - len);
  }
  
  break;
}