mrb_value val = GETARG();
mrb_float fval;
char fbuf[32];
mrb_int need;

switch (mrb_type(val)) {
  case MRB_TT_FLOAT:
    fval = mrb_float(val);
    break;
  case MRB_TT_FIXNUM:
    fval = (mrb_float)mrb_fixnum(val);
    break;
  default:
    val = mrb_Float(mrb, val);
    fval = mrb_float(val);
}

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int sign;
  
  if (isnan(fval)) {
    expr = "NaN";
    sign = 0;
  }
  else {
    expr = "Inf";
    sign = (fval < 0) ? -1 : 1;
  }
  
  need = (int)strlen(expr) + (sign < 0 ? 1 : 0);
  if (sign > 0 && (flags & (FPLUS|FSPACE))) need++;
  
  if ((flags & FWIDTH) && need < width) {
    need = width;
  }
  
  CHECK(need + 1);
  
  if (flags & FMINUS) {
    if (sign < 0) {
      PUSH("-", 1);
    }
    else if (flags & FPLUS) {
      PUSH("+", 1);
    }
    else if (flags & FSPACE) {
      PUSH(" ", 1);
    }
    PUSH(expr, (int)strlen(expr));
    if (need > (int)strlen(expr) + (sign < 0 || (flags & (FPLUS|FSPACE)) ? 1 : 0))
      FILL(' ', need - ((int)strlen(expr) + (sign < 0 || (flags & (FPLUS|FSPACE)) ? 1 : 0)));
  }
  else {
    if (need > (int)strlen(expr) + (sign < 0 || (flags & (FPLUS|FSPACE)) ? 1 : 0))
      FILL(' ', need - ((int)strlen(expr) + (sign < 0 || (flags & (FPLUS|FSPACE)) ? 1 : 0)));
    if (sign < 0) {
      PUSH("-", 1);
    }
    else if (flags & FPLUS) {
      PUSH("+", 1);
    }
    else if (flags & FSPACE) {
      PUSH(" ", 1);
    }
    PUSH(expr, (int)strlen(expr));
  }
  break;
}