mrb_float fval = mrb_float(GETARG());
char fbuf[256];
int need;
char *buf = RSTRING_PTR(result);

        if (isnan(fval)) {
          const char *expr = "NaN";
          int explen = 3;
          if ((flags & FPLUS) || (flags & FSPACE)) explen++;
          if (!(flags&FWIDTH) || width <= explen) {
            if (flags & FPLUS) PUSH("+", 1);
            else if (flags & FSPACE) PUSH(" ", 1);
            PUSH(expr, explen - ((flags & FPLUS) || (flags & FSPACE)));
          }
          else {
            FILL(' ', width - explen);
            if (flags & FPLUS) PUSH("+", 1);
            else if (flags & FSPACE) PUSH(" ", 1);
            PUSH(expr, explen - ((flags & FPLUS) || (flags & FSPACE)));
          }
          break;
        }
        else if (isinf(fval)) {
          const char *expr = (fval > 0.0) ? "Inf" : "-Inf";
          int explen = (fval > 0.0) ? 3 : 4;
          if (fval > 0.0 && (flags & FPLUS)) explen++;
          else if (fval > 0.0 && (flags & FSPACE)) explen++;

          if (!(flags&FWIDTH) || width <= explen) {
            if (fval > 0.0 && flags & FPLUS) PUSH("+", 1);
            else if (fval > 0.0 && flags & FSPACE) PUSH(" ", 1);
            PUSH(expr, explen - ((fval > 0.0 && (flags & FPLUS)) || (fval > 0.0 && (flags & FSPACE))));
          }
          else {
            FILL(' ', width - explen);
            if (fval > 0.0 && flags & FPLUS) PUSH("+", 1);
            else if (fval > 0.0 && flags & FSPACE) PUSH(" ", 1);
            PUSH(expr, explen - ((fval > 0.0 && (flags & FPLUS)) || (fval > 0.0 && (flags & FSPACE))));
          }
          break;
        }