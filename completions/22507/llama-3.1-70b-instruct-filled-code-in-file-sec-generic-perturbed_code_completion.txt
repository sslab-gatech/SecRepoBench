mrb_value val = GETARG();
double fval = mrb_float(mrb, val);
char sign = 0;
char *fbuf = buf;
int need;

if (isinf(fval)) {
  if (fval > 0) {
    if (flags & FPLUS) {
      sign = '+';
    }
    else if (flags & FSPACE) {
      sign ='';
    }
  }
  else {
    sign = '-';
  }
  if (flags & FSHARP) {
    if (*p == 'a' || *p == 'A') {
      sign = 0;
    }
  }
  if (sign) {
    width--;
  }
  if (flags & FWIDTH) {
    if (width < 0) {
      flags |= FMINUS;
      width = -width;
    }
  }
  if (!(flags & FMINUS)) {
    if (width > 0) {
      FILL(' ', width);
    }
  }
  if (sign) {
    PUSH(&sign, 1);
  }
  if (fval > 0) {
    PUSH("Inf", 3);
  }
  else {
    PUSH("-Inf", 4);
  }
  if (flags & FMINUS) {
    if (width > 0) {
      FILL(' ', width);
    }
  }
  break;
}
if (isnan(fval)) {
  if (flags & FPLUS) {
    sign = '+';
  }
  else if (flags & FSPACE) {
    sign ='';
  }
  if (sign) {
    width--;
  }
  if (flags & FWIDTH) {
    if (width < 0) {
      flags |= FMINUS;
      width = -width;
    }
  }
  if (!(flags & FMINUS)) {
    if (width > 0) {
      FILL(' ', width);
    }
  }
  if (sign) {
    PUSH(&sign, 1);
  }
  PUSH("NaN", 3);
  if (flags & FMINUS) {
    if (width > 0) {
      FILL(' ', width);
    }
  }
  break;
}