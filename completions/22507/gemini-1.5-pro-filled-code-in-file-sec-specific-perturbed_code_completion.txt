mrb_value val = GETARG();
        char fbuf[32], *fmt;
        mrb_float fval;
        int need;

        switch (mrb_type(val)) {
        case MRB_TT_FLOAT:
            fval = mrb_float(val);
            break;
        case MRB_TT_STRING:
            val = mrb_str_to_inum(mrb, val, 0, TRUE);
            /* fall through */
        case MRB_TT_FIXNUM:
#ifndef MRB_WITHOUT_FLOAT
            fval = (mrb_float)mrb_fixnum(val);
#else
            fval = mrb_fixnum(val);
#endif
            break;
        default:
            val = mrb_Float(mrb, val);
            fval = mrb_float(val);
            break;
        }

        if (isnan(fval)) {
            fmt = "NaN";
            if (flags & (FPLUS|FSPACE)) {
                CHECK(4);
                if (flags & FPLUS) *buf++ = '+';
                else *buf++ = ' ';
                memcpy(buf, fmt, 3);
                blen += 4;
            } else {
                CHECK(3);
                memcpy(buf, fmt, 3);
                blen += 3;
            }
            break;
        }
        if (isinf(fval)) {
            fmt = (fval > 0.0) ? "Inf" : "-Inf";
            need = strlen(fmt);
            if (flags & (FPLUS|FSPACE)) {
                CHECK(need + 1);
                if (fval > 0.0) {
                    if (flags & FPLUS) *buf++ = '+';
                    else *buf++ = ' ';
                }
                memcpy(buf, fmt, need);
                blen += need + 1;
            } else {
                CHECK(need);
                memcpy(buf, fmt, need);
                blen += need;
            }
            break;
        }