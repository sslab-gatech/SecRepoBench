{
  mrb_float fval = mrb_to_flo(mrb, GETARG());
  char fbuf[32];
  int need;

  if (!isfinite(fval)) {
    const char *special = (isnan(fval) ? "NaN" : (fval < 0 ? "-Inf" : "Inf"));
    int special_len = strlen(special);

    if (flags & FPLUS && fval > 0) {
      PUSH("+", 1);
      width--;
    } else if (flags & FSPACE && fval > 0) {
      PUSH(" ", 1);
      width--;
    }

    if (!(flags & FMINUS) && width > special_len) {
      FILL(' ', width - special_len);
    }

    PUSH(special, special_len);

    if ((flags & FMINUS) && width > special_len) {
      FILL(' ', width - special_len);
    }

    break;
  }

  fmt_setup(fbuf, sizeof(fbuf), *p, flags, width, prec);
  need = snprintf(NULL, 0, fbuf, fval);

  if (need < 0 || need >= MRB_INT_MAX) {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "formatted float too large");
  }

  CHECK(need);
  snprintf(&buf[blen], need + 1, fbuf, fval);
  blen += need;
}