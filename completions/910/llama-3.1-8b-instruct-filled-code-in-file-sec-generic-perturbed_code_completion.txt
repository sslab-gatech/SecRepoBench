// Get type handler
TypeHandler = _cmsGetTagTypeHandler(Icc->ContextID, BaseType);
if (TypeHandler == NULL) goto Error;
LocalTypeHandler = *TypeHandler;

// Read the tag
Icc -> TagTypeHandlers[n] = TypeHandler;

LocalTypeHandler.ContextID = Icc ->ContextID;
LocalTypeHandler.ICCVersion = Icc ->Version;
Icc -> TagPtrs[n] = LocalTypeHandler.ReadPtr(&LocalTypeHandler, io, &ElemCount, TagSize);

// The tag type is supported, but something wrong happened and we cannot read the tag.
// let know the user about this (although it is just a warning)
if (Icc -> TagPtrs[n] == NULL) {

    char String[5];

    _cmsTagSignature2String(String, tagSignature);
    cmsSignalError(Icc ->ContextID, cmsERROR_CORRUPTION_DETECTED, "Corrupted tag '%s'", String);
    goto Error;
}

// This is a weird error that may be a symptom of something more serious, the number of
// stored item is actually less than the number of required elements.
if (ElemCount < TagDescriptor ->ElemCount) {

    char String[5];

    _cmsTagSignature2String(String, tagSignature);
    cmsSignalError(Icc ->ContextID, cmsERROR_CORRUPTION_DETECTED, "'%s' Inconsistent number of items: expected %d, got %d",
        String, TagDescriptor ->ElemCount, ElemCount);
}

// Return the data
_cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
return Icc -> TagPtrs[n];

// Return error and unlock tha data
Error:
_cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
return NULL;