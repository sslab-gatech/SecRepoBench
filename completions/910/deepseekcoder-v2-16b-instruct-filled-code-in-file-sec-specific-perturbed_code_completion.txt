, SigString);
        goto Error;
    }

    // Get the handler
    TypeHandler = _cmsGetTagTypeHandler(Icc->ContextID, Type);
    if (TypeHandler == NULL) {
        cmsSignalError(Icc ->ContextID, cmsERROR_INTERNAL, "(Internal) no handler for tag %x", sig);
        goto Error;
    }

    // Save the type handler
    Icc ->TagTypeHandlers[i] = TypeHandler;

    // Write the tag
    LocalTypeHandler = *TypeHandler;
    LocalTypeHandler.ContextID = Icc ->ContextID;
    LocalTypeHandler.ICCVersion = Icc ->Version;
    if (!LocalTypeHandler.WritePtr(&LocalTypeHandler, Icc ->IOhandler, (void*) data, TagDescriptor ->ElemCount)) {

        _cmsTagSignature2String(TypeString, (cmsTagSignature) Type);
        _cmsTagSignature2String(SigString,  sig);

        cmsSignalError(Icc ->ContextID, cmsERROR_WRITE, "Couldn't write type '%s' for tag '%s'", TypeString, SigString);
        goto Error;
    }

    // Save the size and offset
    Icc ->TagSizes[i]   = TypeHandler ->SizeOf(TypeHandler, data);
    Icc ->TagOffsets[i] = 0; // To be filled later

    // Return success
    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return TRUE;

Error:
    _cmsUnlockMutex(Icc->ContextID, Icc ->UsrMutex);
    return FALSE;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTag(cmsHPROFILE hProfile, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(hProfile, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToMem(cmsContext ContextID, void* MemPtr, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromMem(ContextID, MemPtr, 0, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToFile(const char* FileName, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromFile(NULL, FileName, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToStream(FILE* Stream, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromStream(NULL, Stream);
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToIOhandler(cmsIOHANDLER* io, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(io->stream, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToProfile(cmsHPROFILE hProfile, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(hProfile, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToProfileTHR(cmsContext ContextID, cmsHPROFILE hProfile, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(hProfile, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagToMemTHR(cmsContext ContextID, void* MemPtr, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromMem(ContextID, MemPtr, 0, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromFile(const char* FileName, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromFile(NULL, FileName, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromStream(FILE* Stream, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromStream(NULL, Stream);
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromIOhandler(cmsIOHANDLER* io, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(io->stream, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromFileTHR(cmsContext ContextID, const char* FileName, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromFile(ContextID, FileName, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromStreamTHR(cmsContext ContextID, FILE* Stream, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromStream(ContextID, Stream);
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromIOhandlerTHR(cmsContext ContextID, cmsIOHANDLER* io, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(io->stream, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromProfile(cmsHPROFILE hProfile, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(hProfile, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromProfileTHR(cmsContext ContextID, cmsHPROFILE hProfile, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(hProfile, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromMem(const void* MemPtr, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromMem(NULL, (void*) MemPtr, 0, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromMemTHR(cmsContext ContextID, const void* MemPtr, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromMem(ContextID, (void*) MemPtr, 0, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromFileTHR(cmsContext ContextID, const char* FileName, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromFile(ContextID, FileName, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromStreamTHR(cmsContext ContextID, FILE* Stream, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromStream(ContextID, Stream);
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromIOhandlerTHR(cmsContext ContextID, cmsIOHANDLER* io, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(io->stream, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromProfileTHR(cmsContext ContextID, cmsHPROFILE hProfile, cmsTagSignature sig, const void* data)
{
    return cmsWriteTag(hProfile, sig, data);
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromMemTHR(cmsContext ContextID, const void* MemPtr, cmsTagSignature sig, const void* data)
{
    cmsIOHANDLER* io;
    cmsBool rc;

    io = cmsOpenIOhandlerFromMem(ContextID, (void*) MemPtr, 0, "w");
    if (io == NULL) return FALSE;

    rc = cmsWriteTag(io->stream, sig, data);
    cmsCloseIOhandler(io);

    return rc;
}


// Add a new tag to the profile. If the tag already exists, it is replaced.
cmsBool CMSEXPORT cmsAddTagFromProfile(cmsHPROFILE hProfile,