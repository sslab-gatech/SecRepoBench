handler = xmlFindCharEncodingHandler(encoding_guess);
if (handler == NULL) {
    htmlParseErrInt(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                    "Unsupported encoding: %s\n", encoding_guess);
    xmlFree(encoding_guess);
    xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_8859_1);
} else {
    if (xmlStrcasecmp(encoding_guess, BAD_CAST "UTF-8") != 0)
        xmlSwitchEncoding(ctxt, handler->enc);
    xmlFree(encoding_guess);
}