{
    xmlCharEncodingHandlerPtr handler;

    handler = xmlFindCharEncodingHandler((const char *) encoding_guess);
    if (handler == NULL) {
        /* No encoding handler found, report error */
        htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                     "Unsupported encoding %s\n", encoding_guess, NULL);
    } else {
        /* If the guessed encoding is found and not UTF-8, switch to that encoding */
        if (xmlStrcasecmp(encoding_guess, BAD_CAST "UTF-8") != 0) {
            xmlCharEncoding enc = xmlParseCharEncoding((const char *) encoding_guess);
            if (enc == XML_CHAR_ENCODING_NONE) {
                htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                             "Unsupported encoding %s\n", encoding_guess, NULL);
            } else {
                xmlSwitchEncoding(ctxt, enc);
            }
        }
    }
}