handler = xmlFindCharEncodingHandler((const char *)encoding_guess);
if (handler != NULL && strcmp(handler->name, "UTF-8") != 0) {
    if (xmlSwitchEncoding(ctxt, handler) != 0) {
        htmlParseErr(ctxt, XML_ERR_INVALID_ENCODING,
                     "Unsupported encoding %s\n", BAD_CAST handler->name);
    }
} else {
    htmlParseErr(ctxt, XML_ERR_INVALID_ENCODING,
                 "Unsupported encoding %s\n", BAD_CAST encoding_guess);
}
free(encoding_guess);