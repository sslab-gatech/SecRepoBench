// Find a character encoding handler based on a guessed encoding.
// If the handler is found and is not "UTF-8", switch the parser's encoding
// to use this handler. If no handler is found, report an unsupported
// encoding error.
if (encoding_guess != NULL) {
    xmlCharEncodingHandlerPtr handler = xmlFindCharEncodingHandler(encoding_guess);
    if (handler != NULL) {
        if (strcmp(handler->name, "UTF-8") != 0) {
            xmlSwitchEncoding(ctxt, handler);
        }
        xmlFree(handler);
    } else {
        htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                     "Unsupported encoding '%s'\n", encoding_guess, NULL);
    }
    xmlFree(encoding_guess);
} else {
    htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                 "Unsupported encoding\n", NULL, NULL);
}
ctxt->input->flags |= XML_INPUT_HAS_ENCODING;