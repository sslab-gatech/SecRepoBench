if ((encoding_guess == NULL) || (encoding_guess == XML_CHAR_ENCODING_8859_1)) {
    xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_8859_1);
} else {
    xmlCharEncodingHandlerPtr handler = xmlFindEncodingHandler(encoding_guess);
    if (handler == NULL) {
        xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_8859_1);
    } else {
        xmlSwitchEncoding(ctxt, encoding_guess);
        ctxt->input->flags |= XML_INPUT_HAS_ENCODING;
    }
}