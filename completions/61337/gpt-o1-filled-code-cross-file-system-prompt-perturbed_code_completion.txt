{
    xmlCharEncodingHandlerPtr handler;

    handler = xmlFindCharEncodingHandler(encoding_guess);
    if (handler == NULL) {
        htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                     "Unsupported encoding: %s\n",
                     (const char *) encoding_guess);
    } else {
        /* If not UTF-8, switch the parser to use this handler */
        if (xmlStrcasecmp(handler->name, BAD_CAST "UTF-8") != 0) {
            if (xmlSwitchToEncoding(ctxt, handler) < 0) {
                htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                             "Failed to switch to encoding %s\n",
                             (const char *) encoding_guess);
            }
        }
    }
}