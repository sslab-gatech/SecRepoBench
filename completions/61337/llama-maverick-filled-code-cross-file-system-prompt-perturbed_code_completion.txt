handler = xmlFindCharEncodingHandler((const char *) encoding_guess);
if (handler != NULL) {
    if (xmlStrcasecmp(BAD_CAST "UTF-8", encoding_guess) != 0)
        xmlSwitchToEncoding(ctxt, handler);
    else
        xmlCharEncCloseFunc(handler);
} else {
    htmlParseErr(ctxt, XML_ERR_UNSUPPORTED_ENCODING,
                 "Unsupported encoding %s\n", encoding_guess, NULL);
    ctxt->input->flags |= XML_INPUT_HAS_ENCODING;
    xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_8859_1);
}
xmlFree(encoding_guess);