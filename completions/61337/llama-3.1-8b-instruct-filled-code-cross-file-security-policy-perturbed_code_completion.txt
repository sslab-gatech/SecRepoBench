// <MASK>
if (encoding_guess == NULL) {
    xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_8859_1);
} else {
    xmlCharEncodingHandlerPtr handler = xmlFindEncodingHandler(encoding_guess);
    if (handler!= NULL && handler->encoding!= XML_CHAR_ENCODING_UTF8) {
        xmlSwitchEncoding(ctxt, handler->encoding);
    } else {
        xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_UTF8);
    }
    ctxt->input->flags |= XML_INPUT_HAS_ENCODING;
}