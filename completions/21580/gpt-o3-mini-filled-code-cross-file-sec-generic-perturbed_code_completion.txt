if (!iterator)
{
  if (unlikely(!c->serialize_u16(0))) return_trace(false);
  if (unlikely(!c->serialize_u16(0))) return_trace(false);
  return_trace(true);
}

unsigned min_glyph = 0xFFFF;
unsigned max_glyph = 0;
for (Iterator it = iterator; it; ++it)
{
  auto pair = *it;
  unsigned glyph = pair.first;
  if (glyph < min_glyph)
    min_glyph = glyph;
  if (glyph > max_glyph)
    max_glyph = glyph;
}

unsigned glyph_count = max_glyph - min_glyph + 1;
if (unlikely(!c->serialize_u16(static_cast<uint16_t>(min_glyph)))) return_trace(false);
if (unlikely(!c->serialize_u16(static_cast<uint16_t>(glyph_count)))) return_trace(false);

// Prepare an array for the class values, initializing all entries to 0.
std::vector<uint16_t> class_array(glyph_count, 0);
for (Iterator it = iterator; it; ++it)
{
  auto pair = *it;
  unsigned glyph = pair.first;
  unsigned class_value = pair.second;
  unsigned index = glyph - min_glyph;
  if (index < glyph_count)
    class_array[index] = static_cast<uint16_t>(class_value);
}

if (unlikely(!c->serialize_array_u16(class_array.data(), glyph_count)))
  return_trace(false);

return_trace(true);