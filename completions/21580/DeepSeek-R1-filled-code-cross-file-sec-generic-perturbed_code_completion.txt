if (!iterator)
  {
    startingGlyphIndex = 0;
    classValueLength = 0;
    return_trace (true);
  }

  hb_codepoint_t min_glyph = HB_SET_VALUE_INVALID;
  hb_codepoint_t max_glyph = 0;

  for (const auto& pair : iterator)
  {
    hb_codepoint_t g = pair.first;
    if (min_glyph == HB_SET_VALUE_INVALID || g < min_glyph)
      min_glyph = g;
    if (g > max_glyph)
      max_glyph = g;
  }

  if (min_glyph == HB_SET_VALUE_INVALID)
    return_trace (false);

  unsigned count = max_glyph - min_glyph + 1;

  if (count > 0xFFFFu)
    return_trace (false);

  startingGlyphIndex = min_glyph;
  classValueLength = count;

  if (!classValue.serialize (c, count))
    return_trace (false);

  for (unsigned i = 0; i < count; i++)
    classValue[i] = 0;

  for (const auto& pair : iterator)
  {
    hb_codepoint_t g = pair.first;
    unsigned idx = g - min_glyph;
    if (idx >= count)
      return_trace (false);
    classValue[idx] = pair.second;
  }

  return_trace (true);