if (unlikely (!iterator)) {
      this->start = 0;
      if (unlikely (!this->classes.serialize (c, 0))) return_trace (false);
      return_trace (true);
    }

    hb_codepoint_t min_glyph = HB_SET_VALUE_INVALID;
    hb_codepoint_t max_glyph = HB_SET_VALUE_INVALID;
    for (auto pair : iterator) {
      hb_codepoint_t g = pair.first;
      min_glyph = hb_min (g, min_glyph);
      max_glyph = hb_max (g, max_glyph);
    }

    if (unlikely (min_glyph == HB_SET_VALUE_INVALID)) return_trace (false);

    this->start = min_glyph;
    unsigned count = max_glyph - min_glyph + 1;
    if (unlikely (!this->classes.serialize (c, count))) return_trace (false);

    hb_memset (this->classes.arrayZ, 0, count * sizeof (this->classes.arrayZ[0]));

    for (auto pair : iterator) {
      unsigned idx = pair.first - this->start;
      if (unlikely (idx >= count)) return_trace (false);
      this->classes.arrayZ[idx] = pair.second;
    }

    return_trace (true);