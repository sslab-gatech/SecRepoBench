template<typename Iterator>
static inline void
Coverage_serialize (hb_serialize_context_t *c,
                    Iterator it)
{
  if (unlikely (!c->extend_min (*this))) return_trace (false);

  unsigned format = 2;
  if (likely (it))
  {
    hb_codepoint_t glyph_min = (*it).first;
    hb_codepoint_t glyph_max = + it
                               | hb_map (hb_first)
                               | hb_reduce (hb_max, 0u);

    unsigned num_ranges = 1;
    hb_codepoint_t prev_gid = glyph_min;
    unsigned prev_klass = (*it).second;

    for (const auto gid_klass_pair : it)
    {
      hb_codepoint_t cur_gid = gid_klass_pair.first;
      unsigned cur_klass = gid_klass_pair.second;
      if (cur_gid == glyph_min ||!cur_klass) continue;
      if (cur_gid!= prev_gid + 1 ||
          cur_klass!= prev_klass)
        num_ranges++;

      prev_gid = cur_gid;
      prev_klass = cur_klass;
    }

    if (1 + (glyph_max - glyph_min + 1) <= num_ranges * 3)
      format = 1;
  }
  u.format = format;

  switch (u.format)
  {
  case 1: return_trace (u.format1.serialize (c, it));
  case 2: return_trace (u.format2.serialize (c, it));
  default:return_trace (false);
  }
}