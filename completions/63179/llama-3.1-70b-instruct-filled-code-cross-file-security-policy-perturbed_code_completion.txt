u_int32_t needed;
int rc;

needed = sizeof(u_int8_t) /* type */ +
         sizeof(u_int32_t);

if(serializer->fmt == ndpi_serialization_format_csv) {
  if (ndpi_serializer_header_string(serializer, "", 0) < 0) return(-1);
  ndpi_serialize_csv_pre(serializer);
  remainingspace = serializer->buffer.size - serializer->status.buffer.size_used;
}

needed += ndpi_snprintf(NULL, 0, "%d", value) + 1;

if(remainingspace < needed) {
  if(ndpi_extend_serializer_buffer(&serializer->buffer, needed - remainingspace) < 0)
    return(-1);
  remainingspace = serializer->buffer.size - serializer->status.buffer.size_used;
}

if(serializer->fmt == ndpi_serialization_format_csv) {
  rc = ndpi_snprintf((char *) &serializer->buffer.data[serializer->status.buffer.size_used], remainingspace,
                     "%d", value);
} else {
  serializer->buffer.data[serializer->status.buffer.size_used++] = (ndpi_serialization_string << 4) | ndpi_serialization_int32;
  rc = ndpi_snprintf((char *) &serializer->buffer.data[serializer->status.buffer.size_used], remainingspace,
                     "%d", value);
}

if(rc < 0 || (u_int)rc >= remainingspace)
  return(-1);