/* **************************************** */

static void ndpi_int_tls_add_connection(struct ndpi_detection_module_struct *ndpi_struct,
					struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static u_int32_t __get_master(struct ndpi_detection_module_struct *ndpi_struct,
			      struct ndpi_flow_struct *flow) {
  if(flow->detected_protocol_stack[0] != NDPI_PROTOCOL_UNKNOWN)
    return flow->detected_protocol_stack[0];
  if(flow->detected_protocol_stack[1] != NDPI_PROTOCOL_UNKNOWN)
    return flow->detected_protocol_stack[1];

  return ndpi_tls_refine_master_protocol(ndpi_struct, flow);
}

/* **************************************** */

static u_int32_t ndpi_tls_refine_master_protocol(struct ndpi_detection_module_struct *ndpi_struct,
						 struct ndpi_flow_struct *flow) {
  struct ndpi_packet_struct *packet = &ndpi_struct->packet;
  u_int32_t protocol;

  if(packet->tcp != NULL) {
    // ... (rest of the function remains unchanged)
  } else {
      protocol = NDPI_PROTOCOL_DTLS;
  }

  return protocol;
}

/* **************************************** */

static void ndpi_search_tls_tcp(struct ndpi_detection_module_struct *ndpi_struct,
			       struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void ndpi_search_tls_udp(struct ndpi_detection_module_struct *ndpi_struct,
			       struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void ndpi_looks_like_tls(struct ndpi_detection_module_struct *ndpi_struct,
				struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int ndpi_search_tls_memory(struct ndpi_detection_module_struct *ndpi_struct,
				      struct ndpi_flow_struct *flow,
				      const u_int8_t *payload,
				      u_int16_t payload_len,
				      u_int32_t seq,
				      message_t *message) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void cleanupServerName(char *buffer, u_int buffer_len) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void processCertificateElements(struct ndpi_detection_module_struct *ndpi_struct,
				      struct ndpi_flow_struct *flow,
				      u_int16_t p_offset, u_int16_t certificate_len) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int processCertificate(struct ndpi_detection_module_struct *ndpi_struct,
				 struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int processTLSBlock(struct ndpi_detection_module_struct *ndpi_struct,
			       struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void tlsInitExtraPacketProcessing(struct ndpi_detection_module_struct *ndpi_struct,
					 struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void switch_extra_dissection_to_tls(struct ndpi_detection_module_struct *ndpi_struct,
					struct ndpi_flow_struct *flow)
{
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void switch_to_tls(struct ndpi_detection_module_struct *ndpi_struct,
			   struct ndpi_flow_struct *flow, int first_time)
{
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void checkExtensions(struct ndpi_detection_module_struct *ndpi_struct,
			      struct ndpi_flow_struct *flow, int is_dtls,
			      u_int16_t extension_id, u_int16_t extension_len,
			      u_int16_t extension_payload_offset) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int check_sni_is_numeric_ip(char *sni) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int u_int16_t_cmpfunc(const void * a, const void * b) { return(*(u_int16_t*)a - *(u_int16_t*)b); }

/* **************************************** */

static void ndpi_compute_ja4(struct ndpi_detection_module_struct *ndpi_struct,
			     struct ndpi_flow_struct *flow,
			     u_int32_t quic_version,
			     union ja_info *ja) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void ndpi_int_tls_add_connection(struct ndpi_detection_module_struct *ndpi_struct,
					struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void ndpi_looks_like_tls(struct ndpi_detection_module_struct *ndpi_struct,
				struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int ndpi_search_tls_tcp(struct ndpi_detection_module_struct *ndpi_struct,
			       struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static int ndpi_search_tls_udp(struct ndpi_detection_module_struct *ndpi_struct,
			       struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void ndpi_search_tls_wrapper(struct ndpi_detection_module_struct *ndpi_struct,
					struct ndpi_flow_struct *flow) {
  // ... (rest of the function remains unchanged)
}

/* **************************************** */

static void init_tls_dissector(struct ndpi_detection_module_struct *ndpi_struct,
				u_int32_t *id) {
  // ... (rest of the function remains unchanged)
}