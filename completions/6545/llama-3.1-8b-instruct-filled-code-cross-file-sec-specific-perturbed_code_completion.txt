// <MASK>
if (primitive_info == (PrimitiveInfo *) NULL)
  {
    primitive=DestroyString(primitive);
    for ( ; n >= 0; n--)
      graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
    graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      image->filename);
  }
graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
graphic_context[n]->viewbox=image->page;
if ((image->page.width == 0) || (image->page.height == 0))
  {
    graphic_context[n]->viewbox.width=image->columns;
    graphic_context[n]->viewbox.height=image->rows;
  }
token=AcquireString(primitive);
extent=strlen(token)+MagickPathExtent;
if (SetImageStorageClass(image,DirectClass,exception) == MagickFalse)
  return(MagickFalse);
defsDepth=0;
status=MagickTrue;
for (q=primitive; *q!= '\0'; )
{
  /*
    Interpret graphic primitive.
  */
  GetNextToken(q,&q,MagickPathExtent,keyword);
  if (*keyword == '\0')
    break;
  if (*keyword == '#')
    {
      /*
        Comment.
      */
      while ((*q!= '\n') && (*q!= '\0'))
        q++;
      continue;
    }
  p=q-strlen(keyword)-1;
  primitive_type=UndefinedPrimitive;
  current=graphic_context[n]->affine;
  GetAffineMatrix(&affine);
  switch (*keyword)
  {
    case ';':
      break;
    case 'a':
    case 'A':
    {
      if (LocaleCompare("affine",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          affine.sx=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          GetNextToken(q,&q,extent,token);
          if (*token == ',')
            GetNextToken(q,&q,extent,token);
          affine.rx=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          GetNextToken(q,&q,extent,token);
          if (*token == ',')
            GetNextToken(q,&q,extent,token);
          affine.ry=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          GetNextToken(q,&q,extent,token);
          if (*token == ',')
            GetNextToken(q,&q,extent,token);
          affine.sy=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          GetNextToken(q,&q,extent,token);
          if (*token == ',')
            GetNextToken(q,&q,extent,token);
          affine.tx=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          GetNextToken(q,&q,extent,token);
          if (*token == ',')
            GetNextToken(q,&q,extent,token);
          affine.ty=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          break;
        }
      if (LocaleCompare("alpha",keyword) == 0)
        {
          primitive_type=AlphaPrimitive;
          break;
        }
      if (LocaleCompare("arc",keyword) == 0)
        {
          primitive_type=ArcPrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'b':
    case 'B':
    {
      if (LocaleCompare("bezier",keyword) == 0)
        {
          primitive_type=BezierPrimitive;
          break;
        }
      if (LocaleCompare("border-color",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          (void) QueryColorCompliance(token,AllCompliance,
            &graphic_context[n]->border_color,exception);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'c':
    case 'C':
    {
      if (LocaleCompare("clip-path",keyword) == 0)
        {
          /*
            Create clip mask.
          */
          GetNextToken(q,&q,extent,token);
          (void) CloneString(&graphic_context[n]->clip_mask,token);
          (void) DrawClipPath(image,graphic_context[n],
            graphic_context[n]->clip_mask,exception);
          break;
        }
      if (LocaleCompare("clip-rule",keyword) == 0)
        {
          ssize_t
            fill_rule;

          GetNextToken(q,&q,extent,token);
          fill_rule=ParseCommandOption(MagickFillRuleOptions,MagickFalse,
            token);
          if (fill_rule == -1)
            status=MagickFalse;
          else
            graphic_context[n]->fill_rule=(FillRule) fill_rule;
          break;
        }
      if (LocaleCompare("clip-units",keyword) == 0)
        {
          ssize_t
            clip_units;

          GetNextToken(q,&q,extent,token);
          clip_units=ParseCommandOption(MagickClipPathOptions,MagickFalse,
            token);
          if (clip_units == -1)
            {
              status=MagickFalse;
              break;
            }
          graphic_context[n]->clip_units=(ClipPathUnits) clip_units;
          if (clip_units == ObjectBoundingBox)
            {
              GetAffineMatrix(&current);
              affine.sx=draw_info->bounds.x2;
              affine.sy=draw_info->bounds.y2;
              affine.tx=draw_info->bounds.x1;
              affine.ty=draw_info->bounds.y1;
              break;
            }
          break;
        }
      if (LocaleCompare("circle",keyword) == 0)
        {
          primitive_type=CirclePrimitive;
          break;
        }
      if (LocaleCompare("color",keyword) == 0)
        {
          primitive_type=ColorPrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'd':
    case 'D':
    {
      if (LocaleCompare("decorate",keyword) == 0)
        {
          ssize_t
            decorate;

          GetNextToken(q,&q,extent,token);
          decorate=ParseCommandOption(MagickDecorateOptions,MagickFalse,
            token);
          if (decorate == -1)
            status=MagickFalse;
          else
            graphic_context[n]->decorate=(DecorationType) decorate;
          break;
        }
      if (LocaleCompare("density",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          (void) CloneString(&graphic_context[n]->density,token);
          break;
        }
      if (LocaleCompare("direction",keyword) == 0)
        {
          ssize_t
            direction;

          GetNextToken(q,&q,extent,token);
          direction=ParseCommandOption(MagickDirectionOptions,MagickFalse,
            token);
          if (direction == -1)
            status=MagickFalse;
          else
            graphic_context[n]->direction=(DirectionType) direction;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'e':
    case 'E':
    {
      if (LocaleCompare("ellipse",keyword) == 0)
        {
          primitive_type=EllipsePrimitive;
          break;
        }
      if (LocaleCompare("encoding",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          (void) CloneString(&graphic_context[n]->encoding,token);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'f':
    case 'F':
    {
      if (LocaleCompare("fill",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          (void) FormatLocaleString(pattern,MagickPathExtent,"%s",token);
          if (GetImageArtifact(image,pattern)!= (const char *) NULL)
            (void) DrawPatternPath(image,draw_info,token,
              &graphic_context[n]->fill_pattern,exception);
          else
            {
              status&=QueryColorCompliance(token,AllCompliance,
                &graphic_context[n]->fill,exception);
              if (graphic_context[n]->fill_alpha!= OpaqueAlpha)
                graphic_context[n]->fill.alpha=graphic_context[n]->fill_alpha;
              if (status == MagickFalse)
                {
                  ImageInfo
                    *pattern_info;

                  pattern_info=AcquireImageInfo();
                  (void) CopyMagickString(pattern_info->filename,token,
                    MagickPathExtent);
                  graphic_context[n]->fill_pattern=ReadImage(pattern_info,
                    exception);
                  CatchException(exception);
                  pattern_info=DestroyImageInfo(pattern_info);
                }
            }
          break;
        }
      if (LocaleCompare("fill-opacity",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          factor=strchr(token,'%')!= (char *) NULL? 0.01 : 1.0;
          graphic_context[n]->fill_alpha=(MagickRealType) (QuantumRange-
            ClampToQuantum((MagickRealType) QuantumRange*(1.0-factor*
            StringToDouble(token,&next_token))));
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          break;
        }
      if (LocaleCompare("fill-rule",keyword) == 0)
        {
          ssize_t
            fill_rule;

          GetNextToken(q,&q,extent,token);
          fill_rule=ParseCommandOption(MagickFillRuleOptions,MagickFalse,
            token);
          if (fill_rule == -1)
            status=MagickFalse;
          else
            graphic_context[n]->fill_rule=(FillRule) fill_rule;
          break;
        }
      if (LocaleCompare("font",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          (void) CloneString(&graphic_context[n]->font,token);
          if (LocaleCompare("none",token) == 0)
            graphic_context[n]->font=(char *) RelinquishMagickMemory(
              graphic_context[n]->font);
          break;
        }
      if (LocaleCompare("font-family",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          (void) CloneString(&graphic_context[n]->family,token);
          break;
        }
      if (LocaleCompare("font-size",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          graphic_context[n]->pointsize=StringToDouble(token,&next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          break;
        }
      if (LocaleCompare("font-stretch",keyword) == 0)
        {
          ssize_t
            stretch;

          GetNextToken(q,&q,extent,token);
          stretch=ParseCommandOption(MagickStretchOptions,MagickFalse,token);
          if (stretch == -1)
            status=MagickFalse;
          else
            graphic_context[n]->stretch=(StretchType) stretch;
          break;
        }
      if (LocaleCompare("font-style",keyword) == 0)
        {
          ssize_t
            style;

          GetNextToken(q,&q,extent,token);
          style=ParseCommandOption(MagickStyleOptions,MagickFalse,token);
          if (style == -1)
            status=MagickFalse;
          else
            graphic_context[n]->style=(StyleType) style;
          break;
        }
      if (LocaleCompare("font-weight",keyword) == 0)
        {
          ssize_t
            weight;

          GetNextToken(q,&q,extent,token);
          weight=ParseCommandOption(MagickWeightOptions,MagickFalse,token);
          if (weight == -1)
            weight=(ssize_t) StringToUnsignedLong(token);
          graphic_context[n]->weight=(size_t) weight;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'g':
    case 'G':
    {
      if (LocaleCompare("gradient-units",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          break;
        }
      if (LocaleCompare("gravity",keyword) == 0)
        {
          ssize_t
            gravity;

          GetNextToken(q,&q,extent,token);
          gravity=ParseCommandOption(MagickGravityOptions,MagickFalse,token);
          if (gravity == -1)
            status=MagickFalse;
          else
            graphic_context[n]->gravity=(GravityType) gravity;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'i':
    case 'I':
    {
      if (LocaleCompare("image",keyword) == 0)
        {
          ssize_t
            compose;

          primitive_type=ImagePrimitive;
          GetNextToken(q,&q,extent,token);
          compose=ParseCommandOption(MagickComposeOptions,MagickFalse,token);
          if (compose == -1)
            status=MagickFalse;
          else
            graphic_context[n]->compose=(CompositeOperator) compose;
          break;
        }
      if (LocaleCompare("interline-spacing",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          graphic_context[n]->interline_spacing=StringToDouble(token,
            &next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          break;
        }
      if (LocaleCompare("interword-spacing",keyword) == 0)
        {
          GetNextToken(q,&q,extent,token);
          graphic_context[n]->interword_spacing=StringToDouble(token,
            &next_token);
          if (token == next_token)
            ThrowPointExpectedException(token,exception);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'k':
    case 'K':
    {
      if (LocaleCompare("kerning",keyword) == 0)