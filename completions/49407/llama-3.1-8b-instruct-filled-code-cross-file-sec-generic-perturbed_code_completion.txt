if (version >= 2)
{
  VariationStoreCache *cache = new VariationStoreCache (coords_length);
  VariationIndexMap *index_map = new VariationIndexMap (coords_length);
  VariationStore *store = new VariationStore (coords_length);

  int *output = (int *) hb_calloc (coords_length, sizeof (int));
  if (unlikely (!output))
    return;

  for (unsigned int i = 0; i < coords_length; i++)
  {
    int delta = 0;
    if (cache->has (coords[i]))
    {
      delta = cache->get (coords[i]);
    }
    else
    {
      delta = index_map->get (coords[i]);
      if (delta!= 0)
      {
        store->put (coords[i], delta);
        cache->put (coords[i], delta);
      }
    }

    int transformed = map->map (coords[i]) + delta;
    transformed = hb_clamp (transformed, min, max);
    output[i] = transformed;
  }

  hb_free (output);
  delete cache;
  delete index_map;
  delete store;

  for (unsigned int i = 0; i < coords_length; i++)
  {
    coords[i] = output[i];
  }
}