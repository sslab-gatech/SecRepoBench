for (unsigned int i = 0; i < effectiveaxiscount; i++)
{
  coords[i] = map->map (coords[i]);
  map = &StructAfter<SegmentMaps> (*map);
}

if (unlikely (version >= 2))
{
  // Initialize variation store cache (details omitted)
  VariationStoreCache varStoreCache;
  // ...

  // Allocate output vector for transformed coordinates
  int *transformed = (int *) hb_calloc (effectiveaxiscount, sizeof (int));
  if (!transformed)
    return;

  // Compute deltas and clamp
  for (unsigned int i = 0; i < effectiveaxiscount; i++)
  {
    float delta = varStoreCache.get_delta(variationIndexMap[i], coords[i]);
    int adjusted = coords[i] + (int)near_round(delta);
    if (adjusted < -32768) adjusted = -32768;
    else if (adjusted > 32767) adjusted = 32767;
    transformed[i] = adjusted;
  }

  // Deallocate variation store cache (details omitted)
  // ...

  // Update original coords
  memcpy (coords, transformed, effectiveaxiscount * sizeof (coords[0]));
  hb_free (transformed);
}