void avar::map_coords (int *coords, unsigned int coords_length) const
{
  unsigned int effectiveaxiscount = hb_min (coords_length, axisCount);

  const SegmentMaps *map = &firstAxisSegmentMaps;
  // Iterate through the coordinates up to the smaller of coords_length and axisCount.
  // For each coordinate, apply a mapping transformation using the current SegmentMaps
  // object and then advance to the next SegmentMaps object.
  // 
  // If the version is 2 or higher, further process the coordinates using variation data.
  // Allocate an output vector for the transformed coordinates. For each coordinate,
  // apply an additional transformation involving a variation index map and a variation
  // store to compute a delta value. Adjust each coordinate by the rounded delta,
  // clamp the result to a specified range, and store it in the output vector.
  // 
  // After processing, deallocate the variation store cache and update the original
  // coordinates array with the transformed values from the output vector.
  std::vector<int> output(coords_length);
  for (unsigned int i = 0; i < effectiveaxiscount; i++)
  {
    int coord = coords[i];
    const SegmentMaps *current_map = &firstAxisSegmentMaps;
    for (unsigned int j = 0; j < i; j++)
    {
      coord = current_map->unmap(coord);
      current_map = &StructAfter<SegmentMaps>(*current_map);
    }
    output[i] = coord;
  }

#ifndef HB_NO_VARIATIONS2
  if (version.major >= 2)
  {
    const auto &v2 = * (const avarV2Tail *) map;
    for (unsigned int i = effectiveaxiscount; i < axisCount; i++)
    {
      int coord = coords[i];
      const SegmentMaps *current_map = &firstAxisSegmentMaps;
      for (unsigned int j = 0; j < i; j++)
      {
        coord = current_map->unmap(coord);
        current_map = &StructAfter<SegmentMaps>(*current_map);
      }
      int delta = v2.varIdxMap[coord];
      coord = v2.varStore[delta];
      coord = std::max(coord, v2.coords[0]);
      coord = std::min(coord, v2.coords[1]);
      output[i] = coord;
    }
  }
#endif

  // Update the original coordinates array with the transformed values from the output vector.
  for (unsigned int i = 0; i < effectiveaxiscount; i++)
  {
    coords[i] = output[i];
  }
}