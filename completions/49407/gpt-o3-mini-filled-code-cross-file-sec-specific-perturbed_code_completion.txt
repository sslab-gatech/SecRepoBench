for (unsigned int i = 0; i < effectiveaxiscount; i++)
{
  coords[i] = map->map(coords[i]);
  map = &StructAfter<SegmentMaps>(*map);
}

if (version < 2)
  return;

int *transformed_coords = new (std::nothrow) int[effectiveaxiscount];
if (!transformed_coords)
  return;

for (unsigned int i = 0; i < effectiveaxiscount; i++)
{
  // Compute the variation delta securely using the variation index map and variation store.
  // It is assumed that variationIndexMap is an array of at least axisCount elements and that
  // variationStore is a valid pointer with a get_delta() member function.
  float delta = variationStore->get_delta(variationIndexMap[i], coords[i]);
  int rounded_delta = static_cast<int>(round(delta));
  int adjusted = coords[i] + rounded_delta;

  // Clamp the result to the valid coordinate range.
  if (adjusted < minCoord)
    adjusted = minCoord;
  else if (adjusted > maxCoord)
    adjusted = maxCoord;

  transformed_coords[i] = adjusted;
}

if (variationStoreCache)
{
  delete variationStoreCache;
  variationStoreCache = nullptr;
}

for (unsigned int i = 0; i < effectiveaxiscount; i++)
  coords[i] = transformed_coords[i];

delete[] transformed_coords;