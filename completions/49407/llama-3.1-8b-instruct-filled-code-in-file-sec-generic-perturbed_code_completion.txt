void map_coords (int *coords, unsigned int coords_length) const
{
  unsigned int effectiveaxiscount = hb_min (coords_length, axisCount);

  const SegmentMaps *map = &firstAxisSegmentMaps;
  // Iterate through the coordinates up to the smaller of coords_length and axisCount.
  // For each coordinate, apply a mapping transformation using the current SegmentMaps
  // object and then advance to the next SegmentMaps object.
  // 
  // If the version is 2 or higher, further process the coordinates using variation data.
  // Allocate an output vector for the transformed coordinates. For each coordinate,
  // apply an additional transformation involving a variation index map and a variation
  // store to compute a delta value. Adjust each coordinate by the rounded delta,
  // clamp the result to a specified range, and store it in the output vector.
  // 
  // After processing, deallocate the variation store cache and update the original
  // coordinates array with the transformed values from the output vector.
  std::vector<int> transformed_coords(coords_length);
  for (unsigned int i = 0; i < effectiveaxiscount; i++)
  {
    const AxisValueMap &axis_map = map->arrayZ[i];
    int mapped_value = axis_map.map(coords[i]);
    transformed_coords[i] = mapped_value;
  }

#ifndef HB_NO_VARIATIONS2
  if (version.major >= 2)
  {
    const avarV2Tail &v2 = * (const avarV2Tail *) map;
    for (unsigned int i = 0; i < effectiveaxiscount; i++)
    {
      int mapped_value = transformed_coords[i];
      int variation_index = v2.varIdxMap.map(mapped_value);
      int delta = v2.varStore.map(variation_index);
      transformed_coords[i] = mapped_value + delta;
    }
  }
#endif

  // Clamp the transformed coordinates to the specified range
  for (unsigned int i = 0; i < effectiveaxiscount; i++)
  {
    transformed_coords[i] = std::max(std::min(transformed_coords[i], coords[i] + 1), coords[i] - 1);
  }

  // Update the original coordinates array with the transformed values
  for (unsigned int i = 0; i < effectiveaxiscount; i++)
  {
    coords[i] = transformed_coords[i];
  }
}