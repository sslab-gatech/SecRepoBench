{
  char name[MagickPathExtent], *macro_definition;
  register ssize_t level = 1;

  /*
    Read the quoted macro name (e.g., "wheel").
  */
  q++;
  {
    size_t i = 0;
    while ((*q != '"') && (*q != '\0') && (i < (MagickPathExtent - 1)))
      name[i++] = *q++;
    name[i] = '\0';
  }
  if (*q == '"')
    q++;

  /*
    Capture all MVG tokens until we match a corresponding 'pop'.
    Handle nested 'push'/'pop' pairs by incrementing/decrementing 'level'.
    Skip comments.
  */
  macro_definition = AcquireString("");
  while ((*q != '\0') && (level > 0))
  {
    GetNextToken(q,&q,length,token);
    if (*token == '#')
      {
        /* Skip comment */
        while ((*q != '\n') && (*q != '\0'))
          q++;
        continue;
      }
    if (LocaleCompare(token,"push") == 0)
      level++;
    else if (LocaleCompare(token,"pop") == 0)
      {
        level--;
        if (level == 0)
          break;
      }
    if (level > 0)
      {
        (void) ConcatenateString(&macro_definition,token);
        (void) ConcatenateString(&macro_definition," ");
      }
  }
  (void) AddValueToSplayTree(macros,ConstantString(name),(const void *) macro_definition);
  macro_definition = DestroyString(macro_definition);
}