(void) CopyMagickString(name,token,MagickPathExtent);
            start=q;
            end=q;
            depth=1;
            while ((*end != '\0') && (depth > 0))
            {
              char
                current_token[MagickPathExtent];

              const char
                *next;

              GetNextToken(end,&next,length,current_token);
              if (*current_token == '\0')
                break;
              if (LocaleCompare(current_token,"push") == 0)
                depth++;
              else if (LocaleCompare(current_token,"pop") == 0)
              {
                depth--;
                if (depth == 0)
                  {
                    end=end;
                    break;
                  }
              }
              end=next;
            }
            if (depth == 0)
            {
              char
                *macro_def;

              macro_def=(char *) AcquireMagickMemory(end-start+1);
              if (macro_def != (char *) NULL)
                {
                  (void) strncpy(macro_def,start,end-start);
                  macro_def[end-start]='\0';
                  (void) AddValueToSplayTree(macros,ConstantString(name),
                    macro_def);
                }
              q=end;
            }