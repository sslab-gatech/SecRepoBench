/*
  Get the name of the macro.
*/
n=strlen(token);
if ((n <= 2) || (token[0] != '"') || (token[n-1] != '"'))
  break;
token[n-1]='\0';  // Remove trailing quote
(void) CopyMagickString(name,token+1,MagickPathExtent);

/*
  Find the matching pop for this push.
*/
depth=1;
end=q;
while ((*end != '\0') && (depth > 0))
{
  if (*end == '#')
    {
      /*
        Skip comment.
      */
      while ((*end != '\n') && (*end != '\0'))
        end++;
      if (*end == '\0')
        break;
    }
  if (LocaleNCompare(end,"push",4) == 0)
    {
      /*
        Handle nested push.
      */
      depth++;
      end+=4;
      continue;
    }
  if (LocaleNCompare(end,"pop",3) == 0)
    {
      /*
        Handle pop.
      */
      depth--;
      if (depth > 0)
        end+=3;
      continue;
    }
  end++;
}

if (depth != 0)
  break;  // Unbalanced push/pop

/*
  Extract the macro and add it to the splay tree.
*/
{
  char
    *macro;

  macro=AcquireString(start);
  macro[end-start]='\0';
  (void) AddValueToSplayTree(macros,ConstantString(name),macro);
  
  /*
    Skip past the pop to continue parsing.
  */
  q=end+3;  // Skip past "pop"
}