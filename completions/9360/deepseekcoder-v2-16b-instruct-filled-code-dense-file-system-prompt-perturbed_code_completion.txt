// Extract macros from the MVG string. The code iterates through the string 
        // to find 'push' and 'pop' commands, handling nested structures accordingly.
        // It skips comments starting with '#'. When a complete macro is identified, 
        // it extracts the macro definition and adds it to a splay tree 
        // for later retrieval using the macro name as the key.
        char name[MagickPathExtent];
        const char *p;
        ssize_t n;

        GetNextToken(q, &q, length, token);
        start = q;
        n = 0;
        while (*q != '"' || n > 0) {
          if (*q == '"') {
            n++;
          } else if (*q == '{') {
            n++;
          } else if (*q == '}') {
            n--;
          }
          q++;
        }
        if (*q != '"') {
          ThrowException(OptionError,"Malformed macro definition");
        }
        q++; // skip the closing quote

        // Copy the macro name
        p = start;
        n = 0;
        while (p < q && *p != ' ') {
          name[n++] = *p++;
        }
        name[n] = '\0';
        if (*p == ' ') {
          p++; // skip the space
        }

        // Extract the macro definition
        char *macro_definition = AcquireString(p);
        AddToSplayTree(macros, name, macro_definition);