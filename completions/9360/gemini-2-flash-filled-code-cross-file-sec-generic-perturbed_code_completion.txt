end=q;
            while ((*end != '"') && (*end != '\0'))
              end++;
            if (*end == '"')
              end++;
            n=end-start-1;
            if (n > (ssize_t) sizeof(name)-1)
              n=(ssize_t) sizeof(name)-1;
            p=name;
            for (ssize_t i = 0; i < n; i++)
              *p++ = *start++;
            *p = '\0';
            (void) TrimString(name);
            /*
              Extract macro definition.
            */
            start=end;
            while (isspace((int) (*start)) != 0)
              start++;
          }
        else
          {
            /*
              Unnamed macro (e.g. push graphic-context).
            */
            start=q;
          }
        {
          ssize_t
            nesting=0;

          /*
            Find matching pop command.
          */
          end=start;
          while ((*end != '\0') && (nesting >= 0))
          {
            GetNextToken(end,&end,length,token);
            if (*token == '#')
              {
                /*
                  Skip comment.
                */
                while ((*end != '\n') && (*end != '\0'))
                  end++;
                continue;
              }
            if (LocaleCompare("push",token) == 0)
              nesting++;
            if (LocaleCompare("pop",token) == 0)
              nesting--;
          }
          if (nesting >= 0)
            end=(char *) q+strlen(q);
          n=end-start;
          if (n > 0)
            {
              char
                *definition;

              /*
                Define macro.
              */
              definition=AcquireString("");
              p=definition;
              for (ssize_t i = 0; i < n; i++)
                *p++ = *start++;
              *p = '\0';
              (void) TrimString(definition);
              if (*name == '\0')
                (void) FormatLocaleString(name,MagickPathExtent,"macro-%lu",
                  (unsigned long) GetSplayTreeSize(macros));
              /*
                Add macro to splay tree.
              */
              if (GetValueFromSplayTree(macros,name) == (void *) NULL)
                (void) AddValueToSplayTree(macros,ConstantString(name),
                  definition);
              else
                definition=DestroyString(definition);
            }
          q=end;
          *name='\0';
        }
      }