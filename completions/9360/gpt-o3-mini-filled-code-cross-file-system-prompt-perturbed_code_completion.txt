{
  int depth = 1;
  const char *macro_end = q;
  char macro_name[MagickPathExtent];
  /* token currently holds the macro name; save it */
  (void) CopyMagickString(macro_name, token, MagickPathExtent);
  /* Parse the rest of the MVG macro until the matching 'pop' is found */
  while (*q != '\0')
  {
    GetNextToken(q, &q, length, token);
    if (*token == '\0')
      break;
    if (*token == '#')
    {
      /* Skip comment */
      while ((*q != '\n') && (*q != '\0'))
        q++;
      continue;
    }
    if (LocaleCompare("push", token) == 0)
      depth++;
    else if (LocaleCompare("pop", token) == 0)
    {
      depth--;
      if (depth == 0)
      {
        macro_end = q;
        break;
      }
    }
  }
  if (depth == 0)
  {
    size_t macro_length = (size_t)(macro_end - start);
    char *macro_definition = (char *) AcquireMagickMemory(macro_length + 1);
    if (macro_definition != (char *) NULL)
    {
      memcpy(macro_definition, start, macro_length);
      macro_definition[macro_length] = '\0';
      (void) AddValueToSplayTree(macros, ConstantString(macro_name), macro_definition);
    }
  }
}