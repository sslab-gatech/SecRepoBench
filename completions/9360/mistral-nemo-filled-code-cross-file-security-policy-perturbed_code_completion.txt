// Extract macros from the MVG string. The code iterates through the string
// to find 'push' and 'pop' commands, handling nested structures accordingly.
// It skips comments starting with '#'. When a complete macro is identified,
// it extracts the macro definition and adds it to a splay tree
// for later retrieval using the macro name as the key.
// <MASK>
for ( ; ; )
{
  if (IsPoint(q) == MagickFalse)
    break;
  GetNextToken(q,&q,length,token);
  if (*token == '\0')
    break;
  if (LocaleCompare("push",token) == 0)
    {
      register const char
        *end,
        *start;

      GetNextToken(q,&q,length,token);
      if (*q == '"')
        {
          char
            name[MagickPathExtent];

          const char
            *p;

          ssize_t
           n;

          /*
            Named macro (e.g. push graphic-context "wheel").
          */
          GetNextToken(q,&q,length,token);
          start=q;
          // Extract macros from the MVG string. The code iterates through the string
          // to find 'push' and 'pop' commands, handling nested structures accordingly.
          // It skips comments starting with '#'. When a complete macro is identified,
          // it extracts the macro definition and adds it to a splay tree
          // for later retrieval using the macro name as the key.
          // <MASK>
          while ((*q != '\n') && (*q != '\0'))
            GetNextToken(q,&q,length,token);
          if (*q == '"')
            {
              GetNextToken(q,&q,length,token);
              end=q;
              while ((*q != '"') && (*q != '\0'))
                GetNextToken(q,&q,length,token);
              if (*q == '"')
                GetNextToken(q,&q,length,token);
              n=end-start;
              if (n > 0)
                {
                  name=(char *) AcquireMemory(n+1);
                  (void) memcpy(name,start,n);
                  name[n]='\0';
                  (void) AddValueToSplayTree(macros,ConstantString(name),
                    (void *) NULL);
                  name=(char *) RelinquishMagickMemory(name);
                }
            }
        }
    }
}