// Extract macros from the MVG string. The code iterates through the string 
// to find 'push' and 'pop' commands, handling nested structures accordingly.
// It skips comments starting with '#'. When a complete macro is identified, 
// it extracts the macro definition and adds it to a splay tree 
// for later retrieval using the macro name as the key.
char
  *macro_name,
  *macro_definition;

ssize_t
  macro_definition_length,
  macro_name_length;

macro_name=AcquireString(token);
macro_name_length=strlen(macro_name);
macro_definition=AcquireString("");
macro_definition_length=0;
for ( ; *q!= '\0'; )
{
  GetNextToken(q,&q,length,token);
  if (*token == '"')
    {
      GetNextToken(q,&q,length,token);
      macro_definition=(char *) ResizeQuantumMemory(macro_definition,
        macro_definition_length+strlen(token)+1,sizeof(*macro_definition));
      (void) ConcatenateMagickString(macro_definition,token,
        macro_definition_length+strlen(token)+1);
      macro_definition_length+=strlen(token);
      continue;
    }
  if (LocaleCompare("pop",token) == 0)
    break;
  if (LocaleCompare("push",token) == 0)
    {
      GetNextToken(q,&q,length,token);
      if (LocaleCompare("graphic-context",token) == 0)
        {
          GetNextToken(q,&q,length,token);
          if (*token == '"')
            {
              GetNextToken(q,&q,length,token);
              macro_definition=(char *) ResizeQuantumMemory(
                macro_definition,macro_definition_length+strlen(token)+1,
                sizeof(*macro_definition));
              (void) ConcatenateMagickString(macro_definition,token,
                macro_definition_length+strlen(token)+1);
              macro_definition_length+=strlen(token);
              continue;
            }
        }
    }
  macro_definition=(char *) ResizeQuantumMemory(macro_definition,
    macro_definition_length+strlen(token)+1,sizeof(*macro_definition));
  (void) ConcatenateMagickString(macro_definition,token,
    macro_definition_length+strlen(token)+1);
  macro_definition_length+=strlen(token);
}
macro_definition=(char *) ResizeQuantumMemory(macro_definition,
  macro_definition_length+1,sizeof(*macro_definition));
(void) ConcatenateMagickString(macro_definition,"",macro_definition_length+1);
AddValueToSplayTree(macros,macro_name,macro_definition);
macro_name=DestroyString(macro_name);
macro_definition=DestroyString(macro_definition);