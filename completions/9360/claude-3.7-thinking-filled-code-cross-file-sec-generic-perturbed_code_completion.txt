for (p=q,n=1; (*p != '\0') && (n > 0); )
{
  char cmd[MagickPathExtent];
  const char *tmp=p;
  
  /* Skip whitespace and comments */
  while (isspace((int) *tmp))
    tmp++;
  if (*tmp == '#')
  {
    while ((*tmp != '\n') && (*tmp != '\0'))
      tmp++;
    if (*tmp == '\0')
      break;
    p=tmp+1;
    continue;
  }
  
  /* Extract next token */
  GetNextToken(tmp,&tmp,length,cmd);
  if (*cmd == '\0')
    break;
  
  /* Check for push/pop commands */
  if (LocaleCompare("push",cmd) == 0)
    n++;
  else if (LocaleCompare("pop",cmd) == 0)
  {
    n--;
    if (n == 0)
      end=p;  /* Found the matching pop */
  }
  
  /* Move to next token */
  p=tmp;
}
if (n != 0)
  break;  /* No matching pop */
n=(ssize_t) (end-start);
if (n <= 0)
  break;  /* Empty macro */
/* Store the macro in the splay tree with the name as the key */
{
  char *macro_value;
  
  macro_value=(char *) AcquireMagickMemory((size_t) (n+1));
  if (macro_value == (char *) NULL)
    break;
  (void) memcpy(macro_value,start,(size_t) n);
  macro_value[n]='\0';
  (void) AddValueToSplayTree(macros,ConstantString(token),macro_value);
}