(void) CopyMagickString(name, token, MagickPathExtent);
{
  int depth = 1;
  const char *macro_start = q;
  while (*q != '\0')
  {
    GetNextToken(q, &q, length, token);
    if (*token == '#')
    {
      while ((*q != '\n') && (*q != '\0'))
        q++;
      continue;
    }
    if (LocaleCompare("push", token) == 0)
      depth++;
    else if (LocaleCompare("pop", token) == 0)
    {
      depth--;
      if (depth == 0)
        break;
    }
  }
  if (depth != 0)
    break;
  {
    size_t macro_length = (size_t)(q - macro_start);
    char *macro_definition = (char *) AcquireMagickMemory(macro_length + 1);
    if (macro_definition == (char *) NULL)
      break;
    (void) memcpy(macro_definition, macro_start, macro_length);
    macro_definition[macro_length] = '\0';
    (void) AddValueToSplayTree(macros, ConstantString(name), macro_definition);
    macro_definition = (char *) RelinquishMagickMemory(macro_definition);
  }
}