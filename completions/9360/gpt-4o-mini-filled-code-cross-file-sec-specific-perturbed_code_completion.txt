size_t macro_length = strlen(token) + 1; // +1 for null terminator
            char *macro_definition = (char *) AcquireQuantumMemory(macro_length, sizeof(char));
            if (macro_definition == (char *) NULL)
              ThrowMagickException(exception, GetMagickModule(), ResourceLimitError, "MemoryAllocationFailed", "`%s'", image->filename);
            strncpy(macro_definition, token, macro_length);
            // Add the macro definition to the splay tree
            if (AddValueToSplayTree(macros, macro_definition, (void *) macro_definition) == MagickFalse)
              {
                macro_definition = RelinquishMagickMemory(macro_definition);
                ThrowMagickException(exception, GetMagickModule(), ResourceLimitError, "MemoryAllocationFailed", "`%s'", image->filename);
              }