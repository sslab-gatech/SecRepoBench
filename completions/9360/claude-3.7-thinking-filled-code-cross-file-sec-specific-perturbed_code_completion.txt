int depth = 1;  // We're already inside one 'push'
end = q; // Start looking from current position

// Find matching 'pop'
while ((depth > 0) && (*end != '\0'))
{
    GetNextToken(end, &end, length, token);
    if (*token == '\0')
        break;
    if (LocaleCompare("push", token) == 0)
        depth++;
    else if (LocaleCompare("pop", token) == 0)
        depth--;
}

if (depth != 0)
    continue; // Unbalanced push/pop, skip this macro

// Extract the macro definition (from start to end)
n = (end - start); // Length of the macro definition
if (n > 0)
{
    p = (char *) AcquireQuantumMemory((size_t) n+1, sizeof(char));
    if (p != (char *) NULL)
    {
        memcpy(p, start, n);
        p[n] = '\0';
        // Add to SplayTree
        (void) AddValueToSplayTree(macros, ConstantString(name), p);
    }
}