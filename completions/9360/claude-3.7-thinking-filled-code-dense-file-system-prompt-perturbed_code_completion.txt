/*
  Named macro (e.g. push graphic-context "wheel").
*/
GetNextToken(q,&q,length,token);
start=q;
// Extract macros from the MVG string. The code iterates through the string 
// to find 'push' and 'pop' commands, handling nested structures accordingly.
// It skips comments starting with '#'. When a complete macro is identified, 
// it extracts the macro definition and adds it to a splay tree 
// for later retrieval using the macro name as the key.
n=0;
p=token;
while ((*p != '\0') && (*p != '"'))
  p++;
if (*p == '"')
  p++;  // Skip the opening quote
while ((*p != '\0') && (*p != '"'))
  name[n++]=(*p++);
name[n]='\0';  // Null-terminate the name string

// Skip to the end of the name token in the main stream
while ((*q != '\0') && (*q != '"'))
  q++;
if (*q == '"')
  q++;  // Skip the opening quote
while ((*q != '\0') && (*q != '"'))
  q++;
if (*q == '"')
  q++;  // Skip the closing quote

// Remember the starting position for the macro content
start=q;

// Find the matching "pop" for this "push", considering nesting
ssize_t level = 1;  // We're already inside one level (after the first "push")

while ((*q != '\0') && (level > 0))
{
  GetNextToken(q,&q,length,token);
  if (*token == '\0')
    break;
  if (*token == '#')
  {
    // Skip comment
    while ((*q != '\n') && (*q != '\0'))
      q++;
    continue;
  }
  if (LocaleCompare("push",token) == 0)
    level++;
  else if (LocaleCompare("pop",token) == 0)
    level--;
}

if (level == 0)
{
  // Found matching "pop" for the initial "push"
  end=q;  // This now points to the position after the matching "pop"

  // Calculate the length of the macro content
  size_t macro_length = (size_t) (end - start);
  
  // Create storage for the macro content
  char *macro = (char *) AcquireMagickMemory(macro_length + 1);
  if (macro != (char *) NULL)
  {
    // Copy the macro content
    (void) memcpy(macro, start, macro_length);
    macro[macro_length] = '\0';  // Null-terminate
    
    // Add to splay tree with name as key and macro content as value
    (void) AddValueToSplayTree(macros, ConstantString(name), macro);
  }
}