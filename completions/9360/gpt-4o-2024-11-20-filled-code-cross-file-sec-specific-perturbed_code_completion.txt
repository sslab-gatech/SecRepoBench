end = q;
            n = 1;
            while (*q != '\0') {
              GetNextToken(q, &q, length, token);
              if (*token == '\0')
                continue;
              if (LocaleCompare("push", token) == 0)
                n++;
              else if (LocaleCompare("pop", token) == 0) {
                n--;
                if (n == 0) {
                  end = q;
                  break;
                }
              }
            }
            if (n != 0) {
              token = DestroyString(token);
              macros = DestroySplayTree(macros);
              return (SplayTreeInfo *) NULL;
            }

            if ((end == (const char *) NULL) || (end == start)) {
              token = DestroyString(token);
              macros = DestroySplayTree(macros);
              return (SplayTreeInfo *) NULL;
            }

            p = (const char *) AcquireQuantumMemory((size_t) (end - start + MagickPathExtent), sizeof(*p));
            if (p == (const char *) NULL) {
              token = DestroyString(token);
              macros = DestroySplayTree(macros);
              return (SplayTreeInfo *) NULL;
            }

            (void) CopyMagickString(name, token, MagickPathExtent);
            (void) memcpy((char *) p, start, (size_t) (end - start));
            ((char *) p)[end - start - 1] = '\0';
            (void) AddValueToSplayTree(macros, ConstantString(name), (void *) p);