for (p=q; *q != '\0'; )
{
  GetNextToken(q,&q,length,token);
  if (*token == '\0')
    break;
  if (*token == '#')
    {
      while ((*q != '\n') && (*q != '\0'))
        q++;
      continue;
    }
  if (LocaleCompare("push",token) == 0)
    {
      int
        depth = 1;

      end = q;
      while (*end != '\0')
        {
          const char *save = end;
          GetNextToken(end,&end,length,token);
          if (*token == '\0')
            break;
          if (*token == '#')
            {
              while ((*end != '\n') && (*end != '\0'))
                end++;
              continue;
            }
          if (LocaleCompare("push",token) == 0)
            depth++;
          else if (LocaleCompare("pop",token) == 0)
            {
              GetNextToken(end,&end,length,token);
              if (LocaleCompare(token,"graphic-context") == 0)
                {
                  depth--;
                  if (depth == 0)
                    break;
                }
            }
        }
      if (depth == 0)
        {
          size_t
            n = (size_t) (end-p);

          if (n >= (MagickPathExtent-1))
            n = MagickPathExtent-2;
          (void) CopyMagickString(name,start,MagickPathExtent);
          name[n]='\0';
          (void) AddValueToSplayTree(macros,ConstantString(token),
            ConstantString(name));
          q = end;
        }
      continue;
    }
}