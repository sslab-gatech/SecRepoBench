{
  (void) CopyMagickString(name,token,MagickPathExtent);
  p=q;
  n=1;
  while ((*q != '\0') && (n > 0))
  {
    GetNextToken(q,&q,length,token);
    if (*token == '#')
      {
        while ((*q != '\n') && (*q != '\0'))
          q++;
        continue;
      }
    if (LocaleCompare(token,"push") == 0)
      n++;
    else if (LocaleCompare(token,"pop") == 0)
      n--;
  }
  end=q;
  if (end > start)
  {
    size_t macro_length=(size_t) (end-start);
    char *macro_definition=(char *) AcquireQuantumMemory(macro_length+1,sizeof(*macro_definition));
    if (macro_definition == (char *) NULL)
      break;
    (void) memcpy(macro_definition,start,macro_length);
    macro_definition[macro_length]='\0';
    (void) AddValueToSplayTree(macros,ConstantString(name),macro_definition);
  }
}