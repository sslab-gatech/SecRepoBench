(void) CopyMagickString(name, token+1, MagickPathExtent-1);
name[strlen(name)-1]='\0';  // Remove trailing quote

// Remember where the macro definition starts
start = q;

// Find the matching pop by tracking nesting level
int push_depth = 1;  // We're already inside one push

while (*q != '\0')
{
  const char *token_start = q;  // Remember position before token
  
  GetNextToken(q, &q, length, token);
  if (*token == '\0')
    break;
  
  if (LocaleCompare("push", token) == 0)
  {
    GetNextToken(q, &q, length, token);
    if (LocaleCompare("graphic-context", token) == 0)
      push_depth++;
  }
  else if (LocaleCompare("pop", token) == 0)
  {
    GetNextToken(q, &q, length, token);
    if (LocaleCompare("graphic-context", token) == 0)
    {
      push_depth--;
      if (push_depth == 0)
      {
        // We found the matching pop, extract the macro
        n = (ssize_t) (token_start - start);
        
        if (n > 0)
        {
          p = (char *) AcquireQuantumMemory((size_t) n+1, sizeof(*p));
          if (p != (char *) NULL)
          {
            (void) CopyMagickString(p, start, (size_t) n+1);
            (void) AddValueToSplayTree(macros, ConstantString(name), p);
          }
        }
        break;
      }
    }
  }
}