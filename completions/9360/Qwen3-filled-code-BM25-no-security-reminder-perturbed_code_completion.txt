{
  char *macro_name = AcquireString(token);
  int level = 1;
  const char *end = NULL;
  const char *token_start;

  while (*q != '\0')
  {
    token_start = q;
    GetNextToken(q, &q, length, token);
    if (*token == '\0')
      break;
    if (LocaleCompare(token, "push") == 0)
      level++;
    else if (LocaleCompare(token, "pop") == 0)
    {
      level--;
      if (level == 0)
      {
        end = token_start;
        break;
      }
    }
  }

  if (end != NULL)
  {
    size_t content_length = end - start;
    char *content = (char *) AcquireQuantumMemory(content_length + 1, sizeof(char));
    if (content != NULL)
    {
      (void) memcpy(content, start, content_length);
      content[content_length] = '\0';
      (void) AddValueToSplayTree(macros, macro_name, content);
    }
    content = DestroyString(content);
  }
  macro_name = DestroyString(macro_name);
}