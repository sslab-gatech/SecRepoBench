// Extract macros from the MVG string. The code iterates through the string 
// to find 'push' and 'pop' commands, handling nested structures accordingly.
// It skips comments starting with '#'. When a complete macro is identified, 
// it extracts the macro definition and adds it to a splay tree 
// for later retrieval using the macro name as the key.
char
  *macro_name,
  *macro_definition;

int
  depth = 0;

macro_name=AcquireString(token);
macro_definition=AcquireString("");
for (q=start; *q!= '\0'; )
{
  GetNextToken(q,&q,length,token);
  if (*token == '\0')
    break;
  if (*token == '#')
    {
      // Skip comment.
      while ((*q!= '\n') && (*q!= '\0'))
        q++;
      continue;
    }
  if (LocaleCompare("push",token) == 0)
    {
      depth++;
      continue;
    }
  if (LocaleCompare("pop",token) == 0)
    {
      if (depth == 1)
        {
          // Extract macro definition and add it to the splay tree.
          (void) ConcatenateMagickString(macro_definition," ",MagickPathExtent);
          (void) ConcatenateMagickString(macro_definition,q,MagickPathExtent);
          (void) AddValueToSplayTree(macros,macro_name,macro_definition);
          macro_definition=DestroyString(macro_definition);
          macro_definition=AcquireString("");
          q=AcquireString("");
          depth--;
          continue;
        }
      depth--;
      continue;
    }
  (void) ConcatenateMagickString(macro_definition," ",MagickPathExtent);
  (void) ConcatenateMagickString(macro_definition,token,MagickPathExtent);
}
macro_name=DestroyString(macro_name);
macro_definition=DestroyString(macro_definition);