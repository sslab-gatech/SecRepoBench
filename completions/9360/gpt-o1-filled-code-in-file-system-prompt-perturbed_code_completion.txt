{
  /* Named macro (e.g. push graphic-context "wheel"). */
  GetNextToken(q, &q, length, token);
  (void) CopyMagickString(name, token, MagickPathExtent);

  start = q;
  n = 1;
  for (end = q; *end != '\0'; )
  {
    GetNextToken(end, &end, length, token);
    if (*token == '#')
      {
        /* Skip comment lines */
        while ((*end != '\n') && (*end != '\0'))
          end++;
        continue;
      }
    if (LocaleCompare("push", token) == 0)
      n++;
    else if (LocaleCompare("pop", token) == 0)
      n--;
    if (n == 0)
      break;
  }
  if (*end != '\0')
    {
      /*
        The macro definition extends from 'start' up to the location just
        before "pop" matched. Store the definition in the SplayTree using
        the 'name' as the key.
      */
      size_t macro_length = (size_t) (end - start);
      char *macro = (char *) AcquireQuantumMemory(macro_length + 1, sizeof(*macro));
      if (macro == (char *) NULL)
        {
          (void) ThrowMagickException(exception,GetMagickModule(),
            ResourceLimitError,"MemoryAllocationFailed","`%s'","");
          break;
        }
      (void) CopyMagickString(macro, start, macro_length + 1);
      (void) AddValueToSplayTree(macros, ConstantString(name), macro);
    }
}