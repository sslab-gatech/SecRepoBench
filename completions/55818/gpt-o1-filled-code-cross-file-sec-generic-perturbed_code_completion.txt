#ifdef MOZILLA_CLIENT
#error "This code must not be compiled in the Mozilla client."
#endif

if (utf8) {
    // start from the beginning of the string
    size_t pos = 0;
    // skip 'cpdmin' UTF-8 characters
    for (size_t skipped = 0; skipped < cpdmin && pos < len; ++skipped) {
        unsigned char c = (unsigned char)word[pos];
        if ((c & 0x80) == 0) {
            // 1-byte character
            ++pos;
        } else if ((c & 0xE0) == 0xC0 && pos + 1 < len) {
            pos += 2; // 2-byte character
        } else if ((c & 0xF0) == 0xE0 && pos + 2 < len) {
            pos += 3; // 3-byte character
        } else if ((c & 0xF8) == 0xF0 && pos + 3 < len) {
            pos += 4; // 4-byte character
        } else {
            // invalid or continuation byte, move one step to avoid looping
            ++pos;
        }
    }
    // set the minimum character index after skipping
    *mincharindex = (pos < len) ? pos : len;

    // set the maximum character index to the end
    *cmax = len;
    // exclude trailing continuation bytes
    while (*cmax > *mincharindex && (*cmax > 0)
           && ((word[*cmax - 1] & 0xC0) == 0x80)) {
        --(*cmax);
    }
} else {
    // in non-UTF-8 mode, just shift by 'cpdmin' if possible
    *mincharindex = (cpdmin < len) ? cpdmin : len;
    *cmax = len;
}