int status;
    size_t footer_start;
    uint8_t *pb;
    size_t out_size;
    void *out_buf;
    z_stream strm;
    uint32_t crc;

    /* Calculate worst case output size (zlib documentation suggests this formula) */
    out_size = input_size + ((input_size + 7) >> 3) + ((input_size + 63) >> 6) + 5;
    out_size += FLB_GZIP_HEADER_OFFSET + 8; /* Add space for header and footer */

    /* Allocate output buffer */
    out_buf = flb_malloc(out_size);