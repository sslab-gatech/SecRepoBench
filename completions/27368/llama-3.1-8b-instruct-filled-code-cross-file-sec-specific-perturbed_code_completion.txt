// Allocate memory for the output buffer based on the calculated maximum size.
// This is a potential heap overflow condition, so we need to be careful.
// We will use a safe allocation function that checks for overflow.
void *out_buf = flb_safe_malloc(max_size);
if (!out_buf) {
    flb_errno();
    flb_error("[gzip] could not allocate outgoing buffer");
    return NULL;
}