{
  size_t quantum_bytes, channels;

  /* Compute number of bytes per quantum sample */
  quantum_bytes = (quantumdata->depth + 7UL) / 8UL;

  /* Determine the number of channels for the image.
     Assume GetPixelChannels() is a helper that returns the channel count. */
  channels = GetPixelChannels(image);

  /* Calculate the total required memory for the quantum pixel buffer */
  extent = image->columns * image->rows * channels * quantum_bytes;

  /* Allocate or reallocate the quantum pixel buffer as necessary */
  if (quantumdata->pixels == (unsigned char *) NULL)
  {
    quantumdata->pixels = (unsigned char *) MagickMalloc(extent);
    if (quantumdata->pixels == (unsigned char *) NULL)
      return(MagickFalse);
  }
  else if (quantumdata->extent < extent)
  {
    unsigned char *p = (unsigned char *) MagickRealloc(quantumdata->pixels, extent);
    if (p == (unsigned char *) NULL)
      return(MagickFalse);
    quantumdata->pixels = p;
  }
  quantumdata->extent = extent;
  return(MagickTrue);
}