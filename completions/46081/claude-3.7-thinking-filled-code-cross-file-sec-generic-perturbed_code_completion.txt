switch (quantumdata->format)
{
  case FloatingPointQuantumFormat:
  {
    quantum=quantumdata->depth;
    if (quantum == 16)
      quantum=quantumdata->depth <= 10 ? 32 : 64;
    if (quantum == 32)
      quantum=quantumdata->depth <= 24 ? 32 : 64;
    break;
  }
  default:
  {
    quantum=quantumdata->depth;
    break;
  }
}
if (quantum != quantumdata->quantum)
{
  size_t
    quantum_size;

  /*
    Allocate or reallocate quantum pixel buffer.
  */
  quantum_size=0;
  if ((image->columns != 0) && (image->rows != 0) && (quantumdata->pad != 0) &&
      (quantumdata->depth != 0))
  {
    double
      channels_per_pixel;

    channels_per_pixel=(double) GetPixelChannels(image);
    if (quantumdata->pad > channels_per_pixel)
      channels_per_pixel=quantumdata->pad;
    
    /* Check for potential overflow */
    if (quantum > (SIZE_MAX/(channels_per_pixel+0.5)))
      return(MagickFalse);
    
    quantum_size=(size_t) ((quantum*(channels_per_pixel+0.5)+7)/8);
    if (quantum_size > (SIZE_MAX/image->columns))
      return(MagickFalse);
    
    quantum_size*=image->columns;
    if (quantum_size > (SIZE_MAX/image->rows))
      return(MagickFalse);
    
    extent=quantum_size*image->rows;
    if (extent < quantum_size)
      return(MagickFalse);
  }
  
  if (quantum_size == 0)
  {
    if (quantumdata->pixels != (unsigned char *) NULL)
    {
      quantumdata->pixels=(unsigned char *) RelinquishMagickMemory(
        quantumdata->pixels);
      quantumdata->extent=0;
    }
    quantumdata->quantum=quantum;
    return(MagickTrue);
  }
  
  if ((quantum_size > quantumdata->extent) || 
      (quantumdata->pixels == (unsigned char *) NULL))
  {
    if (quantumdata->pixels != (unsigned char *) NULL)
      quantumdata->pixels=(unsigned char *) RelinquishMagickMemory(
        quantumdata->pixels);
    quantumdata->pixels=(unsigned char *) AcquireMagickMemory(extent);
    if (quantumdata->pixels == (unsigned char *) NULL)
    {
      quantumdata->extent=0;
      return(MagickFalse);
    }
    quantumdata->extent=extent;
  }
  quantumdata->quantum=quantum;
}
return(MagickTrue);