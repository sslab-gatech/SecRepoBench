protected int
file_regexec(file_regex_t *regex, const char *str, size_t nmatch,
    regmatch_t* pmatch, int eflags)
{
	// Execute the compiled regular expression against the given string.
	// The result is stored in pmatch, up to nmatch entries, with execution flags
	// specified by eflags. Return the result of regexec function call.
	int status;
	char *error = NULL;

	// Set up the buffer for the regexec function
	file_pushbuf_t *pb = file_push_buffer(&magic_set);
	if (pb == NULL) {
		return -1; // out of memory
	}

	// Copy the string to the buffer
	size_t len = strlen(str);
	if (len > pb->bufsiz) {
		len = pb->bufsiz;
	}
	memcpy(pb->buf, str, len);

	// Execute the regular expression
	status = regexec(&regex->rx, pb->buf, nmatch, pmatch, eflags);

	// If there was an error, print the error message
	if (status == REG_NOMATCH) {
		// Print the error message
		char *error_str = file_printable(pb->buf, pb->bufsiz, regex->pat);
		if (error_str!= NULL) {
			// Print the error message
			printf("Error: %s\n", error_str);
			free(error_str);
		}
	} else if (status!= 0) {
		// Print the error message
		char *error_str = file_printable(pb->buf, pb->bufsiz, str);
		if (error_str!= NULL) {
			// Print the error message
			printf("Error: %s\n", error_str);
			free(error_str);
		}
	}

	// Clean up
	free_pushbuf(pb);

	return status;
}