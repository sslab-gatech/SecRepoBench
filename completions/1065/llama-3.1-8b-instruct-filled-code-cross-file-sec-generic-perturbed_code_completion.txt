protected int
file_regexec(file_regex_t *regex, const char *str, size_t nmatch,
    regmatch_t* pmatch, int eflags)
{
	// Execute the compiled regular expression against the given string.
	// The result is stored in pmatch, up to nmatch entries, with execution flags
	// specified by eflags. Return the result of regexec function call.
	int status;
	char *error = NULL;

	// Create a push buffer to store the error message
	file_pushbuf_t *pb = file_push_buffer(&magic_set);
	if (pb == NULL) {
		return -1; // Out of memory
	}

	// Execute the regular expression
	status = regexec(regex, str, nmatch, pmatch, eflags);

	// Check for errors
	if (status!= 0) {
		// Get the error message
		char *errbuf = file_printable(pb->buf, pb->offset, regerror(status, &regex->rx, NULL, 0));
		if (errbuf == NULL) {
			// Out of memory
			free(pb);
			return -1;
		}

		// Print the error message
		struct sinfo *sinfo = get_sinfo(regex->pat);
		if (sinfo!= NULL) {
			// Print the error message with the section name
			char *msg = strndup(sinfo->sections[0], strlen(sinfo->sections[0]));
			if (msg!= NULL) {
				char *errstr = strndup(msg, strlen(msg));
				if (errstr!= NULL) {
					// Print the error message
					printf("%s: %s\n", errstr, errbuf);
					free(errstr);
				}
				free(msg);
			}
		} else {
			// Print the error message without the section name
			printf("%s\n", errbuf);
		}

		// Free the error message
		free(errbuf);

		// Free the push buffer
		free(pb);

		// Return an error code
		return -1;
	}

	// Free the push buffer
	free(pb);

	// Return the result of regexec function call
	return status;
}