// Retrieve data from two matrix stages in the pipeline.
// Ensure that the input offset of the first matrix is zero.
// Multiply the matrices to combine them into a single result matrix.
// Determine if the resulting matrix is an identity matrix and whether the offset is null.
// Set the appropriate flags to indicate if the matrix can be optimized away due to being an identity matrix.

if (cmsPipelineCheckAndRetreiveStages(Src, 4,
        cmsSigCurveSetElemType, cmsSigMatrixElemType, cmsSigMatrixElemType, cmsSigCurveSetElemType,
        &Curve1, &Matrix1, &Matrix2, &Curve2)) {

    // Ensure that the input offset of the first matrix is zero.
    _cmsStageMatrixData* Data1 = (_cmsStageMatrixData*)cmsStageData(Matrix1);
    if (Data1->Offset != NULL) return FALSE;

    // Multiply the matrices to combine them into a single result matrix.
    cmsMAT3 res;
    _cmsMAT3per(&res, (cmsMAT3*)Data2->Double, (cmsMAT3*)Data1->Double);

    // Determine if the resulting matrix is an identity matrix and whether the offset is null.
    isIdentityMatrix = FALSE;
    if (_cmsMAT3isIdentity(&res) && Data2->Offset == NULL) {
        isIdentityMatrix = TRUE;
    }

    // Set the appropriate flags to indicate if the matrix can be optimized away due to being an identity matrix.
    if (isIdentityMatrix) {
        *dwFlags |= cmsFLAGS_MATRIX_IS_IDENTITY;
    } else {
        *dwFlags &= ~cmsFLAGS_MATRIX_IS_IDENTITY;
    }
} else {
    return FALSE; // Not optimizeable this time
}