if(packet->payload_packet_len >= 20) {
  /* Check for uTP - Micro Transport Protocol */
  if((packet->payload[0] & 0x0F) <= 4 /* ST_NUM_STATES */) {
    if(packet->payload[1] == 0 /* Version 0 */) {
      /* This is likely uTP */
      NDPI_LOG_INFO(detectionmodule, "found BT: uTP\n");
      ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
      return;
    }
  }
  
  /* Direct check for BitTorrent protocol */
  bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, 
                         packet->payload_packet_len);
  if(bt_proto) {
    goto bittorrent_found;
  }
  
  /* Check for BitTorrent search strings */
  if(ndpi_strnstr((const char *)packet->payload, bt_search, packet->payload_packet_len) != NULL) {
    NDPI_LOG_INFO(detectionmodule, "found BT: bt_search\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
  
  if(ndpi_strnstr((const char *)packet->payload, bt_search1, packet->payload_packet_len) != NULL) {
    NDPI_LOG_INFO(detectionmodule, "found BT: bt_search1\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
}