if(packet->payload_packet_len >= 20) {
  /* Check for BT-SEARCH pattern */
  if((packet->payload_packet_len >= strlen(bt_search))
     && (memcmp(packet->payload, bt_search, strlen(bt_search)) == 0)) {
    bt_proto = NULL;
    goto bittorrent_found;
  }
  
  /* uTP detection - BEP-0029 */
  if(((packet->payload[0] & 0x0F) == 0) && (packet->payload[0] >= 0) && (packet->payload[0] <= 4)) {
    /* Check for uTP v0 */
    if((packet->payload[1] >= 0) && (packet->payload[1] <= 4) /* Type */ &&
       (packet->payload[17] == 0) /* Next extension */ &&
       (ntohs(*(u_int16_t*)&packet->payload[18]) <= 150 /* Max window */)) {
      NDPI_LOG_INFO(detectionmodule, "found BT: uTP v0\n");
      ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
      return;
    }
  }
  
  /* Additional BitTorrent DHT patterns not covered by the checks below */
  if(ndpi_strnstr((const char *)packet->payload, "d1:q", packet->payload_packet_len) != NULL ||
     ndpi_strnstr((const char *)packet->payload, "d1:r", packet->payload_packet_len) != NULL ||
     ndpi_strnstr((const char *)packet->payload, "d1:e", packet->payload_packet_len) != NULL) {
    NDPI_LOG_INFO(detectionmodule, "found BT: DHT\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
}