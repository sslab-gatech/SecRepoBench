if(packet->payload_packet_len >= 20) {
  /* Check for uTP protocol v0 */
  if(packet->payload[0] == 0x01 && 
     packet->payload[1] == 0x00 && 
     (packet->payload[2] == 0x00 || packet->payload[2] == 0x01) && 
     packet->payload[3] <= 0x05) {
    
    NDPI_LOG_INFO(detectionmodule, "Found BT: uTP v0\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
  
  /* Check for uTP protocol v1 */
  if((packet->payload[0] & 0x0f) == 0x01 && 
     (packet->payload[1] == 0x00 || packet->payload[1] == 0x01) && 
     packet->payload_packet_len >= ((packet->payload[0] & 0x10) ? 23 : 20)) {
    
    NDPI_LOG_INFO(detectionmodule, "Found BT: uTP v1\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
  
  /* Check for BitTorrent protocol string */
  if((bt_proto = ndpi_strnstr((const char *)packet->payload, 
                             BITTORRENT_PROTO_STRING, 
                             packet->payload_packet_len)) != NULL) {
    goto bittorrent_found;
  }
}

/* Check for BT-SEARCH string */
if(ndpi_strnstr((const char *)packet->payload, bt_search, packet->payload_packet_len) != NULL) {
  NDPI_LOG_INFO(detectionmodule, "Found BT: search\n");
  ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
  return;
}

/* Check for d1:ad2:id20: string */
if(ndpi_strnstr((const char *)packet->payload, bt_search1, packet->payload_packet_len) != NULL) {
  NDPI_LOG_INFO(detectionmodule, "Found BT: search1\n");
  ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
  return;
}

/* Check for DHT messages */
if(packet->payload_packet_len >= 4) {
  if(packet->payload[0] == 'd' && packet->payload[1] == '1' && 
     packet->payload[2] == ':' && packet->payload[3] == 'a') {
    
    NDPI_LOG_INFO(detectionmodule, "Found BT: DHT\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
}