if(packet->payload_packet_len >= 20) {
  if(ndpi_strnstr((const char *)packet->payload, bt_search, packet->payload_packet_len) ||
     ndpi_strnstr((const char *)packet->payload, bt_search1, packet->payload_packet_len)) {
    goto bittorrent_found;
  }

  if(packet->payload[0] == 0x13) { /* uTP protocol v0 */
    if((packet->payload[1] == 0x00) && (packet->payload[2] == 0x00) && (packet->payload[3] == 0x00) &&
       (packet->payload[8] == 0x00) && (packet->payload[9] == 0x00) && (packet->payload[10] == 0x00) &&
       (packet->payload[11] == 0x00)) {
      goto bittorrent_found;
    }
  } else if(packet->payload[0] == 0x01) { /* uTP protocol v1 */
    if((packet->payload[1] >= 0x00) && (packet->payload[1] <= 0x04) &&
       (packet->payload[2] == 0x00) && (packet->payload[3] == 0x00) &&
       (packet->payload[8] == 0x00) && (packet->payload[9] == 0x00) &&
       (packet->payload[10] == 0x00) && (packet->payload[11] == 0x00)) {
      if((bt_proto = ndpi_strnstr((const char *)&packet->payload[20], BITTORRENT_PROTO_STRING, packet->payload_packet_len - 20))) {
        goto bittorrent_found;
      }
    }
  }

  /* Check for BitTorrent protocol string */
  if((bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len))) {
    goto bittorrent_found;
  }

  /* Apply heuristics */
  if((packet->payload[0] == 'd') && (packet->payload[1] == '1') &&
     (packet->payload[2] == ':') && (packet->payload[3] >= 'a') && (packet->payload[3] <= 'z') &&
     (packet->payload[4] == 'd') && (packet->payload[5] == '2') && (packet->payload[6] == ':')) {
    goto bittorrent_found;
  }
}