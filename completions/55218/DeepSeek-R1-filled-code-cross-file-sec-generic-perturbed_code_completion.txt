// Check for uTP header (version 1) and BitTorrent protocol string
if(packet->payload_packet_len >= 4 && (packet->payload[0] & 0x0F) == 1) {
    bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len);
    if(bt_proto)
        goto bittorrent_found;
}

// Check for BitTorrent protocol v0 handshake
if(packet->payload_packet_len >= 20 && packet->payload[0] == 0x13 /* 19 byte protocol string */) {
    if(memcmp(&packet->payload[1], "BitTorrent protocol", 19) == 0) {
        bt_proto = (char *)packet->payload;
        goto bittorrent_found;
    }
}

// Check for protocol v0 message IDs after 20-byte header
if(packet->payload_packet_len > 20 && packet->payload[20] <= 0x09 /* valid message IDs 0x00-0x09 */) {
    goto bittorrent_found;
}

// Check for known UDP patterns
if((packet->payload_packet_len >= strlen(bt_search) && memcmp(packet->payload, bt_search, strlen(bt_search)) == 0) ||
   (packet->payload_packet_len >= strlen(bt_search1) && memcmp(packet->payload, bt_search1, strlen(bt_search1)) == 0)) {
    goto bittorrent_found;
}