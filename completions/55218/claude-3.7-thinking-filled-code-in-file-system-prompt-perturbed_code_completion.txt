if(packet->payload_packet_len > 8) {
  /* uTP */
  if(is_utpv1_pkt(packet->payload, packet->payload_packet_len)) {
    NDPI_LOG_INFO(detectionmodule, "found BT: uTP\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
  
  /* uTP version 0 */
  if(packet->payload_packet_len >= 20 /* min size */ &&
     packet->payload[0] >= 0x01 && packet->payload[0] <= 0x04 /* Type */ &&
     packet->payload[1] >= 0x00 && packet->payload[1] <= 0x04 /* Version */) {
    
    /* Reasonable connection ID check */
    u_int16_t connection_id = (packet->payload[2] << 8) | packet->payload[3];
    if(connection_id != 0) {
      goto bittorrent_found;
    }
  }
  
  /* BitTorrent DHT */
  if(packet->payload[0] == 'd' && packet->payload[packet->payload_packet_len-1] == 'e') {
    if(ndpi_strnstr((const char *)packet->payload, "1:rd2:id20:", packet->payload_packet_len)) {
      goto bittorrent_found;
    }
  }
  
  /* Check for BitTorrent protocol in payload */
  bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len);
  
  /* BT-SEARCH detection */
  if(memcmp(packet->payload, bt_search, strlen(bt_search)) == 0) {
    goto bittorrent_found;
  }
}