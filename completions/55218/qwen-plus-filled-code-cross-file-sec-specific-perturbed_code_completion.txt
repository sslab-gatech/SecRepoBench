if (packet->payload_packet_len >= sizeof(BITTORRENT_PROTO_STRING) - 1) {
  char *proto_ptr = (char *)packet->payload;

  if (memcmp(proto_ptr, BITTORRENT_PROTO_STRING, sizeof(BITTORRENT_PROTO_STRING) - 1) == 0) {
    /* Potential BitTorrent protocol detected */
    NDPI_LOG_INFO(detectionmodule, "Potential BT: protocol string match\n");

    /* Ensure sufficient space to extract hash */
    if (packet->payload_packet_len >= 27 + sizeof(flow->protos.bittorrent.hash)) {
      memcpy(flow->protos.bittorrent.hash, &proto_ptr[27], sizeof(flow->protos.bittorrent.hash));
      flow->extra_packets_func = NULL; /* Nothing else to do */

      NDPI_LOG_INFO(detectionmodule, "found BT: uTP\n");
      ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
      return;
    }
  }
}

/* Check for specific patterns in payload */
if (packet->payload_packet_len > 0 && packet->payload_packet_len <= 65535) {
  char *search_buf = malloc(packet->payload_packet_len + 1);

  if (search_buf != NULL) {
    memcpy(search_buf, packet->payload, packet->payload_packet_len);
    search_buf[packet->payload_packet_len] = '\0';

    if (ndpi_strnstr(search_buf, bt_search, packet->payload_packet_len)
        || ndpi_strnstr(search_buf, bt_search1, packet->payload_packet_len)) {
      goto bittorrent_found;
    }

    free(search_buf);
  }
}