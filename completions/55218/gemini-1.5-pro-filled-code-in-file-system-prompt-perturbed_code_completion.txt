if(packet->payload_packet_len > 19
	 && (memcmp(packet->payload, bt_search, 19) == 0
	     || memcmp(packet->payload, bt_search1, 14) == 0)) {
	NDPI_LOG_INFO(detectionmodule, "found BT: udp search\n");
	ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 1, NDPI_CONFIDENCE_DPI);
	return;
      }

      if(packet->payload[0] == 0x00 || packet->payload[0] == 0x01 || packet->payload[0] == 0x02 || packet->payload[0] == 0x03) {
	if(packet->payload[0] == 0) {
	  if(packet->payload_packet_len < 2) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	  if(packet->payload[1] != 0x00) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	}
	if(packet->payload[0] == 1) {
	  if(packet->payload_packet_len < 2) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	  if(packet->payload[1] != 0x04) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	}
	if(packet->payload[0] == 2) {
	  if(packet->payload_packet_len < 2) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	  if(packet->payload[1] != 0x05) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	}
	if(packet->payload[0] == 3) {
	  if(packet->payload_packet_len < 2) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	  if(packet->payload[1] != 0x04) {
	    ndpi_skip_bittorrent(detectionmodule, flow, packet);
	    return;
	  }
	}

	if(is_utpv1_pkt(packet->payload, packet->payload_packet_len)) {
	  if(packet->payload_packet_len > 27
	     && (bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len)))
	    goto bittorrent_found;
	}

	if(packet->payload_packet_len > 27
	   && (bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len)))
	  goto bittorrent_found;

	/* Some DHT clients use these ports. So we can't rely on them. */
	if(is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6881)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6882)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6883)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6884)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6885)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6886)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6887)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6888)
	   || is_port(ntohs(packet->udp->source), ntohs(packet->udp->dest), 6889)) {
	  if(packet->payload_packet_len > 27
	     && (bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len)))
	    goto bittorrent_found;
	}
      }