if(packet->payload_packet_len >= 20) {
  if(is_utpv1_pkt(packet->payload, packet->payload_packet_len)) {
    if(packet->payload_packet_len > 28) {
      if(memcmp(&packet->payload[20], BITTORRENT_PROTO_STRING, 8) == 0) {
        bt_proto = (char*)&packet->payload[20];
        goto bittorrent_found;
      }
    }
  } else {
    /* Check for BitTorrent protocol string */
    if((bt_proto = ndpi_strnstr((const char *)packet->payload, BITTORRENT_PROTO_STRING, packet->payload_packet_len))) {
      goto bittorrent_found;
    }
    
    /* Check for specific BitTorrent patterns */
    if(ndpi_strnstr((const char *)packet->payload, bt_search, packet->payload_packet_len) ||
       ndpi_strnstr((const char *)packet->payload, bt_search1, packet->payload_packet_len)) {
      goto bittorrent_found;
    }
  }
  
  /* Additional heuristics */
  if(packet->payload[0] == 'd' && packet->payload[packet->payload_packet_len-1] == 'e') {
    if(ndpi_strnstr((const char *)packet->payload, "1:a", packet->payload_packet_len) &&
       ndpi_strnstr((const char *)packet->payload, "1:q", packet->payload_packet_len) &&
       ndpi_strnstr((const char *)packet->payload, "1:y", packet->payload_packet_len)) {
      goto bittorrent_found;
    }
  }
}