/* Check for BitTorrent search string */
if(packet->payload_packet_len > 0) {
  if(ndpi_strnstr((const char *)packet->payload, bt_search, packet->payload_packet_len)) {
    NDPI_LOG_INFO(detectionmodule, "found BT: search string\n");
    ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
    return;
  }
}

/* Check for uTP (Micro Transport Protocol) */
if(packet->payload_packet_len >= 20) {
  u_int8_t version = (packet->payload[0] & 0x0F);
  u_int8_t type = (packet->payload[0] & 0xF0) >> 4;
  
  if(version <= 4 && type <= 4) {
    /* Valid uTP packet type and version */
    if((type == 0) /* DATA */ || (type == 4) /* SYN */) {
      NDPI_LOG_INFO(detectionmodule, "found BT: uTP protocol\n");
      ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0, NDPI_CONFIDENCE_DPI);
      return;
    }
  }
}