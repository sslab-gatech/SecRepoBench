if(packet->payload_packet_len > 15
         && (memcmp(packet->payload, bt_search, 15) == 0
             || memcmp(packet->payload, bt_search1, 12) == 0)) {
        NDPI_LOG_INFO(detectionmodule, "found BT: UDP bt_search(1)\n");
        ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0,
                                         NDPI_CONFIDENCE_DPI);
        return;
      }

      if(packet->payload[0] == 0x00 || packet->payload[0] == 0x01 || packet->payload[0] == 0x02 || packet->payload[0] == 0x03) {
        if(packet->payload[0] == 0) { /* BT-DHT */
          if(packet->payload_packet_len > 26 && memcmp(&packet->payload[21], "nodes", 5) == 0) {
            NDPI_LOG_INFO(detectionmodule, "found BT: UDP BT-DHT nodes\n");
            ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0,
                                             NDPI_CONFIDENCE_DPI);
            return;
          }
	  if(packet->payload_packet_len > 25 && memcmp(&packet->payload[20], "nodes", 5) == 0) {
            NDPI_LOG_INFO(detectionmodule, "found BT: UDP BT-DHT nodes\n");
            ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0,
                                             NDPI_CONFIDENCE_DPI);
            return;
          }
        } else if(packet->payload[0] == 3) {
          if(packet->payload_packet_len > 25 && memcmp(&packet->payload[20], "files", 5) == 0) {
            NDPI_LOG_INFO(detectionmodule, "found BT: UDP BT-DHT files\n");
            ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0,
                                             NDPI_CONFIDENCE_DPI);
            return;
          }
        }
      }

      if(is_utpv1_pkt(packet->payload, packet->payload_packet_len)) {
        if(packet->payload_packet_len > 27
           && memcmp(&packet->payload[27], BITTORRENT_PROTO_STRING, 19) == 0) {
          NDPI_LOG_INFO(detectionmodule, "found BT: UDP uTPv1\n");
          ndpi_add_connection_as_bittorrent(detectionmodule, flow, 46, 1,
                                           NDPI_CONFIDENCE_DPI);
          return;
        }
      }

      /* Some DHT clients use 0x041327101980 as transaction id */
      if(packet->payload_packet_len > 15 && memcmp(packet->payload, "\x04\x13\x27\x10\x19\x80", 6) == 0) {
        NDPI_LOG_INFO(detectionmodule, "found BT: UDP 0x041327101980\n");
        ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0,
                                         NDPI_CONFIDENCE_DPI);
        return;
      }

      if(packet->payload_packet_len > 15 && memcmp(packet->payload, "\x00\x00\x04\x17\x27\x10\x19\x80", 8) == 0) {
        NDPI_LOG_INFO(detectionmodule, "found BT: UDP 0x0000041727101980\n");
        ndpi_add_connection_as_bittorrent(detectionmodule, flow, -1, 0,
                                         NDPI_CONFIDENCE_DPI);
        return;
      }

      if(packet->payload_packet_len > 3 && memcmp(packet->payload, "\xff\xff\xff\xff", 4) == 0)
	goto bittorrent_found;
      if(packet->payload_packet_len > 15 && memcmp(packet->payload, "\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x8b\x08\x00\x00\x00\x00\x00", 16) == 0)
	goto bittorrent_found;