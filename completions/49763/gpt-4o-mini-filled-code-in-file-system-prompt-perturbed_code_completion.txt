mp_dbl_limb qhat, rhat;
  mp_limb *p = y->p;
  mp_limb *q = q.p;
  mp_limb *x_p = x->p;
  size_t j, k;

  for (i = xd; i-- > 0;) {
    qhat = (mp_dbl_limb)(x_p[i + y->sz] * DIG_BASE + x_p[i]) / p[y->sz - 1];
    rhat = (mp_dbl_limb)(x_p[i + y->sz] * DIG_BASE + x_p[i]) % p[y->sz - 1];

    if (qhat >= DIG_BASE || (qhat * p[y->sz - 2] > (rhat * DIG_BASE + (i > 0 ? x_p[i - 1] : 0)))) {
      qhat--;
      rhat += p[y->sz - 1];
      if (rhat >= DIG_BASE) {
        rhat -= DIG_BASE;
      }
    }

    q[i] = (mp_limb)qhat;
    mp_dbl_limb c = 0;

    for (j = 0; j < y->sz; j++) {
      c += (mp_dbl_limb)p[j] * qhat;
      rhat = (x_p[i + j] - (mp_limb)c);
      c >>= DIG_SIZE;
      x_p[i + j] = LOW(rhat);
    }
    for (; j < x->sz; j++) {
      rhat = (x_p[i + j] - (mp_limb)c);
      c >>= DIG_SIZE;
      x_p[i + j] = LOW(rhat);
    }
    x_p[i + y->sz] += (mp_limb)c;
  }