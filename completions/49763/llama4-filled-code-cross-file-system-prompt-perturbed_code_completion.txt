mp_dbl_limb b, d, ql, tmp;
mp_limb yl[DIGS_PER_LIMB];
size_t ql_sz;

  mpz_realloc(mrb, &q, xd);
  for (i = xd; i > 0; i--) {
    if (i < ydigits) {
      b = 0;
    }
    else {
      b = x.p[i-1];
    }
    if (i > 1) {
      yl[0] = y.p[ydigits-2];
      yl[1] = y.p[ydigits-1];
      d = yl[1] + (yl[0] << DIG_SHIFT);
    }
    else {
      d = y.p[ydigits-1];
    }
    ql = b / d;
    if (ql > MP_LIMB_MAX) {
      ql = MP_LIMB_MAX;
    }
    tmp = ql * y.p[ydigits-1];
    if (i > 1) {
      if (tmp > (b << DIG_SHIFT) + x.p[i-2]) {
        ql--;
        tmp = ql * y.p[ydigits-1];
      }
    }
    else {
      if (tmp > b) {
        ql--;
        tmp = ql * y.p[ydigits-1];
      }
    }
    q.p[i-1] = ql;
    if (i > ydigits) {
      continue;
    }
    ql_sz = i;
    tmp = 0;
    if (i > 1) {
      tmp = ql * yl[0];
    }
    tmp += ql * y.p[ydigits-2];
    if (i > 2) {
      if (tmp > (b << DIG_SHIFT) + x.p[i-3]) {
        ql--;
      }
    }
  }
  q.sz = ql_sz;