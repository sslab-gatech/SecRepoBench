mp_dbl_limb qhat, rhat;
  size_t j, qsize = 0;

  for (i = xd; i-- > 0;) {
    qhat = (mp_dbl_limb)(x.p[i]) / (mp_dbl_limb)(y.p[ydigits - 1]);
    rhat = (mp_dbl_limb)(x.p[i]) % (mp_dbl_limb)(y.p[ydigits - 1]);

    if (qhat > DIG_MASK) {
      qhat = DIG_MASK;
      rhat = (mp_dbl_limb)(x.p[i]) - (mp_dbl_limb)(qhat) * (mp_dbl_limb)(y.p[ydigits - 1]);
    }

    q.p[i] = (mp_limb)qhat;
    r.p[i] = (mp_limb)rhat;

    for (j = 0; j < ydigits; j++) {
      mp_dbl_limb prod = (mp_dbl_limb)qhat * (mp_dbl_limb)(y.p[j]);
      rhat += (mp_dbl_limb)(x.p[i + j]) - prod;
      x.p[i + j] = (mp_limb)rhat;
      rhat >>= DIG_SIZE;
    }

    if (rhat != 0) {
      q.p[i]--;
      rhat = 0;
      for (j = 0; j < ydigits; j++) {
        rhat += (mp_dbl_limb)(x.p[i + j]) + (mp_dbl_limb)(y.p[j]);
        x.p[i + j] = (mp_limb)rhat;
        rhat >>= DIG_SIZE;
      }
    }
  }