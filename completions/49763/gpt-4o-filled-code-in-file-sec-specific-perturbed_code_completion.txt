mpz_set(mrb, &x, xx);
  mpz_realloc(mrb, &x, xd);
  mpz_realloc(mrb, &q, xd - ydigits + 1);
  for (i = xd - ydigits; i < xd; i++) {
    q.p[i] = 0;
  }
  for (i = xd; i-- > ydigits;) {
    mp_dbl_limb qhat = ((mp_dbl_limb)x.p[i] << DIG_SIZE) + x.p[i - 1];
    qhat /= z;
    if (qhat > DIG_MASK) qhat = DIG_MASK;
    mp_dbl_limb k = 0;
    for (j = 0; j < ydigits; j++) {
      k += qhat * y.p[j];
      if (x.p[i - ydigits + j] < (mp_limb)k) {
        x.p[i - ydigits + j] += DIG_BASE - (mp_limb)k;
        k = (k >> DIG_SIZE) + 1;
      }
      else {
        x.p[i - ydigits + j] -= (mp_limb)k;
        k >>= DIG_SIZE;
      }
    }
    if (x.p[i] < k) {
      qhat--;
      k = 0;
      for (j = 0; j < ydigits; j++) {
        k += x.p[i - ydigits + j] + y.p[j];
        if (k >= DIG_BASE) {
          x.p[i - ydigits + j] = k - DIG_BASE;
          k = 1;
        }
        else {
          x.p[i - ydigits + j] = k;
          k = 0;
        }
      }
      x.p[i] += k;
    }
    q.p[i - ydigits] = (mp_limb)qhat;
  }