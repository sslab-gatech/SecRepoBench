for (i = xd - ydigits; i != (size_t)-1; i--) {
  mp_limb xi = (i + 1 < xd) ? x.p[i + 1] : 0;
  mp_limb qhat = ((mp_dbl_limb)xi << DIG_SIZE | x.p[i]) / z;
  mp_limb rhat = ((mp_dbl_limb)xi << DIG_SIZE | x.p[i]) - qhat * z;
  while (qhat >= BASE || (qhat * y.p[ydigits - 2] > (BASE * rhat + (i ? x.p[i - 1] : 0)))) {
    qhat--;
    rhat += z;
    if (rhat >= BASE)
      break;
  }
  mp_limb borrow = 0;
  for (size_t j = 0; j < ydigits; j++) {
    mp_limb prod = qhat * y.p[j];
    mp_limb diff = x.p[i + j] - borrow - (prod & MP_LIMB_MASK);
    x.p[i + j] = diff & MP_LIMB_MASK;
    borrow = (BASE - diff - 1) >> (8 * sizeof(mp_limb) - 1) & (prod >> DIG_SIZE);
  }
  mp_limb diff = x.p[i + ydigits] - borrow;
  x.p[i + ydigits] = diff & MP_LIMB_MASK;
  q.p[i] = qhat;
}