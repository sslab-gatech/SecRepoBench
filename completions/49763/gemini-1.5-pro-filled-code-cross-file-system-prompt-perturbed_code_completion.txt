for (i = xd - ydigits; i >= 0; i--) {
    mp_dbl_limb qhat;
    size_t j;

    if (x.p[i+ydigits] == z)
      qhat = MP_LIMB_MAX;
    else
      qhat = (x.p[i+ydigits]*MP_LIMB_HI + x.p[i+ydigits-1])/z;

    mp_dbl_limb t;
    while ((t = z * qhat) > (x.p[i+ydigits]*MP_LIMB_HI + x.p[i+ydigits-1]) ||
           ((t += y.p[ydigits-2]*qhat) > (x.p[i+ydigits-1]*MP_LIMB_HI + x.p[i+ydigits-2]) && ydigits > 1))
      qhat--;

    /* x -= y*qhat<<i*DIG_SIZE */
    mp_dbl_limb cy = 0;
    for (j = 0; j < ydigits; j++) {
      t = y.p[j] * qhat + cy;
      cy = t >> DIG_SIZE;
      t = x.p[i+j] - t;
      if (t > x.p[i+j])
        cy++;
      x.p[i+j] = t;
    }

    if (cy) {
      qhat--;
      mp_dbl_limb borrow = 0;
      for (j = 0; j < ydigits; j++) {
        t = x.p[i+j] + y.p[j] + borrow;
        borrow = t >> DIG_SIZE;
        x.p[i+j] = t;
      }
    }
    q.p[i] = qhat;
  }