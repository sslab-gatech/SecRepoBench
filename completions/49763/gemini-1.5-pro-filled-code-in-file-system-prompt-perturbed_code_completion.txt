for (i = xd - ydigits; ; i--) {
    mp_dbl_limb qhat;
    if (x.p[i+ydigits] == z)
      qhat = DIG_MASK;
    else
      qhat = (mp_limb)(((mp_dbl_limb)x.p[i+ydigits] << DIG_SIZE) + x.p[i+ydigits-1]) / z;

    mp_dbl_limb_signed borrow = 0;
    for (size_t j=0; j<ydigits; j++) {
      borrow += (mp_dbl_limb_signed)x.p[i+j];
      borrow -= qhat * y.p[j];
      x.p[i+j] = LOW(borrow);
      borrow = HIGH(borrow);
    }
    borrow += x.p[i+ydigits];
    x.p[i+ydigits] = LOW(borrow);

    if (HIGH(borrow) < 0) {
      qhat--;
      mp_dbl_limb carry = 0;
      for (size_t j=0; j<ydigits; j++) {
        carry += (mp_dbl_limb)x.p[i+j];
        carry += y.p[j];
        x.p[i+j] = LOW(carry);
        carry = HIGH(carry);
      }
      carry += x.p[i+ydigits];
      x.p[i+ydigits] = LOW(carry);
    }
    q.p[i] = (mp_limb)qhat;
    if (i == 0) break;
  }