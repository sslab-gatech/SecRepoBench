for (i = xd - ydigits; i >= 0; i--) {
  mp_limb hi = (i + ydigits < xd) ? x.p[i + ydigits] : 0;
  mp_dbl_limb w = ((mp_dbl_limb)hi << DIG_SIZE) | x.p[i + ydigits - 1];
  mp_limb qi = w / z;
  mp_limb ri = w % z;
  while (qi > DIG_BASE - 1 || qi * y.p[ydigits - 2] > ((mp_dbl_limb)ri << DIG_SIZE) | x.p[i + ydigits - 2]) {
    qi--;
    ri += z;
    if (ri >= DIG_BASE)
      break;
  }
  mp_limb k = 0;
  for (size_t j = 0; j < ydigits; j++) {
    mp_dbl_limb p = (mp_dbl_limb)qi * y.p[j] + k;
    k = p >> DIG_SIZE;
    mp_limb t = x.p[i + j] - (p & DIG_MASK) - (k ? 1 : 0);
    x.p[i + j] = t & DIG_MASK;
    k += t >> DIG_SIZE;
  }
  if (hi < k) {
    qi--;
    k = 0;
    for (size_t j = 0; j < ydigits; j++) {
      mp_limb t = x.p[i + j] + y.p[j] + k;
      x.p[i + j] = t & DIG_MASK;
      k = t >> DIG_SIZE;
    }
  }
  q.p[i] = qi;
}