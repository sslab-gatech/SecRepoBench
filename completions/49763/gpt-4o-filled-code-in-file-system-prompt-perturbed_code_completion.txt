for (i = xd - ydigits; i < xd; i++) {
    mp_dbl_limb qhat = ((mp_dbl_limb)x.p[i] << DIG_SIZE) | x.p[i - 1];
    qhat /= z;
    if (qhat > DIG_MASK) qhat = DIG_MASK;

    mp_dbl_limb k = 0;
    for (size_t j = 0; j < ydigits; j++) {
      k += qhat * y.p[j];
      if (x.p[i - j] < (mp_limb)k) {
        x.p[i - j] += DIG_BASE;
        x.p[i - j - 1]--;
      }
      x.p[i - j] -= (mp_limb)k;
      k >>= DIG_SIZE;
    }
    if (x.p[i - ydigits] < k) {
      qhat--;
      k = 0;
      for (size_t j = 0; j < ydigits; j++) {
        k += x.p[i - j] + y.p[j];
        if (k >= DIG_BASE) {
          x.p[i - j] = (mp_limb)(k - DIG_BASE);
          k = 1;
        }
        else {
          x.p[i - j] = (mp_limb)k;
          k = 0;
        }
      }
      x.p[i - ydigits] += (mp_limb)k;
    }
    q.p[i - ydigits] = (mp_limb)qhat;
  }