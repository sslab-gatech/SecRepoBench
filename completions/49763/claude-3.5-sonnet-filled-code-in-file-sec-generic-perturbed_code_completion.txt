for (size_t i = xd - 1; i >= ydigits - 1; i--) {
  mp_dbl_limb a = ((mp_dbl_limb)x.p[i] << DIG_SIZE) | x.p[i-1];
  mp_limb q = (mp_limb)(a / z);
  mp_dbl_limb r = a - (mp_dbl_limb)q * z;
  
  while (r < DIG_BASE && q == DIG_BASE && i >= 2 &&
         (r << DIG_SIZE) + x.p[i-2] < z * q) {
    q--;
    r += z;
  }

  mp_dbl_limb borrow = 0;
  for (size_t j = 0; j < ydigits; j++) {
    mp_dbl_limb p = (mp_dbl_limb)q * y.p[j] + borrow;
    borrow = p >> DIG_SIZE;
    mp_limb s = x.p[i-ydigits+j+1];
    if (s < (p & DIG_MASK)) borrow++;
    x.p[i-ydigits+j+1] = s - (p & DIG_MASK);
  }

  q.p[i-ydigits] = q;
  if (borrow > 0) {
    q.p[i-ydigits]--;
    mp_limb carry = 0;
    for (size_t j = 0; j < ydigits; j++) {
      mp_dbl_limb s = (mp_dbl_limb)x.p[i-ydigits+j+1] + y.p[j] + carry;
      x.p[i-ydigits+j+1] = s & DIG_MASK;
      carry = s >> DIG_SIZE;
    }
  }
}