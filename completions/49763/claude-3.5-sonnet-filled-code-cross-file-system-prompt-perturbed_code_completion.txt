for (i = xd - ydigits; i >= 0; i--) {
  mp_limb hi = (i + ydigits < xd) ? x.p[i + ydigits] : 0;
  mp_dbl_limb n = ((mp_dbl_limb)hi << DIG_SIZE) | x.p[i + ydigits - 1];
  mp_limb q_digit = n / z;
  mp_limb r = n % z;

  while (q_digit > DIG_BASE - 1 || (mp_dbl_limb)q_digit * y.p[ydigits - 2] > ((mp_dbl_limb)r << DIG_SIZE) | x.p[i + ydigits - 2]) {
    q_digit--;
    r += z;
    if (r >= DIG_BASE) break;
  }

  mp_limb borrow = submul(&x.p[i], &y.p[0], q_digit, ydigits);
  if (borrow > hi) {
    q_digit--;
    add(&x.p[i], &y.p[0], ydigits);
  }

  q.p[i] = q_digit;
}