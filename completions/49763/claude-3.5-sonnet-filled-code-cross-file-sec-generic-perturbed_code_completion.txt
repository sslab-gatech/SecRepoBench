for (i = xd - ydigits; i >= 0; i--) {
  mp_limb_t hi = (i + ydigits < xd) ? x.p[i + ydigits] : 0;
  mp_dbl_limb u = ((mp_dbl_limb)hi << DIG_SIZE) | x.p[i + ydigits - 1];
  mp_limb_t qi = u / z;
  mp_limb_t ri = u % z;
  while (qi > DIG_BASE || (mp_dbl_limb)qi * y.p[ydigits-2] > ((mp_dbl_limb)ri << DIG_SIZE) | x.p[i + ydigits - 2]) {
    qi--;
    ri += z;
    if (ri >= DIG_BASE) break;
  }
  mp_limb_t k = 0;
  mp_limb_t t = 0;
  for (size_t j = 0; j < ydigits; j++) {
    mp_dbl_limb p = (mp_dbl_limb)qi * y.p[j] + k;
    t = x.p[i + j] - (p & DIG_MASK) - t;
    x.p[i + j] = t & DIG_MASK;
    k = p >> DIG_SIZE;
    t = (t > DIG_MASK);
  }
  t = x.p[i + ydigits] - k - t;
  x.p[i + ydigits] = t & DIG_MASK;
  q.p[i] = qi;
  if (t < 0) {
    q.p[i]--;
    k = 0;
    for (size_t j = 0; j < ydigits; j++) {
      t = (mp_dbl_limb)x.p[i + j] + y.p[j] + k;
      x.p[i + j] = t & DIG_MASK;
      k = t >> DIG_SIZE;
    }
    x.p[i + ydigits] += k;
  }
}