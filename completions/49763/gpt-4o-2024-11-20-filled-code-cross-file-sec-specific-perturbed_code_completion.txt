for (i = xd; i-- > ydigits;) {
    mp_dbl_limb w = x.p[i];
    if (i > 0) {
      w = (w << DIG_SIZE) | x.p[i - 1];
    }
    mp_limb qhat = w / z;
    mp_limb rhat = w % z;

    if (qhat >= (1UL << DIG_SIZE)) {
      qhat = (1UL << DIG_SIZE) - 1;
      rhat += z;
    }

    while (rhat < (1UL << DIG_SIZE) && qhat * y.p[ydigits - 2] > ((rhat << DIG_SIZE) | x.p[i - 2])) {
      qhat--;
      rhat += z;
      if (rhat >= (1UL << DIG_SIZE)) {
        break;
      }
    }

    mpz_t t;
    mpz_init(mrb, &t);
    mpz_realloc(mrb, &t, ydigits + 1);
    umul(mrb, &t, &y, qhat);

    if (usub(mrb, &x, &x, &t, i - ydigits + 1)) {
      qhat--;
      uadd(mrb, &x, &x, &y, i - ydigits + 1);
    }

    q.p[i - ydigits] = qhat;
    mpz_clear(mrb, &t);
  }