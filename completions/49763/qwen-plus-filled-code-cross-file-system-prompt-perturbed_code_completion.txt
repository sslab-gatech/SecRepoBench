size_t j = xd - ydigits + 1;
for (i = 0; i < j; i++) {
  size_t k = xd - ydigits - i;
  mp_dbl_limb qhat;

  if (x.p[k+ydigits] != z) {
    qhat = x.p[k+ydigits] * BASE + x.p[k+ydigits-1];
    qhat /= z;
  }
  else {
    qhat = BASE - 1;
  }

  while (qhat * y.p[ydigits-2] > (x.p[k+ydigits-1] * BASE + x.p[k+ydigits-2]))
    qhat--;

  if (qhat != 0) {
    mpz_mul_int(mrb, &y, &y, qhat);
    if (mpz_cmp(mrb, &y, &x) > 0) {
      mpz_div_2exp(mrb, &y, &y, 1);
      mpz_sub(mrb, &x, &x, &y);
      q.p[i] = qhat - 1;
    }
    else {
      mpz_sub(mrb, &x, &x, &y);
      q.p[i] = qhat;
    }
  }
}