static void
udiv(mrb_state *mrb, mpz_t *qq, mpz_t *rr, mpz_t *xx, mpz_t *yy)
{
  /* simple cases */
  int cmp = ucmp(xx, yy);
  if (cmp == 0) {
    mpz_set_int(mrb, qq, 1);
    zero(rr);
    return;
  }
  else if (cmp < 0) {
    zero(qq);
    mpz_set(mrb, rr, xx);
    return;
  }

  mpz_t q, x, y;
  size_t i;

  mrb_assert(!uzero(yy));       /* divided by zero */
  mpz_init(mrb, &q);
  mpz_init(mrb, &x);
  mpz_init(mrb, &y);
  mpz_realloc(mrb, &x, xx->sz+1);
  size_t ydigits = digits(yy);
  size_t ns = lzb(yy->p[ydigits-1]);
  ulshift(mrb, &x, xx, ns);
  ulshift(mrb, &y, yy, ns);
  size_t xd = digits(&x);
  mpz_realloc(mrb, &q, xd);
  mp_dbl_limb z = y.p[ydigits-1];
  for (i=0; i<xd; i++) {
    mp_limb x0 = x.p[i];
    mp_limb y0 = y.p[i];
    mp_dbl_limb c = (mp_dbl_limb)x0 * (mp_dbl_limb)y0;
    mp_dbl_limb r = (mp_dbl_limb)z * (mp_dbl_limb)x0 + (mp_dbl_limb)y0;
    z = r >> DIG_SIZE;
    c += r;
    rr->p[i] = LOW(c);
    c >>= DIG_SIZE;
  }
  rr->p[i] = LOW(c);
  trim(&q);
  mpz_move(mrb, qq, &q);
  mpz_clear(mrb, &x);
  mpz_clear(mrb, &y);
}