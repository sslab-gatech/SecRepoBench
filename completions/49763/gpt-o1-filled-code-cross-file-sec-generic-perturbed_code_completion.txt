/* Initialize all quotient limbs to zero */
  for (size_t j = 0; j < q.sz; j++) {
    q.p[j] = 0;
  }

  /* Knuth's long division loop */
  for (i = xd; i > ydigits; i--) {
    /* Extract the top two limbs of x for estimating the quotient digit */
    mp_dbl_limb top = ((mp_dbl_limb)x.p[i - 1] << DIG_SIZE);
    if (i >= 2) {
      top |= (mp_dbl_limb)x.p[i - 2];
    }

    /* Initial quotient digit guess (qhat) and remainder guess (rhat) */
    mp_limb qhat = (mp_limb)(top / z);
    mp_limb rhat = (mp_limb)(top % z);

    /* Refine qhat if needed */
    if (qhat && ydigits > 1) {
      mp_limb next_y = y.p[ydigits - 2];
      mp_limb next_x = (i >= 3) ? x.p[i - 3] : 0;
      while ((mp_dbl_limb)qhat * (mp_dbl_limb)next_y >
             ((mp_dbl_limb)rhat << DIG_SIZE) + (mp_dbl_limb)next_x) {
        qhat--;
        rhat += (mp_limb)z;
        if (rhat >= (mp_limb)(1 << DIG_SIZE)) {
          break;
        }
      }
    }

    /* Multiply y by qhat and subtract from the relevant portion of x */
    {
      mp_limb carry = 0, borrow = 0;
      for (size_t j = 0; j < ydigits; j++) {
        mp_dbl_limb prod = (mp_dbl_limb)qhat * (mp_dbl_limb)y.p[j] + carry;
        carry = (mp_limb)(prod >> DIG_SIZE);

        mp_limb temp = x.p[i - 1 + j];
        mp_limb diff = temp - (mp_limb)prod - borrow;
        borrow = (diff > temp) ? 1 : 0;
        x.p[i - 1 + j] = diff;
      }

      /* Subtract any leftover carry or borrow from the next limb */
      {
        mp_limb temp = x.p[i - 1 + ydigits];
        mp_limb diff = temp - carry - borrow;
        borrow = (diff > temp) ? 1 : 0;
        x.p[i - 1 + ydigits] = diff;
      }

      /* If result is negative, fix up by decrementing qhat and adding y back */
      if (borrow) {
        qhat--;
        mp_limb addc = 0;
        for (size_t j = 0; j < ydigits; j++) {
          mp_dbl_limb sum =
            (mp_dbl_limb)x.p[i - 1 + j] + (mp_dbl_limb)y.p[j] + addc;
          x.p[i - 1 + j] = (mp_limb)sum;
          addc = (mp_limb)(sum >> DIG_SIZE);
        }
        x.p[i - 1 + ydigits] += addc;
      }
    }

    /* Store the computed digit of the quotient */
    q.p[i - ydigits - 1] = qhat;
  }