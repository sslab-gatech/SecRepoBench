for (i = xd - ydigits; i >= 0; i--) {
    mp_dbl_limb t = ((mp_dbl_limb)x.p[i+ydigits] << DIG_SIZE) | x.p[i+ydigits-1];
    mp_limb qq = t / z;
    t -= qq * z;
    mp_dbl_limb borrow = 0;
    for (size_t j = 0; j < ydigits; j++) {
      t = (mp_dbl_limb)x.p[i+j] - qq * y.p[j] - borrow;
      borrow = (t >> DIG_SIZE);
      x.p[i+j] = (mp_limb)t;
    }
    t = x.p[i+ydigits] - borrow;
    x.p[i+ydigits] = (mp_limb)t;
    q.p[i] = qq;
    if (t) { /* non-zero remainder */
      mp_limb carry=0;
      for (size_t j = 0; j < ydigits; j++) {
        t = (mp_dbl_limb)x.p[i+j] + y.p[j] + carry;
        carry = (t >> DIG_SIZE);
        x.p[i+j] = (mp_limb)t;
      }
      x.p[i+ydigits] += carry;
      q.p[i]--;
    }
  }