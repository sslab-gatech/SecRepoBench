for (size_t i = xd - 1; i >= ydigits - 1; i--) {
  mp_dbl_limb a = ((mp_dbl_limb)x.p[i] << DIG_SIZE) | x.p[i-1];
  mp_limb q = (mp_limb)(a / z);
  mp_dbl_limb r = a - (mp_dbl_limb)q * z;
  
  while (r < DIG_BASE && q == DIG_BASE && i >= 2 &&
         (r << DIG_SIZE) + x.p[i-2] < z * q) {
    q--;
    r += z;
  }
  
  mp_dbl_limb borrow = 0;
  for (size_t j = 0; j < ydigits; j++) {
    mp_dbl_limb prod = (mp_dbl_limb)q * y.p[j] + borrow;
    borrow = prod >> DIG_SIZE;
    mp_limb diff = x.p[i-ydigits+j+1] - (mp_limb)(prod & DIG_MASK);
    x.p[i-ydigits+j+1] = diff & DIG_MASK;
    borrow += (diff >> DIG_SIZE) & 1;
  }
  
  q -= borrow;
  if (borrow) {
    mp_dbl_limb carry = 0;
    for (size_t j = 0; j < ydigits; j++) {
      carry += (mp_dbl_limb)x.p[i-ydigits+j+1] + y.p[j];
      x.p[i-ydigits+j+1] = (mp_limb)(carry & DIG_MASK);
      carry >>= DIG_SIZE;
    }
  }
  
  q.p[i-ydigits] = q;
}