if (xd < ydigits) {
    mrb_raise(mrb, E_RUNTIME_ERROR, "buffer overflow detected");
  }

  for (i = xd - ydigits; (mrb_int)i >= 0; i--) {
    mp_dbl_limb w;
    if (x.p[i+ydigits] == z) {
      w = (((mp_dbl_limb)x.p[i+ydigits]) << DIG_SIZE) + x.p[i+ydigits-1];
    }
    else {
      w = (((mp_dbl_limb)x.p[i+ydigits]) << DIG_SIZE) + x.p[i+ydigits-1];
      w /= z;
    }
    if (w > MP_LIMB_MAX) w = MP_LIMB_MAX;

    mpz_t t;
    mpz_init(mrb, &t);
    mpz_realloc(mrb, &t, ydigits + 1);
    umul(mrb, &t, &y, (mp_limb)w);
    while (ucmp(&t, &x) > 0) {
      w--;
      usub(mrb, &t, &t, &y);
    }
    usub(mrb, &x, &x, &t);
    q.p[i] = (mp_limb)w;
    mpz_clear(mrb, &t);
  }