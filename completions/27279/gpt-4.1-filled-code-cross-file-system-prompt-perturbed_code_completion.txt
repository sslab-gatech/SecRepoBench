/* Set Host header */
c->header_host = host;

/* Set Content-Length if body is present */
if (body && body_len > 0) {
    c->content_length = body_len;
}
else {
    c->content_length = 0;
}

/* Proxy parsing */
if (proxy_address) {
    char *proxy_host = NULL;
    int proxy_port = 0;

    /* Parse proxy_address: expected format is host:port */
    char *colon = strchr(proxy_address, ':');
    if (colon) {
        size_t host_len = colon - proxy_address;
        proxy_host = flb_malloc(host_len + 1);
        if (!proxy_host) {
            flb_errno();
            flb_http_client_destroy(c);
            return NULL;
        }
        memcpy(proxy_host, proxy_address, host_len);
        proxy_host[host_len] = '\0';
        proxy_port = atoi(colon + 1);
        if (proxy_port <= 0) {
            flb_free(proxy_host);
            flb_http_client_destroy(c);
            return NULL;
        }
        c->proxy.host = proxy_host;
        c->proxy.port = proxy_port;
    }
    else {
        /* Invalid proxy address format */
        flb_http_client_destroy(c);
        return NULL;
    }
}
else {
    c->proxy.host = NULL;
    c->proxy.port = 0;
}

/* Allocate response data buffer */
c->resp.data = flb_malloc(FLB_HTTP_DATA_SIZE_MAX);