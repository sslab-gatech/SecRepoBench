int nibVal;

      /* Each character of the string (in reverse order) is converted into a 4-bit value that
       * is stored in the dp array. Each fp_digit can hold DIGIT_BIT bits, so we shift the
       * nibble bits appropriately until we reach DIGIT_BIT. Then we move on to the next digit.
       */
      for (; i >= 0; i--) {
          ch = str[i];
          if (ch >= '0' && ch <= '9') {
              nibVal = ch - '0';
          }
          else if (ch >= 'A' && ch <= 'F') {
              nibVal = ch - 'A' + 10;
          }
          else if (ch >= 'a' && ch <= 'f') {
              nibVal = ch - 'a' + 10;
          }
          else {
              /* Invalid character for base-16; stop parsing */
              break;
          }

          /* If we're at the start of a new digit, zero it out. */
          if (j == 0) {
              if (k >= FP_SIZE) {
                  /* Out of space in fpnumber->dp */
                  return FP_VAL;
              }
              fpnumber->dp[k] = 0;
          }

          /* Insert the 4-bit nibble into the current digit. */
          fpnumber->dp[k] |= ((fp_digit)nibVal << j);
          j += 4;

          /* If we've filled up this digit, move to the next one. */
          if (j >= DIGIT_BIT) {
              j = 0;
              k++;
              if (k >= FP_SIZE) {
                  return FP_VAL;
              }
          }
      }