{
    int val;
    /* Validate and convert current hex character to its numeric value. */
    if (ch >= '0' && ch <= '9') {
        val = ch - '0';
    } else if (ch >= 'A' && ch <= 'F') {
        val = ch - 'A' + 10;
    } else if (ch >= 'a' && ch <= 'f') {
        val = ch - 'a' + 10;
    } else {
        return FP_VAL;  /* Invalid characters cause an error */
    }

    /* Safely store the nibble in the current digit, ensuring we don't go out-of-bounds. */
    {
        /* Each fp_digit can hold multiple hex digits. Typically, DIGIT_BIT is 32,
         * so an fp_digit would hold 8 hex digits. Adjust as needed based on actual DIGIT_BIT. */
        int nibPos = j % (DIGIT_BIT / 4);
        fpnumber->dp[k] |= (fp_digit)val << (4 * nibPos);
        j++;

        /* When we've filled one fp_digit, move on to the next one. */
        if (nibPos == (DIGIT_BIT / 4) - 1) {
            k++;
            if (k >= FP_SIZE) {
                return FP_VAL;  /* Too many digits for the allocated space. */
            }
            fpnumber->dp[k] = 0;
        }
    }
}