{
    int val;
    fp_zero(fpnumber);

    for (i = (int)(XSTRLEN(str) - 1); i >= 0; i--) {
        ch = str[i];
        if (ch >= '0' && ch <= '9') {
            val = ch - '0';
        } else if (ch >= 'a' && ch <= 'f') {
            val = 10 + (ch - 'a');
        } else if (ch >= 'A' && ch <= 'F') {
            val = 10 + (ch - 'A');
        } else {
            return FP_VAL; /* invalid character */
        }

        fpnumber->dp[k] |= ((fp_digit)val << j);
        j += 4;
        if (j >= DIGIT_BIT) {
            j -= DIGIT_BIT;
            ++k;
            if (k >= FP_SIZE) {
                return FP_VAL; /* exceeds max size */
            }
        }
    }
}