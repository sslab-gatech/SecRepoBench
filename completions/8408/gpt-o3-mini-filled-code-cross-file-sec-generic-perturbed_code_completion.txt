{
  /*
    Initialize state and allocate a stack for graphic contexts.
  */
  status = MagickTrue;
  n = 0;
  {
    size_t max_contexts = 16;
    graphic_context = (DrawInfo **) AcquireQuantumMemory(max_contexts, sizeof(*graphic_context));
    if (graphic_context == (DrawInfo **) NULL)
    {
      status = MagickFalse;
      goto done;
    }
    graphic_context[0] = CloneDrawInfo((const DrawInfo *) NULL, draw_info);
    if (graphic_context[0] == (DrawInfo *) NULL)
    {
      status = MagickFalse;
      goto done;
    }
  
    /*
      Duplicate the drawing primitive commands string.
    */
    if (draw_info->primitive != (char *) NULL)
      primitive = AcquireString(draw_info->primitive);
    else
      primitive = AcquireString("");
    if (primitive == (char *) NULL)
    {
      status = MagickFalse;
      goto done;
    }
  
    /*
      Parse and execute drawing commands.
    */
    q = primitive;
    while ((q != (const char *) NULL) && (*q != '\0'))
    {
      char command[MagickPathExtent];
      GetNextToken(q, &q, MagickPathExtent, command);
      if (command[0] == '\0')
        break;
  
      if (LocaleCompare("push", command) == 0)
      {
        /* Push current graphic context onto the stack. */
        if ((size_t)(n + 1) >= max_contexts)
        {
          max_contexts *= 2;
          graphic_context = (DrawInfo **) ResizeQuantumMemory(graphic_context, max_contexts, sizeof(*graphic_context));
          if (graphic_context == (DrawInfo **) NULL)
          {
            status = MagickFalse;
            break;
          }
        }
        n++;
        graphic_context[n] = CloneDrawInfo((const DrawInfo *) NULL, graphic_context[n - 1]);
        if (graphic_context[n] == (DrawInfo *) NULL)
        {
          status = MagickFalse;
          break;
        }
        continue;
      }
  
      if (LocaleCompare("pop", command) == 0)
      {
        /* Pop the graphic context from the stack. */
        if (n == 0)
        {
          status = MagickFalse;  /* Unbalanced pop */
          break;
        }
        graphic_context[n] = DestroyDrawInfo(graphic_context[n]);
        n--;
        continue;
      }
  
      if (LocaleCompare("line", command) == 0)
      {
        double x1, y1, x2, y2;
        /* Expect 4 tokens: x1 y1 x2 y2 */
        GetNextToken(q, &q, MagickPathExtent, token);
        x1 = StringToDouble(token, &next_token);
        GetNextToken(q, &q, MagickPathExtent, token);
        y1 = StringToDouble(token, &next_token);
        GetNextToken(q, &q, MagickPathExtent, token);
        x2 = StringToDouble(token, &next_token);
        GetNextToken(q, &q, MagickPathExtent, token);
        y2 = StringToDouble(token, &next_token);
        status = DrawLinePrimitive(image, graphic_context[n], x1, y1, x2, y2, exception);
        if (status == MagickFalse)
          break;
        continue;
      }
  
      if (LocaleCompare("rectangle", command) == 0)
      {
        double x1, y1, x2, y2;
        /* Expect 4 tokens: x1 y1 x2 y2 */
        GetNextToken(q, &q, MagickPathExtent, token);
        x1 = StringToDouble(token, &next_token);
        GetNextToken(q, &q, MagickPathExtent, token);
        y1 = StringToDouble(token, &next_token);
        GetNextToken(q, &q, MagickPathExtent, token);
        x2 = StringToDouble(token, &next_token);
        GetNextToken(q, &q, MagickPathExtent, token);
        y2 = StringToDouble(token, &next_token);
        status = DrawRectanglePrimitive(image, graphic_context[n], x1, y1, x2 - x1, y2 - y1, exception);
        if (status == MagickFalse)
          break;
        continue;
      }
  
      /*
        Unrecognized command: set error status.
      */
      status = MagickFalse;
      break;
    }
  }
done:
  /* Fall-through; resource cleanup follows after this block. */
}