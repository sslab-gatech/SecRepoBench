DrawInfo
    *graphic_context[MagickPathExtent];

  Image
    *pattern_image;

  MagickBooleanType
    status;

  PrimitiveInfo
    *primitive_info;

  StopInfo
    *stops;

  char
    *message;

  size_t
    n;

  ssize_t
    i;

  status=MagickTrue;
  n=0;
  graphic_context[n]=CloneDrawInfo(draw_info);
  if (graphic_context[n] == (DrawInfo *) NULL)
    {
      status=MagickFalse;
      goto cleanup;
    }
  primitive_info=(PrimitiveInfo *) NULL;
  stops=(StopInfo *) NULL;
  token=AcquireString(draw_info->primitive);
  primitive=AcquireString(draw_info->primitive);
  (void) CopyMagickString(primitive_name,draw_info->primitive,MagickPathExtent);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
  for (q=token; *q != '\0'; )
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(q,&q,MagickPathExtent,keyword);
    if (*keyword == '\0')
      break;
    if (*keyword == '#')
      {
        /*
          Comment.
        */
        continue;
      }
    if (LocaleCompare("affine",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,geometry);
        (void) ParseAffineMatrix(geometry,&graphic_context[n]->affine);
        continue;
      }
    if (LocaleCompare("clip-path",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,pattern);
        (void) FormatLocaleString(message,MagickPathExtent,"clip-path:url(#%s);",
          pattern);
        graphic_context[n]->clip_mask=AcquireImage(image->columns,image->rows,
          "clip-path",exception);
        if (graphic_context[n]->clip_mask == (Image *) NULL)
          {
            status=MagickFalse;
            goto cleanup;
          }
        (void) SetImageBackgroundColor(graphic_context[n]->clip_mask,
          graphic_context[n]->fill);
        pattern_image=ReadImage(image->filename,exception);
        if (pattern_image != (Image *) NULL)
          {
            (void) CompositeImage(graphic_context[n]->clip_mask,pattern_image,
              OverCompositeOp,0,0);
            pattern_image=DestroyImage(pattern_image);
          }
        continue;
      }
    if (LocaleCompare("color",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,geometry);
        (void) QueryColorCompliance(geometry,&graphic_context[n]->fill,
          exception);
        continue;
      }
    if (LocaleCompare("gradient",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,geometry);
        stops=ParseGradient(geometry,exception);
        if (stops == (StopInfo *) NULL)
          {
            status=MagickFalse;
            goto cleanup;
          }
        continue;
      }
    if (LocaleCompare("pop",keyword) == 0)
      {
        n--;
        if (n < 0)
          {
            status=MagickFalse;
            goto cleanup;
          }
        continue;
      }
    if (LocaleCompare("push",keyword) == 0)
      {
        n++;
        graphic_context[n]=CloneDrawInfo(graphic_context[n-1]);
        if (graphic_context[n] == (DrawInfo *) NULL)
          {
            status=MagickFalse;
            goto cleanup;
          }
        continue;
      }
    if (LocaleCompare("stroke",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,geometry);
        (void) QueryColorCompliance(geometry,&graphic_context[n]->stroke,
          exception);
        continue;
      }
    if (LocaleCompare("stroke-width",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,geometry);
        graphic_context[n]->stroke_width=StringToDouble(geometry,(char **) NULL);
        continue;
      }
    primitive_info=ParsePrimitive(graphic_context[n],q,&q,exception);
    if (primitive_info == (PrimitiveInfo *) NULL)
      {
        status=MagickFalse;
        goto cleanup;
      }
    if (primitive_info->primitive == UndefinedPrimitive)
      continue;
    for (i=0; primitive_info[i].primitive != UndefinedPrimitive; i++)
      {
        if (stops != (StopInfo *) NULL)
          {
            primitive_info[i].stops=stops;
            stops=(StopInfo *) NULL;
          }
        (void) DrawPrimitive(image,graphic_context[n],&primitive_info[i],
          exception);
      }
  }
cleanup: