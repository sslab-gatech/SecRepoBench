DrawInfo
    **graphic_context;

  MagickBooleanType
    status;

  PrimitiveInfo
    *primitive_info;

  register ssize_t
    i;

  size_t
    length;

  StopInfo
    *stops;

  /*
    Set the drawing defaults.
  */
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
  primitive_info=(PrimitiveInfo *) NULL;
  stops=(StopInfo *) NULL;
  status=MagickTrue;
  SetGeometry(image,geometry);
  (void) memset(&current,0,sizeof(current));
  current.sx=1.0;
  current.sy=1.0;
  /*
    Allocate primitive info memory.
  */
  length=MagickPathExtent;
  primitive_info=(PrimitiveInfo *) AcquireQuantumMemory(length,
    sizeof(*primitive_info));
  if (primitive_info == (PrimitiveInfo *) NULL)
    {
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        image->filename);
      return(MagickFalse);
    }
  (void) memset(primitive_info,0,length*sizeof(*primitive_info));
  graphic_context=(DrawInfo **) AcquireQuantumMemory(length,
    sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    {
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        image->filename);
      return(MagickFalse);
    }
  (void) memset(graphic_context,0,length*sizeof(*graphic_context));
  n=0;
  graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  if (graphic_context[n] == (DrawInfo *) NULL)
    {
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      for (i=0; i <= n; i++)
        graphic_context[i]=DestroyDrawInfo(graphic_context[i]);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        image->filename);
      return(MagickFalse);
    }
  primitive=(char *) AcquireString(draw_info->primitive);
  if (primitive == (char *) NULL)
    {
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      for (i=0; i <= n; i++)
        graphic_context[i]=DestroyDrawInfo(graphic_context[i]);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        image->filename);
      return(MagickFalse);
    }
  (void) FormatLocaleString(primitive_name,MagickPathExtent,
    "%.20g,%.20g %s",(double) image->columns,(double) image->rows,primitive);
  token=AcquireString(primitive);
  (void) memset(&affine,0,sizeof(affine));
  affine.sx=1.0;
  affine.sy=1.0;
  status=MagickTrue;
  for (q=primitive; *q != '\0'; )
  {
    /*
      Interpret drawing command.
    */
    GetNextToken(q,&q,MagickPathExtent,keyword);
    if (*keyword == '\0')
      break;
    if (image->debug != MagickFalse)
      (void) LogMagickEvent(DrawEvent,GetMagickModule(),"%s",keyword);
    if (LocaleNCompare(keyword,"push",4) == 0)
      {
        if (n >= (ssize_t) (length-1))
          {
            length<<=1;
            graphic_context=(DrawInfo **) ResizeQuantumMemory(graphic_context,
              length+1,sizeof(*graphic_context));
            if (graphic_context == (DrawInfo **) NULL)
              {
                (void) ThrowMagickException(exception,GetMagickModule(),
                  ResourceLimitError,"MemoryAllocationFailed","`%s'",
                  image->filename);
                status=MagickFalse;
                break;
              }
          }
        n++;
        graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
          graphic_context[n-1]);
        if (graphic_context[n] == (DrawInfo *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              ResourceLimitError,"MemoryAllocationFailed","`%s'",
              image->filename);
            status=MagickFalse;
            break;
          }
        if (image->debug != MagickFalse)
          (void) LogMagickEvent(DrawEvent,GetMagickModule()," graphic-context=%u",
            n);

        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token != '{')
          continue;
        q++;
        continue;
      }
    if (LocaleNCompare(keyword,"pop",3) == 0)
      {
        if (n <= 0)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),DrawError,
              "UnbalancedGraphicContextPushPop","`%s'",token);
            status=MagickFalse;
            break;
          }

        if (image->debug != MagickFalse)
          (void) LogMagickEvent(DrawEvent,GetMagickModule()," graphic-context=%u",
            n);
        graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
        n--;
        GetNextToken(q,&q,MagickPathExtent,token);
        continue;
      }