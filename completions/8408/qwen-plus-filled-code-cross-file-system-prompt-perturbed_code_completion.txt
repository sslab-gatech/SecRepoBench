/*
    Initialize graphic context stack.
  */
  n=0;
  graphic_context=(DrawInfo **) AcquireQuantumMemory(1,sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    ThrowFatalException(ResourceLimitFatalError,"UnableToAllocateGraphicContext");
  graphic_context[n]=CloneDrawInfo((Image *) NULL,draw_info);
  GetAffineMatrix(&affine);

  /*
    Parse the drawing commands and execute them.
  */
  primitive=ConstantString(draw_info->primitive);
  token=AcquireString(primitive);
  status=MagickTrue;
  while (*token != '\0')
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(token,&token,MagickPathExtent,geometry);
    if (*geometry == '\0')
      break;
    if (*geometry == '#')
      {
        /*
          Comment.
        */
        for ( ; (*token != '\n') && (*token != '\0'); token++);
        continue;
      }
    current=affine;
    switch (*geometry)
    {
      case ';':
        break;
      case 'a':
      case 'A':
      {
        if (LocaleCompare("affine",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.sx=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.rx=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.ry=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.sy=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.tx=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.ty=StringToDouble(geometry,(char **) NULL);
            break;
          }
        if (LocaleCompare("alpha",geometry) == 0)
          {
            DrawAlphaPrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("angle",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.rx=StringToDouble(geometry,(char **) NULL);
            affine.ry=StringToDouble(geometry,(char **) NULL);
            break;
          }
        if (LocaleCompare("arc",geometry) == 0)
          {
            DrawArcPrimitive(image,draw_info,token,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'b':
      case 'B':
      {
        if (LocaleCompare("bezier",geometry) == 0)
          {
            DrawBezierPrimitive(image,draw_info,token,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'c':
      case 'C':
      {
        if (LocaleCompare("clip-path",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            ClipPathImage(image,geometry,exception);
            break;
          }
        if (LocaleCompare("clip-rule",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->fill_rule=ParseFillRule(geometry);
            break;
          }
        if (LocaleCompare("circle",geometry) == 0)
          {
            DrawCirclePrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("color",geometry) == 0)
          {
            DrawColorPrimitive(image,draw_info,token,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'e':
      case 'E':
      {
        if (LocaleCompare("ellipse",geometry) == 0)
          {
            DrawEllipsePrimitive(image,draw_info,token,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'f':
      case 'F':
      {
        if (LocaleCompare("fill",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->fill=CloneString(geometry);
            break;
          }
        if (LocaleCompare("fill-rule",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->fill_rule=ParseFillRule(geometry);
            break;
          }
        if (LocaleCompare("font-family",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->family=CloneString(geometry);
            break;
          }
        if (LocaleCompare("font-stretch",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->stretch=ParseFontStretch(geometry);
            break;
          }
        if (LocaleCompare("font-style",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->style=ParseFontStyle(geometry);
            break;
          }
        if (LocaleCompare("font-size",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->pointsize=StringToDouble(geometry,
              (char **) NULL);
            break;
          }
        if (LocaleCompare("font-weight",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->weight=StringToUnsignedLong(geometry);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'g':
      case 'G':
      {
        if (LocaleCompare("gradient-units",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            break;
          }
        if (LocaleCompare("text-align",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->align=ParseTextAlign(geometry);
            break;
          }
        if (LocaleCompare("text-anchor",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->align=ParseTextAnchor(geometry);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'i':
      case 'I':
      {
        if (LocaleCompare("image",geometry) == 0)
          {
            DrawImagePrimitive(image,draw_info,token,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'l':
      case 'L':
      {
        if (LocaleCompare("line",geometry) == 0)
          {
            DrawLinePrimitive(image,draw_info,token,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'o':
      case 'O':
      {
        if (LocaleCompare("opacity",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->fill_opacity=StringToDouble(geometry,
              (char **) NULL);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'p':
      case 'P':
      {
        if (LocaleCompare("path",geometry) == 0)
          {
            DrawPathPrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("point",geometry) == 0)
          {
            DrawPointPrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("polyline",geometry) == 0)
          {
            DrawPolylinePrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("polygon",geometry) == 0)
          {
            DrawPolygonPrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("pop",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            if (LocaleCompare("graphic-context",geometry) == 0)
              {
                n--;
                if (n < 0)
                  ThrowFatalException(DrawError,
                    "UnbalancedGraphicContextPushPop");
              }
            break;
          }
        if (LocaleCompare("push",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            if (LocaleCompare("graphic-context",geometry) == 0)
              {
                n++;
                graphic_context=(DrawInfo **) ResizeQuantumMemory(
                  graphic_context,n+1,sizeof(*graphic_context));
                if (graphic_context == (DrawInfo **) NULL)
                  ThrowFatalException(ResourceLimitFatalError,
                    "UnableToExtendGraphicContext");
                graphic_context[n]=CloneDrawInfo((Image *) NULL,
                  graphic_context[n-1]);
              }
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'r':
      case 'R':
      {
        if (LocaleCompare("rectangle",geometry) == 0)
          {
            DrawRectanglePrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("roundRectangle",geometry) == 0)
          {
            DrawRoundRectanglePrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("rotate",geometry) == 0)
          {
            double
              angle;

            GetNextToken(token,&token,MagickPathExtent,geometry);
            angle=StringToDouble(geometry,(char **) NULL);
            RotateAffineTransform(&affine,angle);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 's':
      case 'S':
      {
        if (LocaleCompare("scale",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.sx=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.sy=StringToDouble(geometry,(char **) NULL);
            break;
          }
        if (LocaleCompare("skewX",geometry) == 0)
          {
            double
              angle;

            GetNextToken(token,&token,MagickPathExtent,geometry);
            angle=StringToDegrees(StringToDouble(geometry,(char **) NULL));
            affine.ry=tan(DegreesToRadians(angle));
            break;
          }
        if (LocaleCompare("skewY",geometry) == 0)
          {
            double
              angle;

            GetNextToken(token,&token,MagickPathExtent,geometry);
            angle=StringToDegrees(StringToDouble(geometry,(char **) NULL));
            affine.rx=tan(DegreesToRadians(angle));
            break;
          }
        if (LocaleCompare("stroke",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            graphic_context[n]->stroke=CloneString(geometry);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 't':
      case 'T':
      {
        if (LocaleCompare("text",geometry) == 0)
          {
            DrawTextPrimitive(image,draw_info,token,exception);
            break;
          }
        if (LocaleCompare("translate",geometry) == 0)
          {
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.tx=StringToDouble(geometry,(char **) NULL);
            GetNextToken(token,&token,MagickPathExtent,geometry);
            affine.ty=StringToDouble(geometry,(char **) NULL);
            break;
          }
        status=MagickFalse;
        break;
      }
      default:
      {
        status=MagickFalse;
        break;
      }
    }
    if (status == MagickFalse)
      break;
    affine.sx=current.sx;
    affine.rx=current.rx;
    affine.ry=current.ry;
    affine.sy=current.sy;
    affine.tx=current.tx;
    affine.ty=current.ty;
  }