DrawInfo
    **graphic_context;

  MagickBooleanType
    status;

  MagickOffsetType
    offset;

  PrimitiveInfo
    *primitive_info;

  register ssize_t
    i;

  size_t
    length,
    n;

  StopInfo
    *stops;

  /*
    Set the image clip mask.
  */
  (void) SetImageClipMask(image,draw_info->clip_mask,exception);
  if (draw_info->compliance != SVGCompliance)
    (void) SetImageMask(image,WritePixelMask,draw_info->composite_mask,
      exception);
  /*
    Allocate primitive info memory.
  */
  length=MagickPathExtent;
  primitive_info=(PrimitiveInfo *) AcquireQuantumMemory(length,
    sizeof(*primitive_info));
  if (primitive_info == (PrimitiveInfo *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),
        ResourceLimitError,"MemoryAllocationFailed","`%s'",image->filename);
      return(MagickFalse);
    }
  stops=(StopInfo *) NULL;
  /*
    Initialize graphic context.
  */
  graphic_context=(DrawInfo **) AcquireQuantumMemory(
    Max(draw_info->recursion_depth,1),sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),
        ResourceLimitError,"MemoryAllocationFailed","`%s'",image->filename);
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      return(MagickFalse);
    }
  n=0;
  graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  if (graphic_context[n] == (DrawInfo *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),
        ResourceLimitError,"MemoryAllocationFailed","`%s'",image->filename);
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      return(MagickFalse);
    }
  primitive=AcquireString(draw_info->primitive);
  if (primitive == (char *) NULL)
    {
      (void) ThrowMagickException(exception,GetMagickModule(),
        ResourceLimitError,"MemoryAllocationFailed","`%s'",image->filename);
      for ( ; n >= 0; n--)
        graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      return(MagickFalse);
    }
  (void) SetImageArtifact(image,RenderImageTag,"true");
  status=MagickTrue;
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
  token=AcquireString(primitive);
  (void) memset(primitive_name,0,sizeof(primitive_name));
  (void) memset(&current,0,sizeof(current));
  current.sx=1.0;
  current.sy=1.0;
  offset=0;
  for (q=primitive; *q != '\0'; )
  {
    /*
      Interpret drawing command.
    */
    GetNextToken(q,&q,length,token);
    if (*token == '\0')
      break;
    if (offset >= length)
      {
        length<<=1;
        primitive_info=(PrimitiveInfo *) ResizeQuantumMemory(primitive_info,
          length,sizeof(*primitive_info));
        if (primitive_info == (PrimitiveInfo *) NULL)
          {
            (void) ThrowMagickException(exception,GetMagickModule(),
              ResourceLimitError,"MemoryAllocationFailed","`%s'",
              image->filename);
            status=MagickFalse;
            break;
          }
      }
    if (image->debug != MagickFalse)
      (void) LogMagickEvent(DrawEvent,GetMagickModule(),"%s",token);
    (void) CopyMagickString(primitive_name,token,MagickPathExtent);
    primitive_info[offset].primitive=UndefinedPrimitive;
    switch (*token)
    {
      case 'a':
      case 'A':
      {
        if (LocaleCompare("affine",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            affine.sx=StringToDouble(token,&next_token);
            GetNextToken(q,&q,length,token);
            if (*token == ',')
              GetNextToken(q,&q,length,token);
            affine.rx=StringToDouble(token,&next_token);
            GetNextToken(q,&q,length,token);
            if (*token == ',')
              GetNextToken(q,&q,length,token);
            affine.ry=StringToDouble(token,&next_token);
            GetNextToken(q,&q,length,token);
            if (*token == ',')
              GetNextToken(q,&q,length,token);
            affine.sy=StringToDouble(token,&next_token);
            GetNextToken(q,&q,length,token);
            if (*token == ',')
              GetNextToken(q,&q,length,token);
            affine.tx=StringToDouble(token,&next_token);
            GetNextToken(q,&q,length,token);
            if (*token == ',')
              GetNextToken(q,&q,length,token);
            affine.ty=StringToDouble(token,&next_token);
            break;
          }
        if (LocaleCompare("alpha",token) == 0)
          {
            primitive_info[offset].primitive=AlphaPrimitive;
            break;
          }
        if (LocaleCompare("arc",token) == 0)
          {
            primitive_info[offset].primitive=ArcPrimitive;
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'b':
      case 'B':
      {
        if (LocaleCompare("bezier",token) == 0)
          {
            primitive_info[offset].primitive=BezierPrimitive;
            break;
          }
        if (LocaleCompare("border-color",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            (void) QueryColorCompliance(token,AllCompliance,
              &graphic_context[n]->border_color,exception);
            break;
          }
        if (LocaleCompare("background-color",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            (void) QueryColorCompliance(token,AllCompliance,
              &graphic_context[n]->background_color,exception);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'c':
      case 'C':
      {
        if (LocaleCompare("circle",token) == 0)
          {
            primitive_info[offset].primitive=CirclePrimitive;
            break;
          }
        if (LocaleCompare("clip-path",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            (void) FormatLocaleString(geometry,MagickPathExtent,"[%s]",token);
            (void) SetImageArtifact(image,"clip-path",geometry);
            break;
          }
        if (LocaleCompare("clip-rule",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            if (LocaleCompare("evenodd",token) == 0)
              graphic_context[n]->clip_rule=EvenOddRule;
            if (LocaleCompare("nonzero",token) == 0)
              graphic_context[n]->clip_rule=NonZeroRule;
            break;
          }
        if (LocaleCompare("clip-units",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->clip_units=(ClipPathUnits) ParseCommandOption(
              MagickClipPathUnitsOptions,MagickFalse,token);
            break;
          }
        if (LocaleCompare("color",token) == 0)
          {
            primitive_info[offset].primitive=ColorPrimitive;
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'd':
      case 'D':
      {
        if (LocaleCompare("decorate",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->decorate=(DecorationType) ParseCommandOption(
              MagickDecorateOptions,MagickFalse,token);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'e':
      case 'E':
      {
        if (LocaleCompare("ellipse",token) == 0)
          {
            primitive_info[offset].primitive=EllipsePrimitive;
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'f':
      case 'F':
      {
        if (LocaleCompare("fill",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            (void) QueryColorCompliance(token,AllCompliance,
              &graphic_context[n]->fill,exception);
            break;
          }
        if (LocaleCompare("fill-opacity",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->fill_opacity=StringToDouble(token,
              (char **) NULL);
            break;
          }
        if (LocaleCompare("fill-rule",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            if (LocaleCompare("evenodd",token) == 0)
              graphic_context[n]->fill_rule=EvenOddRule;
            if (LocaleCompare("nonzero",token) == 0)
              graphic_context[n]->fill_rule=NonZeroRule;
            break;
          }
        if (LocaleCompare("font",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            (void) CloneString(&graphic_context[n]->font,token);
            break;
          }
        if (LocaleCompare("font-family",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            (void) CloneString(&graphic_context[n]->font_family,token);
            break;
          }
        if (LocaleCompare("font-size",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->pointsize=StringToDouble(token,
              (char **) NULL);
            break;
          }
        if (LocaleCompare("font-stretch",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->font_stretch=(StretchType) ParseCommandOption(
              MagickStretchOptions,MagickFalse,token);
            break;
          }
        if (LocaleCompare("font-style",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->font_style=(StyleType) ParseCommandOption(
              MagickStyleOptions,MagickFalse,token);
            break;
          }
        if (LocaleCompare("font-weight",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->font_weight=StringToLong(token);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'g':
      case 'G':
      {
        if (LocaleCompare("gradient-units",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            break;
          }
        if (LocaleCompare("gravity",token) == 0)
          {
            GetNextToken(q,&q,length,token);
            graphic_context[n]->gravity=(GravityType) ParseCommandOption(
              MagickGravityOptions,MagickFalse,token);
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'i':
      case 'I':
      {
        if (LocaleCompare("image",token) == 0)
          {
            primitive_info[offset].primitive=ImagePrimitive;
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'l':
      case 'L':
      {
        if (LocaleCompare("line",token) == 0)
          {
            primitive_info[offset].primitive=LinePrimitive;
            break;
          }
        status=MagickFalse;
        break;
      }
      case 'm':
      case '