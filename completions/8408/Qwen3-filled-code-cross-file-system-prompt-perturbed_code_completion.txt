if (image->debug != MagickFalse)
  (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");

status = MagickTrue;
primitive = draw_info->primitive;
if (primitive == NULL)
{
  status = MagickFalse;
  goto done;
}
token = AcquireString(primitive);
if (token == NULL)
{
  status = MagickFalse;
  goto done;
}
extent = strlen(primitive) + MagickPathExtent;
q = primitive;
n = 0;
graphic_context = (DrawInfo **) AcquireQuantumMemory(1, sizeof(DrawInfo *));
if (graphic_context == NULL)
{
  status = MagickFalse;
  goto done;
}
graphic_context[0] = CloneDrawInfo(NULL, draw_info);
if (graphic_context[0] == NULL)
{
  status = MagickFalse;
  goto done;
}
current = graphic_context[0]->affine;
affine = current;
primitive_info = (PrimitiveInfo *) AcquireQuantumMemory(2048, sizeof(PrimitiveInfo));
if (primitive_info == NULL)
{
  status = MagickFalse;
  goto done;
}

while (*q != '\0')
{
  GetNextToken(q, &q, MagickPathExtent, primitive_name);
  if (*primitive_name == '\0')
    break;
  if (*primitive_name == '#')
  {
    while (*q != '\0' && *q != '\n') q++;
    continue;
  }
  if (LocaleCompare(primitive_name, "push") == 0)
  {
    GetNextToken(q, &q, extent, token);
    if (LocaleCompare(token, "graphic-context") == 0)
    {
      n++;
      graphic_context = (DrawInfo **) ResizeQuantumMemory(graphic_context, n+1, sizeof(DrawInfo *));
      if (graphic_context == NULL)
      {
        status = MagickFalse;
        break;
      }
      graphic_context[n] = CloneDrawInfo(NULL, graphic_context[n-1]);
      if (graphic_context[n] == NULL)
      {
        status = MagickFalse;
        break;
      }
      current = graphic_context[n]->affine;
      affine = current;
    }
  }
  else if (LocaleCompare(primitive_name, "pop") == 0)
  {
    GetNextToken(q, &q, extent, token);
    if (LocaleCompare(token, "graphic-context") == 0)
    {
      if (n <= 0)
      {
        status = MagickFalse;
        break;
      }
      n--;
      current = graphic_context[n]->affine;
      affine = current;
    }
  }
  else if (LocaleCompare(primitive_name, "affine") == 0)
  {
    GetNextToken(q, &q, extent, token);
    affine.sx = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.rx = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.ry = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.sy = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.tx = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.ty = StringToDouble(token, &next_token);
  }
  else if (LocaleCompare(primitive_name, "translate") == 0)
  {
    GetNextToken(q, &q, extent, token);
    affine.tx = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.ty = StringToDouble(token, &next_token);
  }
  else if (LocaleCompare(primitive_name, "scale") == 0)
  {
    GetNextToken(q, &q, extent, token);
    affine.sx = StringToDouble(token, &next_token);
    GetNextToken(q, &q, extent, token);
    if (*token == ',') GetNextToken(q, &q, extent, token);
    affine.sy = StringToDouble(token, &next_token);
  }
  else
  {
    PrimitiveType primitive_type = UndefinedPrimitive;
    if (LocaleCompare(primitive_name, "line") == 0)
      primitive_type = LinePrimitive;
    else if (LocaleCompare(primitive_name, "rectangle") == 0)
      primitive_type = RectanglePrimitive;
    else if (LocaleCompare(primitive_name, "circle") == 0)
      primitive_type = CirclePrimitive;
    else if (LocaleCompare(primitive_name, "ellipse") == 0)
      primitive_type = EllipsePrimitive;
    else if (LocaleCompare(primitive_name, "path") == 0)
      primitive_type = PathPrimitive;
    else if (LocaleCompare(primitive_name, "polygon") == 0)
      primitive_type = PolygonPrimitive;
    else if (LocaleCompare(primitive_name, "polyline") == 0)
      primitive_type = PolylinePrimitive;
    else if (LocaleCompare(primitive_name, "text") == 0)
      primitive_type = TextPrimitive;
    else if (LocaleCompare(primitive_name, "image") == 0)
      primitive_type = ImagePrimitive;
    else if (LocaleCompare(primitive_name, "bezier") == 0)
      primitive_type = BezierPrimitive;
    else if (LocaleCompare(primitive_name, "arc") == 0)
      primitive_type = ArcPrimitive;
    else if (LocaleCompare(primitive_name, "roundRectangle") == 0)
      primitive_type = RoundRectanglePrimitive;
    else if (LocaleCompare(primitive_name, "color") == 0)
      primitive_type = ColorPrimitive;
    else if (LocaleCompare(primitive_name, "alpha") == 0)
      primitive_type = AlphaPrimitive;

    if (primitive_type == UndefinedPrimitive)
    {
      status = MagickFalse;
      break;
    }

    i = 0;
    while (IsPoint(q) && i < (ssize_t) (2048-6*BezierQuantum-360))
    {
      GetNextToken(q, &q, extent, token);
      point.x = StringToDouble(token, &next_token);
      GetNextToken(q, &q, extent, token);
      if (*token == ',') GetNextToken(q, &q, extent, token);
      point.y = StringToDouble(token, &next_token);
      primitive_info[i].point = point;
      primitive_info[i].primitive = primitive_type;
      i++;
    }
    primitive_info[0].coordinates = i;
    if (i == 0)
    {
      status = MagickFalse;
      break;
    }

    if (!DrawPrimitive(image, graphic_context[n], primitive_info, exception))
    {
      status = MagickFalse;
      break;
    }
  }
}

done: