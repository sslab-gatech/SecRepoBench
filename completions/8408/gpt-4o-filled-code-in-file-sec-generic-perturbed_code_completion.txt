MVGInfo
    mvg_info;

  PrimitiveInfo
    *primitive_info;

  DrawInfo
    **graphic_context;

  size_t
    extent,
    number_stops;

  ssize_t
    n,
    status;

  StopInfo
    *stops;

  /*
    Initialize draw context.
  */
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  assert(draw_info != (DrawInfo *) NULL);
  assert(draw_info->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
  if (draw_info->primitive == (char *) NULL)
    return(MagickFalse);
  extent=2048;
  primitive_info=(PrimitiveInfo *) AcquireQuantumMemory(extent,
    sizeof(*primitive_info));
  if (primitive_info == (PrimitiveInfo *) NULL)
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      draw_info->primitive);
  graphic_context=(DrawInfo **) AcquireMagickMemory(sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    {
      primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        draw_info->primitive);
    }
  graphic_context[0]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  n=0;
  stops=(StopInfo *) NULL;
  number_stops=0;
  status=MagickTrue;
  token=AcquireString(draw_info->primitive);
  primitive=AcquireString(draw_info->primitive);
  next_token=AcquireString(draw_info->primitive);
  mvg_info.primitive_info=(&primitive_info);
  mvg_info.extent=(&extent);
  mvg_info.offset=0;
  mvg_info.exception=exception;
  for (q=draw_info->primitive; *q != '\0'; )
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(q,&q,MagickPathExtent,token);
    if (*token == '\0')
      break;
    if (*token == '#')
      {
        while ((*q != '\n') && (*q != '\0'))
          q++;
        continue;
      }
    if (LocaleCompare("push",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        n++;
        graphic_context=(DrawInfo **) ResizeQuantumMemory(graphic_context,
          (size_t) (n+1),sizeof(*graphic_context));
        if (graphic_context == (DrawInfo **) NULL)
          {
            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
              primitive_info);
            ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
              draw_info->primitive);
          }
        graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
          graphic_context[n-1]);
        if (LocaleCompare("defs",token) == 0)
          {
            while (*q != '}')
            {
              if (*q == '\0')
                {
                  primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                    primitive_info);
                  ThrowBinaryException(DrawError,
                    "NonconformingDrawingPrimitiveDefinition",
                    draw_info->primitive);
                }
              q++;
            }
            q++;
            continue;
          }
        continue;
      }
    if (LocaleCompare("pop",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (n <= 0)
          {
            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
              primitive_info);
            ThrowBinaryException(DrawError,
              "UnbalancedGraphicContextPushPop",draw_info->primitive);
          }
        graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
        n--;
        continue;
      }
    if (LocaleCompare("push",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        n++;
        graphic_context=(DrawInfo **) ResizeQuantumMemory(graphic_context,
          (size_t) (n+1),sizeof(*graphic_context));
        if (graphic_context == (DrawInfo **) NULL)
          {
            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
              primitive_info);
            ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
              draw_info->primitive);
          }
        graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
          graphic_context[n-1]);
        if (LocaleCompare("defs",token) == 0)
          {
            while (*q != '}')
            {
              if (*q == '\0')
                {
                  primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                    primitive_info);
                  ThrowBinaryException(DrawError,
                    "NonconformingDrawingPrimitiveDefinition",
                    draw_info->primitive);
                }
              q++;
            }
            q++;
            continue;
          }
        continue;
      }
    if (LocaleCompare("pop",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (n <= 0)
          {
            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
              primitive_info);
            ThrowBinaryException(DrawError,
              "UnbalancedGraphicContextPushPop",draw_info->primitive);
          }
        graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
        n--;
        continue;
      }
    if (LocaleCompare("path",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token == '\0')
          {
            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
              primitive_info);
            ThrowBinaryException(DrawError,
              "NonconformingDrawingPrimitiveDefinition",draw_info->primitive);
          }
        if (LocaleCompare("mvg",token) == 0)
          {
            GetNextToken(q,&q,MagickPathExtent,token);
            if (*token == '\0')
              {
                primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                  primitive_info);
                ThrowBinaryException(DrawError,
                  "NonconformingDrawingPrimitiveDefinition",
                  draw_info->primitive);
              }
            if (LocaleCompare("path",token) == 0)
              {
                GetNextToken(q,&q,MagickPathExtent,token);
                if (*token == '\0')
                  {
                    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                      primitive_info);
                    ThrowBinaryException(DrawError,
                      "NonconformingDrawingPrimitiveDefinition",
                      draw_info->primitive);
                  }
                if (LocaleCompare("mvg",token) == 0)
                  {
                    GetNextToken(q,&q,MagickPathExtent,token);
                    if (*token == '\0')
                      {
                        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                          primitive_info);
                        ThrowBinaryException(DrawError,
                          "NonconformingDrawingPrimitiveDefinition",
                          draw_info->primitive);
                      }
                    if (LocaleCompare("path",token) == 0)
                      {
                        GetNextToken(q,&q,MagickPathExtent,token);
                        if (*token == '\0')
                          {
                            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                              primitive_info);
                            ThrowBinaryException(DrawError,
                              "NonconformingDrawingPrimitiveDefinition",
                              draw_info->primitive);
                          }
                        if (LocaleCompare("mvg",token) == 0)
                          {
                            GetNextToken(q,&q,MagickPathExtent,token);
                            if (*token == '\0')
                              {
                                primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                  primitive_info);
                                ThrowBinaryException(DrawError,
                                  "NonconformingDrawingPrimitiveDefinition",
                                  draw_info->primitive);
                              }
                            if (LocaleCompare("path",token) == 0)
                              {
                                GetNextToken(q,&q,MagickPathExtent,token);
                                if (*token == '\0')
                                  {
                                    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                      primitive_info);
                                    ThrowBinaryException(DrawError,
                                      "NonconformingDrawingPrimitiveDefinition",
                                      draw_info->primitive);
                                  }
                                if (LocaleCompare("mvg",token) == 0)
                                  {
                                    GetNextToken(q,&q,MagickPathExtent,token);
                                    if (*token == '\0')
                                      {
                                        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                          primitive_info);
                                        ThrowBinaryException(DrawError,
                                          "NonconformingDrawingPrimitiveDefinition",
                                          draw_info->primitive);
                                      }
                                    if (LocaleCompare("path",token) == 0)
                                      {
                                        GetNextToken(q,&q,MagickPathExtent,token);
                                        if (*token == '\0')
                                          {
                                            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                              primitive_info);
                                            ThrowBinaryException(DrawError,
                                              "NonconformingDrawingPrimitiveDefinition",
                                              draw_info->primitive);
                                          }
                                        if (LocaleCompare("mvg",token) == 0)
                                          {
                                            GetNextToken(q,&q,MagickPathExtent,token);
                                            if (*token == '\0')
                                              {
                                                primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                  primitive_info);
                                                ThrowBinaryException(DrawError,
                                                  "NonconformingDrawingPrimitiveDefinition",
                                                  draw_info->primitive);
                                              }
                                            if (LocaleCompare("path",token) == 0)
                                              {
                                                GetNextToken(q,&q,MagickPathExtent,token);
                                                if (*token == '\0')
                                                  {
                                                    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                      primitive_info);
                                                    ThrowBinaryException(DrawError,
                                                      "NonconformingDrawingPrimitiveDefinition",
                                                      draw_info->primitive);
                                                  }
                                                if (LocaleCompare("mvg",token) == 0)
                                                  {
                                                    GetNextToken(q,&q,MagickPathExtent,token);
                                                    if (*token == '\0')
                                                      {
                                                        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                          primitive_info);
                                                        ThrowBinaryException(DrawError,
                                                          "NonconformingDrawingPrimitiveDefinition",
                                                          draw_info->primitive);
                                                      }
                                                    if (LocaleCompare("path",token) == 0)
                                                      {
                                                        GetNextToken(q,&q,MagickPathExtent,token);
                                                        if (*token == '\0')
                                                          {
                                                            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                              primitive_info);
                                                            ThrowBinaryException(DrawError,
                                                              "NonconformingDrawingPrimitiveDefinition",
                                                              draw_info->primitive);
                                                          }
                                                        if (LocaleCompare("mvg",token) == 0)
                                                          {
                                                            GetNextToken(q,&q,MagickPathExtent,token);
                                                            if (*token == '\0')
                                                              {
                                                                primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                  primitive_info);
                                                                ThrowBinaryException(DrawError,
                                                                  "NonconformingDrawingPrimitiveDefinition",
                                                                  draw_info->primitive);
                                                              }
                                                            if (LocaleCompare("path",token) == 0)
                                                              {
                                                                GetNextToken(q,&q,MagickPathExtent,token);
                                                                if (*token == '\0')
                                                                  {
                                                                    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                      primitive_info);
                                                                    ThrowBinaryException(DrawError,
                                                                      "NonconformingDrawingPrimitiveDefinition",
                                                                      draw_info->primitive);
                                                                  }
                                                                if (LocaleCompare("mvg",token) == 0)
                                                                  {
                                                                    GetNextToken(q,&q,MagickPathExtent,token);
                                                                    if (*token == '\0')
                                                                      {
                                                                        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                          primitive_info);
                                                                        ThrowBinaryException(DrawError,
                                                                          "NonconformingDrawingPrimitiveDefinition",
                                                                          draw_info->primitive);
                                                                      }
                                                                    if (LocaleCompare("path",token) == 0)
                                                                      {
                                                                        GetNextToken(q,&q,MagickPathExtent,token);
                                                                        if (*token == '\0')
                                                                          {
                                                                            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                              primitive_info);
                                                                            ThrowBinaryException(DrawError,
                                                                              "NonconformingDrawingPrimitiveDefinition",
                                                                              draw_info->primitive);
                                                                          }
                                                                        if (LocaleCompare("mvg",token) == 0)
                                                                          {
                                                                            GetNextToken(q,&q,MagickPathExtent,token);
                                                                            if (*token == '\0')
                                                                              {
                                                                                primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                                  primitive_info);
                                                                                ThrowBinaryException(DrawError,
                                                                                  "NonconformingDrawingPrimitiveDefinition",
                                                                                  draw_info->primitive);
                                                                              }
                                                                            if (LocaleCompare("path",token) == 0)
                                                                              {
                                                                                GetNextToken(q,&q,MagickPathExtent,token);
                                                                                if (*token == '\0')
                                                                                  {
                                                                                    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                                      primitive_info);
                                                                                    ThrowBinaryException(DrawError,
                                                                                      "NonconformingDrawingPrimitiveDefinition",
                                                                                      draw_info->primitive);
                                                                                  }
                                                                                if (LocaleCompare("mvg",token) == 0)
                                                                                  {
                                                                                    GetNextToken(q,&q,MagickPathExtent,token);
                                                                                    if (*token == '\0')
                                                                                      {
                                                                                        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                                          primitive_info);
                                                                                        ThrowBinaryException(DrawError,
                                                                                          "NonconformingDrawingPrimitiveDefinition",
                                                                                          draw_info->primitive);
                                                                                      }
                                                                                    if (LocaleCompare("path",token) == 0)
                                                                                      {
                                                                                        GetNextToken(q,&q,MagickPathExtent,token);
                                                                                        if (*token == '\0')
                                                                                          {
                                                                                            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                                              primitive_info);
                                                                                            ThrowBinaryException(DrawError,
                                                                                              "NonconformingDrawingPrimitiveDefinition",
                                                                                              draw_info->primitive);
                                                                                          }
                                                                                        if (LocaleCompare("mvg",token) == 0)
                                                                                          {
                                                                                            GetNextToken(q,&q,MagickPathExtent,token);
                                                                                            if (*token == '\0')
                                                                                              {
                                                                                                primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
                                                                                                  primitive_info);
                                                                                                ThrowBinaryException(DrawError,
                                                                                                  "NonconformingDrawingPrimitiveDefinition",
                                                                                                  draw_info->primitive);
                                                                                              }
                                                                                            if (LocaleCompare("path",token) == 0)
                                                                                              {
                                                                                                GetNextToken(q,&q,MagickPat