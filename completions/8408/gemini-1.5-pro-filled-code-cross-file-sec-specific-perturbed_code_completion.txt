DrawInfo
    **graphic_context;

  double
    opacity,
    stroke_opacity,
    stroke_width;

  MagickBooleanType
    status;

  PrimitiveInfo
    *primitive_info;

  PrimitiveType
    primitive_type;

  register ssize_t
    i;

  size_t
    length,
    n;

  StopInfo
    *stops;

  /*
    Set the image clip mask.
  */
  (void) SetImageClipMask(image,draw_info->clip_mask,exception);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
  status=MagickTrue;
  primitive_info=(PrimitiveInfo *) NULL;
  stops=(StopInfo *) NULL;
  n=0;
  graphic_context=(DrawInfo **) AcquireQuantumMemory(n+1,
    sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    {
      token=DestroyString(token);
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        image->filename);
    }
  graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  if (graphic_context[n] == (DrawInfo *) NULL)
    {
      token=DestroyString(token);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
        image->filename);
    }
  primitive_type=UndefinedPrimitive;
  for (q=draw_info->primitive; *q != '\0'; )
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(q,&q,MagickPathExtent,primitive_name);
    if (*primitive_name == '\0')
      break;
    if (image->debug != MagickFalse)
      (void) LogMagickEvent(DrawEvent,GetMagickModule(),primitive_name);
    if (LocaleNCompare(primitive_name,"push",4) == 0)
      {
        if (n+1 == MaxDrawInfoStackSize)
          ThrowBinaryException(DrawError,"DrawInfoStackOverflow",
            image->filename);
        graphic_context=(DrawInfo **) ResizeQuantumMemory(graphic_context,n+2,
          sizeof(*graphic_context));
        if (graphic_context == (DrawInfo **) NULL)
          ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
            image->filename);
        graphic_context[++n]=CloneDrawInfo((ImageInfo *) NULL,
          graphic_context[n-1]);
        if (graphic_context[n] == (DrawInfo *) NULL)
          ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
            image->filename);
        primitive_type=UndefinedPrimitive;
        continue;
      }
    if (LocaleNCompare(primitive_name,"pop",3) == 0)
      {
        if (n <= 0)
          ThrowBinaryException(DrawError,"UnbalancedPushPop",image->filename);
        graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
        n--;
        primitive_type=UndefinedPrimitive;
        continue;
      }
    /*
      Parse the primitive attributes.
    */
    primitive=AcquireString(primitive_name);
    length=strlen(primitive)+MagickPathExtent;
    token=AcquireString(q);
    for (i=0; *q != '\0'; i++)
    {
      /*
        Define points.
      */
      if (IsPoint(q) == MagickFalse)
        break;
      GetNextToken(q,&q,length,token);
      if (*token == '\0')
        break;
      if (primitive_info == (PrimitiveInfo *) NULL)
        {
          primitive_info=(PrimitiveInfo *) AcquireQuantumMemory(i+1,
            sizeof(*primitive_info));
          if (primitive_info == (PrimitiveInfo *) NULL)
            ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
              image->filename);
        }
      else
        if (i >= (ssize_t) GetQuantumCount(primitive_info))
          {
            primitive_info=(PrimitiveInfo *) ResizeQuantumMemory(primitive_info,
              (size_t) (2*GetQuantumCount(primitive_info)),
              sizeof(*primitive_info));
            if (primitive_info == (PrimitiveInfo *) NULL)
              ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
                image->filename);
          }
      primitive_info[i].primitive=primitive_type;
      primitive_info[i].point.x=StringToDouble(token,&next_token);
      if (*next_token == '%')
        primitive_info[i].point.x*=(double) image->columns/100.0;
      GetNextToken(q,&q,length,token);
      if (*token == ',')
        GetNextToken(q,&q,length,token);
      primitive_info[i].point.y=StringToDouble(token,&next_token);
      if (*next_token == '%')
        primitive_info[i].point.y*=(double) image->rows/100.0;
      GetNextToken(q,(const char **) NULL,length,token);
      if (*token == ',')
        GetNextToken(q,&q,length,token);
      primitive_info[i].coordinates=0;
      primitive_info[i].method=FloodfillMethod;
    }
    primitive_info[0].primitive=primitive_type;
    primitive_info[0].coordinates=i;
    primitive_info[0].method=FloodfillMethod;
    primitive_info[0].text=(char *) NULL;
    /*
      Draw primitive.
    */
    status&=DrawPrimitive(image,graphic_context[n],primitive_info,exception);
    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
    primitive_info=(PrimitiveInfo *) NULL;
    primitive_type=UndefinedPrimitive;
    token=DestroyString(token);
    primitive=DestroyString(primitive);
  }