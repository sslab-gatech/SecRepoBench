MagickBooleanType
    active,
    status;

  DrawInfo
    **graphic_context;

  PrimitiveInfo
    *primitive_info;

  size_t
    length;

  ssize_t
    n;

  StopInfo
    *stops;

  /*
    Initialize graphics context.
  */
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  assert(draw_info != (DrawInfo *) NULL);
  assert(draw_info->signature == MagickCoreSignature);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"...");
  status=MagickTrue;
  stops=(StopInfo *) NULL;
  primitive_info=(PrimitiveInfo *) NULL;
  graphic_context=(DrawInfo **) AcquireMagickMemory(sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      image->filename);
  n=0;
  graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  GetAffineMatrix(&affine);
  GetAffineMatrix(&current);
  token=AcquireString(draw_info->primitive);
  primitive=AcquireString(token);
  length=strlen(token);
  for (q=(const char *) token; *q != '\0'; )
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(q,&q,MagickPathExtent,primitive_name);
    if (*primitive_name == '\0')
      break;
    if (*primitive_name == '#')
      {
        /*
          Comment.
        */
        for ( ; (*q != '\n') && (*q != '\0'); q++);
        continue;
      }
    if (LocaleCompare("push",primitive_name) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        if (LocaleCompare("graphic-context",primitive_name) == 0)
          {
            n++;
            graphic_context=(DrawInfo **) ResizeQuantumMemory(graphic_context,
              (size_t) (n+1),sizeof(*graphic_context));
            if (graphic_context == (DrawInfo **) NULL)
              ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
                image->filename);
            graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
              graphic_context[n-1]);
            continue;
          }
        ThrowBinaryException(DrawError,"UnbalancedPushPop",
          primitive_name);
      }
    if (LocaleCompare("pop",primitive_name) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        if (LocaleCompare("graphic-context",primitive_name) == 0)
          {
            if (n == 0)
              ThrowBinaryException(DrawError,"UnbalancedPushPop",
                primitive_name);
            graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
            n--;
            continue;
          }
        ThrowBinaryException(DrawError,"UnbalancedPushPop",
          primitive_name);
      }
    if (LocaleCompare("affine",primitive_name) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        affine.sx=StringToDouble(primitive_name,&next_token);
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        affine.rx=StringToDouble(primitive_name,&next_token);
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        affine.ry=StringToDouble(primitive_name,&next_token);
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        affine.sy=StringToDouble(primitive_name,&next_token);
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        affine.tx=StringToDouble(primitive_name,&next_token);
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        affine.ty=StringToDouble(primitive_name,&next_token);
        continue;
      }
    if (LocaleCompare("primitive",primitive_name) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,primitive_name);
        if (LocaleCompare("line",primitive_name) == 0)
          {
            primitive_info=(PrimitiveInfo *) AcquireMagickMemory(
              2*sizeof(*primitive_info));
            if (primitive_info == (PrimitiveInfo *) NULL)
              ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
                image->filename);
            primitive_info[0].primitive=LinePrimitive;
            primitive_info[0].coordinates=2;
            primitive_info[0].method=FloodfillMethod;
            GetNextToken(q,&q,MagickPathExtent,primitive_name);
            primitive_info[0].point.x=StringToDouble(primitive_name,
              &next_token);
            GetNextToken(q,&q,MagickPathExtent,primitive_name);
            primitive_info[0].point.y=StringToDouble(primitive_name,
              &next_token);
            GetNextToken(q,&q,MagickPathExtent,primitive_name);
            primitive_info[1].point.x=StringToDouble(primitive_name,
              &next_token);
            GetNextToken(q,&q,MagickPathExtent,primitive_name);
            primitive_info[1].point.y=StringToDouble(primitive_name,
              &next_token);
            primitive_info[1].primitive=UndefinedPrimitive;
            (void) DrawPrimitive(image,graphic_context[n],primitive_info,
              exception);
            primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(
              primitive_info);
            continue;
          }
        ThrowBinaryException(DrawError,"UnrecognizedPrimitive",
          primitive_name);
      }
    ThrowBinaryException(DrawError,"UnrecognizedPrimitive",
      primitive_name);
  }