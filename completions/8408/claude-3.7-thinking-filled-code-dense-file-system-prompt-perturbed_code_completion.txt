double
    angle;

  DrawInfo
    **graphic_context;

  MagickBooleanType
    proceed,
    status;

  MagickStatusType
    flags;

  PointInfo
    point;

  PrimitiveInfo
    *primitive_info;

  PrimitiveType
    primitive_type;

  register ssize_t
    i,
    x;

  SegmentInfo
    bounds;

  size_t
    length,
    number_points,
    number_stops;

  ssize_t
    j,
    n,
    number_coordinates,
    s;

  StopInfo
    *stops;

  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"begin draw-image");
  
  if (draw_info->primitive == (char *) NULL)
    return(MagickTrue);
  if (*draw_info->primitive == '\0')
    return(MagickTrue);
    
  /*
    Initialize graphic drawing context.
  */
  graphic_context=(DrawInfo **) AcquireMagickMemory(
    sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      image->filename);
  graphic_context[0]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  n=0;
  
  stops=(StopInfo *) NULL;
  number_stops=0;
  status=MagickTrue;
  primitive=(char *) NULL;
  token=AcquireString(draw_info->primitive);
  
  primitive=AcquireString(draw_info->primitive);
  if (primitive == (char *) NULL)
    {
      token=DestroyString(token);
      graphic_context[0]=DestroyDrawInfo(graphic_context[0]);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      return(MagickFalse);
    }
    
  (void) CloneString(&graphic_context[n]->geometry,draw_info->geometry);
  
  if (SetImageStorageClass(image,DirectClass,exception) == MagickFalse)
    {
      primitive=DestroyString(primitive);
      token=DestroyString(token);
      graphic_context[0]=DestroyDrawInfo(graphic_context[0]);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      return(MagickFalse);
    }
  
  primitive_info=(PrimitiveInfo *) NULL;
  number_points=0;
  
  /*
    Process drawing commands.
  */
  primitive_type=UndefinedPrimitive;
  next_token=primitive;
  proceed=MagickTrue;
  for (q=primitive; *q != '\0'; )
  {
    /*
      Parse the next primitive command.
    */
    GetNextToken(q,&q,MagickPathExtent,token);
    if (*token == '\0')
      break;
    
    if (*token == '#')
      {
        /*
          Comment.
        */
        while ((*q != '\n') && (*q != '\0'))
          q++;
        continue;
      }
    
    if (LocaleCompare("affine",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sx=StringToDouble(token,(char **) NULL);
        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token == ',')
          GetNextToken(q,&q,MagickPathExtent,token);
        affine.rx=StringToDouble(token,(char **) NULL);
        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token == ',')
          GetNextToken(q,&q,MagickPathExtent,token);
        affine.ry=StringToDouble(token,(char **) NULL);
        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token == ',')
          GetNextToken(q,&q,MagickPathExtent,token);
        affine.sy=StringToDouble(token,(char **) NULL);
        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token == ',')
          GetNextToken(q,&q,MagickPathExtent,token);
        affine.tx=StringToDouble(token,(char **) NULL);
        GetNextToken(q,&q,MagickPathExtent,token);
        if (*token == ',')
          GetNextToken(q,&q,MagickPathExtent,token);
        affine.ty=StringToDouble(token,(char **) NULL);
        graphic_context[n]->affine.sx=affine.sx;
        graphic_context[n]->affine.rx=affine.rx;
        graphic_context[n]->affine.ry=affine.ry;
        graphic_context[n]->affine.sy=affine.sy;
        graphic_context[n]->affine.tx=affine.tx;
        graphic_context[n]->affine.ty=affine.ty;
        continue;
      }
    
    if (LocaleCompare("clip-path",token) == 0)
      {
        /*
          Clip path.
        */
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->clip_mask,token);
        if (LocaleCompare(graphic_context[n]->clip_mask,"none") == 0)
          graphic_context[n]->clip_mask=(char *) RelinquishMagickMemory(
            graphic_context[n]->clip_mask);
        continue;
      }
    
    if (LocaleCompare("clip-rule",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (LocaleCompare("evenodd",token) == 0)
          graphic_context[n]->fill_rule=EvenOddRule;
        if (LocaleCompare("nonzero",token) == 0)
          graphic_context[n]->fill_rule=NonZeroRule;
        continue;
      }
    
    if (LocaleCompare("clip-units",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (LocaleCompare("userSpace",token) == 0)
          graphic_context[n]->clip_units=UserSpace;
        if (LocaleCompare("userSpaceOnUse",token) == 0)
          graphic_context[n]->clip_units=UserSpaceOnUse;
        if (LocaleCompare("objectBoundingBox",token) == 0)
          graphic_context[n]->clip_units=ObjectBoundingBox;
        continue;
      }
    
    if (LocaleCompare("fill",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) QueryColorCompliance(token,AllCompliance,
          &graphic_context[n]->fill,exception);
        continue;
      }
    
    if (LocaleCompare("fill-opacity",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->fill.alpha=StringToDouble(token,(char **) NULL);
        continue;
      }
    
    if (LocaleCompare("font",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->font,token);
        continue;
      }
    
    if (LocaleCompare("font-family",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->family,token);
        continue;
      }
    
    if (LocaleCompare("font-size",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->pointsize=StringToDouble(token,(char **) NULL);
        continue;
      }
    
    if (LocaleCompare("font-stretch",token) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->stretch=UndefinedStretch;
        if (LocaleCompare("normal",token) == 0)
          graphic_context[n]->stretch=NormalStretch;
        if (LocaleCompare("UltraCondensed",token) == 0)
          graphic_context[n]->stretch=UltraCondensedStretch;
        if (LocaleCompare("ExtraCondensed",token) == 0)
          graphic_context[n]->stretch=ExtraCondensedStretch;
        if (LocaleCompare("Condensed",token) == 0)
          graphic_context[n]->stretch=CondensedStretch;
        if (LocaleCompare("SemiCondensed",token) == 0)
          graphic_context[n]->stretch=SemiCondensedStretch;
        if (LocaleCompare("SemiExpanded",token) == 0)
          graphic_context[n]->stretch=SemiExpandedStretch;
        if (LocaleCompare("Expanded",token) == 0)
          graphic_context[n]->stretch=ExpandedStretch;
        if (LocaleCompare("ExtraExpanded",token) == 0)
          graphic_context[n]->stretch=ExtraExpandedStretch;
        if (LocaleCompare("UltraExpanded",token) == 0)
          graphic_context[n]->stretch=UltraExpandedStretch;
        if (LocaleCompare("Any",token) == 0)
          graphic_context[n]->stretch=AnyStretch;
        continue;
      }