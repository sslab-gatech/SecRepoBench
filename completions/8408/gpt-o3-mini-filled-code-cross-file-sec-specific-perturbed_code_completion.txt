{
  if (draw_info->primitive == (char *) NULL)
  {
    status = MagickFalse;
    goto cleanup;
  }

  /* Acquire the drawing commands string */
  primitive = AcquireString(draw_info->primitive);
  if (primitive == (char *) NULL)
  {
    status = MagickFalse;
    goto cleanup;
  }
  token = AcquireString(primitive);
  if (token == (char *) NULL)
  {
    primitive = DestroyString(primitive);
    status = MagickFalse;
    goto cleanup;
  }

  /* Initialize the affine transformation */
  GetAffineMatrix(&affine);

  /* Set up the graphic context stack with an initial context */
  n = 0;
  graphic_context = (DrawInfo **) AcquireQuantumMemory(1, sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
  {
    status = MagickFalse;
    goto cleanup;
  }
  graphic_context[0] = CloneDrawInfo((ImageInfo *) NULL, draw_info);
  if (graphic_context[0] == (DrawInfo *) NULL)
  {
    graphic_context = (DrawInfo **) RelinquishMagickMemory(graphic_context);
    status = MagickFalse;
    goto cleanup;
  }

  /* Simple interpreter loop for drawing commands.
     This example only handles the "line" primitive.
     Additional primitives and commands should be implemented as needed. */
  for (q = (const char *) token; *q != '\0'; )
  {
    GetNextToken(q, &q, MagickPathExtent, primitive_name);
    if (*primitive_name == '\0')
      break;

    if (LocaleCompare("line", primitive_name) == 0)
    {
      PointInfo start, end;
      /* Parse the starting point */
      GetNextToken(q, &q, MagickPathExtent, geometry);
      start.x = StringToDouble(geometry, &next_token);
      GetNextToken(q, &q, MagickPathExtent, geometry);
      start.y = StringToDouble(geometry, &next_token);

      /* Parse the ending point */
      GetNextToken(q, &q, MagickPathExtent, geometry);
      end.x = StringToDouble(geometry, &next_token);
      GetNextToken(q, &q, MagickPathExtent, geometry);
      end.y = StringToDouble(geometry, &next_token);

      /* Draw the line using the current graphic context */
      status = DrawLinePrimitive(image, graphic_context[n], start, end, exception);
      if (status == MagickFalse)
        break;
      continue;
    }

    /* Other primitives can be handled here. For unsupported tokens, simply continue. */
  }
}