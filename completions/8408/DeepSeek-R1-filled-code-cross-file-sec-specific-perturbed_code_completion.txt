MagickBooleanType
    status;

  PrimitiveInfo
    *primitive_info;

  ssize_t
    n;

  DrawInfo
    **graphic_context;

  StopInfo
    *stops;

  status=MagickTrue;
  primitive_info=(PrimitiveInfo *) NULL;
  n=(-1);
  graphic_context=(DrawInfo **) AcquireQuantumMemory(MagickMaxAllocExtent,
    sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      image->filename);
  graphic_context[0]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  stops=(StopInfo *) NULL;
  if (*draw_info->primitive == '\0')
    {
      graphic_context[0]=DestroyDrawInfo(graphic_context[0]);
      graphic_context=(DrawInfo **) RelinquishMagickMemory(graphic_context);
      return(MagickTrue);
    }
  primitive=AcquireString(draw_info->primitive);
  token=AcquireString(primitive);
  for (q=(const char *) primitive; *q != '\0'; )
  {
    GetNextToken(q,&q,MagickPathExtent,primitive_name);
    if (*primitive_name == '\0')
      break;
    if (LocaleCompare(primitive_name,"push") == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,pattern);
        n++;
        if (n >= (ssize_t) MagickMaxAllocExtent)
          {
            status=MagickFalse;
            break;
          }
        graphic_context[n+1]=CloneDrawInfo((ImageInfo *) NULL,
          graphic_context[n]);
        if (graphic_context[n+1] == (DrawInfo *) NULL)
          {
            status=MagickFalse;
            break;
          }
        continue;
      }
    if (LocaleCompare(primitive_name,"pop") == 0)
      {
        n--;
        if (n < (-1))
          {
            status=MagickFalse;
            break;
          }
        continue;
      }
    if (LocaleCompare(primitive_name,"affine") == 0)
      {
        GetAffineMatrix(&affine);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.rx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.ry=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sy=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.tx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.ty=StringToDouble(token,&next_token);
        graphic_context[n]->affine=affine;
        continue;
      }
    if (LocaleNCompare(primitive_name,"gradient",8) == 0)
      {
        if (stops == (StopInfo *) NULL)
          stops=(StopInfo *) AcquireQuantumMemory(MagickMaxAllocExtent,
            sizeof(*stops));
        if (stops == (StopInfo *) NULL)
          {
            status=MagickFalse;
            break;
          }
        continue;
      }
    primitive_info=ParsePrimitive(image,graphic_context[n],primitive_name,
      &q,exception);
    if (primitive_info == (PrimitiveInfo *) NULL)
      {
        status=MagickFalse;
        break;
      }
    if (primitive_info->coordinates == 0)
      {
        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
        continue;
      }
    status=RenderPrimitive(image,graphic_context[n],primitive_info,exception);
    primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
    if (status == MagickFalse)
      break;
  }