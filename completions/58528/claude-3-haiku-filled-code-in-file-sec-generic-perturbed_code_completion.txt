// <MASK>
while (rpl_tmp.nb_refs < sh->nb_refs[list_idx]) {
    int cand_list = cand_lists[rpl_tmp.nb_refs];
    if (cand_list == ST_CURR_BEF) {
        for (refindex = 0; refindex < s->rps[ST_CURR_BEF].nb_refs; refindex++) {
            ret = add_candidate_ref(s, &rpl_tmp, s->rps[ST_CURR_BEF].list[refindex], HEVC_FRAME_FLAG_SHORT_REF, 0);
            if (ret < 0)
                return ret;
        }
    } else if (cand_list == ST_CURR_AFT) {
        for (refindex = 0; refindex < s->rps[ST_CURR_AFT].nb_refs; refindex++) {
            ret = add_candidate_ref(s, &rpl_tmp, s->rps[ST_CURR_AFT].list[refindex], HEVC_FRAME_FLAG_SHORT_REF, 0);
            if (ret < 0)
                return ret;
        }
    } else if (cand_list == LT_CURR) {
        for (refindex = 0; refindex < s->rps[LT_CURR].nb_refs; refindex++) {
            ret = add_candidate_ref(s, &rpl_tmp, s->rps[LT_CURR].list[refindex], HEVC_FRAME_FLAG_LONG_REF, 1);
            if (ret < 0)
                return ret;
        }
    }
    if (s->ps.pps->pps_curr_pic_ref_enabled_flag && rpl_tmp.nb_refs == 0)
        rpl_tmp.list[rpl_tmp.nb_refs++] = s->ref->poc;
}