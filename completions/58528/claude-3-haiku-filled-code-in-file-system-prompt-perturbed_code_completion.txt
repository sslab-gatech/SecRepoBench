while (rpl_tmp.nb_refs < sh->nb_refs[list_idx]) {
    int cand_idx = cand_lists[rpl_tmp.nb_refs % 3];
    int poc;

    switch (cand_idx) {
    case ST_CURR_BEF:
        poc = s->poc + s->rps[ST_CURR_BEF].delta_poc[rpl_tmp.nb_refs];
        break;
    case ST_CURR_AFT:
        poc = s->poc + s->rps[ST_CURR_AFT].delta_poc[rpl_tmp.nb_refs];
        break;
    case LT_CURR:
        poc = s->rps[LT_CURR].poc[rpl_tmp.nb_refs];
        break;
    }

    if (s->ps.pps->pps_curr_pic_ref_enabled_flag && rpl_tmp.nb_refs == sh->nb_refs[list_idx] - 1)
        rpl_tmp.list[rpl_tmp.nb_refs++] = s->ref->poc;
    else
        ret = add_candidate_ref(s, &rpl_tmp, poc, HEVC_FRAME_FLAG_SHORT_REF, cand_idx == LT_CURR);
    if (ret < 0)
        return ret;
}