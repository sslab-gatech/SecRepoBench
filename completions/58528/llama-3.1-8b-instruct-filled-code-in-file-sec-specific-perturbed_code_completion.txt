for (i = 0; i < short_rps->num_delta_pocs; i++) {
    int poc = s->poc + short_rps->delta_poc[i];
    int list;

    if (!short_rps->used[i])
        list = ST_FOLL;
    else if (i < short_rps->num_negative_pics)
        list = ST_CURR_BEF;
    else
        list = ST_CURR_AFT;

    ret = add_candidate_ref(s, &rps[list], poc, HEVC_FRAME_FLAG_SHORT_REF, 1);
    if (ret < 0)
        goto fail;

    // Check if the reference is already in the list
    for (j = 0; j < rps[list].nb_refs; j++) {
        if (rps[list].list[j] == poc) {
            // If the reference is already in the list, remove it
            for (k = j; k < rps[list].nb_refs - 1; k++) {
                rps[list].list[k] = rps[list].list[k + 1];
                rps[list].ref[k] = rps[list].ref[k + 1];
            }
            rps[list].nb_refs--;
            break;
        }
    }
}

/* concatenate the candidate lists for the current frame */
while (rpl_tmp.nb_refs < sh->nb_refs[list_idx]) {
    // Iterate over the candidate reference picture lists (ST_CURR_BEF, ST_CURR_AFT, LT_CURR).
    // For each candidate list, append its references to a temporary reference picture list.
    // If the current picture reference is enabled by the PPS, add the current picture as a reference.
    for (int cand_list = 0; cand_list < 3; cand_list++) {
        RefPicList *cand_rpl = &s->rps[cand_list];
        for (int j = 0; j < cand_rpl->nb_refs; j++) {
            if (cand_rpl->list[j] < rpl_tmp.nb_refs) {
                // If the reference is already in the temporary list, skip it
                continue;
            }
            rpl_tmp.list[rpl_tmp.nb_refs] = cand_rpl->list[j];
            rpl_tmp.ref[rpl_tmp.nb_refs] = cand_rpl->ref[j];
            rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = cand_rpl->isLongTerm[j];
            rpl_tmp.nb_refs++;
        }
    }

    if (s->ps.pps->pps_curr_pic_ref_enabled_flag &&
       !sh->rpl_modification_flag[list_idx] &&
        rpl_tmp.nb_refs > sh->nb_refs[L0]) {
        rpl_tmp.list[rpl_tmp.nb_refs - 1] = s->ref->poc;
        rpl_tmp.ref[rpl_tmp.nb_refs - 1] = s->ref;
    }
}