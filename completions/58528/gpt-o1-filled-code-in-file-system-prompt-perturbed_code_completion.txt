{
    int prev_refs = rpl_tmp.nb_refs;
    for (int c = 0; c < 3 && rpl_tmp.nb_refs < sh->nb_refs[list_idx]; c++) {
        int cand_idx = cand_lists[c];
        for (int j = 0; j < s->rps[cand_idx].nb_refs && rpl_tmp.nb_refs < sh->nb_refs[list_idx]; j++) {
            rpl_tmp.list[rpl_tmp.nb_refs]       = s->rps[cand_idx].list[j];
            rpl_tmp.ref[rpl_tmp.nb_refs]        = s->rps[cand_idx].ref[j];
            rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = s->rps[cand_idx].isLongTerm[j];
            rpl_tmp.nb_refs++;
        }
    }
    /* If no new references were added, break to avoid potential infinite loop. */
    if (rpl_tmp.nb_refs == prev_refs)
        break;
}