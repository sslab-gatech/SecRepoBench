for (int cand_idx = 0; cand_idx < 3; cand_idx++) {
                int list_type = cand_lists[cand_idx];
                RefPicSet *rps = &s->rps[list_type];

                for (refindex = 0; refindex < rps->nb_refs; refindex++) {
                    if (rpl_tmp.nb_refs >= MAX_REFS) {
                        av_log(s->avctx, AV_LOG_ERROR, "Exceeded maximum number of references.\n");
                        return AVERROR_INVALIDDATA;
                    }

                    rpl_tmp.list[rpl_tmp.nb_refs] = rps->poc[refindex];
                    rpl_tmp.ref[rpl_tmp.nb_refs] = rps->ref[refindex];
                    rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = (list_type == LT_CURR);
                    rpl_tmp.nb_refs++;
                }
            }

            if (s->ps.pps->pps_curr_pic_ref_enabled_flag && rpl_tmp.nb_refs < MAX_REFS) {
                rpl_tmp.list[rpl_tmp.nb_refs] = s->ref->poc;
                rpl_tmp.ref[rpl_tmp.nb_refs] = s->ref;
                rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = 0;
                rpl_tmp.nb_refs++;
            }

            if (rpl_tmp.nb_refs > MAX_REFS) {
                av_log(s->avctx, AV_LOG_ERROR, "Reference list overflow.\n");
                return AVERROR_INVALIDDATA;
            }