// Iterate over the candidate reference picture lists (ST_CURR_BEF, ST_CURR_AFT, LT_CURR).
        // For each candidate list, append its references to a temporary reference picture list.
        // If the current picture reference is enabled by the PPS, add the current picture as a reference.
        for (i = 0; i < 3; i++) {
            int cand_list_idx = cand_lists[i];
            int nb_refs_in_cand_list = 0;

            if (cand_list_idx == ST_CURR_BEF || cand_list_idx == ST_CURR_AFT) {
                nb_refs_in_cand_list = s->rps[cand_list_idx].nb_refs;
            } else if (cand_list_idx == LT_CURR) {
                nb_refs_in_cand_list = s->rps[LT_CURR].nb_refs;
            }

            for (int j = 0; j < nb_refs_in_cand_list; j++) {
                RefPic *ref_pic = NULL;

                if (cand_list_idx == ST_CURR_BEF) {
                    ref_pic = &s->rps[ST_CURR_BEF].refs[j];
                } else if (cand_list_idx == ST_CURR_AFT) {
                    ref_pic = &s->rps[ST_CURR_AFT].refs[j];
                } else if (cand_list_idx == LT_CURR) {
                    ref_pic = &s->rps[LT_CURR].refs[j];
                }

                if (ref_pic && ref_pic->poc >= s->ref->poc - s->ref->poc_ref_distance &&
                    ref_pic->poc <= s->ref->poc + s->ref->poc_ref_distance) {
                    rpl_tmp.list[rpl_tmp.nb_refs] = ref_pic;
                    rpl_tmp.ref[rpl_tmp.nb_refs] = ref_pic->frame;
                    rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = (cand_list_idx == LT_CURR);
                    rpl_tmp.nb_refs++;
                }
            }
        }

        // If the current picture reference is enabled by the PPS, add the current picture as a reference.
        if (s->ps.pps->pps_curr_pic_ref_enabled_flag) {
            RefPic *current_pic_ref = &s->ref->current_pic_ref;
            rpl_tmp.list[rpl_tmp.nb_refs] = current_pic_ref;
            rpl_tmp.ref[rpl_tmp.nb_refs] = s->ref->frame;
            rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = 0;
            rpl_tmp.nb_refs++;
        }